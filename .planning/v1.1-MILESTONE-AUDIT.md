---
milestone: v1.1
audited: 2026-02-17T20:30:00Z
status: gaps_found
scores:
  requirements: 30/33
  phases: 7/8
  integration: 6/7
  flows: 3/5
gaps:
  requirements:
    - "Phase 13: Geofence coverage analytics (% booking sites covered) — not implemented"
    - "Phase 13: RIDDOR auto-save has no editable UI inputs — saves initial state only"
    - "Phase 14: Payslip page uses user.id instead of medic.id — returns 0 results"
  integration:
    - "Analytics overview tab (5 legacy DB view queries) lacks org_id client-side filter — cross-org data in multi-tenant deployment"
  flows:
    - "Flow 3 (RIDDOR compliance workflow): breaks at draft editing — category/override_reason inputs missing"
    - "Flow 4 (Medic payout cycle): breaks at payslip data fetch — .eq('medic_id', user.id) should be .eq('medic_id', medic.id)"
tech_debt:
  - phase: 10-realtime-ops-polish
    items:
      - "useMedicLocationsStore.ts:332–337 — useEffect inside window !== undefined check (invalid React hook ordering; does not crash in browser)"
  - phase: 12-analytics-dashboard
    items:
      - "Analytics overview tab queries 5 DB views with no org_id filter — acceptable for single-tenant, gap for multi-tenant"
  - phase: 13-ux-polish
    items:
      - "No VERIFICATION.md — all 4 plans completed per SUMMARY.md but phase was never formally verified"
      - "Geofence coverage analytics requirement deferred (noted in 13-RESEARCH.md as 'Not yet implemented')"
  - phase: 15-code-quality
    items:
      - "console.warn in web/stores/useMedicLocationsStore.ts:121 — outside web/app/** sweep scope but should be removed before production"
---

# v1.1 Milestone Audit Report

**Milestone:** v1.1 — Post-MVP Polish & Data Completeness
**Audited:** 2026-02-17
**Status:** gaps_found
**Auditor:** Claude (gsd-audit-milestone orchestrator + gsd-integration-checker)

---

## Summary

v1.1 closes the gaps identified in the post-v1.0 audit: lead persistence, data surfacing, realtime operations, org configuration, analytics, UX polish, compliance exports, and code quality. 7/8 phases are formally verified. 2 critical bugs were found during integration checking — the payslip query uses the wrong user ID (Flow 4 broken) and the RIDDOR auto-save has no editable inputs (Flow 3 partial). 1 requirement was never implemented (geofence coverage analytics).

---

## Phase Verification Status

| Phase | Name | Status | Score | Notes |
|-------|------|--------|-------|-------|
| 08 | Lead Capture | ✅ passed | 13/13 | — |
| 09 | Booking Data Completeness | ✅ passed | 4/4 | — |
| 10 | Realtime Ops Polish | ✅ passed | 7/7 | 1 hook warning (non-blocking) |
| 11 | Org Settings | ✅ passed | 10/10 | — |
| 12 | Analytics Dashboard | ✅ passed | 9/9 | Overview tab org_id gap (legacy) |
| 13 | UX Polish | ⚠️ unverified | N/A | All 4 plans complete, no VERIFICATION.md |
| 14 | Compliance Exports | ✅ passed | 5/5 | Payslip download code bug found during integration check |
| 15 | Code Quality | ✅ passed | 16/16 | 1 console.warn in stores/ outside sweep scope |

---

## Requirements Coverage

### Phase 08 — Lead Capture

| Requirement | Status |
|-------------|--------|
| Contact form persisted to DB, no email-only | SATISFIED |
| Quote submissions persisted (session data not lost) | SATISFIED |
| Admin CRM with lead status (new/contacted/converted/closed) | SATISFIED |
| Quote-to-booking shortcut with data pre-fill | SATISFIED |

### Phase 09 — Booking Data Completeness

| Requirement | Status |
|-------------|--------|
| Client sees specialNotes + what3words on confirmation | SATISFIED |
| Admin sees approval_reason, cancellation_reason, cancelled_by | SATISFIED |
| Recurring booking chain shows all N instances with status | SATISFIED |
| Refund amount visible in admin view when > 0 | SATISFIED |

### Phase 10 — Realtime Ops Polish

| Requirement | Status |
|-------------|--------|
| Map marker shows medic name + site + shift times | SATISFIED |
| Payment failure page has retry button | SATISFIED |
| Alert dismiss prompts for note, logs to medic_alerts | SATISFIED |
| Geofence_failure alert escalates to red pulse after 15 min | SATISFIED |
| Suggested action per alert type (9 types) | SATISFIED |
| Bulk dismiss for low/medium severity only | SATISFIED |
| Contact button fallback to mailto when medicPhone is null | SATISFIED |

### Phase 11 — Org Settings

| Requirement | Status |
|-------------|--------|
| org_settings table with base_rate, geofence_default_radius, urgency_premiums, admin_email | SATISFIED |
| Admin settings page at /admin/settings | SATISFIED |
| Booking pricing reads base_rate from org settings | SATISFIED |
| Geofence creation defaults to org's geofence_default_radius | SATISFIED |
| Urgency premium validation reads from org settings | SATISFIED |

### Phase 12 — Analytics Dashboard

| Requirement | Status |
|-------------|--------|
| Territory coverage heatmap + hiring trigger cards | SATISFIED |
| Auto-assignment success rate chart (12 weeks) | SATISFIED |
| Medic utilisation table sortable by utilisation % | SATISFIED |
| Out-of-territory booking frequency and cost impact | SATISFIED |
| Late arrival pattern heatmap | SATISFIED |
| Multi-tenant org_id isolation on all queries | PARTIAL — new tabs isolated, overview tab legacy views are cross-org |

### Phase 13 — UX Polish

| Requirement | Status |
|-------------|--------|
| Skeleton loaders: treatments, workers, organizations, command center | SATISFIED |
| Geofence creation: interactive Leaflet map picker (click to place, drag to resize) | SATISFIED |
| Geofence real-time exit alert creates medic_alert type geofence_failure | SATISFIED |
| **Geofence coverage analytics: % of booking sites covered** | **UNSATISFIED — not implemented** |
| RIDDOR auto-save draft every 30 seconds | PARTIAL — infrastructure built, no edit inputs on page |
| RIDDOR detail: audit trail with status changes + timestamp + actor | SATISFIED |
| RIDDOR detail: photo gallery for evidence photos | SATISFIED |

### Phase 14 — Compliance Exports

| Requirement | Status |
|-------------|--------|
| **Medic payslip PDF download (2 clicks)** | **UNSATISFIED — query returns 0 results (bug: uses user.id not medic.id)** |
| Admin exports RIDDOR incidents as PDF | SATISFIED |
| Certification expiry banners on medic profile | SATISFIED |
| IR35 status + last assessment date on medic profile | SATISFIED |
| Contract version history with signed URL downloads | SATISFIED |

### Phase 15 — Code Quality

| Requirement | Status |
|-------------|--------|
| Zero console.log in production (web/app/**) | SATISFIED |
| Admin manually assigns medic to unmatched booking | SATISFIED |
| Schedule board empty state (no mock data) | SATISFIED |
| Schedule board conflict checking in production data | SATISFIED |

---

## Total: **30/33 requirements satisfied**

---

## Cross-Phase Integration

| Connection | Status | Details |
|------------|--------|---------|
| Phase 08→11: contact/quotes routes read org_settings admin_email | ✅ WIRED | Both routes query org_settings after DB insert |
| Phase 09→15: BookingDetailPanel + match endpoint manual override | ✅ WIRED | No conflict — reuse existing overrideMedicId field |
| Phase 10→13: onPingReceived + useGeofenceExitMonitor | ✅ WIRED | Callback registered after loadGeofences(), cleanup on unmount |
| Phase 11→08: booking form reads base_rate, quote prefill flows | ✅ WIRED | Two flows (public + admin) both correct |
| Phase 13→10: geofence_failure alert type in AlertPanel | ✅ WIRED | SUGGESTED_ACTIONS and getAlertIcon both handle geofence_failure |
| Phase 12→11: new analytics tabs org_id isolation | ✅ WIRED | All 3 new tabs use .eq('org_id', orgId) via useRequireOrg() |
| Phase 12 overview tab: legacy DB view queries | ⚠️ PARTIAL | 5 views have no org_id filter — cross-org aggregates in multi-tenant |

---

## E2E Flow Verification

| Flow | Steps | Status | Breaks At |
|------|-------|--------|-----------|
| 1. Lead → Booking conversion | Contact form → DB → /admin/submissions → Convert → /admin/bookings/new pre-filled | ✅ COMPLETE | — |
| 2. Booking → Medic → Live monitoring | Create booking → Auto-assign → Command center map marker → Geofence exit → AlertPanel | ✅ COMPLETE | — |
| 3. RIDDOR compliance workflow | Medic logs → Sync → Auto-flag → Admin reviews draft → Auto-save → Status change → Audit trail | ⚠️ PARTIAL | Draft editing — no category/override_reason edit inputs on detail page |
| 4. Medic payout cycle | Booking completed → Timesheet → Admin approves → Payslip → Medic downloads PDF | ❌ BROKEN | Payslip data fetch returns 0 rows (user.id ≠ medic.id bug) |
| 5. Analytics → Operational decisions | Territory metrics → Hiring trigger cards → Coverage gaps → Org settings → Adjust base_rate | ✅ COMPLETE | — |

---

## Critical Gaps (Blockers)

### GAP-1: Payslip Page — Wrong medic_id in Query (Critical)

**File:** `web/app/medic/payslips/page.tsx` ~line 65
**Impact:** Any medic loading `/medic/payslips` sees an empty list. No payslip download possible.
**Root cause:** The `timesheets` query uses `.eq('medic_id', user.id)` (auth UUID) but `timesheets.medic_id` references `medics(id)` — a separate generated UUID. The `medic.id` is correctly fetched in a prior query but not used for the timesheet query.
**Fix:** Change `.eq('medic_id', user.id)` → `.eq('medic_id', medic.id)` where `medic.id` is the result from the `medics` table fetch.

---

### GAP-2: RIDDOR Detail Page — Auto-Save Has No Edit Inputs (High)

**File:** `web/app/(dashboard)/riddor/[id]/page.tsx`
**Impact:** Admins/medics cannot modify RIDDOR category or override_reason from the detail page. The auto-save infrastructure fires on a timer but always saves the original values — no user edit is possible.
**Root cause:** `draftCategory` and `draftOverrideReason` state is set once on load from the incident data. No `<select>`, `<input>`, or `<textarea>` elements are bound to `setDraftCategory` or `setDraftOverrideReason`.
**Fix:** Add a category `<select>` dropdown and `<textarea>` for override_reason when `incident.status === 'draft'`, each `onChange` calling the respective setter.

---

### GAP-3: Geofence Coverage Analytics — Not Implemented (Medium)

**ROADMAP.md Phase 13 requirement:** "Geofence coverage analytics: show % of booking sites covered by at least one active geofence"
**Status:** Not implemented. No component, API route, or query computes this metric. Explicitly marked as "Not yet implemented" in 13-RESEARCH.md.
**Fix needed:** API route or TanStack Query hook computing `count(distinct booking_id) / count(all bookings)` for active geofences, surfaced in admin geofences page or analytics tab.

---

## Non-Critical Tech Debt

### Phase 10: React Hook Ordering Warning

`useMedicLocationsStore.ts:332–337` — `useEffect` called inside `if (typeof window !== 'undefined')` block. Violates React rules technically (hooks must not be conditional) but does not crash in browser context where `window` is always defined. Low risk, should be refactored for correctness.

### Phase 12: Analytics Overview Tab Cross-Org Queries

`web/app/admin/analytics/page.tsx` lines 173–179 — 5 legacy DB view queries have no `.eq('org_id', orgId)` filter. Acceptable for current single-tenant deployment. Medium risk if multi-tenant is enabled.

### Phase 13: Missing VERIFICATION.md

Phase 13 (UX Polish) was not formally verified post-execution. All 4 plans have SUMMARY.md files confirming completion and build success. Recommend running formal verification before milestone completion.

### Phase 15: console.warn in stores/

`web/stores/useMedicLocationsStore.ts:121` — `console.warn('[Realtime] Received partial update for unknown medic:', medicId)` was outside the `web/app/**` sweep scope for Phase 15. Should be removed before production.

---

## Recommendation

**Status: gaps_found** — 2 critical fixes required before milestone can be completed:

1. Fix payslip medic_id query bug (1-line change)
2. Add RIDDOR draft edit inputs (category select + override_reason textarea)
3. Optionally: implement geofence coverage analytics or defer to v1.2

Run `/gsd:plan-milestone-gaps` to create closure phases for these items.

---

*Audited: 2026-02-17*
*Auditor: Claude (gsd-audit-milestone + gsd-integration-checker)*
