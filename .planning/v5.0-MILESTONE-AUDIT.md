---
milestone: v5.0
audited: 2026-02-20
status: passed
scores:
  requirements: 28/28
  phases: 8/8
  integration: 8/8
  flows: 8/8
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 41-web-messaging-core
    items:
      - "Header unread badge is server-side rendered (no real-time update until page nav) — acceptable since ConversationList has Realtime"
  - phase: 42-ios-messaging-offline
    items:
      - "Human verification of full iOS offline round-trip deferred — code verified, live device testing pending"
  - phase: 43-real-time-push-notifications
    items:
      - "Push notification requires real iOS device testing (Expo Push API + APNS credentials) — cannot be verified in dev environment"
  - phase: 46-expiry-tracking-alerts
    items:
      - "Resend API key required for production email delivery — dev mode logs to console"
      - "pg_cron job requires Supabase production instance (not available in local dev)"
---

# v5.0 Internal Comms & Document Management — Milestone Audit

**Audited:** 2026-02-20
**Status:** PASSED
**Score:** 28/28 requirements satisfied, 8/8 phases verified, all E2E flows complete

## Requirements Coverage

All 28 v5.0 requirements are satisfied:

| Category | Requirements | Status |
|----------|-------------|--------|
| Messaging | MSG-01 through MSG-12 (12) | All Complete |
| Notifications | NOTIF-01 through NOTIF-03 (3) | All Complete |
| Documents | DOC-01 through DOC-10 (10) | All Complete |
| Cross-Platform | PLAT-01 through PLAT-03 (3) | All Complete |

## Phase Verification Summary

| Phase | Name | Score | Status |
|-------|------|-------|--------|
| 40 | Comms & Docs Foundation | 4/4 | Passed |
| 41 | Web Messaging Core | 4/4 | Passed |
| 42 | iOS Messaging & Offline | 4/4 | Passed (re-verified after gap fix) |
| 43 | Real-time & Push Notifications | 16/16 | Passed |
| 44 | Broadcast Messaging | 4/4 | Passed |
| 45 | Document Upload & Profile Storage | 5/5 | Passed |
| 46 | Expiry Tracking & Alerts | 3/3 | Passed |
| 47 | Message Polish | 3/3 | Passed |

## Cross-Phase Integration Audit

### Data Flow Verification

| From Phase | To Phase | Integration Point | Status |
|-----------|----------|-------------------|--------|
| 40 (Schema) | 41 (Web UI) | conversations, messages tables → comms.ts queries | Verified — fetchConversationsWithUnread, fetchMessagesForConversation use Phase 40 tables |
| 40 (Types) | All phases | comms.types.ts imports | Verified — 14 files import from @/types/comms.types across all phases |
| 40 (Storage) | 45 (Documents) | medic-documents bucket | Verified — upload/download routes use .from('medic-documents') |
| 40 (Storage) | 47 (Attachments) | message-attachments bucket | Verified — upload/download routes use .from('message-attachments') |
| 41 (Messaging) | 42 (iOS) | Supabase sync | Verified — WatermelonDB sync pulls from same messages table |
| 41 (Messaging) | 43 (Realtime) | useConversations polling → Realtime | Verified — useRealtimeMessages invalidates ['conversations'] and ['messages', id] queries |
| 43 (Realtime) | 44 (Broadcast) | INSERT listener | Verified — Realtime INSERT on messages table handles broadcast messages (same org_id filter) |
| 43 (Realtime) | 47 (Status) | UPDATE listener | Verified — Realtime UPDATE on messages table refreshes tick display |
| 43 (Push) | 44 (Broadcast) | notify_new_message trigger | Verified — trigger fires on any messages INSERT including broadcasts |
| 44 (Broadcast) | 41 (List) | ConversationRow | Verified — handles type='broadcast' with distinct Megaphone icon |
| 45 (Versioning) | 46 (Expiry) | documents.current_version_id | Verified — expiry checker queries via current_version_id JOIN |
| 47 (Status) | 41 (Thread) | MessageStatusIndicator | Verified — MessageItem renders ticks for own messages |

### Auth & Org Scoping Consistency

All 20+ API routes use `requireOrgId()` from `@/lib/organizations/org-resolver`:
- 10 messaging routes (send, conversations, read, broadcast, search, status, attachments)
- 4 document routes (upload, list, categories, download)
- Consistent pattern: `const orgId = await requireOrgId()` at top of handler

RLS enforced at database level via `(SELECT get_user_org_id())` on all 7 v5.0 tables + 2 storage buckets.

### Edge Function Wiring

| Function | Trigger | Migration |
|----------|---------|-----------|
| send-message-notification | AFTER INSERT on messages via pg_net | 150_message_notification_trigger.sql |
| document-expiry-checker | pg_cron daily at 08:00 UTC | 155_document_expiry_reminders.sql |

Both Edge Functions exist in `supabase/functions/` and are wired via migrations.

## E2E Flow Verification

### Flow 1: Admin → Medic 1:1 Messaging
Admin creates conversation (POST /conversations) → sends message (POST /send) → Realtime INSERT fires → medic sees in ConversationList → auto-delivered PATCH fires → medic opens thread → mark-as-read advances status → admin sees blue ticks via Realtime UPDATE.
**Status: Complete**

### Flow 2: Broadcast Messaging
Admin composes broadcast (BroadcastComposeDialog) → POST /broadcast creates message + message_recipients for all medics → Realtime INSERT fires for each medic → medics see broadcast in list (Megaphone icon, read-only) → PATCH /broadcast/read marks recipient → admin sees "X of Y read" in BroadcastReadSummary.
**Status: Complete**

### Flow 3: Offline Messaging (iOS)
Medic goes offline → WatermelonDB cached conversations/messages viewable → medic composes message → queued locally with idempotency_key → connectivity returns → MessageSync pushes to server → server deduplicates via idempotency_key → message appears on web.
**Status: Complete (live device testing deferred)**

### Flow 4: Push Notifications
Message INSERT fires → pg_net calls send-message-notification Edge Function → function reads profiles.push_token → calls Expo Push API → iOS notification: "New message from [Name]" (GDPR-safe, no content) → tap deep links to conversation.
**Status: Complete (requires real iOS device for live test)**

### Flow 5: Document Upload & Versioning
Medic uploads document (POST /documents/upload) → stored in medic-documents bucket → linked to document_versions → document_categories association → admin views on medic profile → medic uploads new version → old version archived (previous_version_id) → new becomes current_version_id.
**Status: Complete (web + iOS paths verified)**

### Flow 6: Expiry Alert Flow
pg_cron fires daily → document-expiry-checker Edge Function → get_documents_expiring_in_days RPC for 30/14/7/1 day windows → deduplicates via document_expiry_reminders table → medic digest email at all stages → admin digest at 14/7/1 → mark_expired_documents sets status='expired'.
**Status: Complete (requires Resend API key for production emails)**

### Flow 7: File Attachment in Message
User clicks Paperclip (AttachmentPicker) → selects file → client-side validation (10MB, allowed types) → FormData upload (POST /attachments/upload) → stored in message-attachments bucket → message created with type='attachment' + metadata JSONB → Realtime INSERT fires → recipient sees MessageAttachment inline → download via signed URL (GET /attachments/download).
**Status: Complete**

### Flow 8: Cross-Conversation Search
User clicks SearchCode icon (ConversationList) → ConversationSearch overlay opens → types keyword (300ms debounce) → GET /messages/search uses textSearch on tsvector → results enriched with sender names + conversation names → SearchResultItem links to /messages/${conversation_id} → click navigates.
**Status: Complete**

## Migrations Summary

| # | Name | What it does |
|---|------|-------------|
| 143 | comms_docs_schema | 7 tables, 35 RLS policies, indexes, triggers, category seeding |
| 144 | comms_docs_storage | 2 storage buckets, 10 storage RLS policies |
| 150 | message_notification_trigger | AFTER INSERT trigger → send-message-notification via pg_net |
| 151 | broadcast_messaging | message_type column, broadcast conversation support |
| 155 | document_expiry_reminders | Audit table, pg_cron job, RPC functions, mark_expired |
| 157 | message_polish | updated_at trigger, tsvector FTS + GIN index, REPLICA IDENTITY FULL |

All 6 migrations are pending production application.

## Tech Debt (Non-Critical)

| Phase | Item | Severity |
|-------|------|----------|
| 41 | Header unread badge is SSR (no real-time until page nav) | Low — ConversationList has Realtime |
| 42 | Live iOS offline round-trip not tested on device | Medium — code verified, needs device test |
| 43 | Push notifications need real device + APNS credentials | Medium — standard deployment step |
| 46 | Resend API key needed for production email delivery | Low — dev mode logs to console |
| 46 | pg_cron requires Supabase production instance | Low — standard deployment step |

No critical blockers. All tech debt items are deployment/testing tasks, not code gaps.

## Conclusion

**v5.0 Internal Comms & Document Management passes the milestone audit.**

- 28/28 requirements satisfied
- 8/8 phases verified with code-level evidence
- All 8 E2E flows complete end-to-end
- Cross-phase integration verified (data flow, auth, Realtime, storage, types)
- 5 minor tech debt items (all deployment/testing related, no code gaps)
- 6 migrations pending production application

---
*Audited: 2026-02-20*
