# Milestone v1.0: MVP

**Status:** ✅ SHIPPED 2026-02-16
**Phases:** 1-7.5 (13 phases total)
**Total Plans:** 84

## Overview

SiteMedic transforms medic clinical work into automatic compliance documentation through seven phases plus six inserted phases for business operations. We start with a rock-solid offline-first foundation (backend, auth, encryption, sync infrastructure), then build the mobile app core for local-only data capture, connect mobile to backend with robust sync, add the manager web dashboard for reporting, enable professional PDF report generation, implement smart RIDDOR auto-flagging, complete with certification tracking, and insert business operations phases for booking portal, payments, territories, and contract management. This order ensures GDPR compliance from Day 1, prevents data loss during sync transitions, and validates offline-first architecture before adding connectivity complexity.

## Phases

### Phase 1: Foundation
**Goal**: Backend API, authentication, and offline-first infrastructure operational with GDPR-compliant encryption and sync architecture ready for mobile app.

**Depends on**: Nothing (first phase)

**Requirements**: ARCH-01, ARCH-02, ARCH-03, ARCH-04, ARCH-05, ARCH-06, ARCH-07, AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-05, GDPR-01, GDPR-02, GDPR-03, GDPR-04, GDPR-05, GDPR-06

**Success Criteria** (what must be TRUE):
  1. User can sign up and log in with email/password
  2. User session persists across app restarts (offline session handling works)
  3. Biometric authentication (Face ID/Touch ID) works for quick access
  4. Encryption key infrastructure ready in iOS Keychain via expo-secure-store (SQLCipher database encryption deferred to Phase 2 per research -- WatermelonDB PR #907 not merged)
  5. Sync queue persists locally with conflict resolution logic ready (not yet actively syncing)
  6. Multi-modal sync status indicators display correctly (color, labels, pending count badge)
  7. Network connectivity detection triggers sync status updates
  8. Audit logging captures all data access: server-side via PostgreSQL triggers on Supabase tables, client-side via local audit log service that records READ operations on sensitive WatermelonDB tables and queues for sync

**Plans**: 5 plans

Plans:
- [x] 01-01: Expo project scaffold and Supabase client initialization
- [x] 01-02: Supabase backend schema, RLS, audit logging, GDPR tables
- [x] 01-03: WatermelonDB local database and encryption key management
- [x] 01-04: Authentication system with offline persistence and biometrics
- [x] 01-05: Sync infrastructure, network monitoring, and status UI

### Phase 1.5: Business Operations Foundation (INSERTED)
**Goal**: Database schema, payment infrastructure, and territory system operational to support booking portal, medic payouts, and UK-wide coverage management.

**Depends on**: Phase 1

**Requirements**: Booking system (online portal, auto-matching, recurring bookings), Payment processing (Stripe Connect, 40% markup, Net 30 invoicing), Territory management (UK postcode sectors, primary/secondary medics, coverage gaps), Payout automation (weekly Friday payouts via UK Faster Payments, IR35 compliance)

**Success Criteria** (what must be TRUE):
  1. Database tables exist for territories, bookings, clients, medics, timesheets, payments, invoices with RLS policies
  2. Stripe Connect account created for platform in test mode
  3. Can create Stripe Express account for test medic (onboarding flow works)
  4. Google Maps Distance Matrix API returns travel times for UK postcodes
  5. UK postcode sector database seeded (~11,232 sectors) with primary assignment capability
  6. Can create test booking with pricing calculation (base + urgency + travel + VAT)
  7. Auto-assignment algorithm ranks medics by distance, utilization, qualifications
  8. Out-of-territory cost logic calculates travel bonus vs room/board vs deny

**Plans**: 4 plans

Plans:
- [x] 01.5-01: Invoice sequencing, pricing calculation, and test data seeding
- [x] 01.5-02: Stripe Connect integration (Express accounts, Payment Intents, webhooks)
- [x] 01.5-03: Auto-assignment algorithm and out-of-territory cost logic
- [x] 01.5-04: UK postcode database seeding (~11,232 sectors)

### Phase 2: Mobile Core
**Goal**: Medics can capture treatments, worker profiles, near-misses, and daily safety checks 100% offline with gloves-on usability.

**Depends on**: Phase 1

**Requirements**: TREAT-01 through TREAT-12, NEAR-01 through NEAR-07, DAILY-01 through DAILY-05, WORK-01 through WORK-06, PHOTO-01 through PHOTO-06, UX-01 through UX-08

**Success Criteria** (what must be TRUE):
  1. Medic can log minor treatment in under 30 seconds
  2. Medic can log full treatment with photos and signature in under 90 seconds
  3. Medic can capture near-miss with photo in under 45 seconds
  4. Medic can complete daily safety checklist (10 items) in under 5 minutes
  5. Medic can add worker during induction with health screening data
  6. Medic can view worker treatment history in 2 taps during emergency
  7. All workflows work with gloves on (48x48pt tap targets verified)
  8. App works 100% offline (airplane mode test passes)
  9. Photos compress on-device to 100-200KB
  10. Treatment auto-saves locally every 10 seconds

**Plans**: 10 plans

Plans:
- [x] 02-01: Dependencies, shared gloves-on UI components, safety taxonomy
- [x] 02-02: Photo capture/compression and signature pad
- [x] 02-03: Worker profiles (search, quick-add, induction, history)
- [x] 02-04: Treatment logger core (full form, auto-save, RIDDOR flag)
- [x] 02-05: Treatment quick mode (presets) and list view
- [x] 02-06: Near-miss capture (photo-first, categories, GPS)
- [x] 02-07: Daily safety checklist (10 items, status tracking)
- [x] 02-08: App navigation, home dashboard, integration
- [x] 02-09: [GAP CLOSURE] Fix auto-save timing and verify presets
- [x] 02-10: [GAP CLOSURE] Fix import paths and verify offline

### Phase 3: Sync Engine
**Goal**: Mobile app data syncs to backend automatically when connectivity available, with photo uploads that don't block workflow and zero data loss.

**Depends on**: Phase 2

**Success Criteria** (what must be TRUE):
  1. Treatment logged offline syncs when connectivity returns
  2. Photos upload in background without blocking workflow
  3. Sync status badge shows pending count at all times
  4. Failed sync surfaces plain language error with retry
  5. RIDDOR incident sync failure triggers critical alert
  6. Sync respects WiFi-only constraint for large photos
  7. Background sync doesn't drain battery (constraints verified)
  8. Concurrent edits resolve with last-write-wins
  9. Client-generated UUIDs prevent duplicate records
  10. Progressive upload syncs preview first, full-quality later

**Plans**: 7 plans

Plans:
- [x] 03-01: Hybrid foreground/background sync scheduler
- [x] 03-02: Progressive photo upload with WiFi-only constraints
- [x] 03-03: SyncQueue with RIDDOR fast retry, LWW conflict resolution
- [x] 03-04: Sync feedback UI (error display, RIDDOR alert, progress)
- [x] 03-05: Wire Phase 2 forms to sync queue
- [x] 03-06: [GAP CLOSURE] Add battery/network runtime constraints
- [x] 03-07: [GAP CLOSURE] Add UUID idempotency keys

### Phase 4: Web Dashboard
**Goal**: Site managers can view treatment logs, worker registry, near-miss reports, and compliance scores in real-time from desktop browser.

**Depends on**: Phase 3

**Requirements**: DASH-01 through DASH-10, EXPORT-01 through EXPORT-03

**Success Criteria** (what must be TRUE):
  1. Manager sees traffic-light compliance score
  2. Manager can filter treatment log by date/severity/outcome
  3. Manager can click into treatment for full detail with photos
  4. Manager can view near-miss log with filters
  5. Manager can search worker registry by company/role/cert status
  6. Dashboard updates via 60-second polling
  7. Manager can export treatment log as CSV or PDF
  8. Manager can export worker registry as CSV
  9. Dashboard is responsive (desktop and tablets)

**Plans**: 6 plans

Plans:
- [x] 04-01: Dashboard scaffold with auth and responsive layout
- [x] 04-02: Overview with compliance score and weekly stats
- [x] 04-03: Treatment log with filtering/sorting, detail view, photos
- [x] 04-04: Near-miss log and worker registry with search
- [x] 04-05: Data export (CSV/PDF) and responsive polish
- [x] 04-06: Integration verification checkpoint

### Phase 4.5: Marketing Website & Booking Portal (INSERTED)
**Goal**: Public marketing website and client self-service booking portal operational with Stripe payment processing and auto-matching.

**Depends on**: Phase 1.5, Phase 4

**Success Criteria** (what must be TRUE):
  1. Marketing website loads in <2 seconds (Lighthouse >90)
  2. Client completes booking in <5 minutes
  3. Stripe payment processing works in test mode
  4. Auto-matching presents ranked candidates with transparency
  5. Pricing shows base + urgency + travel + VAT
  6. Medic receives booking notification email
  7. Client receives confirmation with calendar invite
  8. Established clients see Net 30 option
  9. New clients must prepay via card (3D Secure)
  10. Recurring bookings can be created

**Plans**: 6 plans

Plans:
- [x] 04.5-01: Marketing website with Next.js SSG
- [x] 04.5-02: Booking portal calendar and site location
- [x] 04.5-03: Stripe payment integration (prepay vs Net 30)
- [x] 04.5-04: Auto-matching UI and booking confirmation flow
- [x] 04.5-05: [GAP CLOSURE] Real booking data in confirmation

### Phase 4.6: Customer Onboarding & Contract Management (INSERTED)
**Goal**: Automated service agreement generation with digital signatures, document portal, flexible payment terms, and payment milestone enforcement.

**Depends on**: Phase 1.5, Phase 4.5

**Success Criteria** (what must be TRUE):
  1. Service agreement auto-generates with client info pre-filled
  2. Pricing breakdown matches booking (base + urgency + travel + VAT)
  3. Admin selects payment terms per booking (5 options)
  4. Payment terms update in agreement
  5. Admin can send agreement during phone call
  6. Client receives email with signing link
  7. Client can view and sign digitally
  8. Agreement shows status in admin (Sent/Viewed/Signed/Completed)
  9. Signed agreement PDF stored with audit trail
  10. Payment schedule enforces based on agreement
  11. Admin can manage templates
  12. Booking requires signed agreement (configurable)

**Plans**: 7 plans

Plans:
- [x] 04.6-01: Database schema, types, state machine, payment logic
- [x] 04.6-02: Contract PDF generation Edge Function
- [x] 04.6-03: Signature pad and client signing page
- [x] 04.6-04: Admin creation UI with payment terms selector
- [x] 04.6-05: Contract sending via Resend email with webhooks
- [x] 04.6-06: Admin dashboard, detail view, template management
- [x] 04.6-07: Payment milestone enforcement and booking gate

### Phase 5: PDF Generation
**Goal**: Weekly safety reports auto-generate every Friday and on-demand with professional formatting ready for HSE audits.

**Depends on**: Phase 4

**Requirements**: PDF-01 through PDF-07, NOTIF-01

**Success Criteria** (what must be TRUE):
  1. Weekly safety report auto-generates every Friday
  2. PDF generation completes in <10 seconds
  3. PDF includes company branding
  4. Manager can download or receive via email
  5. PDF stored with signed URL for secure access
  6. Manager receives email notification when ready
  7. PDF is audit-ready for HSE inspectors

**Plans**: 4 plans

Plans:
- [x] 05-01: Edge Function with @react-pdf/renderer and data queries
- [x] 05-02: Storage bucket, PDF upload, Resend email, signed URLs
- [x] 05-03: pg_cron Friday scheduling and dashboard reports page
- [x] 05-04: Integration verification checkpoint

### Phase 5.5: Admin Operations Dashboards (INSERTED)
**Goal**: Admin dashboard operational with booking management, medic roster, territory coverage map, revenue tracking, timesheet approval, and client management.

**Depends on**: Phase 1.5, Phase 4, Phase 5

**Success Criteria** (what must be TRUE):
  1. Admin can view all bookings with filters
  2. Admin can approve/reject bookings requiring manual review
  3. Admin can reassign medic with reason
  4. Admin can view medic roster with availability calendar
  5. Admin can batch-approve 20 timesheets in <5 minutes
  6. Territory map displays color-coded utilization
  7. Coverage gap alerts trigger at >10% rejection rate
  8. Revenue dashboard shows platform fees per territory/medic
  9. Cash flow projection warns at >30 day gap
  10. Admin can upgrade client to Net 30 payment terms

**Plans**: 6 plans

Plans:
- [x] 05.5-01: Booking approval workflow with bulk operations
- [x] 05.5-02: Medic roster with utilization and availability
- [x] 05.5-03: Timesheet batch approval for Friday payout
- [x] 05.5-04: Territory coverage map with utilization colors
- [x] 05.5-05: Revenue dashboard with Recharts and cash flow
- [x] 05.5-06: Client management with Net 30 upgrade

### Phase 6: RIDDOR Auto-Flagging
**Goal**: App automatically detects RIDDOR-reportable incidents with deadline countdown, medic override capability, and pre-filled HSE F2508 form generation.

**Depends on**: Phase 5

**Requirements**: RIDD-01 through RIDD-06, NOTIF-02

**Success Criteria** (what must be TRUE):
  1. Treatment matching RIDDOR criteria auto-flags with confidence
  2. Medic can confirm or override flag with reason
  3. Flagged incident shows deadline countdown
  4. App generates pre-filled HSE F2508 form PDF
  5. Dashboard shows RIDDOR deadline countdown
  6. Manager receives email at 3 days before deadline
  7. RIDDOR report tracks status (Draft/Submitted/Confirmed)
  8. Override patterns track for algorithm tuning

**Plans**: 8 plans

Plans:
- [x] 06-01: Database schema and RIDDOR detection Edge Function
- [x] 06-02: Mobile medic override UI with reason capture
- [x] 06-03: HSE F2508 PDF generation with form mapping
- [x] 06-04: Web dashboard RIDDOR pages with deadline countdown
- [x] 06-05: Deadline tracking cron and email notifications
- [x] 06-06: Override pattern analytics dashboard
- [x] 06-07: [GAP CLOSURE] Database trigger for auto-detection
- [x] 06-08: [GAP CLOSURE] Replace hardcoded org_id with auth

### Phase 6.5: Payment Processing & Payouts (INSERTED)
**Goal**: Full payment processing operational with client charging (card + Net 30), automated weekly medic payouts via UK Faster Payments, IR35 compliance, and out-of-territory cost management.

**Depends on**: Phase 1.5, Phase 5.5

**Success Criteria** (what must be TRUE):
  1. Client payment processing works (card + 3D Secure)
  2. Friday payout job runs automatically (zero failures)
  3. Medics receive funds within 2 business days
  4. Platform fee calculation correct (30/hr medic → 42/hr client)
  5. Invoice PDF generated with VAT and Net 30 terms
  6. Late payment auto-reminders at 7/14/21 days
  7. Medic onboarding captures IR35 status
  8. Stripe Express onboarding link works
  9. Payslip PDF generated for medic records
  10. Out-of-territory calculates travel bonus vs room/board
  11. Admin sees cost breakdown and can approve/deny
  12. System denies booking if cost >50% (admin can override)

**Plans**: 12 plans

Plans:
- [x] 06.5-01: Client payment processing with Stripe
- [x] 06.5-02: Friday payout automation with UK Faster Payments
- [x] 06.5-03: Invoice generation with VAT and late payment handling
- [x] 06.5-04: IR35 compliance and medic onboarding
- [x] 06.5-05: Out-of-territory cost management
- [x] 06.5-06: [GAP CLOSURE] Fix platform fee and renumber migrations
- [x] 06.5-07: [GAP CLOSURE] Wire Resend email and pg_cron jobs
- [x] 06.5-08: [GAP CLOSURE] Payslip PDF generation Edge Function
- [x] 06.5-09: [GAP CLOSURE] Stripe onboarding webhook and GB validation
- [x] 06.5-10: [GAP CLOSURE] Wire out-of-territory approval into workflow
- [x] 06.5-11: [GAP CLOSURE] Fix payslip_reference and cron vault auth
- [x] 06.5-12: [GAP CLOSURE] Re-add Resend email (regression fix)

### Phase 7: Certification Tracking
**Goal**: System tracks UK certifications with progressive expiry alerts, prevents expired workers from logging incidents, and surfaces compliance status to managers.

**Depends on**: Phase 6

**Requirements**: CERT-01 through CERT-06, NOTIF-03, NOTIF-04

**Success Criteria** (what must be TRUE):
  1. System tracks UK certifications (CSCS, CPCS, IPAF, PASMA, Gas Safe)
  2. Dashboard shows certifications expiring in 30/60/90 days
  3. Workers with expired certs show critical alert (red)
  4. Manager receives email when certification expires
  5. Progressive reminders send (30, 14, 7, 1 days before)
  6. Expired cert prevents worker selection for incident logging
  7. Email notifications use professional template
  8. Server-side scheduled jobs check expiry daily

**Plans**: 6 plans

Plans:
- [x] 07-01: Database infrastructure (GIN index, reminders table, RPC)
- [x] 07-02: Certification expiry checker Edge Function with emails
- [x] 07-03: Certifications dashboard with status badges
- [x] 07-04: Certification validation API (expired blocking)
- [x] 07-05: [GAP CLOSURE] Wire validation into mobile treatment forms
- [x] 07-06: [GAP CLOSURE] Replace hardcoded org name with real query

### Phase 7.5: Territory Management & Auto-Assignment (INSERTED)
**Goal**: UK-wide territory system operational with postcode-based coverage, intelligent auto-assignment algorithm, coverage gap detection, and hiring recommendations.

**Depends on**: Phase 1.5, Phase 4.5, Phase 5.5

**Success Criteria** (what must be TRUE):
  1. UK postcode sector database fully seeded (~11,232 sectors)
  2. Can assign primary + secondary medic to sector (drag-drop UI)
  3. Auto-assignment ranks by distance/utilization/qualifications/availability/rating
  4. Out-of-territory logic calculates travel time
  5. System compares travel bonus vs room/board cost
  6. Admin sees cost breakdown and system recommends deny at >50%
  7. Coverage gap alerts trigger at >10% rejection rate for 3+ weeks
  8. Hiring recommendations display with territory grouping
  9. Visual coverage map updates every 5 minutes with colors
  10. Admin can click sector to see medic, stats, bookings
  11. Auto-assignment matches 95% of bookings (100 simulated test)

**Plans**: 5 plans

Plans:
- [x] 07.5-01: Territory metrics aggregation (pg_cron daily)
- [x] 07.5-02: Enhanced auto-assignment with calendar check and certs
- [x] 07.5-03: Drag-drop medic-to-territory assignment panel
- [x] 07.5-04: Coverage gap alerts and hiring recommendations UI
- [x] 07.5-05: Enhanced map with territory detail panel

---

## Milestone Summary

**Decimal Phases (Inserted):**

- Phase 1.5: Business Operations Foundation (inserted for booking portal + payments foundation)
- Phase 4.5: Marketing Website & Booking Portal (inserted for client self-service)
- Phase 4.6: Customer Onboarding & Contract Management (inserted for service agreements)
- Phase 5.5: Admin Operations Dashboards (inserted for admin tools)
- Phase 6.5: Payment Processing & Payouts (inserted for payment automation)
- Phase 7.5: Territory Management & Auto-Assignment (inserted for UK-wide coverage)

**Key Decisions:**

- iOS-first, no Android: Medics use iPhones; avoid multi-platform complexity (✓ v1.0)
- React Native with Expo: Faster development, JavaScript alignment (✓ v1.0)
- Offline-first architecture: Construction sites have unreliable connectivity (✓ v1.0 - zero data loss)
- Supabase for backend: PostgreSQL + Auth + Storage + UK hosting (✓ v1.0)
- Weekly PDF as core deliverable: Site managers need for HSE audits (✓ v1.0 - cron scheduled)
- RIDDOR auto-flagging: App intelligence reduces compliance risk (✓ v1.0 - auto-detection working)
- Territory-based assignment: UK postcode sectors enable geographic optimization (✓ v1.0 - 100% auto-assignment)
- Stripe Connect for medics: Express accounts handle UK Faster Payments (✓ v1.0 - weekly payouts working)

**Issues Resolved:**

- Context efficiency: Milestone archive pattern keeps ROADMAP.md constant size
- Gap closure workflow: Phase verification → gap identification → additional plans → re-verification
- Decimal phase numbering: Clear insertion semantics for urgent additions mid-milestone
- Background sync constraints: Battery + network checks prevent excessive drain
- UUID idempotency: Client-generated UUIDs prevent duplicate records on sync retry
- RIDDOR enforcement: Database trigger wires auto-detection into treatment data pipeline
- Platform fee calculation: Corrected 71.4/28.6 split (medic £30/hr → client £42/hr)
- Certification validation: Wired into mobile treatment forms at point of use

**Technical Debt:**

- Booking confirmation page: Uses mock data instead of fetching real booking (medium severity - confirmation emails work correctly)
- Foundation requirements tracking: 18 Phase 1 requirements (ARCH/AUTH/GDPR) functionally complete but checkboxes not updated in REQUIREMENTS.md

**Production Readiness:**

- 98% ready (46/47 cross-phase connections working, 4/5 E2E flows complete)
- 84,500 lines of TypeScript/TSX/SQL
- 13 phases, 84 plans, 400+ tasks executed
- All core features operational and verified
- Known issues documented in v1.0-MILESTONE-AUDIT.md

---

_For current project status, see .planning/PROJECT.md_
_Archived: 2026-02-17_
