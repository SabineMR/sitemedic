# Milestone v2.0: Multi-Vertical Platform Expansion

**Status:** ✅ SHIPPED 2026-02-18
**Phases:** 18–23 (including 18.5)
**Total Plans:** 30

## Overview

Expanded SiteMedic from a construction-only platform to a multi-vertical medic compliance platform. Film/TV, Festivals & Events, Motorsport, and Football each received their own incident forms, RIDDOR rules, PDF outputs, cert types, and in-app terminology. Added near-miss heat maps and compliance trend analytics visible at both org and platform level.

## Phases

### Phase 18: Vertical Infrastructure & RIDDOR Fix

**Goal:** The platform's core systems are vertical-aware — RIDDOR never fires for non-applicable verticals, the mobile app knows its vertical without hitting the network on every form mount, the WatermelonDB schema has all columns every subsequent phase requires, and admins and clients can set a vertical.

**Depends on:** Phase 17 (v1.1 complete)
**Requirements:** VERT-01, VERT-02, VERT-03, VERT-04, VERT-05, VERT-06
**Plans:** 5 plans

Plans:
- [x] 18-01-PLAN.md — WatermelonDB schema v4: event_vertical, vertical_extra_fields, booking_id to treatments; gps_lat, gps_lng to near_misses; Supabase SQL migration 124; compliance_score_history table
- [x] 18-02-PLAN.md — Vertical-aware RIDDOR detector: gate riddor-detector on non-RIDDOR verticals; F2508 generator returns 400 for non-RIDDOR; scaffold 3 new Edge Functions; incident-report-dispatcher utility
- [x] 18-03-PLAN.md — Mobile OrgContext: create src/contexts/OrgContext.tsx with AsyncStorage caching; register OrgProvider in app/_layout.tsx between AuthProvider and SyncProvider
- [x] 18-04-PLAN.md — Booking vertical override: remove per-mount fetchOrgVertical from new.tsx; add useOrg + useLocalSearchParams; booking_id + event_vertical in sync payload
- [x] 18-05-PLAN.md — Admin + client vertical settings: add eventVertical to BookingRequest and Supabase insert in /api/bookings/create; verify admin vertical selector already works

---

### Phase 18.5: Construction & Infrastructure Vertical (INSERTED)

**Goal:** Formalize construction as a first-class vertical in the new multi-vertical system. The construction vertical already works end-to-end from v1.0 — this phase wires it into the shared vertical config, cert ordering, and dispatcher so it behaves identically to the new verticals and serves as the reference implementation for Phase 19–22.

**Depends on:** Phase 18 (vertical infrastructure, schema v4, OrgContext, incident-report-dispatcher)
**Requirements:** CONST-01, CONST-02, CONST-03
**Plans:** 2 plans

Plans:
- [x] 18.5-01-PLAN.md — Create services/taxonomy/verticals.ts: new canonical VERTICAL_CONFIG file with VerticalConfig interface; construction as reference entry (riddorApplies: true, patientTerm Worker, locationTerm Site, clientTerm Client, certOrdering CSCS-first, pdfGenerator riddor-f2508-generator)
- [x] 18.5-02-PLAN.md — Smoke-test verification: confirm FUNCTION_BY_VERTICAL['construction'] routes to riddor-f2508-generator; confirm construction absent from NON_RIDDOR_VERTICALS; confirm getRecommendedCertTypes includes CSCS/CPCS/IPAF/Gas Safe/PASMA; no code changes

---

### Phase 19: Motorsport Vertical

**Goal:** Medics at motorsport events can log incidents in a Motorsport UK-compliant format. A concussed competitor triggers a mandatory clearance workflow that cannot be bypassed. The event ends with an auto-generated Medical Statistics Sheet. The web dashboard shows uncleared concussion cases with a visible warning badge.

**Depends on:** Phase 18 (vertical infrastructure, schema v4, OrgContext, booking override)
**Requirements:** MOTO-01, MOTO-02, MOTO-03, MOTO-04, MOTO-05, MOTO-06, MOTO-07
**Plans:** 5 plans

Plans:
- [x] 19-01-PLAN.md — Motorsport form fields + concussion gate: MotorsportExtraFields interface, conditional form section in app/treatment/new.tsx with GCS score, extrication, helmet, circuit section, Clerk of Course, car number; mandatory three-step concussion clearance gate blocking form submission
- [x] 19-02-PLAN.md — Cert types + RIDDOR verification: add Motorsport UK Medical Official Licence and BASM Diploma to both cert registries; reorder motorsport cert priority; extend TreatmentWithWorker type; verify RIDDOR gate
- [x] 19-03-PLAN.md — Motorsport PDF Edge Function: replace 501 stub in motorsport-incident-generator with full PDF generation; motorsport-reports storage bucket migration 128; checkpoint for Incident Pack V8.0 download
- [x] 19-04-PLAN.md — Medical Statistics Sheet + dashboard badge: motorsport-stats-sheet-generator Edge Function for per-booking aggregate PDF; concussion clearance badge on treatments table; Generate Stats Sheet button on booking detail
- [x] 19-05-PLAN.md — Integration verification: automated check of all 5 success criteria across all plans; human-verify checkpoint for end-to-end flow

**Research flag:** Motorsport UK Accident Form built with inferred fields from MOTO-01 + DRAFT watermark (user approved). Obtain physical Motorsport UK Incident Pack V8.0 to validate field layout before regulatory submission.

---

### Phase 20: Festivals & Events Vertical

**Goal:** Medics at festivals and events can log incidents using Purple Guide triage categories. The triage data model works correctly alongside existing outcome fields. Festival-goer treatments never trigger RIDDOR. The event organiser receives a Purple Guide-format incident report PDF per treatment.

**Depends on:** Phase 18 (schema v4 with triage_priority column, RIDDOR gate)
**Requirements:** FEST-01, FEST-02, FEST-03, FEST-04, FEST-05, FEST-06
**Plans:** 4 plans

Plans:
- [x] 20-01-PLAN.md — Festival form fields: TST triage priority (P1/P2/P3/P4) required field, alcohol/substance flag, safeguarding flag, attendee disposition; RIDDOR banner gate for festivals; all written to vertical_extra_fields JSONB
- [x] 20-02-PLAN.md — RIDDOR gate verification: confirm festivals in NON_RIDDOR_VERTICALS in riddor-detector and F2508 generator; confirm VERTICAL_COMPLIANCE.festivals.riddorApplies is false; read-only verification
- [x] 20-03-PLAN.md — Purple Guide PDF Edge Function: replace 501 stub with full PurpleGuideDocument React-PDF generation; purple-guide-mapping.ts; storage bucket migration 125
- [x] 20-04-PLAN.md — Dashboard wiring: EventIncidentReportCard, generateEventIncidentPDF query, vertical-aware terminology (Attendee/Venue/Organiser), medic profile recommended cert types (FEST-05)

---

### Phase 21: Film/TV Production Vertical

**Goal:** Medics on film and TV productions can log incidents with production-specific context fields. The existing RIDDOR pipeline continues to operate unchanged for crew members (who are workers under HSE). The app uses production terminology throughout, and the medic's cert profile reflects the Film/TV industry.

**Depends on:** Phase 18 (schema v4, OrgContext, booking override, RIDDOR gate — Film/TV passes through RIDDOR unchanged)
**Requirements:** FILM-01, FILM-02, FILM-03, FILM-04
**Plans:** 2 plans

Plans:
- [x] 21-01-PLAN.md — Film/TV form fields: Production Title, Patient Role picker (9 roles), SFX/Pyrotechnic Involved toggle, Scene/Shot Context; verticalExtraFields wired to auto-save and enqueueSyncItem; ScreenSkills Production Safety Passport and EFR cert types added to both cert registries
- [x] 21-02-PLAN.md — Film/TV vertical wiring: tv_film cert ordering updated (HCPC Paramedic first, ScreenSkills, FREC 4, EFR; CSCS/IPAF removed); getLocationLabel/getEventLabel helpers added; "Cast & Crew" terminology applied across 7 screens; F2508 dispatch confirmed unchanged for tv_film (FILM-04)

---

### Phase 22: Football / Sports Vertical

**Goal:** Medics at football matches can log incidents for two distinct patient types — players and spectators — each with their own form, regulatory framework, and PDF output. Player on-pitch injuries never trigger RIDDOR. The correct PDF (FA or SGSA) is generated automatically based on patient type.

**Depends on:** Phase 18 (schema v4, RIDDOR gate, OrgContext, booking override)
**Requirements:** FOOT-01, FOOT-02, FOOT-03, FOOT-04, FOOT-05, FOOT-06, FOOT-07
**Plans:** 5 plans

Plans:
- [x] 22-01-PLAN.md — Football dual patient type form: patient type selector (Player / Spectator) at form start; conditional Player fields (squad number, phase of play, contact/non-contact, HIA performed/outcome, FA severity); conditional Spectator fields (stand location, row/seat, referral outcome, safeguarding flag/notes, alcohol involvement); validation guards; all written to vertical_extra_fields JSONB in sync payload
- [x] 22-02-PLAN.md — Football RIDDOR gate: verify 'sporting_events' is in NON_RIDDOR_VERTICALS; annotate FOOT-04; Deno-native test asserting gate; confirm F2508 generator 400 guard
- [x] 22-03-PLAN.md — Football PDF Edge Functions: replace fa-incident-generator 501 stub with full FA Match Day Injury Form (player) and SGSA Medical Incident Report (spectator) PDF generation; FAPlayerDocument.tsx, FASpectatorDocument.tsx, mapping files; fa-incident-reports storage bucket migration 127
- [x] 22-04-PLAN.md — Football vertical wiring: getPatientLabel('sporting_events') → 'Player'; org-labels.ts sporting_events → Player/Pitch+Ground/Club; 4 new football cert types (ATMMiF, ITMMiF, FA Advanced Trauma Management, FA Concussion Module) + sporting_events CertCategory + VERTICAL_CERT_TYPES update
- [x] 22-05-PLAN.md — Gap closure: FAIncidentReportCard component, fa-incidents query, sporting_events branch in treatment detail page, stale dispatcher comment fix

---

### Phase 23: Analytics — Heat Maps & Trend Charts

**Goal:** Site managers can see where near-misses are geographically clustering on a heat map. Compliance trends over time are visible as line charts on the org dashboard. Platform admins can compare compliance performance across all orgs. All charts read from properly structured history tables populated by existing background processes.

**Depends on:** Phase 18 (GPS columns in schema v4 — gps_lat, gps_lng on near_misses; compliance_score_history table created)
**Requirements:** ANLT-01, ANLT-02, ANLT-03, ANLT-04, ANLT-05, ANLT-06
**Plans:** 7 plans (5 core + 2 gap closure)

Plans:
- [x] 23-01-PLAN.md — Compliance score history: migration 130 (UNIQUE index + platform admin RLS policy on compliance_score_history); generate-weekly-report Edge Function upsert of numeric score 0-100 with v1 formula; formula_version in details JSONB
- [x] 23-02-PLAN.md — Near-miss heat map (org): NearMissHeatMap component using react-leaflet CircleMarker (severity-coded); TanStack Query hook for GPS data; heat-map page on org dashboard at /analytics/heat-map; Analytics nav link in DashboardNav
- [x] 23-03-PLAN.md — Near-miss heat map (platform admin): AdminNearMissHeatMap with org colour-coding; admin query hook; Heat Map tab added to admin analytics page
- [x] 23-04-PLAN.md — Compliance trend charts (org): ComplianceScoreChart (Recharts LineChart, 12-month weekly scores); IncidentFrequencyChart (Recharts AreaChart, treatment + near-miss counts per week); compliance page at /analytics/compliance
- [x] 23-05-PLAN.md — Platform admin compliance analytics: AdminComplianceTrend (aggregate score across all orgs); OrgComplianceTable (top/bottom performers with trend arrows); Compliance tab on admin analytics page
- [x] 23-06-PLAN.md — [GAP CLOSURE] Motorsport Incident Report Card: MotorsportIncidentReportCard component, generateMotorsportIncidentPDF query, wired into treatment detail page for event_vertical === 'motorsport' (closes MOTO-07)
- [x] 23-07-PLAN.md — [GAP CLOSURE] Competitor Clearance UI Toggle: add competitor_cleared_to_return checkbox to mobile motorsport form outside concussion gate (closes Flow 3 stuck clearance)

---

## Milestone Summary

### Decimal Phases

- Phase 18.5: Construction & Infrastructure Vertical (INSERTED after Phase 18) — formalizes construction as first-class vertical; 2 plans; construction already worked end-to-end, this phase added canonical VERTICAL_CONFIG entry as reference for Phases 19–22

### Key Decisions

- Vertical config storage: TypeScript static `Record<string, Config>` files, vertical ID string in DB — no DB config table needed (extensible without migrations)
- RIDDOR gate: `NON_RIDDOR_VERTICALS` array + early-return in `riddor-detector/index.ts` before `detectRIDDOR()` — mobile form uses `getVerticalCompliance(orgVertical).riddorApplies` (policy lookup, not ad-hoc string comparison)
- `verticalExtraFields` uses `@text` not `@json` in WatermelonDB Treatment model — raw JSON string, parsed at call site; keeps model agnostic of vertical-specific data shapes
- Compliance score formula frozen as v1: `100 - 40(no daily check) - 30(RIDDOR deadlines) - 20(overdue followups) - 10(expired certs)`; `formula_version: 'v1'` stored in JSONB for future comparability
- Heat map uses `react-leaflet CircleMarker` not `leaflet.heat` — leaflet.heat is incompatible with react-leaflet@5.0.0; zero new dependencies
- PDF dispatch: per-vertical card components call Edge Functions directly; `incident-report-dispatcher.ts` exists but is orphaned dead code (tech debt)
- `buildVerticalExtraFields()` helper centralises all vertical JSON serialisation in new.tsx — single function replaces per-vertical ternary chains

### Issues Resolved

- Motorsport RIDDOR mobile exclusion: was `orgVertical !== 'festivals'` (missed motorsport) → fixed to `getVerticalCompliance(orgVertical).riddorApplies` (policy-based, covers all non-RIDDOR verticals automatically)
- Football PDF download path unwired (MOTO-07 equivalent for football) — closed by 22-05 gap closure
- MOTO-07: motorsport-incident-generator existed but had no web UI — closed by 23-06 gap closure
- Flow 3: `competitor_cleared_to_return` had no mobile UI toggle — closed by 23-07 gap closure
- Dashboard RIDDOR badge missing `fairs_shows` and `private_events` in `nonRiddorVerticals` — fixed post-audit
- Treatment detail page RIDDOR badge had no vertical guard — fixed post-audit (matches list-view guard)

### Issues Deferred

- `getLocationLabel` / `getEventLabel` exported from vertical-outcome-labels.ts — zero callers; location/event terminology not yet dynamic (patient term is via `getPatientLabel`)
- `useOrgLabels()` in web/lib/org-labels.ts — exported, zero callers
- `incident-report-dispatcher.ts` — orphaned dead code; all callers bypass it via per-vertical query files
- `t.orgId = 'temp-org'` / `t.medicId = 'temp-medic'` — pre-existing v1.0 carry-forward in app/treatment/new.tsx
- Motorsport UK Accident Form PDF built with DRAFT watermark — validate field layout against physical Motorsport UK Incident Pack V8.0 before regulatory submission

### Technical Debt Incurred

- Central PDF dispatcher (`incident-report-dispatcher.ts`) became dead code — per-vertical cards call Edge Functions directly. Remove or wire it when consolidating PDF generation in v3.0+
- `fairs_shows` and `private_events` are in the Edge Function `NON_RIDDOR_VERTICALS` but have no vertical form implementation — deferred to future phase if these verticals are ever added
- Compliance score formula v1 is simple (4 weighted penalties) — may need refinement as data accumulates

---

_For current project status, see .planning/ROADMAP.md_
