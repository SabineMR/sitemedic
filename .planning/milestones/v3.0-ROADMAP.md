# Milestone v3.0: White-Label Platform & Subscription Engine

**Status:** SHIPPED 2026-02-19
**Phases:** 24-31
**Total Plans:** 30

## Overview

Transform SiteMedic into a white-label SaaS engine — each subscribing medic business gets their own branded portal, subdomain, and subscription plan. Apex Safety Solutions is the first live deployment and the v3.0 launch target. Every org gets per-org branding (logo, primary colour, company name) applied consistently across the web portal, PDFs, and emails. Growth and Enterprise orgs get a subdomain at `slug.sitemedic.co.uk`. Three Stripe Billing tiers (Starter £149/mo, Growth £299/mo, Enterprise £599/mo) with a hybrid onboarding flow — pay online, platform admin activates.

## Phases

### Phase 24: DB Foundation

**Goal:** The database schema exists for all v3.0 features. Existing orgs have `org_branding` rows and default subscription tiers. All subsequent phases can read the columns they require from day one.

**Depends on:** Phase 23 (v2.0 complete — last migration was 130/131)

**Requirements:** INFRA-01, INFRA-02, INFRA-03, INFRA-04, INFRA-05

**Success Criteria:**
1. Running migration 132 on a local Supabase instance with existing org data does not error — existing orgs receive an `org_branding` row with empty logo path, null primary colour, and their current company name carried over
2. Running migration 133 on a local Supabase instance does not error — the `organizations` table has `stripe_customer_id`, `stripe_subscription_id`, `subscription_tier`, and `subscription_status` columns; existing rows have `NULL` in all four columns
3. The `org-logos` Supabase Storage bucket exists as a public bucket — a file uploaded to `org-logos/{org_id}/logo.png` is accessible via its public URL without authentication
4. Apex Safety Solutions org row has `subscription_tier = 'growth'` after the backfill — all other existing orgs have `subscription_tier = 'starter'`
5. `next --version` in the web workspace reports ≥ 15.2.3 — the CVE-2025-29927 middleware bypass patch is in place before subdomain routing expands the attack surface in Phase 26

**Plans:** 5 plans

- [x] 24-01-PLAN.md — Next.js CVE patch: bump next and eslint-config-next to ^15.2.3, verify build passes
- [x] 24-02-PLAN.md — Migration 132: org_branding table with RLS, backfill rows for all existing orgs with company_name from organizations.name
- [x] 24-03-PLAN.md — Migration 133: subscription columns on organizations + Apex/starter tier backfill
- [x] 24-04-PLAN.md — Migration 134: public org-logos storage bucket with org-scoped write RLS
- [x] 24-05-PLAN.md — Verify all migrations and document legacy org behaviour for downstream phases

---

### Phase 25: Billing Infrastructure

**Goal:** The billing webhook handler is deployed and registered in Stripe Dashboard before any org completes Stripe Checkout. The `FEATURE_GATES` constant and `hasFeature()` helper exist as the single source of truth for tier gating. Stripe Products and Prices for all three tiers exist with their IDs captured as env vars.

**Depends on:** Phase 24 (subscription columns must exist on `organizations` before the webhook handler writes to them)

**Requirements:** SUB-01, SUB-03, GATE-01

**Success Criteria:**
1. Three Stripe Products exist in the Stripe Dashboard (Starter £149/mo, Growth £299/mo, Enterprise £599/mo) — their price IDs are stored as `STRIPE_PRICE_STARTER`, `STRIPE_PRICE_GROWTH`, `STRIPE_PRICE_ENTERPRISE` in Vercel env vars
2. A Stripe test-mode `checkout.session.completed` event fired via the Stripe CLI arrives at `/api/stripe/billing-webhooks` and writes the correct `stripe_customer_id` and `subscription_status` to the `organizations` table — the existing Connect webhook endpoint at `/api/stripe/webhooks` is untouched
3. `hasFeature('starter', 'white_label')` returns `false` and `hasFeature('growth', 'white_label')` returns `true` — the `FEATURE_GATES` constant is the sole source of truth for both values, no duplication in component code
4. `STRIPE_BILLING_WEBHOOK_SECRET` is a distinct env var from `STRIPE_WEBHOOK_SECRET` — the two Stripe systems have separate signing secrets, preventing event cross-contamination

**Plans:** 3 plans

- [x] 25-01-PLAN.md — Stripe Products setup: env var template for billing Price IDs and webhook secret; user creates 3 Products with 18 Prices in Stripe Dashboard (test mode)
- [x] 25-02-PLAN.md — Feature gates: create web/lib/billing/feature-gates.ts with FEATURE_GATES constant, hasFeature() helper, isAtLeastTier() helper, SubscriptionTier and FeatureKey types
- [x] 25-03-PLAN.md — Billing webhook handler: migration 135 (webhook_events table + subscription_status_updated_at column); create web/app/api/stripe/billing-webhooks/route.ts handling checkout.session.completed, customer.subscription.updated, customer.subscription.deleted, invoice.payment_failed

---

### Phase 26: Subdomain Routing

**Goal:** Each org on Growth or Enterprise tier is accessible at `slug.sitemedic.co.uk`. The Next.js middleware securely extracts the subdomain, resolves the org, and injects `x-org-*` headers that all SSR pages consume. The branded login page shows the org's own identity to unauthenticated visitors.

**Depends on:** Phase 24 (Next.js ≥15.2.3 must be in place before middleware changes expand the attack surface — CVE-2025-29927)

**Requirements:** ROUTE-01, ROUTE-02, ROUTE-03, ROUTE-04

**Success Criteria:**
1. Visiting `apex.sitemedic.co.uk/login` in a browser shows the Apex Safety Solutions login page — the org's company name appears in the header, not "SiteMedic", and no 404 or generic fallback is served
2. The Next.js middleware strips any incoming `x-org-*` headers before setting its own — an HTTP request crafted with a forged `x-org-id` header does not inject a false org context into the route handler
3. Visiting a slug that does not match any org (`notexist.sitemedic.co.uk`) redirects to the apex domain root rather than serving a blank or broken page
4. Each org subdomain requires its own sign-in — a session obtained at `app.sitemedic.co.uk` does not carry over to `apex.sitemedic.co.uk` (cookie domain is not widened to `.sitemedic.co.uk`)

**Plans:** 4 plans

- [x] 26-01-PLAN.md — Environment Setup & DNS Initiation: add NEXT_PUBLIC_ROOT_DOMAIN env var; checkpoint for Vercel wildcard domain + DNS CNAME configuration
- [x] 26-02-PLAN.md — Middleware Subdomain Extraction & Header Injection: extractSubdomain() helper, x-org-* header stripping (CVE-2025-29927), service-role org+branding lookup by slug, header injection, unknown slug redirect
- [x] 26-03-PLAN.md — Branded Login Page: convert login to server component + client form; read x-org-* headers for org branding; fallback to SiteMedic defaults; "Powered by SiteMedic" footer
- [x] 26-04-PLAN.md — Auth Cookie Scope Verification & Local Dev Testing: fix signout route for subdomain support; verify cookie scope isolation; regression-test auth redirects

---

### Phase 27: Branding — Web Portal

**Goal:** The web portal reflects each org's brand identity — header logo, sidebar accent colour, login page company name, and browser tab title all resolve from the org's `org_branding` row, injected server-side via `x-org-*` headers before any client JavaScript runs. No flash of unbranded content.

**Depends on:** Phase 26 (middleware must inject `x-org-*` headers before the portal can consume them)

**Requirements:** BRAND-03, BRAND-06

**Success Criteria:**
1. Loading `apex.sitemedic.co.uk/dashboard` in a browser shows "Apex Safety Solutions" in the portal header and the Apex logo replaces the SiteMedic logo — no client-side fetch for branding occurs after page load (verify in Network tab: no `/api/branding` request on page load)
2. The primary accent colour throughout the portal (sidebar highlights, buttons, active states) matches the org's configured hex colour — changing `primary_colour_hex` in the `org_branding` table and hard-refreshing the page shows the new colour immediately
3. An org with no branding configured (null logo, null colour) sees the SiteMedic defaults throughout — no broken image placeholders, no missing colour variables
4. The browser tab title for an org portal reads "[Company Name] — SiteMedic" — not the generic "SiteMedic" title

**Plans:** 3 plans

- [x] 27-01-PLAN.md — BrandingContext + Root Layout Integration: BrandingProvider with useBranding() hook, CSS custom property injection, root layout reads headers and wraps in provider, generateMetadata() for dynamic tab title
- [x] 27-02-PLAN.md — Dashboard Layout Rebrand: sidebar header shows org company name, logo/initials, tagline from x-org-* headers
- [x] 27-03-PLAN.md — Admin Layout Rebrand: replace all blue-600/blue-700 with var(--org-primary), logo swap, company name and tagline from useBranding()

---

### Phase 28: Branding — PDFs & Emails

**Goal:** Org logo and company name appear in all generated PDFs and transactional emails. No hardcoded "Apex Safety Group Ltd" or "SiteMedic" branding remains in any PDF Edge Function or email template — every call site fetches org branding before rendering.

**Depends on:** Phase 26 (org branding data exists in `org_branding` table, `org-logos` bucket is live)

**Requirements:** BRAND-04, BRAND-05

**Success Criteria:**
1. Downloading a weekly PDF safety report for an org with a configured logo shows the org's logo in the PDF header — not the SiteMedic logo or a blank placeholder
2. All 8 PDF Edge Functions fetch `org_branding` via service role before rendering — the `branding` prop is required (TypeScript compile error if omitted)
3. A booking confirmation email sent for an org with a configured logo shows the org's logo in the email header and the org's primary colour in the email accent
4. All 3 email templates have a required `branding: OrgBranding` prop — all sending routes fetch org branding before calling `resend.emails.send()`

**Plans:** 3 plans

- [x] 28-01-PLAN.md — Shared PDF branding infrastructure + pilot: create _shared/branding-helpers.ts (OrgBranding type, fetchOrgBranding, fetchLogoAsDataUri) and _shared/pdf-branding.tsx (BrandedPdfHeader, BrandedPdfFooter); integrate into generate-weekly-report as pilot test
- [x] 28-02-PLAN.md — PDF branding rollout: apply proven branding pattern to remaining 7 PDF Edge Functions
- [x] 28-03-PLAN.md — Email branding: create EmailBranding type; update 4 email templates with required branding prop; update 3 sending routes to fetch org_branding

---

### Phase 29: Org Onboarding Flow

**Goal:** A new medic business can discover SiteMedic, select a subscription plan, pay online via Stripe Checkout, and arrive at a post-payment branding setup wizard — all without manual Sabine involvement until the platform admin activation step. Platform admin sees a pending activation queue and triggers the welcome email on approval.

**Depends on:** Phase 25, Phase 27

**Requirements:** SUB-02, SUB-04, ONBOARD-01, ONBOARD-02, ONBOARD-03, ONBOARD-04

**Success Criteria:**
1. A new user visiting `sitemedic.co.uk/signup` can select a plan, complete Stripe Checkout in test mode, and land on a post-payment page confirming their payment is received and their account is pending activation
2. After the Stripe `checkout.session.completed` webhook fires, the platform admin dashboard shows the new org in a "Pending Activation" queue
3. Platform admin can click "Activate" on a pending org, assign a subdomain slug, and trigger the welcome email
4. The new org admin receives a welcome email containing their login URL, their chosen plan, and a getting-started guide
5. The post-payment setup wizard allows the new org admin to upload their logo, pick a primary colour, and set their company name before platform admin activation

**Plans:** 5 plans

- [x] 29-01-PLAN.md — Checkout route + org provisioning: create Stripe Checkout Session with org + org_branding + membership creation
- [x] 29-02-PLAN.md — Signup page with plan selection: multi-step flow (plan cards, account + org details, magic link, auto-checkout on return)
- [x] 29-03-PLAN.md — Onboarding wizard + middleware: post-payment success page, branding setup step
- [x] 29-04-PLAN.md — Platform admin activation queue: pending activation section, Activate endpoint, welcome email
- [x] 29-05-PLAN.md — Welcome email template + sender: React Email template with org branding support

---

### Phase 30: Subscription Management & Feature Gating

**Goal:** Feature gating is enforced at both the API and UI layer simultaneously. Starter-tier orgs see contextual upgrade prompts on Growth-gated features. Org admins can manage their subscription via the Stripe Customer Portal. Platform admin has an MRR dashboard. Orgs with lapsed or cancelled subscriptions see a suspension screen with data preserved and reactivation path clearly signposted.

**Depends on:** Phase 25, Phase 29

**Requirements:** GATE-02, GATE-03, GATE-04, SUB-05, SUB-06, SUB-07

**Success Criteria:**
1. A Starter-tier org admin visiting a Growth-gated page sees a contextual upgrade prompt — not a blank page or generic error
2. A Starter-tier org making a direct API call to a Growth-gated endpoint receives a `403 Forbidden` response
3. An org admin on any tier can access the Stripe Customer Portal from their billing settings page
4. The platform admin subscriptions dashboard shows all org subscriptions with plan tier, status, monthly charge, and a summary MRR figure
5. An org whose subscription is cancelled or payment has lapsed sees a "Subscription Inactive" screen

**Plans:** 5 plans

- [x] 30-01-PLAN.md — TierGate component + requireTier() API helper: shared UI and server-side gating primitives
- [x] 30-02-PLAN.md — Feature gate wiring: wrap branding section with TierGate, add requireTier() to branding API routes
- [x] 30-03-PLAN.md — Stripe Customer Portal: POST /api/billing/portal + Manage Billing button on settings page
- [x] 30-04-PLAN.md — Platform admin MRR dashboard: /platform/subscriptions page with per-tier breakdown and org table
- [x] 30-05-PLAN.md — Suspension flow: middleware subscription check + /suspended page with reactivation path

---

### Phase 31: Branding Settings UI

**Goal:** Org admins can self-serve their branding configuration — upload logo, pick primary colour, set company name and tagline — and see a live preview of how changes will appear. Platform admins can configure branding for any org as a white-glove setup service for new subscribers.

**Depends on:** All preceding phases (bucket from Phase 24, org_branding from Phase 24, BrandingProvider from Phase 27, feature gates from Phase 30)

**Requirements:** BRAND-01, BRAND-02

**Success Criteria:**
1. An org admin on the Growth tier can navigate to their branding settings page, upload a logo, select a primary colour, and edit their company name and tagline
2. After uploading a logo, the logo file is accessible at its Supabase Storage public URL
3. A Starter-tier org admin visiting the branding settings page sees an upgrade prompt
4. A platform admin can navigate to any org in the platform admin panel and override that org's branding

**Plans:** 2 plans

- [x] 31-01-PLAN.md — Org admin branding settings page: BrandingForm component, BrandingPreview live panel, TierGate wrapping
- [x] 31-02-PLAN.md — Platform admin branding override: service-role API route, expandable branding section per org card

---

## Milestone Summary

**Key Decisions:**

- Separate Stripe webhook endpoints: `/api/stripe/billing-webhooks` (Billing) vs `/api/stripe/webhooks` (Connect) — different signing secrets
- Tier never stored in JWT — middleware reads `organizations.subscription_tier` on every request for immediate effect after webhook fires
- `BrandingContext` is separate from `OrgContext` — SSR headers vs client-side mount; merging creates a race condition
- CSS custom properties (`var(--org-primary)`) are the only correct pattern for per-org colours — Tailwind JIT cannot use runtime-constructed class names
- Cookie domain NOT widened to `.sitemedic.co.uk` — each subdomain requires its own sign-in to prevent cross-org session leak
- Legacy orgs (NULL stripe_customer_id) get access granted until they go through onboarding
- Public bucket for org-logos — logos in PDFs/emails need stable URLs; signed URLs expire mid-render
- `fetchLogoAsDataUri()` for PDF rendering — @react-pdf/renderer in Deno Edge cannot reliably fetch remote images
- Service-role client for platform admin branding ops — platform admin JWT has org_id=NULL so RLS blocks direct writes

**Issues Resolved:**

- CVE-2025-29927 patched before subdomain routing expanded attack surface
- Pre-existing build blocker: undefined `previousStatus` in contract signing fixed
- Missing `logo_path` in branding API PUT handler fixed during Phase 31 execution
- Auth cookie scope verified — no cross-org session leak via subdomain

**Issues Deferred:**

- Vercel wildcard domain `*.sitemedic.co.uk` + DNS CNAME configuration (external infrastructure)
- Apply Supabase migrations 132-135 to production
- Create Stripe Products/Prices in Stripe Dashboard (test mode validated)
- Register billing webhook with Stripe signing secret
- DPA template from solicitor (non-code blocker)

**Technical Debt Incurred:**

- Phase 25: Missing VERIFICATION.md (all plan summaries exist, requirements marked complete)
- `getLocationLabel`/`getEventLabel` orphaned exports from v2.0
- `incident-report-dispatcher.ts` dead code from v2.0
- Motorsport PDF DRAFT watermark from v2.0

---

_For current project status, see .planning/ROADMAP.md_
