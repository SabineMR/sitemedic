# Milestone v5.0: Internal Comms & Document Management

**Status:** SHIPPED 2026-02-20
**Phases:** 40-47
**Total Plans:** 21

## Overview

Org admins can communicate with their field medics and collect compliance documents inside SiteMedic -- replacing scattered WhatsApp/email with an in-platform system tied to individual medic profiles. Messaging works across iOS app and web dashboard with offline support, real-time delivery, and push notifications. Document management handles upload, categorisation, expiry tracking, and progressive alerts.

## Phases

### Phase 40: Comms & Docs Foundation

**Goal**: The database schema, storage buckets, RLS policies, and TypeScript types exist for the entire v5.0 messaging and document management system -- all scoped to org_id so no data leaks between organisations
**Depends on**: Phase 39 (v4.0 complete)
**Requirements**: PLAT-03
**Plans**: 2 plans

Plans:
- [x] 40-01-PLAN.md — Database schema and RLS (migration 143: conversations, messages, message_recipients, conversation_read_status, document_categories, documents, document_versions; org_id RLS policies; indexes; triggers; default category seeding)
- [x] 40-02-PLAN.md — Storage buckets and TypeScript types (migration 144: medic-documents bucket, message-attachments bucket, storage RLS policies; web/types/comms.types.ts)

### Phase 41: Web Messaging Core

**Goal**: Org admins and medics can have 1:1 text conversations through the web dashboard -- with a conversation list showing unread counts and a message thread view for sending and reading messages
**Depends on**: Phase 40
**Requirements**: MSG-01, MSG-02, MSG-03, MSG-04
**Plans**: 3 plans

Plans:
- [x] 41-01-PLAN.md — Conversation list page (query functions, navigation, header unread badge, two-panel layout, conversation rows with unread counts)
- [x] 41-02-PLAN.md — Message thread view (dynamic route, message display, send API, mark-as-read, scroll-to-bottom, Enter-to-send input)
- [x] 41-03-PLAN.md — New conversation flow (create conversation API with duplicate prevention, admin medic picker dialog, medic "Message Admin" button)

### Phase 42: iOS Messaging & Offline

**Goal**: Messaging works on the iOS app with the same functionality as web, messages sync between platforms, and medics can view cached messages and queue outbound messages when offline
**Depends on**: Phase 41
**Requirements**: MSG-07, MSG-08, PLAT-01
**Plans**: 3 plans

Plans:
- [x] 42-01-PLAN.md — WatermelonDB models and sync (Conversation + Message models, schema v4 to v5 migration, MessageSync service with pull/push sync, SyncContext integration)
- [x] 42-02-PLAN.md — iOS conversation list and thread UI (Messages tab in bottom bar, ConversationList with unread badges and pull-to-refresh, MessageThread with flat Slack-style layout, MessageInput with Return-to-send, MedicPicker for new conversations)
- [x] 42-03-PLAN.md — Offline queue and delivery (connectivity-triggered push/pull sync, queued message styling with greyed out + clock indicator, idempotency_key deduplication, offline banners, failed message retry, human verification checkpoint)

### Phase 43: Real-time & Push Notifications

**Goal**: Messages arrive instantly when the app or web dashboard is open (no manual refresh), and medics receive iOS push notifications for new messages when the app is backgrounded -- with GDPR-safe notification content
**Depends on**: Phase 42
**Requirements**: NOTIF-01, NOTIF-02, NOTIF-03
**Plans**: 3 plans

Plans:
- [x] 43-01-PLAN.md — Supabase Realtime subscription (single channel per user filtering on org_id; message INSERT + read status UPDATE listeners; WatermelonDB upsert on iOS; TanStack Query invalidation on web; polling completely replaced)
- [x] 43-02-PLAN.md — iOS push notification setup (PushTokenService for token registration in profiles.push_token; NotificationContext for foreground toast, background tap deep linking, app badge count; permission prompt on first Messages tab visit)
- [x] 43-03-PLAN.md — Push notification Edge Function and DB trigger (send-message-notification Edge Function via Expo Push API; GDPR-safe payload with sender name only; AFTER INSERT trigger on messages via pg_net; DeviceNotRegistered token cleanup)

### Phase 44: Broadcast Messaging

**Goal**: Org admins can send broadcast messages to all medics in their organisation, broadcasts appear in each medic's conversation list as a distinct message type, and the admin can track how many medics have read each broadcast
**Depends on**: Phase 43 (real-time needed so broadcasts arrive instantly)
**Requirements**: MSG-05, MSG-06, MSG-10
**Plans**: 2 plans

Plans:
- [x] 44-01-PLAN.md — Broadcast send and delivery (migration 151, POST /api/messages/broadcast, BroadcastComposeDialog, ConversationRow broadcast display, MessageThread read-only notice)
- [x] 44-02-PLAN.md — Broadcast read tracking (PATCH /api/messages/broadcast/read, GET /api/messages/broadcast/{messageId}/recipients, BroadcastReadSummary, BroadcastReadDrilldown, useBroadcastReadSummaries hook)

### Phase 45: Document Upload & Profile Storage

**Goal**: Medics can upload categorised compliance documents (PDF, image) with expiry dates from either the iOS app or web dashboard, documents are stored on the medic's profile visible to their org admin, and uploading a new version of a document type archives the previous version
**Depends on**: Phase 40 (schema and storage buckets)
**Requirements**: DOC-01, DOC-02, DOC-03, DOC-04, DOC-05, DOC-08, DOC-09, PLAT-02
**Plans**: 3 plans

Plans:
- [x] 45-01-PLAN.md — Web document upload and API foundation (4 API routes: categories list/create, document upload with versioning, document list, signed URL download; medic /documents page with drag-and-drop upload dialog, category picker, expiry date with does-not-expire toggle, document list grouped by category, download and version replacement actions)
- [x] 45-02-PLAN.md — iOS document upload (Documents tab in bottom bar; upload screen with expo-document-picker for files and expo-image-picker for camera capture; category selection, expiry date, certificate number; direct Supabase Storage upload; same versioning logic; document list with download and new version actions)
- [x] 45-03-PLAN.md — Admin document views and custom categories (admin medic document view with category grouping, expiry badges, download, version history; custom category management page for org admins to create/toggle org-specific categories)

### Phase 46: Expiry Tracking & Alerts

**Goal**: Documents show colour-coded status badges based on expiry proximity, medics and admins receive progressive email alerts as documents approach expiry, and org admins have a bulk view of all documents expiring across their organisation in the next 30 days
**Depends on**: Phase 45
**Requirements**: DOC-06, DOC-07, DOC-10
**Plans**: 2 plans

Plans:
- [x] 46-01-PLAN.md — Migration 155 + Edge Function for progressive expiry alerts (document_expiry_reminders audit table, get_documents_expiring_in_days RPC, mark_expired_documents function, pg_cron daily job at 8:00 UTC, document-expiry-checker Edge Function with medic digest emails at 30/14/7/1 days and admin digest at 14/7/1 days, Resend with dev mode fallback)
- [x] 46-02-PLAN.md — Bulk expiry dashboard (TanStack Query hooks for expiring documents, /admin/document-expiry page with summary cards + tabbed data table + category filter, DashboardNav item with FileWarning icon)

### Phase 47: Message Polish

**Goal**: Messages show delivery and read status indicators, users can search across all their conversations, and users can attach documents or files to messages -- completing the messaging feature set
**Depends on**: Phase 44 (broadcast complete), Phase 45 (document storage for attachments)
**Requirements**: MSG-09, MSG-11, MSG-12
**Plans**: 3 plans

Plans:
- [x] 47-01-PLAN.md — Delivery and read status (migration 157 with updated_at trigger + tsvector FTS column + GIN index + REPLICA IDENTITY; PATCH /api/messages/[messageId]/status with forward-only state machine; MessageStatusIndicator component with Lucide Check/CheckCheck icons; Realtime UPDATE subscription for live status changes; auto-delivered on Realtime INSERT; mark-as-read on thread open advances messages to 'read')
- [x] 47-02-PLAN.md — Cross-conversation search (GET /api/messages/search using PostgreSQL textSearch with websearch type; ConversationSearch overlay panel with debounced input; SearchResultItem with conversation name, sender, snippet, timestamp; useMessageSearch hook; ConversationList search toggle integration)
- [x] 47-03-PLAN.md — Message file attachments (POST /api/messages/attachments/upload with FormData to message-attachments bucket; GET /api/messages/attachments/download with signed URL; AttachmentPicker with Paperclip button and file validation; MessageAttachment with image thumbnail or file icon display; MessageInput pending file preview and dual send mode; MessageItem attachment rendering)

---

## Milestone Summary

**Key Decisions:**
- Flat Slack-style message layout (not chat bubbles) for professional comms
- Single Supabase Realtime channel per org (not per conversation) to avoid connection exhaustion
- Forward-only message status state machine (sent → delivered → read, no regression)
- GDPR-safe push notifications (sender name only, never message content)
- PostgreSQL tsvector GENERATED column with GIN index for full-text search
- REPLICA IDENTITY FULL for Realtime UPDATE payloads
- WatermelonDB offline queue with idempotency_key deduplication
- Document versioning via current_version_id (archive old, don't delete)
- Progressive expiry alerts at 30/14/7/1 days via pg_cron + Edge Function
- Storage path convention: {orgId}/{entityId}/{filename} for org isolation

**Issues Resolved:**
- Phase 42 gap: unread badge query used local WatermelonDB ID instead of serverId — fixed in re-verification
- Migration 156 already taken by Phase 37 (company_roster_medics) — used 157 for message polish

**Issues Deferred:**
- Header unread badge SSR-only (no Realtime, updates on page navigation)
- iOS offline round-trip needs physical device test
- Push notifications need real device + APNS credentials

**Technical Debt Incurred:**
- Resend API key required for production email delivery (dev mode logs to console)
- pg_cron job requires Supabase production instance (not available locally)
- 6 migrations (143, 144, 150, 151, 155, 157) pending production application

---

_For current project status, see .planning/ROADMAP.md_
