# Milestone v1.1: Post-MVP Polish & Data Completeness

**Status:** ✅ SHIPPED 2026-02-17
**Phases:** 08–17
**Total Plans:** 35

## Overview

v1.1 closes gaps identified in the post-v1.0 codebase audit. The focus is on surfacing data already being collected, completing backend features that have no UI, making the platform production-ready with proper loading/error states, and opening analytics that have been running silently in the background. No new features — just completing what was already built. Also closes two critical bugs found during integration audit (payslip query, RIDDOR draft inputs) and adds the deferred geofence coverage analytics.

## Phases

### Phase 08: Lead Capture & Data Persistence

**Goal:** Persist contact form and quote builder submissions to the database so no lead is lost and admins can follow up.
**Priority:** CRITICAL
**Plans:** 4 plans

Plans:
- [x] 08-01-PLAN.md — Database migration: contact_submissions + quote_submissions tables with RLS
- [x] 08-02-PLAN.md — API route updates: DB-first persistence for contact and quote routes
- [x] 08-03-PLAN.md — Admin submissions page with contact/quote tabs and inline status management
- [x] 08-04-PLAN.md — Quote-to-booking pre-fill via URL search params on new booking form

**Details:**
Created contact_submissions and quote_submissions tables with org-scoped RLS (service-role-insert pattern). Both public API routes now persist to DB before fire-and-forget email (DB-first pattern). Admin CRM at /admin/submissions with searchable/filterable tables and inline status management. Quote-to-booking conversion via URLSearchParams pre-fills /admin/bookings/new.

---

### Phase 09: Booking Data Completeness

**Goal:** Surface all booking data that is collected but never displayed.
**Priority:** HIGH
**Plans:** 3 plans

Plans:
- [x] 09-01-PLAN.md — What3WordsDisplay component + API fix + confirmation page data surfacing
- [x] 09-02-PLAN.md — BookingWithRelations type fix + admin booking detail Sheet panel
- [x] 09-03-PLAN.md — Wire View Details button + What3Words integration + recurring chain view

**Details:**
What3WordsDisplay component with copy button and w3w.co link. Booking confirmation now shows specialNotes, what3words, recurrencePattern. Admin booking detail panel surfaces approval_reason, cancellation_reason, cancelled_by, refund_amount. Recurring booking chain shows all instances with per-instance status.

---

### Phase 10: Real-Time Operations Polish

**Goal:** Make the command centre actually usable in a live shift.
**Priority:** HIGH
**Plans:** 5 plans

Plans:
- [x] 10-01-PLAN.md — Resolve location store TODO: medicContext Map with joined medic+booking query
- [x] 10-02-PLAN.md — Map marker popup: add shift time display to Leaflet Popup
- [x] 10-03-PLAN.md — Payment retry: retry button, reference number, support mailto
- [x] 10-04-PLAN.md — Alert notes end-to-end + bulk dismiss for non-critical alerts
- [x] 10-05-PLAN.md — Alert escalation timer, suggested actions, contact fallback

**Details:**
Location store TODO resolved: medicContext Map joins medic name, booking site, and shift times to each ping. Map marker shows "Kai Jensen — Royal Exchange Site, 07:00-15:00". Payment failure page has retry button + reference number + support mailto. Alert dismiss prompts for note, bulk dismiss for low/medium severity. 15-minute escalation timer with red pulse + audio. 9 alert types with static suggested actions.

---

### Phase 11: Organisation Settings

**Goal:** Replace all hardcoded business configuration values with per-organisation settings.
**Priority:** MEDIUM
**Plans:** 3 plans

Plans:
- [x] 11-01-PLAN.md — Database migration: org_settings table with constraints, RLS, and seed data
- [x] 11-02-PLAN.md — Admin settings API route (GET/PUT) and Business Configuration UI section
- [x] 11-03-PLAN.md — Wire all 7 consumer files to read from org_settings (remove hardcoded values)

**Details:**
org_settings table with base_rate, geofence_default_radius, urgency_premiums (JSONB), admin_email, net30_eligible, credit_limit. Admin settings page at /admin/settings. All 7 consumer files (booking pricing, geofence defaults, urgency premium validation, email routing) now read from DB. Zero hardcoded business values remain.

---

### Phase 12: Analytics Dashboard

**Goal:** Visualise the operational metrics computed in background since Phase 07.5.
**Priority:** MEDIUM
**Plans:** 5 plans

Plans:
- [x] 12-04-PLAN.md — Analytics data API: TanStack Query hooks for all chart data sources (Wave 1)
- [x] 12-01-PLAN.md — Territory analytics components: heatmap, hiring trigger cards, coverage gap table (Wave 2)
- [x] 12-02-PLAN.md — Assignment analytics components: success rate chart, failure breakdown (Wave 2)
- [x] 12-03-PLAN.md — Medic utilisation components: sortable table, OOT bookings, late arrival heatmap (Wave 2)
- [x] 12-05-PLAN.md — Wire all 3 new tabs into analytics page in single pass (Wave 3)

**Details:**
Full analytics dashboard with Territory, Assignments, and Utilisation tabs. Territory heatmap with hiring trigger cards ("Manchester M1 — 94% utilisation — HIRE NOW"). Auto-assignment success rate chart (12 weeks). Medic utilisation sortable table + OOT booking cost impact. Late arrival heatmap. All new tab queries org_id isolated via useRequireOrg().

---

### Phase 13: UX Polish & Missing States

**Goal:** Add skeleton loaders, geofence map picker, geofence exit alerts, RIDDOR management.
**Priority:** MEDIUM
**Plans:** 4 plans

Plans:
- [x] 13-01-PLAN.md — Skeleton loaders for treatments, workers, organizations, and command center (Wave 1)
- [x] 13-02-PLAN.md — Geofence schema fix + interactive Leaflet map picker (Wave 1)
- [x] 13-03-PLAN.md — Geofence exit alert: haversine distance check on every ping (Wave 2)
- [x] 13-04-PLAN.md — RIDDOR auto-save, audit trail, and photo gallery (Wave 2)

**Details:**
Skeleton loaders on 4 pages (6-row treatment skeletons, worker/org cards). Geofence map picker: click-to-place centre, drag-to-resize radius via Leaflet. Geofence exit monitor: haversine check on every location ping, creates geofence_failure medic_alert. RIDDOR: 30-second debounced auto-save, status history audit trail, photo gallery from treatment-photos bucket.

---

### Phase 14: Compliance, Exports & Medic Portal

**Goal:** Enable data export, show certification expiry alerts, IR35 results, contract history, payslip download.
**Priority:** MEDIUM/LOW
**Plans:** 5 plans

Plans:
- [x] 14-01-PLAN.md — Payslip PDF download: use stored pdf_url first, edge function fallback
- [x] 14-02-PLAN.md — Export buttons: RIDDOR PDF, timesheets CSV, bookings CSV, invoices CSV
- [x] 14-03-PLAN.md — Medic profile: certification expiry banners with renewal links
- [x] 14-04-PLAN.md — Medic profile: IR35 status display with assessment date and CEST PDF
- [x] 14-05-PLAN.md — Contract detail: fix PDF downloads, readable timeline, milestone tracker

**Details:**
Payslip PDF download in 2 clicks (stored pdf_url fast path, generate-payslip-pdf edge function fallback). RIDDOR export as F2508-formatted PDF. CSV exports for timesheets, bookings, invoices. Certification expiry banners at 30-day threshold with renewal links. IR35 status card with assessment date + CEST link. Contract detail with version history, amendment trail, milestone payment tracker.

---

### Phase 15: Code Quality & Housekeeping

**Goal:** Remove production console statements, add manual booking matching UI, fix schedule board.
**Priority:** LOW
**Plans:** 3 plans

Plans:
- [x] 15-01-PLAN.md — Console sweep: remove 3 console.warn from API routes (Wave 1)
- [x] 15-02-PLAN.md — Schedule board: remove mock data fallback, add proper error/empty states (Wave 1)
- [x] 15-03-PLAN.md — Manual medic assignment: extend match endpoint + booking detail panel dialog (Wave 2)

**Details:**
Zero console.log/warn in production web/app/** code. Admin "Assign Medic Manually" dialog in booking detail panel calling /api/bookings/match with overrideMedicId. Schedule board shows proper empty state when no bookings (no more mock shift data).

---

### Phase 16: Critical Bug Fixes

**Goal:** Fix two bugs breaking key E2E flows found during milestone integration audit.
**Priority:** CRITICAL
**Gap Closure:** Closes GAP-1, GAP-2 from v1.1-MILESTONE-AUDIT.md
**Plans:** 2 plans

Plans:
- [x] 16-01-PLAN.md — Payslip medic_id fix + console.warn removal in stores (Wave 1)
- [x] 16-02-PLAN.md — RIDDOR detail draft edit inputs: category select + override_reason textarea (Wave 1)

**Details:**
Payslip: changed `.eq('medic_id', user.id)` → `.eq('medic_id', medic.id)` + null guard. Medics now see their correct timesheets. RIDDOR: added Draft Review card with category `<select>` (5 RIDDOR categories) and override reason `<textarea>` wired to existing 30s auto-save. Removed console.warn from useMedicLocationsStore.ts.

---

### Phase 17: Geofence Coverage Analytics

**Goal:** Surface % of active booking sites covered by at least one geofence (deferred Phase 13 requirement).
**Priority:** MEDIUM
**Gap Closure:** Closes GAP-3 from v1.1-MILESTONE-AUDIT.md
**Plans:** 1 plan

Plans:
- [x] 17-01-PLAN.md — Geofence coverage stat: TanStack Query hook + stat card on geofences page

**Details:**
New useGeofenceCoverage hook: two parallel Supabase queries (active bookings + active geofences with booking_id IS NOT NULL), client-side Set intersection for dedup, 60s polling. GeofenceCoverageCard renders above geofence list with green (full)/blue (partial)/gray (none) colour states. Edge cases: "No active bookings to cover" when total=0.

---

## Milestone Summary

**Requirements shipped:** 33/33

**Key Decisions:**

- Service-role-insert pattern for public form APIs (contact/quote) — bypasses RLS, DB-first before email
- Dead field exclusion from quote DB insert (location always '', duration always '1-day')
- org_settings as source of truth for all business configuration values
- TanStack Query with 60s polling for all admin data (no manual useEffect+setState fetching)
- Two-query + Set intersection for geofence coverage (avoids DB view/RPC, no migration needed)
- Geofence map picker: Leaflet with click-to-place + drag-resize (no coordinate inputs)
- RIDDOR auto-save: 30s debounced useRef pattern (no toast, silent save on draft only)
- Payslip: two-step lookup (user_id → medic.id → timesheets.medic_id)

**Issues Resolved:**

- Payslip query returning 0 rows for all medics (auth UUID vs medics table UUID)
- RIDDOR draft editing impossible (state setters had no UI inputs)
- console.warn noise in useMedicLocationsStore.ts production code
- Phase 13 VERIFICATION.md missing (added retroactively, 13/13 passed)
- Geofence coverage analytics deferred from Phase 13 (now complete in Phase 17)

**Issues Deferred (Tech Debt):**

- Analytics overview tab: 5 legacy DB view queries lack org_id filter (single-tenant acceptable)
- useMedicLocationsStore.ts: useEffect inside window !== undefined check (redundant guard, harmless)
- payout-summary.tsx: dead code component + 2 orphaned API routes (payout cycle works via different path)

---

_For current project status, see .planning/ROADMAP.md_
