---
phase: 07-certification-tracking
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - web/app/api/certifications/validate/route.ts
  - web/components/dashboard/workers-table.tsx
  - web/components/dashboard/workers-columns.tsx
  - web/lib/queries/workers.ts
autonomous: true

must_haves:
  truths:
    - "API endpoint rejects worker selection when any certification is expired with 403 status"
    - "Worker registry table shows real certification status per worker (not hardcoded Active)"
    - "Workers with expired certs display red badge in worker table"
    - "Cert status filter in workers table filters by real certification status"
    - "API validation returns list of expired certification types in error response"
  artifacts:
    - path: "web/app/api/certifications/validate/route.ts"
      provides: "Server-side certification validation endpoint"
      exports: ["POST"]
    - path: "web/components/dashboard/workers-table.tsx"
      provides: "Updated workers table with real cert status filtering"
      contains: "certStatusFilter"
    - path: "web/components/dashboard/workers-columns.tsx"
      provides: "Updated columns with cert status badge"
      contains: "CertificationStatusBadge"
  key_links:
    - from: "web/app/api/certifications/validate/route.ts"
      to: "medics.certifications"
      via: "JSONB query for expired certs"
      pattern: "expiry_date.*isPast"
    - from: "web/components/dashboard/workers-columns.tsx"
      to: "web/components/dashboard/certification-status-badge.tsx"
      via: "Import and render CertificationStatusBadge"
      pattern: "CertificationStatusBadge"
    - from: "web/components/dashboard/workers-table.tsx"
      to: "certification status filter"
      via: "Real cert expiry check replacing placeholder"
      pattern: "certStatusFilter"
---

<objective>
Implement certification validation enforcement and update the workers table with real certification status.

Purpose: Closes the compliance loop -- expired certifications are not just displayed but actively enforced. The API validation prevents workers with expired certs from being selected for incident logging (CERT-06), while the worker table replaces the hardcoded "Active" status with real certification expiry data. This is the enforcement layer that ensures certification tracking has teeth.

Output: API validation route + updated worker table components.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-certification-tracking/07-RESEARCH.md
@.planning/phases/07-certification-tracking/07-01-SUMMARY.md
@.planning/phases/07-certification-tracking/07-03-SUMMARY.md

Key reference files:
@web/components/dashboard/workers-table.tsx (cert status filter placeholder at lines 47-50)
@web/components/dashboard/workers-columns.tsx (cert status column with hardcoded "Active")
@web/lib/queries/workers.ts (worker fetch function)
@web/types/certification.types.ts (Certification type from Plan 01)
@web/components/dashboard/certification-status-badge.tsx (badge component from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create certification validation API endpoint</name>
  <files>web/app/api/certifications/validate/route.ts</files>
  <action>
    Create Next.js API route for server-side certification validation:

    Import:
    - createClient from '@/lib/supabase/server'
    - NextResponse from 'next/server'
    - Certification from '@/types/certification.types'

    Export async function POST(request: Request):
    1. Parse request body: { worker_id: string } (worker_id is actually medic_id in this context -- validate worker against medics table certifications)
    2. Validate worker_id is provided, return 400 if missing
    3. Create supabase client
    4. Fetch medic by id: supabase.from('medics').select('id, first_name, last_name, certifications').eq('id', worker_id).single()
    5. If not found, return 404: { error: 'Worker not found' }
    6. Parse certifications JSONB as Certification[]
    7. Filter expired certs: certs where new Date(expiry_date) < new Date() (use date comparison, not date-fns to avoid import issues in API route)
    8. If expiredCerts.length > 0:
       Return 403 JSON:
       ```json
       {
         "valid": false,
         "error": "Worker has expired certification(s)",
         "expired_certs": ["CSCS", "IPAF"],
         "message": "Worker John Smith has 2 expired certification(s): CSCS, IPAF. Workers with expired certifications cannot be selected for incident logging.",
         "worker_name": "John Smith"
       }
       ```
    9. If no expired certs:
       Return 200 JSON:
       ```json
       {
         "valid": true,
         "expired_certs": [],
         "worker_name": "John Smith"
       }
       ```

    Add JSDoc header comment explaining this endpoint enforces CERT-06 requirement.
    Follow existing API route patterns in the codebase.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/sabineresoagli/GitHub/sitemedic/web/tsconfig.json 2>&1 | head -20` to check for type errors.</verify>
  <done>API route at /api/certifications/validate accepts POST with worker_id and returns 200 (valid) or 403 (expired certs) with detailed error message listing expired certification types.</done>
</task>

<task type="auto">
  <name>Task 2: Update workers table with real certification status</name>
  <files>web/components/dashboard/workers-table.tsx, web/components/dashboard/workers-columns.tsx, web/lib/queries/workers.ts</files>
  <action>
    Read all three files first (MANDATORY).

    **web/lib/queries/workers.ts:**
    Update fetchWorkers to also fetch certification data from medics table:
    - After fetching workers, also fetch medics with certifications for the same org
    - For each worker, find matching medic by user_id or cross-reference
    - Add computed fields to each worker: cert_status ('compliant' | 'at-risk' | 'non-compliant' | 'no-certs'), expired_cert_count, expiring_soon_count
    - Alternative simpler approach: Since workers table doesn't have certifications, fetch medics separately and create a Map<medic_user_id, cert_status> for lookup
    - Note: The workers table stores site workers (construction workers on site), while medics table stores medics. If the workers page shows construction workers who don't have certifications tracked, then certification status should show on the admin MEDICS page instead
    - Check what workers-columns currently shows for cert status and update accordingly
    - If workers-columns has a "Cert Status" column showing hardcoded "Active", update it to show real status

    **web/components/dashboard/workers-columns.tsx:**
    - Read the file to find the cert status column
    - Replace hardcoded "Active" badge with CertificationStatusBadge component
    - Import CertificationStatusBadge from './certification-status-badge'
    - Import getCertificationStatus from './certification-status-badge'
    - For the Cert Status column:
      - If worker has certifications data available, find the cert with earliest expiry date
      - Render CertificationStatusBadge with that expiry_date
      - If no certifications, show a gray "No Certs" badge
    - Update the column accessor to read from the new computed certification data

    **web/components/dashboard/workers-table.tsx:**
    - Update the certStatusFilter logic (currently placeholder at lines 47-50)
    - Replace placeholder comment with real filtering:
      - 'all': no filter
      - 'active': workers where cert_status is 'compliant'
      - 'expiring': workers where cert_status is 'at-risk'
      - 'expired': workers where cert_status is 'non-compliant'
      - 'no-certs': workers with no certifications tracked
    - Update the Select options to include meaningful labels:
      - All Status, Active (Compliant), Expiring Soon, Expired, No Certifications

    IMPORTANT: Review the actual data structure in workers-columns.tsx before implementing. The workers table holds construction site workers, and the medics table holds medical professionals. Certification tracking applies to MEDICS (CSCS, CPCS, etc. are construction safety certs that medics need). If the workers-columns cert status refers to medic certifications, implement accordingly. If it refers to construction worker certs (which aren't tracked in the DB), keep the placeholder but add a comment explaining the distinction.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/sabineresoagli/GitHub/sitemedic/web/tsconfig.json 2>&1 | head -30` and confirm no type errors. Verify workers-columns.tsx imports CertificationStatusBadge and workers-table.tsx has real filter logic.</verify>
  <done>Workers/medics table shows real certification status badges (green/amber/red). Cert status filter works with real data. API validation endpoint enforces expired cert blocking at 403 level.</done>
</task>

</tasks>

<verification>
1. POST /api/certifications/validate with expired worker returns 403 with expired_certs array
2. POST /api/certifications/validate with valid worker returns 200 with valid: true
3. Workers/medics table cert status column shows real badges (not hardcoded "Active")
4. Cert status filter dropdown filters workers by real certification state
5. No TypeScript compilation errors
</verification>

<success_criteria>
- Expired certification blocks worker selection via API (403 response with specific cert types)
- Worker/medic table shows real cert status (valid/expiring/expired) per person
- Filter dropdown enables filtering by certification compliance status
- All three files compile without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-certification-tracking/07-04-SUMMARY.md`
</output>
