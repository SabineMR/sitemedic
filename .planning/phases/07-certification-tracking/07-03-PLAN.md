---
phase: 07-certification-tracking
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - web/lib/queries/admin/certifications.ts
  - web/app/(dashboard)/certifications/page.tsx
  - web/components/dashboard/certification-status-badge.tsx
  - web/lib/queries/compliance.ts
  - web/app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows certifications expiring in next 30/60/90 days with filter tabs"
    - "Workers with expired certifications show red critical alert badge"
    - "Compliance score includes real expired cert count (not hardcoded 0)"
    - "Certifications page accessible from sidebar navigation"
    - "Certification status badge shows valid (green), expiring-soon (amber), or expired (red)"
  artifacts:
    - path: "web/lib/queries/admin/certifications.ts"
      provides: "TanStack Query hooks for certification data"
      exports: ["useCertificationSummary", "fetchCertificationSummary"]
    - path: "web/app/(dashboard)/certifications/page.tsx"
      provides: "Certifications dashboard page"
      contains: "CertificationsPage"
    - path: "web/components/dashboard/certification-status-badge.tsx"
      provides: "Reusable cert status badge component"
      exports: ["CertificationStatusBadge"]
  key_links:
    - from: "web/lib/queries/admin/certifications.ts"
      to: "supabase/migrations/031_certification_tracking.sql"
      via: "RPC call get_certification_summary_by_org"
      pattern: "supabase\\.rpc.*get_certification_summary_by_org"
    - from: "web/lib/queries/compliance.ts"
      to: "supabase/migrations/031_certification_tracking.sql"
      via: "RPC call get_expired_cert_count_by_org"
      pattern: "get_expired_cert_count_by_org"
    - from: "web/app/(dashboard)/layout.tsx"
      to: "web/app/(dashboard)/certifications/page.tsx"
      via: "Sidebar navigation link"
      pattern: "certifications"
---

<objective>
Build the certifications dashboard page and integrate real certification data into the existing compliance score.

Purpose: Gives site managers visibility into certification compliance across their workforce -- which certs are expiring soon, which are expired, and overall compliance status. Also replaces the hardcoded `expiredCerts = 0` in the compliance score with real data, activating the existing amber/red traffic light for cert issues.

Output: Dashboard page, query hooks, status badge component, and compliance score integration.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-certification-tracking/07-RESEARCH.md
@.planning/phases/07-certification-tracking/07-01-SUMMARY.md

Key reference files:
@web/lib/queries/admin/medics.ts (TanStack Query hook pattern with org context)
@web/lib/queries/compliance.ts (compliance scoring with expiredCerts placeholder at line 65)
@web/components/dashboard/compliance-score.tsx (renders expiredCerts count)
@web/app/(dashboard)/layout.tsx (sidebar navigation)
@web/app/(dashboard)/riddor/page.tsx (dashboard page pattern to follow)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create certification query hooks and status badge component</name>
  <files>web/lib/queries/admin/certifications.ts, web/components/dashboard/certification-status-badge.tsx</files>
  <action>
    **web/lib/queries/admin/certifications.ts:**
    Follow the exact pattern from web/lib/queries/admin/medics.ts:
    - 'use client' directive
    - Import useQuery from '@tanstack/react-query', createClient, useRequireOrg from '@/contexts/org-context'
    - Import CertificationSummary from '@/types/certification.types'

    Export async function fetchCertificationSummary(supabase, orgId):
    - Call supabase.rpc('get_certification_summary_by_org', { p_org_id: orgId })
    - Return data as CertificationSummary[]
    - Handle error with console.error and throw

    Export function useCertificationSummary():
    - Use useRequireOrg() for orgId
    - queryKey: ['admin', 'certifications', 'summary', orgId]
    - queryFn: fetchCertificationSummary(supabase, orgId)
    - refetchInterval: 60000 (60 seconds)
    - staleTime: 30000

    Export async function fetchExpiringCertifications(supabase, orgId, daysWindow: number):
    - Query medics table where org_id = orgId
    - SELECT id, first_name, last_name, email, certifications
    - Client-side filter: parse JSONB certifications, find certs where expiry_date is within daysWindow of today
    - Return array of { medic_id, medic_name, cert_type, cert_number, expiry_date, days_remaining, status }
    - Use date-fns: parseISO, differenceInDays, isPast, isFuture

    Export function useExpiringCertifications(daysWindow: number):
    - queryKey: ['admin', 'certifications', 'expiring', orgId, daysWindow]
    - 60s polling
    - Calls fetchExpiringCertifications

    **web/components/dashboard/certification-status-badge.tsx:**
    - 'use client' directive
    - Import date-fns: parseISO, isPast, differenceInDays, isFuture
    - Import CertificationStatus from '@/types/certification.types'

    Export function getCertificationStatus(expiryDate: string): CertificationStatus:
    - If isPast(parseISO(expiryDate)): return 'expired'
    - If differenceInDays(parseISO(expiryDate), new Date()) <= 30 && isFuture: return 'expiring-soon'
    - Else: return 'valid'

    Export function CertificationStatusBadge({ expiryDate, showDays = true }):
    - Calculate status using getCertificationStatus
    - Calculate daysRemaining using differenceInDays
    - Config map:
      - valid: bg-green-100 text-green-800, label "Valid"
      - expiring-soon: bg-amber-100 text-amber-800, label "Expires in {N} days"
      - expired: bg-red-100 text-red-800, label "Expired" (or "Expired {N} days ago")
    - Render span with className, status icon (CheckCircle2/AlertTriangle/XCircle from lucide-react), and label text
    - Include aria-label for accessibility
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/sabineresoagli/GitHub/sitemedic/web/tsconfig.json 2>&1 | head -30` to check for type errors.</verify>
  <done>Query hooks export useCertificationSummary and useExpiringCertifications with 60s polling. Badge component renders green/amber/red status with days remaining.</done>
</task>

<task type="auto">
  <name>Task 2: Create certifications dashboard page and integrate with compliance score</name>
  <files>web/app/(dashboard)/certifications/page.tsx, web/lib/queries/compliance.ts, web/app/(dashboard)/layout.tsx</files>
  <action>
    **web/app/(dashboard)/certifications/page.tsx:**
    Create certifications dashboard page following existing dashboard page patterns:
    - 'use client' directive
    - Import useCertificationSummary, useExpiringCertifications from query hooks
    - Import CertificationStatusBadge
    - Import Card, CardContent, CardHeader, CardTitle from '@/components/ui/card'
    - Import DataTable from '@/components/dashboard/data-table' if it exists, else use simple HTML table
    - Import Tabs, TabsContent, TabsList, TabsTrigger from '@/components/ui/tabs' (shadcn)

    Page structure:
    1. Header: "Certification Compliance" title, subtitle showing total medics and compliance rate

    2. Summary cards row (grid 3 cols on lg):
       - Card 1: "Expired" - count of non-compliant medics, red text, XCircle icon
       - Card 2: "Expiring Soon" - count of at-risk medics (within 30 days), amber text, AlertTriangle icon
       - Card 3: "Compliant" - count of compliant medics, green text, CheckCircle2 icon

    3. Tabs for time windows: "30 Days" | "60 Days" | "90 Days" | "Expired"
       - Default tab: "30 Days"
       - Each tab shows a table of expiring/expired certifications

    4. Table columns: Medic Name, Certification Type, Certificate Number, Expiry Date (formatted dd MMM yyyy), Days Remaining, Status Badge
       - Sort by days_remaining ascending (most urgent first)
       - Expired tab: filter where status = 'expired', sort by expiry_date descending

    5. Empty state: "No certifications expiring in the next {N} days" with CheckCircle2 icon

    **web/lib/queries/compliance.ts:**
    Update fetchComplianceData to replace hardcoded expiredCerts = 0:
    - Read the file first (MANDATORY)
    - Line 64-65: Replace `const expiredCerts = 0;` with a real query
    - Call supabase.rpc('get_expired_cert_count_by_org', { p_org_id: orgId }) -- BUT fetchComplianceData currently doesn't receive orgId
    - Since fetchComplianceData is called from dashboard/page.tsx without orgId, use a simpler approach: query medics table directly
    - Alternative: Count medics where certifications JSONB contains any item with expiry_date < today
    - Query: SELECT medics where certifications array has any element with expiry_date in the past
    - Use raw SQL via supabase.rpc or use client-side filtering:
      ```typescript
      const { data: medicsWithCerts } = await supabase
        .from('medics')
        .select('certifications')
        .not('certifications', 'eq', '[]');

      let expiredCerts = 0;
      if (medicsWithCerts) {
        for (const medic of medicsWithCerts) {
          const certs = medic.certifications as any[];
          if (certs?.some(c => c.expiry_date && new Date(c.expiry_date) < new Date())) {
            expiredCerts++;
          }
        }
      }
      ```
    - This replaces the hardcoded 0 and activates the compliance score amber/red indicator

    **web/app/(dashboard)/layout.tsx:**
    Update sidebar navigation to add Certifications link:
    - Read the file first (MANDATORY)
    - Import Shield (or ShieldCheck) from 'lucide-react'
    - Add to navigation array AFTER 'Workers' entry:
      ```typescript
      {
        name: 'Certifications',
        href: '/certifications',
        icon: ShieldCheck,
      },
      ```
    - This places Certifications logically after Workers in the sidebar
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/sabineresoagli/GitHub/sitemedic/web/tsconfig.json 2>&1 | head -30` and confirm no type errors. Verify layout.tsx has ShieldCheck import and Certifications nav item.</verify>
  <done>Certifications page shows summary cards + tabbed expiry table. Compliance score queries real expired cert count. Sidebar has Certifications link with ShieldCheck icon.</done>
</task>

</tasks>

<verification>
1. Certifications page at /certifications renders with summary cards and tab view
2. CertificationStatusBadge shows green/amber/red correctly based on expiry date
3. Compliance score in overview page no longer shows hardcoded 0 for expiredCerts
4. Sidebar navigation includes Certifications link after Workers
5. All queries use org context for multi-tenant filtering
6. 60-second polling on certification data
</verification>

<success_criteria>
- Dashboard shows certifications expiring in 30/60/90 day windows with filter tabs
- Expired certs show red badge, expiring-soon shows amber, valid shows green
- Compliance traffic light activates amber/red when certifications expire
- New sidebar nav item visible and linked to /certifications page
</success_criteria>

<output>
After completion, create `.planning/phases/07-certification-tracking/07-03-SUMMARY.md`
</output>
