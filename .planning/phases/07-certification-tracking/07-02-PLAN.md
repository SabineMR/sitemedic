---
phase: 07-certification-tracking
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - supabase/functions/certification-expiry-checker/index.ts
  - supabase/functions/certification-expiry-checker/email-templates.ts
  - supabase/migrations/032_certification_expiry_cron.sql
autonomous: true

must_haves:
  truths:
    - "Edge Function checks all 4 reminder stages (30, 14, 7, 1 days) on each daily run"
    - "Duplicate reminders prevented by checking certification_reminders table before sending"
    - "Email includes certification type, number, expiry date, days remaining, and renewal link"
    - "pg_cron job scheduled daily at 09:00 UTC to invoke the Edge Function"
    - "Each sent reminder logged to certification_reminders for audit trail"
  artifacts:
    - path: "supabase/functions/certification-expiry-checker/index.ts"
      provides: "Daily certification expiry checking Edge Function"
      contains: "Deno.serve"
    - path: "supabase/functions/certification-expiry-checker/email-templates.ts"
      provides: "Professional email template with SiteMedic branding"
      contains: "sendCertificationExpiryEmail"
    - path: "supabase/migrations/032_certification_expiry_cron.sql"
      provides: "pg_cron daily job schedule"
      contains: "cron.schedule"
  key_links:
    - from: "supabase/functions/certification-expiry-checker/index.ts"
      to: "supabase/migrations/031_certification_tracking.sql"
      via: "RPC call get_certifications_expiring_in_days"
      pattern: "supabase\\.rpc.*get_certifications_expiring_in_days"
    - from: "supabase/functions/certification-expiry-checker/index.ts"
      to: "certification_reminders table"
      via: "INSERT to log sent reminders"
      pattern: "certification_reminders.*insert"
    - from: "supabase/migrations/032_certification_expiry_cron.sql"
      to: "supabase/functions/certification-expiry-checker/index.ts"
      via: "pg_cron HTTP POST invocation"
      pattern: "certification-expiry-checker"
---

<objective>
Build the server-side certification expiry checking system: Edge Function with progressive email reminders and daily pg_cron scheduling.

Purpose: Implements the backend engine that checks for expiring certifications daily, sends progressive email reminders at 30/14/7/1 days before expiry, prevents duplicate sends via audit table, and notifies both medics and site managers. This mirrors the proven RIDDOR deadline checker pattern.

Output: Edge Function (2 files) + SQL migration for cron job.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-certification-tracking/07-RESEARCH.md
@.planning/phases/07-certification-tracking/07-01-SUMMARY.md

Key reference files (mirror these patterns):
@supabase/functions/riddor-deadline-checker/index.ts (Edge Function pattern)
@supabase/functions/riddor-deadline-checker/email-templates.ts (Email template pattern)
@supabase/migrations/021_riddor_deadline_cron.sql (pg_cron pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create certification expiry checker Edge Function</name>
  <files>supabase/functions/certification-expiry-checker/index.ts, supabase/functions/certification-expiry-checker/email-templates.ts</files>
  <action>
    Create two files mirroring the riddor-deadline-checker pattern:

    **email-templates.ts:**
    - Import Resend from 'npm:resend@4.0.2'
    - Initialize resend with Deno.env.get('RESEND_API_KEY')
    - Interface CertExpiryEmailData: medicFirstName, certType, certNumber, expiryDate (formatted string), daysRemaining, renewalUrl (optional), recipientEmail, recipientName, orgName, dashboardUrl
    - Export async function sendCertificationExpiryEmail(data: CertExpiryEmailData): Promise<string | null> that returns resend message ID or null on error
    - Email HTML template matching RIDDOR email style:
      - Header: navy #003366 background with "Certification Expiry Reminder"
      - Alert box: Red background (#fee2e2 / border #dc2626) for daysRemaining <= 1, amber (#fef3c7 / border #f59e0b) for <= 7, blue (#dbeafe / border #2563eb) for others
      - Urgency label: "CRITICAL" for 1 day, "URGENT" for 7 days, "Important" for 14 days, "Reminder" for 30 days
      - Detail rows: Certification Type, Certificate Number, Expiry Date, Days Remaining
      - CTA button: "View Certifications Dashboard" linking to dashboardUrl
      - Next Steps section: 1. Visit certification body website, 2. Complete renewal process, 3. Update your records in SiteMedic
      - Renewal link button if renewalUrl provided
      - Footer: "Apex Safety Group Ltd - Keeping you compliant and working"
    - From address: 'SiteMedic Compliance <notifications@sitemedic.app>'
    - Subject format: `${urgencyLabel}: ${certType} Certification Expires in ${daysRemaining} Day(s)`

    **index.ts:**
    - Import createClient from 'npm:@supabase/supabase-js@2'
    - Import sendCertificationExpiryEmail from './email-templates.ts'
    - Header comment: Phase 7 Certification Tracking - Plan 02
    - Deno.serve handler:
      1. Parse request JSON: { trigger, check_date }
      2. Create supabase client with SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY
      3. Define REMINDER_STAGES = [30, 14, 7, 1]
      4. For each stage in REMINDER_STAGES:
         a. Call supabase.rpc('get_certifications_expiring_in_days', { days_ahead: stage })
         b. For each expiring cert:
            - Check certification_reminders table: SELECT where medic_id, cert_type, days_before match AND sent_at >= today 00:00:00Z -- skip if already sent today
            - Send email to medic via sendCertificationExpiryEmail
            - If stage <= 14 (warning/critical): Also fetch site manager from profiles (role = 'site_manager', org_id = cert.org_id) and send manager email
            - INSERT into certification_reminders: medic_id, cert_type, days_before, sent_at, resend_message_id, org_id
            - Increment totalReminders counter
      5. Also check for EXPIRED certifications (days_ahead = 0): Send expiry notification to manager
      6. Return JSON: { success: true, reminders_sent: totalReminders, expired_notifications: expiredCount, check_date }
      7. Wrap in try/catch, return 500 with error on failure
    - Log each step with console.log for debugging
    - Continue processing even if individual emails fail (batch resilience, same as riddor checker)
    - Use NEXT_PUBLIC_APP_URL || 'http://localhost:30500' for dashboard URL base, link to /certifications page
  </action>
  <verify>Check file exists and has no syntax issues: verify imports, async/await patterns, and JSON response structure match the riddor-deadline-checker pattern.</verify>
  <done>Edge Function at supabase/functions/certification-expiry-checker/ with index.ts (daily checker logic) and email-templates.ts (professional branded email) exists and follows established patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Create pg_cron migration for daily scheduling</name>
  <files>supabase/migrations/032_certification_expiry_cron.sql</files>
  <action>
    Create SQL migration mirroring 021_riddor_deadline_cron.sql exactly:

    1. Enable extensions (idempotent):
       ```sql
       CREATE EXTENSION IF NOT EXISTS pg_cron;
       CREATE EXTENSION IF NOT EXISTS pg_net;
       ```

    2. Unschedule existing job (idempotent):
       ```sql
       SELECT cron.unschedule('certification-expiry-checker');
       ```

    3. Schedule the daily job:
       - Job name: 'certification-expiry-checker'
       - Cron expression: '0 9 * * *' (every day at 09:00 UTC)
       - Body: net.http_post invoking the Edge Function
       - URL from vault: (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'project_url') || '/functions/v1/certification-expiry-checker'
       - Auth from vault: 'Bearer ' || (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'service_role_key')
       - Body: jsonb_build_object('trigger', 'cron', 'check_date', CURRENT_DATE::text)

    4. Add commented-out monitoring queries:
       - View scheduled job
       - Monitor execution history (last 10 runs)
       - Unschedule command
       - Manual trigger command

    Include header comment with Phase 7, Plan 02 reference and dependencies (Edge Function, Resend API key, Vault secrets).
  </action>
  <verify>Review SQL for syntax: cron.schedule call uses $$ delimiters, vault secret references match existing pattern from 021_riddor_deadline_cron.sql.</verify>
  <done>Migration file at supabase/migrations/032_certification_expiry_cron.sql exists with daily 9AM UTC cron job invoking certification-expiry-checker Edge Function via vault-authenticated HTTP POST.</done>
</task>

</tasks>

<verification>
1. Edge Function index.ts iterates all 4 reminder stages (30, 14, 7, 1)
2. Email template has professional SiteMedic branding with urgency-appropriate colors
3. Duplicate prevention checks certification_reminders before sending
4. Each sent email logged to certification_reminders table
5. pg_cron migration uses vault secrets for authentication
6. Manager also notified at 14/7/1 day stages (not just medic)
</verification>

<success_criteria>
- Edge Function handles all 4 progressive reminder stages with duplicate prevention
- Email template matches existing SiteMedic professional style (navy header, urgency colors)
- pg_cron migration schedules daily 9AM UTC check using vault authentication
- Batch resilience: individual email failures don't stop processing
</success_criteria>

<output>
After completion, create `.planning/phases/07-certification-tracking/07-02-SUMMARY.md`
</output>
