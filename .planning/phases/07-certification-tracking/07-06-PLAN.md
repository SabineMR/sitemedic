---
phase: 07-certification-tracking
plan: 06
type: execute
wave: 1
depends_on: ["07-02"]
files_modified:
  - supabase/functions/certification-expiry-checker/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Email notifications show real organization name, not 'Your Organization'"
    - "Medic reminder emails include the actual org name from organizations table"
    - "Manager notification emails include the actual org name"
  artifacts:
    - path: "supabase/functions/certification-expiry-checker/index.ts"
      provides: "Real org name in all email sends"
      contains: "organizations"
  key_links:
    - from: "supabase/functions/certification-expiry-checker/index.ts"
      to: "organizations table"
      via: "supabase.from('organizations').select('name')"
      pattern: "from\\('organizations'\\)"
---

<objective>
Replace hardcoded 'Your Organization' with real org name from organizations table in certification expiry emails.

Purpose: Close Gap 2 (manager email personalization) and Gap 3 (professional template with real branding). Currently, medic reminder emails at lines 86 always use 'Your Organization'. Manager notification emails at lines 128-134 and 181-186 already query the organizations table but the medic emails do not. Fix both: query org name once per cert and use it for all emails.

Output: All certification expiry emails (medic reminders + manager notifications) show the real organization name.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-certification-tracking/07-02-SUMMARY.md

Key file:
- supabase/functions/certification-expiry-checker/index.ts (Edge Function with hardcoded 'Your Organization' on line 86)
- supabase/migrations/00001_organizations.sql (organizations table has 'name' field, NOT 'company_name')
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded org name with real org query in certification expiry checker</name>
  <files>supabase/functions/certification-expiry-checker/index.ts</files>
  <action>
  The Edge Function has TWO places where org name is used:

  1. **Medic reminder emails (line 86):** Hardcoded `orgName: 'Your Organization'` -- this is the bug.
  2. **Manager notification emails (lines 128-134, 181-186):** Already queries organizations table BUT uses `company_name` field which does NOT exist on the organizations table. The organizations table has a `name` field (see migration 00001_organizations.sql). The manager email section queries `select('company_name')` which likely returns null, falling back to 'Your Organization'. Fix this too.

  **Changes to supabase/functions/certification-expiry-checker/index.ts:**

  1. Inside the `for (const cert of expiringCerts)` loop (around line 55), BEFORE the medic email send (line 77), add an org name lookup:
     ```typescript
     // Fetch organization name for email personalization
     const { data: org } = await supabase
       .from('organizations')
       .select('name')
       .eq('id', cert.org_id)
       .single();
     const orgName = org?.name || 'Your Organization';
     ```

  2. Replace the hardcoded `orgName: 'Your Organization'` on line 86 with `orgName: orgName` (using the variable from step 1).

  3. Fix the manager notification org query (around lines 128-134): Change `.select('company_name')` to `.select('name')` and change `org?.company_name` to `org?.name`. Do the same for the expired cert section (around lines 181-186).

  4. Since we now query org name in the medic email section, we can remove the DUPLICATE org query from the manager notification section if they share the same cert/org context. However, to keep the code clean, just fix the field name in both locations. The org query inside the manager section can stay (it's already there), just fix the field name.

  **Summary of changes:**
  - Line ~86: Replace `orgName: 'Your Organization'` with `orgName: orgName` (using new query result)
  - Lines ~129-130: Change `select('company_name')` to `select('name')` and `org?.company_name` to `org?.name`
  - Lines ~182-183: Change `select('company_name')` to `select('name')` and `org?.company_name` to `org?.name`
  - Add new org query before medic email send (around line 75)

  IMPORTANT: The organizations table field is `name` (NOT `company_name`). The `company_name` field exists on the `clients` table, NOT organizations. Verify in migration 00001_organizations.sql.
  </action>
  <verify>
  1. Grep for "Your Organization" in index.ts -- should only appear as fallback value in `|| 'Your Organization'` patterns, NOT as a direct parameter
  2. Grep for "company_name" in index.ts -- should return ZERO matches (all replaced with 'name')
  3. Grep for "select('name')" in index.ts -- should find 3 instances (1 new for medic email, 2 fixed for manager emails)
  4. Grep for "org?.name" in index.ts -- should find 3 instances matching the select queries
  5. Grep for "from('organizations')" in index.ts -- should find 3 instances
  </verify>
  <done>
  - Medic reminder emails at all 4 stages (30/14/7/1 days) include real org name from organizations.name
  - Manager notification emails at critical stages (14/7/1 days) include real org name (field corrected from company_name to name)
  - Expired cert (0 days) manager notification includes real org name (field corrected)
  - Fallback to 'Your Organization' only when organizations query returns null (edge case safety)
  - No hardcoded 'Your Organization' passed as direct orgName parameter
  </done>
</task>

</tasks>

<verification>
- `grep -c "company_name" supabase/functions/certification-expiry-checker/index.ts` returns 0
- `grep "orgName:" supabase/functions/certification-expiry-checker/index.ts` shows variable references, not hardcoded strings
- `grep "from('organizations')" supabase/functions/certification-expiry-checker/index.ts` shows 3 queries
- `grep "select('name')" supabase/functions/certification-expiry-checker/index.ts` shows 3 selects
</verification>

<success_criteria>
1. Zero instances of hardcoded 'Your Organization' passed as orgName parameter (only as fallback in || operator)
2. All 3 email paths (medic reminder, manager critical, manager expired) query organizations.name
3. Field name corrected from company_name to name in all organizations queries
4. Graceful fallback to 'Your Organization' when org query returns null
</success_criteria>

<output>
After completion, create `.planning/phases/07-certification-tracking/07-06-SUMMARY.md`
</output>
