---
phase: 07-certification-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/031_certification_tracking.sql
  - web/types/certification.types.ts
autonomous: true

must_haves:
  truths:
    - "JSONB certifications field has GIN index for fast queries"
    - "certification_reminders table exists for audit trail of sent emails"
    - "PostgreSQL RPC function returns medics with certifications expiring in exactly N days"
    - "TypeScript types define Certification, CertificationStatus, and ReminderStage"
  artifacts:
    - path: "supabase/migrations/031_certification_tracking.sql"
      provides: "GIN index, certification_reminders table, RPC functions"
      contains: "certification_reminders"
    - path: "web/types/certification.types.ts"
      provides: "TypeScript types for certification tracking"
      exports: ["Certification", "CertificationStatus", "ReminderStage", "CertificationSummary"]
  key_links:
    - from: "supabase/migrations/031_certification_tracking.sql"
      to: "medics.certifications"
      via: "GIN index on existing JSONB column"
      pattern: "CREATE INDEX.*certifications.*GIN"
    - from: "web/types/certification.types.ts"
      to: "medics.certifications JSONB schema"
      via: "TypeScript interface matching JSONB structure"
      pattern: "interface Certification"
---

<objective>
Create the database infrastructure and TypeScript types for certification tracking.

Purpose: Establishes the foundation that all other plans depend on -- GIN indexing for performant JSONB queries, a certification_reminders audit table to prevent duplicate emails and provide compliance audit trail, PostgreSQL RPC functions for expiry queries, and shared TypeScript types.

Output: One SQL migration file and one TypeScript types file.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-certification-tracking/07-RESEARCH.md

Key reference files:
@supabase/migrations/002_business_operations.sql (medics table with certifications JSONB field at line 106)
@supabase/migrations/021_riddor_deadline_cron.sql (pg_cron pattern to mirror)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create certification tracking migration</name>
  <files>supabase/migrations/031_certification_tracking.sql</files>
  <action>
    Create SQL migration file with:

    1. GIN index on medics.certifications JSONB column:
       ```sql
       CREATE INDEX IF NOT EXISTS idx_medics_certifications_gin
       ON medics USING GIN (certifications);
       ```

    2. certification_reminders table for audit trail and duplicate prevention:
       - id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
       - medic_id UUID NOT NULL REFERENCES medics(id) ON DELETE CASCADE
       - cert_type TEXT NOT NULL (e.g., 'CSCS', 'CPCS', 'IPAF', 'PASMA', 'Gas Safe')
       - days_before INT NOT NULL (30, 14, 7, 1)
       - sent_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
       - resend_message_id TEXT (for delivery tracking)
       - org_id UUID REFERENCES organizations(id) ON DELETE CASCADE
       - created_at TIMESTAMPTZ DEFAULT NOW()
       - Add indexes: (medic_id, cert_type, days_before, sent_at) for duplicate checking, (org_id) for org-scoped queries
       - Add RLS policy: enable RLS, allow authenticated users to SELECT where org_id matches their org
       - Add COMMENT ON TABLE

    3. PostgreSQL function get_certifications_expiring_in_days(days_ahead INT):
       - Returns TABLE (medic_id UUID, medic_first_name TEXT, medic_last_name TEXT, medic_email TEXT, cert_type TEXT, cert_number TEXT, expiry_date DATE, expiry_date_formatted TEXT, days_remaining INT, renewal_url TEXT, org_id UUID)
       - Query: SELECT from medics, jsonb_array_elements(certifications) as cert
       - WHERE (cert->>'expiry_date')::date = CURRENT_DATE + days_ahead
       - AND available_for_work = true AND email IS NOT NULL
       - Include renewal_url CASE statement for CSCS/CPCS/IPAF/PASMA/Gas Safe
       - Use TO_CHAR for expiry_date_formatted: 'DD Mon YYYY'
       - Mark function as STABLE

    4. PostgreSQL function get_certification_summary_by_org(p_org_id UUID):
       - Returns TABLE (medic_id UUID, medic_name TEXT, total_certs INT, expired_certs INT, expiring_soon_certs INT, valid_certs INT, status TEXT)
       - expired_certs: COUNT where expiry_date < CURRENT_DATE
       - expiring_soon_certs: COUNT where expiry_date BETWEEN CURRENT_DATE AND CURRENT_DATE + 30 days
       - valid_certs: COUNT where expiry_date > CURRENT_DATE + 30 days
       - status: 'non-compliant' if any expired, 'at-risk' if any expiring soon, else 'compliant'
       - ORDER BY status priority (non-compliant first, then at-risk, then compliant), then medic_name
       - Mark function as STABLE

    5. PostgreSQL function get_expired_cert_count_by_org(p_org_id UUID):
       - Returns INT -- count of distinct medics with at least one expired certification
       - Used by compliance score to replace hardcoded 0
       - Mark function as STABLE

    Follow existing migration style from 021_riddor_deadline_cron.sql. Include header comments with phase/plan reference.
  </action>
  <verify>Review the SQL file for syntax correctness: all CREATE statements have matching semicolons, JSONB operators are correct (->>'key'), function bodies use $$ delimiters, and RLS policies reference auth.uid().</verify>
  <done>Migration file exists with GIN index, certification_reminders table with RLS, and 3 PostgreSQL RPC functions (get_certifications_expiring_in_days, get_certification_summary_by_org, get_expired_cert_count_by_org).</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript certification types</name>
  <files>web/types/certification.types.ts</files>
  <action>
    Create TypeScript types file with:

    1. UK_CERT_TYPES constant array: ['CSCS', 'CPCS', 'IPAF', 'PASMA', 'Gas Safe'] as const
    2. UKCertType = typeof UK_CERT_TYPES[number]

    3. Certification interface (matches JSONB structure in medics.certifications):
       - type: UKCertType
       - cert_number: string
       - expiry_date: string (ISO date YYYY-MM-DD)
       - issued_date?: string
       - card_colour?: string (for CPCS card types)
       - notes?: string

    4. CertificationStatus type: 'valid' | 'expiring-soon' | 'expired'

    5. ReminderStage interface:
       - days_before: number
       - urgency: 'info' | 'warning' | 'critical'
       - recipients: ('medic' | 'manager' | 'admin')[]
       - subject_prefix: string

    6. REMINDER_STAGES constant array (exported):
       - { days_before: 30, urgency: 'info', recipients: ['medic'], subject_prefix: 'Reminder' }
       - { days_before: 14, urgency: 'warning', recipients: ['medic', 'manager'], subject_prefix: 'Important' }
       - { days_before: 7, urgency: 'warning', recipients: ['medic', 'manager'], subject_prefix: 'Urgent' }
       - { days_before: 1, urgency: 'critical', recipients: ['medic', 'manager', 'admin'], subject_prefix: 'CRITICAL' }

    7. CertificationSummary interface (matches RPC return):
       - medic_id: string
       - medic_name: string
       - total_certs: number
       - expired_certs: number
       - expiring_soon_certs: number
       - valid_certs: number
       - status: 'compliant' | 'at-risk' | 'non-compliant'

    8. CertificationReminder interface:
       - id: string
       - medic_id: string
       - cert_type: UKCertType
       - days_before: number
       - sent_at: string
       - resend_message_id: string | null
       - org_id: string

    9. Helper type ExpiringCertification (matches RPC return):
       - medic_id: string
       - medic_first_name: string
       - medic_last_name: string
       - medic_email: string
       - cert_type: string
       - cert_number: string
       - expiry_date: string
       - expiry_date_formatted: string
       - days_remaining: number
       - renewal_url: string | null
       - org_id: string

    10. CERT_RENEWAL_URLS record mapping UKCertType to renewal URL strings (same as in RPC function).

    Add JSDoc comments on all exported types. Follow existing types pattern from web/types/database.types.ts.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/sabineresoagli/GitHub/sitemedic/web/tsconfig.json 2>&1 | head -20` to check for type errors in the new file.</verify>
  <done>TypeScript types file exists at web/types/certification.types.ts with all certification-related types, constants, and helper types exported.</done>
</task>

</tasks>

<verification>
1. Migration file at supabase/migrations/031_certification_tracking.sql exists with valid SQL
2. TypeScript types at web/types/certification.types.ts compile without errors
3. GIN index targets existing medics.certifications column
4. certification_reminders table has RLS enabled
5. All 3 RPC functions are defined as STABLE
</verification>

<success_criteria>
- Migration file defines GIN index, certification_reminders table, and 3 RPC functions
- TypeScript types compile and export all certification-related interfaces
- No existing files modified (pure additive foundation)
</success_criteria>

<output>
After completion, create `.planning/phases/07-certification-tracking/07-01-SUMMARY.md`
</output>
