---
phase: 19-motorsport-vertical
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - supabase/functions/motorsport-incident-generator/index.ts
  - supabase/functions/motorsport-incident-generator/types.ts
  - supabase/functions/motorsport-incident-generator/MotorsportIncidentDocument.tsx
  - supabase/functions/motorsport-incident-generator/motorsport-mapping.ts
  - supabase/migrations/125_motorsport_storage_bucket.sql
autonomous: false

must_haves:
  truths:
    - "The motorsport-incident-generator Edge Function returns a signed URL to a PDF when invoked with a valid motorsport treatment incident_id"
    - "The generated PDF includes all Motorsport UK-relevant fields: GCS score, extrication, helmet removed, circuit section, competitor car number, Clerk of Course notification, concussion status"
    - "The motorsport-reports storage bucket exists with RLS policies"
    - "The function returns 400 if event_vertical is not 'motorsport'"
  artifacts:
    - path: "supabase/functions/motorsport-incident-generator/index.ts"
      provides: "Full PDF generation replacing 501 stub"
      contains: "renderToBuffer"
    - path: "supabase/functions/motorsport-incident-generator/MotorsportIncidentDocument.tsx"
      provides: "React PDF component for Motorsport UK Accident Form"
      contains: "Document"
    - path: "supabase/functions/motorsport-incident-generator/motorsport-mapping.ts"
      provides: "Treatment data to form data mapping"
      exports: ["mapTreatmentToMotorsportForm"]
    - path: "supabase/functions/motorsport-incident-generator/types.ts"
      provides: "Full MotorsportFormData type"
      contains: "MotorsportFormData"
    - path: "supabase/migrations/125_motorsport_storage_bucket.sql"
      provides: "motorsport-reports storage bucket + RLS policies"
      contains: "motorsport-reports"
  key_links:
    - from: "supabase/functions/motorsport-incident-generator/index.ts"
      to: "MotorsportIncidentDocument.tsx"
      via: "renderToBuffer import"
      pattern: "renderToBuffer.*MotorsportIncidentDocument"
    - from: "supabase/functions/motorsport-incident-generator/index.ts"
      to: "motorsport-mapping.ts"
      via: "mapTreatmentToMotorsportForm import"
      pattern: "mapTreatmentToMotorsportForm"
    - from: "supabase/functions/motorsport-incident-generator/index.ts"
      to: "supabase.storage.from('motorsport-reports')"
      via: "PDF upload to storage bucket"
      pattern: "motorsport-reports"
---

<objective>
Replace the 501 stub in motorsport-incident-generator with a full PDF generation Edge Function.

Purpose: MOTO-07 requires a Motorsport UK-style Accident Form PDF per incident. The `motorsport-incident-generator` Edge Function stub (created in Phase 18) currently returns 501. This plan replaces it with a working implementation that fetches treatment data, maps it to form fields, renders a PDF using @react-pdf/renderer, stores it in the `motorsport-reports` bucket, and returns a signed URL. The PDF uses the best-available field mapping (from MOTO-01 requirements and Motorsport UK regulatory text) with a "Draft" watermark until validated against the physical Incident Pack V8.0 form.

Output: Working Edge Function, PDF component, mapping file, types file, and storage bucket migration.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-motorsport-vertical/19-RESEARCH.md
@.planning/phases/19-motorsport-vertical/19-01-SUMMARY.md

Key references:
- `supabase/functions/riddor-f2508-generator/index.ts` — the exact pattern to follow (import structure, Supabase client, data fetch, renderToBuffer, storage upload, signed URL).
- `supabase/functions/riddor-f2508-generator/F2508Document.tsx` — PDF component pattern (Page, View, Text, StyleSheet from @react-pdf/renderer).
- `supabase/functions/riddor-f2508-generator/f2508-mapping.ts` — mapping function pattern.
- `supabase/functions/riddor-f2508-generator/types.ts` — type definition pattern.
- `supabase/functions/motorsport-incident-generator/index.ts` — current 501 stub to replace.
- `supabase/functions/motorsport-incident-generator/types.ts` — current minimal type to expand.
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Download Motorsport UK Incident Pack V8.0</name>
  <action>
    Before building the PDF component, attempt to obtain the physical Motorsport UK Accident Form:

    1. Download from: https://motorsportuk.s3.eu-west-2.amazonaws.com/wp-content/uploads/2025/03/Incident-Pack-V8.0.pdf
    2. Open in a PDF reader and identify the Accident Form page(s)
    3. Document the field names, sections, and layout

    If the PDF is available and readable, use the exact field names for the PDF template.
    If the PDF is not obtainable, proceed with the "Draft" approach using MOTO-01 fields and regulatory text as the basis, clearly marking the PDF with a "DRAFT - Pending Motorsport UK form validation" watermark.
  </action>
  <how-to-verify>
    If you downloaded and read the Incident Pack V8.0 PDF, describe the form sections and field names you found. Type "proceed with official form" and provide the field list.

    If you could not obtain it, type "proceed with draft" to continue with the inferred fields from research.
  </how-to-verify>
  <resume-signal>Type "proceed with official form" (with field details) or "proceed with draft"</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create storage bucket migration and build full motorsport incident generator</name>
  <files>
    supabase/migrations/125_motorsport_storage_bucket.sql,
    supabase/functions/motorsport-incident-generator/types.ts,
    supabase/functions/motorsport-incident-generator/motorsport-mapping.ts,
    supabase/functions/motorsport-incident-generator/MotorsportIncidentDocument.tsx,
    supabase/functions/motorsport-incident-generator/index.ts
  </files>
  <action>
    **A. Create `supabase/migrations/125_motorsport_storage_bucket.sql`:**
    Follow the `riddor-reports` bucket pattern. Create a `motorsport-reports` storage bucket with:
    - Public: false (private bucket)
    - RLS policy: service role can upload/read. Authenticated users with matching org_id can read.
    ```sql
    -- Create motorsport-reports storage bucket
    INSERT INTO storage.buckets (id, name, public)
    VALUES ('motorsport-reports', 'motorsport-reports', false)
    ON CONFLICT (id) DO NOTHING;

    -- RLS: Authenticated users can read motorsport reports from their org
    CREATE POLICY "Authenticated users can read motorsport reports"
    ON storage.objects FOR SELECT
    USING (bucket_id = 'motorsport-reports' AND auth.role() = 'authenticated');

    -- RLS: Service role can insert motorsport reports
    CREATE POLICY "Service role can insert motorsport reports"
    ON storage.objects FOR INSERT
    WITH CHECK (bucket_id = 'motorsport-reports' AND auth.role() = 'service_role');
    ```

    **B. Update `types.ts`:**
    Replace the minimal stub type with a full `MotorsportFormData` interface:
    ```typescript
    export interface MotorsportIncidentRequest {
      incident_id: string;
      event_vertical: 'motorsport';
    }

    export interface MotorsportFormData {
      // Event details
      event_name: string;
      event_date: string;
      venue: string;
      org_name: string;

      // Patient/Competitor details
      competitor_name: string;
      competitor_car_number: string;
      circuit_section: string;

      // Clinical details
      injury_type: string;
      body_part: string;
      severity: string;
      mechanism_of_injury: string;
      treatment_types: string[];
      treatment_notes: string;
      outcome: string;

      // Motorsport-specific (from vertical_extra_fields JSONB)
      gcs_score: number | null;
      extrication_required: boolean;
      helmet_removed: boolean;
      concussion_suspected: boolean;
      clerk_of_course_notified: boolean;
      competitor_cleared_to_return: boolean;
      vehicle_type: string;
      helmet_condition: string;

      // Concussion clearance
      hia_conducted: boolean;
      competitor_stood_down: boolean;
      cmo_notified: boolean;

      // Metadata
      reference_number: string;
      medic_name: string;
      created_at: string;
      generated_at: string;
    }
    ```

    Keep the old `MotorsportIncidentData` as a type alias for backward compatibility:
    ```typescript
    /** @deprecated Use MotorsportIncidentRequest */
    export type MotorsportIncidentData = MotorsportIncidentRequest;
    ```

    **C. Create `motorsport-mapping.ts`:**
    Follow the `f2508-mapping.ts` pattern. Export `mapTreatmentToMotorsportForm(treatment, worker, org, extraFields)` that takes raw DB data and returns a `MotorsportFormData` object. Parse `vertical_extra_fields` JSONB safely with null checks. Provide sensible defaults for missing fields (empty string, false, null).

    **D. Create `MotorsportIncidentDocument.tsx`:**
    Follow the `F2508Document.tsx` pattern using `@react-pdf/renderer`:
    - Import `Document, Page, View, Text, StyleSheet` from `@react-pdf/renderer`
    - Props: `{ data: MotorsportFormData }`
    - Layout: A4 page with header "Motorsport Incident Report", event details section, competitor details section, clinical assessment section (including GCS score), motorsport-specific section (extrication, helmet, circuit section), concussion clearance section (if applicable), outcome section, and footer with reference number and generation timestamp.
    - If proceeding with draft approach (user responded "proceed with draft" in Task 1), add a "DRAFT" watermark text rotated 45 degrees across the page center.
    - Use clean professional styling: 10pt body text, 14pt section headers, borders between sections, Motorsport UK red (#e60012) for header accent.

    **E. Replace `index.ts` stub with full implementation:**
    Follow `riddor-f2508-generator/index.ts` exactly:
    1. Parse `{ incident_id, event_vertical }` from request body
    2. Validate `event_vertical === 'motorsport'` (keep existing 400 check)
    3. Create Supabase client with service role key
    4. Fetch treatment by incident_id with joined worker and org data:
       ```typescript
       const { data: treatment } = await supabase
         .from('treatments')
         .select('*, worker:workers(first_name, last_name, role, company), org:organizations(company_name, site_address)')
         .eq('id', incident_id)
         .single();
       ```
    5. Parse `treatment.vertical_extra_fields` (JSONB) safely
    6. Call `mapTreatmentToMotorsportForm(treatment, treatment.worker, treatment.org, extraFields)`
    7. Call `renderToBuffer(<MotorsportIncidentDocument data={formData} />)`
    8. Upload to `motorsport-reports/{incident_id}/MotorsportAccidentForm-{timestamp}.pdf`
    9. Generate 7-day signed URL
    10. Return `{ success: true, pdf_path, signed_url }`

    Remove the 501 response entirely. Keep CORS headers and error handling from the stub.
  </action>
  <verify>
    1. `supabase/migrations/125_motorsport_storage_bucket.sql` exists with bucket creation and RLS policies.
    2. All four Edge Function files exist and have no syntax errors.
    3. The `index.ts` no longer returns 501 — it performs full PDF generation.
    4. `MotorsportFormData` type includes all MOTO-01 fields (GCS, extrication, helmet, circuit section, car number, Clerk of Course, concussion fields).
    5. The mapping function safely handles null `vertical_extra_fields`.
  </verify>
  <done>
    The `motorsport-incident-generator` Edge Function generates a Motorsport UK-style Accident Form PDF for any motorsport treatment. The PDF includes all MOTO-01 fields plus clinical data. The `motorsport-reports` storage bucket is created by migration 125. The function returns a 7-day signed URL for PDF download.
  </done>
</task>

</tasks>

<verification>
1. Storage bucket migration is syntactically valid SQL.
2. Edge Function follows the F2508 generator pattern exactly (import structure, Supabase client, renderToBuffer, storage upload, signed URL).
3. The PDF document component renders all motorsport-specific fields from `vertical_extra_fields`.
4. The mapping function handles null/missing `vertical_extra_fields` gracefully (no crashes on pre-Phase-18 treatments).
5. The 501 stub is fully replaced — no path returns 501 anymore.
</verification>

<success_criteria>
- `motorsport-incident-generator` Edge Function generates a PDF and returns a signed URL
- PDF includes GCS score, extrication, helmet, circuit section, car number, concussion status
- `motorsport-reports` storage bucket created by migration 125
- Function returns 400 for non-motorsport verticals (existing validation preserved)
- Mapping function handles null vertical_extra_fields without crashing
</success_criteria>

<output>
After completion, create `.planning/phases/19-motorsport-vertical/19-03-SUMMARY.md`
</output>
