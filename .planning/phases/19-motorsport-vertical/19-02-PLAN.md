---
phase: 19-motorsport-vertical
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - services/taxonomy/certification-types.ts
  - web/types/certification.types.ts
  - web/types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Motorsport UK Medical Official Licence and BASM Diploma appear as selectable cert types on both mobile and web"
    - "getRecommendedCertTypes('motorsport') returns Motorsport UK Medical Official Licence, HCPC Paramedic, and PHTLS near the top of the list"
    - "The RIDDOR detector does not fire for motorsport treatments (verify existing Phase 18 gate)"
    - "TreatmentWithWorker type includes event_vertical and vertical_extra_fields for dashboard use"
  artifacts:
    - path: "services/taxonomy/certification-types.ts"
      provides: "Motorsport UK Medical Official Licence and BASM Diploma cert types (mobile)"
      contains: "Motorsport UK Medical Official Licence"
    - path: "web/types/certification.types.ts"
      provides: "Motorsport UK Medical Official Licence and BASM Diploma cert types (web)"
      contains: "Motorsport UK Medical Official Licence"
    - path: "web/types/database.types.ts"
      provides: "event_vertical and vertical_extra_fields on TreatmentWithWorker"
      contains: "vertical_extra_fields"
  key_links:
    - from: "services/taxonomy/certification-types.ts"
      to: "web/types/certification.types.ts"
      via: "parallel cert type arrays must be in sync"
      pattern: "Motorsport UK Medical Official Licence"
    - from: "web/types/database.types.ts"
      to: "web/components/dashboard/treatments-columns.tsx"
      via: "TreatmentWithWorker type used by column definitions"
      pattern: "TreatmentWithWorker"
---

<objective>
Add missing Motorsport UK cert types to both taxonomy files, extend TreatmentWithWorker for dashboard use, and verify the RIDDOR gate.

Purpose: MOTO-06 requires Motorsport UK Medical Official Licence, HCPC Paramedic, and PHTLS at the top of the cert selector for motorsport. Two cert types are missing from the codebase: `Motorsport UK Medical Official Licence` and `BASM Diploma`. Both mobile and web cert files must be updated in lockstep. Additionally, the `TreatmentWithWorker` type must include `event_vertical` and `vertical_extra_fields` so the dashboard can render the concussion badge (Plan 19-04). Finally, MOTO-04 requires verifying the RIDDOR gate (Phase 18) works for motorsport.

Output: Updated cert taxonomy files (both platforms), extended `TreatmentWithWorker` type, RIDDOR gate verified.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-motorsport-vertical/19-RESEARCH.md

Key references:
- `services/taxonomy/certification-types.ts` — mobile cert types. Lines 44-49: existing motorsport section. Lines 127-133: VERTICAL_CERT_TYPES['motorsport'] array.
- `web/types/certification.types.ts` — web cert types. Lines 52-57: existing motorsport section. Lines 173-178: VERTICAL_CERT_TYPES['motorsport'] array.
- `web/types/database.types.ts` — `TreatmentWithWorker` at line 77, currently only has `worker: Worker | null`.
- `supabase/functions/riddor-detector/index.ts` — Phase 18 RIDDOR gate with `NON_RIDDOR_VERTICALS` array.
- `services/taxonomy/vertical-compliance.ts` — `motorsport.riddorApplies = false`.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Motorsport UK Medical Official Licence and BASM Diploma to cert taxonomy files</name>
  <files>services/taxonomy/certification-types.ts, web/types/certification.types.ts</files>
  <action>
    Update BOTH files in lockstep:

    **In `services/taxonomy/certification-types.ts` (mobile):**

    1. Add two new entries to the `CERT_TYPES` array in the Motorsport section (after `'MSA First Aider'`):
       ```typescript
       'Motorsport UK Medical Official Licence',
       'BASM Diploma',
       ```

    2. Add corresponding entries to `CERT_TYPE_INFO`:
       ```typescript
       'Motorsport UK Medical Official Licence': { label: 'Motorsport UK Medical Official Licence', category: 'motorsport', description: 'Motorsport UK official medical registration (Doctor / Paramedic / Medical Assistant)' },
       'BASM Diploma':                          { label: 'BASM Diploma', category: 'motorsport', description: 'British Association of Sport and Exercise Medicine diploma' },
       ```

    3. Update `VERTICAL_CERT_TYPES['motorsport']` to include the two new types near the top. Desired order per MOTO-06 (Motorsport UK Medical Official Licence, HCPC Paramedic, PHTLS first):
       ```typescript
       motorsport: ['Motorsport UK Medical Official Licence', 'HCPC Paramedic', 'PHTLS', 'FREC 4', 'PHEC', 'ALS Provider', 'ATLS', 'BASM Diploma', 'FIA Grade 1', 'FIA Grade 2', 'FIA Grade 3', 'Motorsport UK CMO Letter', 'MSA First Aider'],
       ```

    **In `web/types/certification.types.ts` (web):**

    1. Add same two entries to `UK_CERT_TYPES` array in the Motorsport section (after `'MSA First Aider'`):
       ```typescript
       'Motorsport UK Medical Official Licence',  // Official Motorsport UK medical registration
       'BASM Diploma',                            // British Association of Sport & Exercise Medicine
       ```

    2. Add corresponding entries to `CERT_TYPE_METADATA`:
       ```typescript
       'Motorsport UK Medical Official Licence': { label: 'Motorsport UK Medical Official Licence', category: 'motorsport', description: 'Official Motorsport UK medical registration (Registered Doctor, Paramedic, or Medical Assistant)', renewalUrl: 'https://www.motorsportuk.org/volunteers/officials/medical-officials/' },
       'BASM Diploma':                          { label: 'BASM Diploma', category: 'motorsport', description: 'British Association of Sport and Exercise Medicine diploma', renewalUrl: 'https://www.basem.co.uk/' },
       ```

    3. Update `VERTICAL_CERT_TYPES['motorsport']` to match the same order as mobile:
       ```typescript
       motorsport: [
         'Motorsport UK Medical Official Licence', 'HCPC Paramedic', 'PHTLS',
         'FREC 4', 'PHEC', 'ALS Provider', 'ATLS', 'BASM Diploma',
         'FIA Grade 1', 'FIA Grade 2', 'FIA Grade 3',
         'Motorsport UK CMO Letter', 'MSA First Aider',
       ],
       ```

    **Critical:** Both files MUST have the same cert type strings. A mismatch will cause TypeScript errors or missing display labels on one platform.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes for both files.
    2. Grep both files for `Motorsport UK Medical Official Licence` — both return matches.
    3. Grep both files for `BASM Diploma` — both return matches.
    4. The `VERTICAL_CERT_TYPES['motorsport']` array in both files starts with `'Motorsport UK Medical Official Licence'`, `'HCPC Paramedic'`, `'PHTLS'`.
  </verify>
  <done>
    Both mobile and web cert taxonomy files include `Motorsport UK Medical Official Licence` and `BASM Diploma`. The motorsport vertical cert ordering matches MOTO-06: Medical Official Licence, HCPC Paramedic, and PHTLS at the top.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend TreatmentWithWorker type and verify RIDDOR gate</name>
  <files>web/types/database.types.ts</files>
  <action>
    **A. Update `Treatment` interface in `web/types/database.types.ts`:**

    Add the following fields to the `Treatment` interface (these columns exist in the database from Phase 18 migration 124 but were not yet added to the web type):
    ```typescript
    event_vertical: string | null;
    vertical_extra_fields: Record<string, unknown> | null;
    booking_id: string | null;
    mechanism_of_injury: string | null;
    treatment_types: string[] | null;
    reference_number: string | null;
    ```

    Check which of these fields already exist in the interface. Only add the ones that are missing. The critical ones for Phase 19 are `event_vertical` and `vertical_extra_fields`.

    `TreatmentWithWorker` extends `Treatment`, so it will inherit these fields automatically.

    **B. Verify RIDDOR gate (read-only verification, no code changes):**

    Read `supabase/functions/riddor-detector/index.ts` and confirm:
    1. `motorsport` is present in the `NON_RIDDOR_VERTICALS` array
    2. The early-return check uses `treatment.event_vertical` or equivalent

    Read `services/taxonomy/vertical-compliance.ts` and confirm:
    1. `getVerticalCompliance('motorsport').riddorApplies === false`

    Read `web/lib/pdf/incident-report-dispatcher.ts` and confirm:
    1. `motorsport` maps to `motorsport-incident-generator` in the dispatch table

    If any of these verifications fail, report the gap. Do NOT modify these files — they should be correct from Phase 18.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes for `web/types/database.types.ts`.
    2. `TreatmentWithWorker` now includes `event_vertical` and `vertical_extra_fields` (via `Treatment`).
    3. RIDDOR gate confirmed: `motorsport` is in `NON_RIDDOR_VERTICALS` and `riddorApplies === false`.
    4. Incident report dispatcher confirmed: `motorsport` routes to `motorsport-incident-generator`.
  </verify>
  <done>
    `TreatmentWithWorker` type includes all Phase 18 columns needed for dashboard rendering. RIDDOR gate verified working for motorsport vertical (no false RIDDOR flags). Incident report dispatcher routes motorsport treatments correctly.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for all modified files.
2. `getRecommendedCertTypes('motorsport')` returns `Motorsport UK Medical Official Licence` as the first element (can verify by reading the code logic).
3. Both mobile and web cert files have identical motorsport cert type strings.
4. `TreatmentWithWorker` has `event_vertical: string | null` and `vertical_extra_fields: Record<string, unknown> | null`.
5. RIDDOR gate verification complete: motorsport in NON_RIDDOR_VERTICALS, riddorApplies false.
</verification>

<success_criteria>
- `Motorsport UK Medical Official Licence` and `BASM Diploma` exist in both cert taxonomy files
- `VERTICAL_CERT_TYPES['motorsport']` starts with Medical Official Licence, HCPC Paramedic, PHTLS
- `TreatmentWithWorker` includes `event_vertical` and `vertical_extra_fields`
- RIDDOR gate for motorsport verified as working (MOTO-04 confirmed)
</success_criteria>

<output>
After completion, create `.planning/phases/19-motorsport-vertical/19-02-SUMMARY.md`
</output>
