---
phase: 19-motorsport-vertical
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/taxonomy/motorsport-fields.ts
  - app/treatment/new.tsx
autonomous: true

must_haves:
  truths:
    - "A medic logging a motorsport incident sees GCS score, extrication required, helmet removed, circuit section, Clerk of Course notified, and competitor car number fields"
    - "The motorsport fields section only renders when orgVertical === 'motorsport'"
    - "When concussion is suspected, a mandatory three-checkbox clearance panel appears"
    - "The form cannot be submitted with concussion suspected unless HIA conducted, competitor stood down, and CMO notified are all checked"
    - "Motorsport extra fields are stored as JSON string in WatermelonDB vertical_extra_fields column"
  artifacts:
    - path: "services/taxonomy/motorsport-fields.ts"
      provides: "MotorsportExtraFields interface and default initial state"
      exports: ["MotorsportExtraFields", "INITIAL_MOTORSPORT_FIELDS", "MOTORSPORT_INCIDENT_TYPES"]
    - path: "app/treatment/new.tsx"
      provides: "Motorsport fields section + concussion clearance gate"
      contains: "orgVertical === 'motorsport'"
  key_links:
    - from: "app/treatment/new.tsx"
      to: "services/taxonomy/motorsport-fields.ts"
      via: "import MotorsportExtraFields"
      pattern: "import.*motorsport-fields"
    - from: "app/treatment/new.tsx"
      to: "handleCompleteTreatment"
      via: "concussion gate hard return before completion logic"
      pattern: "concussion_suspected.*hia_conducted.*competitor_stood_down.*cmo_notified"
    - from: "app/treatment/new.tsx"
      to: "enqueueSyncItem"
      via: "vertical_extra_fields in sync payload"
      pattern: "vertical_extra_fields.*JSON\\.stringify"
---

<objective>
Add motorsport-specific form fields and concussion clearance gate to the mobile treatment form.

Purpose: When a medic is working at a motorsport event, the treatment form must capture Motorsport UK-required data (GCS score, extrication, helmet removed, circuit section, Clerk of Course notification, competitor car number) and enforce a mandatory three-step concussion clearance workflow (HIA conducted, competitor stood down, CMO notified) that cannot be bypassed. This satisfies MOTO-01 and the core of MOTO-03.

Output: `services/taxonomy/motorsport-fields.ts` (interface + defaults), updated `app/treatment/new.tsx` with motorsport section and concussion gate.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-motorsport-vertical/19-RESEARCH.md

Key references:
- `app/treatment/new.tsx` — the treatment form. Line 81: `orgVertical` already available. Lines 276-285: cert validation gate pattern (model for concussion gate). Lines 733-756: treatmentTypeButton style (model for boolean checkboxes).
- `services/taxonomy/vertical-compliance.ts` — existing vertical taxonomy file pattern.
- `src/database/models/Treatment.ts` — `verticalExtraFields?: string` already decorated.
- `src/database/schema.ts` — `vertical_extra_fields` column present in v4 schema.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MotorsportExtraFields interface and taxonomy file</name>
  <files>services/taxonomy/motorsport-fields.ts</files>
  <action>
    Create `services/taxonomy/motorsport-fields.ts` with:

    1. `MotorsportExtraFields` interface matching the JSONB shape from research:
       - Core fields: `gcs_score: number | null`, `extrication_required: boolean`, `helmet_removed: boolean`, `concussion_suspected: boolean`, `competitor_car_number: string`, `circuit_section: string`, `clerk_of_course_notified: boolean`, `competitor_cleared_to_return: boolean`
       - Concussion clearance gate fields: `hia_conducted: boolean`, `competitor_stood_down: boolean`, `cmo_notified: boolean`
       - Optional additional fields: `vehicle_type?: string`, `incident_type?: string`, `helmet_condition?: string`, `licences_to_msuk?: boolean`

    2. `INITIAL_MOTORSPORT_FIELDS` constant of type `MotorsportExtraFields` with all booleans false, strings empty, gcs_score null.

    3. `MOTORSPORT_INCIDENT_TYPES` array: `['collision', 'single_vehicle', 'track_incident', 'pit_lane', 'paddock', 'spectator_area', 'other']` as const.

    4. `VEHICLE_TYPES` array: `['car', 'kart', 'bike', 'rally_car', 'other']` as const.

    Follow the naming conventions of other taxonomy files (e.g., `injury-types.ts`, `mechanism-presets.ts`). Use JSDoc comment block at top explaining the file's purpose and which phase/requirements it satisfies.
  </action>
  <verify>
    `npx tsc --noEmit services/taxonomy/motorsport-fields.ts` compiles without errors (or equivalent TS check). File exports `MotorsportExtraFields`, `INITIAL_MOTORSPORT_FIELDS`, `MOTORSPORT_INCIDENT_TYPES`, `VEHICLE_TYPES`.
  </verify>
  <done>
    `services/taxonomy/motorsport-fields.ts` exists with a fully typed `MotorsportExtraFields` interface, a default initial state constant, and enum arrays for incident types and vehicle types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add motorsport fields section and concussion gate to treatment form</name>
  <files>app/treatment/new.tsx</files>
  <action>
    Modify `app/treatment/new.tsx` to add:

    **A. State declaration (near other form state, around line 67):**
    ```typescript
    import { MotorsportExtraFields, INITIAL_MOTORSPORT_FIELDS } from '../../services/taxonomy/motorsport-fields';
    // ...
    const [motorsportFields, setMotorsportFields] = useState<MotorsportExtraFields>(INITIAL_MOTORSPORT_FIELDS);
    ```

    **B. Motorsport Details section (after the outcome section, conditional on `orgVertical === 'motorsport'`):**
    Render a new section card titled "Motorsport Details" containing:
    - GCS Score: `TextInput` with `keyboardType="number-pad"`, validated 3-15. Use existing `styles.textArea` style.
    - Competitor Car Number: `TextInput` with placeholder "e.g. 42"
    - Circuit Section: `TextInput` with placeholder "e.g. Turn 3, Paddock, Pit Lane"
    - Boolean toggles using the existing `treatmentTypeButton` / `treatmentTypeButtonSelected` style pattern (lines 733-756 of current file): Extrication Required, Helmet Removed at Scene, Clerk of Course Notified, Concussion Suspected
    - Each boolean toggle is a `Pressable` that flips the boolean in `motorsportFields`.

    **C. Concussion clearance panel (inside the motorsport section, conditional on `motorsportFields.concussion_suspected`):**
    Render a warning card with amber/orange border (similar to RIDDOR banner pattern at lines 636-648) titled "Concussion Clearance Required" with subtitle "All three items must be confirmed before completing this record". Three checkboxes:
    - HIA (Head Injury Assessment) conducted
    - Competitor stood down from event
    - Chief Medical Officer (CMO) notified

    Use same `Pressable` toggle pattern with a distinct checked style (green background when checked).

    **D. Concussion gate in `handleCompleteTreatment` (insert after cert validation gate at line 285, before the existing field validation at line 288):**
    ```typescript
    // Motorsport concussion clearance gate — cannot be bypassed
    if (orgVertical === 'motorsport' && motorsportFields.concussion_suspected) {
      const { hia_conducted, competitor_stood_down, cmo_notified } = motorsportFields;
      if (!hia_conducted || !competitor_stood_down || !cmo_notified) {
        Alert.alert(
          'Concussion Clearance Required',
          'When concussion is suspected, you must confirm:\n- HIA conducted\n- Competitor stood down\n- CMO notified\n\nbefore completing this record.',
          [{ text: 'OK' }]
        );
        return;
      }
    }
    ```

    **E. Include motorsport fields in the sync payload (in the `enqueueSyncItem` call):**
    Add `vertical_extra_fields: motorsportFields.gcs_score !== null || motorsportFields.competitor_car_number ? JSON.stringify(motorsportFields) : null` to the sync payload object. Only stringify if the medic has entered any motorsport data (avoid writing empty objects for non-motorsport treatments).

    Actually, simpler approach: If `orgVertical === 'motorsport'`, always include `vertical_extra_fields: JSON.stringify(motorsportFields)`. If not motorsport, omit or set null.

    **F. Include motorsport fields in the WatermelonDB auto-save update (in the treatment.update callback):**
    Add `t.verticalExtraFields = orgVertical === 'motorsport' ? JSON.stringify(motorsportFields) : undefined;`

    **G. Add styles for the concussion gate banner:**
    Add to the StyleSheet: `concussionGateBanner` (amber/orange border, padding 16, marginTop 16, borderRadius 12, borderWidth 2, borderColor '#f59e0b', backgroundColor '#fffbeb'), `concussionGateTitle` (fontSize 16, fontWeight '700', color '#92400e'), `concussionGateSubtitle` (fontSize 13, color '#92400e', marginBottom 12), `clearanceCheckbox` and `clearanceCheckboxChecked` styles matching the treatmentTypeButton pattern but with green checked state.

    **Important:** Do NOT use emoji in the UI text. Use plain text for checkbox labels.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes for the treatment form (no TypeScript errors).
    2. `pnpm dev` starts without build errors.
    3. Open the treatment form with `?event_vertical=motorsport` route param — the "Motorsport Details" section renders.
    4. Toggle "Concussion Suspected" ON — the clearance panel appears.
    5. Try to complete the treatment with concussion suspected but clearance items unchecked — `Alert.alert` fires and blocks submission.
    6. Check all three clearance items, complete treatment — submission proceeds.
  </verify>
  <done>
    The treatment form conditionally renders motorsport-specific fields when `orgVertical === 'motorsport'`. The concussion clearance gate blocks form submission when concussion is suspected but the three-part checklist is incomplete. Motorsport fields are stored in `vertical_extra_fields` both locally (WatermelonDB) and in the sync payload (Supabase).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with no errors on modified files.
2. The motorsport fields section does NOT render when `orgVertical` is any other value (e.g., 'construction', 'general').
3. The concussion gate is a hard block — `return` statement prevents any downstream completion logic from running.
4. `motorsportFields` state is serialized to JSON string for WatermelonDB and included in the sync payload.
5. GCS score input rejects values outside 3-15 range.
</verification>

<success_criteria>
- `services/taxonomy/motorsport-fields.ts` exports `MotorsportExtraFields`, `INITIAL_MOTORSPORT_FIELDS`, `MOTORSPORT_INCIDENT_TYPES`
- `app/treatment/new.tsx` renders motorsport fields section for motorsport vertical only
- Concussion gate blocks submission when concussion suspected and clearance incomplete
- All form data persists to WatermelonDB `vertical_extra_fields` column as JSON string
- Sync payload includes `vertical_extra_fields` for Supabase JSONB column
</success_criteria>

<output>
After completion, create `.planning/phases/19-motorsport-vertical/19-01-SUMMARY.md`
</output>
