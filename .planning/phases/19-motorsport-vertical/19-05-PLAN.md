---
phase: 19-motorsport-vertical
plan: 05
type: execute
wave: 3
depends_on: ["19-01", "19-02", "19-03", "19-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "A medic logging a motorsport incident sees Motorsport UK fields and cannot submit with concussion suspected unless clearance checklist is complete"
    - "A motorsport treatment does not produce a RIDDOR flag"
    - "Uncleared concussion cases show a red badge on the dashboard treatments list"
    - "An admin can generate a Medical Statistics Sheet PDF from the booking detail page"
    - "The cert selector shows Motorsport UK Medical Official Licence, HCPC Paramedic, and PHTLS at the top for motorsport"
  artifacts: []
  key_links:
    - from: "app/treatment/new.tsx"
      to: "services/taxonomy/motorsport-fields.ts"
      via: "MotorsportExtraFields import"
      pattern: "import.*motorsport-fields"
    - from: "web/components/dashboard/treatments-columns.tsx"
      to: "web/types/database.types.ts"
      via: "TreatmentWithWorker.vertical_extra_fields"
      pattern: "vertical_extra_fields"
    - from: "web/app/admin/bookings/[id]/page.tsx"
      to: "supabase/functions/motorsport-stats-sheet-generator"
      via: "supabase.functions.invoke"
      pattern: "motorsport-stats-sheet-generator"
    - from: "supabase/functions/motorsport-incident-generator/index.ts"
      to: "motorsport-reports bucket"
      via: "storage upload"
      pattern: "motorsport-reports"
---

<objective>
Verify the complete motorsport vertical integration end-to-end.

Purpose: All four implementation plans (19-01 through 19-04) have been executed independently. This plan runs a comprehensive integration check against all five phase success criteria to confirm the motorsport vertical works as a complete feature. No code changes are expected — this is a verification checkpoint.

Output: Verification results confirming all phase success criteria are met.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-motorsport-vertical/19-RESEARCH.md
@.planning/phases/19-motorsport-vertical/19-01-SUMMARY.md
@.planning/phases/19-motorsport-vertical/19-02-SUMMARY.md
@.planning/phases/19-motorsport-vertical/19-03-SUMMARY.md
@.planning/phases/19-motorsport-vertical/19-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run automated integration verification</name>
  <files></files>
  <action>
    Verify the following by reading source files and running TypeScript compilation:

    **SC-1: Motorsport form fields + concussion gate (MOTO-01, MOTO-03)**
    - Read `app/treatment/new.tsx` and confirm:
      - `orgVertical === 'motorsport'` conditional renders motorsport fields section
      - GCS score, extrication, helmet, circuit section, car number, Clerk of Course fields present
      - Concussion gate in `handleCompleteTreatment` blocks submission when `concussion_suspected && (!hia_conducted || !competitor_stood_down || !cmo_notified)`
      - `vertical_extra_fields` included in sync payload

    **SC-2: RIDDOR disabled (MOTO-04)**
    - Read `supabase/functions/riddor-detector/index.ts` and confirm `motorsport` in `NON_RIDDOR_VERTICALS`
    - Read `services/taxonomy/vertical-compliance.ts` and confirm `riddorApplies: false` for motorsport

    **SC-3: Dashboard concussion badge (MOTO-03)**
    - Read `web/components/dashboard/treatments-columns.tsx` and confirm:
      - Column checks `event_vertical === 'motorsport'`
      - Badge renders when `concussion_suspected === true && competitor_stood_down !== true`
      - Null-safe check on `vertical_extra_fields`

    **SC-4: Medical Statistics Sheet (MOTO-02)**
    - Verify `supabase/functions/motorsport-stats-sheet-generator/index.ts` exists and imports `renderToBuffer`
    - Verify `web/app/admin/bookings/[id]/page.tsx` has "Generate Medical Statistics Sheet" button
    - Verify button is conditional on `event_vertical === 'motorsport'`

    **SC-5: Cert profile (MOTO-06)**
    - Read `services/taxonomy/certification-types.ts` VERTICAL_CERT_TYPES['motorsport'] and confirm first three entries are `Motorsport UK Medical Official Licence`, `HCPC Paramedic`, `PHTLS`
    - Read `web/types/certification.types.ts` and confirm same ordering

    **Compilation check:**
    - Run `npx tsc --noEmit` from project root (or `pnpm tsc --noEmit`) to verify no TypeScript errors across all modified files.

    Report results for each success criterion: PASS or FAIL with details.
  </action>
  <verify>
    All five success criteria pass. TypeScript compilation succeeds with no errors.
  </verify>
  <done>
    All phase success criteria verified: motorsport form fields render correctly, concussion gate blocks submission, RIDDOR is disabled, dashboard badge shows for uncleared concussions, Medical Statistics Sheet generates, and cert profile ordering is correct.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete motorsport vertical integration:
    1. Mobile treatment form with motorsport-specific fields (GCS, extrication, helmet, circuit section, car number, Clerk of Course) — renders only for motorsport bookings
    2. Concussion clearance gate — form blocks submission when concussion suspected until HIA, stood down, CMO notified are all confirmed
    3. Motorsport PDF Edge Function — generates Motorsport UK Accident Form PDF per incident
    4. Medical Statistics Sheet — aggregate PDF per booking with treatment counts, severity breakdown, GCS range, concussion/extrication counts
    5. Dashboard concussion badge — red "Concussion clearance required" badge on treatments table for uncleared motorsport concussions
    6. Cert types — Motorsport UK Medical Official Licence and BASM Diploma added, ordering: Medical Official Licence, HCPC Paramedic, PHTLS first
    7. RIDDOR gate — verified motorsport treatments never trigger RIDDOR
  </what-built>
  <how-to-verify>
    1. Run the app (`pnpm dev` on port 30500) and navigate to the treatment form
    2. Verify motorsport fields section does NOT appear by default
    3. Navigate to treatment form with `?event_vertical=motorsport` — verify motorsport fields section appears
    4. Toggle "Concussion Suspected" — verify clearance panel appears
    5. Try to complete with concussion suspected but clearance items unchecked — verify it blocks
    6. Check all three clearance items and complete — verify it proceeds
    7. On the web dashboard treatments list, verify concussion badge appearance for motorsport treatments
    8. On a motorsport booking detail page, verify "Generate Medical Statistics Sheet" button is visible
    9. In the medic cert profile, verify Motorsport UK Medical Official Licence appears at the top for motorsport vertical
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All five phase success criteria verified through automated code inspection and human visual/functional verification.
</verification>

<success_criteria>
All phase success criteria pass:
1. Motorsport form fields visible + concussion gate blocks submission
2. RIDDOR disabled for motorsport
3. Dashboard concussion badge visible for uncleared cases
4. Medical Statistics Sheet generates from booking detail
5. Cert selector shows correct ordering for motorsport
</success_criteria>

<output>
After completion, create `.planning/phases/19-motorsport-vertical/19-05-SUMMARY.md`
</output>
