---
phase: 19-motorsport-vertical
plan: 04
type: execute
wave: 3
depends_on: ["19-01", "19-02", "19-03"]
files_modified:
  - supabase/functions/motorsport-stats-sheet-generator/index.ts
  - supabase/functions/motorsport-stats-sheet-generator/MotorsportStatsDocument.tsx
  - supabase/functions/motorsport-stats-sheet-generator/stats-mapping.ts
  - supabase/functions/motorsport-stats-sheet-generator/types.ts
  - web/components/dashboard/treatments-columns.tsx
  - web/app/admin/bookings/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "An admin can click 'Generate Medical Statistics Sheet' on a motorsport booking detail page and receive a PDF download"
    - "The Medical Statistics Sheet PDF aggregates all treatments for that booking: total count, severity breakdown, GCS range, extrication count, concussion count"
    - "On the treatments list, any motorsport head injury with concussion suspected and no clearance record (competitor_cleared_to_return !== true) shows a red 'Concussion clearance required' badge"
    - "The badge does not appear for non-motorsport treatments or for treatments with null vertical_extra_fields"
  artifacts:
    - path: "supabase/functions/motorsport-stats-sheet-generator/index.ts"
      provides: "Medical Statistics Sheet PDF Edge Function"
      contains: "renderToBuffer"
    - path: "supabase/functions/motorsport-stats-sheet-generator/MotorsportStatsDocument.tsx"
      provides: "Stats sheet PDF component with aggregate tables"
      contains: "Document"
    - path: "supabase/functions/motorsport-stats-sheet-generator/stats-mapping.ts"
      provides: "Aggregate treatment data into stats summary"
      exports: ["mapBookingToStats"]
    - path: "supabase/functions/motorsport-stats-sheet-generator/types.ts"
      provides: "MotorsportStatsData and MotorsportStatsRequest types"
      exports: ["MotorsportStatsData", "MotorsportStatsRequest"]
    - path: "web/components/dashboard/treatments-columns.tsx"
      provides: "Concussion clearance badge column"
      contains: "Concussion clearance required"
    - path: "web/app/admin/bookings/[id]/page.tsx"
      provides: "Generate Medical Statistics Sheet button"
      contains: "motorsport-stats-sheet-generator"
  key_links:
    - from: "web/app/admin/bookings/[id]/page.tsx"
      to: "supabase/functions/motorsport-stats-sheet-generator"
      via: "supabase.functions.invoke"
      pattern: "motorsport-stats-sheet-generator"
    - from: "web/components/dashboard/treatments-columns.tsx"
      to: "vertical_extra_fields"
      via: "JSONB field access for concussion badge"
      pattern: "concussion_suspected.*competitor_cleared_to_return"
---

<objective>
Build the Medical Statistics Sheet PDF generator and add the concussion clearance badge to the dashboard.

Purpose: MOTO-02 requires a per-booking Medical Statistics Sheet that aggregates all incident records. MOTO-03 requires admin visibility into uncleared concussion cases. This plan creates the stats sheet Edge Function (following the F2508 generator pattern), adds a "Generate Medical Statistics Sheet" button to the booking detail page, and adds a concussion clearance badge to the treatments table.

Dependency note: This plan depends on Plan 03 (Wave 2) because the stats sheet Edge Function uploads PDFs to the `motorsport-reports` storage bucket created by migration 125 in Plan 03. Plan 03 must complete before this plan executes.

Output: `motorsport-stats-sheet-generator` Edge Function (4 files), updated booking detail page, updated treatments columns with concussion badge.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-motorsport-vertical/19-RESEARCH.md
@.planning/phases/19-motorsport-vertical/19-01-SUMMARY.md
@.planning/phases/19-motorsport-vertical/19-03-SUMMARY.md

Key references:
- `supabase/functions/riddor-f2508-generator/index.ts` — Edge Function pattern (import structure, data fetch, renderToBuffer, storage upload, signed URL).
- `web/components/dashboard/treatments-columns.tsx` — RIDDOR badge at lines 88-97 (model for concussion badge).
- `web/app/admin/bookings/[id]/page.tsx` — booking detail page, already has event_vertical field.
- `web/types/database.types.ts` — `TreatmentWithWorker` with `event_vertical` and `vertical_extra_fields` (from Plan 19-02).
- `supabase/migrations/125_motorsport_storage_bucket.sql` — creates the `motorsport-reports` bucket (from Plan 19-03). Must exist before this plan runs.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Medical Statistics Sheet Edge Function</name>
  <files>
    supabase/functions/motorsport-stats-sheet-generator/index.ts,
    supabase/functions/motorsport-stats-sheet-generator/MotorsportStatsDocument.tsx,
    supabase/functions/motorsport-stats-sheet-generator/stats-mapping.ts,
    supabase/functions/motorsport-stats-sheet-generator/types.ts
  </files>
  <action>
    Create the `motorsport-stats-sheet-generator` Edge Function directory and all 4 files following the F2508 generator pattern exactly.

    **A. `types.ts`:**
    ```typescript
    export interface MotorsportStatsRequest {
      booking_id: string;
    }

    export interface MotorsportStatsData {
      // Event details
      event_name: string;
      event_date: string;
      event_end_date: string | null;
      venue: string;
      org_name: string;
      cmo_name: string;  // medic who generated the sheet

      // Aggregate counts
      total_patients: number;
      total_competitors: number;  // treatments with competitor_car_number present
      total_spectators_staff: number;  // treatments without competitor_car_number

      // By severity
      severity_counts: Record<string, number>;  // minor, moderate, major, critical

      // By outcome
      outcome_counts: Record<string, number>;  // returned_to_work, sent_home, hospital_referral, ambulance_called

      // Motorsport-specific aggregates
      concussion_count: number;
      extrication_count: number;
      gcs_min: number | null;
      gcs_max: number | null;
      hospital_referrals: number;

      // Individual incidents (tabular)
      incidents: Array<{
        time: string;
        competitor_number: string;
        circuit_section: string;
        injury_type: string;
        severity: string;
        gcs: number | null;
        outcome: string;
        concussion: boolean;
      }>;

      // Metadata
      generated_at: string;
      booking_id: string;
    }
    ```

    **B. `stats-mapping.ts`:**
    Export `mapBookingToStats(booking, treatments, medicName): MotorsportStatsData`.
    - Count treatments by severity using `reduce`.
    - Count treatments by outcome using `reduce`.
    - For motorsport fields: parse each treatment's `vertical_extra_fields` (JSONB). Handle null safely.
    - `total_competitors` = count of treatments where `vertical_extra_fields?.competitor_car_number` is truthy.
    - `concussion_count` = count where `vertical_extra_fields?.concussion_suspected === true`.
    - `extrication_count` = count where `vertical_extra_fields?.extrication_required === true`.
    - `gcs_min` / `gcs_max` = min/max of `vertical_extra_fields?.gcs_score` values (filtering nulls).
    - `hospital_referrals` = count where outcome is `'hospital_referral'` or `'ambulance_called'`.
    - `incidents` array: map each treatment to the tabular row format.

    **C. `MotorsportStatsDocument.tsx`:**
    React PDF component using `@react-pdf/renderer`:
    - A4 page, landscape orientation for the aggregate table.
    - Header: "Medical Statistics Sheet" with event name, date, venue.
    - Summary section: total patients, competitor count, severity distribution (table), outcome distribution (table).
    - Motorsport section: concussion count, extrication count, GCS range, hospital referrals.
    - Incidents table: one row per treatment with time, competitor number, circuit section, injury, severity, GCS, outcome, concussion flag.
    - Footer: "Generated by SiteMedic" + timestamp + booking_id.
    - Professional styling: 10pt body, 12pt headers, light gray alternating rows in tables, red highlight for concussion rows.

    **D. `index.ts`:**
    Follow `riddor-f2508-generator/index.ts` pattern:
    1. CORS handling.
    2. Parse `{ booking_id }` from request body. Return 400 if missing.
    3. Create Supabase client with service role key.
    4. Fetch booking: `supabase.from('bookings').select('*, org_settings(company_name)').eq('id', booking_id).single()`.
    5. Fetch all motorsport treatments for this booking: `supabase.from('treatments').select('*, worker:workers(first_name, last_name)').eq('booking_id', booking_id).eq('event_vertical', 'motorsport')`.
    6. If no treatments found, return 404 with message "No motorsport treatments found for this booking".
    7. Get medic name from the first treatment's worker or fallback to "Unknown".
    8. Call `mapBookingToStats(booking, treatments, medicName)`.
    9. Call `renderToBuffer(<MotorsportStatsDocument data={statsData} />)`.
    10. Upload to `motorsport-reports/{booking_id}/MedicalStatsSheet-{Date.now()}.pdf`.
    11. Generate 7-day signed URL.
    12. Return `{ success: true, pdf_path, signed_url }`.

    Note: This function uses the `motorsport-reports` storage bucket created by migration 125 (Plan 19-03). Plan 03 is a dependency — the bucket will exist when this plan executes.
  </action>
  <verify>
    1. All four files exist in `supabase/functions/motorsport-stats-sheet-generator/`.
    2. No syntax errors in TypeScript files.
    3. `index.ts` imports from all three sibling files correctly.
    4. `stats-mapping.ts` handles null `vertical_extra_fields` without throwing.
  </verify>
  <done>
    The `motorsport-stats-sheet-generator` Edge Function can aggregate all motorsport treatments for a booking into a Medical Statistics Sheet PDF. The PDF includes severity distribution, motorsport-specific counts (concussion, extrication, GCS range), and a tabular incident list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add concussion badge to treatments table and stats sheet button to booking detail</name>
  <files>
    web/components/dashboard/treatments-columns.tsx,
    web/app/admin/bookings/[id]/page.tsx
  </files>
  <action>
    **A. Add concussion clearance badge to `treatments-columns.tsx`:**

    Add a new column to the `treatmentColumns` array, inserted AFTER the RIDDOR column (after line 97) and BEFORE the actions column:

    ```typescript
    {
      id: 'motorsport_clearance',
      header: 'Clearance',
      cell: ({ row }) => {
        const vertical = row.original.event_vertical;
        const extraFields = row.original.vertical_extra_fields as Record<string, unknown> | null;
        if (vertical !== 'motorsport' || !extraFields) return null;
        if (
          extraFields.concussion_suspected === true &&
          extraFields.competitor_cleared_to_return !== true
        ) {
          return (
            <Badge variant="destructive" className="text-xs whitespace-nowrap">
              Concussion clearance required
            </Badge>
          );
        }
        return null;
      },
    },
    ```

    Critical null-safety: `extraFields` must be checked for null before accessing nested properties. Pre-Phase-18 treatments have `null` `vertical_extra_fields`. Use `competitor_cleared_to_return !== true` (not `competitor_stood_down !== true`) because this field specifically represents "no clearance record exists" — a competitor may have been stood down but not yet cleared to return, which is the actual safety-critical state.

    **B. Add "Generate Medical Statistics Sheet" button to `web/app/admin/bookings/[id]/page.tsx`:**

    1. Import `createClientComponentClient` from `@supabase/auth-helpers-nextjs` (or use existing supabase client pattern from the file).
    2. Add state: `const [statsLoading, setStatsLoading] = useState(false);`
    3. Add handler function:
       ```typescript
       const handleGenerateStatsSheet = async () => {
         setStatsLoading(true);
         try {
           const supabase = createClientComponentClient();
           const { data, error } = await supabase.functions.invoke('motorsport-stats-sheet-generator', {
             body: { booking_id: bookingId },
           });
           if (error) throw error;
           if (data?.signed_url) {
             window.open(data.signed_url, '_blank');
             toast.success('Medical Statistics Sheet generated');
           }
         } catch (err: unknown) {
           toast.error('Failed to generate Medical Statistics Sheet');
           console.error('Stats sheet error:', err);
         } finally {
           setStatsLoading(false);
         }
       };
       ```

    4. Render the button conditionally when the booking's `event_vertical === 'motorsport'`. Place it in the booking detail card, near other action buttons:
       ```tsx
       {detail?.booking.event_vertical === 'motorsport' && (
         <Button
           onClick={handleGenerateStatsSheet}
           disabled={statsLoading}
           variant="outline"
           className="mt-4"
         >
           {statsLoading ? (
             <>
               <Loader2 className="h-4 w-4 mr-2 animate-spin" />
               Generating...
             </>
           ) : (
             <>
               <ClipboardList className="h-4 w-4 mr-2" />
               Generate Medical Statistics Sheet
             </>
           )}
         </Button>
       )}
       ```

    Note: `ClipboardList` and `Loader2` icons are already imported at the top of the file. `Button` may need to be imported from `@/components/ui/button` if not already present.

    Check existing imports and add any missing ones. Do NOT duplicate imports.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes for both modified files.
    2. In `treatments-columns.tsx`: the `motorsport_clearance` column exists in the array.
    3. The badge renders ONLY when `event_vertical === 'motorsport'` AND `concussion_suspected === true` AND `competitor_cleared_to_return !== true`.
    4. The badge does NOT render for null `vertical_extra_fields` (no crash).
    5. In booking detail page: the "Generate Medical Statistics Sheet" button is visible only for motorsport bookings.
    6. The button calls `supabase.functions.invoke('motorsport-stats-sheet-generator')` with `booking_id`.
  </verify>
  <done>
    The treatments table shows a red "Concussion clearance required" badge for any motorsport treatment with suspected concussion that has no clearance record (competitor_cleared_to_return !== true). The booking detail page has a "Generate Medical Statistics Sheet" button for motorsport bookings that generates and downloads the aggregate PDF.
  </done>
</task>

</tasks>

<verification>
1. All four Edge Function files exist in `supabase/functions/motorsport-stats-sheet-generator/`.
2. The concussion badge column renders correctly: shows badge when concussion suspected and competitor_cleared_to_return !== true, nothing for cleared or non-motorsport.
3. The stats sheet button only appears for motorsport bookings.
4. No TypeScript compilation errors in any modified file.
5. Null-safety verified: pre-Phase-18 treatments with null `vertical_extra_fields` do not crash the treatments table.
</verification>

<success_criteria>
- `motorsport-stats-sheet-generator` Edge Function exists with all 4 files
- Stats sheet aggregates treatment data: total count, severity, outcome, concussion count, extrication count, GCS range
- Concussion badge appears on treatments table for uncleared motorsport concussions (competitor_cleared_to_return !== true)
- "Generate Medical Statistics Sheet" button on motorsport booking detail page invokes the Edge Function
- All null-safety checks in place for `vertical_extra_fields`
</success_criteria>

<output>
After completion, create `.planning/phases/19-motorsport-vertical/19-04-SUMMARY.md`
</output>
