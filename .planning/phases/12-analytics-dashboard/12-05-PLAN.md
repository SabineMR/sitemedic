---
phase: 12-analytics-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["12-01", "12-02", "12-03"]
files_modified:
  - web/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees 'Territory' tab in analytics page and it renders heatmap, hiring trigger cards, coverage gap table"
    - "Admin sees 'Assignments' tab in analytics page and it renders success rate chart and failure breakdown"
    - "Admin sees 'Utilisation' tab in analytics page and it renders sortable medic table, OOT chart, late arrival heatmap"
    - "All 3 new tabs show loading skeletons while data fetches"
    - "Existing 4 tabs (overview, medics, geofences, alerts) are completely untouched"
    - "No parallel write conflicts — this is the only plan modifying page.tsx"
  artifacts:
    - path: "web/app/admin/analytics/page.tsx"
      provides: "7-tab analytics page with territory, assignments, utilisation tabs added"
      contains: "'territory'"
  key_links:
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/admin/territory-analytics-charts.tsx"
      via: "static import for chart components"
      pattern: "territory-analytics-charts"
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/admin/assignment-analytics-charts.tsx"
      via: "static import for chart components"
      pattern: "assignment-analytics-charts"
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/admin/medic-utilisation-charts.tsx"
      via: "static import for chart components"
      pattern: "medic-utilisation-charts"
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/admin/territory-map"
      via: "dynamic import with ssr:false (Leaflet requires browser APIs)"
      pattern: "dynamic.*territory-map"
---

<objective>
Wire all three new analytics tabs (Territory, Assignments, Utilisation) into the analytics page in a single pass.

Purpose: Plans 12-01, 12-02, and 12-03 each create chart component files but do NOT modify analytics/page.tsx. This plan adds all three tabs to the page in one atomic operation, preventing the parallel write conflict that would occur if each plan modified the page independently.

Output: Updated `web/app/admin/analytics/page.tsx` with 7 tabs total (4 existing + 3 new).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-dashboard/12-04-SUMMARY.md (query hooks and types)
@web/app/admin/analytics/page.tsx (current page with 4 tabs — extend, do NOT refactor existing tabs)
@web/components/admin/territory-analytics-charts.tsx (TerritoryHeatmap, HiringTriggerCards, CoverageGapTable — from 12-01)
@web/components/admin/assignment-analytics-charts.tsx (AssignmentSuccessChart, FailureBreakdownChart — from 12-02)
@web/components/admin/medic-utilisation-charts.tsx (MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap — from 12-03)
@web/lib/queries/admin/analytics.ts (useAutoAssignmentStats, useMedicUtilisation, useOutOfTerritoryBookings, useLateArrivalPatterns, OOTSummary, LateArrivalSummary)
@web/lib/queries/admin/territories.ts (useTerritories)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add all three new tabs to analytics page in one pass</name>
  <files>web/app/admin/analytics/page.tsx</files>
  <action>
Extend `web/app/admin/analytics/page.tsx` to add 'territory', 'assignments', and 'utilisation' tabs. Do NOT refactor or modify existing tabs (overview, medics, geofences, alerts). Only ADD the new tabs and their imports.

**Changes to make:**

1. **Add imports at the top of the file** (after existing imports):

   Static imports for chart components (they are 'use client' components, no SSR issues):
   ```typescript
   import dynamic from 'next/dynamic';
   import { TerritoryHeatmap, HiringTriggerCards, CoverageGapTable } from '@/components/admin/territory-analytics-charts';
   import { AssignmentSuccessChart, FailureBreakdownChart } from '@/components/admin/assignment-analytics-charts';
   import { MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap } from '@/components/admin/medic-utilisation-charts';
   import { useTerritories } from '@/lib/queries/admin/territories';
   import { useAutoAssignmentStats, useMedicUtilisation, useOutOfTerritoryBookings, useLateArrivalPatterns } from '@/lib/queries/admin/analytics';
   import type { OOTSummary, LateArrivalSummary } from '@/lib/queries/admin/analytics';
   ```

   Dynamic import ONLY for TerritoryMap (Leaflet requires browser APIs, crashes during SSR):
   ```typescript
   const TerritoryMapDynamic = dynamic(
     () => import('@/components/admin/territory-map'),
     { ssr: false, loading: () => <div className="h-[500px] bg-gray-800 rounded-lg animate-pulse" /> }
   );
   ```

   NOTE: Do NOT use dynamic import for the chart components — they are standard React client components. Only TerritoryMap (Leaflet) needs dynamic import with ssr:false.

2. **Update the activeTab state type** to include the 3 new tabs:
   ```typescript
   const [activeTab, setActiveTab] = useState<'overview' | 'medics' | 'geofences' | 'alerts' | 'territory' | 'assignments' | 'utilisation'>('overview');
   ```

3. **Update the tabs array** in the JSX to include the 3 new tabs:
   ```typescript
   {(['overview', 'medics', 'geofences', 'alerts', 'territory', 'assignments', 'utilisation'] as const).map((tab) => (
   ```

4. **Create 3 sub-components** (defined INSIDE the file, BEFORE the default export) so that hooks are only called when the tab is active:

   ```typescript
   function TerritoryTab() {
     const { data: territories = [], isLoading } = useTerritories();

     if (isLoading) {
       return <div className="h-96 bg-gray-800 rounded-lg animate-pulse" />;
     }

     return (
       <div className="space-y-6">
         <TerritoryHeatmap territories={territories} TerritoryMapComponent={TerritoryMapDynamic} />
         <HiringTriggerCards territories={territories} />
         <CoverageGapTable territories={territories} />
       </div>
     );
   }

   function AssignmentsTab() {
     const { data: stats = [], isLoading } = useAutoAssignmentStats();

     if (isLoading) {
       return <div className="h-96 bg-gray-800 rounded-lg animate-pulse" />;
     }

     return (
       <div className="space-y-6">
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Auto-Assignment Success Rate (Last 12 Weeks)</h2>
           <AssignmentSuccessChart data={stats} />
         </div>
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Failure Reason Breakdown</h2>
           <FailureBreakdownChart data={stats} />
         </div>
       </div>
     );
   }

   function UtilisationTab() {
     const { data: utilisation = [], isLoading: loadingUtil } = useMedicUtilisation();
     const { data: oot, isLoading: loadingOOT } = useOutOfTerritoryBookings();
     const { data: lateArrivals, isLoading: loadingLate } = useLateArrivalPatterns();

     const isLoading = loadingUtil || loadingOOT || loadingLate;

     if (isLoading) {
       return <div className="h-96 bg-gray-800 rounded-lg animate-pulse" />;
     }

     const ootData: OOTSummary = oot ?? { bookings: [], total_oot_bookings: 0, total_extra_cost: 0, oot_percentage: 0 };
     const lateData: LateArrivalSummary = lateArrivals ?? { patterns: [], total_late_arrivals: 0, worst_day: 'N/A', worst_medic: 'N/A' };

     return (
       <div className="space-y-6">
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Medic Utilisation</h2>
           <MedicUtilisationTable data={utilisation} />
         </div>
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Out-of-Territory Bookings</h2>
           <OOTBookingsChart data={ootData} />
         </div>
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Late Arrival Patterns</h2>
           <LateArrivalHeatmap data={lateData} />
         </div>
       </div>
     );
   }
   ```

5. **Add the 3 tab content sections** at the end of the JSX (after the alerts tab, before the closing `</div>`):
   ```tsx
   {activeTab === 'territory' && <TerritoryTab />}
   {activeTab === 'assignments' && <AssignmentsTab />}
   {activeTab === 'utilisation' && <UtilisationTab />}
   ```

**IMPORTANT RULES:**
- Do NOT touch any existing tab code (overview, medics, geofences, alerts)
- Do NOT refactor the existing useEffect-based data fetching to TanStack Query
- Only ADD the new imports, sub-components, tab buttons, and tab content sections
- Use STATIC imports for all chart components (they are 'use client')
- Use DYNAMIC import with ssr:false ONLY for TerritoryMapDynamic (Leaflet requirement)
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep analytics` to verify the page compiles. Then run `pnpm build 2>&1 | tail -20` to confirm the build succeeds (catches SSR issues with Leaflet).
  </verify>
  <done>
- Analytics page has 7 tabs: overview, medics, geofences, alerts, territory, assignments, utilisation
- Territory tab renders TerritoryHeatmap, HiringTriggerCards, CoverageGapTable
- Assignments tab renders AssignmentSuccessChart, FailureBreakdownChart
- Utilisation tab renders MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap
- TerritoryMap is dynamically imported with ssr:false (no Leaflet SSR crash)
- Chart components use static imports (no unnecessary dynamic imports)
- All 3 new tabs show loading skeletons while data fetches
- Existing 4 tabs are completely untouched
- TypeScript compiles without errors
- Build succeeds without SSR crashes
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project web/tsconfig.json` passes
- `pnpm build` succeeds (no SSR crashes from Leaflet)
- Analytics page loads with 7 tabs
- Territory tab shows heatmap, hiring trigger cards, coverage gap table
- Assignments tab shows success rate chart and failure breakdown
- Utilisation tab shows medic table, OOT chart, late arrival heatmap
- Existing 4 tabs are unaffected
</verification>

<success_criteria>
1. All 7 tabs accessible and rendering correctly
2. Territory tab renders 3 sub-components with heatmap
3. Assignments tab renders 2 Recharts components
4. Utilisation tab renders 3 sub-components with sortable table
5. No parallel write conflicts (this is the only plan modifying page.tsx)
6. Build succeeds without SSR errors
7. Existing tabs completely untouched
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-dashboard/12-05-SUMMARY.md`
</output>
