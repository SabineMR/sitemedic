---
phase: 12-analytics-dashboard
plan: 01
type: execute
wave: 2
depends_on: ["12-04"]
files_modified:
  - web/components/admin/territory-analytics-charts.tsx
  - web/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees territory coverage heatmap on the Territory tab"
    - "Admin sees hiring trigger cards grouped by region with severity colors"
    - "Admin sees 'Manchester M1 - 94% utilisation for 4 weeks - HIRE NOW' style card"
    - "Admin sees coverage gap table with sectors >10% rejection rate"
    - "Territory tab shows empty state when no territory data exists"
  artifacts:
    - path: "web/components/admin/territory-analytics-charts.tsx"
      provides: "TerritoryHeatmap, HiringTriggerCards, CoverageGapTable components"
      exports:
        - "TerritoryHeatmap"
        - "HiringTriggerCards"
        - "CoverageGapTable"
    - path: "web/app/admin/analytics/page.tsx"
      provides: "Territory tab added to analytics page"
      contains: "'territory'"
  key_links:
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/admin/territory-analytics-charts.tsx"
      via: "dynamic import with ssr:false"
      pattern: "dynamic.*territory-analytics-charts"
    - from: "web/components/admin/territory-analytics-charts.tsx"
      to: "web/lib/queries/admin/territories.ts"
      via: "useTerritories hook"
      pattern: "useTerritories"
    - from: "web/components/admin/territory-analytics-charts.tsx"
      to: "web/lib/territory/hiring-triggers.ts"
      via: "detectHiringTriggers + groupTriggersByRegion"
      pattern: "detectHiringTriggers"
---

<objective>
Build the Territory Analytics tab with heatmap, hiring trigger cards, and coverage gap table.

Purpose: Surface territory coverage data that has been computed since Phase 07.5 but never shown to admins. This is the most complex analytics view because it combines map visualization, alert cards, and data tables.

Output: Territory tab in analytics page with 3 sub-components, all properly rendered with dark theme styling.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-dashboard/12-04-SUMMARY.md (query hooks created in 12-04)
@web/app/admin/analytics/page.tsx (extend with new tab — do NOT refactor existing tabs)
@web/components/admin/territory-map.tsx (reuse TerritoryMapInner for heatmap — already has Leaflet circles)
@web/components/admin/revenue-charts.tsx (follow this pattern for component structure and dark theme)
@web/lib/queries/admin/territories.ts (useTerritories, TerritoryWithMetrics, getUtilizationColor)
@web/lib/territory/hiring-triggers.ts (detectHiringTriggers, groupTriggersByRegion, HiringTrigger)
@web/lib/territory/coverage-gaps.ts (detectCoverageGaps, sortGapsBySeverity, CoverageGap)
@web/lib/territory/metrics.ts (aggregateTerritoryMetrics, TerritoryMetricsSummary)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create territory analytics chart components</name>
  <files>web/components/admin/territory-analytics-charts.tsx</files>
  <action>
Create `web/components/admin/territory-analytics-charts.tsx` with 3 exported components. Follow revenue-charts.tsx pattern for structure and dark theme.

**Add 'use client' at the top.**

**Imports:**
```typescript
import { useTerritories, getUtilizationColor } from '@/lib/queries/admin/territories';
import type { TerritoryWithMetrics } from '@/lib/queries/admin/territories';
import { detectHiringTriggers, groupTriggersByRegion } from '@/lib/territory/hiring-triggers';
import type { HiringTrigger } from '@/lib/territory/hiring-triggers';
import { detectCoverageGaps, sortGapsBySeverity } from '@/lib/territory/coverage-gaps';
import { aggregateTerritoryMetrics } from '@/lib/territory/metrics';
```

**Component 1: TerritoryHeatmap**
```typescript
interface TerritoryHeatmapProps {
  territories: TerritoryWithMetrics[];
  TerritoryMapComponent: React.ComponentType<any>; // Passed in to avoid SSR import
}
```
- Accept territories data as prop (parent fetches via useTerritories)
- Accept TerritoryMapComponent as prop (parent does the dynamic import of territory-map.tsx)
- Show summary stats from `aggregateTerritoryMetrics()` at the top:
  - Total territories, assigned, unassigned, avg utilisation, high utilisation count, coverage gap count
  - Use 6-column grid, dark theme cards (bg-gray-800 rounded-lg p-4 border border-gray-700)
- Below stats, render the TerritoryMapComponent at height 500px
- Empty state: if territories.length === 0, show "No territory data available" message

**Component 2: HiringTriggerCards**
```typescript
interface HiringTriggerCardsProps {
  territories: TerritoryWithMetrics[];
}
```
- Call `detectHiringTriggers(territories)` to get triggers
- CRITICAL FIX from research: The lib function hardcodes weeks_active to 0. Fix at display layer:
  ```typescript
  const triggers = detectHiringTriggers(territories);
  const triggersWithWeeks = triggers.map(t => {
    const territory = territories.find(terr => terr.id === t.territory_id);
    return { ...t, weeks_active: territory?.hiring_trigger_weeks ?? 0 };
  });
  ```
- Call `groupTriggersByRegion(triggersWithWeeks)` to get grouped triggers
- Render region groups, each with:
  - Region header (e.g., "Manchester")
  - Trigger cards within the region, each showing:
    - Postcode sector (e.g., "M1")
    - Utilisation % or rejection rate
    - Weeks active (e.g., "4 weeks")
    - Severity badge: critical = bg-red-500/20 text-red-400, warning = bg-yellow-500/20 text-yellow-400
    - Trigger type icon/label
    - Message from trigger
    - For critical triggers with weeks_active >= 3: add pulsing red dot indicator (animate-pulse)
  - Card format for the success criteria example: "Manchester M1 -- 94% utilisation for 4 weeks -- HIRE NOW"
    - "HIRE NOW" badge for critical high_utilization triggers with weeks_active >= 3
    - "MONITOR" badge for warning triggers
- Severity colors: critical = red border-l-4 border-red-500, warning = yellow border-l-4 border-yellow-500
- Empty state: "No hiring triggers detected -- all territories within capacity"

**Component 3: CoverageGapTable**
```typescript
interface CoverageGapTableProps {
  territories: TerritoryWithMetrics[];
}
```
- Call `detectCoverageGaps(territories)` then `sortGapsBySeverity(gaps)`
- Render as a table (follow medics tab table pattern from analytics page):
  - Columns: Sector, Region, Rejection Rate, Total Bookings, Rejected, Severity, Recommended Action
  - Rejection rate cell: red text if > 25%, yellow if 10-25%
  - Severity badge: critical = bg-red-500/20 text-red-400, warning = bg-yellow-500/20 text-yellow-400
- Only show gaps where `minimum_volume_met === true` (filter out low-volume false positives)
- Empty state: "No coverage gaps detected -- all territories meeting service levels"
- Dark theme: bg-gray-800 border-gray-700, text-gray-300 for body text
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep territory-analytics` to verify no TypeScript errors.
  </verify>
  <done>
- File exists at `web/components/admin/territory-analytics-charts.tsx`
- 3 components exported: TerritoryHeatmap, HiringTriggerCards, CoverageGapTable
- HiringTriggerCards patches weeks_active from territory data (not hardcoded 0)
- Critical triggers show pulsing indicator and "HIRE NOW" badge
- Coverage gap table filters out low-volume territories
- All components have empty state handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Territory tab to analytics page</name>
  <files>web/app/admin/analytics/page.tsx</files>
  <action>
Extend `web/app/admin/analytics/page.tsx` to add a 'territory' tab. Do NOT refactor or modify existing tabs (overview, medics, geofences, alerts). Only add the new tab.

**Changes to make:**

1. Update the `activeTab` state type to include 'territory':
   ```typescript
   const [activeTab, setActiveTab] = useState<'overview' | 'medics' | 'geofences' | 'alerts' | 'territory'>('overview');
   ```

2. Add 'territory' to the tabs array in the JSX:
   ```typescript
   {(['overview', 'medics', 'geofences', 'alerts', 'territory'] as const).map((tab) => (
   ```

3. Add dynamic imports at the top of the file (after existing imports):
   ```typescript
   import dynamic from 'next/dynamic';
   import { useTerritories } from '@/lib/queries/admin/territories';
   ```

4. Add dynamic import for chart components (SSR disabled for Leaflet):
   ```typescript
   const TerritoryMapDynamic = dynamic(
     () => import('@/components/admin/territory-map'),
     { ssr: false, loading: () => <div className="h-[500px] bg-gray-800 rounded-lg animate-pulse" /> }
   );
   const TerritoryAnalyticsDynamic = dynamic(
     () => import('@/components/admin/territory-analytics-charts').then(mod => ({
       default: ({ territories }: any) => (
         <>
           <mod.TerritoryHeatmap territories={territories} TerritoryMapComponent={TerritoryMapDynamic} />
           <mod.HiringTriggerCards territories={territories} />
           <mod.CoverageGapTable territories={territories} />
         </>
       )
     })),
     { ssr: false, loading: () => <div className="h-96 bg-gray-800 rounded-lg animate-pulse" /> }
   );
   ```

   Actually, simpler approach: dynamic import the chart components file and use them individually. Since TerritoryHeatmap needs the map component passed in, use a wrapper:

   ```typescript
   const TerritoryMapDynamic = dynamic(
     () => import('@/components/admin/territory-map'),
     { ssr: false, loading: () => <div className="h-[500px] bg-gray-800 rounded-lg animate-pulse" /> }
   );
   ```

   And in the territory analytics component itself, handle the dynamic map import internally. Better approach: import the chart components directly (they're 'use client' already) and pass the dynamically imported map as a prop.

   Simplest correct approach:
   ```typescript
   // At top level of file, add:
   import dynamic from 'next/dynamic';

   const TerritoryMapDynamic = dynamic(
     () => import('@/components/admin/territory-map'),
     { ssr: false, loading: () => <div className="h-[500px] bg-gray-800 rounded-lg animate-pulse" /> }
   );
   ```

   Then import the chart components statically (they're client components, no Leaflet dependency):
   ```typescript
   import { TerritoryHeatmap, HiringTriggerCards, CoverageGapTable } from '@/components/admin/territory-analytics-charts';
   ```

5. Inside the component, add useTerritories hook (only called when territory tab is active):
   Create a separate sub-component `TerritoryTab` to avoid calling useTerritories when tab is not active:
   ```typescript
   function TerritoryTab() {
     const { data: territories = [], isLoading } = useTerritories();

     if (isLoading) {
       return <div className="h-96 bg-gray-800 rounded-lg animate-pulse" />;
     }

     return (
       <div className="space-y-6">
         <TerritoryHeatmap territories={territories} TerritoryMapComponent={TerritoryMapDynamic} />
         <HiringTriggerCards territories={territories} />
         <CoverageGapTable territories={territories} />
       </div>
     );
   }
   ```

6. Add the territory tab content section (after the alerts tab):
   ```tsx
   {activeTab === 'territory' && <TerritoryTab />}
   ```

**IMPORTANT:**
- Do NOT touch any existing tab code (overview, medics, geofences, alerts)
- Do NOT refactor the existing useEffect-based data fetching to TanStack Query
- Only ADD the new tab and its imports
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep analytics` to verify the page compiles. Then run `pnpm build 2>&1 | tail -20` to confirm the build succeeds (catches SSR issues).
  </verify>
  <done>
- Analytics page has 5 tabs: overview, medics, geofences, alerts, territory
- Territory tab renders TerritoryHeatmap, HiringTriggerCards, CoverageGapTable
- TerritoryMap is dynamically imported with ssr:false (no Leaflet SSR crash)
- Existing tabs are completely untouched
- Territory tab shows loading skeleton while data fetches
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project web/tsconfig.json` passes
- `pnpm build` succeeds (no SSR crashes from Leaflet)
- Analytics page loads with 5 tabs
- Territory tab shows heatmap, hiring trigger cards, coverage gap table
- Hiring trigger cards show weeks_active from territory data (not hardcoded 0)
- Coverage gap table only shows sectors with total_bookings >= 10
</verification>

<success_criteria>
1. Admin sees territory coverage heatmap with color-coded utilisation circles
2. Admin sees hiring trigger cards like "Manchester M1 -- 94% utilisation for 4 weeks -- HIRE NOW"
3. Coverage gap table shows sectors with >10% rejection rate, sorted by severity
4. All components handle empty data gracefully
5. Build succeeds without SSR errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-dashboard/12-01-SUMMARY.md`
</output>
