---
phase: 12-analytics-dashboard
plan: 01
type: execute
wave: 2
depends_on: ["12-04"]
files_modified:
  - web/components/admin/territory-analytics-charts.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees territory coverage heatmap on the Territory tab"
    - "Admin sees hiring trigger cards grouped by region with severity colors"
    - "Admin sees 'Manchester M1 - 94% utilisation for 4 weeks - HIRE NOW' style card"
    - "Admin sees coverage gap table with sectors >10% rejection rate"
    - "Territory tab shows empty state when no territory data exists"
  artifacts:
    - path: "web/components/admin/territory-analytics-charts.tsx"
      provides: "TerritoryHeatmap, HiringTriggerCards, CoverageGapTable components"
      exports:
        - "TerritoryHeatmap"
        - "HiringTriggerCards"
        - "CoverageGapTable"
  key_links:
    - from: "web/components/admin/territory-analytics-charts.tsx"
      to: "web/lib/queries/admin/territories.ts"
      via: "useTerritories hook"
      pattern: "useTerritories"
    - from: "web/components/admin/territory-analytics-charts.tsx"
      to: "web/lib/territory/hiring-triggers.ts"
      via: "detectHiringTriggers + groupTriggersByRegion"
      pattern: "detectHiringTriggers"
---

<objective>
Build the Territory Analytics chart components: heatmap, hiring trigger cards, and coverage gap table.

Purpose: Surface territory coverage data that has been computed since Phase 07.5 but never shown to admins. This is the most complex analytics view because it combines map visualization, alert cards, and data tables.

Output: `web/components/admin/territory-analytics-charts.tsx` with 3 exported components. Page wiring happens in 12-05.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-dashboard/12-04-SUMMARY.md (query hooks created in 12-04)
@web/components/admin/territory-map.tsx (reuse TerritoryMapInner for heatmap â€” already has Leaflet circles)
@web/components/admin/revenue-charts.tsx (follow this pattern for component structure and dark theme)
@web/lib/queries/admin/territories.ts (useTerritories, TerritoryWithMetrics, getUtilizationColor)
@web/lib/territory/hiring-triggers.ts (detectHiringTriggers, groupTriggersByRegion, HiringTrigger)
@web/lib/territory/coverage-gaps.ts (detectCoverageGaps, sortGapsBySeverity, CoverageGap)
@web/lib/territory/metrics.ts (aggregateTerritoryMetrics, TerritoryMetricsSummary)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create territory analytics chart components</name>
  <files>web/components/admin/territory-analytics-charts.tsx</files>
  <action>
Create `web/components/admin/territory-analytics-charts.tsx` with 3 exported components. Follow revenue-charts.tsx pattern for structure and dark theme.

**Add 'use client' at the top.**

**Imports:**
```typescript
import { useTerritories, getUtilizationColor } from '@/lib/queries/admin/territories';
import type { TerritoryWithMetrics } from '@/lib/queries/admin/territories';
import { detectHiringTriggers, groupTriggersByRegion } from '@/lib/territory/hiring-triggers';
import type { HiringTrigger } from '@/lib/territory/hiring-triggers';
import { detectCoverageGaps, sortGapsBySeverity } from '@/lib/territory/coverage-gaps';
import { aggregateTerritoryMetrics } from '@/lib/territory/metrics';
```

**Component 1: TerritoryHeatmap**
```typescript
interface TerritoryHeatmapProps {
  territories: TerritoryWithMetrics[];
  TerritoryMapComponent: React.ComponentType<any>; // Passed in to avoid SSR import
}
```
- Accept territories data as prop (parent fetches via useTerritories)
- Accept TerritoryMapComponent as prop (parent does the dynamic import of territory-map.tsx)
- Show summary stats from `aggregateTerritoryMetrics()` at the top:
  - Total territories, assigned, unassigned, avg utilisation, high utilisation count, coverage gap count
  - Use 6-column grid, dark theme cards (bg-gray-800 rounded-lg p-4 border border-gray-700)
- Below stats, render the TerritoryMapComponent at height 500px
- Empty state: if territories.length === 0, show "No territory data available" message

**Component 2: HiringTriggerCards**
```typescript
interface HiringTriggerCardsProps {
  territories: TerritoryWithMetrics[];
}
```
- Call `detectHiringTriggers(territories)` to get triggers
- CRITICAL FIX from research: The lib function hardcodes weeks_active to 0. Fix at display layer:
  ```typescript
  const triggers = detectHiringTriggers(territories);
  const triggersWithWeeks = triggers.map(t => {
    const territory = territories.find(terr => terr.id === t.territory_id);
    return { ...t, weeks_active: territory?.hiring_trigger_weeks ?? 0 };
  });
  ```
- Call `groupTriggersByRegion(triggersWithWeeks)` to get grouped triggers
- Render region groups, each with:
  - Region header (e.g., "Manchester")
  - Trigger cards within the region, each showing:
    - Postcode sector (e.g., "M1")
    - Utilisation % or rejection rate
    - Weeks active (e.g., "4 weeks")
    - Severity badge: critical = bg-red-500/20 text-red-400, warning = bg-yellow-500/20 text-yellow-400
    - Trigger type icon/label
    - Message from trigger
    - For critical triggers with weeks_active >= 3: add pulsing red dot indicator (animate-pulse)
  - Card format for the success criteria example: "Manchester M1 -- 94% utilisation for 4 weeks -- HIRE NOW"
    - "HIRE NOW" badge for critical high_utilization triggers with weeks_active >= 3
    - "MONITOR" badge for warning triggers
- Severity colors: critical = red border-l-4 border-red-500, warning = yellow border-l-4 border-yellow-500
- Empty state: "No hiring triggers detected -- all territories within capacity"

**Component 3: CoverageGapTable**
```typescript
interface CoverageGapTableProps {
  territories: TerritoryWithMetrics[];
}
```
- Call `detectCoverageGaps(territories)` then `sortGapsBySeverity(gaps)`
- Render as a table (follow medics tab table pattern from analytics page):
  - Columns: Sector, Region, Rejection Rate, Total Bookings, Rejected, Severity, Recommended Action
  - Rejection rate cell: red text if > 25%, yellow if 10-25%
  - Severity badge: critical = bg-red-500/20 text-red-400, warning = bg-yellow-500/20 text-yellow-400
- Only show gaps where `minimum_volume_met === true` (filter out low-volume false positives)
- Empty state: "No coverage gaps detected -- all territories meeting service levels"
- Dark theme: bg-gray-800 border-gray-700, text-gray-300 for body text
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep territory-analytics` to verify no TypeScript errors.
  </verify>
  <done>
- File exists at `web/components/admin/territory-analytics-charts.tsx`
- 3 components exported: TerritoryHeatmap, HiringTriggerCards, CoverageGapTable
- HiringTriggerCards patches weeks_active from territory data (not hardcoded 0)
- Critical triggers show pulsing indicator and "HIRE NOW" badge
- Coverage gap table filters out low-volume territories
- All components have empty state handling
- This plan does NOT modify analytics/page.tsx (page wiring deferred to 12-05)
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project web/tsconfig.json` passes
- File exports TerritoryHeatmap, HiringTriggerCards, CoverageGapTable
- Hiring trigger cards show weeks_active from territory data (not hardcoded 0)
- Coverage gap table only shows sectors with total_bookings >= 10
</verification>

<success_criteria>
1. Admin-facing components created for territory coverage heatmap with color-coded utilisation circles
2. Hiring trigger cards render like "Manchester M1 -- 94% utilisation for 4 weeks -- HIRE NOW"
3. Coverage gap table shows sectors with >10% rejection rate, sorted by severity
4. All components handle empty data gracefully
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-dashboard/12-01-SUMMARY.md`
</output>
