---
phase: 12-analytics-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["12-04"]
files_modified:
  - web/components/admin/assignment-analytics-charts.tsx
  - web/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees auto-assignment success rate line chart for the last 12 weeks"
    - "Admin sees failure reason breakdown when assignments fail"
    - "Chart shows empty state message when auto_schedule_logs has no data"
    - "Assignments tab is accessible from the analytics page"
  artifacts:
    - path: "web/components/admin/assignment-analytics-charts.tsx"
      provides: "AssignmentSuccessChart, FailureBreakdownChart components"
      exports:
        - "AssignmentSuccessChart"
        - "FailureBreakdownChart"
    - path: "web/app/admin/analytics/page.tsx"
      provides: "Assignments tab added to analytics page"
      contains: "'assignments'"
  key_links:
    - from: "web/components/admin/assignment-analytics-charts.tsx"
      to: "web/lib/queries/admin/analytics.ts"
      via: "useAutoAssignmentStats hook"
      pattern: "useAutoAssignmentStats"
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/admin/assignment-analytics-charts.tsx"
      via: "dynamic import with ssr:false"
      pattern: "dynamic.*assignment-analytics"
---

<objective>
Build the Assignments Analytics tab showing auto-assignment success rate chart and failure reason breakdown.

Purpose: Surface the auto-assignment performance data from `auto_schedule_logs` that has been tracked since Phase 07.5. Admins need to know if auto-assignment is working reliably and why it fails when it does.

Output: Assignments tab in analytics page with success rate line chart and failure breakdown bar chart.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-dashboard/12-04-SUMMARY.md (query hooks created in 12-04)
@web/app/admin/analytics/page.tsx (extend with new tab)
@web/components/admin/revenue-charts.tsx (follow this exact pattern for Recharts components)
@web/lib/queries/admin/analytics.ts (useAutoAssignmentStats, WeeklyAssignmentStats)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create assignment analytics chart components</name>
  <files>web/components/admin/assignment-analytics-charts.tsx</files>
  <action>
Create `web/components/admin/assignment-analytics-charts.tsx` with 2 exported components. Follow the exact Recharts pattern from revenue-charts.tsx.

**Add 'use client' at the top.**

**Imports:**
```typescript
import {
  LineChart,
  Line,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  Cell,
} from 'recharts';
import type { WeeklyAssignmentStats } from '@/lib/queries/admin/analytics';
```

**Component 1: AssignmentSuccessChart**
```typescript
interface AssignmentSuccessChartProps {
  data: WeeklyAssignmentStats[];
}

export function AssignmentSuccessChart({ data }: AssignmentSuccessChartProps) {
```
- Line chart showing 12 weeks of auto-assignment performance
- **CRITICAL empty state**: If data.length === 0, show: "No auto-assignment data recorded yet. Data will appear after the auto-assignment system processes bookings."
  - Use the same empty state pattern as revenue-charts.tsx: centered text in a div with h-[400px]
- X-axis: week_label (e.g., "W7 2026")
- Two Y-axes:
  - Left Y-axis: success_rate (0-100%), label "Success Rate %"
  - Right Y-axis: total_attempts (count), label "Attempts"
- Lines:
  - success_rate: green (#22c55e), strokeWidth 2, dot radius 4
  - total_attempts: blue (#2563EB), strokeWidth 1, dashed (strokeDasharray="5 5")
- Tooltip: dark theme (bg: #1F2937, border: #374151, text: #F3F4F6), show success_rate as "X%", total_attempts as count, avg_confidence as "X%"
- Summary cards above chart (3-column grid, dark theme):
  - Average success rate across all weeks
  - Total attempts across all weeks
  - Average confidence score across all weeks
- Dark theme chart styling: CartesianGrid stroke="#374151", axis stroke="#9CA3AF"
- ResponsiveContainer width 100%, height 400

**Component 2: FailureBreakdownChart**
```typescript
interface FailureBreakdownChartProps {
  data: WeeklyAssignmentStats[];
}

export function FailureBreakdownChart({ data }: FailureBreakdownChartProps) {
```
- Bar chart showing failure reasons aggregated across all weeks
- Group all `top_failure_reason` values across weeks, count occurrences of each reason
- Transform data into array of { reason: string, count: number } sorted DESC by count
- **CRITICAL empty state**: If no failure data (all successful or no data), show: "No assignment failures recorded -- excellent auto-assignment performance!"
- BarChart layout: vertical bars, one per failure reason
- Bar color: red (#ef4444) for all bars
- Tooltip: dark theme, show reason and count
- XAxis: reason text (truncate long reasons with ellipsis if >30 chars)
- YAxis: count
- Dark theme styling matching AssignmentSuccessChart
- ResponsiveContainer width 100%, height 300
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep assignment-analytics` to verify no TypeScript errors.
  </verify>
  <done>
- File exists at `web/components/admin/assignment-analytics-charts.tsx`
- 2 components exported: AssignmentSuccessChart, FailureBreakdownChart
- Both components have empty state handling for missing auto_schedule_logs data
- Charts use dark theme styling matching revenue-charts.tsx
- Recharts components follow same import and usage pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Assignments tab to analytics page</name>
  <files>web/app/admin/analytics/page.tsx</files>
  <action>
Extend `web/app/admin/analytics/page.tsx` to add an 'assignments' tab. Do NOT modify existing tabs or the territory tab from 12-01.

**Changes to make:**

1. Update the `activeTab` state type to include 'assignments' (it may already include 'territory' from 12-01):
   - If 12-01 ran first: extend the union type to add 'assignments'
   - If this runs first: add 'assignments' to the existing union

2. Add 'assignments' to the tabs array.

3. Add dynamic import for chart components (Recharts needs ssr:false to avoid hydration issues):
   ```typescript
   const AssignmentAnalyticsDynamic = dynamic(
     () => import('@/components/admin/assignment-analytics-charts').then(mod => ({
       default: mod.AssignmentSuccessChart
     })),
     { ssr: false, loading: () => <div className="h-96 bg-gray-800 rounded-lg animate-pulse" /> }
   );
   const FailureBreakdownDynamic = dynamic(
     () => import('@/components/admin/assignment-analytics-charts').then(mod => ({
       default: mod.FailureBreakdownChart
     })),
     { ssr: false, loading: () => <div className="h-64 bg-gray-800 rounded-lg animate-pulse" /> }
   );
   ```

   Alternatively, simpler approach: create a wrapper sub-component that handles the data fetching:

4. Import the hook:
   ```typescript
   import { useAutoAssignmentStats } from '@/lib/queries/admin/analytics';
   ```

5. Create sub-component for the Assignments tab:
   ```typescript
   function AssignmentsTab() {
     const { data: stats = [], isLoading } = useAutoAssignmentStats();

     if (isLoading) {
       return <div className="h-96 bg-gray-800 rounded-lg animate-pulse" />;
     }

     return (
       <div className="space-y-6">
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Auto-Assignment Success Rate (Last 12 Weeks)</h2>
           <AssignmentSuccessChart data={stats} />
         </div>
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Failure Reason Breakdown</h2>
           <FailureBreakdownChart data={stats} />
         </div>
       </div>
     );
   }
   ```

   But since Recharts needs ssr:false, dynamic import the sub-components. Best approach:
   - Import AssignmentSuccessChart and FailureBreakdownChart statically in the wrapper
   - Dynamic import the wrapper itself

   Actually, simplest: import the chart components normally (they have 'use client'), Recharts hydration is only an issue with SSR. Since the page is already 'use client', static imports work. Use dynamic only if build fails.

   Use static imports:
   ```typescript
   import { AssignmentSuccessChart, FailureBreakdownChart } from '@/components/admin/assignment-analytics-charts';
   ```

   If this causes hydration issues, switch to dynamic import pattern. Start with static since the analytics page is already 'use client'.

6. Add tab content:
   ```tsx
   {activeTab === 'assignments' && <AssignmentsTab />}
   ```

**NOTE on file conflict with 12-01:** Both 12-01 and 12-02 modify analytics/page.tsx. Since they're in the same wave, there may be a merge conflict. To handle this:
- Read the file fresh before making changes
- Only add your specific tab content and imports
- Do NOT touch territory tab code if it exists from 12-01

**IMPORTANT:**
- Do NOT touch existing tabs (overview, medics, geofences, alerts)
- Do NOT touch territory tab if 12-01 has already added it
- Only ADD the assignments tab, its imports, and its sub-component
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep analytics` to verify the page compiles.
  </verify>
  <done>
- Analytics page includes an 'assignments' tab
- Assignments tab renders AssignmentSuccessChart and FailureBreakdownChart
- Charts show empty state when auto_schedule_logs has no data
- Existing tabs are untouched
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project web/tsconfig.json` passes
- Analytics page loads with the assignments tab
- Success rate chart shows line chart or empty state
- Failure breakdown shows bar chart or "no failures" message
- Existing tabs are unaffected
</verification>

<success_criteria>
1. Auto-assignment success rate chart shows last 12 weeks without errors (or empty state)
2. Failure reason breakdown shows aggregated failure reasons
3. Summary cards show average success rate, total attempts, average confidence
4. Empty states display gracefully when no auto_schedule_logs data exists
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-dashboard/12-02-SUMMARY.md`
</output>
