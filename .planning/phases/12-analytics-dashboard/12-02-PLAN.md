---
phase: 12-analytics-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["12-04"]
files_modified:
  - web/components/admin/assignment-analytics-charts.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees auto-assignment success rate line chart for the last 12 weeks"
    - "Admin sees failure reason breakdown when assignments fail"
    - "Chart shows empty state message when auto_schedule_logs has no data"
  artifacts:
    - path: "web/components/admin/assignment-analytics-charts.tsx"
      provides: "AssignmentSuccessChart, FailureBreakdownChart components"
      exports:
        - "AssignmentSuccessChart"
        - "FailureBreakdownChart"
  key_links:
    - from: "web/components/admin/assignment-analytics-charts.tsx"
      to: "web/lib/queries/admin/analytics.ts"
      via: "useAutoAssignmentStats hook"
      pattern: "useAutoAssignmentStats"
---

<objective>
Build the Assignment Analytics chart components: success rate line chart and failure reason breakdown.

Purpose: Surface the auto-assignment performance data from `auto_schedule_logs` that has been tracked since Phase 07.5. Admins need to know if auto-assignment is working reliably and why it fails when it does.

Output: `web/components/admin/assignment-analytics-charts.tsx` with 2 exported Recharts components. Page wiring happens in 12-05.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-dashboard/12-04-SUMMARY.md (query hooks created in 12-04)
@web/components/admin/revenue-charts.tsx (follow this exact pattern for Recharts components)
@web/lib/queries/admin/analytics.ts (useAutoAssignmentStats, WeeklyAssignmentStats)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create assignment analytics chart components</name>
  <files>web/components/admin/assignment-analytics-charts.tsx</files>
  <action>
Create `web/components/admin/assignment-analytics-charts.tsx` with 2 exported components. Follow the exact Recharts pattern from revenue-charts.tsx.

**Add 'use client' at the top.**

**Imports:**
```typescript
import {
  LineChart,
  Line,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  Cell,
} from 'recharts';
import type { WeeklyAssignmentStats } from '@/lib/queries/admin/analytics';
```

**Component 1: AssignmentSuccessChart**
```typescript
interface AssignmentSuccessChartProps {
  data: WeeklyAssignmentStats[];
}

export function AssignmentSuccessChart({ data }: AssignmentSuccessChartProps) {
```
- Line chart showing 12 weeks of auto-assignment performance
- **CRITICAL empty state**: If data.length === 0, show: "No auto-assignment data recorded yet. Data will appear after the auto-assignment system processes bookings."
  - Use the same empty state pattern as revenue-charts.tsx: centered text in a div with h-[400px]
- X-axis: week_label (e.g., "W7 2026")
- Two Y-axes:
  - Left Y-axis: success_rate (0-100%), label "Success Rate %"
  - Right Y-axis: total_attempts (count), label "Attempts"
- Lines:
  - success_rate: green (#22c55e), strokeWidth 2, dot radius 4
  - total_attempts: blue (#2563EB), strokeWidth 1, dashed (strokeDasharray="5 5")
- Tooltip: dark theme (bg: #1F2937, border: #374151, text: #F3F4F6), show success_rate as "X%", total_attempts as count, avg_confidence as "X%"
- Summary cards above chart (3-column grid, dark theme):
  - Average success rate across all weeks
  - Total attempts across all weeks
  - Average confidence score across all weeks
- Dark theme chart styling: CartesianGrid stroke="#374151", axis stroke="#9CA3AF"
- ResponsiveContainer width 100%, height 400

**Component 2: FailureBreakdownChart**
```typescript
interface FailureBreakdownChartProps {
  data: WeeklyAssignmentStats[];
}

export function FailureBreakdownChart({ data }: FailureBreakdownChartProps) {
```
- Bar chart showing failure reasons aggregated across all weeks
- Group all `top_failure_reason` values across weeks, count occurrences of each reason
- Transform data into array of { reason: string, count: number } sorted DESC by count
- **CRITICAL empty state**: If no failure data (all successful or no data), show: "No assignment failures recorded -- excellent auto-assignment performance!"
- BarChart layout: vertical bars, one per failure reason
- Bar color: red (#ef4444) for all bars
- Tooltip: dark theme, show reason and count
- XAxis: reason text (truncate long reasons with ellipsis if >30 chars)
- YAxis: count
- Dark theme styling matching AssignmentSuccessChart
- ResponsiveContainer width 100%, height 300
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep assignment-analytics` to verify no TypeScript errors.
  </verify>
  <done>
- File exists at `web/components/admin/assignment-analytics-charts.tsx`
- 2 components exported: AssignmentSuccessChart, FailureBreakdownChart
- Both components have empty state handling for missing auto_schedule_logs data
- Charts use dark theme styling matching revenue-charts.tsx
- Recharts components follow same import and usage pattern
- This plan does NOT modify analytics/page.tsx (page wiring deferred to 12-05)
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project web/tsconfig.json` passes
- File exports AssignmentSuccessChart and FailureBreakdownChart
- Both components handle empty data gracefully
- Dark theme styling consistent with revenue-charts.tsx
</verification>

<success_criteria>
1. Auto-assignment success rate chart shows last 12 weeks without errors (or empty state)
2. Failure reason breakdown shows aggregated failure reasons
3. Summary cards show average success rate, total attempts, average confidence
4. Empty states display gracefully when no auto_schedule_logs data exists
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-dashboard/12-02-SUMMARY.md`
</output>
