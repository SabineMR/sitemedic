---
phase: 12-analytics-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["12-04"]
files_modified:
  - web/components/admin/medic-utilisation-charts.tsx
  - web/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees medic utilisation table sortable by utilisation %"
    - "Admin sees out-of-territory booking frequency and cost impact"
    - "Admin sees late arrival pattern heatmap by medic and day of week"
    - "Utilisation tab is accessible from the analytics page"
    - "All charts handle empty data with appropriate messages"
  artifacts:
    - path: "web/components/admin/medic-utilisation-charts.tsx"
      provides: "MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap components"
      exports:
        - "MedicUtilisationTable"
        - "OOTBookingsChart"
        - "LateArrivalHeatmap"
    - path: "web/app/admin/analytics/page.tsx"
      provides: "Utilisation tab added to analytics page"
      contains: "'utilisation'"
  key_links:
    - from: "web/components/admin/medic-utilisation-charts.tsx"
      to: "web/lib/queries/admin/analytics.ts"
      via: "useMedicUtilisation, useOutOfTerritoryBookings, useLateArrivalPatterns hooks"
      pattern: "useMedicUtilisation|useOutOfTerritoryBookings|useLateArrivalPatterns"
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/admin/medic-utilisation-charts.tsx"
      via: "static import (client components)"
      pattern: "medic-utilisation-charts"
---

<objective>
Build the Medic Utilisation tab with sortable utilisation table, OOT booking chart, and late arrival heatmap.

Purpose: Give admins visibility into per-medic performance metrics -- who is over/under-utilised, which bookings incur extra travel costs, and which medics/days have late arrival patterns.

Output: Utilisation tab in analytics page with 3 data visualizations.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-dashboard/12-04-SUMMARY.md (query hooks created in 12-04)
@web/app/admin/analytics/page.tsx (extend with new tab)
@web/components/admin/revenue-charts.tsx (follow dark theme pattern)
@web/lib/queries/admin/analytics.ts (useMedicUtilisation, useOutOfTerritoryBookings, useLateArrivalPatterns)
@web/lib/queries/admin/medics.ts (getUtilizationColor, getUtilizationTextColor)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medic utilisation chart components</name>
  <files>web/components/admin/medic-utilisation-charts.tsx</files>
  <action>
Create `web/components/admin/medic-utilisation-charts.tsx` with 3 exported components.

**Add 'use client' at the top.**

**Imports:**
```typescript
import { useState } from 'react';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from 'recharts';
import type { MedicUtilisation, OOTSummary, LateArrivalSummary } from '@/lib/queries/admin/analytics';
import { getUtilizationTextColor } from '@/lib/queries/admin/medics';
```

**Component 1: MedicUtilisationTable**
```typescript
interface MedicUtilisationTableProps {
  data: MedicUtilisation[];
}

export function MedicUtilisationTable({ data }: MedicUtilisationTableProps) {
```
- Sortable table showing per-medic utilisation
- **Sorting state:** `const [sortField, setSortField] = useState<'utilisation_pct' | 'medic_name' | 'total_shifts_completed'>('utilisation_pct');`
- **Sort direction:** `const [sortDir, setSortDir] = useState<'asc' | 'desc'>('desc');`
- Toggle sort on column header click (clicking same column toggles direction)
- Sort indicator: show arrow (up/down) next to active sort column
- Columns:
  - **Medic Name** (sortable): text-white font-medium
  - **Utilisation %** (sortable, default sort DESC): colored using getUtilizationTextColor
    - Also show a small progress bar (div with width proportional to %, colored green/yellow/red)
  - **Booked Days / 5**: e.g., "3/5" in text-gray-300
  - **Total Shifts** (sortable): total_shifts_completed in text-gray-300
  - **Territories**: territory_count, text-gray-300
  - **Status**: available badge (green "Available" or red "Unavailable")
- Table styling: bg-gray-800 rounded-lg border border-gray-700, header bg-gray-900
- Hover row: hover:bg-gray-700/50
- Empty state: "No medic data available"

**Component 2: OOTBookingsChart**
```typescript
interface OOTBookingsChartProps {
  data: OOTSummary;
}

export function OOTBookingsChart({ data }: OOTBookingsChartProps) {
```
- Shows out-of-territory booking frequency and cost impact
- Summary cards at top (3-column grid, dark theme):
  - Total OOT bookings: data.total_oot_bookings
  - Total extra cost: `Â£${data.total_extra_cost.toLocaleString()}` (travel bonus + room/board)
  - OOT %: `${data.oot_percentage.toFixed(1)}%` of all bookings
- Below cards: horizontal bar chart showing top 10 OOT bookings by cost
  - Each bar: medic_name on Y-axis, total_extra_cost on X-axis
  - Tooltip shows: medic name, site postcode, shift date, travel bonus, room/board, total
  - Bar color: orange (#f97316)
- Empty state: "No out-of-territory bookings recorded. All bookings within assigned territories."
- Dark theme styling

**Component 3: LateArrivalHeatmap**
```typescript
interface LateArrivalHeatmapProps {
  data: LateArrivalSummary;
}

export function LateArrivalHeatmap({ data }: LateArrivalHeatmapProps) {
```
- Heatmap grid showing late arrivals by medic (rows) and day of week (columns)
- Use CSS grid instead of Recharts (heatmaps aren't great in Recharts)
- Layout:
  - Header row: Mon, Tue, Wed, Thu, Fri (skip Sat/Sun unless data exists)
  - Each row: medic name on left, colored cells for each day
  - Cell color intensity based on late_count:
    - 0: bg-gray-800 (no lates)
    - 1-2: bg-yellow-500/20 (low)
    - 3-5: bg-orange-500/30 (medium)
    - 6+: bg-red-500/40 (high)
  - Cell text: late count number
- Extract unique medic names from patterns, build grid data
- Summary stats at top:
  - Total late arrivals: data.total_late_arrivals
  - Worst day: data.worst_day
  - Worst medic: data.worst_medic
- Empty state: "No late arrival alerts recorded. All medics arriving on time."
- Dark theme: bg-gray-800 border border-gray-700 for the grid container
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep medic-utilisation` to verify no TypeScript errors.
  </verify>
  <done>
- File exists at `web/components/admin/medic-utilisation-charts.tsx`
- 3 components exported: MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap
- MedicUtilisationTable is sortable by utilisation %, name, and shifts
- OOTBookingsChart shows cost impact with summary cards
- LateArrivalHeatmap uses CSS grid for day/medic visualization
- All components have empty state handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Utilisation tab to analytics page</name>
  <files>web/app/admin/analytics/page.tsx</files>
  <action>
Extend `web/app/admin/analytics/page.tsx` to add a 'utilisation' tab. Do NOT modify existing tabs or tabs added by 12-01/12-02.

**Changes to make:**

1. Update the `activeTab` state type to include 'utilisation' (add to existing union):
   - The type should now include all tabs: 'overview' | 'medics' | 'geofences' | 'alerts' | 'territory' | 'assignments' | 'utilisation'
   - If 12-01 and 12-02 haven't run yet, just add 'utilisation' alongside the original 4

2. Add 'utilisation' to the tabs array (capitalize display as "Utilisation").

3. Add imports:
   ```typescript
   import { MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap } from '@/components/admin/medic-utilisation-charts';
   import { useMedicUtilisation, useOutOfTerritoryBookings, useLateArrivalPatterns } from '@/lib/queries/admin/analytics';
   ```

4. Create sub-component for the Utilisation tab (avoids calling hooks when tab is not active):
   ```typescript
   function UtilisationTab() {
     const { data: utilisation = [], isLoading: loadingUtil } = useMedicUtilisation();
     const { data: oot, isLoading: loadingOOT } = useOutOfTerritoryBookings();
     const { data: lateArrivals, isLoading: loadingLate } = useLateArrivalPatterns();

     const isLoading = loadingUtil || loadingOOT || loadingLate;

     if (isLoading) {
       return <div className="h-96 bg-gray-800 rounded-lg animate-pulse" />;
     }

     // Provide default empty values for potentially undefined data
     const ootData: OOTSummary = oot ?? { bookings: [], total_oot_bookings: 0, total_extra_cost: 0, oot_percentage: 0 };
     const lateData: LateArrivalSummary = lateArrivals ?? { patterns: [], total_late_arrivals: 0, worst_day: 'N/A', worst_medic: 'N/A' };

     return (
       <div className="space-y-6">
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Medic Utilisation</h2>
           <MedicUtilisationTable data={utilisation} />
         </div>
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Out-of-Territory Bookings</h2>
           <OOTBookingsChart data={ootData} />
         </div>
         <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
           <h2 className="text-xl font-semibold mb-4">Late Arrival Patterns</h2>
           <LateArrivalHeatmap data={lateData} />
         </div>
       </div>
     );
   }
   ```

5. Add tab content:
   ```tsx
   {activeTab === 'utilisation' && <UtilisationTab />}
   ```

**NOTE on file conflict with 12-01 and 12-02:** All three Wave 2 plans modify analytics/page.tsx. Since they're in the same wave:
- Read the file fresh before making changes
- Only add your specific tab content and imports
- Do NOT touch territory tab code (12-01) or assignments tab code (12-02)
- If the other tabs exist, keep them. If they don't, just add yours.

**IMPORTANT:**
- Do NOT touch existing tabs (overview, medics, geofences, alerts)
- Do NOT touch territory or assignments tabs if they exist from 12-01/12-02
- Only ADD the utilisation tab, its imports, and its sub-component
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep analytics` to verify the page compiles.
  </verify>
  <done>
- Analytics page includes a 'utilisation' tab
- Utilisation tab renders MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap
- All 3 data hooks are called within the sub-component (lazy loading when tab active)
- Existing tabs are untouched
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project web/tsconfig.json` passes
- Analytics page loads with the utilisation tab
- Medic utilisation table is sortable by utilisation %
- OOT bookings chart shows frequency and cost
- Late arrival heatmap shows patterns by medic and day
- All charts handle empty data gracefully
</verification>

<success_criteria>
1. Medic utilisation table sortable by utilisation % (highest first by default)
2. Out-of-territory booking frequency shows total count and cost impact
3. Late arrival heatmap shows which medics are late on which days
4. All components display empty state messages when no data exists
5. Progress bars in utilisation table color-coded green/yellow/red
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-dashboard/12-03-SUMMARY.md`
</output>
