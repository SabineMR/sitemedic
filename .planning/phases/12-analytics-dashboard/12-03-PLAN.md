---
phase: 12-analytics-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["12-04"]
files_modified:
  - web/components/admin/medic-utilisation-charts.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees medic utilisation table sortable by utilisation %"
    - "Admin sees out-of-territory booking frequency and cost impact"
    - "Admin sees late arrival pattern heatmap by medic and day of week"
    - "All charts handle empty data with appropriate messages"
  artifacts:
    - path: "web/components/admin/medic-utilisation-charts.tsx"
      provides: "MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap components"
      exports:
        - "MedicUtilisationTable"
        - "OOTBookingsChart"
        - "LateArrivalHeatmap"
  key_links:
    - from: "web/components/admin/medic-utilisation-charts.tsx"
      to: "web/lib/queries/admin/analytics.ts"
      via: "useMedicUtilisation, useOutOfTerritoryBookings, useLateArrivalPatterns hooks"
      pattern: "useMedicUtilisation|useOutOfTerritoryBookings|useLateArrivalPatterns"
---

<objective>
Build the Medic Utilisation chart components: sortable utilisation table, OOT booking chart, and late arrival heatmap.

Purpose: Give admins visibility into per-medic performance metrics -- who is over/under-utilised, which bookings incur extra travel costs, and which medics/days have late arrival patterns.

Output: `web/components/admin/medic-utilisation-charts.tsx` with 3 data visualization components. Page wiring happens in 12-05.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-analytics-dashboard/12-04-SUMMARY.md (query hooks created in 12-04)
@web/components/admin/revenue-charts.tsx (follow dark theme pattern)
@web/lib/queries/admin/analytics.ts (useMedicUtilisation, useOutOfTerritoryBookings, useLateArrivalPatterns, OOTSummary, OutOfTerritoryBooking)
@web/lib/queries/admin/medics.ts (getUtilizationColor, getUtilizationTextColor)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medic utilisation chart components</name>
  <files>web/components/admin/medic-utilisation-charts.tsx</files>
  <action>
Create `web/components/admin/medic-utilisation-charts.tsx` with 3 exported components.

**Add 'use client' at the top.**

**Imports:**
```typescript
import { useState } from 'react';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from 'recharts';
import type { MedicUtilisation, OOTSummary, LateArrivalSummary } from '@/lib/queries/admin/analytics';
import { getUtilizationTextColor } from '@/lib/queries/admin/medics';
```

**Component 1: MedicUtilisationTable**
```typescript
interface MedicUtilisationTableProps {
  data: MedicUtilisation[];
}

export function MedicUtilisationTable({ data }: MedicUtilisationTableProps) {
```
- Sortable table showing per-medic utilisation
- **Sorting state:** `const [sortField, setSortField] = useState<'utilisation_pct' | 'medic_name' | 'total_shifts_completed'>('utilisation_pct');`
- **Sort direction:** `const [sortDir, setSortDir] = useState<'asc' | 'desc'>('desc');`
- Toggle sort on column header click (clicking same column toggles direction)
- Sort indicator: show arrow (up/down) next to active sort column
- Columns:
  - **Medic Name** (sortable): text-white font-medium
  - **Utilisation %** (sortable, default sort DESC): colored using getUtilizationTextColor
    - Also show a small progress bar (div with width proportional to %, colored green/yellow/red)
  - **Booked Days / 5**: e.g., "3/5" in text-gray-300
  - **Total Shifts** (sortable): total_shifts_completed in text-gray-300
  - **Territories**: territory_count, text-gray-300
  - **Status**: available badge (green "Available" or red "Unavailable")
- Table styling: bg-gray-800 rounded-lg border border-gray-700, header bg-gray-900
- Hover row: hover:bg-gray-700/50
- Empty state: "No medic data available"

**Component 2: OOTBookingsChart**

IMPORTANT: This component uses the UPDATED `OOTSummary` and `OutOfTerritoryBooking` types from 12-04 which have `out_of_territory_cost` and `out_of_territory_type` fields (NOT `travel_bonus`/`room_board`).

```typescript
interface OOTBookingsChartProps {
  data: OOTSummary;
}

export function OOTBookingsChart({ data }: OOTBookingsChartProps) {
```
- Shows out-of-territory booking frequency and cost impact
- Summary cards at top (3-column grid, dark theme):
  - Total OOT bookings: data.total_oot_bookings
  - Total extra cost: `GBP${data.total_extra_cost.toLocaleString()}` (from out_of_territory_cost)
  - OOT %: `${data.oot_percentage.toFixed(1)}%` of all bookings
- Below cards: horizontal bar chart showing top 10 OOT bookings by cost
  - Each bar: medic_name on Y-axis, out_of_territory_cost on X-axis
  - Tooltip shows: medic name, site postcode, shift date, out_of_territory_cost, out_of_territory_type (displayed as "Travel Bonus" or "Room & Board")
  - Bar color: orange (#f97316)
- Empty state: "No out-of-territory bookings recorded. All bookings within assigned territories."
- Dark theme styling

**Component 3: LateArrivalHeatmap**
```typescript
interface LateArrivalHeatmapProps {
  data: LateArrivalSummary;
}

export function LateArrivalHeatmap({ data }: LateArrivalHeatmapProps) {
```
- Heatmap grid showing late arrivals by medic (rows) and day of week (columns)
- Use CSS grid instead of Recharts (heatmaps aren't great in Recharts)
- Layout:
  - Header row: Mon, Tue, Wed, Thu, Fri (skip Sat/Sun unless data exists)
  - Each row: medic name on left, colored cells for each day
  - Cell color intensity based on late_count:
    - 0: bg-gray-800 (no lates)
    - 1-2: bg-yellow-500/20 (low)
    - 3-5: bg-orange-500/30 (medium)
    - 6+: bg-red-500/40 (high)
  - Cell text: late count number
- Extract unique medic names from patterns, build grid data
- Summary stats at top:
  - Total late arrivals: data.total_late_arrivals
  - Worst day: data.worst_day
  - Worst medic: data.worst_medic
- Empty state: "No late arrival alerts recorded. All medics arriving on time."
- Dark theme: bg-gray-800 border border-gray-700 for the grid container
  </action>
  <verify>
Run `npx tsc --noEmit --project web/tsconfig.json 2>&1 | grep medic-utilisation` to verify no TypeScript errors.
  </verify>
  <done>
- File exists at `web/components/admin/medic-utilisation-charts.tsx`
- 3 components exported: MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap
- MedicUtilisationTable is sortable by utilisation %, name, and shifts
- OOTBookingsChart uses out_of_territory_cost and out_of_territory_type (NOT travel_bonus/room_board)
- OOTBookingsChart tooltip displays out_of_territory_type as human-readable label ("Travel Bonus" / "Room & Board")
- LateArrivalHeatmap uses CSS grid for day/medic visualization
- All components have empty state handling
- This plan does NOT modify analytics/page.tsx (page wiring deferred to 12-05)
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project web/tsconfig.json` passes
- File exports MedicUtilisationTable, OOTBookingsChart, LateArrivalHeatmap
- OOTBookingsChart references out_of_territory_cost (not travel_bonus)
- All charts handle empty data gracefully
</verification>

<success_criteria>
1. Medic utilisation table sortable by utilisation % (highest first by default)
2. Out-of-territory booking frequency shows total count and cost impact using correct column names
3. Late arrival heatmap shows which medics are late on which days
4. All components display empty state messages when no data exists
5. Progress bars in utilisation table color-coded green/yellow/red
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-dashboard/12-03-SUMMARY.md`
</output>
