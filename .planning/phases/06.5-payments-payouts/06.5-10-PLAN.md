---
phase: 06.5-payments-payouts
plan: 10
type: execute
wave: 2
depends_on: []
files_modified:
  - web/app/admin/bookings/page.tsx
  - web/components/admin/booking-approval-table.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Admin sees out-of-territory cost breakdown when viewing bookings that require territory approval"
    - "Out-of-territory approval component is rendered in the admin booking workflow"
    - "Booking confirmation is blocked when requires_manual_approval is true and not yet approved"
  artifacts:
    - path: "web/app/admin/bookings/page.tsx"
      provides: "Admin bookings page with out-of-territory integration"
      contains: "OutOfTerritory"
    - path: "web/components/admin/booking-approval-table.tsx"
      provides: "Booking table with out-of-territory cost display and approval trigger"
      contains: "OutOfTerritory"
  key_links:
    - from: "web/components/admin/booking-approval-table.tsx"
      to: "web/components/admin/out-of-territory-approval.tsx"
      via: "import and conditional render"
      pattern: "import.*OutOfTerritoryApproval"
    - from: "web/components/admin/booking-approval-table.tsx"
      to: "web/app/api/bookings/calculate-cost/route.ts"
      via: "fetch to calculate cost"
      pattern: "calculate-cost"
---

<objective>
Wire the existing out-of-territory approval component into the admin booking workflow.

Purpose: The OutOfTerritoryApproval component (518 lines at `web/components/admin/out-of-territory-approval.tsx`) and the OutOfTerritoryCalculator component (`web/components/bookings/out-of-territory-calculator.tsx`) exist but are orphaned -- not imported or rendered anywhere. Admin cannot see cost breakdowns or approve/deny out-of-territory bookings. These components need to be integrated into the admin bookings page.

Output: Admin booking approval workflow shows out-of-territory cost details and approval controls for bookings flagged as out-of-territory.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.5-payments-payouts/06.5-05-SUMMARY.md
@.planning/phases/06.5-payments-payouts/06.5-VERIFICATION.md
@web/app/admin/bookings/page.tsx
@web/components/admin/booking-approval-table.tsx
@web/components/admin/out-of-territory-approval.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate out-of-territory approval into booking approval table</name>
  <files>web/components/admin/booking-approval-table.tsx</files>
  <action>
  Read the full content of `web/components/admin/booking-approval-table.tsx` to understand its structure (TanStack Table columns, row rendering, existing approval actions).

  Also read `web/components/admin/out-of-territory-approval.tsx` to understand its props interface.

  Then make these changes to `booking-approval-table.tsx`:

  1. **Add import** at top of file:
     ```typescript
     import { OutOfTerritoryApproval } from './out-of-territory-approval';
     ```

  2. **Add state for selected out-of-territory booking:**
     ```typescript
     const [selectedOOTBooking, setSelectedOOTBooking] = useState<string | null>(null);
     ```

  3. **Add a "Territory" column** to the columns array. This should appear after the status column. The column should:
     - Check if the booking has `is_out_of_territory === true` or `requires_manual_approval === true`
     - If out-of-territory: show a badge/indicator (orange badge with "Out of Territory" text)
     - If the booking's `territory_approval_status` is 'pending': show an "Approve" button that sets `selectedOOTBooking` to the booking ID
     - If already approved: show green "Approved" badge
     - If denied: show red "Denied" badge
     - If NOT out-of-territory: show nothing or a dash

     ```typescript
     {
       id: 'territory',
       header: 'Territory',
       cell: ({ row }) => {
         const booking = row.original;
         if (!booking.is_out_of_territory) return <span className="text-gray-500">-</span>;

         if (booking.territory_approval_status === 'approved') {
           return <span className="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Approved</span>;
         }
         if (booking.territory_approval_status === 'denied') {
           return <span className="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Denied</span>;
         }

         return (
           <Button
             variant="outline"
             size="sm"
             className="text-orange-600 border-orange-300 hover:bg-orange-50"
             onClick={() => setSelectedOOTBooking(booking.id)}
           >
             Review Cost
           </Button>
         );
       },
     },
     ```

  4. **Render the OutOfTerritoryApproval component** as a dialog/panel below the table (or as a slide-over). Add this AFTER the table JSX, inside the component's return:

     ```tsx
     {selectedOOTBooking && (
       <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
         <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
           <div className="p-4 border-b flex justify-between items-center">
             <h2 className="text-lg font-semibold">Out-of-Territory Review</h2>
             <Button
               variant="ghost"
               size="sm"
               onClick={() => setSelectedOOTBooking(null)}
             >
               Close
             </Button>
           </div>
           <div className="p-4">
             <OutOfTerritoryApproval
               bookingId={selectedOOTBooking}
               onApproved={() => {
                 setSelectedOOTBooking(null);
                 // Trigger refetch of bookings data
               }}
               onDenied={() => {
                 setSelectedOOTBooking(null);
                 // Trigger refetch of bookings data
               }}
             />
           </div>
         </div>
       </div>
     )}
     ```

     Adapt the props to match what OutOfTerritoryApproval actually expects. Read the component to check exact prop names and types. If it uses different prop names (e.g., `onClose`, `onComplete`), use those instead.

  5. **Trigger data refetch** after approval/denial. The existing pattern uses TanStack Query's `queryClient.invalidateQueries()`. Look for how the existing approve/reject actions trigger refetch and follow the same pattern.

  Do NOT change the existing column definitions, bulk operations, or medic reassignment logic. Only ADD the territory column and approval panel.
  </action>
  <verify>
  `grep "OutOfTerritoryApproval" web/components/admin/booking-approval-table.tsx` returns import and usage.
  `grep "selectedOOTBooking" web/components/admin/booking-approval-table.tsx` returns state and handlers.
  `grep "is_out_of_territory" web/components/admin/booking-approval-table.tsx` returns column check.
  `cd /Users/sabineresoagli/GitHub/sitemedic && pnpm tsc --noEmit 2>&1 | grep "booking-approval-table\|out-of-territory" || echo "No type errors"`
  </verify>
  <done>
  - OutOfTerritoryApproval component imported and rendered in booking approval table
  - "Territory" column shows out-of-territory status with "Review Cost" button for pending bookings
  - Modal/dialog opens OutOfTerritoryApproval with booking ID
  - Data refetches after approval or denial
  - Existing booking table functionality unchanged
  </done>
</task>

</tasks>

<verification>
- `grep -c "OutOfTerritoryApproval" web/components/admin/booking-approval-table.tsx` returns >= 2 (import + usage)
- `grep -c "out-of-territory" web/components/admin/booking-approval-table.tsx` returns >= 1
- Admin bookings page renders without errors: `pnpm tsc --noEmit`
</verification>

<success_criteria>
1. Out-of-territory bookings show "Review Cost" button in booking table
2. Clicking opens the existing OutOfTerritoryApproval component with the booking's cost breakdown
3. Approval/denial updates booking and refreshes the table
4. Non-out-of-territory bookings are unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-10-SUMMARY.md`
</output>
