---
phase: 06.5-payments-payouts
plan: 05
type: execute
wave: 3
depends_on: ["06.5-01", "06.5-02"]
files_modified:
  - web/lib/bookings/out-of-territory.ts
  - web/app/api/bookings/calculate-cost/route.ts
  - web/components/bookings/out-of-territory-calculator.tsx
  - web/components/admin/out-of-territory-approval.tsx
  - supabase/migrations/022_out_of_territory_rules.sql
autonomous: true

must_haves:
  truths:
    - "Out-of-territory bookings calculate travel bonus (2/mile beyond 30 miles) vs room/board cost"
    - "Admin sees cost breakdown and can approve/deny out-of-territory booking"
    - "System denies booking if out-of-territory cost >50% of shift cost (admin can override)"
    - "Travel time from secondary medic's home to site calculated via Google Maps"
    - "Room/board cost option displays when travel >2 hours (flat rate)"
  artifacts:
    - path: "web/lib/bookings/out-of-territory.ts"
      provides: "Cost calculation logic for out-of-territory bookings"
      exports: ["calculateOutOfTerritoryCost", "shouldDenyBooking", "recommendedOption"]
    - path: "web/app/api/bookings/calculate-cost/route.ts"
      provides: "API endpoint for cost calculation with Google Maps integration"
      exports: ["POST"]
    - path: "web/components/bookings/out-of-territory-calculator.tsx"
      provides: "React component showing cost breakdown and recommendations"
      contains: "OutOfTerritoryCalculator"
    - path: "web/components/admin/out-of-territory-approval.tsx"
      provides: "Admin approval interface for high-cost bookings"
      contains: "OutOfTerritoryApproval"
    - path: "supabase/migrations/022_out_of_territory_rules.sql"
      provides: "Business rules and cost thresholds for out-of-territory logic"
      exports: []
  key_links:
    - from: "web/lib/bookings/out-of-territory.ts"
      to: "Google Maps Distance Matrix API"
      via: "calculates travel time and distance"
      pattern: "maps.googleapis.com"
    - from: "web/app/api/bookings/calculate-cost/route.ts"
      to: "travel_time_cache table"
      via: "caches API results for 7 days"
      pattern: "travel_time_cache"
    - from: "web/components/admin/out-of-territory-approval.tsx"
      to: "bookings table"
      via: "updates requires_manual_approval and approval fields"
      pattern: "bookings.*approved"
---

<objective>
Create out-of-territory cost management system with travel bonus calculation, room/board comparison, Google Maps integration, admin approval workflow, and automatic denial for high-cost bookings.

Purpose: When a booking site is outside the primary medic's territory, the system calculates the most cost-effective option: (1) travel bonus for secondary medic (£2/mile beyond 30 miles), (2) room/board for overnight stay (flat rate), or (3) deny booking if cost >50% of shift value. Admin reviews cost breakdown and approves/denies based on business rules.

Output: Cost calculator, Google Maps integration with caching, admin approval UI, and booking validation logic.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/002_business_operations.sql
@.planning/phases/01.5-business-foundation/01.5-03-SUMMARY.md
@.planning/phases/04.5-marketing-booking/04.5-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create out-of-territory cost calculator</name>
  <files>
    web/lib/bookings/out-of-territory.ts
    supabase/migrations/022_out_of_territory_rules.sql
  </files>
  <action>
**web/lib/bookings/out-of-territory.ts** — Cost calculation logic:
```typescript
export interface TravelCalculation {
  distance_miles: number;
  travel_time_minutes: number;
  travel_cost: number; // £2/mile beyond 30 miles
  room_board_cost: number; // Flat rate if travel >2 hours
  recommended_option: 'travel_bonus' | 'room_board' | 'deny';
  total_cost: number;
  shift_value: number;
  cost_percentage: number; // cost / shift_value
}

// Business rules
const TRAVEL_BONUS_RATE = 2; // £2 per mile
const FREE_TRAVEL_MILES = 30; // First 30 miles are included
const ROOM_BOARD_FLAT_RATE = 150; // £150 for overnight accommodation
const TRAVEL_TIME_THRESHOLD = 120; // 2 hours = 120 minutes
const DENIAL_THRESHOLD = 0.5; // Deny if cost >50% of shift value

// Calculate travel bonus cost
export function calculateTravelBonus(distance_miles: number): number {
  const billable_miles = Math.max(0, distance_miles - FREE_TRAVEL_MILES);
  return Number((billable_miles * TRAVEL_BONUS_RATE).toFixed(2));
}

// Calculate room/board cost (flat rate)
export function calculateRoomBoard(travel_time_minutes: number): number {
  return travel_time_minutes > TRAVEL_TIME_THRESHOLD ? ROOM_BOARD_FLAT_RATE : 0;
}

// Determine if booking should be denied
export function shouldDenyBooking(cost: number, shift_value: number): boolean {
  return cost / shift_value > DENIAL_THRESHOLD;
}

// Calculate out-of-territory cost and recommend option
export function calculateOutOfTerritoryCost(
  distance_miles: number,
  travel_time_minutes: number,
  shift_value: number
): TravelCalculation {
  const travel_cost = calculateTravelBonus(distance_miles);
  const room_board_cost = calculateRoomBoard(travel_time_minutes);

  // Compare options
  let recommended_option: 'travel_bonus' | 'room_board' | 'deny';
  let total_cost: number;

  if (travel_cost === 0 && room_board_cost === 0) {
    // Within free travel zone
    recommended_option = 'travel_bonus';
    total_cost = 0;
  } else if (room_board_cost === 0) {
    // Travel <2 hours: only travel bonus applies
    recommended_option = 'travel_bonus';
    total_cost = travel_cost;
  } else {
    // Travel >2 hours: compare travel bonus vs room/board
    if (travel_cost < room_board_cost) {
      recommended_option = 'travel_bonus';
      total_cost = travel_cost;
    } else {
      recommended_option = 'room_board';
      total_cost = room_board_cost;
    }
  }

  const cost_percentage = shift_value > 0 ? total_cost / shift_value : 0;

  // Override recommendation if cost too high
  if (shouldDenyBooking(total_cost, shift_value)) {
    recommended_option = 'deny';
  }

  return {
    distance_miles,
    travel_time_minutes,
    travel_cost,
    room_board_cost,
    recommended_option,
    total_cost,
    shift_value,
    cost_percentage: Number((cost_percentage * 100).toFixed(2)), // Percentage
  };
}

// Format cost calculation for display
export function formatCostBreakdown(calc: TravelCalculation): string {
  const lines = [
    `Distance: ${calc.distance_miles} miles`,
    `Travel time: ${Math.round(calc.travel_time_minutes / 60)} hours ${calc.travel_time_minutes % 60} minutes`,
    ``,
    `Option 1: Travel Bonus`,
    `  Billable miles: ${Math.max(0, calc.distance_miles - FREE_TRAVEL_MILES)} miles × £${TRAVEL_BONUS_RATE}/mile = £${calc.travel_cost}`,
    ``,
  ];

  if (calc.room_board_cost > 0) {
    lines.push(
      `Option 2: Room & Board`,
      `  Overnight accommodation: £${calc.room_board_cost}`,
      ``
    );
  }

  lines.push(
    `Recommended: ${calc.recommended_option === 'deny' ? 'DENY BOOKING' : calc.recommended_option.replace('_', ' ').toUpperCase()}`,
    `Total cost: £${calc.total_cost}`,
    `Shift value: £${calc.shift_value}`,
    `Cost percentage: ${calc.cost_percentage}%`,
  );

  if (calc.recommended_option === 'deny') {
    lines.push(``, `⚠️ Cost exceeds 50% of shift value. Booking should be denied unless manually overridden by admin.`);
  }

  return lines.join('\n');
}
```

**supabase/migrations/022_out_of_territory_rules.sql** — Business rules:
```sql
-- Migration 022: Out-of-Territory Cost Rules
-- Business rules and thresholds for out-of-territory bookings

-- Out-of-territory cost settings table
CREATE TABLE IF NOT EXISTS out_of_territory_rules (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  rule_name TEXT NOT NULL UNIQUE,
  rule_value DECIMAL(10,2) NOT NULL,
  rule_description TEXT,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert default rules
INSERT INTO out_of_territory_rules (rule_name, rule_value, rule_description) VALUES
  ('travel_bonus_rate', 2.00, 'Travel bonus rate per mile beyond free zone (GBP)'),
  ('free_travel_miles', 30.00, 'First N miles are included in base rate'),
  ('room_board_flat_rate', 150.00, 'Flat rate for overnight accommodation (GBP)'),
  ('travel_time_threshold_minutes', 120.00, 'Travel time threshold for room/board option (minutes)'),
  ('denial_threshold_percent', 50.00, 'Auto-deny if cost exceeds this % of shift value'),
  ('admin_override_limit_percent', 75.00, 'Maximum % admin can override (hard limit)');

CREATE INDEX idx_out_of_territory_rules_name ON out_of_territory_rules(rule_name);

-- Function to get rule value
CREATE OR REPLACE FUNCTION get_out_of_territory_rule(p_rule_name TEXT)
RETURNS DECIMAL(10,2) AS $$
DECLARE
  v_value DECIMAL(10,2);
BEGIN
  SELECT rule_value INTO v_value
  FROM out_of_territory_rules
  WHERE rule_name = p_rule_name;

  RETURN COALESCE(v_value, 0);
END;
$$ LANGUAGE plpgsql;

COMMENT ON TABLE out_of_territory_rules IS 'Configurable business rules for out-of-territory cost calculations';
COMMENT ON FUNCTION get_out_of_territory_rule IS 'Retrieve rule value by name (returns 0 if not found)';
```
  </action>
  <verify>
Run: `ls web/lib/bookings/out-of-territory.ts` confirms calculator exists.
Run: `grep "calculateOutOfTerritoryCost" web/lib/bookings/out-of-territory.ts` confirms export.
Run: `ls supabase/migrations/022_out_of_territory_rules.sql` confirms migration.
Run: `grep "travel_bonus_rate" supabase/migrations/022_out_of_territory_rules.sql` confirms rules.
  </verify>
  <done>
Out-of-territory cost calculator compares travel bonus (£2/mile beyond 30 miles) vs room/board (£150 flat), recommends cheapest option, and flags for denial if cost >50% of shift value. Business rules stored in database for easy updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cost calculation API with Google Maps integration</name>
  <files>
    web/app/api/bookings/calculate-cost/route.ts
  </files>
  <action>
**web/app/api/bookings/calculate-cost/route.ts** — POST endpoint:
- Accept: `{ medicId: string, sitePostcode: string, shiftHours: number, baseRate: number }`
- Validate user is authenticated
- Fetch medic home_postcode from medics table
- Check travel_time_cache for existing result:
  ```sql
  SELECT * FROM travel_time_cache
  WHERE origin_postcode = medic.home_postcode
    AND destination_postcode = sitePostcode
    AND expires_at > NOW()
  LIMIT 1
  ```
- If cache miss: call Google Maps Distance Matrix API:
  ```typescript
  const response = await fetch(
    `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${medicPostcode}&destinations=${sitePostcode}&units=imperial&key=${GOOGLE_MAPS_API_KEY}`
  );
  const data = await response.json();

  const element = data.rows[0].elements[0];
  if (element.status !== 'OK') {
    return NextResponse.json({ error: 'Could not calculate route' }, { status: 400 });
  }

  const distance_miles = Number((element.distance.value / 1609.34).toFixed(2)); // meters to miles
  const travel_time_minutes = Math.round(element.duration.value / 60); // seconds to minutes

  // Cache result for 7 days
  await supabase.from('travel_time_cache').insert({
    origin_postcode: medicPostcode,
    destination_postcode: sitePostcode,
    travel_time_minutes,
    distance_miles,
    cached_at: new Date().toISOString(),
    expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
  });
  ```
- Calculate shift value: shiftHours * baseRate * 1.2 (VAT)
- Call calculateOutOfTerritoryCost(distance_miles, travel_time_minutes, shift_value)
- Return: `{ calculation: TravelCalculation, cached: boolean }`
- Error handling:
  - 400 if invalid postcode format
  - 500 if Google Maps API fails
  - Log API calls for cost monitoring
  </action>
  <verify>
Run: `ls web/app/api/bookings/calculate-cost/` confirms API route.
Run: `grep "maps.googleapis.com" web/app/api/bookings/calculate-cost/route.ts` confirms Google Maps.
Run: `grep "travel_time_cache" web/app/api/bookings/calculate-cost/route.ts` confirms caching.
Run: `grep "calculateOutOfTerritoryCost" web/app/api/bookings/calculate-cost/route.ts` confirms calculator.
  </verify>
  <done>
Cost calculation API integrates with Google Maps Distance Matrix API, caches results for 7 days, calculates travel bonus vs room/board, and returns recommendation with cost breakdown.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create out-of-territory UI components and admin approval</name>
  <files>
    web/components/bookings/out-of-territory-calculator.tsx
    web/components/admin/out-of-territory-approval.tsx
  </files>
  <action>
**web/components/bookings/out-of-territory-calculator.tsx** — 'use client' component:
- Props: `{ medicId: string, sitePostcode: string, shiftHours: number, baseRate: number, onCalculated: (result: TravelCalculation) => void }`
- State: loading, calculation, error
- Auto-fetch calculation on mount:
  - POST /api/bookings/calculate-cost
  - Display loading spinner during API call
- Display:
  - **Travel Details**:
    - Distance: {miles} miles
    - Travel time: {hours}h {minutes}m
    - Medic postcode → Site postcode
  - **Cost Comparison**:
    - Option 1: Travel Bonus
      - Billable miles: {distance - 30} miles
      - Rate: £2/mile
      - Total: £{cost}
    - Option 2: Room & Board (if applicable)
      - Overnight stay
      - Flat rate: £150
  - **Recommendation**:
    - Badge color: green (travel_bonus), blue (room_board), red (deny)
    - Text: "Travel bonus recommended" / "Room & board recommended" / "Booking should be denied"
  - **Cost Analysis**:
    - Total cost: £{total}
    - Shift value: £{shift_value}
    - Cost percentage: {percentage}%
    - Progress bar showing cost/value ratio
  - If deny recommended:
    - Warning box: "This booking exceeds the 50% cost threshold and should be denied. Admin override required."
- Call onCalculated(calculation) after successful fetch
- "Recalculate" button to refresh (clears cache)

**web/components/admin/out-of-territory-approval.tsx** — 'use client' component:
- Props: `{ bookingId: string }`
- Fetch booking with cost calculation data
- Display:
  - Booking details: site name, shift date, hours, total
  - Out-of-territory calculation: distance, travel time, cost breakdown
  - Recommendation: badge with color
  - Cost percentage: progress bar
- Admin actions:
  - **Approve** button:
    - If cost >50%: show confirmation dialog "Override denial recommendation?"
    - If cost >75%: block with error "Cost too high (admin override limit)"
    - Updates booking: SET status='confirmed', requires_manual_approval=FALSE, approved_by=admin_id, approved_at=NOW()
    - Updates booking: SET out_of_territory_cost=total_cost, out_of_territory_type=recommended_option
  - **Deny** button:
    - Show reason input
    - Updates booking: SET status='cancelled', cancellation_reason=reason, cancelled_by=admin_id
  - **Request More Info** button:
    - Opens modal with message composer
    - Sends email to client with questions
- Notes section: Admin can add internal notes
- Audit trail: Shows who created, who reviewed, approval/denial decision
  </action>
  <verify>
Run: `ls web/components/bookings/out-of-territory-calculator.tsx` confirms calculator component.
Run: `grep "travel_bonus.*room_board.*deny" web/components/bookings/out-of-territory-calculator.tsx` confirms options.
Run: `ls web/components/admin/out-of-territory-approval.tsx` confirms approval component.
Run: `grep "approved_by" web/components/admin/out-of-territory-approval.tsx` confirms admin tracking.
  </verify>
  <done>
Out-of-territory calculator component displays cost breakdown with travel bonus vs room/board comparison and denial recommendation. Admin approval component enforces thresholds, tracks approvals, and prevents override >75% cost.
  </done>
</task>

</tasks>

<verification>
1. Travel bonus calculation: £2/mile beyond 30 miles
2. Room/board option: £150 flat rate when travel >2 hours
3. Google Maps Distance Matrix API integration with 7-day caching
4. Cost comparison recommends cheapest option (travel_bonus or room_board)
5. Automatic denial recommendation when cost >50% of shift value
6. Admin can override 50-75% range but blocked at >75%
7. Out-of-territory calculator displays cost breakdown with progress bar
8. Admin approval component tracks approval decisions and reasons
9. Build passes with no TypeScript errors
</verification>

<success_criteria>
- Out-of-territory cost calculates travel bonus at £2/mile beyond 30 miles
- Room/board flat rate (£150) offered when travel time >2 hours
- System compares options and recommends cheaper one
- Booking flagged for denial if cost >50% of shift value
- Admin can see cost breakdown with distance, time, and recommendations
- Admin approval required for bookings >50% cost (up to 75% hard limit)
- Google Maps API results cached for 7 days to reduce costs
- Admin cannot override bookings >75% cost without escalation
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-05-SUMMARY.md`
</output>
