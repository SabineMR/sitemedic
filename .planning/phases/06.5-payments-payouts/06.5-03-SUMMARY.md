---
phase: 06.5-payments-payouts
plan: 03
subsystem: api
tags: [invoices, vat, react-pdf, deno, edge-functions, pg-cron, late-payment, resend, pdf-generation]

# Dependency graph
requires:
  - phase: 06.5-01
    provides: "Payment Intent API patterns and Stripe integration"
  - phase: 05-01
    provides: "@react-pdf/renderer 4.3.2 pattern with renderToBuffer in Deno Edge Functions"
  - phase: 04.6-02
    provides: "Contract PDF generation pattern with React-PDF components"
  - phase: 01.5
    provides: "Invoices, invoice_line_items, clients tables, invoice_number sequence"
provides:
  - "Invoice PDF generation with VAT (20%), Net 30 terms, and late payment fee display"
  - "Invoice generation API that creates invoice records with line items and triggers PDF generation"
  - "Late payment tracker component with color-coded overdue periods and reminder controls"
  - "Automated late payment reminder system with pg_cron (7/14/21 days)"
  - "UK statutory late fee calculator (£40/£70/£100 based on invoice amount)"
affects: [email-integration, admin-dashboard, payment-reconciliation, financial-reporting]

# Tech tracking
tech-stack:
  added: [@react-pdf/renderer for Edge Functions, pg_cron for scheduled reminders]
  patterns: [Invoice PDF generation in Edge Functions, late payment tracking with automated reminders, UK statutory late fees, pg_cron HTTP triggers]

key-files:
  created:
    - supabase/functions/generate-invoice-pdf/index.ts
    - supabase/functions/generate-invoice-pdf/components/InvoiceDocument.tsx
    - web/lib/invoices/late-fees.ts
    - web/app/api/invoices/generate/route.ts
    - web/app/api/invoices/send-reminder/route.ts
    - web/components/invoices/late-payment-tracker.tsx
    - supabase/migrations/022_late_payment_reminders.sql
  modified: []

key-decisions:
  - "Invoice PDFs generated in Edge Function and uploaded to Supabase Storage with 1-year signed URLs"
  - "Late fees follow UK Late Payment of Commercial Debts (Interest) Act 1998: £40 (<£1k), £70 (£1k-10k), £100 (£10k+)"
  - "Automated reminders at 7, 14, and 21 days overdue via pg_cron daily job at 10am GMT"
  - "Late fees applied automatically at 21 days overdue"
  - "Migration number 022 (not 020) to avoid conflict with existing RIDDOR deadline cron"
  - "Email sending currently logged (TODO for Resend integration)"

patterns-established:
  - "Invoice PDF template reuses React-PDF pattern from Phase 05-01 with professional UK formatting"
  - "Late payment tracker provides real-time overdue monitoring with auto-refresh"
  - "pg_cron uses HTTP POST to API endpoint for reminder sending (allows auth and business logic)"
  - "Color-coded severity: yellow (1-7 days), orange (8-14 days), red (15+ days overdue)"

# Metrics
duration: 9min
completed: 2026-02-16
---

# Phase 06.5 Plan 03: Invoice Generation with VAT Summary

**Invoice generation system with professional PDF formatting, VAT (20%), Net 30 payment terms, automated late payment reminders at 7/14/21 days, and UK statutory late fees**

## Performance

- **Duration:** 9 minutes
- **Started:** 2026-02-16T21:32:37Z
- **Completed:** 2026-02-16T21:42:26Z
- **Tasks:** 3
- **Files modified:** 7 created, 3 fixed (TypeScript errors)

## Accomplishments
- Professional invoice PDF generation with VAT breakdown and Net 30 payment terms
- Late payment tracker displays overdue invoices with color-coded severity and reminder controls
- Automated reminder system sends emails at 7, 14, and 21 days overdue via pg_cron
- UK statutory late fees calculated and applied automatically (£40/£70/£100 based on invoice amount)
- Invoice PDFs uploaded to Supabase Storage with signed URLs for client access

## Task Commits

Each task was committed atomically:

1. **Task 1: Create invoice PDF generator with VAT and Net 30 terms** - `b2a41ba` (feat)
   - Edge Function generates invoice PDFs from database records
   - React-PDF components with professional UK formatting
   - VAT (20%) and Net 30 payment terms display
   - PDF upload to Supabase Storage with signed URLs
   - UK late fee calculator library

2. **Task 2: Create invoice generation API and late payment tracker** - `95274c3` (feat)
   - Invoice generation API validates bookings and creates invoice with line items
   - Late payment tracker component with color-coded overdue periods (yellow/orange/red)
   - Auto-refresh every 60 seconds with filtering
   - Manual reminder sending and mark-as-paid controls

3. **Task 3: Create automated late payment reminder system** - `03fa205` (feat)
   - Reminder API sends emails at 7/14/21 day intervals
   - pg_cron migration for daily automated checks at 10am GMT
   - Escalation warnings and statutory late fee application at 21 days
   - Audit logging for all reminder events

4. **TypeScript error fixes** - `cc325ab` (fix)
   - Replaced deprecated @supabase/auth-helpers with @/lib/supabase/server and client
   - Fixed implicit any types in maps and reducers
   - Fixed error types in catch blocks
   - Removed duplicate web/lib/invoices/pdf-generator.ts (Edge Function version is canonical)

## Files Created/Modified

### Core Infrastructure
- `supabase/functions/generate-invoice-pdf/index.ts` - Edge Function for PDF generation (uploads to Storage)
- `supabase/functions/generate-invoice-pdf/components/InvoiceDocument.tsx` - React-PDF invoice template
- `web/lib/invoices/late-fees.ts` - UK statutory late fee calculator
- `supabase/migrations/022_late_payment_reminders.sql` - pg_cron job for automated reminders

### API Routes
- `web/app/api/invoices/generate/route.ts` - Invoice creation API with validation and PDF trigger
- `web/app/api/invoices/send-reminder/route.ts` - Late payment reminder API with email templates

### UI Components
- `web/components/invoices/late-payment-tracker.tsx` - Overdue invoice dashboard with color coding

## Decisions Made

**D-06.5-03-001: Invoice PDF generated in Edge Function**
- React-PDF rendering happens server-side in Deno Edge Function
- PDF uploaded to Supabase Storage with 1-year signed URL
- Follows pattern from Phase 05-01 (weekly safety reports) and 04.6-02 (contract PDFs)

**D-06.5-03-002: UK statutory late fees**
- £40 for invoices under £1,000
- £70 for invoices £1,000-£9,999
- £100 for invoices £10,000+
- Applied automatically at 21 days overdue
- Based on UK Late Payment of Commercial Debts (Interest) Act 1998

**D-06.5-03-003: Automated reminders via pg_cron**
- Daily job runs at 10am GMT
- Checks for invoices at exactly 7, 14, or 21 days overdue
- HTTP POST to reminder API endpoint (allows auth, validation, email sending)
- Partial indexes for optimized reminder queries

**D-06.5-03-004: Migration number 022 instead of 020**
- Discovered existing migration 020_riddor_deadline_cron.sql
- Renamed to 022 to avoid conflict and maintain chronological order

**D-06.5-03-005: Email sending currently logged**
- TODO: Integrate with Resend API for actual email delivery
- Email templates already drafted with payment instructions and escalation warnings
- Console logging in place for testing

**D-06.5-03-006: Color-coded severity in late payment tracker**
- Yellow: 1-7 days overdue (early warning)
- Orange: 8-14 days overdue (escalating)
- Red: 15+ days overdue (critical)
- Auto-refresh every 60 seconds for real-time monitoring

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed TypeScript errors blocking build**
- **Found during:** Final verification (Task completion)
- **Issue:** Invoice API routes used deprecated `@supabase/auth-helpers-nextjs` package causing TypeScript errors
- **Fix:**
  - Replaced `createRouteHandlerClient({ cookies })` with `createClient()` from `@/lib/supabase/server`
  - Replaced `createClientComponentClient()` with `createClient()` from `@/lib/supabase/client`
  - Fixed implicit `any` types in map/reduce callbacks
  - Fixed error types in catch blocks
- **Files modified:**
  - web/app/api/invoices/generate/route.ts
  - web/app/api/invoices/send-reminder/route.ts
  - web/components/invoices/late-payment-tracker.tsx
- **Verification:** `pnpm tsc --noEmit` passes with 0 invoice-related errors
- **Committed in:** cc325ab (separate fix commit)

**2. [Rule 3 - Blocking] Removed duplicate PDF generator file**
- **Found during:** TypeScript compilation
- **Issue:** Created `web/lib/invoices/pdf-generator.ts` in Task 1, but it uses JSX syntax in .ts file (not .tsx), causing 135+ syntax errors
- **Fix:** Removed duplicate file - Edge Function at `supabase/functions/generate-invoice-pdf/components/InvoiceDocument.tsx` is the canonical version
- **Files modified:** web/lib/invoices/pdf-generator.ts (deleted)
- **Verification:** Build errors resolved
- **Committed in:** cc325ab (fix commit)

**3. [Rule 3 - Blocking] Renamed migration to avoid conflict**
- **Found during:** File creation (Task 3)
- **Issue:** Created migration 020_late_payment_reminders.sql, but migration 020_riddor_deadline_cron.sql already exists
- **Fix:** Renamed to 022_late_payment_reminders.sql to maintain chronological order
- **Files modified:** supabase/migrations/022_late_payment_reminders.sql (renamed from 020)
- **Verification:** No migration number conflicts
- **Committed in:** b2a41ba (Task 1 commit - migration was created earlier than anticipated)

---

**Total deviations:** 3 auto-fixed (1 bug, 2 blocking)
**Impact on plan:** All auto-fixes necessary for build correctness and avoiding migration conflicts. No scope creep.

## Issues Encountered

**TypeScript compilation revealed import pattern mismatch:**
- Invoice API routes used old `@supabase/auth-helpers-nextjs` pattern
- Project uses newer `@/lib/supabase/server` and `@/lib/supabase/client` utilities
- Fixed by aligning with existing payment API patterns from Phase 06.5-01

**Duplicate PDF generator file:**
- Initially created PDF template in both `web/lib/invoices/` and Edge Function
- Edge Function version is canonical (uses Deno + npm: specifier)
- Removed web version to avoid JSX syntax errors in .ts file

## User Setup Required

**Edge Function deployment required.** To use invoice PDF generation:

1. Deploy Edge Function:
   ```bash
   supabase functions deploy generate-invoice-pdf
   ```

2. Configure pg_cron environment variables in Supabase dashboard:
   ```sql
   ALTER DATABASE postgres SET app.supabase_url = 'https://[project-ref].supabase.co';
   ALTER DATABASE postgres SET app.service_role_key = '[service-role-key]';
   ```

3. **TODO: Resend API integration**
   - Email sending currently logged to console
   - Need to integrate Resend API for actual email delivery
   - Email templates already drafted in reminder API

**No other external services required** - all dependencies internal to Supabase.

## Next Phase Readiness

**Ready for email integration:**
- Invoice generation creates PDFs and uploads to Storage
- Reminder system has email templates with payment instructions
- pg_cron automation triggers reminder API at correct intervals

**Ready for admin dashboard:**
- Late payment tracker component displays overdue invoices
- Manual reminder sending and mark-as-paid controls available
- Color-coded severity for quick visual assessment

**Ready for payment reconciliation:**
- Invoice status tracking (draft → sent → paid/overdue)
- Late fees tracked separately from original invoice amount
- Audit trail for all reminder events

**Potential enhancements:**
- Integrate Resend API for actual email sending (currently logged)
- Add bank transfer reconciliation for offline payments
- Generate monthly financial reports combining invoices and payouts

---
*Phase: 06.5-payments-payouts*
*Completed: 2026-02-16*
