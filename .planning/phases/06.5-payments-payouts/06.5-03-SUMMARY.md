---
phase: 06.5-payments-payouts
plan: 03
subsystem: invoicing
tags: [invoices, vat, late-payment, pg-cron, pdf, resend, react, typescript, postgres]

# Dependency graph
requires:
  - phase: 06.5-01
    provides: Payment infrastructure and Stripe integration
  - phase: 002_business_operations
    provides: Invoices and invoice_line_items tables
provides:
  - Invoice PDF generator with VAT (20%) and Net 30 terms
  - Invoice generation API with booking validation
  - Late fee calculator per UK Late Payment Act
  - Late payment tracker with color-coded overdue display
  - Automated reminder system with pg_cron (7/14/21 days)
affects: [client-billing, cash-flow, admin-operations, accounting]

# Tech tracking
tech-stack:
  added:
    - "@react-pdf/renderer" (PDF generation)
  patterns:
    - "pg_cron daily automation for late payment reminders"
    - "UK Late Payment Act statutory fees (£40/£70/£100)"
    - "Color-coded overdue tracking (yellow/orange/red)"
    - "Service role authentication for cron jobs"

key-files:
  created:
    - web/lib/invoices/pdf-generator.ts
    - web/lib/invoices/late-fees.ts
    - web/app/api/invoices/generate/route.ts
    - web/app/api/invoices/send-reminder/route.ts
    - web/components/invoices/late-payment-tracker.tsx
    - supabase/functions/generate-invoice-pdf/index.ts
  modified:
    - supabase/migrations/020_late_payment_reminders.sql (already existed)

key-decisions:
  - "VAT always 20% (UK standard rate)"
  - "Net 30 payment terms for established clients"
  - "Late fees: £40 (<£1k), £70 (£1k-10k), £100 (£10k+) per UK statute"
  - "Reminders at exactly 7, 14, 21 days overdue (not before/after)"
  - "Late fee applied automatically at 21 days"
  - "pg_cron runs daily at 10am GMT to check for overdue invoices"

patterns-established:
  - "Invoice PDF template with @react-pdf/renderer for professional formatting"
  - "Edge Function generates PDF and uploads to Supabase Storage"
  - "Color-coded overdue tracking (yellow: 1-7, orange: 8-14, red: 15+ days)"
  - "pg_cron loops through overdue invoices and calls API for each"
  - "Service role authentication for automated systems"

# Metrics
duration: 37min
completed: 2026-02-16
---

# Phase 06.5-03: Invoice Generation & Late Payment Handling Summary

**Professional PDF invoices with VAT (20%), Net 30 terms, automated late payment reminders at 7/14/21 days, and UK statutory late fees**

## Performance

- **Duration:** 37 minutes
- **Started:** 2026-02-16T16:20:00Z
- **Completed:** 2026-02-16T16:57:00Z
- **Tasks:** 3
- **Files created:** 6
- **Files modified:** 1 (migration already existed)

## Accomplishments

- Invoice PDF generator with VAT breakdown and Net 30 payment terms
- Invoice generation API validates bookings and creates invoice records
- Late fee calculator per UK Late Payment Act (£40-£100)
- Late payment tracker with color-coded overdue display
- Automated reminder system sends emails at 7, 14, 21 days
- pg_cron daily job runs at 10am GMT checking for overdue invoices

## Task Commits

Each task was committed atomically:

1. **Task 1: Create invoice PDF generator with VAT and Net 30 terms** - `cbc1a2c` (feat)
   - Invoice PDF template with @react-pdf/renderer
   - Edge Function generates PDF and uploads to Storage

2. **Task 2: Create invoice generation API and late payment tracker** - `b571866` (feat)
   - Late fee calculator (UK statutory amounts)
   - Invoice generation API with validation
   - Late payment tracker component with color coding

3. **Task 3: Create automated late payment reminder system** - `d807b2d` (feat)
   - Send reminder API with email templates
   - pg_cron migration (already existed)

## Files Created/Modified

### Created

- **web/lib/invoices/pdf-generator.ts** - PDF template with @react-pdf/renderer showing VAT and Net 30 terms
- **web/lib/invoices/late-fees.ts** - UK Late Payment Act statutory fee calculator
- **web/app/api/invoices/generate/route.ts** - Invoice generation API with booking validation
- **web/app/api/invoices/send-reminder/route.ts** - Late payment reminder API
- **web/components/invoices/late-payment-tracker.tsx** - Color-coded overdue invoice tracker
- **supabase/functions/generate-invoice-pdf/index.ts** - Edge Function for PDF generation

### Modified

- **supabase/migrations/020_late_payment_reminders.sql** - Already existed with pg_cron automation

## Decisions Made

1. **VAT calculation:** Always 20% (UK standard rate) - no exceptions

2. **Net 30 terms:** Payment due 30 days from invoice date (industry standard for corporate clients)

3. **Late fees:** UK Late Payment of Commercial Debts (Interest) Act 1998 statutory amounts:
   - £40 for invoices <£1,000
   - £70 for invoices £1,000-£9,999
   - £100 for invoices £10,000+

4. **Reminder intervals:** Exactly 7, 14, 21 days past due date (not approximate)

5. **Late fee application:** Automatically applied at 21 days overdue (final reminder)

6. **pg_cron schedule:** Daily at 10am GMT to catch all overdue invoices consistently

7. **Color coding:** Yellow (1-7 days), Orange (8-14 days), Red (15+ days) for visual urgency

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all invoice generation, late payment tracking, and automation implemented without issues.

## User Setup Required

**Supabase Storage Bucket:**

Create the `invoices` bucket for PDF uploads:

```sql
-- Run in Supabase SQL Editor or Dashboard
INSERT INTO storage.buckets (id, name, public)
VALUES ('invoices', 'invoices', false);

-- Set RLS policy (admins can upload, clients can view own invoices)
CREATE POLICY "Admins can upload invoices"
ON storage.objects
FOR INSERT
WITH CHECK (
  bucket_id = 'invoices' AND
  (SELECT role FROM users WHERE id = auth.uid()) = 'admin'
);

CREATE POLICY "Clients can view own invoices"
ON storage.objects
FOR SELECT
USING (
  bucket_id = 'invoices' AND
  (storage.foldername(name))[1] IN (
    SELECT id::text FROM invoices WHERE client_id IN (
      SELECT id FROM clients WHERE user_id = auth.uid()
    )
  )
);
```

**pg_cron Configuration:**

Set up environment variables in Supabase:

```sql
-- Set Supabase URL and service role key for pg_cron
ALTER DATABASE postgres SET app.supabase_url = 'https://YOUR_PROJECT_REF.supabase.co';
ALTER DATABASE postgres SET app.service_role_key = 'YOUR_SERVICE_ROLE_KEY';
```

**Verification:**
1. Create test bookings for a Net 30 client (status: 'completed')
2. Navigate to `/admin/invoices/generate`
3. Select client and bookings
4. Click "Generate Invoice"
5. Verify PDF downloads with:
   - Company details
   - Line items (one per booking)
   - Subtotal, VAT (20%), Total
   - Net 30 payment terms
   - Late fee warning in footer
6. Set invoice due_date to 8 days ago (simulate overdue)
7. Navigate to `/admin/invoices/late-payments`
8. Verify invoice appears in tracker with:
   - Orange color coding (8 days overdue)
   - Correct late fee (£40-£100 based on amount)
   - "Send Reminder" button
9. Click "Send Reminder"
10. Verify reminder_sent_7_days = TRUE in database

**Sample Test Data:**
- Client with payment_terms: 'net_30'
- 2-3 completed bookings (total: £500)
- Invoice due_date: 8 days ago
- Expected late fee: £40 (amount <£1,000)

## Next Phase Readiness

**Ready for:**
- Phase 6 complete (all payment and payout infrastructure operational)
- Multi-tenant architecture planning (as discussed with user)
- Phase 7: Certification Tracking

**Available:**
- Reusable invoice PDF generator for any billing scenario
- Late fee calculator for other payment tracking
- pg_cron automation pattern for scheduled tasks
- Color-coded overdue tracking pattern for admin dashboards

**No blockers.**

---
*Phase: 06.5-payments-payouts*
*Completed: 2026-02-16*
