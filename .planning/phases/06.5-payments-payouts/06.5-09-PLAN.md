---
phase: 06.5-payments-payouts
plan: 09
type: execute
wave: 2
depends_on: ["06.5-06"]
files_modified:
  - web/app/api/stripe/webhooks/route.ts
  - supabase/functions/friday-payout/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Stripe account.updated webhook captured and medic onboarding status synced to database"
    - "Friday payout Edge Function validates medic Express account has GB bank capability before transfer"
    - "Payouts blocked for medics without completed Stripe onboarding"
  artifacts:
    - path: "web/app/api/stripe/webhooks/route.ts"
      provides: "Handler for account.updated event updating medic onboarding status"
      contains: "account.updated"
    - path: "supabase/functions/friday-payout/index.ts"
      provides: "GB bank account validation before Stripe Transfer"
      contains: "country.*GB"
  key_links:
    - from: "web/app/api/stripe/webhooks/route.ts"
      to: "medics table"
      via: "UPDATE medics SET stripe_onboarding_complete"
      pattern: "stripe_onboarding_complete"
    - from: "supabase/functions/friday-payout/index.ts"
      to: "Stripe Account API"
      via: "stripe.accounts.retrieve()"
      pattern: "accounts\\.retrieve"
---

<objective>
Add Stripe onboarding webhook handler and GB bank account validation for payouts.

Purpose: There is no webhook to capture `account.updated` events from Stripe, meaning medic onboarding completion is never recorded in the database. The friday-payout Edge Function does not verify the medic's Stripe Express account is a GB account before attempting transfers. Without GB validation, transfers to non-GB accounts will fail at the Stripe API level.

Output: Stripe webhook handler for `account.updated` events and GB bank account validation in the payout Edge Function.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.5-payments-payouts/06.5-02-SUMMARY.md
@.planning/phases/06.5-payments-payouts/06.5-04-SUMMARY.md
@.planning/phases/06.5-payments-payouts/06.5-VERIFICATION.md
@web/app/api/stripe/webhooks/route.ts
@supabase/functions/friday-payout/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add account.updated webhook handler to Stripe webhooks</name>
  <files>web/app/api/stripe/webhooks/route.ts</files>
  <action>
  The existing webhook handler at `web/app/api/stripe/webhooks/route.ts` handles:
  - `payment_intent.succeeded`
  - `payment_intent.payment_failed`

  Add a new case to the switch statement for `account.updated`:

  ```typescript
  case 'account.updated': {
    const account = event.data.object as Stripe.Account;

    if (!account.id) {
      console.error('account.updated missing account ID');
      return NextResponse.json({ received: true });
    }

    console.log(`Stripe account updated: ${account.id}`);

    // Check if this is a Connected account (medic Express account)
    const chargesEnabled = account.charges_enabled;
    const payoutsEnabled = account.payouts_enabled;
    const detailsSubmitted = account.details_submitted;
    const onboardingComplete = chargesEnabled && payoutsEnabled && detailsSubmitted;

    // Find medic by stripe_account_id and update onboarding status
    const { error: updateError } = await supabase
      .from('medics')
      .update({
        stripe_onboarding_complete: onboardingComplete,
      })
      .eq('stripe_account_id', account.id);

    if (updateError) {
      console.error('Error updating medic onboarding status:', updateError);
    } else {
      console.log(
        `Medic Stripe onboarding ${onboardingComplete ? 'completed' : 'in progress'} for account ${account.id} (charges: ${chargesEnabled}, payouts: ${payoutsEnabled}, details: ${detailsSubmitted})`
      );
    }

    break;
  }
  ```

  Place this new case AFTER the `payment_intent.payment_failed` case and BEFORE the `default` case.

  Also update the file header comment to include the new event type:
  ```
  * Handles:
  * - payment_intent.succeeded: Update booking from 'pending' to 'confirmed'
  * - payment_intent.payment_failed: Update booking to 'cancelled'
  * - account.updated: Sync medic Stripe Express onboarding status
  ```

  Do NOT change the existing payment_intent handlers. Only add the new case.
  </action>
  <verify>
  `grep "account.updated" web/app/api/stripe/webhooks/route.ts` returns match.
  `grep "stripe_onboarding_complete" web/app/api/stripe/webhooks/route.ts` returns match.
  `grep "charges_enabled" web/app/api/stripe/webhooks/route.ts` returns match.
  `cd /Users/sabineresoagli/GitHub/sitemedic && pnpm tsc --noEmit 2>&1 | grep "webhooks" || echo "No type errors"`
  </verify>
  <done>
  - Webhook handler processes `account.updated` events
  - Updates medic `stripe_onboarding_complete` based on charges_enabled AND payouts_enabled AND details_submitted
  - Existing payment_intent handlers unchanged
  - File compiles without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GB bank account validation to Friday payout Edge Function</name>
  <files>supabase/functions/friday-payout/index.ts</files>
  <action>
  In `supabase/functions/friday-payout/index.ts`, add account country validation AFTER the existing stripe_onboarding_complete check (line 133-143) and BEFORE the payout amount validation (line 146).

  Add this validation block:

  ```typescript
  // Validate medic account is GB (required for UK Faster Payments)
  try {
    const account = await stripe.accounts.retrieve(medic.stripe_account_id);

    if (account.country !== 'GB') {
      console.warn(
        `Timesheet ${timesheet.id}: Medic ${medicName} account country is ${account.country}, not GB`
      );
      failedCount++;
      errors.push({
        timesheetId: timesheet.id,
        error: `Stripe account country is ${account.country} (expected GB for UK Faster Payments)`,
        medic: medicName,
      });
      continue;
    }

    // Also verify payouts are actually enabled on the account
    if (!account.payouts_enabled) {
      console.warn(
        `Timesheet ${timesheet.id}: Medic ${medicName} payouts not enabled on Stripe account`
      );
      failedCount++;
      errors.push({
        timesheetId: timesheet.id,
        error: 'Stripe account payouts not enabled',
        medic: medicName,
      });
      continue;
    }
  } catch (accountError: any) {
    console.error(
      `Timesheet ${timesheet.id}: Failed to retrieve Stripe account for ${medicName}:`,
      accountError.message
    );
    failedCount++;
    errors.push({
      timesheetId: timesheet.id,
      error: `Failed to verify Stripe account: ${accountError.message}`,
      medic: medicName,
    });
    continue;
  }
  ```

  NOTE: This plan depends on Plan 06 having already updated the percentage from 60% to 71.4%. If executing after Plan 06, the payout validation at line 147 should already reference 71.4%. If Plan 06 has not run yet, this plan should still add the GB validation -- the percentage fix is independent.

  Do NOT change the Stripe Transfer creation logic, timesheet query, or response structure. Only add the account validation step.
  </action>
  <verify>
  `grep "accounts.retrieve" supabase/functions/friday-payout/index.ts` returns match.
  `grep "country.*GB" supabase/functions/friday-payout/index.ts` returns match.
  `grep "payouts_enabled" supabase/functions/friday-payout/index.ts` returns match.
  </verify>
  <done>
  - Friday payout Edge Function retrieves Stripe account before transfer
  - Validates account.country === 'GB' (required for UK Faster Payments)
  - Validates account.payouts_enabled === true
  - Non-GB or payouts-disabled accounts logged as errors and skipped
  - Other payouts continue processing (batch resilience pattern preserved)
  </done>
</task>

</tasks>

<verification>
- Webhook handler at `web/app/api/stripe/webhooks/route.ts` has 3 cases: payment_intent.succeeded, payment_intent.payment_failed, account.updated
- Edge Function at `supabase/functions/friday-payout/index.ts` calls stripe.accounts.retrieve() before stripe.transfers.create()
- Both files compile (pnpm tsc --noEmit)
</verification>

<success_criteria>
1. account.updated webhook syncs medic onboarding status to database (charges_enabled + payouts_enabled + details_submitted)
2. Friday payout validates GB country and payouts_enabled before transfer
3. Non-GB accounts are gracefully skipped with error logging
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-09-SUMMARY.md`
</output>
