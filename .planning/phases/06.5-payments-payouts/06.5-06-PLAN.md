---
phase: 06.5-payments-payouts
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - web/lib/payouts/calculator.ts
  - supabase/functions/friday-payout/index.ts
  - supabase/migrations/020_late_payment_reminders.sql
  - supabase/migrations/021_friday_payout_cron.sql
  - supabase/migrations/021_payslip_generation.sql
  - supabase/migrations/023_late_payment_reminders.sql
  - supabase/migrations/024_friday_payout_cron.sql
  - supabase/migrations/025_payslip_generation.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Platform fee calculation matches roadmap: medic 71.4%, platform 28.6% (medic GBP30/hr, client GBP42/hr)"
    - "Migration numbers are unique and sequential (no duplicate 020 or 021)"
    - "Friday payout Edge Function validates payout at 71.4% not 60%"
  artifacts:
    - path: "web/lib/payouts/calculator.ts"
      provides: "Correct 71.4/28.6 payout split"
      contains: "71.4"
    - path: "supabase/functions/friday-payout/index.ts"
      provides: "Payout validation using correct percentage"
      contains: "71.4"
    - path: "supabase/migrations/023_late_payment_reminders.sql"
      provides: "Renumbered migration (was 020)"
    - path: "supabase/migrations/024_friday_payout_cron.sql"
      provides: "Renumbered migration (was 021)"
    - path: "supabase/migrations/025_payslip_generation.sql"
      provides: "Renumbered migration (was 021)"
  key_links:
    - from: "web/lib/payouts/calculator.ts"
      to: "supabase/functions/friday-payout/index.ts"
      via: "Same percentage used in both"
      pattern: "71\\.4"
---

<objective>
Fix platform fee calculation to match roadmap specification and resolve migration numbering conflicts.

Purpose: The payout calculator uses 60/40 split but roadmap specifies medic GBP30/hr, client GBP42/hr = 71.4% medic, 28.6% platform. This arithmetic mismatch causes revenue loss. Additionally, duplicate migration numbers (two 020s and two 021s) will cause deployment failures.

Output: Corrected payout calculator, updated Edge Function validation, and sequentially renumbered migrations (023, 024, 025).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.5-payments-payouts/06.5-02-SUMMARY.md
@.planning/phases/06.5-payments-payouts/06.5-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix platform fee calculation to 71.4/28.6 split</name>
  <files>web/lib/payouts/calculator.ts, supabase/functions/friday-payout/index.ts</files>
  <action>
  Update `web/lib/payouts/calculator.ts`:

  1. Change the header comment block to reflect correct arithmetic:
     - Medic rate: GBP30/hr
     - Client rate: GBP42/hr
     - Platform fee: GBP12/hr (GBP42 - GBP30 = GBP12)
     - Medic percentage: 30/42 = 71.43% (round to 71.4%)
     - Platform percentage: 12/42 = 28.57% (round to 28.6%)

  2. In `calculatePayout()` function (lines 26-27), change:
     - `const medicPercentage = 60;` -> `const medicPercentage = 71.4;`
     - `const platformPercentage = 40;` -> `const platformPercentage = 28.6;`

  3. Update `calculatePlatformFee()` (line 48): change `40` to `28.6`

  4. Update `validatePayout()` comment (line 57): change "60%" to "71.4%"

  5. In `PayoutCalculation` interface comments (lines 15-16):
     - `medicPercentage: number; // Should be 60%` -> `// Should be 71.4%`
     - `platformPercentage: number; // Should be 40%` -> `// Should be 28.6%`

  Then update `supabase/functions/friday-payout/index.ts`:

  6. Line 147: change `(booking.total * 60) / 100` to `(booking.total * 71.4) / 100`

  7. Line 150: update the tolerance check comment to reference 71.4%

  Do NOT change anything else in the Edge Function. Only fix the percentage arithmetic.
  </action>
  <verify>
  Search both files for "60" and "40" percentage references -- should find none related to payout split.
  Search both files for "71.4" -- should find the correct percentage in both files.
  Run: `cd /Users/sabineresoagli/GitHub/sitemedic && pnpm tsc --noEmit 2>&1 | grep -i "calculator\|payout" || echo "No type errors"`
  </verify>
  <done>
  - calculator.ts uses medicPercentage=71.4, platformPercentage=28.6
  - friday-payout/index.ts validates payout at 71.4% of booking total
  - Both files compile without TypeScript errors
  - Example: GBP336 booking -> medic receives GBP239.90 (71.4%), platform keeps GBP96.10 (28.6%)
  </done>
</task>

<task type="auto">
  <name>Task 2: Renumber conflicting migrations to sequential order</name>
  <files>
    supabase/migrations/020_late_payment_reminders.sql,
    supabase/migrations/021_friday_payout_cron.sql,
    supabase/migrations/021_payslip_generation.sql,
    supabase/migrations/023_late_payment_reminders.sql,
    supabase/migrations/024_friday_payout_cron.sql,
    supabase/migrations/025_payslip_generation.sql
  </files>
  <action>
  Current state has conflicts:
  - 020_riddor_deadline_cron.sql (Phase 6, keep as-is)
  - 020_late_payment_reminders.sql (Phase 6.5, CONFLICT)
  - 021_friday_payout_cron.sql (Phase 6.5, CONFLICT)
  - 021_payslip_generation.sql (Phase 6.5, CONFLICT)
  - 022_out_of_territory_rules.sql (Phase 6.5, keep as-is -- already unique)

  NOTE: The summary for 06.5-03 says migration was already renamed to 022_late_payment_reminders.sql, but the actual file on disk is still 020_late_payment_reminders.sql. Trust the filesystem.

  Renumber by:
  1. Rename `020_late_payment_reminders.sql` to `023_late_payment_reminders.sql`
     - Update the header comment inside the file: "Migration 020" -> "Migration 023"
  2. Rename `021_friday_payout_cron.sql` to `024_friday_payout_cron.sql`
     - Update the header comment: "Migration 021" -> "Migration 024"
  3. Rename `021_payslip_generation.sql` to `025_payslip_generation.sql`
     - Update the header comment: "Migration 021" -> "Migration 025"

  Use `git mv` for the rename to preserve git history.

  Final migration order should be:
  - 018_riddor_incidents.sql
  - 019_riddor_reports_storage.sql
  - 020_riddor_deadline_cron.sql
  - 022_out_of_territory_rules.sql
  - 023_late_payment_reminders.sql
  - 024_friday_payout_cron.sql
  - 025_payslip_generation.sql

  Do NOT change the content of the SQL beyond the header comment number update.
  </action>
  <verify>
  `ls /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/ | sort` -- verify no duplicate numbers.
  Confirm 020_late_payment_reminders.sql no longer exists.
  Confirm 021_friday_payout_cron.sql no longer exists.
  Confirm 021_payslip_generation.sql no longer exists.
  Confirm 023, 024, 025 files exist with correct content.
  </verify>
  <done>
  - No duplicate migration numbers in supabase/migrations/
  - Sequential order: 018 -> 019 -> 020 -> 022 -> 023 -> 024 -> 025
  - Header comments in renamed files reference correct migration number
  - Git tracks renames properly (git mv used)
  </done>
</task>

</tasks>

<verification>
- `grep -r "medicPercentage = 71.4" /Users/sabineresoagli/GitHub/sitemedic/web/lib/payouts/calculator.ts` returns match
- `grep -r "71.4" /Users/sabineresoagli/GitHub/sitemedic/supabase/functions/friday-payout/index.ts` returns match
- No duplicate migration numbers: `ls supabase/migrations/ | sed 's/_.*//' | sort | uniq -d` returns empty
- `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
1. Platform fee split is 71.4% medic / 28.6% platform in calculator and Edge Function
2. No duplicate migration numbers exist
3. All files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-06-SUMMARY.md`
</output>
