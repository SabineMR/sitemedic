---
phase: 06.5-payments-payouts
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - web/lib/payouts/calculator.ts
  - supabase/functions/friday-payout/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Platform fee calculation matches roadmap: medic 71.4%, platform 28.6% (medic GBP30/hr, client GBP42/hr)"
    - "Friday payout Edge Function validates payout at 71.4% not 60%"
  artifacts:
    - path: "web/lib/payouts/calculator.ts"
      provides: "Correct 71.4/28.6 payout split"
      contains: "71.4"
    - path: "supabase/functions/friday-payout/index.ts"
      provides: "Payout validation using correct percentage"
      contains: "71.4"
  key_links:
    - from: "web/lib/payouts/calculator.ts"
      to: "supabase/functions/friday-payout/index.ts"
      via: "Same percentage used in both"
      pattern: "71\\.4"
---

<objective>
Fix platform fee calculation to match roadmap specification.

Purpose: The payout calculator uses 60/40 split but roadmap specifies medic GBP30/hr, client GBP42/hr = 71.4% medic, 28.6% platform. This arithmetic mismatch causes revenue loss.

Output: Corrected payout calculator and updated Edge Function validation with correct percentages.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.5-payments-payouts/06.5-02-SUMMARY.md
@.planning/phases/06.5-payments-payouts/06.5-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix platform fee calculation to 71.4/28.6 split</name>
  <files>web/lib/payouts/calculator.ts, supabase/functions/friday-payout/index.ts</files>
  <action>
  Update `web/lib/payouts/calculator.ts`:

  1. Change the header comment block to reflect correct arithmetic:
     - Medic rate: GBP30/hr
     - Client rate: GBP42/hr
     - Platform fee: GBP12/hr (GBP42 - GBP30 = GBP12)
     - Medic percentage: 30/42 = 71.43% (round to 71.4%)
     - Platform percentage: 12/42 = 28.57% (round to 28.6%)

  2. In `calculatePayout()` function (lines 26-27), change:
     - `const medicPercentage = 60;` -> `const medicPercentage = 71.4;`
     - `const platformPercentage = 40;` -> `const platformPercentage = 28.6;`

  3. Update `calculatePlatformFee()` (line 48): change `40` to `28.6`

  4. Update `validatePayout()` comment (line 57): change "60%" to "71.4%"

  5. In `PayoutCalculation` interface comments (lines 15-16):
     - `medicPercentage: number; // Should be 60%` -> `// Should be 71.4%`
     - `platformPercentage: number; // Should be 40%` -> `// Should be 28.6%`

  Then update `supabase/functions/friday-payout/index.ts`:

  6. Line 147: change `(booking.total * 60) / 100` to `(booking.total * 71.4) / 100`

  7. Line 150: update the tolerance check comment to reference 71.4%

  Do NOT change anything else in the Edge Function. Only fix the percentage arithmetic.
  </action>
  <verify>
  Search both files for "60" and "40" percentage references -- should find none related to payout split.
  Search both files for "71.4" -- should find the correct percentage in both files.
  Run: `cd /Users/sabineresoagli/GitHub/sitemedic && pnpm tsc --noEmit 2>&1 | grep -i "calculator\|payout" || echo "No type errors"`
  </verify>
  <done>
  - calculator.ts uses medicPercentage=71.4, platformPercentage=28.6
  - friday-payout/index.ts validates payout at 71.4% of booking total
  - Both files compile without TypeScript errors
  - Example: GBP336 booking -> medic receives GBP239.90 (71.4%), platform keeps GBP96.10 (28.6%)
  </done>
</task>

</tasks>

<verification>
- `grep -r "medicPercentage = 71.4" /Users/sabineresoagli/GitHub/sitemedic/web/lib/payouts/calculator.ts` returns match
- `grep -r "71.4" /Users/sabineresoagli/GitHub/sitemedic/supabase/functions/friday-payout/index.ts` returns match
- `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
1. Platform fee split is 71.4% medic / 28.6% platform in calculator and Edge Function
2. All files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-06-SUMMARY.md`
</output>
