---
phase: 06.5-payments-payouts
plan: 04
subsystem: compliance
tags: [ir35, stripe, payslips, onboarding, utr, cest, react, typescript, postgres]

# Dependency graph
requires:
  - phase: 01.5-business-foundation
    provides: Stripe Connect Edge Function, medics table with IR35 fields
  - phase: 06.5-02
    provides: Payout infrastructure and timesheets workflow
provides:
  - IR35 validator with UTR format validation and CEST assessment
  - IR35 form component for employment status collection
  - Stripe Express account onboarding integration
  - Automatic payslip generation on payout completion
  - Admin medic onboarding page with compliance checklist
affects: [medic-onboarding, payroll, compliance, admin-operations]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "UTR validation (10-digit UK tax reference)"
    - "Database trigger auto-generates payslips on payout"
    - "Stripe Express account creation via Edge Function"
    - "Auto-refresh status component (30-second polling)"

key-files:
  created:
    - web/lib/medics/ir35-validator.ts
    - web/components/medics/ir35-form.tsx
    - web/app/api/medics/ir35-assessment/route.ts
    - web/components/medics/stripe-onboarding-status.tsx
    - web/app/(dashboard)/admin/medics/onboarding/[id]/page.tsx
  modified:
    - supabase/migrations/024_payslip_generation.sql (renamed from 021)

key-decisions:
  - "UTR must be exactly 10 digits (UK HMRC format)"
  - "CEST assessment recommended but not strictly required (encouragement only)"
  - "Stripe Express account created automatically when IR35 form submitted"
  - "Payslips auto-generate when timesheet.payout_status = 'paid'"
  - "£0 deductions for self-employed (medic handles own tax)"
  - "Auto-refresh Stripe status every 30 seconds until complete"

patterns-established:
  - "IR35 validator returns errors array for inline display"
  - "Stripe onboarding status component with three states (not started, in progress, complete)"
  - "Admin onboarding page uses checklist pattern for completion tracking"
  - "Database trigger pattern for automatic record creation"

# Metrics
duration: 20min
completed: 2026-02-16
---

# Phase 06.5-04: IR35 Compliance & Medic Onboarding Summary

**IR35 compliance system with employment status validation, Stripe Express onboarding, CEST assessment collection, UTR validation, and automatic payslip generation**

## Performance

- **Duration:** 20 minutes
- **Started:** 2026-02-16T16:00:00Z
- **Completed:** 2026-02-16T16:20:00Z
- **Tasks:** 3
- **Files created:** 5
- **Files modified:** 1 (renamed migration)

## Accomplishments

- IR35 validator with UTR format validation (10 digits) and completeness checking
- IR35 form collects employment status, UTR, CEST assessment with file upload
- Stripe Express account onboarding integration with auto-refresh status
- Automatic payslip generation via database trigger
- Admin medic onboarding page with 5-item compliance checklist

## Task Commits

Each task was committed atomically:

1. **Task 1: Create IR35 validator and employment status form** - `ca51522` (feat)
   - IR35 validator library with UTR validation
   - IR35 form component with employment status radio buttons
   - CEST assessment upload to Supabase Storage

2. **Task 2: Create Stripe onboarding integration and IR35 API** - `4e1d2e9` (feat)
   - IR35 assessment API endpoint
   - Stripe onboarding status component with three states
   - Auto-refresh every 30 seconds

3. **Task 3: Create payslip generator and admin onboarding page** - `e26e436` (feat)
   - Payslips table with auto-generation trigger
   - Admin onboarding page with compliance checklist
   - Payslip history table

## Files Created/Modified

### Created

- **web/lib/medics/ir35-validator.ts** - IR35 validation logic with UTR format checker
- **web/components/medics/ir35-form.tsx** - React form for employment status collection
- **web/app/api/medics/ir35-assessment/route.ts** - API endpoint to save IR35 data
- **web/components/medics/stripe-onboarding-status.tsx** - Stripe onboarding progress display
- **web/app/(dashboard)/admin/medics/onboarding/[id]/page.tsx** - Admin onboarding page with checklist

### Modified

- **supabase/migrations/024_payslip_generation.sql** - Renamed from 021 to avoid conflict (already existed from previous session)

## Decisions Made

1. **UTR validation:** Exactly 10 digits required (UK HMRC format standard)

2. **CEST assessment:** Strongly recommended but not blocking (encourages compliance without forcing)

3. **Stripe account creation:** Automatically triggered when IR35 form submitted (simplifies workflow)

4. **Payslip auto-generation:** Database trigger fires when timesheet.payout_status changes to 'paid' (zero manual admin work)

5. **Self-employed deductions:** £0 tax and NI deductions (medic responsible for Self Assessment tax return)

6. **Stripe status polling:** Auto-refresh every 30 seconds until onboarding complete (UX optimization)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**Migration numbering conflict:**
- Found two 021 migrations (friday_payout_cron and payslip_generation)
- Resolved: payslip_generation already renamed to 024 in previous session

## User Setup Required

**Supabase Storage Bucket:**

Create the `ir35-assessments` bucket for CEST PDF uploads:

```sql
-- Run in Supabase SQL Editor or Dashboard
INSERT INTO storage.buckets (id, name, public)
VALUES ('ir35-assessments', 'ir35-assessments', false);

-- Set RLS policy (admin and medic can upload their own CEST PDFs)
CREATE POLICY "Medics can upload own CEST PDFs"
ON storage.objects
FOR INSERT
WITH CHECK (
  bucket_id = 'ir35-assessments' AND
  auth.uid() = (SELECT user_id FROM medics WHERE id::text = (storage.foldername(name))[1])
);

CREATE POLICY "Admins can view all CEST PDFs"
ON storage.objects
FOR SELECT
USING (
  bucket_id = 'ir35-assessments' AND
  (SELECT role FROM users WHERE id = auth.uid()) = 'admin'
);
```

**Verification:**
1. Navigate to `/admin/medics/onboarding/[medic-id]` as admin
2. Complete IR35 form:
   - Select "Self-Employed Contractor"
   - Enter 10-digit UTR (e.g., "1234567890")
   - Select CEST result (Outside IR35)
   - Upload CEST PDF (optional)
   - Submit form
3. Verify Stripe onboarding status changes to "In Progress"
4. Click "Continue Onboarding" and complete Stripe flow
5. Return to page, verify status shows "Complete" with green checkmark
6. Verify checklist shows all 5 items as complete

**Sample Test Data:**
- UTR: "1234567890" (valid 10-digit format)
- CEST Result: "Outside IR35"
- Umbrella Company: "PayStream" or "Giant Group"

## Next Phase Readiness

**Ready for:**
- Phase 06.5-03: Invoice generation with VAT and late payment handling (only remaining plan)
- Weekly medic payouts (payslips auto-generate on payout)
- IR35 compliance reporting and auditing

**Available:**
- Reusable IR35 validator for any employment status checking
- Stripe onboarding patterns for other account types
- Database trigger pattern for automatic record creation
- Admin checklist UI pattern for multi-step completion tracking

**No blockers.**

---
*Phase: 06.5-payments-payouts*
*Completed: 2026-02-16*
