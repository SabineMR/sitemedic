---
phase: 06.5-payments-payouts
plan: 04
subsystem: payments
tags: [ir35, stripe-express, payslips, hmrc, cest, utr, tax-compliance, supabase-storage]

# Dependency graph
requires:
  - phase: 06.5-02
    provides: Stripe Connect Edge Function with Express account creation
  - phase: 01.5-business-foundation
    provides: Medics table with IR35 fields and Stripe account columns
provides:
  - IR35 compliance system with employment status collection
  - Stripe Express account onboarding flow for medic payouts
  - CEST assessment upload to Supabase Storage
  - Automated payslip generation on timesheet payout
  - Admin medic onboarding dashboard with approval workflow
affects: [payouts, accounting, tax-reporting, medic-onboarding]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "IR35 validation with employment status (self_employed vs umbrella)"
    - "Stripe Express account creation via Edge Function invocation"
    - "Auto-refresh pattern for Stripe onboarding status checking"
    - "Database trigger for automated payslip generation"

key-files:
  created:
    - web/lib/medics/ir35-validator.ts
    - web/components/medics/ir35-form.tsx
    - web/app/api/medics/ir35-assessment/route.ts
    - web/components/medics/stripe-onboarding-status.tsx
    - supabase/migrations/021_payslip_generation.sql
    - web/app/(dashboard)/admin/medics/onboarding/[id]/page.tsx
  modified: []

key-decisions:
  - "Self-employed medics: no tax deductions (£0), medic handles own taxes"
  - "Umbrella company: payouts to company account, company handles deductions"
  - "UTR validation: 10-digit format with optional spaces"
  - "CEST assessment: recommended but not strictly required"
  - "Auto-refresh Stripe status every 30 seconds until onboarding complete"
  - "Payslip generation: triggered on timesheet.payout_status = 'paid'"

patterns-established:
  - "IR35 validator pattern: validateIR35Status returns { valid, errors[] }"
  - "Employment status radio buttons with conditional form fields"
  - "CEST assessment: PDF upload to ir35-assessments/ bucket OR manual entry"
  - "Stripe onboarding status: 3 states (not started, in progress, complete)"
  - "Admin onboarding checklist: visual progress with CheckCircle/XCircle icons"

# Metrics
duration: 5min
completed: 2026-02-16
---

# Phase 06.5 Plan 04: IR35 Compliance Summary

**IR35 compliance with medic employment status, UTR validation, CEST assessment upload, Stripe Express onboarding, and automated payslip generation on payout**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-16T21:32:35Z
- **Completed:** 2026-02-16T21:37:46Z
- **Tasks:** 3
- **Files modified:** 6

## Accomplishments
- IR35 assessment form collects employment status (self-employed or umbrella company)
- UTR validation for 10-digit format with self-employed contractors
- CEST assessment upload to Supabase Storage with manual result entry option
- Stripe Express account creation and onboarding flow with auto-refresh status
- Automated payslip generation via database trigger when payout completes
- Admin medic onboarding page with approval checklist and payslip history

## Task Commits

Each task was committed atomically:

1. **Task 1: Create IR35 validator and assessment form** - `b8825a7` (feat)
2. **Task 2: Create Stripe onboarding integration and IR35 API** - `87671a6` (feat)
3. **Task 3: Create payslip generator and onboarding page** - `50be84b` (feat)

## Files Created/Modified

- `web/lib/medics/ir35-validator.ts` - IR35 validation logic, UTR format check, employment status validation
- `web/components/medics/ir35-form.tsx` - Client form for IR35 assessment with employment status, UTR, CEST upload
- `web/app/api/medics/ir35-assessment/route.ts` - POST endpoint to save IR35 data and create Stripe Express account
- `web/components/medics/stripe-onboarding-status.tsx` - Component showing Stripe onboarding progress with 30s auto-refresh
- `supabase/migrations/021_payslip_generation.sql` - Payslips table with trigger on timesheet payout
- `web/app/(dashboard)/admin/medics/onboarding/[id]/page.tsx` - Admin page with onboarding checklist and approval workflow

## Decisions Made

1. **Self-employed tax handling:** No deductions (£0 tax, £0 NI) - medic responsible for own taxes
   - Rationale: Self-employed contractors manage their own tax obligations to HMRC

2. **CEST assessment: recommended but optional**
   - Rationale: Strongly encouraged for IR35 compliance but not legally required to process payouts

3. **UTR validation: 10-digit format only**
   - Rationale: HMRC UTR is always 10 digits, validation prevents input errors

4. **Stripe onboarding auto-refresh: 30 seconds**
   - Rationale: Balance between responsiveness and API rate limits

5. **Payslip trigger: timesheet.payout_status = 'paid'**
   - Rationale: Auto-generate payslip record immediately when payout completes

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required beyond existing Stripe integration.

## Next Phase Readiness

- IR35 compliance system complete and ready for medic onboarding
- Stripe Express accounts can be created for all medics
- Payslips auto-generate on timesheet payout completion
- Admin can approve medics for work after completing onboarding checklist
- Ready for Phase 6.5-05: Payout batch processing

**Blockers:** None

**Concerns:**
- CEST assessment is recommended but not enforced - admins should verify compliance manually
- Payslip PDF generation (pdf_url field) not implemented in this phase - will be added in future enhancement

---
*Phase: 06.5-payments-payouts*
*Completed: 2026-02-16*
