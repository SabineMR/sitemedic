---
phase: 06.5-payments-payouts
plan: 03
type: execute
wave: 2
depends_on: ["06.5-01"]
files_modified:
  - supabase/functions/generate-invoice-pdf/index.ts
  - supabase/migrations/020_late_payment_reminders.sql
  - web/app/api/invoices/generate/route.ts
  - web/app/api/invoices/send-reminder/route.ts
  - web/lib/invoices/pdf-generator.ts
  - web/components/invoices/invoice-viewer.tsx
  - web/components/invoices/late-payment-tracker.tsx
autonomous: true

must_haves:
  truths:
    - "Invoice PDF generated with VAT (20%) and Net 30 terms for established clients"
    - "Late payment auto-reminders send at 7, 14, 21 days with statutory late fees (40-100)"
    - "Invoice line items show individual bookings with hours and rates"
    - "Invoice status tracks sent, paid, overdue states"
    - "Late fees calculated per UK Late Payment Act: £40 (<£1000), £70 (£1000-9999), £100 (£10k+)"
  artifacts:
    - path: "supabase/functions/generate-invoice-pdf/index.ts"
      provides: "Edge Function for PDF invoice generation with @react-pdf/renderer"
      exports: ["serve"]
    - path: "web/lib/invoices/pdf-generator.ts"
      provides: "Invoice PDF template with VAT and Net 30 terms"
      exports: ["InvoiceDocument", "generateInvoicePDF"]
    - path: "web/app/api/invoices/generate/route.ts"
      provides: "API endpoint for invoice creation and PDF generation"
      exports: ["POST"]
    - path: "web/app/api/invoices/send-reminder/route.ts"
      provides: "API endpoint for late payment reminders"
      exports: ["POST"]
    - path: "supabase/migrations/020_late_payment_reminders.sql"
      provides: "pg_cron job for automatic late payment reminders"
      exports: []
  key_links:
    - from: "supabase/functions/generate-invoice-pdf/index.ts"
      to: "invoices table"
      via: "queries invoice with line items"
      pattern: "invoices.*invoice_line_items"
    - from: "web/app/api/invoices/send-reminder/route.ts"
      to: "Resend email API"
      via: "sends reminder email to client"
      pattern: "resend.emails.send"
    - from: "supabase/migrations/020_late_payment_reminders.sql"
      to: "web/app/api/invoices/send-reminder"
      via: "triggers reminder at 7/14/21 day intervals"
      pattern: "http_post"
---

<objective>
Create invoice generation system with PDF formatting, VAT calculation, Net 30 payment terms, late payment tracking, and automated reminders with statutory late fees.

Purpose: For Net 30 clients, the system generates professional PDF invoices with line items (bookings), VAT (20%), and 30-day payment terms. Late payments trigger automatic reminders at 7, 14, and 21 days overdue with statutory late fees (£40-100 based on invoice amount). Invoices are stored in Supabase Storage and sent via email.

Output: Invoice PDF generator, late payment reminder system with pg_cron, admin invoice dashboard, and email templates.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/002_business_operations.sql
@supabase/migrations/004_invoice_sequence.sql
@.planning/phases/05-pdf-generation/05-01-SUMMARY.md
@.planning/phases/04.6-customer-onboarding-contract-management/04.6-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invoice PDF generator with VAT and Net 30 terms</name>
  <files>
    web/lib/invoices/pdf-generator.ts
    supabase/functions/generate-invoice-pdf/index.ts
  </files>
  <action>
**web/lib/invoices/pdf-generator.ts** — PDF template with @react-pdf/renderer:
```typescript
import { Document, Page, Text, View, StyleSheet } from '@react-pdf/renderer';

export interface InvoiceData {
  invoice_number: string;
  invoice_date: string;
  due_date: string;
  client: {
    company_name: string;
    billing_address: string;
    billing_postcode: string;
    vat_number: string | null;
  };
  line_items: Array<{
    description: string;
    quantity: number; // hours
    unit_price: number;
    amount: number;
  }>;
  subtotal: number;
  vat: number; // 20%
  total: number;
  payment_terms: 'prepay' | 'net_30';
  late_fee_charged: number;
}

const styles = StyleSheet.create({
  page: { padding: 40, fontSize: 10, fontFamily: 'Helvetica' },
  header: { marginBottom: 20 },
  title: { fontSize: 24, fontWeight: 'bold' },
  invoiceNumber: { fontSize: 12, color: '#666', marginTop: 5 },
  section: { marginTop: 15, marginBottom: 15 },
  sectionTitle: { fontSize: 12, fontWeight: 'bold', marginBottom: 10 },
  row: { flexDirection: 'row', borderBottomWidth: 1, borderBottomColor: '#e5e7eb', paddingVertical: 8 },
  column: { flex: 1 },
  textRight: { textAlign: 'right' },
  textBold: { fontWeight: 'bold' },
  total: { fontSize: 14, fontWeight: 'bold', backgroundColor: '#f3f4f6', padding: 10, marginTop: 10 },
  footer: { marginTop: 30, fontSize: 9, color: '#666' },
});

export const InvoiceDocument = ({ data }: { data: InvoiceData }) => (
  <Document>
    <Page size="A4" style={styles.page}>
      {/* Header */}
      <View style={styles.header}>
        <Text style={styles.title}>INVOICE</Text>
        <Text style={styles.invoiceNumber}>{data.invoice_number}</Text>
      </View>

      {/* Bill To */}
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Bill To:</Text>
        <Text>{data.client.company_name}</Text>
        <Text>{data.client.billing_address}</Text>
        <Text>{data.client.billing_postcode}</Text>
        {data.client.vat_number && <Text>VAT: {data.client.vat_number}</Text>}
      </View>

      {/* Invoice Details */}
      <View style={styles.section}>
        <View style={styles.row}>
          <Text style={styles.column}>Invoice Date:</Text>
          <Text style={[styles.column, styles.textRight]}>{data.invoice_date}</Text>
        </View>
        <View style={styles.row}>
          <Text style={styles.column}>Due Date:</Text>
          <Text style={[styles.column, styles.textRight]}>{data.due_date}</Text>
        </View>
        <View style={styles.row}>
          <Text style={styles.column}>Payment Terms:</Text>
          <Text style={[styles.column, styles.textRight]}>
            {data.payment_terms === 'net_30' ? 'Net 30' : 'Prepay'}
          </Text>
        </View>
      </View>

      {/* Line Items */}
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Services</Text>
        <View style={[styles.row, styles.textBold]}>
          <Text style={[styles.column, { flex: 3 }]}>Description</Text>
          <Text style={styles.column}>Hours</Text>
          <Text style={[styles.column, styles.textRight]}>Rate</Text>
          <Text style={[styles.column, styles.textRight]}>Amount</Text>
        </View>
        {data.line_items.map((item, idx) => (
          <View key={idx} style={styles.row}>
            <Text style={[styles.column, { flex: 3 }]}>{item.description}</Text>
            <Text style={styles.column}>{item.quantity}</Text>
            <Text style={[styles.column, styles.textRight]}>£{item.unit_price.toFixed(2)}</Text>
            <Text style={[styles.column, styles.textRight]}>£{item.amount.toFixed(2)}</Text>
          </View>
        ))}
      </View>

      {/* Totals */}
      <View style={[styles.section, { alignItems: 'flex-end' }]}>
        <View style={{ width: '50%' }}>
          <View style={styles.row}>
            <Text style={styles.column}>Subtotal:</Text>
            <Text style={[styles.column, styles.textRight]}>£{data.subtotal.toFixed(2)}</Text>
          </View>
          <View style={styles.row}>
            <Text style={styles.column}>VAT (20%):</Text>
            <Text style={[styles.column, styles.textRight]}>£{data.vat.toFixed(2)}</Text>
          </View>
          {data.late_fee_charged > 0 && (
            <View style={styles.row}>
              <Text style={styles.column}>Late Payment Fee:</Text>
              <Text style={[styles.column, styles.textRight]}>£{data.late_fee_charged.toFixed(2)}</Text>
            </View>
          )}
          <View style={[styles.row, styles.total]}>
            <Text style={[styles.column, styles.textBold]}>Total Due:</Text>
            <Text style={[styles.column, styles.textRight, styles.textBold]}>
              £{(data.total + data.late_fee_charged).toFixed(2)}
            </Text>
          </View>
        </View>
      </View>

      {/* Footer */}
      <View style={styles.footer}>
        <Text>Payment is due within 30 days of invoice date.</Text>
        <Text>Late payments subject to statutory late fees under the Late Payment of Commercial Debts (Interest) Act 1998.</Text>
        <Text>Bank details: Sort Code 12-34-56, Account 12345678</Text>
      </View>
    </Page>
  </Document>
);

export async function generateInvoicePDF(data: InvoiceData): Promise<Buffer> {
  const { renderToBuffer } = await import('@react-pdf/renderer');
  return renderToBuffer(<InvoiceDocument data={data} />);
}
```

**supabase/functions/generate-invoice-pdf/index.ts** — Edge Function:
- Accept POST: `{ invoiceId: string }`
- Query invoice with client and line_items joins
- Format data for InvoiceDocument
- Generate PDF buffer using @react-pdf/renderer
- Upload to Supabase Storage: `invoices/{invoice_number}.pdf`
- Update invoices table: SET pdf_url = signed URL, status = 'sent', sent_at = NOW()
- Return: `{ pdf_url, invoice_number }`
  </action>
  <verify>
Run: `ls web/lib/invoices/pdf-generator.ts` confirms PDF template exists.
Run: `grep "@react-pdf/renderer" web/lib/invoices/pdf-generator.ts` confirms library import.
Run: `ls supabase/functions/generate-invoice-pdf/index.ts` confirms Edge Function.
Run: `grep "VAT.*20" web/lib/invoices/pdf-generator.ts` confirms VAT display.
  </verify>
  <done>
Invoice PDF generator creates professional invoices with company details, line items, VAT (20%), Net 30 terms, and late fee display. Edge Function uploads PDF to Storage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create invoice generation API and late payment tracker</name>
  <files>
    web/app/api/invoices/generate/route.ts
    web/lib/invoices/late-fees.ts
    web/components/invoices/late-payment-tracker.tsx
  </files>
  <action>
**web/lib/invoices/late-fees.ts** — UK statutory late fee calculator:
```typescript
// UK Late Payment of Commercial Debts (Interest) Act 1998
export function calculateLateFee(invoiceAmount: number): number {
  if (invoiceAmount < 1000) return 40;
  if (invoiceAmount < 10000) return 70;
  return 100;
}

export function calculateLateFeeWithInterest(
  invoiceAmount: number,
  daysOverdue: number
): { lateFee: number; interest: number; total: number } {
  const lateFee = calculateLateFee(invoiceAmount);

  // Bank of England base rate + 8% (simplified calculation)
  const annualRate = 0.08; // 8% for example
  const dailyRate = annualRate / 365;
  const interest = invoiceAmount * dailyRate * daysOverdue;

  return {
    lateFee,
    interest: Number(interest.toFixed(2)),
    total: Number((lateFee + interest).toFixed(2)),
  };
}
```

**web/app/api/invoices/generate/route.ts** — POST endpoint:
- Accept: `{ clientId: string, bookingIds: string[], invoiceDate?: string }`
- Validate user is authenticated and is admin
- Fetch client details
- Fetch bookings and validate:
  - All bookings belong to client
  - All bookings have status 'completed'
  - No bookings already invoiced
- Calculate totals:
  - Subtotal = sum of booking totals (excluding VAT)
  - VAT = subtotal * 0.20
  - Total = subtotal + VAT
- Generate invoice_number (using sequence from migration 004)
- Insert invoice record:
  ```typescript
  {
    invoice_number,
    client_id: clientId,
    subtotal,
    vat,
    total,
    invoice_date: invoiceDate || today,
    due_date: invoiceDate + 30 days,
    payment_terms: client.payment_terms,
    status: 'draft',
  }
  ```
- Insert invoice_line_items for each booking:
  ```typescript
  {
    invoice_id,
    booking_id,
    description: `Medic service - ${booking.site_name} on ${booking.shift_date}`,
    quantity: booking.shift_hours,
    unit_price: booking.total / booking.shift_hours,
    amount: booking.total,
  }
  ```
- Call supabase.functions.invoke('generate-invoice-pdf', { invoiceId })
- Send invoice email to client via Resend
- Return: `{ invoice, pdf_url }`

**web/components/invoices/late-payment-tracker.tsx** — 'use client' component:
- Display invoices with status 'sent' past due_date
- For each overdue invoice:
  - Days overdue count (today - due_date)
  - Last reminder sent (7, 14, or 21 days)
  - Late fee amount (calculated)
  - "Send Reminder" button
  - "Mark as Paid" button
- Color coding:
  - 1-7 days: yellow
  - 8-14 days: orange
  - 15+ days: red
- Auto-refresh every 60 seconds
- Filter by client, date range, overdue bracket
  </action>
  <verify>
Run: `ls web/app/api/invoices/generate/route.ts` confirms generation API.
Run: `ls web/lib/invoices/late-fees.ts` confirms late fee calculator.
Run: `grep "calculateLateFee" web/lib/invoices/late-fees.ts` confirms export.
Run: `ls web/components/invoices/late-payment-tracker.tsx` confirms tracker component.
Run: `grep "overdue" web/components/invoices/late-payment-tracker.tsx` confirms filtering.
  </verify>
  <done>
Invoice generation API creates invoice records with line items, triggers PDF generation, and sends email. Late payment tracker displays overdue invoices with statutory late fees and reminder controls.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create automated late payment reminder system</name>
  <files>
    web/app/api/invoices/send-reminder/route.ts
    supabase/migrations/020_late_payment_reminders.sql
  </files>
  <action>
**web/app/api/invoices/send-reminder/route.ts** — POST endpoint:
- Accept: `{ invoiceId: string, reminderType: '7_days' | '14_days' | '21_days' }`
- Validate user is admin or automated system
- Fetch invoice with client details
- Calculate days overdue: today - due_date
- Validate reminder hasn't already been sent for this interval
- Calculate late fee (£40-100 based on amount)
- Send reminder email via Resend:
  - Subject: "Payment Reminder: Invoice {number} - {days} days overdue"
  - Body template with:
    - Invoice number and original amount
    - Days overdue
    - Late fee notice (statutory amount)
    - Payment instructions
    - Escalation warning (if 21+ days)
- Update invoice:
  - SET reminder_sent_{7|14|21}_days = TRUE
  - If 21+ days and not already charged: SET late_fee_charged = calculateLateFee(total)
  - SET status = 'overdue' if not already
- Log reminder event in audit trail
- Return: `{ success: true, email_sent: true, late_fee_applied: number }`

**supabase/migrations/020_late_payment_reminders.sql** — pg_cron automation:
```sql
-- Migration 020: Late Payment Reminder Cron Jobs
-- Automated reminders at 7, 14, 21 days overdue

CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Daily check for overdue invoices (runs at 10am GMT)
SELECT cron.schedule(
  'check-overdue-invoices-daily',
  '0 10 * * *',
  $$
  -- Find invoices needing 7-day reminder
  SELECT net.http_post(
    url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/send-invoice-reminder',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.service_role_key')
    ),
    body := jsonb_build_object(
      'reminder_type', '7_days',
      'invoice_ids', (
        SELECT json_agg(id)
        FROM invoices
        WHERE status = 'sent'
          AND due_date = CURRENT_DATE - INTERVAL '7 days'
          AND reminder_sent_7_days = FALSE
      )
    )
  );

  -- Find invoices needing 14-day reminder
  SELECT net.http_post(
    url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/send-invoice-reminder',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.service_role_key')
    ),
    body := jsonb_build_object(
      'reminder_type', '14_days',
      'invoice_ids', (
        SELECT json_agg(id)
        FROM invoices
        WHERE status IN ('sent', 'overdue')
          AND due_date = CURRENT_DATE - INTERVAL '14 days'
          AND reminder_sent_14_days = FALSE
      )
    )
  );

  -- Find invoices needing 21-day reminder (with late fee)
  SELECT net.http_post(
    url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/send-invoice-reminder',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.service_role_key')
    ),
    body := jsonb_build_object(
      'reminder_type', '21_days',
      'invoice_ids', (
        SELECT json_agg(id)
        FROM invoices
        WHERE status IN ('sent', 'overdue')
          AND due_date = CURRENT_DATE - INTERVAL '21 days'
          AND reminder_sent_21_days = FALSE
      )
    )
  );
  $$
);

COMMENT ON SCHEMA cron IS 'Late payment reminder automation - runs daily at 10am GMT';
```
  </action>
  <verify>
Run: `ls web/app/api/invoices/send-reminder/route.ts` confirms reminder API.
Run: `grep "late_fee_charged" web/app/api/invoices/send-reminder/route.ts` confirms late fee logic.
Run: `ls supabase/migrations/020_late_payment_reminders.sql` confirms migration.
Run: `grep "7 days\\|14 days\\|21 days" supabase/migrations/020_late_payment_reminders.sql` confirms intervals.
  </verify>
  <done>
Late payment reminder API sends emails at 7/14/21 day intervals with statutory late fees. pg_cron job runs daily to check for overdue invoices and trigger reminders automatically.
  </done>
</task>

</tasks>

<verification>
1. Invoice PDF includes company details, line items, VAT (20%), Net 30 terms
2. Late fees calculated per UK statute: £40 (<£1k), £70 (£1k-10k), £100 (£10k+)
3. Late payment reminders send automatically at 7, 14, 21 days overdue
4. pg_cron job runs daily to check for overdue invoices
5. Invoice status tracks sent, paid, overdue states
6. Admin dashboard shows late payment tracker with color coding
7. Late fees applied at 21 days overdue
8. Build passes with no TypeScript errors
</verification>

<success_criteria>
- Invoice PDF generated with VAT breakdown and Net 30 payment terms
- Line items show individual bookings with hours and client rates
- Late payment reminders send at 7, 14, 21 days with statutory fees
- Late fees calculated correctly: £40, £70, or £100 based on invoice amount
- Invoice status updates to 'overdue' when past due date
- Admin can view late payment tracker with days overdue and late fees
- Email templates professional and include payment instructions
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-03-SUMMARY.md`
</output>
