---
phase: 06.5
plan: 12
subsystem: payments
tags: [resend, email, late-payment, invoices, gap-closure]

dependency-graph:
  requires: [06.5-07]
  provides: ["Late payment email reminders via Resend"]
  affects: [06.5-VERIFICATION]

tech-stack:
  added: []
  patterns: ["Email error resilience pattern"]

key-files:
  created: []
  modified:
    - web/app/api/invoices/send-reminder/route.ts

decisions:
  - id: email-non-blocking
    choice: Email failures do not block invoice status updates
    rationale: Invoice state changes are critical business logic; email is a notification enhancement
    alternatives: ["Block on email failure", "Retry email failures"]

metrics:
  duration: 3.5 min
  completed: 2026-02-17
---

# Phase 6.5 Plan 12: Late Payment Email Reminders (Gap Closure) Summary

**One-liner:** Restored Resend email integration for late payment reminders with HTML templates and graceful error handling.

## What Was Built

Re-integrated Resend email sending into the late payment reminder endpoint that was accidentally reverted in commit d807b2d. The endpoint now sends professional HTML emails to clients when invoices are 7, 14, or 21 days overdue.

**Key functionality:**
- HTML email template with SiteMedic navy branding (#003366)
- Invoice details table with overdue days highlighted in red
- Yellow warning box citing UK Late Payment of Commercial Debts (Interest) Act 1998
- Red escalation warning for 21+ day overdue invoices
- Text fallback for email clients that don't render HTML
- Graceful error handling: email failures logged but don't block invoice updates

## Tasks Completed

| Task | Description | Commit | Files Modified |
|------|-------------|--------|----------------|
| 1 | Re-add Resend email integration to late payment reminder endpoint | 7395774 | `web/app/api/invoices/send-reminder/route.ts` |

**Total:** 1/1 tasks (100%)

## Technical Implementation

### Email Integration Pattern

```typescript
// Import Resend client
import { resend } from '@/lib/email/resend';

// Send email with error handling
let emailError: any = null;
try {
  const { data: emailResult, error } = await resend.emails.send({
    from: 'SiteMedic Accounts <accounts@sitemedic.co.uk>',
    to: invoice.client.contact_email,
    subject: emailSubject,
    html: `<div style="...">...</div>`,
    text: emailBody,
  });

  emailError = error;

  if (emailError) {
    console.error('Failed to send reminder email:', emailError);
    // Continue processing -- email failure should NOT block invoice update
  }
} catch (error) {
  console.error('Email send exception:', error);
  emailError = error;
  // Continue processing
}

// Response reflects actual send status
return NextResponse.json({
  success: true,
  email_sent: !emailError,
  late_fee_applied: reminderType === '21_days' ? lateFee : 0,
});
```

### HTML Email Template Features

1. **Navy header** (#003366) with SiteMedic branding
2. **Invoice details table** with alternating row styles
3. **Late fee row** (conditional, only shown if > 0)
4. **Yellow warning box** citing statutory late payment law
5. **Red escalation warning** for 21+ day reminders
6. **Payment instructions** with bank details and reference
7. **Footer** with company contact info

### Error Resilience

**Decision:** Email failures do NOT block invoice status updates.

**Rationale:**
- Invoice state changes are critical business logic
- Email is a notification enhancement, not a requirement
- Network issues, API downtime, or email bounces should not prevent proper invoice tracking
- Errors are logged for monitoring, but processing continues

**Pattern established:**
```typescript
if (emailError) {
  console.error('Failed to send reminder email:', emailError);
  // Continue processing -- email failure should NOT block invoice update
}
```

This pattern is consistent with the booking confirmation email endpoint (`web/app/api/email/booking-confirmation/route.ts`).

## Deviations from Plan

None - plan executed exactly as written.

## Decisions Made

### 1. Email Non-Blocking Error Handling

**Decision:** Email send failures are logged but do not prevent invoice status updates.

**Context:** The late payment reminder endpoint performs two operations:
1. Send email notification to client
2. Update invoice status/late fee in database

**Chosen approach:** Graceful degradation - log email errors, continue with invoice update, return accurate `email_sent: !emailError` in response.

**Alternatives considered:**
- **Block on email failure:** Would prevent invoice state updates if Resend API is down - unacceptable for critical business logic
- **Retry email failures:** Adds complexity and latency; can be added later if needed

**Rationale:** Invoice status tracking is core financial data and must not depend on third-party email service availability. Clients can be notified manually if email fails.

**Impact:** Production-ready resilience pattern; monitoring can track `email_sent: false` responses.

## Files Changed

### Modified
- **web/app/api/invoices/send-reminder/route.ts** (71 insertions, 15 deletions)
  - Added Resend import
  - Replaced TODO stub with actual `resend.emails.send()` call
  - Built HTML email template with SiteMedic branding
  - Added graceful error handling (try/catch + error logging)
  - Fixed `email_sent` response field to reflect actual send status
  - Removed console.log stubs

## Verification Results

All verification checks passed:

1. ✅ **Import present:** `import { resend } from '@/lib/email/resend'` at line 4
2. ✅ **Send call present:** `resend.emails.send()` at line 111
3. ✅ **TODO removed:** No TODO comments remaining
4. ✅ **No false positive:** `email_sent: true` hardcoded value removed
5. ✅ **Dynamic response:** `email_sent: !emailError` at line 186
6. ✅ **Graceful error handling:** Error handling comments at lines 150, 157

**Note:** Pre-existing build error in `app/admin/timesheets/page.tsx` is unrelated to this plan's changes.

## Integration Points

### Dependencies
- **Requires:** `06.5-07` (Resend email client and dev mode fallback)
- **Uses:** `@/lib/email/resend` (Resend client with graceful fallback when RESEND_API_KEY not set)

### Provides
- **Late payment email reminders** with professional HTML templates
- **Accurate email status reporting** in API responses
- **Error resilience pattern** for email operations

### Affects
- **06.5-VERIFICATION** - Closes Truth #6: "Late payment auto-reminders send emails to clients via Resend"

## Next Phase Readiness

**Status:** Phase 6.5 is now 100% complete (12/12 must-haves verified).

**Blockers:** None

**Concerns:** None

**What's next:**
- Phase 6.5 verification complete - all 12 must-haves passing
- Ready for Phase 7 (next phase in roadmap)

## Notes

### Git History Context

This plan restores functionality that was accidentally lost:

- **Commit d8b6278:** Original Resend integration added to late payment reminders
- **Commit d807b2d:** Subsequent changes accidentally reverted the email sending
- **This plan (commit 7395774):** Restores email sending with improvements from both commits

### Dev Mode Support

The Resend client (`@/lib/email/resend.ts`) includes dev mode fallback:
- When `RESEND_API_KEY` is not set, emails are logged to console instead of sent
- Allows local testing without Resend account
- Production environments must set `RESEND_API_KEY` for actual email delivery

### Email Template Consistency

The HTML template follows the same branding and structure as other SiteMedic emails:
- Navy header (#003366)
- Light gray body (#f9fafb)
- Professional table layout
- Clear call-to-action (payment instructions)
- Company contact info in footer

Consistent with booking confirmation emails and other customer communications.

---

**Summary:** Gap closure plan successfully restored late payment email functionality. All 1 task completed in 3.5 minutes. Phase 6.5 is now fully verified and production-ready.
