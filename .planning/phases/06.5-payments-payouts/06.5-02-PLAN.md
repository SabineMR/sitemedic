---
phase: 06.5-payments-payouts
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/friday-payout/index.ts
  - supabase/migrations/019_friday_payout_cron.sql
  - web/app/api/payouts/process-batch/route.ts
  - web/app/api/payouts/calculate-weekly/route.ts
  - web/lib/payouts/calculator.ts
  - web/components/admin/payout-summary.tsx
autonomous: true

must_haves:
  truths:
    - "Friday payout job runs automatically (zero failures, every Friday at 9am)"
    - "Medics receive funds within 2 business days via UK Faster Payments"
    - "Platform fee calculation correct (medic 30/hr -> client 42/hr -> platform 12/hr)"
    - "Payout only processes for timesheets with status 'admin_approved'"
    - "Failed payouts logged with error details and flagged for manual review"
  artifacts:
    - path: "supabase/functions/friday-payout/index.ts"
      provides: "Edge Function for automated weekly medic payouts"
      exports: ["serve"]
    - path: "supabase/migrations/019_friday_payout_cron.sql"
      provides: "pg_cron job for Friday 9am payout execution"
      exports: []
    - path: "web/lib/payouts/calculator.ts"
      provides: "Payout calculation logic with platform fee split"
      exports: ["calculatePayout", "calculatePlatformFee"]
    - path: "web/app/api/payouts/process-batch/route.ts"
      provides: "API endpoint for batch payout processing"
      exports: ["POST"]
    - path: "web/components/admin/payout-summary.tsx"
      provides: "Admin dashboard component showing weekly payout summary"
      contains: "PayoutSummary"
  key_links:
    - from: "supabase/functions/friday-payout/index.ts"
      to: "timesheets table"
      via: "queries timesheets with status='admin_approved'"
      pattern: "timesheets.*admin_approved"
    - from: "supabase/functions/friday-payout/index.ts"
      to: "Stripe Transfer API"
      via: "creates Stripe Transfer to medic Express account"
      pattern: "stripe.transfers.create"
    - from: "supabase/migrations/019_friday_payout_cron.sql"
      to: "supabase/functions/friday-payout"
      via: "invokes Edge Function every Friday at 9am"
      pattern: "net.http_post"
---

<objective>
Create automated Friday payout system with pg_cron scheduler, Stripe Transfer API for UK Faster Payments, payout calculation logic, and admin monitoring dashboard.

Purpose: Every Friday at 9am, the system automatically processes all admin-approved timesheets from the previous week. It calculates medic payouts (60% of booking revenue), creates Stripe Transfers to medic Express accounts (UK Faster Payments), updates timesheet status to 'paid', and logs all transactions. Failed payouts are flagged for manual review.

Output: Edge Function for payout processing, pg_cron job for scheduling, payout calculator, admin API routes, and monitoring dashboard.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/002_business_operations.sql
@supabase/functions/stripe-connect/index.ts
@supabase/functions/_shared/stripe.ts
@.planning/phases/01.5-business-foundation/01.5-02-SUMMARY.md
@.planning/phases/05.5-admin-operations/05.5-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payout calculator and batch processor</name>
  <files>
    web/lib/payouts/calculator.ts
    web/app/api/payouts/calculate-weekly/route.ts
    web/app/api/payouts/process-batch/route.ts
  </files>
  <action>
**web/lib/payouts/calculator.ts** — Payout calculation logic:
```typescript
export interface PayoutCalculation {
  medicPayout: number;
  platformFee: number;
  grossRevenue: number;
  medicPercentage: number; // Should be 60%
  platformPercentage: number; // Should be 40%
}

// Calculate payout split: medic gets 60%, platform keeps 40%
export function calculatePayout(bookingTotal: number): PayoutCalculation {
  const medicPercentage = 60;
  const platformPercentage = 40;

  const medicPayout = (bookingTotal * medicPercentage) / 100;
  const platformFee = (bookingTotal * platformPercentage) / 100;

  return {
    medicPayout: Number(medicPayout.toFixed(2)),
    platformFee: Number(platformFee.toFixed(2)),
    grossRevenue: bookingTotal,
    medicPercentage,
    platformPercentage,
  };
}

// Calculate platform fee from booking
export function calculatePlatformFee(bookingTotal: number): number {
  return Number(((bookingTotal * 40) / 100).toFixed(2));
}

// Validate payout matches expected calculation
export function validatePayout(timesheet: any, booking: any): boolean {
  const expected = calculatePayout(booking.total);
  const actual = timesheet.payout_amount;

  // Allow 1 penny tolerance for rounding
  return Math.abs(expected.medicPayout - actual) <= 0.01;
}
```

**web/app/api/payouts/calculate-weekly/route.ts** — GET endpoint:
- Query timesheets with status = 'admin_approved' and payout_status = 'admin_approved'
- Join with medics, bookings tables
- Filter: medic_submitted_at >= (today - 7 days) AND medic_submitted_at < today
- Calculate total payouts per medic:
  ```typescript
  {
    medic_id,
    medic_name,
    timesheet_count,
    total_hours,
    total_payout,
    stripe_account_id,
    stripe_onboarding_complete,
  }
  ```
- Calculate totals: total medics, total payouts, total platform fees
- Return: `{ medics: [], totals: { medicCount, totalPayouts, totalPlatformFees, totalRevenue } }`

**web/app/api/payouts/process-batch/route.ts** — POST endpoint:
- Accept: `{ timesheetIds: string[], dryRun?: boolean }`
- Validate user is admin (check role)
- Fetch timesheets with medic and booking relations
- Validate:
  - All timesheets have status 'admin_approved'
  - All medics have stripe_account_id and stripe_onboarding_complete = true
  - All payout amounts match expected calculations
- For each timesheet:
  - Create Stripe Transfer:
    ```typescript
    const transfer = await stripe.transfers.create({
      amount: Math.round(payout_amount * 100), // Convert GBP to pence
      currency: 'gbp',
      destination: medic.stripe_account_id,
      metadata: {
        timesheet_id: timesheet.id,
        medic_id: medic.id,
        booking_id: booking.id,
      },
      description: `Payout for ${booking.site_name} on ${booking.shift_date}`,
    });
    ```
  - Update timesheet: SET payout_status = 'paid', paid_at = NOW(), stripe_transfer_id = transfer.id
  - Log success
- Handle errors:
  - If Stripe Transfer fails: log error, mark timesheet with failure reason, continue processing others
  - Return summary: `{ success: count, failed: count, errors: [] }`
- If dryRun = true: skip Stripe calls, return validation results only
  </action>
  <verify>
Run: `ls web/lib/payouts/calculator.ts` confirms calculator exists.
Run: `grep "calculatePayout" web/lib/payouts/calculator.ts` confirms export.
Run: `ls web/app/api/payouts/calculate-weekly/` confirms weekly calculator route.
Run: `ls web/app/api/payouts/process-batch/` confirms batch processor route.
Run: `grep "stripe.transfers.create" web/app/api/payouts/process-batch/route.ts` confirms Stripe Transfer.
  </verify>
  <done>
Payout calculator validates 60/40 split, weekly calculator aggregates payouts per medic, batch processor creates Stripe Transfers with error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Friday payout Edge Function</name>
  <files>
    supabase/functions/friday-payout/index.ts
  </files>
  <action>
**supabase/functions/friday-payout/index.ts** — Automated payout processor:
- Import shared stripe client from `../_shared/stripe.ts`
- Accept POST request (called by pg_cron)
- Validate request has authorization header (service role key or cron secret)
- Query timesheets for payout:
  ```sql
  SELECT t.*, m.stripe_account_id, m.stripe_onboarding_complete, m.first_name, m.last_name, b.total, b.site_name, b.shift_date
  FROM timesheets t
  JOIN medics m ON t.medic_id = m.id
  JOIN bookings b ON t.booking_id = b.id
  WHERE t.payout_status = 'admin_approved'
    AND t.paid_at IS NULL
    AND m.stripe_account_id IS NOT NULL
    AND m.stripe_onboarding_complete = true
  ORDER BY t.medic_id, t.medic_submitted_at
  ```
- Group by medic (to batch multiple timesheets into single transfer if needed)
- For each timesheet:
  - Validate payout_amount matches expected 60% of booking.total
  - Create Stripe Transfer:
    ```typescript
    const transfer = await stripe.transfers.create({
      amount: Math.round(timesheet.payout_amount * 100),
      currency: 'gbp',
      destination: medic.stripe_account_id,
      metadata: {
        timesheet_id: timesheet.id,
        medic_id: medic.id,
        booking_id: booking.id,
        payout_week: new Date().toISOString().split('T')[0],
      },
      description: `Weekly payout - ${medic.first_name} ${medic.last_name}`,
    });
    ```
  - Update timesheet:
    ```sql
    UPDATE timesheets
    SET payout_status = 'paid',
        paid_at = NOW(),
        stripe_transfer_id = $1
    WHERE id = $2
    ```
  - Log success
- Error handling:
  - If medic missing stripe_account_id: log warning, skip
  - If Stripe Transfer fails: log error with details, update timesheet with error reason, continue processing others
  - Send admin notification email for failed payouts
- Return summary: `{ processed: count, successful: count, failed: count, errors: [] }`
- Log execution time and total amount transferred

IMPORTANT: Use UK Faster Payments by ensuring destination is Stripe Express account with bank_account capability in GB.
  </action>
  <verify>
Run: `ls supabase/functions/friday-payout/index.ts` confirms Edge Function exists.
Run: `grep "stripe.transfers.create" supabase/functions/friday-payout/index.ts` confirms Stripe Transfer.
Run: `grep "payout_status.*paid" supabase/functions/friday-payout/index.ts` confirms status update.
Run: `grep "admin_approved" supabase/functions/friday-payout/index.ts` confirms filtering.
  </verify>
  <done>
Friday payout Edge Function queries admin-approved timesheets, validates medic Stripe accounts, creates Stripe Transfers for UK Faster Payments, updates payout status, and handles errors with admin notifications.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create pg_cron scheduler and admin dashboard</name>
  <files>
    supabase/migrations/019_friday_payout_cron.sql
    web/components/admin/payout-summary.tsx
  </files>
  <action>
**supabase/migrations/019_friday_payout_cron.sql** — pg_cron job:
```sql
-- Migration 019: Friday Payout Cron Job
-- Schedule automated medic payouts every Friday at 9am GMT

-- Enable pg_cron extension (if not already enabled)
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Create cron job for Friday payouts
-- Runs every Friday at 9:00 AM GMT
-- Invokes friday-payout Edge Function via HTTP POST
SELECT cron.schedule(
  'friday-medic-payouts',  -- Job name
  '0 9 * * 5',             -- Cron expression: 9am on Fridays (day 5)
  $$
  SELECT
    net.http_post(
      url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/friday-payout',
      headers := jsonb_build_object(
        'Content-Type', 'application/json',
        'Authorization', 'Bearer ' || current_setting('app.service_role_key')
      ),
      body := jsonb_build_object(
        'scheduled', true,
        'execution_time', NOW()
      )
    ) AS request_id;
  $$
);

-- Create job execution log table
CREATE TABLE IF NOT EXISTS payout_executions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  execution_date DATE NOT NULL,
  execution_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  timesheets_processed INT DEFAULT 0,
  successful_payouts INT DEFAULT 0,
  failed_payouts INT DEFAULT 0,
  total_amount DECIMAL(10,2) DEFAULT 0,
  errors JSONB DEFAULT '[]'::jsonb,
  status TEXT NOT NULL DEFAULT 'running', -- running, completed, failed
  completed_at TIMESTAMPTZ,

  CONSTRAINT valid_status CHECK (status IN ('running', 'completed', 'failed'))
);

CREATE INDEX idx_payout_executions_date ON payout_executions(execution_date DESC);
CREATE INDEX idx_payout_executions_status ON payout_executions(status);

COMMENT ON TABLE payout_executions IS 'Audit log of automated Friday payout job executions';

-- Grant necessary permissions
GRANT USAGE ON SCHEMA cron TO postgres;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA cron TO postgres;
```

NOTE: The service_role_key needs to be set as a database setting. Alternatively, use a dedicated cron secret stored in vault.

**web/components/admin/payout-summary.tsx** — 'use client' component:
- Fetch data from /api/payouts/calculate-weekly
- Display weekly payout summary:
  - Total medics to be paid
  - Total payout amount (sum of medic payouts)
  - Total platform fees (40% kept)
  - Total revenue (100%)
  - Breakdown by medic: name, hours worked, payout amount, Stripe status
- Show medics with issues:
  - Missing Stripe account
  - Onboarding incomplete
  - Payout amount validation errors
- Display last payout execution:
  - Date, time, success count, failure count
  - Link to error logs if any failures
- "Process Payouts" button:
  - Triggers POST /api/payouts/process-batch
  - Shows confirmation dialog with dry-run preview
  - Displays progress during batch processing
  - Shows success/error summary after completion
- Filters: date range, medic name, status
  </action>
  <verify>
Run: `ls supabase/migrations/019_friday_payout_cron.sql` confirms migration exists.
Run: `grep "pg_cron" supabase/migrations/019_friday_payout_cron.sql` confirms extension enabled.
Run: `grep "0 9 \* \* 5" supabase/migrations/019_friday_payout_cron.sql` confirms Friday 9am schedule.
Run: `ls web/components/admin/payout-summary.tsx` confirms dashboard component.
Run: `grep "calculate-weekly" web/components/admin/payout-summary.tsx` confirms API integration.
  </verify>
  <done>
pg_cron job schedules Friday 9am payout execution, payout_executions table logs all runs, admin dashboard shows weekly summary with medic breakdown and manual trigger option.
  </done>
</task>

</tasks>

<verification>
1. pg_cron job created with Friday 9am schedule
2. Edge Function queries admin_approved timesheets only
3. Payout calculation validates 60/40 split (medic/platform)
4. Stripe Transfer uses UK Faster Payments (GB bank account)
5. Failed payouts logged with error details
6. Admin dashboard shows weekly summary with medic breakdown
7. Manual payout trigger available for admin intervention
8. All payout executions logged in payout_executions table
</verification>

<success_criteria>
- pg_cron job runs every Friday at 9am GMT
- Only timesheets with status 'admin_approved' are processed
- Stripe Transfer created for each medic with onboarding complete
- Medics receive funds within 2 business days (UK Faster Payments)
- Platform fee calculation correct: 60% to medic, 40% to platform
- Failed payouts flagged for manual review with clear error messages
- Admin can view weekly summary and manually trigger payouts
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-02-SUMMARY.md`
</output>
