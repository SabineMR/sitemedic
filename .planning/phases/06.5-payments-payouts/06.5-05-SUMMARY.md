---
phase: 06.5-payments-payouts
plan: 05
subsystem: bookings
tags: [google-maps, cost-calculation, admin-approval, out-of-territory, travel-bonus, react, typescript]

# Dependency graph
requires:
  - phase: 01.5-business-foundation
    provides: Google Maps API integration, travel_time_cache table
  - phase: 06.5-01
    provides: Payment processing infrastructure
  - phase: 06.5-02
    provides: Payout calculation patterns
provides:
  - Out-of-territory cost calculator with travel bonus vs room/board comparison
  - Google Maps API integration with 7-day caching for cost reduction
  - Admin approval workflow enforcing 50% and 75% cost thresholds
  - React components for cost display and approval decisions
affects: [booking-approval, admin-operations, territory-management]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Google Maps Distance Matrix API with 7-day caching"
    - "Cost comparison algorithm (travel_bonus vs room_board)"
    - "Configurable business rules in database"
    - "Admin override with confirmation dialogs"

key-files:
  created:
    - web/lib/bookings/out-of-territory.ts
    - web/app/api/bookings/calculate-cost/route.ts
    - web/components/bookings/out-of-territory-calculator.tsx
    - web/components/admin/out-of-territory-approval.tsx
    - supabase/migrations/022_out_of_territory_rules.sql
  modified: []

key-decisions:
  - "Travel bonus: £2/mile beyond 30 miles free zone (UK standard)"
  - "Room/board flat rate: £150 when travel >2 hours"
  - "Auto-deny recommendation at 50% cost threshold"
  - "Admin hard limit at 75% (prevents unprofitable bookings)"
  - "7-day Google Maps cache (70-80% API cost reduction)"

patterns-established:
  - "Cost calculator returns recommendation with full breakdown"
  - "Admin override requires explicit confirmation for 50-75% range"
  - "Denial requires reason with audit trail"
  - "Business rules stored in database for easy updates"

# Metrics
duration: 15min
completed: 2026-02-16
---

# Phase 06.5-05: Out-of-Territory Cost Management Summary

**Out-of-territory cost calculator with Google Maps integration, admin approval workflow, and 7-day caching to minimize API costs**

## Performance

- **Duration:** 15 minutes
- **Started:** 2026-02-16T15:45:00Z
- **Completed:** 2026-02-16T16:00:00Z
- **Tasks:** 3
- **Files created:** 5

## Accomplishments

- Cost calculation library compares travel bonus (£2/mile) vs room/board (£150 flat)
- Google Maps Distance Matrix API integration with 7-day caching
- Admin approval component enforces business rules (50% threshold, 75% hard limit)
- React components for visual cost breakdown and approval workflow
- Database migration for configurable business rules

## Task Commits

Each task was committed atomically:

1. **Task 1: Create out-of-territory cost calculator** - `af51afb` (feat)
   - Cost calculator library with travel bonus, room/board, and denial logic
   - Database migration with configurable business rules table

2. **Task 2: Create cost calculation API with Google Maps integration** - `f502b25` (feat)
   - POST /api/bookings/calculate-cost endpoint
   - Google Maps Distance Matrix API integration
   - 7-day caching in travel_time_cache table

3. **Task 3: Create out-of-territory UI components** - `5ca0d57` (feat)
   - OutOfTerritoryCalculator component with visual cost breakdown
   - OutOfTerritoryApproval component with admin workflow

## Files Created/Modified

### Created

- **web/lib/bookings/out-of-territory.ts** - Cost calculation logic with business rules
- **web/app/api/bookings/calculate-cost/route.ts** - API endpoint for cost calculation with Google Maps
- **web/components/bookings/out-of-territory-calculator.tsx** - React component for cost display
- **web/components/admin/out-of-territory-approval.tsx** - Admin approval interface
- **supabase/migrations/022_out_of_territory_rules.sql** - Business rules table and function

### Modified

None

## Decisions Made

1. **Travel bonus calculation:** £2/mile beyond 30 miles free zone (standard UK rate)

2. **Room/board flat rate:** £150 when travel time >2 hours (cheaper than hotel + meals)

3. **Auto-deny threshold:** 50% cost as percentage of shift value (profitability protection)

4. **Admin override limits:**
   - 0-50%: Auto-approve allowed
   - 50-75%: Override with confirmation required
   - >75%: Hard block (escalation required)

5. **Google Maps caching:** 7 days TTL reduces API costs by 70-80%

6. **Business rules in database:** Allows easy updates without code changes

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all Google Maps integration, cost calculation logic, and admin components implemented without issues.

## User Setup Required

**Environment Variables:**

The following environment variable must be set for Google Maps API:

```env
# Google Maps API Key (from Google Cloud Console)
GOOGLE_MAPS_API_KEY=your_api_key_here
```

**Google Cloud Console Setup:**
1. Enable Distance Matrix API
2. Create API key
3. Restrict key to Distance Matrix API only
4. Monitor usage (£0.005 per call, caching reduces by 70-80%)

**Verification:**
1. Create test booking with medic home postcode and site postcode
2. View out-of-territory calculator component
3. Verify cost breakdown displays:
   - Travel distance and time
   - Travel bonus cost (£2/mile beyond 30 miles)
   - Room/board option (if travel >2 hours)
   - Recommendation (travel_bonus / room_board / deny)
4. Verify admin approval component:
   - Shows cost percentage with progress bar
   - Enforces 50% and 75% thresholds
   - Requires confirmation for override
   - Blocks approval >75%

**Sample Test Data:**
- Medic postcode: "SW1A 1AA" (London)
- Site postcode: "M1 1AD" (Manchester)
- Expected: ~200 miles, ~4 hours, travel bonus ~£340, room/board £150
- Recommendation: room_board (cheaper)

## Next Phase Readiness

**Ready for:**
- Phase 06.5-03: Invoice generation with VAT and late payment handling
- Phase 06.5-04: IR35 compliance and medic onboarding
- Admin approval workflows for high-cost bookings

**Available:**
- Reusable OutOfTerritoryCalculator component for any booking flow
- Admin approval patterns (confirmation, audit trail, threshold enforcement)
- Google Maps caching infrastructure for other location features

**No blockers.**

---
*Phase: 06.5-payments-payouts*
*Completed: 2026-02-16*
