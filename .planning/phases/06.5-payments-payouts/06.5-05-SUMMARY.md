---
phase: 06.5-payments-payouts
plan: 05
subsystem: booking-cost-management
tags: [google-maps, out-of-territory, travel-bonus, room-board, admin-approval, cost-calculation]
requires: [06.5-01-invoice-api, 06.5-02-payout-engine]
provides:
  - out-of-territory cost calculator
  - google-maps integration with 7-day caching
  - travel bonus vs room/board comparison
  - admin approval workflow with override limits
  - automatic denial recommendations
affects: [booking-flow, admin-operations]
tech-stack:
  added: []
  patterns:
    - google-maps-distance-matrix-api
    - cost-threshold-enforcement
    - admin-override-workflow
key-files:
  created:
    - web/lib/bookings/out-of-territory.ts
    - web/app/api/bookings/calculate-cost/route.ts
    - web/components/bookings/out-of-territory-calculator.tsx
    - web/components/admin/out-of-territory-approval.tsx
    - supabase/migrations/022_out_of_territory_rules.sql
  modified: []
decisions:
  - decision: Travel bonus rate set at £2/mile beyond 30 miles
    rationale: Industry standard for out-of-territory travel compensation
    alternatives: Flat rate or percentage-based
    date: 2026-02-16
  - decision: Room/board flat rate of £150 when travel >2 hours
    rationale: Simpler than tracking actual hotel costs, covers typical overnight stay
    alternatives: Reimbursement model with receipts
    date: 2026-02-16
  - decision: Auto-deny recommendation at 50% cost threshold
    rationale: Prevents unprofitable bookings while allowing admin judgment
    alternatives: Hard denial at 50%, higher threshold
    date: 2026-02-16
  - decision: Admin override limit at 75% cost threshold
    rationale: Hard limit prevents extreme loss-making bookings
    alternatives: No hard limit, escalation to senior admin
    date: 2026-02-16
  - decision: 7-day cache for Google Maps route data
    rationale: Reduces API costs while keeping data reasonably fresh
    alternatives: 30-day cache, no cache, per-booking cache
    date: 2026-02-16
metrics:
  duration: 4 min
  completed: 2026-02-16
---

# Phase 06.5 Plan 05: Out-of-Territory Cost Management Summary

**One-liner:** Travel bonus vs room/board cost calculator with Google Maps integration, 7-day caching, and admin approval workflow (50-75% override limits).

## What Was Built

Created comprehensive out-of-territory cost management system that calculates the most cost-effective option for bookings outside a medic's primary territory.

**Core Components:**

1. **Cost Calculator Library** (`out-of-territory.ts`)
   - Travel bonus: £2/mile beyond 30-mile free zone
   - Room/board: £150 flat rate when travel >2 hours
   - Automatic comparison recommends cheaper option
   - Denial recommendation when cost >50% of shift value
   - Format helper for human-readable breakdown

2. **Google Maps API Integration** (`calculate-cost/route.ts`)
   - Distance Matrix API for accurate travel time/distance
   - 7-day caching to reduce API costs
   - UK postcode validation
   - Error handling for API failures
   - Converts meters to miles, seconds to minutes

3. **Out-of-Territory Calculator Component** (`out-of-territory-calculator.tsx`)
   - Real-time cost calculation via API
   - Visual cost breakdown with progress bars
   - Color-coded thresholds (green <25%, yellow <50%, orange <75%, red >75%)
   - Travel details: distance, time, postcodes
   - Option comparison: travel bonus vs room/board
   - Recommendation badges
   - Cache indicator
   - Refresh capability

4. **Admin Approval Component** (`out-of-territory-approval.tsx`)
   - Booking details with shift info
   - Full cost analysis display
   - Admin override workflow:
     - 50-75%: requires admin approval
     - >75%: blocked (escalation required)
   - Approval/denial actions with audit trail
   - Internal notes section
   - Denial reason capture
   - Confirmation dialogs for overrides

5. **Business Rules Database** (`022_out_of_territory_rules.sql`)
   - Configurable cost thresholds
   - Travel bonus rate, free miles, room/board rate
   - Denial threshold, admin override limit
   - Helper function: `get_out_of_territory_rule(rule_name)`

## Deviations from Plan

None - plan executed exactly as written.

## Decisions Made

**1. Travel Bonus Calculation**
- £2/mile beyond 30 miles (industry standard)
- First 30 miles included in base rate
- Linear calculation (no tiers)

**2. Room/Board vs Travel Bonus**
- Flat £150 rate for overnight accommodation
- Triggered when travel time >2 hours
- System recommends cheaper option
- Avoids receipt tracking complexity

**3. Cost Thresholds**
- 50%: Auto-deny recommendation (admin can override)
- 75%: Hard limit (requires escalation)
- Prevents extreme loss-making bookings
- Balances flexibility with financial protection

**4. Google Maps Caching Strategy**
- 7-day TTL for route data
- Reduces API costs significantly
- Routes rarely change for same postcodes
- `travel_time_cache` table already existed

**5. Admin Approval Workflow**
- Visual indicators for cost percentage
- Confirmation dialog for 50%+ overrides
- Blocks approval >75% automatically
- Audit trail: approved_by, approved_at, cancellation_reason

## Technical Notes

**Google Maps Integration:**
- Requires `GOOGLE_MAPS_API_KEY` environment variable
- Distance Matrix API endpoint
- Imperial units (miles) for UK market
- Error handling for invalid postcodes, API failures

**Cost Calculation:**
- Server-side validation prevents manipulation
- Shift value includes VAT (1.2x multiplier)
- Percentage calculation: (cost / shift_value) × 100

**UI/UX:**
- Progress bars show cost relative to shift value
- Color coding: green (safe) → yellow → orange → red (blocked)
- Badge system for recommendations
- Loading states and error handling
- Recalculate option clears cache

**Database Schema:**
- `out_of_territory_rules` table for configurable thresholds
- Booking fields: `out_of_territory_cost`, `out_of_territory_type`
- Approval fields: `approved_by`, `approved_at`, `requires_manual_approval`
- Cancellation fields: `cancelled_by`, `cancelled_at`, `cancellation_reason`

## Testing Strategy

**Manual Testing:**
1. Calculate cost for booking <30 miles (should be £0)
2. Calculate cost for 50 miles, 1 hour travel (travel bonus only)
3. Calculate cost for 100 miles, 3 hours travel (compare options)
4. Test 40% cost (auto-approve), 60% cost (admin override), 80% cost (blocked)
5. Verify cache works (second request instant)
6. Test invalid postcode format
7. Test admin approval/denial workflow

**Edge Cases:**
- Google Maps API failure (should error gracefully)
- Missing API key (should return 500 with clear message)
- Cache expiration (should refetch after 7 days)
- Cost exactly 50% or 75% (should follow threshold rules)
- Travel exactly 30 miles (should be £0 bonus)
- Travel exactly 2 hours (should show room/board option)

## Success Metrics

- [x] Travel bonus calculates at £2/mile beyond 30 miles
- [x] Room/board flat rate (£150) offered when travel >2 hours
- [x] System compares options and recommends cheaper one
- [x] Booking flagged for denial if cost >50% of shift value
- [x] Admin sees cost breakdown with distance, time, recommendations
- [x] Admin approval required for bookings >50% cost (up to 75% hard limit)
- [x] Google Maps API results cached for 7 days
- [x] Admin cannot override bookings >75% cost without escalation
- [x] TypeScript compilation passes with no errors

## Next Phase Readiness

**Blockers:** None

**Concerns:**
- Google Maps API costs: Monitor usage and consider billing alerts
- API key security: Ensure environment variable is properly secured
- Cache invalidation: May need manual cache clear if routes change (rare)
- Admin override abuse: Consider logging/auditing admin override decisions

**Handoff Notes:**
- Environment variable `GOOGLE_MAPS_API_KEY` must be set before deployment
- Database migration 022 must run before using out-of-territory features
- Consider adding admin dashboard to view override statistics
- May want to add email notifications for denied bookings
- Consider adding medic notification when assigned to out-of-territory booking

## Files Modified

**Created:**
- `web/lib/bookings/out-of-territory.ts` (123 lines) - Cost calculation logic
- `web/app/api/bookings/calculate-cost/route.ts` (172 lines) - API with Google Maps
- `web/components/bookings/out-of-territory-calculator.tsx` (279 lines) - Cost display
- `web/components/admin/out-of-territory-approval.tsx` (518 lines) - Admin approval UI
- `supabase/migrations/022_out_of_territory_rules.sql` (43 lines) - Business rules

**Total:** 5 files created, 1,135 lines added

## Commits

1. `af51afb` - feat(06.5-05): add out-of-territory cost calculator
2. `897be68` - feat(06.5-05): add cost calculation API with Google Maps integration
3. `9eb11af` - feat(06.5-05): add out-of-territory UI components

**Atomic commits:** Each task committed individually for clean git history and easy reversion.
