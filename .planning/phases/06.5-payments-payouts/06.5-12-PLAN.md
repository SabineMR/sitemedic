---
phase: 06.5-payments-payouts
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/api/invoices/send-reminder/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Late payment auto-reminders send emails to clients via Resend"
    - "Email failure does not block invoice status update"
    - "Response email_sent field reflects actual send status (not hardcoded true)"
  artifacts:
    - path: "web/app/api/invoices/send-reminder/route.ts"
      provides: "Late payment reminder API with Resend email sending"
      contains: "resend.emails.send"
  key_links:
    - from: "web/app/api/invoices/send-reminder/route.ts"
      to: "web/lib/email/resend.ts"
      via: "import { resend }"
      pattern: "import.*resend.*from.*@/lib/email/resend"
    - from: "web/app/api/invoices/send-reminder/route.ts"
      to: "Resend API"
      via: "resend.emails.send()"
      pattern: "resend\\.emails\\.send"
---

<objective>
Re-add Resend email integration to late payment reminder API that was accidentally reverted.

Purpose: Commit d8b6278 added Resend email sending to the late payment reminder endpoint. A subsequent commit d807b2d accidentally reverted this change. The current code builds the email subject/body but never sends it, and falsely returns `email_sent: true`. This plan restores email sending so clients actually receive overdue payment notifications.

Output: Working late payment reminder endpoint that sends emails via Resend with graceful error handling.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.5-payments-payouts/06.5-VERIFICATION.md

Key references:
- @web/app/api/invoices/send-reminder/route.ts (file to fix - currently has TODO stub at line 71)
- @web/lib/email/resend.ts (Resend client with dev mode fallback - import this)
- @web/app/api/email/booking-confirmation/route.ts (reference for Resend usage pattern - lines 132, 180)

Git history reference:
- Commit d8b6278: Original Resend integration (the code to restore)
- Commit d807b2d: Accidental reversion (the bad commit)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Re-add Resend email integration to late payment reminder endpoint</name>
  <files>web/app/api/invoices/send-reminder/route.ts</files>
  <action>
Modify `web/app/api/invoices/send-reminder/route.ts` to restore the Resend email sending that was reverted in commit d807b2d. Use commit d8b6278 as the reference for what to restore, adapted to the current file structure.

Specific changes:

1. **Add Resend import** at top of file (after existing imports):
   ```typescript
   import { resend } from '@/lib/email/resend';
   ```

2. **Replace the TODO stub** (current line 71: `// TODO: Implement Resend email sending`) with an actual Resend email send call. Place the email send AFTER the emailBody is built (after the closing backtick around line 99) and BEFORE the invoice update logic (current line 104). The call should:
   - Use `resend.emails.send()` with `from: 'SiteMedic Accounts <accounts@sitemedic.co.uk>'`
   - Send to `invoice.client.contact_email`
   - Use `emailSubject` (already defined) as subject
   - Include an HTML version wrapped in a styled div (SiteMedic branding: navy #003366 header, invoice details table, late fee warning, payment instructions, escalation warning for 21_days)
   - Include `emailBody` (already defined) as the `text` fallback
   - Store the result in `{ data: emailResult, error: emailError }`

3. **Add graceful error handling** after the send call:
   ```typescript
   if (emailError) {
     console.error('Failed to send reminder email:', emailError);
     // Continue processing -- email failure should NOT block invoice update
   }
   ```

4. **Remove the two console.log lines** that currently log the email subject/body to console (current lines 101-102), as they are the stub output.

5. **Fix the false positive response** at current line 130: Change `email_sent: true` to `email_sent: !emailError` so the response reflects whether the email was actually sent. This requires the `emailError` variable to be in scope -- declare it with `let emailError: any = null;` before the try block, or ensure the send result variable is accessible at the response.

HTML email template should follow the same pattern as commit d8b6278:
- Navy header bar (#003366) with "SiteMedic" text
- Light gray body (#f9fafb) with border
- Invoice details table with alternating style
- Yellow warning box citing UK Late Payment of Commercial Debts (Interest) Act 1998
- Payment instructions section
- Red escalation warning for 21_days reminders
- Footer with SiteMedic Ltd contact

IMPORTANT: Do NOT restructure the rest of the file. Only add the import, replace the TODO with the send call + error handling, remove the console.log stubs, and fix the email_sent response value. The invoice update logic, late fee calculation, and auth flow are all correct and must remain unchanged.

Pattern reference: See `web/app/api/email/booking-confirmation/route.ts` lines 132-144 for the established Resend usage pattern in this codebase (`const result = await resend.emails.send({...})` with error check).
  </action>
  <verify>
  Run these checks:

  1. `grep -n "import.*resend.*from.*@/lib/email/resend" web/app/api/invoices/send-reminder/route.ts` -- must find the import
  2. `grep -n "resend.emails.send" web/app/api/invoices/send-reminder/route.ts` -- must find the send call
  3. `grep -n "TODO.*Resend" web/app/api/invoices/send-reminder/route.ts` -- must return NO results (TODO removed)
  4. `grep -n "email_sent: true" web/app/api/invoices/send-reminder/route.ts` -- must return NO results (hardcoded true removed)
  5. `grep -n "email_sent:" web/app/api/invoices/send-reminder/route.ts` -- must show dynamic value (e.g., `!emailError`)
  6. `pnpm --dir web build 2>&1 | tail -5` -- must compile without TypeScript errors
  </verify>
  <done>
  - Resend import present at top of file
  - `resend.emails.send()` call replaces TODO stub
  - HTML email template with SiteMedic branding included
  - Text fallback uses existing emailBody variable
  - Error handling logs but does not block invoice update
  - Response `email_sent` field reflects actual send status (not hardcoded true)
  - No TypeScript compilation errors
  - File compiles cleanly with `pnpm build`
  </done>
</task>

</tasks>

<verification>
1. **Import present:** `grep "import.*resend" web/app/api/invoices/send-reminder/route.ts` returns the import line
2. **Send call present:** `grep "resend.emails.send" web/app/api/invoices/send-reminder/route.ts` returns the send call
3. **TODO removed:** `grep "TODO" web/app/api/invoices/send-reminder/route.ts` returns no results
4. **No false positive:** `grep "email_sent: true" web/app/api/invoices/send-reminder/route.ts` returns no results (should be dynamic)
5. **Graceful error handling:** `grep "email failure" web/app/api/invoices/send-reminder/route.ts` or similar comment present
6. **Build passes:** `pnpm --dir web build` completes without errors
</verification>

<success_criteria>
- Late payment reminder endpoint sends emails via Resend when triggered
- Email includes HTML template with SiteMedic branding and invoice details
- Text fallback included for email clients that don't render HTML
- Email failure is logged but does NOT prevent invoice status update (graceful degradation)
- Response `email_sent` field accurately reports whether email was sent
- Dev mode fallback works (console.log when RESEND_API_KEY not set, via existing resend.ts mock)
- Closes the final gap in Phase 6.5 verification (Truth #6: Late payment auto-reminders send emails)
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-12-SUMMARY.md`
</output>
