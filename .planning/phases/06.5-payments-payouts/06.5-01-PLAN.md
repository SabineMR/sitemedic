---
phase: 06.5-payments-payouts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/api/payments/create-payment-intent/route.ts
  - web/app/api/payments/capture-payment/route.ts
  - web/lib/stripe/server.ts
  - web/lib/stripe/client.ts
  - web/components/payments/payment-form.tsx
  - web/components/payments/payment-status.tsx
autonomous: true

must_haves:
  truths:
    - "Client payment processing works (card charge via Stripe Payment Intent with 3D Secure)"
    - "Payment Intent creation stores record in payments table"
    - "3D Secure authentication flow works for SCA-required cards"
    - "Payment success updates booking status to confirmed"
    - "Payment failure displays user-friendly error message"
  artifacts:
    - path: "web/lib/stripe/server.ts"
      provides: "Server-side Stripe client initialization"
      exports: ["stripe", "stripeSecretKey"]
    - path: "web/lib/stripe/client.ts"
      provides: "Client-side Stripe.js initialization"
      exports: ["loadStripe"]
    - path: "web/app/api/payments/create-payment-intent/route.ts"
      provides: "API endpoint for creating Payment Intent"
      exports: ["POST"]
    - path: "web/app/api/payments/capture-payment/route.ts"
      provides: "API endpoint for capturing authorized payment"
      exports: ["POST"]
    - path: "web/components/payments/payment-form.tsx"
      provides: "React component for payment form with Stripe Elements"
      contains: "PaymentForm"
  key_links:
    - from: "web/app/api/payments/create-payment-intent/route.ts"
      to: "supabase/functions/stripe-connect"
      via: "calls Edge Function to create Payment Intent"
      pattern: "stripe-connect"
    - from: "web/components/payments/payment-form.tsx"
      to: "web/lib/stripe/client.ts"
      via: "loads Stripe.js and Elements"
      pattern: "loadStripe"
    - from: "web/app/api/payments/capture-payment/route.ts"
      to: "payments table"
      via: "updates payment status on success"
      pattern: "payments.*update"
---

<objective>
Create client payment processing with Stripe Payment Intents, 3D Secure authentication, and booking confirmation flow.

Purpose: Clients can pay for bookings via card (prepay) or receive invoices (Net 30). This plan implements the prepay flow: Payment Intent creation with 3D Secure (SCA compliance), card charging, payment confirmation, and booking status updates.

Output: API routes for payment creation/capture, Stripe.js integration, payment form component, and payment status tracking.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/002_business_operations.sql
@supabase/functions/stripe-connect/index.ts
@.planning/phases/01.5-business-foundation/01.5-02-SUMMARY.md
@.planning/phases/04.6-customer-onboarding-contract-management/04.6-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe server and client initialization</name>
  <files>
    web/lib/stripe/server.ts
    web/lib/stripe/client.ts
  </files>
  <action>
**web/lib/stripe/server.ts** — Server-side Stripe client:
```typescript
import Stripe from 'stripe';

if (!process.env.STRIPE_SECRET_KEY) {
  throw new Error('STRIPE_SECRET_KEY environment variable is not set');
}

export const stripeSecretKey = process.env.STRIPE_SECRET_KEY;

// Initialize Stripe with API version
export const stripe = new Stripe(stripeSecretKey, {
  apiVersion: '2024-12-18', // Latest stable version
  typescript: true,
});
```

**web/lib/stripe/client.ts** — Client-side Stripe.js loader:
```typescript
import { loadStripe as stripeLoadStripe, Stripe } from '@stripe/stripe-js';

let stripePromise: Promise<Stripe | null> | null = null;

export const loadStripe = (): Promise<Stripe | null> => {
  if (!stripePromise) {
    const publishableKey = process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY;

    if (!publishableKey) {
      console.error('NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY is not set');
      return Promise.resolve(null);
    }

    stripePromise = stripeLoadStripe(publishableKey);
  }

  return stripePromise;
};
```

NOTE: This creates singleton instances to avoid multiple Stripe initializations. The server client is used in API routes, the client loader is used in React components.
  </action>
  <verify>
Run: `ls web/lib/stripe/server.ts` confirms server client exists.
Run: `ls web/lib/stripe/client.ts` confirms client loader exists.
Run: `grep "export const stripe" web/lib/stripe/server.ts` confirms export.
Run: `grep "loadStripe" web/lib/stripe/client.ts` confirms export.
  </verify>
  <done>
Stripe server client initialized with API key, client loader created with singleton pattern for Stripe.js.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Payment Intent API routes</name>
  <files>
    web/app/api/payments/create-payment-intent/route.ts
    web/app/api/payments/capture-payment/route.ts
  </files>
  <action>
**web/app/api/payments/create-payment-intent/route.ts** — POST endpoint:
- Accept: `{ bookingId: string, amount: number, clientId: string }`
- Validate user is authenticated (Supabase SSR)
- Fetch booking and client from database
- Validate:
  - Booking exists and belongs to client
  - Amount matches booking total
  - Booking status is 'pending'
- Check if client has stripe_customer_id:
  - If not: create Stripe Customer first via stripe.customers.create({ email, name: company_name, metadata: { client_id } })
  - Update clients table with stripe_customer_id
- Create Payment Intent:
  ```typescript
  const paymentIntent = await stripe.paymentIntents.create({
    amount: Math.round(amount * 100), // Convert GBP to pence
    currency: 'gbp',
    customer: stripe_customer_id,
    metadata: {
      booking_id: bookingId,
      client_id: clientId,
    },
    description: `Booking ${booking.site_name} on ${booking.shift_date}`,
    automatic_payment_methods: { enabled: true }, // Enables 3D Secure
    capture_method: 'automatic', // Auto-capture on confirmation
  });
  ```
- Insert into payments table:
  ```typescript
  {
    booking_id: bookingId,
    client_id: clientId,
    stripe_payment_intent_id: paymentIntent.id,
    amount: amount,
    platform_fee: booking.platform_fee,
    medic_payout: booking.medic_payout,
    status: 'pending',
  }
  ```
- Return: `{ clientSecret: paymentIntent.client_secret, paymentIntentId: paymentIntent.id }`
- Error handling: 400 for invalid input, 500 for Stripe errors

**web/app/api/payments/capture-payment/route.ts** — POST endpoint (for manual capture if needed):
- Accept: `{ paymentIntentId: string }`
- Validate user is authenticated
- Fetch payment from payments table by stripe_payment_intent_id
- Retrieve Payment Intent from Stripe: `stripe.paymentIntents.retrieve(paymentIntentId)`
- Check status:
  - If 'succeeded': update payments table status to 'succeeded'
  - Update bookings table: SET status = 'confirmed' WHERE id = booking_id
  - If 'requires_capture': call `stripe.paymentIntents.capture(paymentIntentId)`
  - If 'requires_payment_method': return error "Payment failed"
- Log payment event in audit trail
- Return: `{ success: true, status: paymentIntent.status }`

NOTE: For prepay bookings, capture_method='automatic' handles capture automatically. This endpoint is for edge cases or manual intervention.
  </action>
  <verify>
Run: `ls web/app/api/payments/create-payment-intent/` to verify route directory.
Run: `ls web/app/api/payments/capture-payment/` to verify capture route.
Run: `grep "automatic_payment_methods" web/app/api/payments/create-payment-intent/route.ts` confirms 3D Secure.
Run: `grep "payments.*insert" web/app/api/payments/create-payment-intent/route.ts` confirms DB insert.
Run: `cd /Users/sabineresoagli/GitHub/sitemedic/web && pnpm build 2>&1 | tail -10` to verify build.
  </verify>
  <done>
Payment Intent API creates Stripe Payment Intent with 3D Secure, stores record in payments table, and capture endpoint handles manual capture if needed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create payment form component with Stripe Elements</name>
  <files>
    web/components/payments/payment-form.tsx
    web/components/payments/payment-status.tsx
  </files>
  <action>
**web/components/payments/payment-form.tsx** — 'use client' component:
- Props: `{ bookingId: string, amount: number, onSuccess: (paymentIntentId: string) => void, onError: (error: string) => void }`
- Use @stripe/react-stripe-js: `<Elements>` and `<PaymentElement>`
- State: clientSecret (from API), processing (boolean), error (string | null)
- Load Stripe on mount: `const stripePromise = loadStripe()`
- Fetch client secret on mount:
  - POST /api/payments/create-payment-intent with { bookingId, amount, clientId }
  - Set clientSecret from response
- Render:
  - If no clientSecret: show loading spinner
  - If clientSecret: render Stripe Elements:
    ```tsx
    <Elements stripe={stripePromise} options={{ clientSecret }}>
      <PaymentElementForm
        clientSecret={clientSecret}
        onSuccess={onSuccess}
        onError={onError}
      />
    </Elements>
    ```
- Inner component `PaymentElementForm`:
  - Uses `useStripe()` and `useElements()` hooks
  - Renders `<PaymentElement />` (Stripe's unified payment UI)
  - Submit handler:
    - Calls `stripe.confirmPayment({ elements, confirmParams: { return_url: window.location.origin + '/bookings/success' } })`
    - If error: call onError(error.message)
    - If success: call onSuccess(paymentIntentId)
  - Shows processing state during submission
  - Displays inline errors below payment element

**web/components/payments/payment-status.tsx** — 'use client' component:
- Props: `{ status: 'pending' | 'processing' | 'succeeded' | 'failed', error?: string }`
- Renders status badge with color:
  - pending: gray badge "Payment pending"
  - processing: blue badge with spinner "Processing payment..."
  - succeeded: green badge with checkmark "Payment successful"
  - failed: red badge with X icon "Payment failed" + error message
- If failed: show "Try again" button
  </action>
  <verify>
Run: `ls web/components/payments/payment-form.tsx` confirms form component exists.
Run: `ls web/components/payments/payment-status.tsx` confirms status component exists.
Run: `grep "PaymentElement" web/components/payments/payment-form.tsx` confirms Stripe Elements integration.
Run: `grep "confirmPayment" web/components/payments/payment-form.tsx` confirms payment confirmation.
  </verify>
  <done>
Payment form component integrates Stripe Elements with PaymentElement for unified payment UI, handles 3D Secure authentication, and displays payment status with user-friendly error messages.
  </done>
</task>

</tasks>

<verification>
1. Stripe server client initialized with API version
2. Payment Intent API creates Payment Intent with automatic_payment_methods (3D Secure)
3. Payment record inserted into payments table with status 'pending'
4. Payment form uses Stripe Elements with PaymentElement
5. 3D Secure authentication flow works for SCA-required cards
6. Payment success updates booking status to 'confirmed'
7. Payment failure displays user-friendly error message
8. Build passes with no TypeScript errors
</verification>

<success_criteria>
- Client can enter card details in Stripe-hosted payment form
- 3D Secure authentication modal displays for SCA-required cards
- Payment Intent creation stores record in payments table
- Successful payment updates booking status to 'confirmed'
- Failed payment shows clear error message to user
- All payment events logged in database
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-01-SUMMARY.md`
</output>
