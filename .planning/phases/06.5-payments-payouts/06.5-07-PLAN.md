---
phase: 06.5-payments-payouts
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/api/invoices/send-reminder/route.ts
  - supabase/migrations/024_friday_payout_cron.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Late payment reminders send actual emails via Resend API (not console.log)"
    - "Friday payout pg_cron job is scheduled in migration SQL (SELECT cron.schedule executed)"
  artifacts:
    - path: "web/app/api/invoices/send-reminder/route.ts"
      provides: "Working email sending via Resend"
      contains: "resend.emails.send"
    - path: "supabase/migrations/024_friday_payout_cron.sql"
      provides: "pg_cron job actually scheduled"
      contains: "cron.schedule"
  key_links:
    - from: "web/app/api/invoices/send-reminder/route.ts"
      to: "web/lib/email/resend.ts"
      via: "import { resend }"
      pattern: "import.*resend.*from.*email/resend"
    - from: "supabase/migrations/024_friday_payout_cron.sql"
      to: "supabase/functions/friday-payout/index.ts"
      via: "pg_cron HTTP POST to Edge Function"
      pattern: "cron\\.schedule.*friday"
---

<objective>
Wire Resend email integration into late payment reminders and schedule pg_cron jobs in migration SQL.

Purpose: Late payment reminders currently stub email sending with console.log (TODO comment at line 125-128 of send-reminder/route.ts). The Friday payout migration (024, formerly 021) has the cron.schedule SQL commented out. Both must be functional for payment automation to work.

Output: Working email sending via existing Resend client, and pg_cron jobs actually scheduled in migration SQL.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.5-payments-payouts/06.5-03-SUMMARY.md
@.planning/phases/06.5-payments-payouts/06.5-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace console.log email stub with Resend integration</name>
  <files>web/app/api/invoices/send-reminder/route.ts</files>
  <action>
  The existing Resend client is at `web/lib/email/resend.ts` and exports a `resend` object with a `resend.emails.send()` method. It has graceful dev-mode fallback (logs to console if RESEND_API_KEY not set). This pattern is used in `web/app/api/email/booking-confirmation/route.ts`.

  In `web/app/api/invoices/send-reminder/route.ts`:

  1. Add import at top: `import { resend } from '@/lib/email/resend';`

  2. Replace the TODO block (lines 125-129):
     ```
     // TODO: Send email via Resend
     // For now, we'll just log it
     console.log(`Would send email to ${invoice.client.contact_email}:`);
     console.log(`Subject: ${subject}`);
     console.log(`Body: ${emailBody}`);
     ```

     With actual Resend call:
     ```typescript
     const { data: emailResult, error: emailError } = await resend.emails.send({
       from: 'SiteMedic Accounts <accounts@sitemedic.co.uk>',
       to: invoice.client.contact_email,
       subject: subject,
       html: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
         <div style="background: #003366; padding: 20px; border-radius: 8px 8px 0 0;">
           <h1 style="color: white; margin: 0; font-size: 20px;">SiteMedic</h1>
         </div>
         <div style="padding: 24px; background: #f9fafb; border: 1px solid #e5e7eb; border-top: none;">
           <h2 style="color: #1f2937; margin-top: 0;">Payment Reminder</h2>
           <p>Dear ${invoice.client.contact_name},</p>
           <p>This is a payment reminder for Invoice <strong>${invoice.invoice_number}</strong>.</p>
           <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
             <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Invoice Number</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">${invoice.invoice_number}</td></tr>
             <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Original Amount</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">GBP${parseFloat(invoice.total).toFixed(2)}</td></tr>
             <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Due Date</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${new Date(invoice.due_date).toLocaleDateString('en-GB')}</td></tr>
             <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Days Overdue</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; color: #ef4444; font-weight: bold;">${daysOverdue} days</td></tr>
             ${lateFee > 0 ? `<tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">Late Payment Fee</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; color: #ef4444;">GBP${lateFee.toFixed(2)}</td></tr>` : ''}
             <tr style="background: #f3f4f6;"><td style="padding: 8px; font-weight: bold;">Total Now Due</td><td style="padding: 8px; font-weight: bold; font-size: 16px;">GBP${(parseFloat(invoice.total) + lateFee).toFixed(2)}</td></tr>
           </table>
           <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 4px; padding: 12px; margin: 16px 0;">
             <p style="margin: 0; color: #92400e; font-size: 13px;">As per the UK Late Payment of Commercial Debts (Interest) Act 1998, statutory late payment fees apply to overdue invoices.</p>
           </div>
           <h3 style="color: #1f2937;">Payment Instructions</h3>
           <p>Bank: SiteMedic Ltd<br/>Sort Code: 12-34-56<br/>Account Number: 12345678<br/>Reference: ${invoice.invoice_number}</p>
           ${escalationWarning ? `<div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 4px; padding: 12px; margin: 16px 0;"><p style="margin: 0; color: #991b1b; font-weight: bold;">This invoice is 21+ days overdue. If payment is not received within 7 days, this matter may be escalated to our collections department.</p></div>` : ''}
           <p style="color: #6b7280; font-size: 12px;">If you have already made payment, please disregard this reminder and contact us to confirm.</p>
         </div>
         <div style="padding: 12px; text-align: center; color: #9ca3af; font-size: 11px;">
           SiteMedic Ltd | accounts@sitemedic.co.uk
         </div>
       </div>`,
       text: emailBody,
     });

     if (emailError) {
       console.error('Failed to send reminder email:', emailError);
       // Continue processing -- email failure should not block invoice status update
     }
     ```

  3. Update the response `email_sent` field to use actual result:
     Change `email_sent: true` to `email_sent: !emailError`

  Do NOT change the authentication logic, invoice query, late fee calculation, or audit logging. Only replace the email stub.
  </action>
  <verify>
  Search for "console.log(`Would send email" in the file -- should NOT exist.
  Search for "resend.emails.send" in the file -- should exist.
  Search for "TODO: Send email via Resend" -- should NOT exist.
  `cd /Users/sabineresoagli/GitHub/sitemedic && pnpm tsc --noEmit 2>&1 | grep "send-reminder" || echo "No type errors"`
  </verify>
  <done>
  - send-reminder/route.ts imports `resend` from `@/lib/email/resend`
  - Email sending uses `resend.emails.send()` with HTML template and text fallback
  - No console.log stub or TODO comments remain
  - Dev mode still works (Resend client falls back to console logging when no API key)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pg_cron schedule SQL to Friday payout migration</name>
  <files>supabase/migrations/024_friday_payout_cron.sql</files>
  <action>
  NOTE: This file will be named 024_friday_payout_cron.sql after Plan 06 renumbers it. If Plan 06 has not yet run, modify the file at its current name (021_friday_payout_cron.sql) instead.

  The current migration at `021_friday_payout_cron.sql` (soon to be 024) creates the pg_cron extension and payout_executions table, but the actual `cron.schedule()` call is commented out (lines 36-59). The RIDDOR migration at `020_riddor_deadline_cron.sql` shows the correct pattern: it actually calls `SELECT cron.schedule(...)` with vault secrets for auth.

  Modify the migration to ADD the actual cron.schedule call AFTER the existing table creation. Add this SQL at the bottom of the file, BEFORE the final COMMENT line:

  ```sql
  -- Enable pg_net for HTTP calls
  CREATE EXTENSION IF NOT EXISTS pg_net;

  -- Schedule Friday payout job
  -- Cron expression: '0 9 * * 5' = Every Friday at 09:00 UTC
  SELECT cron.schedule(
    'friday-medic-payouts',
    '0 9 * * 5',
    $$
    SELECT net.http_post(
      url := (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'project_url')
             || '/functions/v1/friday-payout',
      headers := jsonb_build_object(
        'Content-Type', 'application/json',
        'Authorization', 'Bearer ' || (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'service_role_key')
      ),
      body := jsonb_build_object(
        'scheduled', true,
        'execution_time', NOW()
      )
    ) AS request_id;
    $$
  );
  ```

  This pattern mirrors the working `020_riddor_deadline_cron.sql` migration which uses vault.decrypted_secrets for secure credential retrieval.

  Also REMOVE the entire "NOTE: pg_cron job creation requires manual setup" comment block (lines 36-59) since the job is now scheduled in the migration itself.

  Replace it with:
  ```sql
  -- Vault secrets required (configured in Supabase Dashboard):
  -- - project_url: Your Supabase project URL (e.g., https://xxx.supabase.co)
  -- - service_role_key: Your service role key for Edge Function auth
  ```

  Do NOT change the payout_executions table definition or indexes.
  </action>
  <verify>
  Search file for "cron.schedule" (uncommented, not in a comment block) -- should exist.
  Search file for "requires manual setup" -- should NOT exist.
  Search file for "vault.decrypted_secrets" -- should exist.
  Search file for "friday-medic-payouts" -- should exist as the job name.
  </verify>
  <done>
  - Migration 024 (or 021 if not yet renumbered) contains `SELECT cron.schedule(...)` that will execute on migration run
  - Uses vault secrets pattern consistent with 020_riddor_deadline_cron.sql
  - "Manual setup" comment block removed
  - pg_net extension enabled for HTTP calls
  - payout_executions table unchanged
  </done>
</task>

</tasks>

<verification>
- `grep -c "resend.emails.send" web/app/api/invoices/send-reminder/route.ts` returns 1
- `grep -c "console.log.*Would send email" web/app/api/invoices/send-reminder/route.ts` returns 0
- `grep "cron.schedule" supabase/migrations/024_friday_payout_cron.sql` (or 021 if not renumbered) shows uncommented schedule call
- `grep "requires manual setup" supabase/migrations/024_friday_payout_cron.sql` returns empty
- `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
1. Late payment reminder API sends real emails via Resend (with dev-mode fallback when no API key)
2. Friday payout cron job scheduled in migration SQL (not commented out)
3. Cron pattern uses vault secrets for auth (matches RIDDOR cron pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-07-SUMMARY.md`
</output>
