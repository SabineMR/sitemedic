---
phase: 06.5-payments-payouts
verified: 2026-02-16T23:45:00Z
status: gaps_found
score: 11/12 must-haves verified
re_verification:
  previous_status: gaps_found
  previous_score: 10/12
  gaps_closed:
    - "Payslip PDF generation now has payslip_reference field and automated trigger"
    - "Late payment cron auth pattern aligned with vault.decrypted_secrets"
  gaps_remaining:
    - "Late payment email sending REGRESSED - Resend integration was removed"
  regressions:
    - truth: "Late payment auto-reminders send emails"
      previous_status: "VERIFIED (claimed in previous verification)"
      current_status: "FAILED"
      regression_cause: "Commit d807b2d (16:58) reverted Resend integration added in d8b6278 (16:33)"

gaps:
  - truth: "Late payment auto-reminders send at 7, 14, 21 days with statutory late fees (40-100)"
    status: partial
    reason: "Cron auth pattern FIXED (vault.decrypted_secrets in migration 030), BUT email sending is TODO stub - Resend integration was reverted"
    artifacts:
      - path: "web/app/api/invoices/send-reminder/route.ts"
        issue: "Line 71: '// TODO: Implement Resend email sending' - email content built but NOT sent"
      - path: "web/app/api/invoices/send-reminder/route.ts"
        issue: "Line 130: Returns email_sent: true but no actual email call exists - FALSE POSITIVE"
    missing:
      - "Re-add Resend API call: resend.emails.send({ from, to, subject, html, text })"
      - "Import Resend client from @/lib/email/resend"
      - "Handle email send errors gracefully (log but don't block invoice update)"
    regression_details:
      - commit_added: "d8b6278 (2026-02-16 16:33) feat(06.5-07): wire Resend email into late payment reminders"
      - commit_reverted: "d807b2d (2026-02-16 16:58) feat(06.5-03): create automated late payment reminder system"
      - reversion_impact: "Deleted 134 lines, added 49 lines - removed Resend import and email.send() call"
      - false_claim: "Previous verification claimed 'Resend API integrated (line 126)' but this was AFTER d8b6278 and BEFORE d807b2d reversion"
---

# Phase 6.5: Payment Processing & Payouts Re-Verification Report (v3)

**Phase Goal:** Full payment processing operational with client charging (card + Net 30), automated weekly medic payouts via UK Faster Payments, IR35 compliance, and out-of-territory cost management.

**Verified:** 2026-02-16T23:45:00Z
**Status:** gaps_found
**Re-verification:** Yes ‚Äî after gap closure plan 06.5-11

## Re-Verification Summary

**Previous Status:** gaps_found (10/12 must-haves verified)
**Current Status:** gaps_found (11/12 must-haves verified)
**Progress:** 2 gaps closed, 1 REGRESSION discovered

### Gaps Closed ‚úÖ

1. **Payslip PDF generation schema (Gap #9)** ‚Äî FIXED
   - Migration 029 adds `payslip_reference` field (line 22)
   - Trigger `trigger_generate_payslip_pdf` created (line 67)
   - pg_net HTTP POST calls Edge Function after INSERT (lines 43-52)
   - Edge Function can now read payslip.payslip_reference without runtime error

2. **Late payment cron auth pattern (Gap #6 follow-up)** ‚Äî FIXED
   - Migration 030 unschedules old job (line 19)
   - Migration 030 recreates with vault.decrypted_secrets (lines 39, 43, 57, 61, 75, 79)
   - Consistent with migrations 021 (RIDDOR) and 022 (Friday payout)

### Regression Discovered üî¥

**Late Payment Email Sending (Truth #6)** ‚Äî REGRESSED from VERIFIED to PARTIAL

**What happened:**
1. Plan 06.5-07 added Resend email integration (commit d8b6278, 16:33)
2. Previous verification (16:40) checked codebase and saw Resend integration
3. Previous verification claimed "Resend API integrated (send-reminder/route.ts line 126)" ‚úì VERIFIED
4. AFTER previous verification, commit d807b2d (16:58) REVERTED the Resend integration
5. Commit d807b2d has WRONG message: "feat(06.5-03): create..." (should be "revert(06.5-07)")
6. Current codebase has NO email sending - line 71 is "// TODO: Implement Resend email sending"
7. Line 130 returns `email_sent: true` but NO email was actually sent - FALSE POSITIVE

**Evidence:**
- `git show d8b6278` - shows +41 lines with resend.emails.send()
- `git show d807b2d` - shows -134/+49 lines, removes Resend import
- Current file line 71: `// TODO: Implement Resend email sending`
- No `import` statement for Resend
- No `resend.emails.send()` call in function body

**Impact:** Late payment reminders will update database but NOT send emails to clients. Silent failure.

### Gaps Remaining ‚ö†Ô∏è

1. **Late payment email sending (Gap #6)** ‚Äî PARTIAL (was claimed VERIFIED, now REGRESSED)
   - Cron auth pattern: ‚úÖ FIXED (vault.decrypted_secrets in migration 030)
   - Email sending: ‚ùå REGRESSED (TODO stub, Resend integration removed)
   - Invoice update logic: ‚úÖ Working (status, reminder flags, late fees)
   - Database state: ‚úÖ Correct (invoices marked as reminded)
   - Client notification: ‚ùå BROKEN (no email sent)

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Client payment processing works (card charge via Stripe Payment Intent with 3D Secure) | ‚úì VERIFIED | No change from previous. Payment Intent API at web/app/api/payments/create-payment-intent/route.ts functional. |
| 2 | Friday payout job runs automatically (zero failures, every Friday at 9am) | ‚úì VERIFIED | No change from previous. Migration 022 line 45: `SELECT cron.schedule('friday-medic-payouts', '0 9 * * 5'...`. |
| 3 | Medics receive funds within 2 business days via UK Faster Payments | ‚úì VERIFIED | No change from previous. GB validation at friday-payout/index.ts lines 145-161. |
| 4 | Platform fee calculation correct (medic 30/hr -> client 42/hr -> platform 12/hr) | ‚úì VERIFIED | No change from previous. calculator.ts lines 31-32 use 71.4%/28.6%. |
| 5 | Invoice PDF generated with VAT (20%) and Net 30 terms for established clients | ‚úì VERIFIED | No change from previous. Invoice PDF functional. |
| 6 | Late payment auto-reminders send at 7, 14, 21 days with statutory late fees (40-100) | ‚ö†Ô∏è PARTIAL | **REGRESSED** - Cron auth FIXED (migration 030 uses vault pattern), BUT email sending is TODO stub (line 71). Returns email_sent: true falsely (line 130). Resend integration REMOVED in commit d807b2d. |
| 7 | Medic onboarding captures IR35 status (self-employed vs umbrella company) | ‚úì VERIFIED | No change from previous. IR35 form at web/components/medics/ir35-form.tsx. |
| 8 | Stripe Express account onboarding link works (medic completes bank details) | ‚úì VERIFIED | No change from previous. Webhook handler account.updated at webhooks/route.ts line 125. |
| 9 | Payslip PDF generated (gross, deductions, net) for medic records | ‚úì VERIFIED | **FIXED** - Migration 029 adds payslip_reference (line 22), trigger (line 67), pg_net call (lines 43-52). Edge Function can read field without error. |
| 10 | Out-of-territory bookings calculate travel bonus (2/mile beyond 30 miles) vs room/board cost | ‚úì VERIFIED | No change from previous. Calculator at web/lib/bookings/out-of-territory.ts. |
| 11 | Admin sees cost breakdown and can approve/deny out-of-territory booking | ‚úì VERIFIED | No change from previous. Component wired at booking-approval-table.tsx line 35, 887. |
| 12 | System denies booking if out-of-territory cost >50% of shift cost (admin can override) | ‚úì VERIFIED | No change from previous. Denial logic functional. |

**Score:** 11/12 truths verified (1 partial due to regression, 0 completely failed)

### Required Artifacts

| Artifact | Expected | Status | Re-Verification Notes |
|----------|----------|--------|----------------------|
| `supabase/migrations/029_payslip_schema_fix.sql` | payslip_reference field and PDF trigger | ‚úì VERIFIED | **NEW** - 82 lines, adds column (line 22), trigger function (lines 30-56), trigger (lines 67-70). |
| `supabase/migrations/030_late_payment_cron_auth_fix.sql` | Late payment cron with vault auth | ‚úì VERIFIED | **NEW** - 108 lines, unschedules old (line 19), schedules with vault (lines 24-86). |
| `web/app/api/invoices/send-reminder/route.ts` | Late payment reminder API with email | ‚ö†Ô∏è PARTIAL | **REGRESSED** - 140 lines, BUT line 71 is TODO stub, no Resend import, no email.send() call. |
| `web/lib/payouts/calculator.ts` | Payout calculator with 71.4/28.6 split | ‚úì VERIFIED | No change from previous. 70 lines, correct percentages. |
| `supabase/functions/friday-payout/index.ts` | Friday payout Edge Function | ‚úì VERIFIED | No change from previous. 320 lines, GB validation at 145-161. |
| `supabase/migrations/022_friday_payout_cron.sql` | pg_cron job for Friday 9am | ‚úì VERIFIED | No change from previous. Line 45 schedules job. |
| `supabase/functions/generate-payslip-pdf/index.ts` | Payslip PDF generator | ‚úì VERIFIED | No change from previous. 185 lines, reads payslip_reference (line 107). |
| `web/app/api/stripe/webhooks/route.ts` | Stripe webhook handler | ‚úì VERIFIED | No change from previous. account.updated handler at lines 125-158. |
| `web/components/admin/booking-approval-table.tsx` | Admin booking approval UI | ‚úì VERIFIED | No change from previous. OutOfTerritoryApproval wired at lines 35, 887. |
| `web/lib/bookings/out-of-territory.ts` | OOT cost calculator | ‚úì VERIFIED | No change from previous. Travel bonus vs room/board logic functional. |

### Key Link Verification

| From | To | Via | Status | Re-Verification Notes |
|------|----|----|--------|----------------------|
| Payslip trigger (029) | payslips table | AFTER INSERT | ‚úì WIRED | **NEW** - trigger_generate_payslip_pdf fires after payslip row created |
| Payslip trigger (029) | Edge Function | pg_net HTTP POST | ‚úì WIRED | **NEW** - Lines 43-52 call generate-payslip-pdf with payslipId |
| Late payment cron (030) | Reminder API | HTTP POST | ‚úì WIRED | **NEW** - Migration 030 lines 38-46 call /functions/v1/send-invoice-reminder |
| Reminder API | Resend email | resend.emails.send() | ‚úó NOT_WIRED | **REGRESSED** - TODO stub at line 71, no actual email call |
| Friday payout cron (022) | Edge Function | HTTP POST via pg_net | ‚úì WIRED | No change from previous. |
| Stripe webhook | medics table | UPDATE stripe_onboarding_complete | ‚úì WIRED | No change from previous. |
| OutOfTerritoryApproval | booking-approval-table | Modal overlay | ‚úì WIRED | No change from previous. |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Re-Verification Status |
|------|------|---------|----------|------------------------|
| `send-reminder/route.ts` | 71 | TODO stub for email sending | üõë Blocker | **NEW REGRESSION** - Was fixed in d8b6278, reverted in d807b2d |
| `send-reminder/route.ts` | 130 | Returns email_sent: true falsely | üõë Blocker | **NEW** - Misleading response, no email actually sent |

### Previous Anti-Patterns Resolved

| File | Pattern | Resolution |
|------|---------|------------|
| `029_payslip_schema_fix.sql` | Missing payslip_reference field | **RESOLVED** - Field added at line 22 |
| `029_payslip_schema_fix.sql` | No Edge Function trigger | **RESOLVED** - Trigger created at line 67 |
| `030_late_payment_cron_auth_fix.sql` | current_setting() auth mismatch | **RESOLVED** - Vault pattern used |

## Gaps Summary

**1 gap blocking full goal achievement:**

### Gap 1: Late Payment Email Sending REGRESSION

**Impact:** Late payment reminders update database correctly but NEVER send emails to clients. Silent failure - clients don't know they're overdue.

**Root Cause:** Resend integration added in commit d8b6278 (16:33) was reverted in commit d807b2d (16:58) with wrong commit message

**Timeline:**
1. 15:36 - Commit 03fa205: Initial reminder system (console.log stub)
2. 16:33 - Commit d8b6278: Added Resend integration (resend.emails.send)
3. 16:40 - Previous verification run: Saw Resend integration, marked VERIFIED
4. 16:58 - Commit d807b2d: REVERTED Resend integration (wrong commit message)
5. 17:32 - Plan 06.5-11 executed: Fixed auth pattern, didn't touch email
6. 23:45 - This verification: Discovered regression

**Evidence:**
- Current file line 71: `// TODO: Implement Resend email sending`
- No `import` for Resend client
- No `resend.emails.send()` call
- Line 130 returns `email_sent: true` despite no email sent
- `git diff d8b6278 HEAD -- send-reminder/route.ts` shows -41 insertions (Resend code removed)

**What's Missing:**
1. Re-add Resend import: `import { resend } from '@/lib/email/resend';`
2. Replace TODO at line 71 with:
   ```typescript
   await resend.emails.send({
     from: 'billing@sitemedic.co.uk',
     to: invoice.client.contact_email,
     subject: emailSubject,
     html: `<html>...</html>`,
     text: emailBody
   });
   ```
3. Wrap in try-catch for graceful error handling
4. Don't block invoice update if email fails

**Workaround:** Manual emails to clients OR re-apply commit d8b6278 changes

## Next Steps

1. **Re-add Resend email integration** (5-10 min task)
   - Cherry-pick changes from commit d8b6278
   - OR manually re-implement resend.emails.send() call
   - Add try-catch for graceful error handling
   - Test with test invoice (due_date 7 days ago)

2. **Verify email delivery end-to-end**
   - Create test invoice, trigger reminder API
   - Confirm email received at client.contact_email
   - Verify HTML renders correctly in Gmail/Outlook
   - Check late fee calculation accurate

## Human Verification Required

### 1. Test Payslip PDF Generation End-to-End

**Test:** 
1. Create test timesheet with admin_approved = true
2. Set payout_status = 'paid'
3. Wait 5-10 seconds for async Edge Function

**Expected:**
- Payslip row created with payslip_reference (PS-YYYYMMDD-UUID8)
- pdf_url populated with signed URL
- PDF downloads correctly
- PDF shows: payslip reference, medic name, gross/deductions/net, hours

**Why human:** Requires database INSERT and PDF visual inspection

### 2. Test Late Payment Cron with Vault Auth

**Test:**
1. Configure vault secrets in Supabase Dashboard (project_url, service_role_key)
2. Create test invoice with due_date = 7 days ago
3. Manually trigger cron job via SQL Editor

**Expected:**
- Cron job executes without auth errors
- Reminder API called (check pg_net queue)
- Invoice updated (reminder_sent_7_days = true, status = 'overdue')
- **Email NOT sent** (due to regression, will fail until fixed)

**Why human:** Requires Supabase Dashboard access and vault configuration

### 3. Test Friday Payout with Payslip PDF Cascade

**Test:**
1. Create approved timesheet (admin_approved = true)
2. Trigger Friday payout Edge Function
3. Verify cascade: timesheet -> payout -> payslip -> PDF

**Expected:**
- timesheet.payout_status = 'paid'
- Stripe Transfer created
- Payslip row created with payslip_reference
- Payslip PDF generated and pdf_url populated
- Payslip downloadable via signed URL

**Why human:** Requires Stripe test mode and full workflow validation

### 4. Test Out-of-Territory Approval Workflow

**Test:**
1. Create booking requiring manual approval (>50% travel cost)
2. Open admin booking approval dashboard
3. Click "Review Cost" button

**Expected:**
- Modal opens with cost breakdown
- Shows travel bonus vs room/board comparison
- Admin can approve/deny
- Booking status updates in database

**Why human:** Requires admin UI interaction

---

_Verified: 2026-02-16T23:45:00Z_
_Verifier: Claude (gsd-verifier)_
_Re-verification: Yes (v3 - after plan 06.5-11, discovered regression)_
