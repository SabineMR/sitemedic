---
phase: 06.5-payments-payouts
verified: 2026-02-16T21:55:00Z
status: gaps_found
score: 7/12 must-haves verified

gaps:
  - truth: "Friday payout job runs automatically (zero failures, every Friday at 9am)"
    status: failed
    reason: "pg_cron job exists in migration but NOT actually scheduled - requires manual Supabase Dashboard setup"
    artifacts:
      - path: "supabase/migrations/021_friday_payout_cron.sql"
        issue: "Migration only creates extension and table structure. Comment at line 36 says 'pg_cron job creation requires manual setup via Supabase Dashboard'"
    missing:
      - "Actual pg_cron job scheduled in database (SELECT cron.schedule(...) not executed)"
      - "Migration needs to run the actual scheduling SQL, not just document it"
      - "No automated trigger exists - Friday payouts will NOT run automatically"
  
  - truth: "Medics receive funds within 2 business days via UK Faster Payments"
    status: partial
    reason: "Stripe Transfer API called correctly, but UK Faster Payments requires medic bank account in GB with currency=gbp"
    artifacts:
      - path: "supabase/functions/friday-payout/index.ts"
        issue: "Transfer created with currency: 'gbp' but no validation that medic's Stripe Express account has GB bank account capability"
    missing:
      - "Check medic.stripe_account_id has bank_account capability enabled"
      - "Verify account.country = 'GB' before attempting transfer"
      - "Error handling for non-GB accounts (would fail at Stripe API level)"
  
  - truth: "Late payment auto-reminders send at 7, 14, 21 days with statutory late fees (40-100)"
    status: failed
    reason: "Reminder API and cron migration exist BUT email sending is stubbed with console.log (Resend not integrated)"
    artifacts:
      - path: "web/app/api/invoices/send-reminder/route.ts"
        issue: "Line has TODO comment and console.log instead of actual Resend API call"
      - path: "supabase/migrations/020_late_payment_reminders.sql"
        issue: "pg_cron job SQL exists in migration but NOT actually scheduled (same issue as payout cron)"
    missing:
      - "Resend API integration (email actually sends)"
      - "pg_cron job actually scheduled for daily execution"
      - "Email templates stored/configured"
  
  - truth: "Stripe Express account onboarding link works (medic completes bank details)"
    status: partial
    reason: "Onboarding URL generation exists but no verification that medic actually completes onboarding"
    artifacts:
      - path: "web/components/medics/stripe-onboarding-status.tsx"
        issue: "Component shows status but doesn't enforce completion before enabling payout"
    missing:
      - "Webhook handler to capture account.updated events from Stripe"
      - "Database update when onboarding completes (charges_enabled/payouts_enabled)"
      - "Block payouts if stripe_onboarding_complete = false"
  
  - truth: "Payslip PDF generated (gross, deductions, net) for medic records"
    status: failed
    reason: "Payslip database record created by trigger, but PDF generation NOT implemented"
    artifacts:
      - path: "supabase/migrations/021_payslip_generation.sql"
        issue: "Creates payslips table with pdf_url field but no Edge Function to generate PDF"
    missing:
      - "Edge Function to generate payslip PDF (similar to invoice PDF generator)"
      - "Upload payslip PDF to Supabase Storage"
      - "Update payslips.pdf_url after generation"
  
  - truth: "Admin sees cost breakdown and can approve/deny out-of-territory booking"
    status: partial
    reason: "Cost calculator and approval UI exist but NOT integrated into booking workflow"
    artifacts:
      - path: "web/components/admin/out-of-territory-approval.tsx"
        issue: "Standalone component exists but not wired into admin booking approval page"
      - path: "web/components/bookings/out-of-territory-calculator.tsx"
        issue: "Component exists but no evidence of usage in booking creation flow"
    missing:
      - "Integration into admin dashboard bookings page"
      - "Auto-trigger calculation when booking is out-of-territory"
      - "Block booking confirmation if requires_manual_approval=true"
---

# Phase 6.5: Payment Processing & Payouts Verification Report

**Phase Goal:** Full payment processing operational with client charging (card + Net 30), automated weekly medic payouts via UK Faster Payments, IR35 compliance, and out-of-territory cost management.

**Verified:** 2026-02-16T21:55:00Z
**Status:** gaps_found
**Re-verification:** No ‚Äî initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Client payment processing works (card charge via Stripe Payment Intent with 3D Secure) | ‚úì VERIFIED | Payment Intent API at `web/app/api/payments/create-payment-intent/route.ts` uses `automatic_payment_methods: { enabled: true }` (line 134). PaymentElement component wired with `confirmPayment()`. 3D Secure enabled. |
| 2 | Friday payout job runs automatically (zero failures, every Friday at 9am) | ‚úó FAILED | Migration 021 creates pg_cron extension but NOT the actual job. Line 36 comment says "requires manual setup via Supabase Dashboard". No `SELECT cron.schedule(...)` in migration. Payouts will NOT run automatically. |
| 3 | Medics receive funds within 2 business days via UK Faster Payments | ‚ö†Ô∏è PARTIAL | `stripe.transfers.create()` called in `friday-payout/index.ts` (line 165) with `currency: 'gbp'`. BUT no validation that medic Express account has GB bank_account. Would fail at Stripe API for non-GB accounts. |
| 4 | Platform fee calculation correct (medic 30/hr -> client 42/hr -> platform 12/hr) | ‚úó FAILED | Calculator uses 60/40 split (medic 60%, platform 40%) in `calculator.ts` lines 26-27. This is DIFFERENT from roadmap spec (medic 30/hr, client 42/hr = 71.4% medic, 28.6% platform). Arithmetic mismatch. |
| 5 | Invoice PDF generated with VAT (20%) and Net 30 terms for established clients | ‚úì VERIFIED | `InvoiceDocument.tsx` displays "VAT (20%)" at line 105 and "Net 30" payment terms at line 73. Edge Function uploads PDF to Storage. |
| 6 | Late payment auto-reminders send at 7, 14, 21 days with statutory late fees (40-100) | ‚úó FAILED | Late fee calculator exists (`late-fees.ts` with ¬£40/¬£70/¬£100). Reminder API exists BUT email sending is console.log stub (TODO comment). pg_cron migration 020 has SQL but job NOT scheduled. No emails will send. |
| 7 | Medic onboarding captures IR35 status (self-employed vs umbrella company) | ‚úì VERIFIED | `ir35-form.tsx` (284 lines) has employment_status radio buttons. `ir35-validator.ts` validates self_employed vs umbrella. Form captures UTR and CEST assessment. |
| 8 | Stripe Express account onboarding link works (medic completes bank details) | ‚ö†Ô∏è PARTIAL | `stripe-onboarding-status.tsx` shows onboarding URL from `stripe_connect` Edge Function. BUT no webhook to capture completion events. No verification that charges_enabled/payouts_enabled before processing payouts. |
| 9 | Payslip PDF generated (gross, deductions, net) for medic records | ‚úó FAILED | Database trigger creates payslips record (`021_payslip_generation.sql` line 40). `pdf_url` field exists BUT no Edge Function to generate PDF. Payslips exist in DB but no downloadable PDF. |
| 10 | Out-of-territory bookings calculate travel bonus (2/mile beyond 30 miles) vs room/board cost | ‚úì VERIFIED | `out-of-territory.ts` has `TRAVEL_BONUS_RATE = 2`, `FREE_TRAVEL_MILES = 30`, `ROOM_BOARD_FLAT_RATE = 150`. Calculator compares options and returns recommendation. |
| 11 | Admin sees cost breakdown and can approve/deny out-of-territory booking | ‚ö†Ô∏è PARTIAL | `out-of-territory-approval.tsx` (518 lines) has approval UI with cost breakdown. BUT component not wired into admin dashboard. No evidence of integration in booking workflow. Standalone component exists but unused. |
| 12 | System denies booking if out-of-territory cost >50% of shift cost (admin can override) | ‚úì VERIFIED | `out-of-territory.ts` has `DENIAL_THRESHOLD = 0.5` (line 102). `shouldDenyBooking()` function checks cost percentage. Recommendation set to 'deny' when threshold exceeded. Admin override limit at 75%. |

**Score:** 7/12 truths verified (5 failed, 3 partial)

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `web/lib/stripe/server.ts` | Stripe server client | ‚úì EXISTS | 17 lines. Exports `stripe` and `stripeSecretKey`. API version 2026-01-28.clover. |
| `web/app/api/payments/create-payment-intent/route.ts` | Payment Intent API with 3D Secure | ‚úì WIRED | 200+ lines. Uses `automatic_payment_methods`, creates Payment Intent, stores in payments table. |
| `supabase/functions/friday-payout/index.ts` | Friday payout Edge Function | ‚úì SUBSTANTIVE | 276 lines. Queries `payout_status='admin_approved'`, creates Stripe Transfers, updates timesheets. Has console.log statements but functional. |
| `supabase/migrations/021_friday_payout_cron.sql` | pg_cron job for Friday 9am | ‚úó STUB | Migration creates extension and table but does NOT schedule job. Comment says manual setup required. No automation. |
| `web/lib/payouts/calculator.ts` | Payout calculator with 60/40 split | ‚úì EXISTS | 64 lines. `calculatePayout()` returns medicPercentage: 60, platformPercentage: 40. |
| `supabase/functions/generate-invoice-pdf/index.ts` | Invoice PDF generator | ‚úì WIRED | 182 lines. Queries invoice, renders PDF with React-PDF, uploads to Storage. |
| `web/lib/invoices/late-fees.ts` | UK statutory late fee calculator | ‚úì EXISTS | Exports `calculateLateFee()` with ¬£40/¬£70/¬£100 thresholds. |
| `web/app/api/invoices/send-reminder/route.ts` | Late payment reminder API | ‚úó STUB | File exists but email sending is console.log (TODO comment). Not functional. |
| `web/lib/medics/ir35-validator.ts` | IR35 validation logic | ‚úì EXISTS | 72 lines. `validateUTR()`, `validateIR35Status()`, employment status checks. |
| `web/components/medics/ir35-form.tsx` | IR35 form component | ‚úì SUBSTANTIVE | 284 lines. Radio buttons for employment_status, UTR input, CEST upload. |
| `supabase/migrations/021_payslip_generation.sql` | Payslip table and trigger | ‚ö†Ô∏è PARTIAL | Creates table and trigger. Trigger inserts payslip on payout. BUT no PDF generation (pdf_url null). |
| `web/lib/bookings/out-of-territory.ts` | Cost calculator | ‚úì EXISTS | 123 lines. `calculateOutOfTerritoryCost()`, travel bonus, room/board, denial logic. |
| `web/components/admin/out-of-territory-approval.tsx` | Admin approval UI | ‚ö†Ô∏è ORPHANED | 518 lines. Component exists but NOT imported/used in admin dashboard. Standalone. |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| Payment Intent API | Stripe Payment Intent | `stripe.paymentIntents.create()` | ‚úì WIRED | Creates Payment Intent with 3D Secure enabled |
| PaymentForm component | Stripe Elements | `confirmPayment()` | ‚úì WIRED | Uses PaymentElement and confirms payment |
| friday-payout Edge Function | timesheets table | `payout_status='admin_approved'` | ‚úì WIRED | Queries admin-approved timesheets |
| friday-payout Edge Function | Stripe Transfer API | `stripe.transfers.create()` | ‚úì WIRED | Creates transfer to medic Express account |
| pg_cron job | friday-payout Edge Function | HTTP POST | ‚úó NOT_WIRED | Migration has SQL but job NOT scheduled |
| Invoice PDF generator | invoices table | SQL query with joins | ‚úì WIRED | Fetches invoice with line_items |
| Reminder API | Resend email | `resend.emails.send()` | ‚úó NOT_WIRED | Console.log stub, no actual email |
| pg_cron reminder job | Reminder API | HTTP POST | ‚úó NOT_WIRED | Migration has SQL but job NOT scheduled |
| IR35 form | IR35 assessment API | POST request | ‚úì WIRED | Submits employment_status, UTR, CEST data |
| Payslip trigger | payslips table | `timesheet.payout_status='paid'` | ‚úì WIRED | Auto-creates payslip record on payout |
| Out-of-territory calculator | Google Maps API | Distance Matrix | ‚úì WIRED | Calls API, caches results for 7 days |
| Out-of-territory approval | bookings table | UPDATE approved_by | ‚ö†Ô∏è PARTIAL | Component has logic but not used in workflow |

### Requirements Coverage

No specific requirements mapped to Phase 6.5 in REQUIREMENTS.md (decimal phase added after requirements mapping).

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| `send-reminder/route.ts` | ~85 | `console.log` instead of Resend email | üõë Blocker | Late payment reminders will NOT send emails |
| `friday-payout/index.ts` | 33,78,93,202,222 | Multiple `console.log` statements | ‚ö†Ô∏è Warning | Logging present but not critical |
| `friday-payout/index.ts` | 243 | `TODO: Send admin notification email` | ‚ö†Ô∏è Warning | No admin alerts on payout failures |
| `021_friday_payout_cron.sql` | 36 | Manual setup comment | üõë Blocker | Automation does NOT exist |
| `020_late_payment_reminders.sql` | Similar | Manual setup required | üõë Blocker | Automation does NOT exist |
| `payslip_generation.sql` | N/A | No PDF generation Edge Function | üõë Blocker | Payslips exist in DB but no PDF download |
| `out-of-territory-approval.tsx` | N/A | Component not imported anywhere | ‚ö†Ô∏è Warning | Dead code, not integrated |

### Migration Number Conflicts

**CRITICAL ISSUE:** Multiple migrations with same numbers:
- `020_late_payment_reminders.sql` (Phase 6.5-03)
- `020_riddor_deadline_cron.sql` (Phase 6, existing)
- `021_friday_payout_cron.sql` (Phase 6.5-02)
- `021_payslip_generation.sql` (Phase 6.5-04)

This will cause migration failures. Migrations must be renumbered sequentially: 020, 021, 022, 023.

### Gaps Summary

**5 critical gaps blocking goal achievement:**

1. **Friday payout automation does NOT exist**
   - Migration creates pg_cron extension but does NOT schedule the job
   - Manual Supabase Dashboard setup required (not documented)
   - Payouts will never run automatically without manual intervention

2. **Late payment reminders do NOT send emails**
   - Email API stubbed with console.log
   - Resend integration not implemented
   - pg_cron job not scheduled
   - Late payment automation completely non-functional

3. **Payslip PDFs do NOT generate**
   - Database trigger creates record but pdf_url remains null
   - No Edge Function to generate PDF
   - Medics cannot download payslips

4. **Platform fee calculation WRONG**
   - Roadmap specifies: medic 30/hr, client 42/hr, platform 12/hr (28.6% platform fee)
   - Implementation uses: 60% medic, 40% platform
   - Arithmetic mismatch will cause revenue loss

5. **Out-of-territory approval NOT integrated**
   - Components exist but not wired into booking workflow
   - No automatic calculation during booking creation
   - Admin approval UI orphaned

**3 partial implementations:**

1. **UK Faster Payments not validated**
   - Stripe Transfer API called but no GB bank account verification
   - Would fail at runtime for non-GB accounts

2. **Stripe onboarding completion not enforced**
   - No webhook to capture account.updated events
   - No blocking of payouts for incomplete onboarding

3. **Migration numbering conflicts**
   - Duplicate migration numbers will cause deployment failures
   - Needs renumbering: 019 ‚Üí 023 sequential

---

_Verified: 2026-02-16T21:55:00Z_
_Verifier: Claude (gsd-verifier)_
