---
phase: 06.5-payments-payouts
verified: 2026-02-16T23:00:00Z
status: gaps_found
score: 10/12 must-haves verified
re_verification:
  previous_status: gaps_found
  previous_score: 7/12
  gaps_closed:
    - "Platform fee calculation correct (71.4/28.6)"
    - "Late payment auto-reminders send emails (Resend API integrated)"
    - "Friday payout job runs automatically (pg_cron scheduled)"
  gaps_remaining:
    - "Payslip PDF generation incomplete (missing payslip_reference field)"
    - "Late payment cron uses wrong auth pattern (current_setting vs vault)"
  regressions: []

gaps:
  - truth: "Payslip PDF generated (gross, deductions, net) for medic records"
    status: partial
    reason: "Edge Function exists and can generate PDFs, BUT payslips table missing payslip_reference field that Edge Function expects (line 107 in index.ts)"
    artifacts:
      - path: "supabase/migrations/024_payslip_generation.sql"
        issue: "Table schema missing payslip_reference TEXT field"
      - path: "supabase/functions/generate-payslip-pdf/index.ts"
        issue: "Line 107 reads payslip.payslip_reference but field doesn't exist in database"
    missing:
      - "ALTER TABLE payslips ADD COLUMN payslip_reference TEXT UNIQUE NOT NULL DEFAULT gen_random_uuid()::text;"
      - "Edge Function needs to be called after payslip creation (trigger or manual invocation)"
  
  - truth: "Late payment auto-reminders send at 7, 14, 21 days with statutory late fees (40-100)"
    status: partial
    reason: "Migration 020 uses current_setting() auth pattern, NOT vault.decrypted_secrets like other crons (inconsistent pattern, may fail in production)"
    artifacts:
      - path: "supabase/migrations/020_late_payment_reminders.sql"
        issue: "Lines 22-23 use current_setting('app.supabase_url') instead of vault.decrypted_secrets pattern used by migration 022 (friday-payout) and 021 (RIDDOR)"
    missing:
      - "Update migration 020 to use vault.decrypted_secrets pattern for consistency"
      - "Remove current_setting() approach which requires manual env var config"
---

# Phase 6.5: Payment Processing & Payouts Re-Verification Report

**Phase Goal:** Full payment processing operational with client charging (card + Net 30), automated weekly medic payouts via UK Faster Payments, IR35 compliance, and out-of-territory cost management.

**Verified:** 2026-02-16T23:00:00Z
**Status:** gaps_found
**Re-verification:** Yes ‚Äî after gap closure (plans 06.5-06 through 06.5-10)

## Re-Verification Summary

**Previous Status:** gaps_found (7/12 must-haves verified)
**Current Status:** gaps_found (10/12 must-haves verified)
**Progress:** 3 critical gaps closed, 2 partial gaps remain

### Gaps Closed ‚úÖ

1. **Platform fee calculation (Gap #4)** ‚Äî FIXED
   - Calculator now uses 71.4% medic, 28.6% platform (was 60/40)
   - Friday payout validation updated to 71.4%
   - Arithmetic matches roadmap: ¬£30 medic / ¬£42 client

2. **Late payment emails (Gap #6)** ‚Äî FIXED
   - Resend API integration complete with HTML templates
   - Email sending no longer stubbed (console.log removed)
   - Late fee calculation and escalation warnings functional

3. **Friday payout automation (Gap #2)** ‚Äî FIXED
   - Migration 022 now schedules pg_cron job with SELECT cron.schedule()
   - Uses vault.decrypted_secrets pattern for auth (consistent with RIDDOR cron)
   - No manual setup required

### Gaps Remaining ‚ö†Ô∏è

1. **Payslip PDF generation (Gap #9)** ‚Äî PARTIAL (was FAILED)
   - Edge Function exists and substantive (185 lines)
   - PayslipDocument React-PDF template complete (129 lines)
   - BUT: Database table missing `payslip_reference` field
   - Edge Function line 107 reads `payslip.payslip_reference` ‚Üí will fail at runtime
   - PDF generation trigger not wired (manual invocation required)

2. **Late payment cron auth pattern (Gap #6 follow-up)** ‚Äî PARTIAL
   - Migration 020 uses `current_setting()` for auth (lines 22-23)
   - Other crons use `vault.decrypted_secrets` (migrations 021, 022)
   - Inconsistent pattern may cause production failures
   - Manual env var config required vs vault secrets

### No Regressions

All previously passing must-haves still pass. No degradation detected.

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Client payment processing works (card charge via Stripe Payment Intent with 3D Secure) | ‚úì VERIFIED | No change from previous verification. Payment Intent API at `web/app/api/payments/create-payment-intent/route.ts` functional. |
| 2 | Friday payout job runs automatically (zero failures, every Friday at 9am) | ‚úì VERIFIED | **FIXED** - Migration 022 line 45 has `SELECT cron.schedule('friday-medic-payouts', '0 9 * * 5', ...)`. Uses vault.decrypted_secrets (lines 50, 54). Automation complete. |
| 3 | Medics receive funds within 2 business days via UK Faster Payments | ‚úì VERIFIED | **FIXED** - GB bank validation added at lines 145-161 in `friday-payout/index.ts`. Checks `account.country === 'GB'` and `account.payouts_enabled` before transfer. |
| 4 | Platform fee calculation correct (medic 30/hr -> client 42/hr -> platform 12/hr) | ‚úì VERIFIED | **FIXED** - `calculator.ts` lines 31-32 now use 71.4% medic, 28.6% platform. Friday payout validation line 191 uses 71.4%. Arithmetic correct. |
| 5 | Invoice PDF generated with VAT (20%) and Net 30 terms for established clients | ‚úì VERIFIED | No change from previous verification. Invoice PDF generation functional. |
| 6 | Late payment auto-reminders send at 7, 14, 21 days with statutory late fees (40-100) | ‚ö†Ô∏è PARTIAL | **MOSTLY FIXED** - Resend API integrated (send-reminder/route.ts line 126). HTML email template complete (lines 130-157). BUT migration 020 uses `current_setting()` auth (lines 22-23) instead of vault pattern. Cron scheduled (line 11) but may fail in production due to auth pattern mismatch. |
| 7 | Medic onboarding captures IR35 status (self-employed vs umbrella company) | ‚úì VERIFIED | No change from previous verification. IR35 form and validation functional. |
| 8 | Stripe Express account onboarding link works (medic completes bank details) | ‚úì VERIFIED | **FIXED** - Webhook handler added for `account.updated` events (webhooks/route.ts lines 125-158). Database `stripe_onboarding_complete` flag synced when `charges_enabled && payouts_enabled && details_submitted`. |
| 9 | Payslip PDF generated (gross, deductions, net) for medic records | ‚ö†Ô∏è PARTIAL | **PARTIAL FIX** - Edge Function exists (185 lines) with PayslipDocument component (129 lines). BUT table schema missing `payslip_reference` field (migration 024 lines 6-33). Edge Function line 107 expects field ‚Üí runtime failure. No trigger to call Edge Function after payslip creation. |
| 10 | Out-of-territory bookings calculate travel bonus (2/mile beyond 30 miles) vs room/board cost | ‚úì VERIFIED | No change from previous verification. Cost calculator functional. |
| 11 | Admin sees cost breakdown and can approve/deny out-of-territory booking | ‚úì VERIFIED | **FIXED** - OutOfTerritoryApproval component wired into booking-approval-table.tsx (line 34 import, line 104 state, lines 386-422 Territory column, lines 869-887 modal). "Review Cost" button triggers modal. Query invalidation on close. |
| 12 | System denies booking if out-of-territory cost >50% of shift cost (admin can override) | ‚úì VERIFIED | No change from previous verification. Denial logic functional. |

**Score:** 10/12 truths verified (2 partial, 0 failed)

### Required Artifacts

| Artifact | Expected | Status | Re-Verification Notes |
|----------|----------|--------|----------------------|
| `web/lib/payouts/calculator.ts` | Payout calculator with 71.4/28.6 split | ‚úì VERIFIED | **FIXED** - Lines 31-32 now use correct percentages. 69 lines, substantive. |
| `supabase/functions/friday-payout/index.ts` | Friday payout Edge Function | ‚úì VERIFIED | **ENHANCED** - GB validation added (lines 145-175). 320 lines, substantive. |
| `supabase/migrations/022_friday_payout_cron.sql` | pg_cron job for Friday 9am | ‚úì VERIFIED | **FIXED** - Renumbered from 021 to 022. Line 45 schedules cron job. Uses vault pattern (lines 50, 54). |
| `web/app/api/invoices/send-reminder/route.ts` | Late payment reminder API | ‚úì VERIFIED | **FIXED** - Resend integration added (line 126). HTML template (lines 130-157). 225 lines, substantive. |
| `supabase/migrations/020_late_payment_reminders.sql` | pg_cron late payment job | ‚ö†Ô∏è PARTIAL | Cron scheduled (line 11) BUT uses `current_setting()` auth (lines 22-23) instead of vault pattern. Inconsistent with other crons. |
| `supabase/functions/generate-payslip-pdf/index.ts` | Payslip PDF generator | ‚ö†Ô∏è PARTIAL | Edge Function exists (185 lines) BUT expects `payslip_reference` field (line 107) that doesn't exist in table schema. |
| `supabase/migrations/024_payslip_generation.sql` | Payslip table and trigger | ‚ö†Ô∏è PARTIAL | Table created (lines 6-33), trigger functional (lines 87-90) BUT missing `payslip_reference` field. No Edge Function invocation. |
| `web/app/api/stripe/webhooks/route.ts` | Stripe webhook handler | ‚úì VERIFIED | **ENHANCED** - `account.updated` handler added (lines 125-158). Syncs onboarding completion flags. 172 lines, substantive. |
| `web/components/admin/booking-approval-table.tsx` | Admin booking approval UI | ‚úì VERIFIED | **ENHANCED** - OutOfTerritoryApproval wired (line 34 import, line 104 state, lines 386-422 Territory column, modal at lines 869-887). |

### Key Link Verification

| From | To | Via | Status | Re-Verification Notes |
|------|----|----|--------|----------------------|
| friday-payout Edge Function | Stripe Transfer API | `stripe.transfers.create()` | ‚úì WIRED | **ENHANCED** - Now validates GB country before transfer (lines 145-161) |
| pg_cron job (022) | friday-payout Edge Function | HTTP POST via pg_net | ‚úì WIRED | **FIXED** - Cron scheduled in migration, uses vault secrets |
| Reminder API | Resend email | `resend.emails.send()` | ‚úì WIRED | **FIXED** - Real email sending (line 126), HTML template (lines 130-157) |
| pg_cron job (020) | Reminder API | HTTP POST via pg_net | ‚ö†Ô∏è PARTIAL | Cron scheduled BUT uses current_setting() auth (may fail in production) |
| Payslip trigger | payslips table | `timesheet.payout_status='paid'` | ‚úì WIRED | Trigger creates payslip record (migration 024 lines 87-90) |
| Payslip trigger | PDF Edge Function | ??? | ‚úó NOT_WIRED | Trigger does NOT call Edge Function. pdf_url remains null. Manual invocation required. |
| Stripe webhook | medics table | UPDATE stripe_onboarding_complete | ‚úì WIRED | **FIXED** - account.updated handler syncs flag (webhooks/route.ts lines 142-147) |
| OutOfTerritoryApproval | booking-approval-table | Modal overlay | ‚úì WIRED | **FIXED** - Component imported and rendered in modal (lines 869-887) |

### Anti-Patterns Found

| File | Line | Pattern | Severity | Re-Verification Status |
|------|------|---------|----------|------------------------|
| `024_payslip_generation.sql` | 6-33 | Missing payslip_reference field | üõë Blocker | **NEW ISSUE** - Edge Function expects field that doesn't exist |
| `020_late_payment_reminders.sql` | 22-23 | current_setting() auth pattern | ‚ö†Ô∏è Warning | **NEW ISSUE** - Inconsistent with vault pattern used by other crons |
| `024_payslip_generation.sql` | 87-90 | Trigger doesn't call Edge Function | üõë Blocker | **NEW ISSUE** - pdf_url will remain null, no PDF generated |

### Previous Anti-Patterns Resolved

| File | Pattern | Resolution |
|------|---------|------------|
| `send-reminder/route.ts` | console.log stub | **RESOLVED** - Resend API integrated (line 126) |
| `021_friday_payout_cron.sql` | Manual setup comment | **RESOLVED** - Renumbered to 022, cron scheduled (line 45) |
| `calculator.ts` | 60/40 split | **RESOLVED** - Updated to 71.4/28.6 (lines 31-32) |
| `out-of-territory-approval.tsx` | Component not imported | **RESOLVED** - Wired into booking-approval-table.tsx (line 34) |

### Migration Numbering

**Previous Issue:** Duplicate migration numbers (020, 021 conflicts)

**Current Status:** RESOLVED
- 020_late_payment_reminders.sql
- 021_riddor_deadline_cron.sql (existing)
- 022_friday_payout_cron.sql (renumbered from 021)
- 023_out_of_territory_rules.sql
- 024_payslip_generation.sql (renumbered from 021)

Sequential numbering now correct.

## Gaps Summary

**2 gaps blocking full goal achievement:**

### Gap 1: Payslip PDF Generation Schema Mismatch

**Impact:** Payslip records created but PDFs never generated

**Root Cause:** Database schema and Edge Function out of sync

**Evidence:**
- `supabase/functions/generate-payslip-pdf/index.ts` line 107 reads `payslip.payslip_reference`
- `supabase/migrations/024_payslip_generation.sql` table schema (lines 6-33) has no `payslip_reference` field
- Edge Function expects field for PDF filename generation

**What's Missing:**
1. Add `payslip_reference TEXT UNIQUE NOT NULL DEFAULT gen_random_uuid()::text` to payslips table
2. Wire trigger to call Edge Function after payslip creation (or use pg_net HTTP POST)
3. Alternative: Call Edge Function manually from admin dashboard

**Workaround:** Admin can manually invoke Edge Function via API for each payslip

### Gap 2: Late Payment Cron Auth Pattern Inconsistency

**Impact:** Late payment reminders may fail in production due to auth pattern mismatch

**Root Cause:** Migration 020 uses different auth approach than other crons

**Evidence:**
- Migration 020 lines 22-23: `current_setting('app.supabase_url')` and `current_setting('app.service_role_key')`
- Migration 022 lines 50, 54: `vault.decrypted_secrets WHERE name = 'project_url'` and `'service_role_key'`
- Migration 021 (RIDDOR) also uses vault pattern

**What's Missing:**
1. Update migration 020 to use `vault.decrypted_secrets` pattern
2. Remove `current_setting()` approach which requires manual env var configuration

**Workaround:** Set app.supabase_url and app.service_role_key in Supabase Dashboard Settings

## Next Steps

1. **Fix payslip_reference schema gap** (5-10 min task)
   - Add migration: `ALTER TABLE payslips ADD COLUMN payslip_reference TEXT UNIQUE NOT NULL DEFAULT ('PS-' || to_char(NOW(), 'YYYYMMDD') || '-' || substr(md5(random()::text), 1, 8));`
   - Wire trigger to call Edge Function after insert

2. **Align late payment cron auth** (2-5 min task)
   - Update migration 020 to use vault.decrypted_secrets pattern
   - Match auth approach used by migrations 021 and 022

## Human Verification Required

### 1. Test Friday Payout End-to-End

**Test:** Trigger Friday payout Edge Function manually (or wait for Friday 9am)
**Expected:** 
- Medics with admin_approved timesheets receive Stripe Transfer
- Non-GB accounts skipped with error logged
- Payout execution record created in payout_executions table

**Why human:** Requires live Stripe test accounts and simulated booking/timesheet data

### 2. Test Late Payment Email Delivery

**Test:** Create test invoice, set due_date to 7 days ago, trigger reminder API
**Expected:**
- Email received at invoice.client.contact_email
- HTML template renders correctly in Gmail/Outlook
- Late fee calculation accurate (¬£40 base + 0.5% per day)

**Why human:** Requires email client verification and visual inspection

### 3. Test Stripe Onboarding Webhook

**Test:** Complete medic Stripe Express onboarding via Stripe test mode
**Expected:**
- account.updated webhook received
- Database stripe_onboarding_complete flag updates to true
- Webhook logs show event processed

**Why human:** Requires Stripe Dashboard interaction and webhook monitoring

### 4. Test Out-of-Territory Approval Workflow

**Test:** Create booking requiring manual approval, open admin dashboard
**Expected:**
- Territory column shows "Pending Review"
- "Review Cost" button opens modal with cost breakdown
- Admin can approve/deny, booking status updates

**Why human:** Requires admin UI interaction and visual verification

---

_Verified: 2026-02-16T23:00:00Z_
_Verifier: Claude (gsd-verifier)_
_Re-verification: Yes (after gap closure plans 06.5-06 through 06.5-10)_
