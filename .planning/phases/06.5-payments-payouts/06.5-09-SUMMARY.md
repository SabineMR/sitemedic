---
phase: 06.5-payments-payouts
plan: 09
subsystem: payments
tags: [stripe, webhooks, onboarding, payouts, validation, gb-accounts, uk-faster-payments]

# Dependency graph
requires:
  - phase: 04.5-marketing-booking
    provides: Stripe webhook handler for payment_intent events
  - phase: 06.5-02
    provides: Friday payout Edge Function with Stripe Transfer API

provides:
  - account.updated webhook handler syncing medic Stripe onboarding status to database
  - GB bank account validation before payout transfers
  - Stripe account country and payouts_enabled verification
  - Automatic stripe_onboarding_complete flag updates

affects: [medic-payouts, admin-operations, stripe-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Stripe webhook event handling for account.updated events"
    - "Stripe Account API validation before transfer execution"
    - "GB country requirement for UK Faster Payments"
    - "Batch processing resilience (skip non-GB, continue others)"

key-files:
  created: []
  modified:
    - web/app/api/stripe/webhooks/route.ts
    - supabase/functions/friday-payout/index.ts

key-decisions:
  - "Stripe onboarding complete when charges_enabled + payouts_enabled + details_submitted all true"
  - "Validate account.country === 'GB' before Stripe Transfer (UK Faster Payments requirement)"
  - "Skip non-GB accounts with detailed error logging rather than failing entire batch"
  - "Double-check payouts_enabled at transfer time (catch race conditions)"

patterns-established:
  - "Webhook handler pattern: check event data presence, update database, log status changes"
  - "Pre-transfer validation: retrieve full Stripe account, validate country and capabilities"
  - "Batch resilience: skip invalid accounts with error tracking, continue processing others"

# Metrics
duration: 2min
completed: 2026-02-16
---

# Phase 06.5-09: Stripe Onboarding Webhook & GB Validation Summary

**Stripe account.updated webhook handler syncing medic onboarding status and GB bank account validation preventing non-UK payout transfer failures**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-16T22:32:03Z
- **Completed:** 2026-02-16T22:33:48Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Stripe account.updated webhook captures onboarding completion events automatically
- Database stripe_onboarding_complete flag synced based on charges_enabled + payouts_enabled + details_submitted
- Friday payout Edge Function validates account.country === 'GB' before transfer
- Non-GB accounts gracefully skipped with detailed error logging
- Payouts_enabled double-checked at transfer time to catch race conditions

## Task Commits

Each task was committed atomically:

1. **Task 1: Add account.updated webhook handler to Stripe webhooks** - `bd786fb` (feat)
2. **Task 2: Add GB bank account validation to Friday payout Edge Function** - `d8b21d8` (feat)

## Files Created/Modified

### Modified

- **web/app/api/stripe/webhooks/route.ts** - Added account.updated event handler to sync medic onboarding status (charges_enabled, payouts_enabled, details_submitted)
- **supabase/functions/friday-payout/index.ts** - Added Stripe account retrieval and GB country validation before transfer execution

## Decisions Made

1. **Onboarding completion criteria:** Medic onboarding complete when all three flags true: charges_enabled + payouts_enabled + details_submitted (Stripe Express standard)

2. **GB country requirement:** Validate account.country === 'GB' before Stripe Transfer because UK Faster Payments only works with GB bank accounts

3. **Batch resilience:** Skip non-GB accounts with detailed error logging rather than failing entire payout batch (preserves weekly automation)

4. **Double-check payouts_enabled:** Even though database has stripe_onboarding_complete flag, retrieve fresh account at transfer time to catch any Stripe-side changes (race condition protection)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - webhook handler and GB validation added without issues.

## User Setup Required

**Stripe Webhook Configuration:**

The account.updated event must be enabled in the Stripe Dashboard webhook settings:

1. Navigate to Stripe Dashboard > Developers > Webhooks
2. Find your production webhook endpoint (https://yourdomain.com/api/stripe/webhooks)
3. Click "Add events"
4. Search for and enable: `account.updated`
5. Save configuration

**Verification:**

After adding account.updated event:

1. Complete a medic's Stripe Express onboarding via Stripe Dashboard (test mode)
2. Check webhook logs in Stripe Dashboard for account.updated event
3. Verify medic's `stripe_onboarding_complete` flag updated in database:
   ```sql
   SELECT email, stripe_onboarding_complete, stripe_account_id
   FROM medics
   WHERE stripe_account_id IS NOT NULL;
   ```

**GB Account Testing:**

Test the Friday payout validation:

1. Set a medic's Stripe account country to non-GB (e.g., 'US') via Stripe Dashboard test mode
2. Trigger Friday payout Edge Function manually
3. Verify timesheet skipped with error: "Stripe account country is US (expected GB for UK Faster Payments)"
4. Check other medics' payouts processed successfully (batch resilience)

## Next Phase Readiness

**Ready for:**
- Phase 07: Financial reporting and reconciliation (payout validation enhanced)
- Admin operations: Payout errors clearly logged for manual review
- Medic onboarding: Automatic status tracking without manual database updates

**Available:**
- Stripe webhook pattern for other account events (account.external_account.created, etc.)
- Account validation pattern for other compliance checks
- Batch processing resilience pattern for other background jobs

**No blockers.**

**Notes:**
- Medics with non-GB Stripe accounts will need to update their bank details to GB accounts
- Stripe onboarding status syncs automatically - no admin intervention needed
- Weekly payouts will skip medics until GB bank account added and verified

---
*Phase: 06.5-payments-payouts*
*Completed: 2026-02-16*
