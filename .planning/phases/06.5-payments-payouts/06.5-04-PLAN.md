---
phase: 06.5-payments-payouts
plan: 04
type: execute
wave: 2
depends_on: ["06.5-02"]
files_modified:
  - web/app/(dashboard)/admin/medics/onboarding/[id]/page.tsx
  - web/app/api/medics/ir35-assessment/route.ts
  - web/components/medics/ir35-form.tsx
  - web/components/medics/stripe-onboarding-status.tsx
  - web/lib/medics/ir35-validator.ts
  - supabase/migrations/021_payslip_generation.sql
autonomous: true

must_haves:
  truths:
    - "Medic onboarding captures IR35 status (self_employed vs umbrella company)"
    - "Stripe Express account onboarding link works (medic completes bank details)"
    - "CEST assessment result uploaded and stored in Supabase Storage"
    - "Payslip PDF generated (gross, deductions, net) for medic records"
    - "UTR (Unique Taxpayer Reference) collected for self-employed medics"
  artifacts:
    - path: "web/lib/medics/ir35-validator.ts"
      provides: "IR35 validation logic and CEST assessment checker"
      exports: ["validateIR35Status", "requiresCESTAssessment"]
    - path: "web/components/medics/ir35-form.tsx"
      provides: "React component for IR35 status form"
      contains: "IR35Form"
    - path: "web/app/api/medics/ir35-assessment/route.ts"
      provides: "API endpoint for IR35 assessment upload and validation"
      exports: ["POST"]
    - path: "web/components/medics/stripe-onboarding-status.tsx"
      provides: "Component showing Stripe Express account onboarding progress"
      contains: "StripeOnboardingStatus"
    - path: "supabase/migrations/021_payslip_generation.sql"
      provides: "Payslip generation function and template"
      exports: []
  key_links:
    - from: "web/app/api/medics/ir35-assessment/route.ts"
      to: "medics table"
      via: "updates IR35 fields (employment_status, utr, cest_assessment_result)"
      pattern: "medics.*update"
    - from: "web/components/medics/stripe-onboarding-status.tsx"
      to: "supabase/functions/stripe-connect"
      via: "checks Stripe account status"
      pattern: "check_account_status"
    - from: "supabase/migrations/021_payslip_generation.sql"
      to: "timesheets table"
      via: "generates payslip from timesheet data"
      pattern: "timesheets.*paid_at"
---

<objective>
Create IR35 compliance system with medic onboarding flow, Stripe Express account setup, CEST assessment collection, UTR validation, and payslip PDF generation.

Purpose: All medics must complete IR35 assessment before receiving payouts. The system collects employment status (self-employed contractor vs umbrella company), validates Unique Taxpayer Reference (UTR) for self-employed, stores HMRC CEST assessment results, and integrates with Stripe Express for bank account setup. Payslips are auto-generated for each payout.

Output: IR35 onboarding form, Stripe onboarding integration, CEST assessment uploader, payslip generator, and admin validation dashboard.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/002_business_operations.sql
@supabase/functions/stripe-connect/index.ts
@.planning/phases/01.5-business-foundation/01.5-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IR35 validator and assessment form</name>
  <files>
    web/lib/medics/ir35-validator.ts
    web/components/medics/ir35-form.tsx
  </files>
  <action>
**web/lib/medics/ir35-validator.ts** — IR35 validation logic:
```typescript
export type EmploymentStatus = 'self_employed' | 'umbrella';

export interface IR35Assessment {
  employment_status: EmploymentStatus;
  utr?: string; // Required for self_employed
  umbrella_company_name?: string; // Required for umbrella
  cest_assessment_result?: string; // 'outside_ir35' | 'inside_ir35' | 'unknown'
  cest_assessment_date?: string;
  cest_pdf_url?: string;
}

// Validate UTR format (10 digits, with optional spaces)
export function validateUTR(utr: string): boolean {
  const cleaned = utr.replace(/\s/g, '');
  return /^\d{10}$/.test(cleaned);
}

// Check if CEST assessment is required
export function requiresCESTAssessment(employment_status: EmploymentStatus): boolean {
  return employment_status === 'self_employed';
}

// Validate IR35 status completeness
export function validateIR35Status(data: IR35Assessment): {
  valid: boolean;
  errors: string[];
} {
  const errors: string[] = [];

  if (!data.employment_status) {
    errors.push('Employment status is required');
  }

  if (data.employment_status === 'self_employed') {
    if (!data.utr) {
      errors.push('UTR is required for self-employed contractors');
    } else if (!validateUTR(data.utr)) {
      errors.push('Invalid UTR format (must be 10 digits)');
    }

    // CEST assessment recommended but not strictly required
    if (!data.cest_assessment_result) {
      errors.push('HMRC CEST assessment is strongly recommended for IR35 compliance');
    }
  }

  if (data.employment_status === 'umbrella') {
    if (!data.umbrella_company_name) {
      errors.push('Umbrella company name is required');
    }
  }

  return {
    valid: errors.length === 0,
    errors,
  };
}

// Calculate deductions (simplified - umbrella companies handle this)
export function calculateDeductions(grossPay: number, employment_status: EmploymentStatus): {
  gross: number;
  tax: number;
  ni: number;
  net: number;
} {
  if (employment_status === 'umbrella') {
    // Umbrella company handles deductions
    return { gross: grossPay, tax: 0, ni: 0, net: grossPay };
  }

  // Self-employed: no deductions (medic responsible for own taxes)
  return { gross: grossPay, tax: 0, ni: 0, net: grossPay };
}
```

**web/components/medics/ir35-form.tsx** — 'use client' component:
- Props: `{ medicId: string, onComplete: () => void }`
- Form fields:
  - Employment status radio buttons:
    - Self-employed contractor (default)
    - Umbrella company employee
  - If self_employed:
    - UTR input (10 digits with validation)
    - CEST assessment upload:
      - File picker for PDF
      - Or manual entry: radio buttons (Outside IR35, Inside IR35, Unknown)
      - Assessment date picker
    - Information box: "You are responsible for your own tax and National Insurance. SiteMedic will issue gross payments only."
  - If umbrella:
    - Umbrella company name input
    - Information box: "Your umbrella company will handle tax and NI deductions. Payouts will be sent to your company's account."
- Validation:
  - Call validateIR35Status on submit
  - Display inline errors for invalid fields
- Submit handler:
  - Upload CEST PDF to Supabase Storage if provided: `ir35-assessments/{medic_id}-{timestamp}.pdf`
  - POST /api/medics/ir35-assessment with form data
  - On success: call onComplete()
- Styling: Clean form with clear labels and help text
  </action>
  <verify>
Run: `ls web/lib/medics/ir35-validator.ts` confirms validator exists.
Run: `grep "validateUTR" web/lib/medics/ir35-validator.ts` confirms UTR validation.
Run: `ls web/components/medics/ir35-form.tsx` confirms form component.
Run: `grep "employment_status" web/components/medics/ir35-form.tsx` confirms field.
  </verify>
  <done>
IR35 validator checks employment status, validates UTR format for self-employed, and ensures completeness. IR35 form collects status, UTR, CEST assessment, and umbrella company details with inline validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe onboarding integration and IR35 API</name>
  <files>
    web/app/api/medics/ir35-assessment/route.ts
    web/components/medics/stripe-onboarding-status.tsx
  </files>
  <action>
**web/app/api/medics/ir35-assessment/route.ts** — POST endpoint:
- Accept: `{ medicId: string, employment_status, utr?, umbrella_company_name?, cest_assessment_result?, cest_assessment_date?, cest_pdf_url? }`
- Validate user is the medic or admin
- Validate IR35 data using validateIR35Status
- If invalid: return 400 with errors
- Update medics table:
  ```typescript
  {
    employment_status,
    utr: employment_status === 'self_employed' ? utr : null,
    umbrella_company_name: employment_status === 'umbrella' ? umbrella_company_name : null,
    cest_assessment_result,
    cest_assessment_date,
    cest_pdf_url,
    updated_at: NOW(),
  }
  ```
- If Stripe account doesn't exist yet: create Express account
  - Call supabase.functions.invoke('stripe-connect', { action: 'create_express_account', medic_id, email, first_name, last_name })
  - Store stripe_account_id and stripe_onboarding_url
- Log IR35 assessment completion event
- Return: `{ success: true, stripe_onboarding_url }`

**web/components/medics/stripe-onboarding-status.tsx** — 'use client' component:
- Props: `{ medicId: string }`
- Fetch medic data including stripe_account_id and stripe_onboarding_complete
- Display onboarding status:
  - **Not Started**: "Set up your payout account" button
    - Calls /api/medics/ir35-assessment to create Express account
    - Opens stripe_onboarding_url in new tab
  - **In Progress**: "Complete Stripe onboarding" button with warning icon
    - "You need to complete bank account details before receiving payouts"
    - Shows last update timestamp
    - "Continue onboarding" link
  - **Complete**: Green checkmark "Payout account active"
    - Shows bank account last 4 digits (masked)
    - Shows account status: charges_enabled, payouts_enabled
- Auto-refresh every 30 seconds to check for completion
- Call /api/medics/check-stripe-status endpoint:
  - Wraps supabase.functions.invoke('stripe-connect', { action: 'check_account_status', stripe_account_id })
  - Updates medics table with latest status
  </action>
  <verify>
Run: `ls web/app/api/medics/ir35-assessment/route.ts` confirms IR35 API.
Run: `grep "validateIR35Status" web/app/api/medics/ir35-assessment/route.ts` confirms validation.
Run: `ls web/components/medics/stripe-onboarding-status.tsx` confirms status component.
Run: `grep "stripe_onboarding_url" web/components/medics/stripe-onboarding-status.tsx` confirms link.
  </verify>
  <done>
IR35 assessment API validates and stores employment status, creates Stripe Express account if needed, and returns onboarding URL. Stripe onboarding status component shows progress and completion state with auto-refresh.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create payslip generator and onboarding page</name>
  <files>
    supabase/migrations/021_payslip_generation.sql
    web/app/(dashboard)/admin/medics/onboarding/[id]/page.tsx
  </files>
  <action>
**supabase/migrations/021_payslip_generation.sql** — Payslip generation:
```sql
-- Migration 021: Payslip Generation
-- Auto-generate payslips for medic payouts

-- Payslips table
CREATE TABLE IF NOT EXISTS payslips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  timesheet_id UUID NOT NULL REFERENCES timesheets(id) ON DELETE CASCADE,
  medic_id UUID NOT NULL REFERENCES medics(id) ON DELETE CASCADE,

  -- Pay period
  pay_period_start DATE NOT NULL,
  pay_period_end DATE NOT NULL,
  payment_date DATE NOT NULL,

  -- Amounts (in GBP)
  gross_pay DECIMAL(10,2) NOT NULL,
  tax_deducted DECIMAL(10,2) DEFAULT 0,
  ni_deducted DECIMAL(10,2) DEFAULT 0,
  net_pay DECIMAL(10,2) NOT NULL,

  -- Employment details
  employment_status TEXT NOT NULL, -- From medics.employment_status
  utr TEXT, -- For self-employed
  umbrella_company_name TEXT, -- For umbrella

  -- PDF
  pdf_url TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT valid_employment_status CHECK (employment_status IN ('self_employed', 'umbrella'))
);

CREATE INDEX idx_payslips_timesheet ON payslips(timesheet_id);
CREATE INDEX idx_payslips_medic ON payslips(medic_id);
CREATE INDEX idx_payslips_payment_date ON payslips(payment_date DESC);

-- Function to auto-generate payslip when timesheet is paid
CREATE OR REPLACE FUNCTION generate_payslip_on_payout()
RETURNS TRIGGER AS $$
DECLARE
  medic_record RECORD;
BEGIN
  -- Only trigger when payout_status changes to 'paid'
  IF NEW.payout_status = 'paid' AND OLD.payout_status != 'paid' THEN
    -- Fetch medic employment details
    SELECT employment_status, utr, umbrella_company_name
    INTO medic_record
    FROM medics
    WHERE id = NEW.medic_id;

    -- Insert payslip record
    INSERT INTO payslips (
      timesheet_id,
      medic_id,
      pay_period_start,
      pay_period_end,
      payment_date,
      gross_pay,
      tax_deducted,
      ni_deducted,
      net_pay,
      employment_status,
      utr,
      umbrella_company_name
    ) VALUES (
      NEW.id,
      NEW.medic_id,
      (SELECT shift_date FROM bookings WHERE id = NEW.booking_id),
      (SELECT shift_date FROM bookings WHERE id = NEW.booking_id),
      CURRENT_DATE,
      NEW.payout_amount,
      0, -- Self-employed: no deductions (medic handles own tax)
      0, -- Self-employed: no NI deductions
      NEW.payout_amount,
      medic_record.employment_status,
      medic_record.utr,
      medic_record.umbrella_company_name
    );
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_generate_payslip_on_payout
  AFTER UPDATE ON timesheets
  FOR EACH ROW
  EXECUTE FUNCTION generate_payslip_on_payout();

COMMENT ON TABLE payslips IS 'Auto-generated payslips for medic payouts with IR35 compliance details';
COMMENT ON FUNCTION generate_payslip_on_payout IS 'Trigger: Creates payslip record when timesheet.payout_status changes to paid';
```

**web/app/(dashboard)/admin/medics/onboarding/[id]/page.tsx** — Admin medic onboarding page:
- Fetch medic data with IR35 and Stripe status
- Display onboarding checklist:
  1. ✅/❌ Personal details (name, email, phone, address)
  2. ✅/❌ Qualifications (certifications, confined space, trauma)
  3. ✅/❌ IR35 status (employment_status, UTR/umbrella company)
  4. ✅/❌ Stripe Express account (onboarding complete)
  5. ✅/❌ Ready for payouts (all above complete)
- Sections:
  - **Personal Info**: Read-only display with edit button
  - **Qualifications**: List of certifications with expiry dates
  - **IR35 Compliance**:
    - If not complete: Show IR35Form component
    - If complete: Show status summary with CEST assessment link
    - Download CEST PDF button if uploaded
  - **Payout Setup**:
    - Show StripeOnboardingStatus component
    - Display bank account details when complete
  - **Payslip History**:
    - Table of past payslips with download links
    - Columns: pay period, gross, deductions, net, PDF
- Admin actions:
  - "Approve for work" button (enables available_for_work flag)
  - "Suspend" button with reason input
  - "View payout history" link
- Validation messages for incomplete sections
  </action>
  <verify>
Run: `ls supabase/migrations/021_payslip_generation.sql` confirms migration.
Run: `grep "payslips" supabase/migrations/021_payslip_generation.sql` confirms table creation.
Run: `grep "generate_payslip_on_payout" supabase/migrations/021_payslip_generation.sql` confirms trigger.
Run: `ls web/app/(dashboard)/admin/medics/onboarding/` confirms onboarding page.
  </verify>
  <done>
Payslip generator creates records automatically when timesheets are paid, stores IR35 details, and triggers on payout completion. Admin onboarding page shows checklist with IR35 form, Stripe status, and payslip history.
  </done>
</task>

</tasks>

<verification>
1. IR35 form collects employment_status (self_employed or umbrella)
2. UTR validation for 10-digit format
3. CEST assessment upload stores PDF in Supabase Storage
4. Stripe Express account creation via stripe-connect Edge Function
5. Stripe onboarding status component shows progress with auto-refresh
6. Payslip table created with trigger on timesheet.payout_status = 'paid'
7. Admin onboarding page displays checklist with completion status
8. Build passes with no TypeScript errors
</verification>

<success_criteria>
- Medic can select employment status (self-employed or umbrella)
- UTR field validates 10-digit format for self-employed medics
- CEST assessment PDF uploads to Supabase Storage
- Stripe Express account onboarding link opens correctly
- Stripe onboarding status shows "Complete" when bank details added
- Payslip auto-generates with gross, deductions (£0 for self-employed), net
- Admin can view onboarding progress and approve medics for work
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-04-SUMMARY.md`
</output>
