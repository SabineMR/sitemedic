---
phase: 06.5-payments-payouts
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/generate-payslip-pdf/index.ts
  - supabase/functions/generate-payslip-pdf/components/PayslipDocument.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Payslip PDF generates with gross pay, deductions, and net pay for medic records"
    - "Generated PDF is uploaded to Supabase Storage and payslips.pdf_url is updated"
  artifacts:
    - path: "supabase/functions/generate-payslip-pdf/index.ts"
      provides: "Edge Function to generate payslip PDFs"
      exports: ["serve"]
    - path: "supabase/functions/generate-payslip-pdf/components/PayslipDocument.tsx"
      provides: "React-PDF payslip template"
      contains: "PayslipDocument"
  key_links:
    - from: "supabase/functions/generate-payslip-pdf/index.ts"
      to: "supabase storage payslips bucket"
      via: "supabase.storage.from('payslips').upload()"
      pattern: "storage.*from.*payslips.*upload"
    - from: "supabase/functions/generate-payslip-pdf/index.ts"
      to: "payslips table"
      via: "UPDATE payslips SET pdf_url"
      pattern: "update.*payslips.*pdf_url"
---

<objective>
Create payslip PDF generation Edge Function so medics can download payslips.

Purpose: The payslip database trigger (migration 025/021) creates payslip records when payout_status changes to 'paid', but pdf_url remains null because no Edge Function exists to generate the PDF. This means medics cannot download their payslips. The invoice PDF Edge Function at `supabase/functions/generate-invoice-pdf/` provides the exact pattern to follow.

Output: New Edge Function that generates professional payslip PDFs using React-PDF, uploads to Supabase Storage, and updates payslips.pdf_url.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.5-payments-payouts/06.5-04-SUMMARY.md
@.planning/phases/06.5-payments-payouts/06.5-VERIFICATION.md
@supabase/functions/generate-invoice-pdf/index.ts
@supabase/functions/generate-invoice-pdf/components/InvoiceDocument.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payslip PDF React-PDF template</name>
  <files>supabase/functions/generate-payslip-pdf/components/PayslipDocument.tsx</files>
  <action>
  Create a React-PDF payslip document component following the EXACT same pattern as `supabase/functions/generate-invoice-pdf/components/InvoiceDocument.tsx`.

  The payslip must include:

  1. **Header section:**
     - "SiteMedic" company name and "PAYSLIP" title
     - Brand color: #003366 (dark navy, matching existing PDF brand)

  2. **Medic details:**
     - Full name (first_name + last_name)
     - Employment status (Self-Employed / Umbrella Company)
     - UTR number (if self-employed)
     - Umbrella company name (if umbrella)

  3. **Pay period:**
     - Pay period start and end dates (UK format: dd MMM yyyy)
     - Payment date

  4. **Earnings table:**
     - Description | Hours | Rate | Amount
     - Row: "Medic services" | hours_worked | hourly_rate | gross_pay

  5. **Deductions table:**
     - Tax deducted: GBP0.00 (self-employed handles own tax)
     - NI deducted: GBP0.00 (self-employed handles own NI)
     - Note for self-employed: "As a self-employed contractor, you are responsible for your own tax and National Insurance contributions via Self Assessment."

  6. **Net pay summary:**
     - Gross Pay
     - Total Deductions
     - Net Pay (bold, larger font)

  7. **Footer:**
     - "This payslip is for your records. SiteMedic does not deduct tax or National Insurance for self-employed contractors."
     - Generated date

  Interface for the component:
  ```typescript
  interface PayslipData {
    medic_name: string;
    employment_status: 'self_employed' | 'umbrella';
    utr: string | null;
    umbrella_company_name: string | null;
    pay_period_start: string;
    pay_period_end: string;
    payment_date: string;
    gross_pay: number;
    tax_deducted: number;
    ni_deducted: number;
    net_pay: number;
    hours_worked: number;
    hourly_rate: number;
    booking_site: string;
    payslip_reference: string;
  }
  ```

  Use the same React and @react-pdf/renderer imports with `npm:` specifier (Deno Edge Function style):
  ```typescript
  import React from 'npm:react@18.2.0';
  import { Document, Page, Text, View, StyleSheet } from 'npm:@react-pdf/renderer@4.3.2';
  ```

  Follow the same StyleSheet.create() pattern as InvoiceDocument.tsx.
  </action>
  <verify>
  File exists at `supabase/functions/generate-payslip-pdf/components/PayslipDocument.tsx`.
  File imports from `npm:react@18.2.0` and `npm:@react-pdf/renderer@4.3.2`.
  File exports a `PayslipDocument` component.
  </verify>
  <done>
  - PayslipDocument.tsx renders a professional payslip PDF
  - Shows medic name, employment status, UTR/umbrella details
  - Earnings table with hours, rate, gross
  - Deductions section (GBP0 for self-employed with explanatory note)
  - Net pay summary section
  - Uses SiteMedic brand colors (#003366)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create payslip PDF generation Edge Function</name>
  <files>supabase/functions/generate-payslip-pdf/index.ts</files>
  <action>
  Create the Edge Function following the EXACT same pattern as `supabase/functions/generate-invoice-pdf/index.ts`.

  The function should:

  1. **Accept POST with payslipId:**
     ```typescript
     const { payslipId } = await req.json();
     ```

  2. **Query payslip with related data:**
     ```sql
     SELECT p.*, m.first_name, m.last_name, m.employment_status, m.utr, m.umbrella_company_name,
            t.hours_worked, t.hourly_rate,
            b.site_name
     FROM payslips p
     JOIN medics m ON p.medic_id = m.id
     JOIN timesheets t ON p.timesheet_id = t.id
     JOIN bookings b ON t.booking_id = b.id
     WHERE p.id = payslipId
     ```

     In Supabase client syntax:
     ```typescript
     const { data: payslip } = await supabase
       .from('payslips')
       .select(`
         *,
         medics(first_name, last_name, employment_status, utr, umbrella_company_name),
         timesheets(hours_worked, hourly_rate, bookings(site_name))
       `)
       .eq('id', payslipId)
       .single();
     ```

  3. **Generate PDF using renderToBuffer:**
     ```typescript
     import { renderToBuffer } from 'npm:@react-pdf/renderer@4.3.2';
     ```
     Pass the queried data to PayslipDocument component.

  4. **Upload to Supabase Storage:**
     - Bucket: `payslips` (create storage bucket reference)
     - Path: `{medic_id}/{payslip_id}.pdf`
     - Content-Type: `application/pdf`

  5. **Generate signed URL** with 365-day expiry (1 year, matching invoice pattern).

  6. **Update payslips table:**
     ```typescript
     await supabase.from('payslips').update({ pdf_url: signedUrl }).eq('id', payslipId);
     ```

  7. **Return the signed URL in response.**

  Use the same imports pattern as generate-invoice-pdf/index.ts:
  ```typescript
  import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
  ```

  Create a storage bucket initialization at the start (with IF NOT EXISTS pattern):
  ```typescript
  // Ensure storage bucket exists (idempotent)
  await supabase.storage.createBucket('payslips', { public: false, fileSizeLimit: 5242880 });
  ```
  Wrap in try/catch and ignore "already exists" errors.

  Error handling: Return 400 for missing payslipId, 404 for payslip not found, 500 for generation errors. Match the JSON response shape from generate-invoice-pdf.
  </action>
  <verify>
  File exists at `supabase/functions/generate-payslip-pdf/index.ts`.
  File imports `serve` from Deno std library.
  File queries `payslips` table with joins to medics, timesheets, bookings.
  File calls `renderToBuffer` to generate PDF.
  File uploads to `payslips` storage bucket.
  File updates `payslips.pdf_url` with signed URL.
  </verify>
  <done>
  - Edge Function generates payslip PDF from database record
  - PDF uploaded to Supabase Storage (payslips bucket)
  - payslips.pdf_url updated with 1-year signed URL
  - Error handling for missing data, generation failures
  - Follows same pattern as existing generate-invoice-pdf Edge Function
  </done>
</task>

</tasks>

<verification>
- `ls supabase/functions/generate-payslip-pdf/` shows both index.ts and components/PayslipDocument.tsx
- `grep "renderToBuffer" supabase/functions/generate-payslip-pdf/index.ts` returns match
- `grep "storage.*payslips" supabase/functions/generate-payslip-pdf/index.ts` returns match
- `grep "pdf_url" supabase/functions/generate-payslip-pdf/index.ts` returns match
</verification>

<success_criteria>
1. PayslipDocument.tsx renders professional payslip with gross/deductions/net
2. Edge Function queries payslip data, generates PDF, uploads to Storage
3. payslips.pdf_url updated with signed download URL
4. Follows established Edge Function patterns (generate-invoice-pdf)
</success_criteria>

<output>
After completion, create `.planning/phases/06.5-payments-payouts/06.5-08-SUMMARY.md`
</output>
