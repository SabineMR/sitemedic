---
phase: 06.5-payments-payouts
plan: 02
subsystem: payments
tags: [stripe, payouts, transfers, pg_cron, automation, uk-faster-payments]

# Dependency graph
requires:
  - phase: 01.5-business-foundation
    provides: timesheets table with payout_status workflow, medics table with Stripe account fields
  - phase: 01.5-business-foundation
    provides: Stripe integration with shared stripe.ts client

provides:
  - Automated Friday payout system with pg_cron scheduler
  - Payout calculator validating 60/40 revenue split (medic/platform)
  - Stripe Transfer API integration for UK Faster Payments
  - Admin dashboard for weekly payout management and manual triggers
  - payout_executions audit log table

affects: [admin-operations, medic-payroll, financial-reporting]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "pg_cron for scheduled Edge Function invocation"
    - "Stripe Transfers for medic payouts (UK Faster Payments)"
    - "60/40 revenue split calculation pattern"
    - "Dry-run mode for preview before batch processing"

key-files:
  created:
    - web/lib/payouts/calculator.ts
    - web/app/api/payouts/calculate-weekly/route.ts
    - web/app/api/payouts/process-batch/route.ts
    - supabase/functions/friday-payout/index.ts
    - supabase/migrations/021_friday_payout_cron.sql
    - web/components/admin/payout-summary.tsx
  modified: []

key-decisions:
  - "Use pg_cron with Edge Function HTTP POST for Friday 9am automation"
  - "UK Faster Payments via Stripe Transfer API to medic Express accounts"
  - "60% medic payout, 40% platform fee based on booking total"
  - "payout_executions table logs all automated runs for audit trail"
  - "Manual payout trigger with dry-run preview for admin safety"

patterns-established:
  - "Payout calculation validation: validatePayout() checks 60/40 split within 1 penny tolerance"
  - "Batch processing with error handling: continue processing on single failure, log all errors"
  - "Admin dashboard pattern: summary cards, medic breakdown table, manual action buttons"

# Metrics
duration: 4min
completed: 2026-02-16
---

# Phase 06.5-02: Friday Payout Automation Summary

**Automated weekly medic payouts via Stripe Transfers with pg_cron scheduler, 60/40 revenue split calculator, and admin dashboard for manual override**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-16T21:19:21Z
- **Completed:** 2026-02-16T21:23:43Z
- **Tasks:** 3
- **Files modified:** 6

## Accomplishments

- Automated Friday 9am payout job using pg_cron to invoke Edge Function
- Stripe Transfer API integration for UK Faster Payments (2 business days)
- Payout calculator validates 60% medic share, 40% platform fee
- Admin dashboard shows weekly summary with medic breakdown and Stripe status
- Error handling logs failed payouts with detailed reasons for manual review

## Task Commits

Each task was committed atomically:

1. **Task 1: Create payout calculator and batch processor** - `3bd08f6` (feat)
2. **Task 2: Create Friday payout Edge Function** - `d62ec4b` (feat)
3. **Task 3: Create pg_cron scheduler and admin dashboard** - `0b11367` (feat)

## Files Created/Modified

### Created

- **web/lib/payouts/calculator.ts** - Payout calculation logic with 60/40 split validation
- **web/app/api/payouts/calculate-weekly/route.ts** - GET endpoint aggregating admin-approved timesheets by medic
- **web/app/api/payouts/process-batch/route.ts** - POST endpoint for batch Stripe Transfer processing with dry-run mode
- **supabase/functions/friday-payout/index.ts** - Edge Function for automated weekly payout execution
- **supabase/migrations/021_friday_payout_cron.sql** - pg_cron job configuration and payout_executions audit log table
- **web/components/admin/payout-summary.tsx** - Admin dashboard component with weekly summary and manual trigger

### Modified

None

## Decisions Made

1. **pg_cron scheduler:** Use pg_cron extension to invoke Edge Function every Friday at 9am GMT via HTTP POST with service role key for authentication

2. **UK Faster Payments:** Stripe Transfer API delivers funds to medic Express accounts within 2 business days (standard UK bank transfer)

3. **60/40 revenue split:** Medics receive 60% of booking total, platform keeps 40% - validated in calculator with 1 penny tolerance for rounding

4. **Error handling strategy:** Continue processing all payouts even if individual transfers fail, log all errors to payout_executions table and display in admin dashboard for manual review

5. **Dry-run preview:** Admin can test payout batch with validation only (no Stripe calls) before confirming actual processing

6. **Stripe validation:** Only process payouts for medics with `stripe_account_id` and `stripe_onboarding_complete = true` to prevent transfer failures

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all Stripe Transfer integration, pg_cron setup, and admin dashboard components implemented without issues.

## User Setup Required

**External services require manual configuration.**

### pg_cron Job Setup

The pg_cron job must be configured manually via Supabase Dashboard:

1. **Enable pg_cron extension:** Migration 021 creates extension (auto-applied on next deploy)

2. **Store service role key as database setting:**
   ```sql
   ALTER DATABASE postgres SET app.service_role_key = 'your-service-role-key';
   ```

3. **Create cron job via Supabase Dashboard:**
   - Navigate to Database > Cron Jobs
   - Click "Create a new cron job"
   - Job name: `friday-medic-payouts`
   - Schedule: `0 9 * * 5` (Every Friday at 9:00 AM GMT)
   - Command:
     ```sql
     SELECT
       net.http_post(
         url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/friday-payout',
         headers := jsonb_build_object(
           'Content-Type', 'application/json',
           'Authorization', 'Bearer ' || current_setting('app.service_role_key')
         ),
         body := jsonb_build_object(
           'scheduled', true,
           'execution_time', NOW()
         )
       ) AS request_id;
     ```
   - Replace `YOUR_PROJECT_REF` with actual Supabase project reference

**Alternative:** Use Supabase Edge Function Cron Triggers (recommended):
https://supabase.com/docs/guides/functions/schedule-functions

### Verification

After setup, verify the cron job is scheduled:

```sql
SELECT * FROM cron.job WHERE jobname = 'friday-medic-payouts';
```

Test the Edge Function manually:

```bash
curl -X POST https://YOUR_PROJECT_REF.supabase.co/functions/v1/friday-payout \
  -H "Authorization: Bearer YOUR_SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json" \
  -d '{"scheduled": false, "test": true}'
```

## Next Phase Readiness

**Ready for:**
- Phase 06.5-03: Payout dispute handling and error recovery flows
- Phase 07: Financial reporting and reconciliation (payout_executions audit trail ready)
- Admin operations: Weekly payout monitoring dashboard accessible

**Blockers:** None

**Notes:**
- Medics must complete Stripe Express onboarding before receiving payouts (Phase 01.5 Stripe Connect setup)
- Timesheets must flow through full approval workflow: medic → manager → admin before payout eligibility
- First Friday run will process all historical admin-approved timesheets (backlog catchup)

---
*Phase: 06.5-payments-payouts*
*Completed: 2026-02-16*
