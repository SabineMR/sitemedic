---
phase: 24-db-foundation
plan: 05
type: execute
wave: 2
depends_on: ["24-02", "24-03", "24-04"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 3 migrations (132, 133, 134) exist as valid SQL files"
    - "Apex slug exists in the organizations table (backfill target verified)"
    - "Migration 132 backfill carries company_name from organizations.name"
    - "Migration 133 backfill sets Apex to growth, others to starter"
    - "Migration 134 creates public bucket with org-scoped write RLS"
    - "Legacy NULL stripe_customer_id behaviour is documented"
  artifacts: []
  key_links:
    - from: "132_org_branding.sql"
      to: "Phase 27/28/31 (branding consumers)"
      via: "org_branding table schema"
      pattern: "org_branding"
    - from: "133_subscription_columns.sql"
      to: "Phase 25/26/30 (billing/routing/gating consumers)"
      via: "subscription_tier and subscription_status columns"
      pattern: "subscription_tier|subscription_status"
    - from: "134_org_logos_bucket.sql"
      to: "Phase 28/31 (PDF branding, logo upload UI)"
      via: "org-logos storage bucket"
      pattern: "org-logos"
---

<objective>
Verify all Phase 24 migrations are correct and document the legacy org behaviour for downstream phases.

Purpose: This plan validates all 3 SQL migrations created by plans 24-02, 24-03, and 24-04 before they are applied to production. It also documents the critical "NULL stripe_customer_id = access granted" convention that Phases 25-30 must honour.

Output: Verification that all migration files are complete and correct. Legacy org behaviour documented in the SUMMARY file.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-db-foundation/24-02-SUMMARY.md
@.planning/phases/24-db-foundation/24-03-SUMMARY.md
@.planning/phases/24-db-foundation/24-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify all migration files are complete and correct</name>
  <files></files>
  <action>
  Read and validate all three migration files created by prior plans:

  **Migration 132 (org_branding) -- verify:**
  1. `CREATE TABLE org_branding` with columns: id, org_id, logo_path, primary_colour_hex, company_name, tagline, created_at, updated_at
  2. `UNIQUE` constraint on org_id
  3. `REFERENCES organizations(id) ON DELETE CASCADE` FK
  4. `CHECK` on primary_colour_hex allows NULL (either `IS NULL OR` pattern or implicit via CHECK semantics)
  5. `uuid_generate_v4()` for PK (NOT gen_random_uuid)
  6. Index on org_id
  7. Backfill `INSERT INTO org_branding (org_id, company_name) SELECT id, name FROM organizations`
  8. 5 RLS policies (org SELECT, org admin UPDATE, platform admin SELECT/INSERT/UPDATE)

  **Migration 133 (subscription_columns) -- verify:**
  1. `ALTER TABLE organizations ADD COLUMN IF NOT EXISTS` for all 4 columns
  2. `stripe_customer_id TEXT DEFAULT NULL`
  3. `stripe_subscription_id TEXT DEFAULT NULL`
  4. `subscription_tier TEXT DEFAULT NULL CHECK (... IN ('starter', 'growth', 'enterprise'))`
  5. `subscription_status TEXT DEFAULT NULL CHECK (... IN ('active', 'past_due', 'cancelled'))`
  6. Backfill: `UPDATE organizations SET subscription_tier = 'growth' WHERE slug = 'apex'`
  7. Backfill: `UPDATE organizations SET subscription_tier = 'starter' WHERE slug != 'apex' AND subscription_tier IS NULL`
  8. No new RLS policies (existing coverage from migrations 00004 + 102)

  **Migration 134 (org-logos bucket) -- verify:**
  1. `INSERT INTO storage.buckets` with id='org-logos', public=true
  2. File size limit = 2097152 (2MB)
  3. Allowed MIME types include png, jpeg, jpg, svg+xml, webp
  4. 7 RLS policies total (2 INSERT, 1 SELECT, 2 UPDATE, 2 DELETE)
  5. Org admin policies check `(storage.foldername(name))[1] = get_user_org_id()::text`
  6. Platform admin policies do NOT check folder (their org_id is NULL)
  7. `ON CONFLICT (id) DO NOTHING` for idempotency

  If any check fails, fix the issue in the migration file directly.
  </action>
  <verify>
  Run these verification commands:

  1. `ls -la /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/132_org_branding.sql` -- file exists
  2. `ls -la /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/133_subscription_columns.sql` -- file exists
  3. `ls -la /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/134_org_logos_bucket.sql` -- file exists
  4. `grep -c 'CREATE POLICY' /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/132_org_branding.sql` -- outputs 5
  5. `grep -c 'CREATE POLICY' /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/134_org_logos_bucket.sql` -- outputs 7
  6. `grep 'uuid_generate_v4' /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/132_org_branding.sql` -- present
  7. `grep 'gen_random_uuid' /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/132_org_branding.sql` -- NOT present
  8. `grep "slug = 'apex'" /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/133_subscription_columns.sql` -- present
  9. `grep '\[1\]' /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/134_org_logos_bucket.sql` -- present (1-indexed arrays)
  </verify>
  <done>
  All 3 migration files verified: correct table structure, proper CHECK constraints, idempotent backfills, correct RLS policies, 1-indexed array access, uuid_generate_v4() usage. Phase 24 DB foundation is ready for application to Supabase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document legacy org behaviour for downstream phases</name>
  <files>.planning/phases/24-db-foundation/24-05-SUMMARY.md</files>
  <action>
  When writing the 24-05 SUMMARY file, include a "Legacy Org Behaviour" section that documents the following critical information for downstream phases (25-31):

  1. **NULL stripe_customer_id**: Means the org has not gone through Stripe onboarding. Application code MUST treat NULL as "access granted" -- no billing enforcement. This is the state of ALL existing orgs after migration 133.

  2. **NULL subscription_status**: Same meaning as NULL stripe_customer_id. The org is not on Stripe billing. Treat as active for access control purposes.

  3. **subscription_tier is NOT NULL** after backfill: All existing orgs have a tier (Apex='growth', others='starter'). Feature gating can use subscription_tier immediately.

  4. **org_branding rows exist** for all existing orgs after migration 132 backfill. company_name is pre-populated from organizations.name. logo_path and primary_colour_hex are NULL (to be set via branding settings UI in Phase 31).

  5. **New orgs created AFTER migration 132** will NOT auto-get an org_branding row. The onboarding flow (Phase 29) must INSERT a row when creating a new org.

  6. **Apex slug assumption**: The backfill in migration 133 uses `WHERE slug = 'apex'`. If this slug changes before the migration runs in production, the backfill must be updated.

  This documentation is written as part of the SUMMARY file that the output section instructs to create.
  </action>
  <verify>
  Run: `cat /Users/sabineresoagli/GitHub/sitemedic/.planning/phases/24-db-foundation/24-05-SUMMARY.md | grep "NULL stripe_customer_id"`
  This must return a line confirming the legacy access-granted behaviour is documented.
  </verify>
  <done>
  Legacy org behaviour documented in 24-05 SUMMARY: NULL stripe fields = access granted, subscription_tier always populated, org_branding rows backfilled for existing orgs, new orgs need explicit INSERT, Apex slug assumption noted.
  </done>
</task>

</tasks>

<verification>
- All 3 migration files exist and pass structural checks
- Migration 132: 5 policies, uuid_generate_v4, company_name backfill
- Migration 133: 4 columns, CHECK constraints, Apex/starter backfill, no new policies
- Migration 134: 7 policies, public bucket, 2MB limit, 1-indexed folder check
- Legacy org behaviour documented for downstream phases
</verification>

<success_criteria>
All Phase 24 migrations verified complete and correct. Legacy org behaviour documented for Phases 25-31 to reference. Phase 24 DB Foundation is ready for deployment.
</success_criteria>

<output>
After completion, create `.planning/phases/24-db-foundation/24-05-SUMMARY.md`
</output>
