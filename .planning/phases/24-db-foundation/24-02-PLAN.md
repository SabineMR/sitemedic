---
phase: 24-db-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/132_org_branding.sql
autonomous: true

must_haves:
  truths:
    - "org_branding table exists with org_id FK, logo_path, primary_colour_hex, company_name, tagline columns"
    - "Every existing org has an org_branding row after migration runs"
    - "Org users can SELECT their own org branding but not others"
    - "Org admins can UPDATE their own org branding"
    - "Platform admins can SELECT, INSERT, and UPDATE all org branding rows"
    - "primary_colour_hex column validates hex format (#RRGGBB)"
  artifacts:
    - path: "supabase/migrations/132_org_branding.sql"
      provides: "org_branding table, index, backfill, RLS policies"
      min_lines: 60
  key_links:
    - from: "org_branding.org_id"
      to: "organizations.id"
      via: "FOREIGN KEY with ON DELETE CASCADE"
      pattern: "REFERENCES organizations"
    - from: "RLS policies"
      to: "get_user_org_id() / is_org_admin() / is_platform_admin()"
      via: "Helper functions in JWT"
      pattern: "get_user_org_id|is_org_admin|is_platform_admin"
---

<objective>
Create migration 132: the org_branding table that stores per-org white-label configuration (logo path, primary colour, company name, tagline). Backfill a row for every existing org.

Purpose: All v3.0 branding features (portal, PDFs, emails) read from this table. It must exist with backfilled data before any branding code is written in Phases 27-31.

Output: supabase/migrations/132_org_branding.sql with table, index, backfill, and RLS policies.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/118_org_settings.sql (canonical template for org-scoped table)
@supabase/migrations/00004_rls_policies.sql (existing org RLS pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 132_org_branding.sql</name>
  <files>supabase/migrations/132_org_branding.sql</files>
  <action>
  Create the file at `/Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/132_org_branding.sql`.

  Follow migration 118 (org_settings) as the template. The migration must contain:

  **1. CREATE TABLE org_branding:**
  ```sql
  CREATE TABLE org_branding (
    id                  UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
    org_id              UUID        NOT NULL UNIQUE
                        REFERENCES organizations(id) ON DELETE CASCADE,
    logo_path           TEXT,
    primary_colour_hex  TEXT CHECK (primary_colour_hex IS NULL OR primary_colour_hex ~ '^#[0-9A-Fa-f]{6}$'),
    company_name        TEXT,
    tagline             TEXT,
    created_at          TIMESTAMPTZ DEFAULT NOW(),
    updated_at          TIMESTAMPTZ DEFAULT NOW()
  );
  ```

  IMPORTANT: The CHECK constraint on primary_colour_hex must allow NULL (initial state for all orgs) -- use `IS NULL OR` pattern.

  **2. INDEX:**
  ```sql
  CREATE INDEX idx_org_branding_org ON org_branding (org_id);
  ```

  **3. BACKFILL -- Insert a row for every existing org, carrying over company name from organizations.name:**
  ```sql
  INSERT INTO org_branding (org_id, company_name)
  SELECT id, name
  FROM organizations
  ON CONFLICT (org_id) DO NOTHING;
  ```

  IMPORTANT: Carry over `organizations.name` into `company_name` so existing orgs have their name pre-populated. logo_path and primary_colour_hex default to NULL. This matches the success criteria: "existing orgs receive an org_branding row with empty logo path, null primary colour, and their current company name carried over."

  **4. ENABLE RLS:**
  ```sql
  ALTER TABLE org_branding ENABLE ROW LEVEL SECURITY;
  ```

  **5. RLS POLICIES (5 total, following migration 118 pattern):**

  Org users -- SELECT only:
  ```sql
  CREATE POLICY "Org users can view their own org branding"
    ON org_branding FOR SELECT
    USING (org_id = get_user_org_id());
  ```

  Org admins -- UPDATE their own:
  ```sql
  CREATE POLICY "Org admins can update their own org branding"
    ON org_branding FOR UPDATE
    USING (org_id = get_user_org_id() AND is_org_admin())
    WITH CHECK (org_id = get_user_org_id() AND is_org_admin());
  ```

  Platform admins -- full SELECT, INSERT, UPDATE:
  ```sql
  CREATE POLICY "Platform admins can view all org branding"
    ON org_branding FOR SELECT
    USING (is_platform_admin());

  CREATE POLICY "Platform admins can insert org branding"
    ON org_branding FOR INSERT
    WITH CHECK (is_platform_admin());

  CREATE POLICY "Platform admins can update all org branding"
    ON org_branding FOR UPDATE
    USING (is_platform_admin())
    WITH CHECK (is_platform_admin());
  ```

  **6. Add COMMENT blocks** following migration 118 convention -- brief comments on table and key columns.

  **7. SUMMARY comment block** at the bottom following migration 118 convention.

  Do NOT add a DELETE policy for org users (only platform admins manage row lifecycle, same as org_settings).
  Do NOT use gen_random_uuid() -- use uuid_generate_v4() per project convention.
  </action>
  <verify>
  1. File exists at `/Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/132_org_branding.sql`
  2. File contains `CREATE TABLE org_branding`
  3. File contains `REFERENCES organizations(id) ON DELETE CASCADE`
  4. File contains `ON CONFLICT (org_id) DO NOTHING` (idempotent backfill)
  5. File contains exactly 5 CREATE POLICY statements (1 org SELECT, 1 org admin UPDATE, 3 platform admin)
  6. File contains `primary_colour_hex IS NULL OR primary_colour_hex ~ '^#[0-9A-Fa-f]{6}$'` (NULL-safe CHECK)
  7. Backfill SELECT includes `name` from organizations for company_name carry-over
  8. `grep 'company_name' /Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/132_org_branding.sql | grep 'SELECT'` -- must match the backfill INSERT line confirming company_name is carried from organizations.name
  </verify>
  <done>
  Migration 132 file exists with: org_branding table (6 columns + timestamps), org_id index, backfill carrying company_name from organizations.name (INSERT INTO org_branding (org_id, company_name) SELECT id, name FROM organizations), RLS enabled with 5 policies (org SELECT, org admin UPDATE, platform admin SELECT/INSERT/UPDATE). Backfill INSERT includes company_name from organizations.name. Ready to apply.
  </done>
</task>

</tasks>

<verification>
- File exists at supabase/migrations/132_org_branding.sql
- Contains CREATE TABLE, INDEX, INSERT INTO (backfill), ALTER TABLE ENABLE RLS, 5 CREATE POLICY statements
- Backfill carries `organizations.name` into `company_name` (verified by grep matching company_name in a SELECT line)
- primary_colour_hex CHECK allows NULL values
- Uses uuid_generate_v4() not gen_random_uuid()
</verification>

<success_criteria>
Migration 132 creates org_branding table with all required columns, backfills a row for every existing org with company_name from organizations.name, and has org-scoped RLS policies following the migration 118 pattern.
</success_criteria>

<output>
After completion, create `.planning/phases/24-db-foundation/24-02-SUMMARY.md`
</output>
