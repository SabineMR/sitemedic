---
phase: 24-db-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/134_org_logos_bucket.sql
autonomous: true

must_haves:
  truths:
    - "org-logos Supabase Storage bucket exists and is public"
    - "Bucket limits uploads to 2MB and image MIME types only"
    - "Org admins can upload logos only under their own org_id folder"
    - "Platform admins can upload logos under any org_id folder"
    - "Anyone (including unauthenticated) can view/download org logos"
    - "Org admins can update and delete their own org logos"
  artifacts:
    - path: "supabase/migrations/134_org_logos_bucket.sql"
      provides: "Public org-logos storage bucket with org-scoped write RLS"
      min_lines: 40
  key_links:
    - from: "storage.objects bucket_id='org-logos'"
      to: "org_branding.logo_path"
      via: "Logo URL stored in org_branding after upload (Phase 31)"
      pattern: "org-logos"
    - from: "storage.foldername(name)[1]"
      to: "get_user_org_id()::text"
      via: "Org-scoped folder path enforcement"
      pattern: "foldername.*get_user_org_id"
---

<objective>
Create migration 134: a public Supabase Storage bucket called 'org-logos' with org-scoped write RLS policies. Logos uploaded here will be referenced by org_branding.logo_path in Phase 31.

Purpose: Org logos must be publicly accessible (they appear in PDFs served from Edge Functions and in emails). Write access is restricted so org admins can only upload under their own org_id path prefix.

Output: supabase/migrations/134_org_logos_bucket.sql with bucket creation and 4 storage RLS policies.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/131_emergency_recordings_bucket.sql (canonical template for storage bucket migration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 134_org_logos_bucket.sql</name>
  <files>supabase/migrations/134_org_logos_bucket.sql</files>
  <action>
  Create the file at `/Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/134_org_logos_bucket.sql`.

  Follow migration 131 (emergency-recordings) as the template. The migration must contain:

  **1. CREATE BUCKET:**
  ```sql
  INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
  VALUES (
    'org-logos',
    'org-logos',
    true,       -- PUBLIC: logos appear in PDFs, emails, and portal header
    2097152,    -- 2 MB max per file
    ARRAY['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml', 'image/webp']
  )
  ON CONFLICT (id) DO NOTHING;
  ```

  IMPORTANT: `public = true` means unauthenticated GET. Write policies still required.

  **2. INSERT POLICY -- Org admins and platform admins can upload:**
  ```sql
  CREATE POLICY "Org admins can upload org logos"
    ON storage.objects FOR INSERT
    WITH CHECK (
      bucket_id = 'org-logos'
      AND (is_org_admin() OR is_platform_admin())
      AND (storage.foldername(name))[1] = get_user_org_id()::text
    );
  ```

  IMPORTANT: Postgres arrays are 1-indexed -- use `[1]` not `[0]`.
  IMPORTANT: Platform admins also match via `is_platform_admin()` in the OR. However, platform admins have `org_id = NULL` in their JWT, so `get_user_org_id()::text` would be NULL for them. Add a separate INSERT policy for platform admins without the folder check:

  ```sql
  CREATE POLICY "Platform admins can upload any org logo"
    ON storage.objects FOR INSERT
    WITH CHECK (
      bucket_id = 'org-logos'
      AND is_platform_admin()
    );
  ```

  And update the org admin policy to remove the `OR is_platform_admin()`:
  ```sql
  CREATE POLICY "Org admins can upload org logos"
    ON storage.objects FOR INSERT
    WITH CHECK (
      bucket_id = 'org-logos'
      AND is_org_admin()
      AND (storage.foldername(name))[1] = get_user_org_id()::text
    );
  ```

  **3. SELECT POLICY -- Anyone can view (public bucket):**
  ```sql
  CREATE POLICY "Anyone can view org logos"
    ON storage.objects FOR SELECT
    USING (bucket_id = 'org-logos');
  ```

  **4. UPDATE POLICY -- Org admins can replace their logos, platform admins any:**
  ```sql
  CREATE POLICY "Org admins can update org logos"
    ON storage.objects FOR UPDATE
    USING (
      bucket_id = 'org-logos'
      AND is_org_admin()
      AND (storage.foldername(name))[1] = get_user_org_id()::text
    );

  CREATE POLICY "Platform admins can update any org logo"
    ON storage.objects FOR UPDATE
    USING (
      bucket_id = 'org-logos'
      AND is_platform_admin()
    );
  ```

  **5. DELETE POLICY -- Org admins can delete their logos, platform admins any:**
  ```sql
  CREATE POLICY "Org admins can delete org logos"
    ON storage.objects FOR DELETE
    USING (
      bucket_id = 'org-logos'
      AND is_org_admin()
      AND (storage.foldername(name))[1] = get_user_org_id()::text
    );

  CREATE POLICY "Platform admins can delete any org logo"
    ON storage.objects FOR DELETE
    USING (
      bucket_id = 'org-logos'
      AND is_platform_admin()
    );
  ```

  **6. SUMMARY comment block** at the bottom following migration 131 convention.

  Total: 7 policies (2 INSERT, 1 SELECT, 2 UPDATE, 2 DELETE).

  File path pattern enforced: `org-logos/{org_id}/logo.{ext}` -- the foldername check ensures org admins can only write under their own org_id folder.
  </action>
  <verify>
  1. File exists at `/Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/134_org_logos_bucket.sql`
  2. File contains `INSERT INTO storage.buckets` with `'org-logos'` and `true` (public)
  3. File contains `2097152` (2MB limit)
  4. File contains `ARRAY['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml', 'image/webp']`
  5. File contains 7 `CREATE POLICY` statements
  6. All folder checks use `(storage.foldername(name))[1]` (1-indexed, not 0)
  7. Platform admin policies do NOT include folder restriction (their org_id is NULL)
  8. File contains `ON CONFLICT (id) DO NOTHING` (idempotent)
  </verify>
  <done>
  Migration 134 creates public org-logos bucket with 2MB limit, image MIME types only. 7 RLS policies enforce org-scoped writes (org admins restricted to their folder, platform admins unrestricted). Public SELECT for unauthenticated logo access.
  </done>
</task>

</tasks>

<verification>
- File exists at supabase/migrations/134_org_logos_bucket.sql
- Bucket is public, 2MB limit, image MIME types only
- 7 RLS policies: org admin INSERT/UPDATE/DELETE scoped to their folder, platform admin INSERT/UPDATE/DELETE unrestricted, public SELECT
- Folder path check uses 1-indexed array access `[1]`
</verification>

<success_criteria>
Migration 134 creates the org-logos public storage bucket with proper file size and MIME type limits. RLS policies enforce org-scoped writes while allowing public reads. Platform admins can manage logos for any org.
</success_criteria>

<output>
After completion, create `.planning/phases/24-db-foundation/24-04-SUMMARY.md`
</output>
