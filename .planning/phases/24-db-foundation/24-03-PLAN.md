---
phase: 24-db-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/133_subscription_columns.sql
autonomous: true

must_haves:
  truths:
    - "organizations table has stripe_customer_id, stripe_subscription_id, subscription_tier, subscription_status columns"
    - "subscription_tier only allows NULL, 'starter', 'growth', or 'enterprise'"
    - "subscription_status only allows NULL, 'active', 'past_due', or 'cancelled'"
    - "All 4 new columns are added with DEFAULT NULL (safe ALTER TABLE for existing rows)"
    - "After backfill runs: all existing org rows have a non-NULL subscription_tier (Apex='growth', others='starter')"
    - "Apex Safety Solutions org has subscription_tier = 'growth' after backfill"
    - "All other existing orgs have subscription_tier = 'starter' after backfill"
  artifacts:
    - path: "supabase/migrations/133_subscription_columns.sql"
      provides: "ALTER TABLE organizations with 4 new columns + subscription tier backfill"
      min_lines: 30
  key_links:
    - from: "organizations.subscription_tier"
      to: "Phase 25 feature-gates.ts"
      via: "Middleware reads tier for every request"
      pattern: "subscription_tier"
    - from: "organizations.stripe_customer_id"
      to: "Phase 25 billing webhook"
      via: "Webhook handler writes customer ID after checkout"
      pattern: "stripe_customer_id"
---

<objective>
Create migration 133: add subscription columns (stripe_customer_id, stripe_subscription_id, subscription_tier, subscription_status) to the organizations table, then backfill existing orgs with default subscription tiers.

Purpose: Phase 25 (billing webhook) and Phase 30 (feature gating) depend on these columns existing. The backfill sets Apex to 'growth' and all others to 'starter' so tier-based logic works immediately for existing orgs.

Output: supabase/migrations/133_subscription_columns.sql with ALTER TABLE + CHECK constraints + backfill.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/00004_rls_policies.sql (existing organizations policies)
@supabase/migrations/102_platform_admin_rls_policies.sql (platform admin FOR ALL on organizations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 133_subscription_columns.sql</name>
  <files>supabase/migrations/133_subscription_columns.sql</files>
  <action>
  Create the file at `/Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/133_subscription_columns.sql`.

  The migration must contain:

  **1. ALTER TABLE -- Add 4 new columns:**
  ```sql
  ALTER TABLE organizations
    ADD COLUMN IF NOT EXISTS stripe_customer_id     TEXT DEFAULT NULL,
    ADD COLUMN IF NOT EXISTS stripe_subscription_id TEXT DEFAULT NULL,
    ADD COLUMN IF NOT EXISTS subscription_tier      TEXT DEFAULT NULL
      CHECK (subscription_tier IN ('starter', 'growth', 'enterprise')),
    ADD COLUMN IF NOT EXISTS subscription_status    TEXT DEFAULT NULL
      CHECK (subscription_status IN ('active', 'past_due', 'cancelled'));
  ```

  IMPORTANT: All columns DEFAULT NULL. The CHECK constraints allow NULL (Postgres CHECK passes if the expression evaluates to NULL or TRUE). No need for explicit `IS NULL OR` -- the CHECK constraint `IN (...)` naturally fails only on non-NULL values that aren't in the list.

  **2. COLUMN COMMENTS:**
  ```sql
  COMMENT ON COLUMN organizations.stripe_customer_id IS
    'Stripe Customer ID (cus_xxx). NULL for legacy orgs not yet onboarded to billing.';

  COMMENT ON COLUMN organizations.stripe_subscription_id IS
    'Stripe Subscription ID (sub_xxx). NULL for legacy orgs and orgs on free/manual plans.';

  COMMENT ON COLUMN organizations.subscription_tier IS
    'Current subscription tier: starter, growth, or enterprise. '
    'NULL means legacy org with no billing -- treated as access-granted until onboarding.';

  COMMENT ON COLUMN organizations.subscription_status IS
    'Current Stripe subscription status: active, past_due, or cancelled. '
    'NULL means legacy org not yet on Stripe billing -- treated as active until onboarding.';
  ```

  **3. BACKFILL -- Set subscription tiers for existing orgs:**
  ```sql
  -- Apex Safety Solutions: growth tier (primary launch org)
  UPDATE organizations
  SET subscription_tier = 'growth'
  WHERE slug = 'apex';

  -- All other existing orgs: starter tier (default)
  UPDATE organizations
  SET subscription_tier = 'starter'
  WHERE slug != 'apex'
    AND subscription_tier IS NULL;
  ```

  IMPORTANT: The backfill uses `slug = 'apex'` for Apex identification. Plan 24-05 will verify this slug exists. The WHERE clause `AND subscription_tier IS NULL` makes the second UPDATE idempotent.

  Note on RLS: No new RLS policies needed. Migration 102 already has a `FOR ALL` policy on organizations for platform admins, and the existing SELECT policy from migration 00004 automatically covers the new columns for org users.

  **4. SUMMARY comment block** at the bottom:
  ```sql
  -- SUMMARY
  -- Migration complete: Added subscription columns to organizations table.
  --
  -- Columns added:
  --   - stripe_customer_id (TEXT, NULL) -- Stripe Customer ID
  --   - stripe_subscription_id (TEXT, NULL) -- Stripe Subscription ID
  --   - subscription_tier (TEXT, NULL, CHECK: starter/growth/enterprise)
  --   - subscription_status (TEXT, NULL, CHECK: active/past_due/cancelled)
  --
  -- Backfill:
  --   - Apex Safety Solutions (slug='apex'): subscription_tier = 'growth'
  --   - All other orgs: subscription_tier = 'starter'
  --
  -- RLS: No new policies needed (migration 102 FOR ALL covers platform admin;
  --       migration 00004 SELECT covers org users for new columns).
  --
  -- Legacy behaviour: NULL stripe_customer_id means org has not onboarded to
  -- Stripe billing. Application code treats NULL as "access granted" until
  -- the org goes through the onboarding flow (Phase 29).
  ```
  </action>
  <verify>
  1. File exists at `/Users/sabineresoagli/GitHub/sitemedic/supabase/migrations/133_subscription_columns.sql`
  2. File contains `ALTER TABLE organizations`
  3. File contains `ADD COLUMN IF NOT EXISTS stripe_customer_id`
  4. File contains `ADD COLUMN IF NOT EXISTS subscription_tier`
  5. File contains `CHECK (subscription_tier IN ('starter', 'growth', 'enterprise'))`
  6. File contains `CHECK (subscription_status IN ('active', 'past_due', 'cancelled'))`
  7. File contains `WHERE slug = 'apex'` (Apex backfill)
  8. File contains `SET subscription_tier = 'starter'` (other orgs backfill)
  9. File does NOT contain `CREATE POLICY` (no new RLS needed)
  </verify>
  <done>
  Migration 133 adds 4 subscription columns to organizations with CHECK constraints, backfills Apex as 'growth' and all others as 'starter', includes column comments. No new RLS policies needed (existing coverage sufficient).
  </done>
</task>

</tasks>

<verification>
- File exists at supabase/migrations/133_subscription_columns.sql
- ALTER TABLE adds stripe_customer_id, stripe_subscription_id, subscription_tier, subscription_status
- CHECK constraints enforce valid tier and status values
- Backfill sets Apex to 'growth', all others to 'starter'
- No CREATE POLICY statements (existing RLS covers new columns)
</verification>

<success_criteria>
Migration 133 adds all 4 subscription columns with correct CHECK constraints, backfills tiers for existing orgs (Apex='growth', others='starter'), and documents the legacy NULL-stripe-customer-id behaviour.
</success_criteria>

<output>
After completion, create `.planning/phases/24-db-foundation/24-03-SUMMARY.md`
</output>
