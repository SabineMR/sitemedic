---
phase: 01.5-business-foundation
plan: 02
subsystem: payments
tags: [stripe, stripe-connect, express-accounts, payment-intents, webhooks, edge-functions, deno]

# Dependency graph
requires:
  - phase: 01.5-01
    provides: Database schema for clients, medics, bookings, payments, and timesheets tables with Stripe integration fields
provides:
  - Stripe Connect Edge Function (create_express_account, create_payment_intent, create_customer, check_account_status)
  - Stripe webhook handler (account.updated, payment_intent.succeeded, payment_intent.payment_failed, transfer.created)
  - Shared Stripe client using v14 Deno-compatible imports
affects: [01.5-05-medic-onboarding, 02-client-booking-flow, 03-medic-payouts]

# Tech tracking
tech-stack:
  added: [stripe@14, @supabase/supabase-js@2]
  patterns:
    - Action-based Edge Function routing (single function handles multiple actions via request body)
    - Webhook signature verification before event processing
    - Service role key for database operations (bypass RLS in admin operations)
    - Deno-compatible Stripe v14 with Fetch HTTP client (no Node.js dependencies)

key-files:
  created:
    - supabase/functions/_shared/stripe.ts
    - supabase/functions/stripe-connect/index.ts
    - supabase/functions/stripe-webhooks/index.ts
  modified: []

key-decisions:
  - "D-01.5-02-001: Use Stripe v14 for Deno compatibility (older versions have CommonJS issues in Edge Runtime)"
  - "D-01.5-02-002: Action-based routing pattern for stripe-connect (single function, multiple actions via body.action)"
  - "D-01.5-02-003: Store onboarding_url in medics table for re-access (Stripe AccountLinks expire)"
  - "D-01.5-02-004: Verify webhook signatures BEFORE parsing event (security requirement per Stripe docs)"
  - "D-01.5-02-005: Express accounts for medics use GB country and transfers capability (UK-based medics)"
  - "D-01.5-02-006: Payment Intent metadata includes booking_id and client_id for event correlation"

patterns-established:
  - "Shared client pattern: Export reusable clients from _shared/ directory for use across Edge Functions"
  - "Webhook handler pattern: Verify signature with raw body, route by event.type, update DB with service role"
  - "Edge Function error handling: Return 400 for invalid input, 500 for Stripe/DB errors with JSON response"

# Metrics
duration: 4min
completed: 2026-02-15
---

# Phase 01.5 Plan 02: Stripe Connect Integration Summary

**Stripe Connect Express accounts for UK medic payouts with Payment Intent creation, webhook processing, and Deno-compatible v14 client**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-15T17:29:13-06:00
- **Completed:** 2026-02-15T23:33:07Z
- **Tasks:** 3 (2 auto + 1 checkpoint)
- **Files modified:** 3

## Accomplishments
- Stripe Connect Edge Function handles Express account creation, onboarding link generation, Payment Intent creation, and Stripe Customer creation
- Webhook handler processes account.updated, payment_intent.succeeded, payment_intent.payment_failed, and transfer.created events
- Shared Stripe client uses Deno-compatible v14 with Fetch HTTP client (no Node.js dependencies)
- Service role key enables admin operations (bypass RLS for webhook and admin actions)

## Task Commits

Each task was committed atomically:

1. **Task 1: Shared Stripe client and Connect Edge Function** - `d113c79` (feat)
2. **Task 2: Stripe webhook handler** - `859a2a0` (feat)
3. **Task 3: Checkpoint - User setup verification** - APPROVED (user will add Stripe keys later)

**Plan metadata:** Pending (will be committed with STATE.md update)

## Files Created/Modified
- `supabase/functions/_shared/stripe.ts` - Shared Stripe client (v14) with Fetch HTTP client for Deno compatibility
- `supabase/functions/stripe-connect/index.ts` - Express account creation, Payment Intent creation, Customer creation, account status checks
- `supabase/functions/stripe-webhooks/index.ts` - Webhook signature verification and event processing for account, payment, and transfer events

## Decisions Made

**D-01.5-02-001: Use Stripe v14 for Deno compatibility**
- Rationale: Older Stripe versions (v12, v13) have CommonJS issues in Edge Runtime; v14 uses ESM and works with Deno

**D-01.5-02-002: Action-based routing pattern for stripe-connect**
- Rationale: Single Edge Function with `action` field in request body (4 actions: create_express_account, create_payment_intent, create_customer, check_account_status) reduces deployment complexity vs 4 separate functions

**D-01.5-02-003: Store onboarding_url in medics table**
- Rationale: Stripe AccountLinks expire after 1 hour; storing URL allows re-access for medics who don't complete onboarding immediately

**D-01.5-02-004: Verify webhook signatures BEFORE parsing event**
- Rationale: Security requirement per Stripe documentation - signature verification needs raw body, not parsed JSON

**D-01.5-02-005: Express accounts for medics use GB country and transfers capability**
- Rationale: UK-based medics need GB bank accounts; transfers capability required for payouts

**D-01.5-02-006: Payment Intent metadata includes booking_id and client_id**
- Rationale: Enables event correlation in webhooks (no database lookup needed to find related booking)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - Stripe v14 imports worked as expected, all Edge Functions deployed successfully.

## User Setup Required

**External services require manual configuration:**

The following environment variables and dashboard configuration are needed before the Stripe integration can be tested:

### Environment Variables

Add to Supabase Edge Function secrets (via `supabase secrets set`):

1. **STRIPE_SECRET_KEY** - Stripe Dashboard → Developers → API keys → Secret key (test mode)
   - Format: `sk_test_...`
   - Used for: All Stripe API operations

2. **STRIPE_WEBHOOK_SECRET** - Stripe Dashboard → Developers → Webhooks → Add endpoint → Signing secret
   - Format: `whsec_...`
   - Used for: Webhook signature verification

3. **STRIPE_PUBLISHABLE_KEY** (optional for future frontend use)
   - Format: `pk_test_...`
   - Used for: Client-side Stripe.js initialization

### Dashboard Configuration

**Stripe Dashboard → Connect:**
1. Enable Connect in test mode (if not already enabled)
2. Note: Platform account must exist before Express accounts can be created

**Stripe Dashboard → Developers → Webhooks:**
1. Add endpoint: `https://{project-ref}.supabase.co/functions/v1/stripe-webhooks`
2. Select events:
   - `account.updated` (Track medic onboarding completion)
   - `payment_intent.succeeded` (Confirm client payment)
   - `payment_intent.payment_failed` (Record payment failures)
   - `transfer.created` (Track medic payouts)
3. Copy signing secret to `STRIPE_WEBHOOK_SECRET`

### Verification Commands

After setup, verify with:

```bash
# List secrets (confirm all 3 exist)
supabase secrets list

# Test Express account creation (manual curl to Edge Function)
curl -X POST https://{project-ref}.supabase.co/functions/v1/stripe-connect \
  -H "Authorization: Bearer {anon-key}" \
  -H "Content-Type: application/json" \
  -d '{"action": "create_express_account", "medic_id": "...", "email": "...", "first_name": "...", "last_name": "..."}'

# Check Stripe Dashboard → Connect → Accounts (should show new Express account)
```

**Status:** User approved checkpoint - will complete setup later. Code is ready for deployment.

## Next Phase Readiness

**Ready for next phase (01.5-03 or later phases):**
- Stripe Connect infrastructure complete
- Express account creation ready (pending API keys)
- Payment Intent creation ready (pending API keys)
- Webhook processing ready (pending webhook endpoint configuration)

**Blockers/Concerns:**
- None - setup is straightforward once user has Stripe account
- Webhook endpoint URL requires Supabase project reference (available after deployment)

---
*Phase: 01.5-business-foundation*
*Completed: 2026-02-15*
