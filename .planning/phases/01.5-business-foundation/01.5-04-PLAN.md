---
phase: 01.5-business-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/seed-uk-postcodes/index.ts
  - scripts/generate-uk-postcodes.ts
  - data/uk_postcode_sectors.csv
autonomous: true

must_haves:
  truths:
    - "UK postcode sector database seeded with ~11,232 sectors"
    - "Each sector has correct region mapping (London, South East, North West, etc.)"
    - "Can assign primary medic to any territory sector"
    - "Can query territories by region to see coverage"
  artifacts:
    - path: "scripts/generate-uk-postcodes.ts"
      provides: "Script to generate UK postcode sector CSV from known postcode area definitions"
      min_lines: 100
    - path: "data/uk_postcode_sectors.csv"
      provides: "CSV of all UK postcode sectors with region mappings"
      contains: "postcode_sector,region"
    - path: "supabase/functions/seed-uk-postcodes/index.ts"
      provides: "Edge Function to batch-insert postcode sectors into territories table"
      exports: ["serve"]
  key_links:
    - from: "supabase/functions/seed-uk-postcodes/index.ts"
      to: "territories table"
      via: "Batch INSERT ... ON CONFLICT DO NOTHING"
      pattern: "supabase.*from.*territories.*insert"
    - from: "scripts/generate-uk-postcodes.ts"
      to: "data/uk_postcode_sectors.csv"
      via: "Writes CSV file from programmatic postcode area definitions"
      pattern: "writeFileSync.*uk_postcode_sectors"
---

<objective>
Seed the UK postcode sector database with ~11,232 sectors and region mappings for territory management.

Purpose: SiteMedic's territory system assigns primary and secondary medics to UK postcode sectors. This plan generates the complete UK postcode sector dataset from known postcode area definitions, creates a CSV data file, and builds a seeder Edge Function that batch-inserts sectors into the territories table. The existing test territory (E1, London) will be preserved.

Output: Postcode generation script, CSV data file, and seeder Edge Function.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-business-foundation/01.5-RESEARCH.md
@supabase/migrations/002_business_operations.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate UK postcode sector dataset</name>
  <files>
    scripts/generate-uk-postcodes.ts
    data/uk_postcode_sectors.csv
  </files>
  <action>
    Create `scripts/generate-uk-postcodes.ts` — a Node.js/TypeScript script that generates the UK postcode sector CSV.

    UK postcode structure: `AREA + DISTRICT + SECTOR + UNIT`
    - Area: 1-2 letters (e.g., E, SW, EC, WC, N, NW, SE, W, B, M, L, LS, S, G, EH)
    - District: 1-2 numbers after area (e.g., E1, SW1, EC2, M60)
    - Sector: We store at AREA+DISTRICT level (the "outward code"), NOT the full sector

    The script must define ALL 121 UK postcode areas with their district ranges and regions:

    **London postcode areas (10 areas):**
    - E (East London): districts 1-20, region "London"
    - EC (East Central London): districts 1-4, region "London"
    - N (North London): districts 1-22, region "London"
    - NW (North West London): districts 1-11, region "London"
    - SE (South East London): districts 1-28, region "London"
    - SW (South West London): districts 1-20, region "London"
    - W (West London): districts 1-14, region "London"
    - WC (West Central London): districts 1-2, region "London"

    **South East (13 areas):**
    - BN (Brighton): 1-45, "South East"
    - CT (Canterbury): 1-21, "South East"
    - DA (Dartford): 1-18, "South East"
    - GU (Guildford): 1-52, "South East"
    - HP (Hemel Hempstead): 1-27, "South East"
    - KT (Kingston upon Thames): 1-24, "South East"
    - ME (Medway): 1-20, "South East"
    - MK (Milton Keynes): 1-46, "South East"
    - OX (Oxford): 1-49, "South East"
    - PO (Portsmouth): 1-41, "South East"
    - RG (Reading): 1-45, "South East"
    - RH (Redhill): 1-20, "South East"
    - SL (Slough): 0-9, "South East"
    - SN (Swindon): 1-26, "South East" (note: also South West overlap)
    - SO (Southampton): 14-53, "South East"
    - TN (Tonbridge): 1-40, "South East"
    - TW (Twickenham): 1-20, "South East"

    **South West (8 areas):**
    - BA (Bath): 1-22, "South West"
    - BH (Bournemouth): 1-25, "South West"
    - BS (Bristol): 1-49, "South West"
    - DT (Dorchester): 1-11, "South West"
    - EX (Exeter): 1-39, "South West"
    - GL (Gloucester): 1-56, "South West"
    - PL (Plymouth): 1-35, "South West"
    - SP (Salisbury): 1-11, "South West"
    - TA (Taunton): 1-24, "South West"
    - TQ (Torquay): 1-14, "South West"
    - TR (Truro): 1-27, "South West"

    **East of England (7 areas):**
    - AL (St Albans): 1-10, "East of England"
    - CB (Cambridge): 1-25, "East of England"
    - CM (Chelmsford): 0-24, "East of England"
    - CO (Colchester): 1-16, "East of England"
    - EN (Enfield): 1-11, "East of England"
    - HA (Harrow): 0-9, "East of England"
    - IG (Ilford): 1-11, "East of England"
    - IP (Ipswich): 1-33, "East of England"
    - LU (Luton): 1-7, "East of England"
    - NR (Norwich): 1-35, "East of England"
    - PE (Peterborough): 1-38, "East of England"
    - RM (Romford): 1-20, "East of England"
    - SG (Stevenage): 1-19, "East of England"
    - SS (Southend-on-Sea): 0-17, "East of England"
    - UB (Southall): 1-11, "East of England"
    - WD (Watford): 1-25, "East of England"

    **West Midlands (6 areas):**
    - B (Birmingham): 1-98, "West Midlands"
    - CV (Coventry): 1-47, "West Midlands"
    - DY (Dudley): 1-14, "West Midlands"
    - HR (Hereford): 1-9, "West Midlands"
    - ST (Stoke-on-Trent): 1-21, "West Midlands"
    - TF (Telford): 1-13, "West Midlands"
    - WR (Worcester): 1-15, "West Midlands"
    - WS (Walsall): 1-15, "West Midlands"
    - WV (Wolverhampton): 1-16, "West Midlands"

    **East Midlands (5 areas):**
    - DE (Derby): 1-75, "East Midlands"
    - LE (Leicester): 1-67, "East Midlands"
    - LN (Lincoln): 1-13, "East Midlands"
    - NG (Nottingham): 1-34, "East Midlands"
    - NN (Northampton): 1-29, "East Midlands"

    **North West (8 areas):**
    - BB (Blackburn): 1-18, "North West"
    - BL (Bolton): 0-9, "North West"
    - CA (Carlisle): 1-28, "North West"
    - CH (Chester): 1-66, "North West"
    - CW (Crewe): 1-12, "North West"
    - FY (Blackpool): 0-8, "North West"
    - L (Liverpool): 1-40, "North West"
    - LA (Lancaster): 1-23, "North West"
    - M (Manchester): 1-60, "North West"
    - OL (Oldham): 1-16, "North West"
    - PR (Preston): 0-26, "North West"
    - SK (Stockport): 1-23, "North West"
    - WA (Warrington): 1-16, "North West"
    - WN (Wigan): 1-8, "North West"

    **Yorkshire & Humber (6 areas):**
    - BD (Bradford): 1-24, "Yorkshire and the Humber"
    - DN (Doncaster): 1-22, "Yorkshire and the Humber"
    - HD (Huddersfield): 1-9, "Yorkshire and the Humber"
    - HG (Harrogate): 1-5, "Yorkshire and the Humber"
    - HU (Hull): 1-20, "Yorkshire and the Humber"
    - HX (Halifax): 1-7, "Yorkshire and the Humber"
    - LS (Leeds): 1-29, "Yorkshire and the Humber"
    - S (Sheffield): 1-75, "Yorkshire and the Humber"
    - WF (Wakefield): 1-17, "Yorkshire and the Humber"
    - YO (York): 1-62, "Yorkshire and the Humber"

    **North East (4 areas):**
    - DH (Durham): 1-9, "North East"
    - DL (Darlington): 1-17, "North East"
    - NE (Newcastle upon Tyne): 1-71, "North East"
    - SR (Sunderland): 1-8, "North East"
    - TS (Teesside): 1-29, "North East"

    **Wales (8 areas):**
    - CF (Cardiff): 1-83, "Wales"
    - LD (Llandrindod Wells): 1-8, "Wales"
    - LL (Llandudno): 1-78, "Wales"
    - NP (Newport): 1-44, "Wales"
    - SA (Swansea): 1-73, "Wales"
    - SY (Shrewsbury): 1-25, "Wales" (border area)

    **Scotland (14 areas):**
    - AB (Aberdeen): 1-56, "Scotland"
    - DD (Dundee): 1-11, "Scotland"
    - DG (Dumfries): 1-16, "Scotland"
    - EH (Edinburgh): 1-55, "Scotland"
    - FK (Falkirk): 1-21, "Scotland"
    - G (Glasgow): 1-84, "Scotland"
    - HS (Outer Hebrides): 1-9, "Scotland"
    - IV (Inverness): 1-63, "Scotland"
    - KA (Kilmarnock): 1-30, "Scotland"
    - KW (Kirkwall): 1-17, "Scotland"
    - KY (Kirkcaldy): 1-16, "Scotland"
    - ML (Motherwell): 1-12, "Scotland"
    - PA (Paisley): 1-78, "Scotland"
    - PH (Perth): 1-50, "Scotland"
    - TD (Galashiels): 1-15, "Scotland"
    - ZE (Lerwick): 1-3, "Scotland"

    **Northern Ireland (1 area):**
    - BT (Belfast): 1-94, "Northern Ireland"

    **Crown Dependencies (2 areas):**
    - GY (Guernsey): 1-10, "Channel Islands"
    - JE (Jersey): 1-4, "Channel Islands"
    - IM (Isle of Man): 1-9, "Isle of Man"

    The script should:
    1. Define all areas with their district ranges and regions as a data structure
    2. Generate rows: for each area, for each district in range, create `{area}{district}, {region}`
    3. Write to `data/uk_postcode_sectors.csv` with header: `postcode_sector,region`
    4. Log total count (should be approximately 11,000-12,000 sectors)
    5. Can be run with: `npx tsx scripts/generate-uk-postcodes.ts`

    IMPORTANT: Some districts don't exist in reality (gaps in numbering), but we include them all for coverage. Real bookings will validate against actual postcodes via Postcodes.io API. Territory assignment works at sector level regardless.
  </action>
  <verify>
    - Script exists at `scripts/generate-uk-postcodes.ts`
    - CSV exists at `data/uk_postcode_sectors.csv` with header row
    - CSV has approximately 3,000-12,000 rows (UK has ~3,000 postcode districts, but ranges produce more entries)
    - All 12 UK regions represented: London, South East, South West, East of England, West Midlands, East Midlands, North West, Yorkshire and the Humber, North East, Wales, Scotland, Northern Ireland
    - Each row has format: `AB1,Scotland` (postcode_sector,region)
  </verify>
  <done>UK postcode sector CSV generated with all areas, districts, and region mappings</done>
</task>

<task type="auto">
  <name>Task 2: Postcode seeder Edge Function</name>
  <files>
    supabase/functions/seed-uk-postcodes/index.ts
  </files>
  <action>
    Create Edge Function `supabase/functions/seed-uk-postcodes/index.ts`:

    This function reads the postcode data (embedded as a constant, NOT from CSV file — Edge Functions can't read local files) and batch-inserts into territories table.

    Implementation:
    1. Embed the postcode area definitions directly in the Edge Function as a TypeScript constant (same data structure as the generation script). Do NOT try to read from CSV.

    2. Generate all sectors programmatically (same algorithm as generate-uk-postcodes.ts)

    3. Batch insert in chunks of 500 rows:
       ```typescript
       // For each batch of 500 sectors:
       const { error } = await supabase
         .from('territories')
         .insert(batch, { onConflict: 'postcode_sector' })
         // ON CONFLICT DO NOTHING to preserve existing assignments
       ```
       NOTE: Supabase JS client supports `upsert` with `ignoreDuplicates: true` option:
       ```typescript
       const { error } = await supabase
         .from('territories')
         .upsert(batch, { onConflict: 'postcode_sector', ignoreDuplicates: true })
       ```

    4. Track progress: log batch number and running total

    5. Return summary:
       ```json
       {
         "total_sectors_generated": 11232,
         "sectors_inserted": 11231,
         "sectors_skipped": 1,
         "regions": {
           "London": 145,
           "South East": 523,
           ...
         },
         "duration_ms": 4500
       }
       ```

    6. Idempotent: Uses upsert with ignoreDuplicates to skip existing rows (preserves the E1 test territory and any assigned medics)

    7. Use service role key (bypass RLS)
    8. Use Deno imports: `https://deno.land/std@0.168.0/http/server.ts`, `https://esm.sh/@supabase/supabase-js@2`
    9. Set max_travel_minutes default to 30 for all new territories

    IMPORTANT: The Edge Function must be self-contained. All postcode definitions must be embedded in the source file. The CSV file is for reference/verification only.
  </action>
  <verify>
    - Edge Function exists at `supabase/functions/seed-uk-postcodes/index.ts`
    - Contains embedded UK postcode area definitions (not file reads)
    - Uses upsert with ignoreDuplicates (preserves existing data)
    - Batch size of 500 rows per insert
    - Returns summary with total counts per region
    - Does not modify existing territories (E1 test territory preserved)
  </verify>
  <done>Seeder Edge Function can batch-insert ~11,000+ UK postcode sectors into territories table without affecting existing data</done>
</task>

</tasks>

<verification>
1. `scripts/generate-uk-postcodes.ts` runs and produces CSV
2. `data/uk_postcode_sectors.csv` has 3,000+ rows with correct format
3. `seed-uk-postcodes/index.ts` embeds same data and batch-inserts
4. All 12 UK regions are covered
5. Existing E1 territory with medic assignment is preserved (upsert with ignoreDuplicates)
6. Function returns count per region for verification
</verification>

<success_criteria>
- CSV generation script produces valid UK postcode sector data
- Seeder Edge Function inserts 3,000+ territory records
- All major UK regions represented (London through Northern Ireland)
- Existing territory assignments preserved (no data loss)
- Batch insert handles large dataset efficiently (500 per batch)
- Primary medic assignment capability verified (existing E1 test territory)
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-business-foundation/01.5-04-SUMMARY.md`
</output>
