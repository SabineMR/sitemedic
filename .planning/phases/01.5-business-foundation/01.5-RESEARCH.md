# Phase 1.5 Research: Business Operations Foundation

**Phase**: 1.5 - Business Operations Foundation (INSERTED)
**Researched**: 2026-02-15
**Dependencies**: Phase 1 (Supabase backend, auth)

---

## Overview

Phase 1.5 establishes the database schema, payment infrastructure, and territory system required to support the business operations layer. This enables SiteMedic to scale from single-medic operation to multi-medic UK-wide coverage with online booking, automated payments, and territory management.

**Key Components**:
1. Database schema for territories, bookings, clients, timesheets, payments
2. Stripe Connect integration (platform + medic Express accounts)
3. Google Maps Distance Matrix API with caching
4. UK postcode sector database seeding

---

## Database Schema Design

### Core Tables

#### territories
Stores UK postcode sectors with medic assignments for coverage management.

```sql
CREATE TABLE territories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  postcode_sector TEXT NOT NULL UNIQUE, -- e.g., "SW1A", "N1", "E14"
  region TEXT NOT NULL, -- e.g., "London", "Manchester", "Birmingham"
  primary_medic_id UUID REFERENCES medics(id),
  secondary_medic_id UUID REFERENCES medics(id),
  max_travel_minutes INT DEFAULT 30, -- Hybrid model: postcode + max travel time
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_territories_postcode ON territories(postcode_sector);
CREATE INDEX idx_territories_primary_medic ON territories(primary_medic_id);
CREATE INDEX idx_territories_secondary_medic ON territories(secondary_medic_id);
```

#### bookings
Stores medic shift bookings with pricing, status, and matching details.

```sql
CREATE TABLE bookings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  client_id UUID NOT NULL REFERENCES clients(id),
  medic_id UUID REFERENCES medics(id), -- NULL until assigned
  site_name TEXT NOT NULL,
  site_address TEXT NOT NULL,
  site_postcode TEXT NOT NULL,
  shift_date DATE NOT NULL,
  shift_start_time TIME NOT NULL,
  shift_end_time TIME NOT NULL,
  shift_hours DECIMAL(4,2) NOT NULL, -- e.g., 8.00

  -- Pricing breakdown
  base_rate DECIMAL(10,2) NOT NULL, -- Per hour
  urgency_premium_percent INT DEFAULT 0, -- 0, 20, 50, 75
  travel_surcharge DECIMAL(10,2) DEFAULT 0,
  out_of_territory_cost DECIMAL(10,2) DEFAULT 0, -- Travel bonus or room/board
  subtotal DECIMAL(10,2) NOT NULL,
  vat DECIMAL(10,2) NOT NULL, -- 20%
  total DECIMAL(10,2) NOT NULL,

  -- Status tracking
  status TEXT NOT NULL DEFAULT 'pending', -- pending, confirmed, in_progress, completed, cancelled
  requires_manual_approval BOOLEAN DEFAULT FALSE,
  approval_reason TEXT,

  -- Special requirements
  confined_space_required BOOLEAN DEFAULT FALSE,
  trauma_specialist_required BOOLEAN DEFAULT FALSE,
  special_notes TEXT,

  -- Recurring booking
  is_recurring BOOLEAN DEFAULT FALSE,
  recurrence_pattern TEXT, -- e.g., "weekly", "biweekly"
  recurring_until DATE,
  parent_booking_id UUID REFERENCES bookings(id), -- For recurring instances

  -- Auto-matching metadata
  auto_matched BOOLEAN DEFAULT FALSE,
  match_score DECIMAL(5,2), -- 0.00 to 100.00
  match_criteria JSONB, -- Store ranking breakdown

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  cancelled_at TIMESTAMPTZ,
  cancellation_reason TEXT
);

CREATE INDEX idx_bookings_client ON bookings(client_id);
CREATE INDEX idx_bookings_medic ON bookings(medic_id);
CREATE INDEX idx_bookings_date ON bookings(shift_date);
CREATE INDEX idx_bookings_status ON bookings(status);
CREATE INDEX idx_bookings_postcode ON bookings(site_postcode);
```

#### clients
Stores construction company accounts with payment terms.

```sql
CREATE TABLE clients (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_name TEXT NOT NULL,
  vat_number TEXT,
  billing_address TEXT NOT NULL,
  billing_postcode TEXT NOT NULL,

  -- Primary contact
  contact_name TEXT NOT NULL,
  contact_email TEXT NOT NULL,
  contact_phone TEXT NOT NULL,

  -- Payment terms
  payment_terms TEXT NOT NULL DEFAULT 'prepay', -- 'prepay' or 'net_30'
  credit_limit DECIMAL(10,2) DEFAULT 0, -- For Net 30 clients
  outstanding_balance DECIMAL(10,2) DEFAULT 0,

  -- Stripe
  stripe_customer_id TEXT UNIQUE,
  default_payment_method_id TEXT,

  -- Status
  status TEXT NOT NULL DEFAULT 'active', -- active, suspended, closed
  suspended_reason TEXT,

  -- Stats
  total_bookings INT DEFAULT 0,
  successful_bookings INT DEFAULT 0,
  cancelled_bookings INT DEFAULT 0,
  late_payments INT DEFAULT 0,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_clients_status ON clients(status);
CREATE INDEX idx_clients_stripe_customer ON clients(stripe_customer_id);
```

#### medics
Stores medic roster with qualifications and Stripe payout details.

```sql
CREATE TABLE medics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id), -- Links to Phase 1 auth
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT NOT NULL,

  -- Address (for travel time calculations)
  home_address TEXT NOT NULL,
  home_postcode TEXT NOT NULL,

  -- Qualifications
  has_confined_space_cert BOOLEAN DEFAULT FALSE,
  has_trauma_cert BOOLEAN DEFAULT FALSE,
  certifications JSONB, -- Store all certifications with expiry dates

  -- Stripe payout
  stripe_account_id TEXT UNIQUE, -- Stripe Express account ID
  stripe_onboarding_complete BOOLEAN DEFAULT FALSE,

  -- IR35 status
  employment_status TEXT NOT NULL DEFAULT 'self_employed', -- self_employed, umbrella
  utr TEXT, -- Unique Taxpayer Reference (for self-employed)
  umbrella_company_name TEXT,

  -- Performance
  star_rating DECIMAL(3,2) DEFAULT 0.00, -- 0.00 to 5.00
  total_shifts_completed INT DEFAULT 0,
  total_shifts_cancelled INT DEFAULT 0,
  riddor_compliance_rate DECIMAL(5,2) DEFAULT 100.00, -- Percentage

  -- Availability
  available_for_work BOOLEAN DEFAULT TRUE,
  unavailable_until DATE,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_medics_user ON medics(user_id);
CREATE INDEX idx_medics_stripe_account ON medics(stripe_account_id);
CREATE INDEX idx_medics_postcode ON medics(home_postcode);
CREATE INDEX idx_medics_available ON medics(available_for_work);
```

#### timesheets
Stores hours worked with approval workflow for payouts.

```sql
CREATE TABLE timesheets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  booking_id UUID NOT NULL REFERENCES bookings(id),
  medic_id UUID NOT NULL REFERENCES medics(id),

  -- Hours
  scheduled_hours DECIMAL(4,2) NOT NULL,
  logged_hours DECIMAL(4,2) NOT NULL,
  discrepancy_reason TEXT, -- If logged != scheduled

  -- Approval workflow
  medic_submitted_at TIMESTAMPTZ,
  manager_approved_at TIMESTAMPTZ,
  manager_approved_by UUID REFERENCES auth.users(id), -- Site manager
  admin_approved_at TIMESTAMPTZ,
  admin_approved_by UUID REFERENCES auth.users(id), -- Admin
  rejection_reason TEXT,

  -- Payout
  payout_amount DECIMAL(10,2) NOT NULL, -- Medic's 60% share
  payout_status TEXT NOT NULL DEFAULT 'pending', -- pending, approved, paid, rejected
  paid_at TIMESTAMPTZ,
  stripe_transfer_id TEXT, -- Stripe Transfer ID

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_timesheets_booking ON timesheets(booking_id);
CREATE INDEX idx_timesheets_medic ON timesheets(medic_id);
CREATE INDEX idx_timesheets_payout_status ON timesheets(payout_status);
```

#### invoices
Stores client invoices with VAT and payment tracking.

```sql
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  invoice_number TEXT NOT NULL UNIQUE, -- e.g., "INV-2026-001"
  client_id UUID NOT NULL REFERENCES clients(id),

  -- Amounts
  subtotal DECIMAL(10,2) NOT NULL,
  vat DECIMAL(10,2) NOT NULL, -- 20%
  total DECIMAL(10,2) NOT NULL,

  -- Payment terms
  invoice_date DATE NOT NULL,
  due_date DATE NOT NULL, -- invoice_date + 30 days for Net 30
  payment_terms TEXT NOT NULL, -- 'prepay' or 'net_30'

  -- Status
  status TEXT NOT NULL DEFAULT 'draft', -- draft, sent, paid, overdue, cancelled
  sent_at TIMESTAMPTZ,
  paid_at TIMESTAMPTZ,

  -- Reminders
  reminder_sent_7_days BOOLEAN DEFAULT FALSE,
  reminder_sent_14_days BOOLEAN DEFAULT FALSE,
  reminder_sent_21_days BOOLEAN DEFAULT FALSE,
  late_fee_charged DECIMAL(10,2) DEFAULT 0, -- Statutory late fees

  -- PDF
  pdf_url TEXT, -- Supabase Storage signed URL

  -- Line items stored in separate table (invoices_line_items)

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_invoices_client ON invoices(client_id);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_due_date ON invoices(due_date);
CREATE INDEX idx_invoices_number ON invoices(invoice_number);
```

#### payments
Stores Stripe payment transactions.

```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  invoice_id UUID REFERENCES invoices(id),
  booking_id UUID REFERENCES bookings(id), -- For prepay bookings
  client_id UUID NOT NULL REFERENCES clients(id),

  -- Stripe
  stripe_payment_intent_id TEXT UNIQUE,
  stripe_charge_id TEXT,

  -- Amounts
  amount DECIMAL(10,2) NOT NULL,
  platform_fee DECIMAL(10,2) NOT NULL, -- 40% markup
  medic_payout DECIMAL(10,2) NOT NULL, -- 60% to medic

  -- Status
  status TEXT NOT NULL DEFAULT 'pending', -- pending, succeeded, failed, refunded
  failure_reason TEXT,

  -- Refunds
  refunded_amount DECIMAL(10,2) DEFAULT 0,
  refund_reason TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_payments_invoice ON payments(invoice_id);
CREATE INDEX idx_payments_booking ON payments(booking_id);
CREATE INDEX idx_payments_client ON payments(client_id);
CREATE INDEX idx_payments_stripe_intent ON payments(stripe_payment_intent_id);
```

#### travel_time_cache
Caches Google Maps API results to reduce costs (7-day TTL).

```sql
CREATE TABLE travel_time_cache (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  origin_postcode TEXT NOT NULL,
  destination_postcode TEXT NOT NULL,
  travel_time_minutes INT NOT NULL,
  distance_miles DECIMAL(6,2) NOT NULL,
  cached_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ DEFAULT NOW() + INTERVAL '7 days',

  UNIQUE(origin_postcode, destination_postcode)
);

CREATE INDEX idx_travel_cache_origin ON travel_time_cache(origin_postcode);
CREATE INDEX idx_travel_cache_destination ON travel_time_cache(destination_postcode);
CREATE INDEX idx_travel_cache_expires ON travel_time_cache(expires_at);
```

#### territory_metrics
Daily analytics for hiring decisions and coverage gap detection.

```sql
CREATE TABLE territory_metrics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  postcode_sector TEXT NOT NULL,
  metric_date DATE NOT NULL,

  -- Bookings
  total_bookings INT DEFAULT 0,
  confirmed_bookings INT DEFAULT 0,
  rejected_bookings INT DEFAULT 0,
  rejection_rate DECIMAL(5,2) DEFAULT 0.00, -- Percentage

  -- Utilization
  primary_medic_id UUID REFERENCES medics(id),
  primary_medic_utilization DECIMAL(5,2) DEFAULT 0.00, -- Percentage
  secondary_medic_id UUID REFERENCES medics(id),
  secondary_medic_utilization DECIMAL(5,2) DEFAULT 0.00,

  -- Coverage
  fulfillment_rate DECIMAL(5,2) DEFAULT 100.00, -- % successfully filled
  avg_travel_time_minutes DECIMAL(6,2),

  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(postcode_sector, metric_date)
);

CREATE INDEX idx_territory_metrics_postcode ON territory_metrics(postcode_sector);
CREATE INDEX idx_territory_metrics_date ON territory_metrics(metric_date);
```

### Row-Level Security (RLS) Policies

All tables must have RLS policies to isolate data by user role:

- **Clients**: Can only see their own bookings, invoices, payments
- **Medics**: Can only see their own bookings, timesheets, payouts
- **Site Managers**: Can see bookings for their sites, approve timesheets
- **Admins**: Full access to all tables

Example RLS policy for bookings table:
```sql
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;

-- Clients can only see their own bookings
CREATE POLICY "Clients can view own bookings" ON bookings
  FOR SELECT USING (
    auth.uid() IN (
      SELECT user_id FROM clients WHERE id = bookings.client_id
    )
  );

-- Admins can see all bookings
CREATE POLICY "Admins can view all bookings" ON bookings
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM auth.users
      WHERE auth.uid() = id AND role = 'admin'
    )
  );
```

---

## Stripe Connect Integration

### Architecture

**Platform Account** (SiteMedic):
- Stripe Connect platform account
- Charges clients via Payment Intents
- Holds platform fees (40%)
- Transfers medic payouts (60%)

**Medic Express Accounts**:
- Each medic has Stripe Express account
- Onboarding via Stripe hosted flow
- Bank account verification (UK accounts only)
- KYC/identity verification
- Payouts via UK Faster Payments (2 business days)

### Payment Flow

1. **Client Prepay Booking**:
   - Client enters card details (Stripe Elements)
   - Create Stripe Payment Intent (£42 for 1-hour shift)
   - 3D Secure authentication (SCA compliant)
   - Charge succeeds → funds held in platform account
   - Platform fee: £12 (40%)
   - Medic payout pending: £30 (60%)

2. **Weekly Medic Payout**:
   - Friday payout job runs (Supabase Edge Function cron)
   - Admin-approved timesheets fetched
   - For each timesheet:
     - Create Stripe Transfer to medic Express account
     - Amount: £30/hour × hours worked
     - Destination: medic's Express account ID
   - Email confirmation to medic

3. **Net 30 Invoice**:
   - Invoice generated Friday (PDF via Edge Function)
   - Email to client with payment link
   - Due date: 30 days from invoice date
   - Client pays via Stripe Checkout or bank transfer
   - Late payment reminders at 7, 14, 21 days
   - Statutory late fees: £40-100 (depending on amount)

### Stripe Connect Setup

```javascript
// Create Express account for medic
const account = await stripe.accounts.create({
  type: 'express',
  country: 'GB',
  capabilities: {
    transfers: { requested: true },
  },
  business_type: 'individual', // Self-employed
  individual: {
    email: medic.email,
    first_name: medic.first_name,
    last_name: medic.last_name,
  },
});

// Generate onboarding link
const accountLink = await stripe.accountLinks.create({
  account: account.id,
  refresh_url: 'https://sitemedic.co.uk/medic/onboarding/refresh',
  return_url: 'https://sitemedic.co.uk/medic/onboarding/complete',
  type: 'account_onboarding',
});

// Redirect medic to accountLink.url
```

### Payment Intent Creation

```javascript
// Client prepay booking
const paymentIntent = await stripe.paymentIntents.create({
  amount: 4200, // £42.00 in pence
  currency: 'gbp',
  customer: client.stripe_customer_id,
  payment_method: client.default_payment_method_id,
  confirm: true,
  metadata: {
    booking_id: booking.id,
    client_id: client.id,
    medic_id: booking.medic_id,
  },
  description: `Medic booking for ${booking.site_name} on ${booking.shift_date}`,
});
```

### Transfer to Medic

```javascript
// Weekly payout job
const transfer = await stripe.transfers.create({
  amount: 3000, // £30.00 in pence
  currency: 'gbp',
  destination: medic.stripe_account_id,
  metadata: {
    timesheet_id: timesheet.id,
    medic_id: medic.id,
    booking_id: timesheet.booking_id,
  },
  description: `Payout for shift on ${booking.shift_date}`,
});

// Update timesheet with transfer ID
await supabase
  .from('timesheets')
  .update({
    stripe_transfer_id: transfer.id,
    payout_status: 'paid',
    paid_at: new Date().toISOString(),
  })
  .eq('id', timesheet.id);
```

---

## Google Maps Distance Matrix API

### Purpose
Calculate travel time from medic's home to job site for auto-assignment ranking.

### API Usage

```javascript
// Calculate travel time
const response = await fetch(
  `https://maps.googleapis.com/maps/api/distancematrix/json?` +
  `origins=${medic.home_postcode}&` +
  `destinations=${booking.site_postcode}&` +
  `mode=driving&` +
  `departure_time=now&` + // Account for traffic
  `key=${GOOGLE_MAPS_API_KEY}`
);

const data = await response.json();
const element = data.rows[0].elements[0];

if (element.status === 'OK') {
  const travelTimeMinutes = Math.round(element.duration_in_traffic.value / 60);
  const distanceMiles = (element.distance.value / 1609.34).toFixed(2);

  // Cache result for 7 days
  await supabase.from('travel_time_cache').insert({
    origin_postcode: medic.home_postcode,
    destination_postcode: booking.site_postcode,
    travel_time_minutes: travelTimeMinutes,
    distance_miles: distanceMiles,
  });
}
```

### Cost Optimization

**Caching Strategy**:
- Cache results for 7 days (traffic patterns relatively stable)
- Reduces API calls by ~80% (most bookings use same medic-site pairs)
- Example: 100 bookings/week × £0.005/call = £0.50/week
- With cache: 20 new calls/week = £0.10/week (80% savings)

**Haversine Fallback**:
If Google Maps API unavailable or rate limit exceeded, use haversine formula for straight-line distance estimation:

```javascript
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 3959; // Earth radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // Distance in miles
}

// Estimate travel time: distance / avg speed (30 mph urban)
const travelTimeMinutes = Math.round((distance / 30) * 60);
```

---

## UK Postcode Database Seeding

### Data Source
Use official UK postcode dataset (Royal Mail PAF or open data sources like ONS Postcode Directory).

### Seeding Strategy

**Postcode Sector Level** (~11,232 sectors):
- Sector: First 3-4 characters (e.g., "SW1A", "N1", "E14")
- Balances granularity with manageability
- Each sector contains ~1,500-3,000 addresses

**Seeding Script**:
```sql
-- Example seed data (first 10 London sectors)
INSERT INTO territories (postcode_sector, region) VALUES
  ('E1', 'London'),
  ('E2', 'London'),
  ('E3', 'London'),
  ('E4', 'London'),
  ('E5', 'London'),
  ('E6', 'London'),
  ('E7', 'London'),
  ('E8', 'London'),
  ('E9', 'London'),
  ('E10', 'London');

-- Full seeding from CSV
COPY territories(postcode_sector, region)
FROM '/path/to/uk_postcode_sectors.csv'
DELIMITER ','
CSV HEADER;
```

**CSV Format**:
```csv
postcode_sector,region
E1,London
E2,London
SW1A,London
M1,Manchester
B1,Birmingham
...
```

### Territory Assignment

Initially, all territories have NULL primary/secondary medics. Admin assigns medics via drag-drop UI in Phase 7.5.

---

## Implementation Plans

### Plan 01.5-01: Database Schema
- Create all 9 core tables with proper indexes
- Implement RLS policies for multi-tenant access
- Add database triggers for updated_at timestamps
- Seed basic test data (1 client, 1 medic, 1 territory)

### Plan 01.5-02: Stripe Connect Integration
- Set up platform Stripe account (test mode)
- Implement medic Express account creation
- Test payment flow (charge client, transfer to medic)
- Handle webhooks (payment succeeded, transfer completed)

### Plan 01.5-03: Google Maps API Integration
- Implement Distance Matrix API calls
- Build 7-day caching layer
- Add haversine fallback for API failures
- Test with sample UK postcodes

### Plan 01.5-04: UK Postcode Database Seeding
- Source UK postcode sector dataset
- Create seeding script (SQL COPY or batch INSERT)
- Validate ~11,232 sectors imported
- Add region mappings (London, Manchester, etc.)

---

## Success Criteria

- ✅ All 9 tables created with RLS policies
- ✅ Can create test client, medic, booking via SQL
- ✅ Stripe Connect test mode charges succeed
- ✅ Medic Express account onboarding link works
- ✅ Google Maps API returns travel time <500ms
- ✅ 7-day cache reduces API calls by >70%
- ✅ UK postcode sectors seeded (~11,232 rows)
- ✅ Can assign primary medic to territory

---

**Next Phase**: Phase 4.5 (Marketing Website & Booking Portal) uses this database schema and Stripe integration.
