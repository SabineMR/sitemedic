---
phase: 01.5-business-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/stripe-connect/index.ts
  - supabase/functions/stripe-webhooks/index.ts
  - supabase/functions/_shared/stripe.ts
autonomous: false

user_setup:
  - service: stripe
    why: "Payment processing for client charges and medic payouts"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (test mode)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint -> Signing secret"
      - name: STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key (test mode)"
    dashboard_config:
      - task: "Enable Connect in test mode"
        location: "Stripe Dashboard -> Connect -> Get started"
      - task: "Add webhook endpoint for account.updated and payment_intent.succeeded events"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"

must_haves:
  truths:
    - "Stripe Connect platform account exists in test mode"
    - "Can create Stripe Express account for a test medic"
    - "Medic onboarding link redirects to Stripe hosted flow"
    - "Webhook handler processes account.updated events to track onboarding completion"
    - "Can create test Payment Intent for a client booking"
  artifacts:
    - path: "supabase/functions/stripe-connect/index.ts"
      provides: "Express account creation, onboarding link generation, Payment Intent creation"
      exports: ["serve"]
    - path: "supabase/functions/stripe-webhooks/index.ts"
      provides: "Webhook handler for Stripe events"
      exports: ["serve"]
    - path: "supabase/functions/_shared/stripe.ts"
      provides: "Shared Stripe client initialization"
      exports: ["stripe"]
  key_links:
    - from: "supabase/functions/stripe-connect/index.ts"
      to: "medics table"
      via: "Updates stripe_account_id and stripe_onboarding_complete"
      pattern: "supabase.*from.*medics.*update"
    - from: "supabase/functions/stripe-webhooks/index.ts"
      to: "medics table"
      via: "Updates onboarding status on account.updated webhook"
      pattern: "supabase.*from.*medics.*update"
    - from: "supabase/functions/stripe-connect/index.ts"
      to: "payments table"
      via: "Creates payment record on Payment Intent creation"
      pattern: "supabase.*from.*payments.*insert"
---

<objective>
Integrate Stripe Connect for platform payments and medic payouts.

Purpose: SiteMedic charges clients via Stripe and pays medics via Stripe Express accounts. This plan sets up the Stripe Connect infrastructure: Express account creation for medics, onboarding flow, Payment Intent creation for client charges, and webhook handling for event processing.

Output: Three Edge Functions (stripe-connect, stripe-webhooks, shared stripe client) that enable the full Stripe Connect payment flow in test mode.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-business-foundation/01.5-RESEARCH.md
@supabase/migrations/002_business_operations.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared Stripe client and Connect Edge Function</name>
  <files>
    supabase/functions/_shared/stripe.ts
    supabase/functions/stripe-connect/index.ts
  </files>
  <action>
    1. Create shared Stripe client `supabase/functions/_shared/stripe.ts`:
       - Import Stripe from `https://esm.sh/stripe@14?target=deno` (Deno-compatible)
       - Initialize: `new Stripe(Deno.env.get('STRIPE_SECRET_KEY')!, { apiVersion: '2024-12-18.acacia', httpClient: Stripe.createFetchHttpClient() })`
       - Export `stripe` instance and `STRIPE_WEBHOOK_SECRET`
       - NOTE: Use Stripe v14 for Deno compatibility (CommonJS issues with older versions)

    2. Create Edge Function `supabase/functions/stripe-connect/index.ts`:
       - Import shared stripe client
       - Route by `action` field in POST body:

       **action: "create_express_account"**
       - Input: `{ medic_id, email, first_name, last_name }`
       - Creates Stripe Express account:
         ```
         stripe.accounts.create({
           type: 'express',
           country: 'GB',
           capabilities: { transfers: { requested: true } },
           business_type: 'individual',
           individual: { email, first_name, last_name },
         })
         ```
       - Updates medics table: `stripe_account_id = account.id`
       - Generates onboarding link:
         ```
         stripe.accountLinks.create({
           account: account.id,
           refresh_url: `${SITE_URL}/medic/onboarding/refresh`,
           return_url: `${SITE_URL}/medic/onboarding/complete`,
           type: 'account_onboarding',
         })
         ```
       - Returns: `{ account_id, onboarding_url }`

       **action: "create_payment_intent"**
       - Input: `{ booking_id, client_id, amount_pence, description }`
       - Looks up client's stripe_customer_id from clients table
       - Creates Payment Intent:
         ```
         stripe.paymentIntents.create({
           amount: amount_pence,
           currency: 'gbp',
           customer: stripe_customer_id,
           metadata: { booking_id, client_id },
           description,
         })
         ```
       - Inserts record into payments table with status='pending'
       - Returns: `{ client_secret, payment_intent_id }`

       **action: "create_customer"**
       - Input: `{ client_id, email, company_name }`
       - Creates Stripe Customer: `stripe.customers.create({ email, name: company_name, metadata: { client_id } })`
       - Updates clients table: `stripe_customer_id = customer.id`
       - Returns: `{ customer_id }`

       **action: "check_account_status"**
       - Input: `{ stripe_account_id }`
       - Retrieves account: `stripe.accounts.retrieve(stripe_account_id)`
       - Returns: `{ charges_enabled, payouts_enabled, details_submitted }`

       - All actions require Authorization header (Bearer token from Supabase auth)
       - CORS headers matching existing Edge Functions pattern
       - Error handling: return 400 for invalid input, 500 for Stripe errors
       - Use Supabase service role for DB operations (bypass RLS for admin operations)
  </action>
  <verify>
    - `_shared/stripe.ts` imports Stripe v14 and exports stripe instance
    - `stripe-connect/index.ts` handles all 4 actions
    - Express account creation calls `stripe.accounts.create` with type 'express' and country 'GB'
    - Payment Intent creation inserts into payments table
    - Customer creation updates clients table with stripe_customer_id
  </verify>
  <done>Stripe Connect Edge Function handles Express account creation, Payment Intent creation, customer creation, and account status checks</done>
</task>

<task type="auto">
  <name>Task 2: Stripe webhook handler</name>
  <files>
    supabase/functions/stripe-webhooks/index.ts
  </files>
  <action>
    Create Edge Function `supabase/functions/stripe-webhooks/index.ts`:

    1. Webhook signature verification:
       - Read raw body as text (NOT json - signature verification needs raw body)
       - Verify signature: `stripe.webhooks.constructEvent(body, sig, STRIPE_WEBHOOK_SECRET)`
       - Return 400 if signature invalid

    2. Handle events by type:

       **account.updated** (Express account onboarding status):
       - Extract account.id from event.data.object
       - Check if charges_enabled and payouts_enabled are true
       - If both true: update medics table SET stripe_onboarding_complete = true WHERE stripe_account_id = account.id
       - Log: "Medic onboarding complete for account {id}"

       **payment_intent.succeeded**:
       - Extract payment_intent.id and metadata (booking_id, client_id)
       - Update payments table: SET status = 'succeeded', stripe_charge_id = latest_charge
       - Update bookings table: SET status = 'confirmed' WHERE id = booking_id (if currently 'pending')
       - Log: "Payment succeeded for booking {booking_id}"

       **payment_intent.payment_failed**:
       - Update payments table: SET status = 'failed', failure_reason = last_payment_error.message
       - Log warning: "Payment failed for booking {booking_id}: {reason}"

       **transfer.created** (medic payout):
       - Extract transfer metadata (timesheet_id, medic_id)
       - Update timesheets table: SET stripe_transfer_id = transfer.id
       - Log: "Transfer created for medic {medic_id}"

    3. Return 200 for all handled events, 200 with warning for unhandled events
    4. Use Supabase service role key for DB updates (webhooks have no user context)
    5. IMPORTANT: Do NOT parse body as JSON before signature verification
  </action>
  <verify>
    - Webhook handler verifies Stripe signature before processing
    - account.updated handler updates medics.stripe_onboarding_complete
    - payment_intent.succeeded updates payments and bookings tables
    - payment_intent.payment_failed records failure reason
    - transfer.created updates timesheets with transfer ID
    - Returns 200 for all events (Stripe retries on non-2xx)
  </verify>
  <done>Webhook handler processes account.updated, payment_intent.succeeded, payment_intent.payment_failed, and transfer.created events with correct database updates</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stripe Connect Edge Functions (stripe-connect, stripe-webhooks, shared client) that enable Express account creation, Payment Intent creation, and webhook processing</what-built>
  <how-to-verify>
    1. Verify Stripe test mode API keys are set in Supabase Edge Function secrets:
       - STRIPE_SECRET_KEY (starts with sk_test_)
       - STRIPE_WEBHOOK_SECRET (starts with whsec_)
    2. Review the Edge Function code in supabase/functions/stripe-connect/index.ts
    3. Confirm the webhook handler in supabase/functions/stripe-webhooks/index.ts handles all 4 event types
    4. Check that supabase/functions/_shared/stripe.ts uses Stripe v14 for Deno compatibility
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. All 3 files exist: `_shared/stripe.ts`, `stripe-connect/index.ts`, `stripe-webhooks/index.ts`
2. Stripe client uses v14 Deno-compatible import
3. Express account creation targets GB country with transfers capability
4. Webhook signature verification happens before event processing
5. Payment Intent creation stores record in payments table
6. Account onboarding completion updates medics table
</verification>

<success_criteria>
- Shared Stripe client initializes with test mode key
- Can create Express account for medic (returns account_id and onboarding_url)
- Can create Payment Intent for booking (returns client_secret)
- Can create Stripe Customer for client
- Webhook handler processes 4 event types with correct DB updates
- All DB updates use service role (bypass RLS)
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-business-foundation/01.5-02-SUMMARY.md`
</output>
