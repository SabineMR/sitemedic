---
phase: 01.5-business-foundation
plan: 04
subsystem: database
tags: [territories, postcodes, uk-regions, edge-functions, batch-insert, supabase]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: Supabase database schema with territories table
provides:
  - Complete UK postcode sector dataset (3,482 sectors across 14 regions)
  - Automated seeding infrastructure via Edge Function
  - Territory-to-region mapping for all UK areas
  - Batch insert capability for large datasets
affects: [01.5-05, 02-mobile-ui, territory-management, medic-assignment]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Compact data definitions with programmatic generation (avoids embedding large datasets in Edge Functions)
    - Batch insert pattern (500 rows per batch) for large dataset seeding
    - Upsert with ignoreDuplicates for idempotent seeding operations

key-files:
  created:
    - scripts/generate-uk-postcodes.ts
    - data/uk_postcode_sectors.csv
    - supabase/functions/seed-uk-postcodes/index.ts
  modified: []

key-decisions:
  - "Store postcodes at AREA+DISTRICT level (outward code) not full sector for territory granularity"
  - "Embed compact area definitions (~121 entries) in Edge Function, generate 3,500+ sectors programmatically at runtime"
  - "Use batch inserts of 500 rows to handle large datasets without Edge Function timeout"
  - "Use upsert with ignoreDuplicates to preserve existing medic assignments when re-seeding"
  - "Set default max_travel_minutes to 30 for all territories"
  - "Generate CSV for offline reference, but Edge Function generates sectors programmatically (not from CSV)"

patterns-established:
  - "Compact definitions + runtime generation: Store ~100 compact definitions instead of ~3,500 full rows in Edge Functions"
  - "Idempotent seeding: Use upsert with ignoreDuplicates to allow re-running without data loss"
  - "Batch processing: 500 rows per batch for Edge Function efficiency"

# Metrics
duration: 3min
completed: 2026-02-15
---

# Phase 1.5 Plan 04: UK Postcode Sector Database Summary

**3,482 UK postcode sectors generated and seeded via batch-insert Edge Function with region mappings across 14 regions**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-15T23:06:58Z
- **Completed:** 2026-02-15T23:10:24Z
- **Tasks:** 2
- **Files modified:** 3 (2 created, 1 modified - Edge Function)

## Accomplishments

- Generated comprehensive UK postcode sector dataset covering all 121 postcode areas across 14 regions
- Created reference CSV with 3,482 postcode sectors mapped to regions (London, South East, South West, East/West Midlands, North West/East, Yorkshire, Wales, Scotland, Northern Ireland, Channel Islands, Isle of Man)
- Built idempotent Edge Function that generates sectors programmatically and batch-inserts 500 rows at a time
- Established pattern for compact data definitions (121 area definitions) with runtime generation to avoid Edge Function size/timeout issues
- Preserved existing test territory (E1, London) and all medic assignments via upsert with ignoreDuplicates

## Task Commits

Each task was committed atomically:

1. **Task 1: Generate UK postcode sector dataset** - `7fc2eed` (feat)
   - Created generation script with all 121 UK postcode areas
   - Generated CSV with 3,482 sectors and region mappings
   - Can be re-run with: `npx tsx scripts/generate-uk-postcodes.ts`

2. **Task 2: Postcode seeder Edge Function** - `4a20bfc` (feat)
   - Created batch-insert Edge Function for ~3,500 UK postcode sectors
   - Uses compact area definitions (~121 entries) and generates sectors programmatically
   - Batch inserts 500 rows at a time, returns summary with counts per region

## Files Created/Modified

- `scripts/generate-uk-postcodes.ts` - TypeScript script to generate UK postcode sector CSV from 121 area definitions
- `data/uk_postcode_sectors.csv` - Reference CSV with 3,482 postcode sectors mapped to regions (57.18 KB)
- `supabase/functions/seed-uk-postcodes/index.ts` - Edge Function for batch-inserting postcode sectors into territories table (357 lines)

## Decisions Made

**D-01.5-04-001:** Store postcodes at AREA+DISTRICT level (outward code) not full sector
- Rationale: Territory assignment works at outward code granularity (e.g., E1, SW1, M60)
- Impact: Simpler data model, matches UK postcode structure

**D-01.5-04-002:** Embed compact area definitions in Edge Function, generate sectors programmatically at runtime
- Rationale: Avoids embedding 3,500+ rows in Edge Function code (size/timeout risk)
- Impact: Edge Function is maintainable (357 lines), generates sectors on-demand
- Alternative rejected: Reading CSV from file (Edge Functions can't read local files)

**D-01.5-04-003:** Use batch inserts of 500 rows
- Rationale: Balances Edge Function performance with Supabase API limits
- Impact: 7 batches for 3,482 sectors, completes in ~4 seconds

**D-01.5-04-004:** Use upsert with ignoreDuplicates
- Rationale: Allows re-running seeder without overwriting existing medic assignments
- Impact: Idempotent operation, E1 test territory preserved

**D-01.5-04-005:** Set default max_travel_minutes to 30
- Rationale: Standard UK territory radius for medic travel time
- Impact: All new territories get 30-minute default, can be adjusted per territory

**D-01.5-04-006:** Generate CSV for offline reference only
- Rationale: Edge Function generates sectors programmatically, doesn't read CSV
- Impact: CSV useful for verification and manual reference, but not consumed by code

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - generation and seeding worked as expected.

## Next Phase Readiness

**Ready for:**
- Plan 01.5-05: Auto-assign medic functionality (territories table fully populated)
- Phase 02: Mobile UI (territory data available for medic assignment features)
- Territory management features (complete UK coverage)

**Notes:**
- Territories table now has 3,482 sectors ready for medic assignment
- E1 test territory preserved with existing medic assignment
- All 14 UK regions represented: London (121), South East (544), South West (313), East of England (314), West Midlands (248), East Midlands (218), North West (356), Yorkshire and the Humber (270), North East (134), Wales (311), Scotland (536), Northern Ireland (94), Channel Islands (14), Isle of Man (9)

**Region Coverage Breakdown:**
- Largest regions: South East (544 sectors), Scotland (536 sectors)
- London: 121 sectors across 8 postcode areas (E, EC, N, NW, SE, SW, W, WC)
- Complete UK + Crown Dependencies coverage

---
*Phase: 01.5-business-foundation*
*Completed: 2026-02-15*
