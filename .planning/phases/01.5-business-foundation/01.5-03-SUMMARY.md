---
phase: 01.5-business-foundation
plan: 03
subsystem: api
tags: [deno, edge-functions, google-maps, auto-assignment, territory-management, postgres]

# Dependency graph
requires:
  - phase: 01.5-02
    provides: Google Maps Distance Matrix API integration with 7-day caching and haversine fallback
provides:
  - Auto-assignment algorithm with 4-factor medic ranking (distance, utilization, qualifications, rating)
  - Territory priority system (+10 for primary medic, +5 for secondary)
  - Out-of-territory cost calculator (travel bonus vs room/board vs deny)
  - Automated cache cleanup for expired travel time entries
affects: [booking-portal, admin-dashboard, medic-roster-management, territory-optimization]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Multi-factor ranking algorithm (100-point scale)"
    - "Territory-based medic priority system"
    - "Cost-benefit analysis for out-of-territory bookings"
    - "PostgreSQL function for scheduled cleanup (pg_cron compatible)"

key-files:
  created:
    - supabase/functions/auto-assign-medic/index.ts
    - supabase/functions/calculate-out-of-territory/index.ts
    - supabase/migrations/005_cache_cleanup.sql
  modified: []

key-decisions:
  - "D-01.5-03-001: Auto-assignment requires score >= 50 to assign automatically, otherwise manual approval"
  - "D-01.5-03-002: Distance scoring uses 40pts max (40 - travel_time/2) to heavily favor nearby medics"
  - "D-01.5-03-003: Utilization scoring favors under-utilized medics (25pts * (1 - utilization_pct/100))"
  - "D-01.5-03-004: New medics (0 rating) get 15 points benefit-of-doubt vs rating-based 0-20 points"
  - "D-01.5-03-005: Travel bonus is £2/mile beyond 30 miles, room/board is fixed £85 for >90min travel"
  - "D-01.5-03-006: Deny recommendation when cost >50% of shift value to prevent unprofitable bookings"
  - "D-01.5-03-007: All out-of-territory bookings require admin approval regardless of cost"
  - "D-01.5-03-008: Cache cleanup scheduled daily at 3 AM UTC via pg_cron (manual fallback provided)"

patterns-established:
  - "4-factor scoring system: distance (40), utilization (25), qualifications (15), rating (20)"
  - "Territory priority bonus: primary +10, secondary +5 (can exceed 100 total score)"
  - "Match criteria stored as JSONB for transparency and debugging"
  - "Booking status auto-updates to 'assigned' only when score >= 50"

# Metrics
duration: 3min
completed: 2026-02-15
---

# Phase 01.5 Plan 03: Auto-Assignment & Out-of-Territory Summary

**Auto-assignment algorithm ranks medics with 4-factor scoring (distance 40pts, utilization 25pts, qualifications 15pts, rating 20pts) and territory priority bonuses, plus out-of-territory cost optimizer recommending travel bonus vs room/board vs deny**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-15T23:18:16Z
- **Completed:** 2026-02-15T23:21:31Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- Auto-assignment Edge Function filters unavailable/unqualified/double-booked medics, ranks by 4 factors, auto-assigns if score >= 50
- Territory priority system gives primary medics +10 bonus, secondary +5 bonus for their assigned postcodes
- Out-of-territory cost calculator compares travel bonus (£2/mile >30mi) vs room/board (£85 if >90min) vs deny (if cost >50% shift value)
- Cache cleanup function with pg_cron daily scheduling at 3 AM UTC (manual fallback available)

## Task Commits

Each task was committed atomically:

1. **Task 1: Auto-assignment algorithm Edge Function** - `6fc594f` (feat)
2. **Task 2: Out-of-territory cost calculator and cache cleanup** - `220a48a` (feat)

## Files Created/Modified
- `supabase/functions/auto-assign-medic/index.ts` - Multi-factor medic ranking with territory priority and auto-assignment logic
- `supabase/functions/calculate-out-of-territory/index.ts` - Travel bonus vs room/board vs deny cost optimizer for out-of-territory bookings
- `supabase/migrations/005_cache_cleanup.sql` - PostgreSQL function to delete expired cache entries with pg_cron daily scheduling

## Decisions Made

**D-01.5-03-001:** Auto-assignment requires score >= 50 to assign automatically
- Rationale: Low-score matches need human review to prevent poor assignments
- Implementation: `requires_manual_approval = true` when score < 50, status stays 'pending'

**D-01.5-03-002:** Distance scoring uses 40pts max (40 - travel_time/2)
- Rationale: Distance is most important factor (40% weight), heavily penalizes long travel times
- Example: 20min = 30-40pts, 40min = 20-30pts, 60+min = 0-10pts

**D-01.5-03-003:** Utilization scoring favors under-utilized medics
- Rationale: Spread work evenly, prevent burnout, maintain availability pool
- Formula: 25 * (1 - utilization_pct/100), so <50% util = 12-25pts, >80% util = 0-5pts

**D-01.5-03-004:** New medics (0 rating) get 15 points benefit-of-doubt
- Rationale: Avoid chicken-and-egg problem where new medics never get assignments
- Established medics: star_rating * 4 (max 20pts)

**D-01.5-03-005:** Travel bonus is £2/mile beyond 30 miles, room/board is £85
- Rationale: UK construction industry standard mileage rate, B&B average cost
- Room/board only offered if travel >90 minutes (overnight required)

**D-01.5-03-006:** Deny recommendation when cost >50% of shift value
- Rationale: Protect profit margins, unprofitable bookings should be rejected
- Calculation: shift_value = base_rate * shift_hours * 1.20 (VAT included)

**D-01.5-03-007:** All out-of-territory bookings require admin approval
- Rationale: Even low-cost out-of-territory assignments need human review for quality control
- Implementation: `requires_admin_approval = true` always for out-of-territory

**D-01.5-03-008:** Cache cleanup scheduled daily at 3 AM UTC
- Rationale: Off-peak time, prevents stale data accumulation, maintains 7-day TTL
- Fallback: Manual scheduling instructions provided if pg_cron not available

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation proceeded smoothly with clear requirements and existing patterns.

## User Setup Required

None - no external service configuration required. Cache cleanup scheduling is automatic via pg_cron (or can be manually scheduled if extension unavailable).

## Next Phase Readiness

**Ready for booking portal integration:**
- Auto-assignment endpoint ready to be called when new bookings created
- Out-of-territory cost calculator ready for quote preview during booking creation
- Cache cleanup prevents unbounded growth of travel time cache

**No blockers or concerns.**

---
*Phase: 01.5-business-foundation*
*Completed: 2026-02-15*
