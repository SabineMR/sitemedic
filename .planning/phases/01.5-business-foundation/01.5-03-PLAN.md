---
phase: 01.5-business-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/auto-assign-medic/index.ts
  - supabase/functions/calculate-out-of-territory/index.ts
  - supabase/migrations/005_cache_cleanup.sql
autonomous: true

must_haves:
  truths:
    - "Google Maps Distance Matrix API returns travel times for UK postcodes (via existing calculate-travel-time Edge Function)"
    - "Auto-assignment algorithm ranks medics by distance, utilization, qualifications"
    - "Out-of-territory cost logic calculates travel bonus vs room/board vs deny"
    - "Expired cache entries are cleaned up automatically (7-day TTL enforced)"
  artifacts:
    - path: "supabase/functions/auto-assign-medic/index.ts"
      provides: "Medic auto-assignment algorithm with multi-factor ranking"
      exports: ["serve"]
    - path: "supabase/functions/calculate-out-of-territory/index.ts"
      provides: "Out-of-territory cost calculation (travel bonus vs room/board vs deny)"
      exports: ["serve"]
    - path: "supabase/migrations/005_cache_cleanup.sql"
      provides: "Scheduled cleanup of expired travel_time_cache entries"
      contains: "DELETE FROM travel_time_cache"
  key_links:
    - from: "supabase/functions/auto-assign-medic/index.ts"
      to: "supabase/functions/calculate-travel-time/index.ts"
      via: "HTTP call to calculate travel time for each candidate medic"
      pattern: "fetch.*calculate-travel-time"
    - from: "supabase/functions/auto-assign-medic/index.ts"
      to: "bookings table"
      via: "Updates booking with matched medic_id and match_score"
      pattern: "supabase.*from.*bookings.*update"
    - from: "supabase/functions/calculate-out-of-territory/index.ts"
      to: "territories table"
      via: "Checks if postcode sector has assigned primary medic"
      pattern: "supabase.*from.*territories"
---

<objective>
Build the auto-assignment algorithm and out-of-territory cost logic, leveraging the existing Google Maps Distance Matrix API Edge Function.

Purpose: When a booking comes in, the system must automatically rank available medics by distance, utilization, qualifications, and availability, then assign the best match. For out-of-territory bookings, it must calculate whether a travel bonus, room/board, or denial is most cost-effective. The existing calculate-travel-time Edge Function already handles Google Maps API calls with 7-day caching and haversine fallback.

Output: Auto-assignment Edge Function, out-of-territory cost calculator, and cache cleanup migration.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-business-foundation/01.5-RESEARCH.md
@supabase/migrations/002_business_operations.sql
@supabase/functions/calculate-travel-time/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-assignment algorithm Edge Function</name>
  <files>
    supabase/functions/auto-assign-medic/index.ts
  </files>
  <action>
    Create Edge Function `supabase/functions/auto-assign-medic/index.ts`:

    Input: `{ booking_id }` (POST)
    - Fetches booking details from bookings table (site_postcode, shift_date, shift_start_time, shift_end_time, confined_space_required, trauma_specialist_required)

    Algorithm steps:

    1. **Find candidate medics** (filter phase):
       - available_for_work = true
       - NOT already booked on shift_date with overlapping times (query bookings table for conflicts)
       - If confined_space_required: has_confined_space_cert = true
       - If trauma_specialist_required: has_trauma_cert = true
       - Exclude medics with unavailable_until >= shift_date

    2. **Rank candidates** (scoring phase - 100 point scale):
       - **Distance score (40 points max):**
         - Call calculate-travel-time Edge Function for each candidate (medic.home_postcode -> booking.site_postcode)
         - Use SUPABASE_URL environment variable to call sibling Edge Function
         - Score: 40 - (travel_time_minutes / 2), minimum 0
         - Under 20 min = 30-40 points, 20-40 min = 20-30 points, 40-60 min = 10-20 points, 60+ min = 0-10 points

       - **Utilization score (25 points max):**
         - Count medic's confirmed bookings in current week (Mon-Sun)
         - utilization_pct = (booked_days / 5) * 100
         - Score: 25 * (1 - utilization_pct / 100)
         - Under 50% = 12-25 points (preferred), 50-80% = 5-12 points, over 80% = 0-5 points

       - **Qualifications score (15 points max):**
         - Base: 5 points for any active medic
         - +5 if has_confined_space_cert (even if not required)
         - +5 if has_trauma_cert (even if not required)
         - These certs are bonus for general capability

       - **Rating score (20 points max):**
         - Score: star_rating * 4 (5.0 stars = 20 points, 4.5 stars = 18 points)
         - New medics (0 rating) get 15 points (benefit of the doubt)

    3. **Territory priority boost:**
       - Look up booking.site_postcode sector in territories table
       - If medic is primary_medic_id for that sector: +10 bonus points (can exceed 100)
       - If medic is secondary_medic_id: +5 bonus points

    4. **Sort by total score descending**, return top 5 candidates

    5. **Auto-assign top candidate:**
       - Update bookings table: medic_id = top_candidate.medic_id, auto_matched = true, match_score = score, match_criteria = JSON breakdown of scoring
       - If top score < 50: set requires_manual_approval = true, approval_reason = "Low auto-match score"
       - If no candidates found: set requires_manual_approval = true, approval_reason = "No available medics"

    Output: `{ assigned_medic_id, match_score, candidates: [...top5], requires_manual_approval }`

    Use Deno imports: `https://deno.land/std@0.168.0/http/server.ts`, `https://esm.sh/@supabase/supabase-js@2`
    Use service role key for DB access
    CORS headers matching existing Edge Functions
  </action>
  <verify>
    - Edge Function handles POST with booking_id
    - Filters exclude unavailable, unqualified, and double-booked medics
    - Scoring uses 100-point scale with 4 factors (distance 40, utilization 25, qualifications 15, rating 20)
    - Territory primary/secondary medics get bonus points
    - Low-score matches trigger manual approval
    - match_criteria JSONB stores full scoring breakdown
  </verify>
  <done>Auto-assignment algorithm ranks medics by distance (40pts), utilization (25pts), qualifications (15pts), and rating (20pts) with territory priority boost</done>
</task>

<task type="auto">
  <name>Task 2: Out-of-territory cost calculator and cache cleanup</name>
  <files>
    supabase/functions/calculate-out-of-territory/index.ts
    supabase/migrations/005_cache_cleanup.sql
  </files>
  <action>
    1. Create Edge Function `supabase/functions/calculate-out-of-territory/index.ts`:
       Input: `{ medic_id, booking_site_postcode, shift_hours, base_rate }`

       Algorithm:
       a. Look up territory for booking_site_postcode sector (first 2-4 chars)
       b. Check if medic is primary or secondary for that territory
       c. If primary: return `{ in_territory: true, cost: 0 }`
       d. If secondary or unassigned:
          - Call calculate-travel-time for medic.home_postcode -> booking_site_postcode
          - Calculate travel bonus: beyond 30 miles = £2/mile extra
            `travel_bonus = max(0, (distance_miles - 30)) * 2`
          - Calculate room/board cost: if travel_time > 90 minutes, overnight stay
            `room_board = 85` (£85 per night, UK average B&B)
          - Calculate shift value: `shift_value = base_rate * shift_hours * 1.20` (including VAT)
          - Determine recommendation:
            - If min(travel_bonus, room_board) > shift_value * 0.50: recommend "deny" (cost > 50% of shift)
            - If travel_bonus < room_board: recommend "travel_bonus"
            - Else: recommend "room_board"

       Output:
       ```json
       {
         "in_territory": false,
         "travel_time_minutes": 75,
         "distance_miles": 45,
         "travel_bonus": 30.00,
         "room_board": 85.00,
         "recommendation": "travel_bonus",
         "recommended_cost": 30.00,
         "shift_value": 288.00,
         "cost_percentage": 10.4,
         "requires_admin_approval": true
       }
       ```
       - All out-of-territory bookings require admin approval (requires_manual_approval = true)
       - Use Deno imports matching existing Edge Functions

    2. Create migration `supabase/migrations/005_cache_cleanup.sql`:
       - Create a PostgreSQL function `cleanup_expired_cache()` that deletes rows from travel_time_cache where expires_at < NOW()
       - Create a pg_cron job (if pg_cron extension available) or document that this should be called daily
       - Add comment: "Run daily to clean up expired 7-day cache entries"
       - If pg_cron not available, create the cleanup function only and document manual scheduling:
         ```sql
         CREATE OR REPLACE FUNCTION cleanup_expired_cache()
         RETURNS INTEGER AS $$
         DECLARE
           deleted_count INTEGER;
         BEGIN
           DELETE FROM travel_time_cache WHERE expires_at < NOW();
           GET DIAGNOSTICS deleted_count = ROW_COUNT;
           RETURN deleted_count;
         END;
         $$ LANGUAGE plpgsql;
         ```
       - Try to schedule: `SELECT cron.schedule('cleanup-travel-cache', '0 3 * * *', 'SELECT cleanup_expired_cache()');`
       - Wrap in DO block with exception handler in case pg_cron not installed
  </action>
  <verify>
    - Out-of-territory calculator correctly computes travel bonus (£2/mile beyond 30 miles)
    - Room/board defaults to £85 for travel > 90 minutes
    - Deny recommendation triggers when cost > 50% of shift value
    - Cache cleanup function exists and deletes expired entries
    - Both files follow existing Edge Function patterns
  </verify>
  <done>Out-of-territory cost logic compares travel bonus vs room/board vs deny, and expired cache entries have cleanup mechanism</done>
</task>

</tasks>

<verification>
1. Auto-assign function correctly filters, scores, and ranks medics
2. Territory primary/secondary medics get bonus scoring
3. Out-of-territory cost calculation matches business rules (£2/mile, £85 room/board, 50% deny threshold)
4. Cache cleanup function works (DELETE WHERE expires_at < NOW())
5. All Edge Functions follow same Deno import patterns as calculate-travel-time
</verification>

<success_criteria>
- Auto-assignment ranks medics with 4-factor scoring (distance, utilization, qualifications, rating)
- Territory priority gives bonus to assigned medics
- Low-score matches (<50 points) require manual approval
- Out-of-territory correctly recommends travel_bonus vs room_board vs deny
- Cache cleanup prevents stale data accumulation
- Existing calculate-travel-time Edge Function is reused (not duplicated)
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-business-foundation/01.5-03-SUMMARY.md`
</output>
