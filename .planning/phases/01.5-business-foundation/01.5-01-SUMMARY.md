---
phase: 01.5-business-foundation
plan: 01
subsystem: database
tags: [supabase, edge-functions, postgresql, pricing, invoicing]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: Supabase database migrations (002_business_operations.sql, 003_rls_policies.sql) with 10 tables
provides:
  - Invoice number auto-generation with INV-YYYY-NNN format
  - Pricing calculation Edge Function with UK VAT and 40/60 platform split
  - Test data seeder for development (1 client, 1 medic, 1 booking)
affects: [04.5-marketing-booking, 05.5-admin-operations, 06.5-payments-payouts]

# Tech tracking
tech-stack:
  added:
    - PostgreSQL sequence for invoice numbering
    - Supabase Edge Functions pattern (calculate-pricing, seed-test-data)
  patterns:
    - Pure calculation Edge Functions (no DB writes)
    - Idempotent seeding with deterministic UUIDs
    - Pricing breakdown with all cost components tracked

key-files:
  created:
    - supabase/migrations/004_invoice_sequence.sql
    - supabase/functions/calculate-pricing/index.ts
    - supabase/functions/seed-test-data/index.ts
  modified: []

key-decisions:
  - "Pure calculation pattern: calculate-pricing returns JSON only, callers write to DB"
  - "Invoice numbers use single global sequence (not yearly reset) for simplicity"
  - "Test data uses deterministic UUIDs for idempotency (10000000-... for client, 20000000-... for medic)"
  - "Platform split: 40% platform fee, 60% medic payout on total including VAT"

patterns-established:
  - "Edge Functions follow existing pattern from calculate-travel-time (Deno std@0.168.0, CORS headers)"
  - "Pricing calculations round to 2 decimal places (GBP standard)"
  - "Service role key bypasses RLS for seeding operations"

# Metrics
duration: 2min
completed: 2026-02-15
---

# Phase 01.5 Plan 01: Database Validation & Pricing Summary

**Invoice auto-generation with INV-YYYY-NNN format, pricing calculation with UK 20% VAT and 40/60 split, and idempotent test data seeder**

## Performance

- **Duration:** 2 min 22 sec
- **Started:** 2026-02-15T23:16:55Z
- **Completed:** 2026-02-15T23:19:17Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Invoice number sequence generates INV-2026-001 format automatically
- Pricing calculation handles base rate + urgency premium + travel + VAT with validated 40/60 split
- Test data creates verifiable records (£288 total for 8h @ £30/hr with £48 VAT)
- All existing schema from 002/003 migrations remains untouched

## Task Commits

Each task was committed atomically:

1. **Task 1: Invoice number sequence and pricing Edge Function** - `eee5386` (feat)
2. **Task 2: Test data seeder Edge Function** - `772827c` (feat)

## Files Created/Modified

- `supabase/migrations/004_invoice_sequence.sql` - Invoice number auto-generation with sequence and trigger
- `supabase/functions/calculate-pricing/index.ts` - Pure calculation function for booking pricing breakdown
- `supabase/functions/seed-test-data/index.ts` - Idempotent test data seeder with deterministic UUIDs

## Decisions Made

**D-01.5-01-001: Pure calculation pattern for pricing**
- Rationale: calculate-pricing returns JSON breakdown only. Callers (seed-test-data, stripe-connect, admin UI) are responsible for writing pricing to bookings table. Separates calculation logic from persistence.

**D-01.5-01-002: Single global invoice sequence (not yearly reset)**
- Rationale: Simpler implementation using `nextval('invoice_number_seq')` with LPAD. Yearly reset would require checking last invoice year and resetting sequence. Can be enhanced later if needed.

**D-01.5-01-003: Deterministic UUIDs for test data**
- Rationale: Enables idempotent seeding. Same UUID always = same test record. Prevents duplicate test data on repeated seeder runs.
  - Client: `10000000-0000-0000-0000-000000000001`
  - Medic: `20000000-0000-0000-0000-000000000001`
  - Booking: `30000000-0000-0000-0000-000000000001`

**D-01.5-01-004: Platform split on total (not subtotal)**
- Rationale: 40% platform fee calculated on total (including VAT), not subtotal. Ensures platform captures share of full client payment. Medic receives 60% of total.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed as specified.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for:**
- 04.5-marketing-booking: Quote builder can call calculate-pricing Edge Function
- 06.5-payments-payouts: Invoice generation can use invoice_number_seq
- 05.5-admin-operations: Seed data provides test bookings for admin UI

**Notes:**
- Test medic seeding requires manual auth.users creation (service key can't create auth users directly)
- Invoice sequence starts at 001 - will increment with each new invoice
- Pricing calculation validated with test cases (8h @ £30 = £288 total)

---
*Phase: 01.5-business-foundation*
*Completed: 2026-02-15*
