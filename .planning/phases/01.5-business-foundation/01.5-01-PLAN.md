---
phase: 01.5-business-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/004_invoice_sequence.sql
  - supabase/functions/calculate-pricing/index.ts
  - supabase/functions/seed-test-data/index.ts
autonomous: true

must_haves:
  truths:
    - "Database tables exist for territories, bookings, clients, medics, timesheets, payments, invoices with RLS policies"
    - "Invoices have unique sequential numbers in INV-YYYY-NNN format"
    - "Pricing includes all cost components (base rate, urgency, travel, out-of-territory) with 20% VAT applied"
    - "Test booking can be created with correct pricing breakdown and 40/60 platform split"
  artifacts:
    - path: "supabase/migrations/004_invoice_sequence.sql"
      provides: "Invoice number sequence for auto-incrementing invoice numbers"
      contains: "CREATE SEQUENCE"
    - path: "supabase/functions/calculate-pricing/index.ts"
      provides: "Booking pricing calculation Edge Function"
      exports: ["serve"]
    - path: "supabase/functions/seed-test-data/index.ts"
      provides: "Test data seeder for development (1 client, 1 medic, 1 booking)"
      exports: ["serve"]
  key_links:
    - from: "supabase/functions/calculate-pricing/index.ts"
      to: "caller (stripe-connect, seed-test-data, admin UI)"
      via: "Returns JSON pricing breakdown — pure calculation, no DB writes"
      pattern: "return.*Response.*JSON"
    - from: "supabase/functions/seed-test-data/index.ts"
      to: "clients, medics, bookings tables"
      via: "Supabase client inserts"
      pattern: "supabase.*from.*(clients|medics|bookings)"
---

<objective>
Validate existing database schema, add invoice number sequencing, create pricing calculation function, and seed test data for development.

Purpose: The database migrations (002_business_operations.sql, 003_rls_policies.sql) were created in a prior session and cover all 10 tables with RLS. This plan adds the missing pieces: invoice number auto-generation, pricing calculation business logic, and test data to verify the schema works end-to-end.

Output: Invoice sequence migration, pricing Edge Function, test data seeder.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-business-foundation/01.5-RESEARCH.md
@supabase/migrations/002_business_operations.sql
@supabase/migrations/003_rls_policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Invoice number sequence and pricing Edge Function</name>
  <files>
    supabase/migrations/004_invoice_sequence.sql
    supabase/functions/calculate-pricing/index.ts
  </files>
  <action>
    1. Create migration `supabase/migrations/004_invoice_sequence.sql`:
       - Create a SEQUENCE for invoice numbers: `CREATE SEQUENCE invoice_number_seq START 1;`
       - Create a function `generate_invoice_number()` that produces format `INV-YYYY-NNN` (e.g., INV-2026-001)
       - Uses `LPAD(nextval('invoice_number_seq')::text, 3, '0')` for zero-padded numbers
       - Add trigger on invoices table: BEFORE INSERT, if invoice_number is NULL, auto-generate it

    2. Create Edge Function `supabase/functions/calculate-pricing/index.ts`:
       - PURE CALCULATION — no database reads or writes. Returns JSON pricing breakdown only.
         Callers (seed-test-data, stripe-connect, admin UI) are responsible for writing pricing to bookings table.
       - Accepts POST with: `{ shift_hours, base_rate, urgency_premium_percent, travel_surcharge, out_of_territory_cost, out_of_territory_type }`
       - Calculates:
         - `hourly_total = base_rate * shift_hours`
         - `urgency_amount = hourly_total * (urgency_premium_percent / 100)`
         - `subtotal = hourly_total + urgency_amount + travel_surcharge + out_of_territory_cost`
         - `vat = subtotal * 0.20` (UK 20% VAT)
         - `total = subtotal + vat`
         - `platform_fee = total * 0.40` (40% markup)
         - `medic_payout = total - platform_fee` (60% to medic)
       - Returns full pricing breakdown as JSON
       - Validates: shift_hours >= 8 (UK construction standard), base_rate > 0, urgency_premium_percent in [0, 20, 50, 75]
       - CORS headers for browser access
       - Use Deno imports matching existing Edge Functions: `https://deno.land/std@0.168.0/http/server.ts`
  </action>
  <verify>
    - `004_invoice_sequence.sql` exists and contains CREATE SEQUENCE
    - `calculate-pricing/index.ts` exists and exports a serve handler
    - Pricing for 8-hour shift at £30/hr base rate with 0% urgency = subtotal £240, VAT £48, total £288, platform_fee £115.20, medic_payout £172.80
    - Pricing for 8-hour shift at £30/hr with 50% urgency = subtotal £360, VAT £72, total £432
  </verify>
  <done>Invoice number auto-generation and pricing calculation work correctly with validated formulas</done>
</task>

<task type="auto">
  <name>Task 2: Test data seeder Edge Function</name>
  <files>
    supabase/functions/seed-test-data/index.ts
  </files>
  <action>
    Create Edge Function `supabase/functions/seed-test-data/index.ts`:
    - Uses Supabase service role key (bypasses RLS) for seeding
    - Idempotent: checks if test data exists before inserting (uses known UUIDs)
    - Seeds the following test records:
      1. Test admin user (via auth.users if possible, or document that this requires manual creation)
      2. Test client: company_name="ABC Construction Ltd", contact_name="Sarah Mitchell", contact_email="sarah@abcconstruction.co.uk", billing_postcode="E1 6AN", payment_terms="net_30"
      3. Test medic: first_name="James", last_name="Wilson", email="james.wilson@sitemedic.co.uk", home_postcode="SW1A 1AA", has_confined_space_cert=true, has_trauma_cert=true, employment_status="self_employed"
      4. Test booking: linking test client and medic, site_postcode="E14 5AB" (Canary Wharf), shift_date=tomorrow, shift_hours=8, base_rate=30.00, urgency_premium_percent=0, status="confirmed"
         - Calculate pricing using the same formulas from Task 1
         - Set subtotal, vat, total, platform_fee, medic_payout
      5. Test territory assignment: Update E1 territory to set primary_medic_id to test medic
    - Returns summary of seeded data
    - IMPORTANT: Use deterministic UUIDs for idempotency:
      - Client: '10000000-0000-0000-0000-000000000001'
      - Medic: '20000000-0000-0000-0000-000000000001'
      - Booking: '30000000-0000-0000-0000-000000000001'
    - NOTE: client.user_id and medic.user_id require auth.users records. Create placeholder auth users via Supabase admin API, or skip user_id and document as manual step.
    - Use Deno imports: `https://deno.land/std@0.168.0/http/server.ts`, `https://esm.sh/@supabase/supabase-js@2`
  </action>
  <verify>
    - `seed-test-data/index.ts` exists with serve handler
    - Test client has correct fields including payment_terms='net_30'
    - Test booking has correct pricing (8 hours * £30 = £240 subtotal, £48 VAT, £288 total)
    - Seeder is idempotent (uses INSERT ... ON CONFLICT DO NOTHING or checks first)
  </verify>
  <done>Test data seeder creates 1 client, 1 medic, 1 booking, and 1 territory assignment with correct pricing</done>
</task>

</tasks>

<verification>
1. All files exist: `004_invoice_sequence.sql`, `calculate-pricing/index.ts`, `seed-test-data/index.ts`
2. Pricing calculation matches expected values for test cases
3. Invoice number format is INV-YYYY-NNN
4. Test data uses deterministic UUIDs for idempotency
5. Edge Functions follow same patterns as existing `calculate-travel-time/index.ts`
</verification>

<success_criteria>
- Invoice number sequence generates INV-2026-001 format
- Pricing calculation correctly handles base + urgency + travel + VAT with 40/60 split
- Test data seeder creates verifiable records in all key tables
- All existing schema from 002/003 migrations remains untouched
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-business-foundation/01.5-01-SUMMARY.md`
</output>
