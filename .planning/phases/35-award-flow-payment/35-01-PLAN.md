---
phase: 35-award-flow-payment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/149_marketplace_award_payment.sql
  - web/lib/marketplace/award-types.ts
  - web/lib/marketplace/award-schemas.ts
  - web/lib/marketplace/award-calculations.ts
  - web/stores/useAwardCheckoutStore.ts
  - web/app/api/marketplace/quotes/[id]/award/route.ts
autonomous: true

must_haves:
  truths:
    - "Award API creates a Stripe PaymentIntent with setup_future_usage for deposit and returns clientSecret"
    - "Quote status can transition to 'awarded' or 'rejected' (new statuses added to DB)"
    - "Deposit and remainder amounts are correctly calculated with configurable deposit percentage"
    - "EXCLUSION constraint conflicts are checked for named medics before award proceeds"
  artifacts:
    - path: "supabase/migrations/149_marketplace_award_payment.sql"
      provides: "Award payment columns on bookings, marketplace_award_history, client_payment_methods, quote status expansion"
      contains: "marketplace_award_history"
    - path: "web/lib/marketplace/award-types.ts"
      provides: "TypeScript types for award flow"
      contains: "AwardCheckoutState"
    - path: "web/lib/marketplace/award-schemas.ts"
      provides: "Zod validation schemas for award request"
      contains: "awardRequestSchema"
    - path: "web/lib/marketplace/award-calculations.ts"
      provides: "Deposit/remainder calculation logic"
      contains: "calculateAwardAmounts"
    - path: "web/stores/useAwardCheckoutStore.ts"
      provides: "Zustand store for multi-step award checkout flow"
      contains: "useAwardCheckoutStore"
    - path: "web/app/api/marketplace/quotes/[id]/award/route.ts"
      provides: "POST endpoint that validates award, checks EXCLUSION constraints, creates Stripe PaymentIntent"
      exports: ["POST"]
  key_links:
    - from: "web/app/api/marketplace/quotes/[id]/award/route.ts"
      to: "web/lib/stripe/server.ts"
      via: "stripe.paymentIntents.create with setup_future_usage"
      pattern: "setup_future_usage.*off_session"
    - from: "web/app/api/marketplace/quotes/[id]/award/route.ts"
      to: "web/lib/marketplace/award-calculations.ts"
      via: "calculateAwardAmounts import"
      pattern: "calculateAwardAmounts"
    - from: "web/stores/useAwardCheckoutStore.ts"
      to: "web/lib/marketplace/award-types.ts"
      via: "type imports for store state"
      pattern: "AwardCheckoutState"
---

<objective>
Create the database foundation, TypeScript types, validation schemas, calculation logic, Zustand store, and award API endpoint for the marketplace award and payment flow.

Purpose: This plan establishes all the backend infrastructure needed before any UI or webhook work can begin. The migration adds new columns to bookings for marketplace payment tracking, expands quote statuses to include 'awarded' and 'rejected', creates the marketplace_award_history audit table, and adds the client_payment_methods table. The award API creates a Stripe PaymentIntent with `setup_future_usage: 'off_session'` to both charge the deposit and save the card for the later remainder charge.

Output: Migration 149, TypeScript types, Zod schemas, calculation helpers, Zustand store, and POST /api/marketplace/quotes/[id]/award route.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-award-flow-payment/35-CONTEXT.md
@.planning/phases/35-award-flow-payment/35-RESEARCH.md

Key reference files:
@web/lib/stripe/server.ts
@web/lib/marketplace/quote-types.ts
@web/lib/marketplace/quote-schemas.ts
@web/lib/direct-jobs/booking-bridge.ts
@web/app/api/direct-jobs/[id]/payment/route.ts
@supabase/migrations/146_marketplace_quotes.sql
@supabase/migrations/140_marketplace_foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and TypeScript types/schemas/calculations</name>
  <files>
    supabase/migrations/149_marketplace_award_payment.sql
    web/lib/marketplace/award-types.ts
    web/lib/marketplace/award-schemas.ts
    web/lib/marketplace/award-calculations.ts
  </files>
  <action>
    **Migration 149_marketplace_award_payment.sql:**

    1. Expand marketplace_quotes status CHECK constraint to include 'awarded' and 'rejected':
       ```sql
       ALTER TABLE marketplace_quotes DROP CONSTRAINT IF EXISTS marketplace_quotes_status_check;
       ALTER TABLE marketplace_quotes ADD CONSTRAINT marketplace_quotes_status_check
         CHECK (status IN ('draft', 'submitted', 'revised', 'withdrawn', 'awarded', 'rejected'));
       ```
       Also add `awarded_at TIMESTAMPTZ`, `rejected_at TIMESTAMPTZ`, `rejected_reason TEXT` columns to marketplace_quotes.

    2. Add marketplace payment columns to bookings table:
       - `marketplace_event_id UUID REFERENCES marketplace_events(id)` -- links booking to marketplace event
       - `marketplace_quote_id UUID REFERENCES marketplace_quotes(id)` -- links booking to winning quote
       - `deposit_amount DECIMAL(10,2)` -- deposit charged at award time
       - `remainder_amount DECIMAL(10,2)` -- remainder due after event
       - `deposit_percent INT DEFAULT 25` -- the deposit % used
       - `remainder_due_at TIMESTAMPTZ` -- when remainder becomes chargeable (event end + 14 days)
       - `remainder_paid_at TIMESTAMPTZ` -- when remainder was successfully charged
       - `remainder_failed_attempts INT DEFAULT 0` -- counter for failed charge attempts
       - `remainder_last_failed_at TIMESTAMPTZ`
       - `stripe_customer_id TEXT` -- Stripe customer for this marketplace client
       - `stripe_payment_method_id TEXT` -- saved card for remainder charge
       - `deposit_payment_intent_id TEXT` -- Stripe PI for deposit
       - `remainder_payment_intent_id TEXT` -- Stripe PI for remainder
       Add indexes on marketplace_event_id, remainder_due_at, stripe_customer_id, and a partial index on remainder_due_at WHERE remainder_paid_at IS NULL for the daily cron query.

    3. Create marketplace_award_history table for audit trail:
       - id UUID PK, event_id FK, winning_quote_id FK, losing_quote_ids UUID[], awarded_by UUID FK to auth.users, deposit_amount DECIMAL, total_amount DECIMAL, deposit_percent INT, awarded_at TIMESTAMPTZ DEFAULT NOW(), created_at TIMESTAMPTZ DEFAULT NOW()
       - Indexes on event_id, awarded_by, awarded_at
       - RLS: event poster can view own awards; platform admin sees all

    4. Create client_payment_methods table:
       - id UUID PK, user_id UUID FK to auth.users (NOT profiles), stripe_customer_id TEXT NOT NULL, stripe_payment_method_id TEXT UNIQUE NOT NULL, card_brand TEXT, card_last_four TEXT, card_expiry_month INT, card_expiry_year INT, is_default BOOLEAN DEFAULT FALSE, created_at TIMESTAMPTZ, updated_at TIMESTAMPTZ
       - Indexes on user_id, stripe_customer_id
       - RLS: user can manage own payment methods; platform admin sees all

    5. Add marketplace_events status 'awarded' is already in the CHECK constraint (confirmed from migration 145). No change needed there.

    6. Add COMMENT ON statements for all new columns/tables.

    **DO NOT** modify the existing bookings source CHECK constraint -- it already includes 'marketplace' from migration 140.

    **award-types.ts:**
    - Export `AwardCheckoutStep = 'confirm' | 'payment' | 'processing' | 'success' | 'error'`
    - Export `AwardCheckoutState` interface (step, quoteId, eventId, companyId, totalPrice, depositPercent, depositAmount, remainderAmount, stripeCustomerId, paymentMethodId, depositPaymentIntentId, clientSecret, clientEmail, clientName, clientPhone, isProcessing, error)
    - Export `AwardRequest` interface (eventId, quoteId, depositPercent?)
    - Export `AwardApiResponse` interface (clientSecret, paymentIntentId, customerId, depositAmount, remainderAmount, depositPercent, totalPrice)
    - Export `PaymentBreakdown` interface (totalPrice, depositPercent, depositAmount, remainderAmount, vatAmount, subtotal)
    - Export `MarketplaceBookingPayment` interface (mirrors the new booking columns for marketplace)
    - Expand `QuoteStatus` type in quote-types.ts to include `'awarded' | 'rejected'`
    - Add 'awarded' and 'rejected' to `QUOTE_STATUS_LABELS` in quote-types.ts

    **award-schemas.ts:**
    - `awardRequestSchema` -- Zod v4 schema validating eventId (UUID), quoteId (UUID), depositPercent (optional, 1-100, default 25)
    - `awardConfirmationSchema` -- validates the full confirmation form (clientEmail, clientName, clientPhone, cardholderName, termsAccepted boolean)

    **award-calculations.ts:**
    - `calculateAwardAmounts(totalPrice: number, depositPercent: number): PaymentBreakdown` -- calculates deposit, remainder, VAT split (totalPrice is inclusive of VAT; subtotal = totalPrice / 1.20; vatAmount = totalPrice - subtotal)
    - `calculateMarketplaceCommission(totalPrice: number, platformFeePercent: number, medicPayoutPercent: number)` -- returns { platformFee, medicPayout, platformNet } using the existing pattern from pricing.ts (platform takes from company side, not client side)
    - `getDepositPercentForEventType(eventType: string): number` -- returns deposit % based on event type (default 25%; construction/motorsport 50%; configurable via a const map for now, admin UI in Phase 39)
    - `calculateRemainderDueDate(eventEndDate: Date): Date` -- adds 14 days to event end date
  </action>
  <verify>
    1. `pnpm exec tsc --noEmit` passes with no type errors
    2. Migration SQL is syntactically valid (check for balanced parentheses, semicolons)
    3. award-calculations.ts: calculateAwardAmounts(1200, 25) returns depositAmount=300, remainderAmount=900, subtotal=1000, vatAmount=200
    4. All exported types are importable from their respective files
  </verify>
  <done>
    Migration 149 exists with all required schema changes. TypeScript types, Zod schemas, and calculation functions are exported and type-check clean. Quote status expanded to include 'awarded' and 'rejected'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Award API route and Zustand store</name>
  <files>
    web/app/api/marketplace/quotes/[id]/award/route.ts
    web/stores/useAwardCheckoutStore.ts
    web/lib/marketplace/quote-types.ts
  </files>
  <action>
    **Award API route (POST /api/marketplace/quotes/[id]/award):**

    1. Authenticate user via supabase.auth.getUser()
    2. Parse and validate request body with awardRequestSchema (Zod v4)
    3. Fetch the quote by ID -- verify it exists, status is 'submitted' or 'revised' (not draft/withdrawn/awarded/rejected)
    4. Fetch the event and verify the authenticated user is the event poster (event.posted_by === user.id)
    5. Verify event status is 'open' (not already awarded, cancelled, or closed)
    6. **EXCLUSION constraint check for named medics:**
       - If quote.staffing_plan.type === 'named_medics', extract medic IDs from staffing_plan.named_medics
       - For each event_day in the event, check medic_commitments table for time range overlaps using the same pattern from Phase 34.1 (query with tstzrange overlap check)
       - If ANY named medic has a conflict, return 409 with friendly error message: "One or more named staff members are unavailable for the requested dates. Please contact {company_name} to discuss alternatives."
       - If staffing_plan.type === 'headcount_and_quals', skip EXCLUSION check (company resolves staffing)
    7. Get deposit percent via getDepositPercentForEventType(event.event_type) -- can be overridden by request body depositPercent
    8. Calculate amounts via calculateAwardAmounts(quote.total_price, depositPercent)
    9. Create or retrieve Stripe Customer:
       - Check client_payment_methods table for existing stripe_customer_id for this user
       - If none, check clients table for stripe_customer_id (existing pattern from v1.0)
       - If still none, create new Stripe customer via stripe.customers.create({ email, name, metadata: { user_id } })
       - Save to client_payment_methods if newly created
    10. Create Stripe PaymentIntent with:
        - amount: depositAmount in pence (Math.round(depositAmount * 100))
        - currency: 'gbp'
        - customer: customerId
        - setup_future_usage: 'off_session' -- CRITICAL: saves card for remainder
        - automatic_payment_methods: { enabled: true }
        - metadata: { event_id, quote_id, payment_type: 'deposit', deposit_percent, client_email, client_name, total_price: quote.total_price }
        - receipt_email: user email
        - idempotencyKey: `pi_deposit_${quoteId}_${Date.now()}`
    11. Support dev mock when no STRIPE_SECRET_KEY (same pattern as direct-jobs payment route)
    12. Return AwardApiResponse: { clientSecret, paymentIntentId, customerId, depositAmount, remainderAmount, depositPercent, totalPrice }

    **Error responses:**
    - 401: Not authenticated
    - 403: Not the event poster
    - 404: Quote or event not found
    - 400: Quote not in valid status, event not open, validation errors
    - 409: EXCLUSION constraint conflict for named medics
    - 500: Internal error

    **Zustand store (useAwardCheckoutStore.ts):**

    Follow the pattern from 35-RESEARCH.md Pattern 2. Create store with:
    - State: step (AwardCheckoutStep), quoteId, eventId, companyId, companyName, totalPrice, depositPercent, depositAmount, remainderAmount, stripeCustomerId, paymentMethodId, depositPaymentIntentId, clientSecret, clientEmail, clientName, clientPhone, isProcessing, error
    - Actions: initializeAward(quoteId, eventId, companyId, companyName, totalPrice, depositPercent), setStripeData(customerId, secret, intentId), setStep, setError, setProcessing, reset
    - initializeAward should call calculateAwardAmounts internally to set depositAmount/remainderAmount

    **Update quote-types.ts:**
    - Expand QuoteStatus to: `'draft' | 'submitted' | 'revised' | 'withdrawn' | 'awarded' | 'rejected'`
    - Add to QUOTE_STATUS_LABELS: awarded: 'Awarded', rejected: 'Not Selected'
  </action>
  <verify>
    1. `pnpm exec tsc --noEmit` passes
    2. The award route file exports POST function
    3. Route handles mock mode when STRIPE_SECRET_KEY is absent
    4. Zustand store initializeAward correctly computes deposit/remainder amounts
    5. QuoteStatus type includes 'awarded' and 'rejected'
  </verify>
  <done>
    POST /api/marketplace/quotes/[id]/award creates a Stripe PaymentIntent with setup_future_usage, validates ownership, checks EXCLUSION constraints for named medics, supports dev mock, and returns clientSecret. Zustand store manages the multi-step checkout flow. Quote types expanded with new statuses.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- zero type errors
2. Migration 149 SQL is valid (no syntax errors)
3. Award API returns proper error codes for each failure case
4. calculateAwardAmounts produces correct math for deposit/remainder/VAT split
5. Zustand store initializes with correct calculated amounts
</verification>

<success_criteria>
- Migration 149 adds all marketplace payment columns to bookings, creates marketplace_award_history and client_payment_methods tables, expands quote status constraint
- Award API creates PaymentIntent with setup_future_usage: 'off_session' and returns clientSecret
- EXCLUSION constraint check blocks awards when named medics have scheduling conflicts
- Dev mock mode works when STRIPE_SECRET_KEY is absent
- All types, schemas, calculations, and store are exported and importable
</success_criteria>

<output>
After completion, create `.planning/phases/35-award-flow-payment/35-01-SUMMARY.md`
</output>
