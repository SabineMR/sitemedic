---
phase: 35-award-flow-payment
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - web/components/marketplace/award/AwardConfirmationModal.tsx
  - web/components/marketplace/award/PaymentBreakdownSection.tsx
  - web/components/marketplace/award/DepositPaymentForm.tsx
  - web/app/api/stripe/webhooks/route.ts
  - web/lib/marketplace/booking-bridge.ts
autonomous: true

must_haves:
  truths:
    - "Client can click 'Award This Quote' and see a confirmation modal with payment breakdown"
    - "Client can enter card details via embedded Stripe Payment Element and pay the deposit"
    - "On successful deposit payment, a booking with source='marketplace' is auto-created"
    - "Winning quote status changes to 'awarded', event status changes to 'awarded'"
    - "Non-winning quotes are rejected with status 'rejected'"
  artifacts:
    - path: "web/components/marketplace/award/AwardConfirmationModal.tsx"
      provides: "Award confirmation modal with two steps: confirm and payment"
      min_lines: 80
    - path: "web/components/marketplace/award/PaymentBreakdownSection.tsx"
      provides: "Transparent payment breakdown showing total, deposit, remainder, VAT"
      min_lines: 30
    - path: "web/components/marketplace/award/DepositPaymentForm.tsx"
      provides: "Stripe Payment Element embedded form for deposit collection"
      min_lines: 60
    - path: "web/lib/marketplace/booking-bridge.ts"
      provides: "createMarketplaceBooking function that creates booking from awarded quote"
      contains: "createMarketplaceBooking"
    - path: "web/app/api/stripe/webhooks/route.ts"
      provides: "Deposit webhook handler that creates booking and updates statuses"
      contains: "payment_type.*deposit"
  key_links:
    - from: "web/components/marketplace/award/AwardConfirmationModal.tsx"
      to: "/api/marketplace/quotes/[id]/award"
      via: "fetch POST to create PaymentIntent"
      pattern: "fetch.*award"
    - from: "web/components/marketplace/award/DepositPaymentForm.tsx"
      to: "stripe.confirmPayment"
      via: "useStripe hook confirmPayment call"
      pattern: "confirmPayment"
    - from: "web/app/api/stripe/webhooks/route.ts"
      to: "web/lib/marketplace/booking-bridge.ts"
      via: "createMarketplaceBooking call on deposit success"
      pattern: "createMarketplaceBooking"
---

<objective>
Build the award checkout UI (confirmation modal, payment breakdown, Stripe Payment Element form) and the server-side deposit success handling (webhook handler that creates the marketplace booking and updates quote/event statuses).

Purpose: This is the core user-facing flow. The client clicks "Award This Quote", sees a breakdown of what they'll pay now vs later, enters card details via Stripe Elements, and on successful payment a booking is auto-created with source='marketplace' that flows into the existing SiteMedic pipeline (timesheets, payouts, compliance).

Output: Award modal components, deposit payment form with Stripe Elements, webhook handler for deposit success, and marketplace booking bridge function.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-award-flow-payment/35-CONTEXT.md
@.planning/phases/35-award-flow-payment/35-RESEARCH.md
@.planning/phases/35-award-flow-payment/35-01-SUMMARY.md

Key reference files:
@web/lib/stripe/server.ts
@web/lib/direct-jobs/booking-bridge.ts
@web/app/api/stripe/webhooks/route.ts
@web/stores/useAwardCheckoutStore.ts
@web/lib/marketplace/award-types.ts
@web/lib/marketplace/award-calculations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Award UI components (modal, breakdown, payment form)</name>
  <files>
    web/components/marketplace/award/AwardConfirmationModal.tsx
    web/components/marketplace/award/PaymentBreakdownSection.tsx
    web/components/marketplace/award/DepositPaymentForm.tsx
  </files>
  <action>
    **AwardConfirmationModal.tsx:**

    Create a 'use client' modal component using shadcn Dialog (or Sheet). Two-step flow managed by useAwardCheckoutStore:

    Step 1 ('confirm'):
    - Props: quoteId, eventId, companyName, totalPrice, eventType (to derive deposit %)
    - On mount, call store.initializeAward() with the quote data
    - Display: Company name, quote total, deposit percentage and amount, remainder amount and due date ("14 days after event ends"), VAT breakdown
    - Include PaymentBreakdownSection component
    - "Proceed to Payment" button that calls the award API (POST /api/marketplace/quotes/{quoteId}/award with { eventId, depositPercent })
    - On API success, store.setStripeData(customerId, clientSecret, paymentIntentId) which transitions to step 'payment'
    - On API error (409 EXCLUSION conflict), show toast.error with the conflict message
    - On API error (other), show toast.error

    Step 2 ('payment'):
    - Wrap DepositPaymentForm in Stripe Elements provider: `<Elements stripe={stripePromise} options={{ clientSecret: store.clientSecret, appearance: { theme: 'stripe' } }}>`
    - Initialize stripePromise with loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!)
    - Show DepositPaymentForm component
    - Back button to return to confirm step

    Step 3 ('success'):
    - Show success message with green check icon
    - "Booking confirmed! You'll receive a confirmation email shortly."
    - Show: deposit paid amount, remainder due date, "You can manage your payment method in your dashboard"
    - "View My Events" button linking to /marketplace/events

    Step 4 ('error'):
    - Show error message with retry option
    - "Back to Payment" button to return to payment step

    Loading state ('processing'):
    - Show spinner during API calls and Stripe confirmation

    **PaymentBreakdownSection.tsx:**

    Reusable read-only component showing payment transparency:
    - Props: totalPrice, depositPercent, depositAmount, remainderAmount, subtotal, vatAmount
    - Layout: Card with rows for each line item
    - Row: "Quote Total (inc. VAT)" — totalPrice formatted as GBP
    - Row: "Subtotal (ex. VAT)" — subtotal
    - Row: "VAT (20%)" — vatAmount
    - Divider
    - Row (highlighted): "Deposit Due Now ({depositPercent}%)" — depositAmount (bold, primary color)
    - Row: "Remainder Due After Event" — remainderAmount (gray, smaller text)
    - Row: "Payment Terms" — "Remainder charged 14 days after event completion"
    - Use Tailwind: bg-gray-50 rounded-lg p-4

    **DepositPaymentForm.tsx:**

    Follow the pattern from 35-RESEARCH.md Pattern 3. 'use client' component:
    - Uses useStripe() and useElements() hooks from @stripe/react-stripe-js
    - Uses useAwardCheckoutStore for state
    - Form with PaymentElement (layout: 'tabs')
    - Submit handler calls stripe.confirmPayment({ elements, clientSecret, redirect: 'if_required', confirmParams: { return_url: `${window.location.origin}/marketplace/checkout/success` } })
    - On success (paymentIntent.status === 'succeeded'): store.setStep('success'), toast.success
    - On requires_action: toast.info (Stripe handles 3DS automatically with Payment Element)
    - On error: store.setError(error.message), toast.error
    - Payment summary at bottom showing deposit amount
    - Terms text: "Your card will be saved securely for the remainder charge", "You can update your payment method in your dashboard"
    - Submit button: "Pay Deposit {depositAmount}" -- disabled when !stripe || !elements || isLoading

    **Important:** Use `redirect: 'if_required'` (NOT 'always') so we handle the result in the modal rather than redirecting away.
  </action>
  <verify>
    1. `pnpm exec tsc --noEmit` passes
    2. AwardConfirmationModal renders all 4 steps based on store state
    3. PaymentBreakdownSection displays all amounts correctly formatted as GBP (pound sign prefix, 2 decimal places)
    4. DepositPaymentForm uses useStripe/useElements hooks and handles success/error/requires_action
  </verify>
  <done>
    Award confirmation modal shows payment breakdown, collects deposit via Stripe Payment Element, and transitions through confirm -> payment -> processing -> success flow. All components type-check and follow existing UI patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deposit webhook handler and marketplace booking bridge</name>
  <files>
    web/app/api/stripe/webhooks/route.ts
    web/lib/marketplace/booking-bridge.ts
  </files>
  <action>
    **Marketplace booking bridge (web/lib/marketplace/booking-bridge.ts):**

    Create a new file following the pattern of web/lib/direct-jobs/booking-bridge.ts. Export `createMarketplaceBooking`:

    ```typescript
    interface CreateMarketplaceBookingParams {
      supabase: SupabaseClient;
      eventId: string;
      quoteId: string;
      quote: { total_price: number; company_id: string; staffing_plan: StaffingPlan; pricing_breakdown: PricingBreakdown };
      event: { event_name: string; location_address: string; location_postcode: string; event_type: string; posted_by: string };
      eventDays: Array<{ event_date: string; start_time: string; end_time: string }>;
      depositAmount: number;
      depositPercent: number;
      remainderAmount: number;
      stripeCustomerId: string;
      stripePaymentMethodId: string;
      depositPaymentIntentId: string;
      platformFeePercent?: number; // Default from env
      medicPayoutPercent?: number; // Default from env
    }
    ```

    Function logic:
    1. Calculate commission using calculateMarketplaceCommission (from award-calculations.ts)
    2. Find the event end date from eventDays (latest event_date) to calculate remainder_due_at (end + 14 days)
    3. For each event day, create a booking record:
       - org_id: Resolve from marketplace_companies.org_id via quote.company_id
       - client_id: null (marketplace clients use auth.users, not the clients table)
       - medic_id: null (assigned later by company)
       - source: 'marketplace'
       - status: 'confirmed'
       - marketplace_event_id: eventId
       - marketplace_quote_id: quoteId
       - site_name: event.event_name
       - site_address: event.location_address
       - site_postcode: event.location_postcode
       - shift_date, shift_start_time, shift_end_time from event day
       - Calculate shift_hours from start/end times (same pattern as direct-jobs booking-bridge)
       - Pricing: base_rate computed, subtotal = total/1.20, vat = total - subtotal, platform_fee, medic_payout using commission calculation
       - Marketplace payment columns: deposit_amount, deposit_percent, remainder_amount, remainder_due_at, stripe_customer_id, stripe_payment_method_id, deposit_payment_intent_id
       - event_vertical: event.event_type
    4. For multi-day events, create ONE booking per day (consistent with Phase 34.1 pattern)
    5. Return { success: boolean, bookingIds: string[], error?: string }

    **IMPORTANT:** Use the same pricing pattern as booking-bridge.ts (direct jobs): total_price is VAT-inclusive, split into subtotal/vat. BUT for marketplace, platform_fee is NOT zero -- use DEFAULT_PLATFORM_FEE_PERCENT (60%) and DEFAULT_MEDIC_PAYOUT_PERCENT (40%) from env, or per-medic overrides.

    **Webhook handler update (web/app/api/stripe/webhooks/route.ts):**

    Add marketplace deposit and remainder handling to the existing switch statement. Do NOT modify existing cases -- add new logic within existing cases by checking metadata.payment_type:

    In `payment_intent.succeeded` case:
    - Check `paymentIntent.metadata?.payment_type`
    - If `payment_type === 'deposit'`:
      1. Extract event_id, quote_id from metadata
      2. Fetch quote with company data and event with event_days
      3. Call createMarketplaceBooking() to create booking(s)
      4. Update quote status to 'awarded' with awarded_at = now()
      5. Update event status to 'awarded'
      6. Reject other submitted/revised quotes on this event: set status='rejected', rejected_at=now(), rejected_reason='Another quote was selected'
      7. Insert into marketplace_award_history: event_id, winning_quote_id, losing_quote_ids (array of rejected quote IDs), awarded_by (from event.posted_by), deposit_amount, total_amount, deposit_percent
      8. Save payment method to client_payment_methods table: user_id (from event.posted_by), stripe_customer_id, stripe_payment_method_id (from paymentIntent.payment_method), card details (retrieve from Stripe if available)
      9. Create medic_commitments entries for named medics (if staffing_plan.type === 'named_medics') for each event day -- catch 23P01 EXCLUSION errors gracefully (already validated at award time, but race condition safety)
    - IMPORTANT: Only process if bookingId is NOT in metadata (that's the existing direct booking webhook). Check for payment_type === 'deposit' FIRST, then fall through to existing logic if not marketplace.

    In `payment_intent.payment_failed` case:
    - Check metadata.payment_type
    - If 'deposit': Do nothing special (client sees error in UI, can retry)
    - Existing logic (booking cancellation) should only run for non-marketplace payments (check metadata.booking_id exists AND payment_type is NOT 'deposit' or 'remainder')

    **Keep existing webhook cases (account.updated, existing payment_intent handlers) unchanged.** Only ADD marketplace-specific handling within the existing structure.
  </action>
  <verify>
    1. `pnpm exec tsc --noEmit` passes
    2. Webhook handler has deposit and existing payment paths that don't conflict
    3. booking-bridge.ts exports createMarketplaceBooking with correct type signature
    4. Existing webhook behavior (booking confirmation, account.updated) is unchanged
    5. marketplace_award_history is populated with winning and losing quote IDs
  </verify>
  <done>
    On deposit success via webhook: marketplace booking(s) created with source='marketplace' and commission split, quote marked 'awarded', event marked 'awarded', other quotes marked 'rejected', award history recorded, payment method saved, medic commitments created for named medics. Existing webhook behavior preserved.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- zero type errors across all new files
2. Award modal renders confirm -> payment -> success flow
3. Stripe Payment Element renders in the payment step
4. Webhook handler creates booking on deposit success with correct source='marketplace'
5. Losing quotes are automatically rejected when winning quote deposit succeeds
6. Event transitions to 'awarded' status after deposit
</verification>

<success_criteria>
- Client sees "Award This Quote" button, clicks it, sees payment breakdown modal
- Client can pay deposit via embedded Stripe Payment Element
- On deposit success, booking auto-created with source='marketplace' and all payment tracking columns populated
- Quote statuses update (winner -> 'awarded', others -> 'rejected')
- Event status transitions to 'awarded'
- Award audit trail in marketplace_award_history
- Medic commitments created for named medics (EXCLUSION safety)
- Payment method saved for future remainder charge
</success_criteria>

<output>
After completion, create `.planning/phases/35-award-flow-payment/35-02-SUMMARY.md`
</output>
