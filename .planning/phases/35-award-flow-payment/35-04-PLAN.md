---
phase: 35-award-flow-payment
plan: 04
type: execute
wave: 3
depends_on: ["35-02"]
files_modified:
  - web/lib/marketplace/notifications.ts
  - web/components/marketplace/award/AwardedEventDetails.tsx
  - web/app/api/marketplace/events/[id]/awarded/route.ts
autonomous: true

must_haves:
  truths:
    - "Winning company receives notification with full client contact details after deposit"
    - "Non-selected companies receive 'not selected' notification"
    - "Client contact details are visible on the awarded event detail page"
    - "Contact details remain hidden until both awarded AND deposit paid"
  artifacts:
    - path: "web/lib/marketplace/notifications.ts"
      provides: "Email notification functions for award, rejection, and payment events"
      contains: "sendAwardNotification"
    - path: "web/components/marketplace/award/AwardedEventDetails.tsx"
      provides: "Dashboard component showing awarded event with client contact details revealed"
      min_lines: 40
    - path: "web/app/api/marketplace/events/[id]/awarded/route.ts"
      provides: "GET endpoint returning awarded event details with contact info for winning company"
      exports: ["GET"]
  key_links:
    - from: "web/lib/marketplace/notifications.ts"
      to: "Resend API"
      via: "fetch to send email"
      pattern: "resend|email"
    - from: "web/app/api/marketplace/events/[id]/awarded/route.ts"
      to: "canViewContactDetails"
      via: "access control check before revealing contact"
      pattern: "canViewContactDetails|awarded.*deposit"
    - from: "web/app/api/stripe/webhooks/route.ts"
      to: "web/lib/marketplace/notifications.ts"
      via: "import and call sendAwardNotification on deposit success"
      pattern: "sendAwardNotification|sendRejectionNotification"
---

<objective>
Build the notification system for award events (winner email with client contact, rejection emails, client confirmation) and the dashboard contact reveal that shows full client details to the winning company after deposit payment.

Purpose: After a quote is awarded and deposit is paid, the winning company needs to coordinate with the client. This plan implements the email notifications and dashboard contact reveal that enable coordination. Non-winning companies receive courteous rejection emails. The contact gating rule from Phase 34 (hidden until BOTH awarded AND deposit paid) is enforced server-side.

Output: Notification helper functions, awarded event details API with contact reveal, dashboard component showing client details, and webhook integration for email triggers.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-award-flow-payment/35-CONTEXT.md
@.planning/phases/35-award-flow-payment/35-RESEARCH.md
@.planning/phases/35-award-flow-payment/35-01-SUMMARY.md
@.planning/phases/35-award-flow-payment/35-02-SUMMARY.md

Key reference files:
@web/lib/marketplace/quote-types.ts
@web/app/api/stripe/webhooks/route.ts
@supabase/functions/_shared/email-templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Award notification functions and webhook email triggers</name>
  <files>
    web/lib/marketplace/notifications.ts
    web/app/api/stripe/webhooks/route.ts
  </files>
  <action>
    **Notification helper functions (web/lib/marketplace/notifications.ts):**

    Create email notification functions using the Resend API (same pattern as existing email-templates.ts). Use `fetch` to call Resend directly from Next.js API routes (not Edge Functions). The Resend API key comes from `process.env.RESEND_API_KEY`.

    Export these functions:

    1. `sendAwardNotification(params)` -- Email to winning company admin
       - To: company admin email (from marketplace_companies.admin_user_id -> profiles.email, or from marketplace_companies contact info)
       - Subject: "Congratulations! Your quote has been awarded for {event_name}"
       - Body (HTML):
         - "Your quote of {total_price} for {event_name} has been awarded by the client."
         - "Client Contact Details:" (section header)
         - Client name, email, phone, event address (full details)
         - Event details: dates, times, location, staffing requirements
         - "Next Steps:" section with actionable guidance
         - Link to event detail page on dashboard: /marketplace/events/{eventId}

    2. `sendRejectionNotification(params)` -- Email to non-winning companies
       - To: company admin email
       - Subject: "Update on your quote for {event_name}"
       - Body (HTML):
         - "Thank you for submitting your quote for {event_name}."
         - "Unfortunately, the client has selected another provider for this event."
         - "Your quote of {total_price} has been marked as not selected."
         - Encouraging tone: "There are new events being posted regularly. Browse current opportunities: {link}"
         - Link to marketplace browse page: /marketplace/events

    3. `sendClientDepositConfirmation(params)` -- Email to client after deposit
       - To: client email
       - Subject: "Deposit Confirmed - {event_name}"
       - Body (HTML):
         - "Your deposit of {deposit_amount} ({deposit_percent}%) for {event_name} has been processed."
         - "Booking Confirmed" section with event details
         - "Winning Company:" company name (NOT full contact yet -- company contacts client)
         - "Payment Summary:" deposit paid, remainder due (amount + date)
         - "Your card has been securely saved for the remainder payment."
         - "You can update your payment method anytime: {dashboard_link}/marketplace/payments"
         - Payment reference: Stripe PI ID

    4. `sendRemainderFailedNotification(params)` -- Email to client on failed remainder
       - To: client email
       - Subject: "Action Required: Payment Failed for {event_name}"
       - Body (HTML):
         - "We were unable to charge your payment method for the remaining {remainder_amount}."
         - "Event: {event_name}, Amount: {remainder_amount}"
         - "This was attempt {attempt} of 3. We'll retry automatically."
         - "To avoid interruption, please update your payment method: {link}"
         - Link to payment method manager: /marketplace/payments

    **Email format:** Use simple HTML emails (not complex templates). SiteMedic branding: company name in header, footer with support email. Style inline (email-safe CSS). Use the existing pattern from _shared/email-templates.ts if it provides a base template.

    **If RESEND_API_KEY is not set:** Log warning and skip email (don't throw). This allows testing without Resend credentials.

    **Webhook integration (web/app/api/stripe/webhooks/route.ts):**

    Update the deposit webhook handler (added in Plan 02) to call notification functions:

    In `payment_intent.succeeded` where `payment_type === 'deposit'`:
    - After booking creation and status updates (existing Plan 02 logic), ADD:
    - Fetch winning company admin email (marketplace_companies -> admin_user_id -> auth.users email)
    - Fetch client email and details (event.posted_by -> auth.users)
    - Call `sendAwardNotification()` with company email, client details, event details, total price
    - Call `sendRejectionNotification()` for each rejected quote (fetch company emails in batch)
    - Call `sendClientDepositConfirmation()` with client email, deposit amount, event details
    - Wrap each email send in try/catch (email failure must NOT block the webhook response)

    In `payment_intent.payment_failed` where `payment_type === 'remainder'`:
    - Call `sendRemainderFailedNotification()` with client email, remainder amount, event name, attempt number
    - Already partially handled in Plan 03 -- this just adds the import and function call

    **IMPORTANT:** Email sends MUST be wrapped in try/catch individually. A failed email must NEVER cause the webhook to return non-200 (Stripe would retry the entire webhook).
  </action>
  <verify>
    1. `pnpm exec tsc --noEmit` passes
    2. All 4 notification functions exported from notifications.ts
    3. Webhook handler calls sendAwardNotification on deposit success
    4. Webhook handler calls sendRejectionNotification for each losing company
    5. Email functions gracefully skip when RESEND_API_KEY is not set
    6. Each email send is wrapped in its own try/catch in the webhook
  </verify>
  <done>
    Award notification sent to winning company with full client contact details. Rejection notifications sent to all non-winning companies. Client receives deposit confirmation email. Remainder failure triggers email with payment update link. All emails fire from webhook handler with graceful error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Awarded event details API and dashboard contact reveal component</name>
  <files>
    web/app/api/marketplace/events/[id]/awarded/route.ts
    web/components/marketplace/award/AwardedEventDetails.tsx
  </files>
  <action>
    **Awarded event details API (GET /api/marketplace/events/[id]/awarded):**

    This endpoint returns the full event details with client contact information ONLY to the winning company.

    1. Authenticate user
    2. Fetch the event by ID
    3. Fetch the awarded quote (status='awarded') for this event
    4. **Access control check:**
       - If user is the winning company admin (quote.company_id -> marketplace_companies.admin_user_id === user.id):
         Return FULL details including client contact (name, email, phone, address)
       - If user is the event poster (event.posted_by === user.id):
         Return event details + awarded company info (but company already knows client details)
       - Otherwise: 403
    5. **Contact gating rule (from Phase 34 decision):**
       - Contact details are ONLY revealed if BOTH conditions are true:
         a. Event status is 'awarded'
         b. Deposit has been paid (check: awarded quote exists AND booking with deposit_payment_intent_id exists)
       - If event is awarded but deposit not yet paid (edge case: webhook hasn't fired yet), return event details but contact fields as null with a message "Contact details available after deposit confirmation"
    6. Return:
       ```json
       {
         "event": { id, event_name, event_type, dates, times, location, description, staffing_requirements },
         "award": { awarded_at, deposit_amount, deposit_percent, remainder_amount, remainder_due_at },
         "client": { name, email, phone, address } | null,
         "company": { name, admin_email } | null,
         "booking": { id, status } | null,
         "contactRevealed": true | false
       }
       ```

    **AwardedEventDetails.tsx:**

    'use client' component that renders on the event detail page when event.status === 'awarded'.

    - Fetches from GET /api/marketplace/events/{eventId}/awarded
    - For the winning company:
      - Section header: "You've been awarded this event!" with green check badge
      - **Client Contact Details** card (highlighted):
        - Client name, email (mailto link), phone (tel link), event address
        - "Contact the client to coordinate event logistics"
      - **Event Details** section: dates, times, location, requirements
      - **Payment Status** section: deposit paid amount, remainder due date
      - **Booking Link**: "View Booking" button linking to the booking in the SiteMedic dashboard
    - For the event poster (client view):
      - Section header: "Event Awarded" with company name
      - **Payment Summary**: deposit paid, remainder due date, manage payment method link
      - **Awarded Company**: company name
    - If contact not yet revealed (deposit pending):
      - Show message: "Contact details will be available once the deposit payment is confirmed"
      - Subtle spinner or "Processing payment..." indicator
    - Responsive layout with Tailwind, using shadcn Card, Badge, Button
    - Integrate this component into the existing event detail page (check where event details are rendered -- likely web/app/marketplace/events/[eventId]/page.tsx or similar)

    **Integration point:** Add an "Award This Quote" button to the existing quote detail/comparison view. When event.status === 'awarded', replace the award button with a link to the AwardedEventDetails section. Reference the existing quote list page to find where to add the AwardConfirmationModal trigger.

    Check existing files:
    - web/app/marketplace/events/[eventId]/page.tsx (or similar event detail page)
    - web/components/marketplace/quote-detail/ (existing quote display components)
    - Add "Award This Quote" button to quote rows/cards in the quote list
    - On awarded event, show AwardedEventDetails instead of quote list
  </action>
  <verify>
    1. `pnpm exec tsc --noEmit` passes
    2. GET /api/marketplace/events/{id}/awarded returns client contact ONLY for winning company
    3. Contact details are null when deposit hasn't been confirmed yet
    4. AwardedEventDetails renders client contact card for winning company
    5. AwardedEventDetails renders payment summary for event poster
    6. "Award This Quote" button exists in the quote comparison view
    7. canViewContactDetails pattern from Phase 34 is respected (awarded AND deposit paid)
  </verify>
  <done>
    Winning company sees full client contact details (name, email, phone, address) on the dashboard after deposit. Event poster sees payment summary and awarded company info. Contact gating enforced: details hidden until both awarded AND deposit paid. Award trigger button integrated into quote comparison view.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- zero type errors
2. Winning company receives email with client contact on deposit success (AWRD-03)
3. Non-winning companies receive rejection email (AWRD-04)
4. Client receives deposit confirmation email
5. Dashboard shows full client contact to winning company only (AWRD-03)
6. Contact hidden until both awarded AND deposit paid (Phase 34 rule)
7. Failed remainder triggers email with payment update link (AWRD-09)
</verification>

<success_criteria>
- Winning company gets email + dashboard notification with event details and client contact info (AWRD-03)
- Non-selected companies receive "not selected" notification (AWRD-04)
- Client gets deposit confirmation email with payment reference and remainder schedule
- Contact details gated behind awarded + deposit_paid (not just awarded status)
- Failed remainder charges trigger client email with dashboard link (AWRD-09)
- "Award This Quote" button visible in quote comparison, triggers award modal
</success_criteria>

<output>
After completion, create `.planning/phases/35-award-flow-payment/35-04-SUMMARY.md`
</output>
