---
phase: 35-award-flow-payment
plan: 03
type: execute
wave: 3
depends_on: ["35-02"]
files_modified:
  - supabase/functions/charge-remainder-payment/index.ts
  - supabase/migrations/149b_remainder_charge_cron.sql
  - web/components/marketplace/award/PaymentMethodManager.tsx
  - web/app/api/marketplace/payments/method/route.ts
  - web/app/api/stripe/webhooks/route.ts
autonomous: true

must_haves:
  truths:
    - "Remainder is auto-charged 14 days after event completion via scheduled Edge Function"
    - "Failed remainder charges are tracked and retried (3 attempts over 7 days)"
    - "Client receives notification on failed remainder charge with link to update payment method"
    - "Client can view and update their saved payment method in the dashboard"
    - "Commission is deducted from company's side using existing platform_fee_percent/medic_payout_percent"
  artifacts:
    - path: "supabase/functions/charge-remainder-payment/index.ts"
      provides: "Edge Function that queries due remainders and charges saved payment methods"
      contains: "off_session.*true"
    - path: "supabase/migrations/149b_remainder_charge_cron.sql"
      provides: "pg_cron schedule for daily remainder charge check"
      contains: "cron.schedule"
    - path: "web/components/marketplace/award/PaymentMethodManager.tsx"
      provides: "Dashboard component for clients to view/update saved card"
      min_lines: 40
    - path: "web/app/api/marketplace/payments/method/route.ts"
      provides: "API to list and update saved payment methods"
      exports: ["GET", "PUT"]
  key_links:
    - from: "supabase/functions/charge-remainder-payment/index.ts"
      to: "stripe.paymentIntents.create"
      via: "off-session PaymentIntent creation"
      pattern: "off_session.*true"
    - from: "supabase/functions/charge-remainder-payment/index.ts"
      to: "bookings table"
      via: "query for due remainders"
      pattern: "remainder_due_at.*remainder_paid_at.*null"
    - from: "web/app/api/stripe/webhooks/route.ts"
      to: "bookings.remainder_paid_at"
      via: "update on remainder success"
      pattern: "payment_type.*remainder"
---

<objective>
Build the remainder payment automation (scheduled Edge Function + pg_cron for 14-day post-event charges), the webhook handlers for remainder success/failure, and the client-facing payment method manager so clients can update their card before the remainder is charged.

Purpose: After the event completes, the remainder must be automatically charged to the client's saved payment method. This plan implements the scheduled charge, retry logic for failures, client notifications on failure, and a dashboard UI for managing saved cards. Commission deduction happens at booking creation (Plan 02) using the existing platform_fee_percent/medic_payout_percent pattern, so payouts flow through the existing friday-payout pipeline automatically.

Output: charge-remainder-payment Edge Function, pg_cron migration, remainder webhook handlers, payment method API, and PaymentMethodManager UI component.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-award-flow-payment/35-CONTEXT.md
@.planning/phases/35-award-flow-payment/35-RESEARCH.md
@.planning/phases/35-award-flow-payment/35-01-SUMMARY.md
@.planning/phases/35-award-flow-payment/35-02-SUMMARY.md

Key reference files:
@supabase/functions/friday-payout/index.ts
@supabase/functions/_shared/stripe.ts
@supabase/functions/_shared/email-templates.ts
@web/app/api/stripe/webhooks/route.ts
@web/lib/marketplace/booking-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remainder charge Edge Function and pg_cron schedule</name>
  <files>
    supabase/functions/charge-remainder-payment/index.ts
    supabase/migrations/149b_remainder_charge_cron.sql
  </files>
  <action>
    **Edge Function (charge-remainder-payment/index.ts):**

    Follow the friday-payout Edge Function pattern. Use Deno serve() with service role key auth:

    1. Validate authorization header (same pattern as friday-payout)
    2. Create Supabase client with service role key
    3. Query bookings where:
       - source = 'marketplace'
       - remainder_due_at <= NOW() (due today or overdue)
       - remainder_paid_at IS NULL (not yet paid)
       - remainder_payment_intent_id IS NULL (not already attempted -- for initial charge)
       - OR: remainder_failed_attempts > 0 AND remainder_failed_attempts < 3 AND next retry is due
         Retry schedule: attempt 1 = day 1, attempt 2 = day 3, attempt 3 = day 7 after initial failure
         Calculate: remainder_last_failed_at + interval based on attempt count
    4. For each due booking:
       a. Create a Stripe PaymentIntent with:
          - amount: remainder_amount in pence
          - currency: 'gbp'
          - customer: stripe_customer_id
          - payment_method: stripe_payment_method_id
          - off_session: true (CRITICAL: customer not present)
          - confirm: true (immediately attempt charge)
          - metadata: { booking_id, event_id: marketplace_event_id, payment_type: 'remainder', attempt: current_attempt + 1 }
          - idempotencyKey: `pi_remainder_${booking.id}_attempt_${attempt}` (prevents double charges)
       b. On success:
          - Update booking: remainder_payment_intent_id = paymentIntent.id
          - Log success
       c. On Stripe error:
          - Update booking: remainder_failed_attempts++, remainder_last_failed_at = now()
          - If error code is 'authentication_required':
            Log that SCA is needed. The webhook handler will send email with link to update payment method.
          - Log failure with booking ID and error
    5. Return summary: { processed, success, failed, errors[] }

    **Use `../\_shared/stripe.ts`** for Stripe instance (same as friday-payout). If it doesn't exist, create it following the friday-payout import pattern.

    **Retry logic:** The Edge Function runs daily. It processes:
    - Initial charges: remainder_due_at <= NOW() AND remainder_payment_intent_id IS NULL
    - Retries: remainder_failed_attempts > 0 AND remainder_failed_attempts < 3 AND retry is due
    - Retry timing: 1 day after attempt 1, 3 days after attempt 2, 7 days after attempt 3
    - After 3 failures (remainder_failed_attempts >= 3): Skip this booking (escalation handled separately -- mark as 'payment_failed' and alert admin)

    **pg_cron migration (149b_remainder_charge_cron.sql):**

    ```sql
    -- Migration 149b: Schedule daily remainder charge check
    -- Runs at 8 AM UTC every day
    -- Calls the charge-remainder-payment Edge Function

    SELECT cron.schedule(
      'charge-marketplace-remainders',
      '0 8 * * *',
      $$
      SELECT
        net.http_post(
          url:=current_setting('app.settings.supabase_url') || '/functions/v1/charge-remainder-payment',
          headers:=json_build_object(
            'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key'),
            'Content-Type', 'application/json'
          )::jsonb,
          body:=json_build_object(
            'action', 'charge_due_remainders',
            'timestamp', NOW()
          )::jsonb
        ) AS request_id;
      $$
    );
    ```

    Follow the pattern from migration 039_territory_metrics_cron.sql for the exact pg_cron syntax used in this codebase.

    **IMPORTANT:** Check how 039 references the Supabase URL and service role key (it might use Vault or app.settings). Use the same approach -- do NOT hardcode URLs or keys.
  </action>
  <verify>
    1. Edge Function file has valid Deno syntax (no Node.js-specific imports)
    2. Migration SQL uses the same pg_cron pattern as existing cron jobs in the codebase
    3. Retry logic: 3 attempts, with increasing intervals (1, 3, 7 days)
    4. Idempotency keys prevent double-charging on Edge Function retries
    5. off_session: true is set on all remainder PaymentIntents
  </verify>
  <done>
    Edge Function queries due marketplace remainders, creates off-session PaymentIntents with retry logic (3 attempts over 7 days), and pg_cron schedules daily execution at 8 AM UTC. Idempotency keys prevent double charges.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remainder webhook handlers, payment method API, and manager UI</name>
  <files>
    web/app/api/stripe/webhooks/route.ts
    web/app/api/marketplace/payments/method/route.ts
    web/components/marketplace/award/PaymentMethodManager.tsx
  </files>
  <action>
    **Webhook handler additions (web/app/api/stripe/webhooks/route.ts):**

    Add remainder handling to the EXISTING switch cases (Plan 02 already added deposit handling):

    In `payment_intent.succeeded`:
    - If `payment_type === 'remainder'`:
      1. Extract booking_id from metadata
      2. Update booking: remainder_paid_at = now(), remainder_payment_intent_id = paymentIntent.id
      3. Log: "Remainder charged successfully for booking {bookingId}"
      4. The booking is now fully paid. The existing friday-payout Edge Function will process the medic payout on the next Friday cycle (it queries confirmed bookings with completed timesheets).

    In `payment_intent.payment_failed`:
    - If `payment_type === 'remainder'`:
      1. Extract booking_id, attempt from metadata
      2. Update booking: remainder_failed_attempts = attempt, remainder_last_failed_at = now()
      3. If attempt >= 3: Set a flag or status indicating payment failure escalation needed
      4. Send failure notification email to client using Resend (via fetch to Resend API or existing email helper):
         - Subject: "Action Required: Payment Failed for {event_name}"
         - Body: "Your scheduled payment of {remainder_amount} for {event_name} could not be processed. Please update your payment method: {dashboard_link}/marketplace/payments"
         - Include: amount, event name, link to payment method manager
      5. DO NOT cancel the booking (unlike direct booking failures). Marketplace bookings should stay confirmed and retry.

    **Payment method API (web/app/api/marketplace/payments/method/route.ts):**

    GET handler:
    - Authenticate user
    - Query client_payment_methods table where user_id = auth user id
    - Return array of saved payment methods (card_brand, card_last_four, card_expiry_month, card_expiry_year, is_default, id)
    - Also return any upcoming remainder charges: query bookings where stripe_customer_id matches AND remainder_paid_at IS NULL AND remainder_due_at IS NOT NULL

    PUT handler:
    - Authenticate user
    - Accept { paymentMethodId: string } in body
    - Call Stripe API to attach new payment method to customer: stripe.paymentMethods.attach(paymentMethodId, { customer: stripeCustomerId })
    - Set as default: stripe.customers.update(stripeCustomerId, { invoice_settings: { default_payment_method: paymentMethodId } })
    - Update all bookings for this customer that have remainder_paid_at IS NULL: set stripe_payment_method_id = new paymentMethodId
    - Update client_payment_methods table: mark old default as is_default=false, add new method as is_default=true
    - Return updated payment method list

    **PaymentMethodManager.tsx:**

    'use client' component for the marketplace client dashboard:
    - Fetches saved payment methods via GET /api/marketplace/payments/method
    - Shows current card: "Visa ending in 4242, expires 12/27" with card brand icon
    - Shows upcoming charges: "Remainder of Â£X due on {date} for {event_name}"
    - "Update Payment Method" button that opens a SetupIntent flow:
      1. Creates a new SetupIntent via a small API endpoint (or reuse the PUT with Stripe Elements)
      2. Shows Stripe Payment Element to collect new card
      3. On success, calls PUT to update the default method
    - If no payment method saved, show "No payment method on file" with setup option
    - Use shadcn Card, Badge, Button components
    - Tailwind styling consistent with existing dashboard pages

    **IMPORTANT for commission/payout:** Commission is already deducted at booking creation time (Plan 02 booking bridge uses platform_fee_percent/medic_payout_percent). The friday-payout Edge Function already processes bookings by looking at confirmed bookings with approved timesheets and their medic_payout column. No changes needed to friday-payout -- marketplace bookings with source='marketplace' will be picked up automatically because they have the same structure (medic_payout column set, source column exists but friday-payout doesn't filter by it).

    Verify that friday-payout does NOT filter by source column. If it does, it may need a minor update to include source='marketplace'. Check the existing query in friday-payout/index.ts.
  </action>
  <verify>
    1. `pnpm exec tsc --noEmit` passes
    2. Webhook handles remainder succeeded (updates booking) and remainder failed (sends email, doesn't cancel booking)
    3. GET /api/marketplace/payments/method returns saved cards for authenticated user
    4. PUT /api/marketplace/payments/method updates payment method on Stripe and in database
    5. PaymentMethodManager renders current card and upcoming charges
    6. Existing friday-payout Edge Function will process marketplace bookings (confirm no source filter)
  </verify>
  <done>
    Remainder success updates booking as fully paid. Remainder failure sends email notification with link to update payment method and tracks failed attempts. Client can view/update saved card via dashboard. Commission flows through existing payout pipeline with no friday-payout changes needed (or minimal filter update if source-filtered).
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- zero type errors
2. Edge Function creates off-session PaymentIntents with proper idempotency
3. pg_cron migration follows existing codebase pattern
4. Remainder webhook doesn't cancel marketplace bookings on failure (unlike direct bookings)
5. Failed remainder sends email to client with update link
6. Payment method manager shows current card and allows updates
7. Existing friday-payout pipeline will process marketplace bookings for medic payouts
</verification>

<success_criteria>
- Remainder auto-charged 14 days after event via Edge Function + pg_cron (AWRD-05)
- 3 retries over 7 days on failure with email notification on each attempt (AWRD-09)
- Commission deducted at booking creation using platform_fee_percent/medic_payout_percent (AWRD-06)
- Payout follows existing friday-payout pipeline via Stripe Connect (AWRD-07)
- Client can manage saved payment method in dashboard
- Payment method saved at deposit time is used for off-session remainder (AWRD-08)
</success_criteria>

<output>
After completion, create `.planning/phases/35-award-flow-payment/35-03-SUMMARY.md`
</output>
