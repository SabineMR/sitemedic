---
phase: 36-ratings-messaging-disputes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/152_marketplace_ratings.sql
  - web/lib/marketplace/rating-types.ts
  - web/lib/marketplace/types.ts
  - web/app/api/marketplace/events/[id]/ratings/route.ts
  - web/app/api/marketplace/ratings/[id]/report/route.ts
  - web/components/marketplace/ratings/MarketplaceRatingForm.tsx
  - web/components/marketplace/ratings/ReviewCard.tsx
  - web/components/marketplace/ratings/CompanyRatingsSummary.tsx
  - web-marketplace/app/companies/[id]/page.tsx
  - web-marketplace/app/api/marketplace/quotes/list/route.ts
autonomous: true

must_haves:
  truths:
    - "After event completion, both client and company can leave a star rating (1-5) and written review within a 14-day window"
    - "Ratings are blind — neither party sees the other's rating until both have submitted or the 14-day window expires"
    - "Company profiles show aggregate star rating (average + count) and a scrollable list of individual written reviews"
    - "Ratings influence quote sorting via the existing best-value algorithm (company_rating/company_review_count populated from real data)"
    - "Either party can report a review, and platform admin can remove inappropriate content"
  artifacts:
    - path: "supabase/migrations/152_marketplace_ratings.sql"
      provides: "Rating extensions (blind_window_expires_at, moderation columns, aggregate columns on marketplace_companies, trigger)"
      contains: "blind_window_expires_at"
    - path: "web/app/api/marketplace/events/[id]/ratings/route.ts"
      provides: "Marketplace rating API with blind window logic"
      exports: ["GET", "POST"]
    - path: "web/components/marketplace/ratings/MarketplaceRatingForm.tsx"
      provides: "Rating form adapted for marketplace events with blind window awareness"
    - path: "web/components/marketplace/ratings/CompanyRatingsSummary.tsx"
      provides: "Aggregate rating display + scrollable review list for company profiles"
  key_links:
    - from: "web/app/api/marketplace/events/[id]/ratings/route.ts"
      to: "supabase/migrations/152_marketplace_ratings.sql"
      via: "blind_window_expires_at check in GET response"
      pattern: "blind_window_expires_at"
    - from: "web-marketplace/app/api/marketplace/quotes/list/route.ts"
      to: "marketplace_companies.average_rating"
      via: "JOIN to populate company_rating on quote list"
      pattern: "average_rating"
---

<objective>
Implement bidirectional ratings for marketplace events with a 14-day blind window, aggregate rating display on company profiles, moderation support, and wiring to the best-value quote sorting algorithm.

Purpose: Ratings build trust in the marketplace by giving both clients and companies visibility into each other's track record. The blind window prevents retaliation ratings (Uber/Airbnb pattern). Aggregate ratings on company profiles and quote sorting create a quality signal that rewards good service.

Output: Migration 152 extending job_ratings + marketplace_companies; marketplace ratings API with blind window; rating form, review cards, and company rating summary components; quote list API wired to real rating data; report/moderation API.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@supabase/migrations/148_direct_job_ratings.sql
@web/components/direct-jobs/RatingForm.tsx
@web/lib/marketplace/quote-scoring.ts
@web/lib/marketplace/quote-types.ts
@web/lib/marketplace/types.ts
@web-marketplace/app/companies/[id]/page.tsx
@web-marketplace/app/api/marketplace/quotes/list/route.ts
@web/app/api/direct-jobs/[id]/ratings/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and TypeScript types for marketplace ratings</name>
  <files>
    supabase/migrations/152_marketplace_ratings.sql
    web/lib/marketplace/rating-types.ts
    web/lib/marketplace/types.ts
  </files>
  <action>
    **Migration 152** — Extend existing `job_ratings` table and `marketplace_companies` for marketplace ratings:

    1. **Add columns to `job_ratings`:**
       - `blind_window_expires_at TIMESTAMPTZ` — computed as event completion date + 14 days, set on INSERT via trigger or by API
       - `moderation_status TEXT NOT NULL DEFAULT 'published' CHECK (moderation_status IN ('published', 'flagged', 'removed'))` — for admin moderation
       - `flagged_at TIMESTAMPTZ` — when a user reported this review
       - `flagged_by UUID REFERENCES auth.users(id)` — who reported it
       - `flagged_reason TEXT` — why it was reported
       - `moderation_notes TEXT` — admin notes when resolving a flag
       - `moderated_by UUID REFERENCES auth.users(id)` — admin who resolved
       - `moderated_at TIMESTAMPTZ` — when admin resolved

    2. **Add columns to `marketplace_companies`:**
       - `average_rating NUMERIC(2,1) DEFAULT 0` — denormalized aggregate (e.g. 4.3)
       - `review_count INTEGER DEFAULT 0` — denormalized count of published ratings where rater_type='client'

    3. **Create trigger function `update_company_rating_aggregate()`:**
       - Fires AFTER INSERT, UPDATE, DELETE on `job_ratings`
       - Resolves company_id from: `marketplace_events.id = job_ratings.job_id`, then find the awarded quote's company_id from `marketplace_quotes WHERE event_id = job_id AND status = 'awarded'`
       - Computes average and count of published client ratings for that company across ALL their awarded events
       - Updates `marketplace_companies.average_rating` and `review_count`
       - Only processes ratings where `rater_type = 'client'` AND `moderation_status = 'published'`
       - Handle NULL company gracefully (direct jobs have no company — skip aggregate)

    4. **Create trigger:** `AFTER INSERT OR UPDATE OR DELETE ON job_ratings FOR EACH ROW EXECUTE FUNCTION update_company_rating_aggregate()`

    5. **Add index:** `idx_job_ratings_moderation ON job_ratings(moderation_status) WHERE moderation_status != 'published'` (partial, for admin queries)

    6. **Add composite index:** `idx_job_ratings_company_aggregate ON job_ratings(job_id, rater_type, moderation_status)` for efficient aggregate computation

    **TypeScript types** (`web/lib/marketplace/rating-types.ts`):
    - `ModerationStatus = 'published' | 'flagged' | 'removed'`
    - `MarketplaceRating` extending the base rating with `blind_window_expires_at`, `moderation_status`, `flagged_at`, `flagged_by`, `flagged_reason`, `moderation_notes`
    - `RatingVisibility = 'visible' | 'blind' | 'pending'` — computed enum for UI
    - `CompanyRatingAggregates = { average_rating: number; review_count: number }`
    - `RatingReportRequest = { rating_id: string; reason: string }`
    - `MarketplaceRatingsResponse = { ratings: MarketplaceRating[]; averageRating: number; count: number; canRate: boolean; blindWindowActive: boolean; blindWindowExpiresAt: string | null }`

    **Update `web/lib/marketplace/types.ts`:**
    - Add `average_rating: number` and `review_count: number` to the `MarketplaceCompany` interface
  </action>
  <verify>
    - Migration file exists at `supabase/migrations/152_marketplace_ratings.sql`
    - TypeScript types compile: `cd web && npx tsc --noEmit --skipLibCheck 2>&1 | head -30`
    - Migration SQL is valid (no syntax errors when read)
  </verify>
  <done>
    Migration 152 adds blind_window_expires_at + moderation columns to job_ratings, adds average_rating + review_count to marketplace_companies, creates aggregate trigger. TypeScript types defined in rating-types.ts and MarketplaceCompany updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Marketplace ratings API, rating form, and moderation</name>
  <files>
    web/app/api/marketplace/events/[id]/ratings/route.ts
    web/app/api/marketplace/ratings/[id]/report/route.ts
    web/components/marketplace/ratings/MarketplaceRatingForm.tsx
    web/components/marketplace/ratings/ReviewCard.tsx
    web/components/marketplace/ratings/CompanyRatingsSummary.tsx
    web-marketplace/app/companies/[id]/page.tsx
    web-marketplace/app/api/marketplace/quotes/list/route.ts
  </files>
  <action>
    **Marketplace Ratings API** (`web/app/api/marketplace/events/[id]/ratings/route.ts`):

    - **GET**: Fetch ratings for a marketplace event.
      - Query `job_ratings` WHERE `job_id = eventId`
      - Compute blind window: `blind_window_expires_at` from job_ratings row. If both client and company have rated, OR `NOW() > blind_window_expires_at`, ratings are visible. Otherwise, the requesting user only sees their own rating (with a "waiting for other party" indicator).
      - Response: `{ ratings, averageRating, count, canRate, blindWindowActive, blindWindowExpiresAt }`
      - `canRate` is true when: user hasn't rated yet, event status is 'completed', AND `NOW() <= blind_window_expires_at`
      - Include `viewerRating` (the authenticated user's own rating, if exists) regardless of blind window

    - **POST**: Submit or update a rating.
      - Auth: Must be authenticated
      - Determine `rater_type`: If user is the event poster (check `marketplace_events.posted_by`), rater_type = 'client'. If user is the company admin (check `marketplace_quotes.company_id` -> `marketplace_companies.admin_user_id` for the awarded quote), rater_type = 'company'.
      - Validate: event status must be 'completed', `blind_window_expires_at` must be in the future (14-day window still open)
      - Compute `blind_window_expires_at`: Look up the last event_day's date from `event_days` WHERE `event_id = eventId`, add 14 days
      - Upsert into `job_ratings` (UNIQUE on job_id + rater_user_id handles create-or-update)
      - Body: `{ rating: number (1-5), review?: string (max 2000 chars) }`

    **Report API** (`web/app/api/marketplace/ratings/[id]/report/route.ts`):
    - **POST**: Report a review for moderation.
      - Auth: Must be authenticated
      - Updates the rating: `moderation_status = 'flagged'`, `flagged_at = NOW()`, `flagged_by = user.id`, `flagged_reason = body.reason`
      - Only published ratings can be flagged (not already flagged/removed)
      - Platform admin can also use this to directly set `moderation_status = 'removed'` with `moderation_notes`

    **MarketplaceRatingForm** (`web/components/marketplace/ratings/MarketplaceRatingForm.tsx`):
    - Adapt the existing `RatingForm` pattern from `web/components/direct-jobs/RatingForm.tsx`
    - Props: `eventId`, `existingRating?`, `onRatingSubmitted?`, `raterType` ('client' | 'company')
    - Uses 5-star selector (reuse `StarRatingInput` pattern) + review textarea (2000 char max)
    - Submits to `POST /api/marketplace/events/[id]/ratings`
    - Show "blind window" info message: "Your rating will be visible after both parties have rated or after [date]"
    - If `canRate` is false, show read-only view or "rating window closed" message

    **ReviewCard** (`web/components/marketplace/ratings/ReviewCard.tsx`):
    - Displays a single review: star rating (StarDisplay), reviewer name (masked: "First L."), review text, date, rater_type badge
    - "Report" button (opens simple modal with reason text input) — calls report API
    - If `moderation_status === 'removed'`, show "[Review removed by moderator]" placeholder

    **CompanyRatingsSummary** (`web/components/marketplace/ratings/CompanyRatingsSummary.tsx`):
    - Props: `companyId`, `averageRating`, `reviewCount`
    - Top section: Large aggregate star display + "4.3 out of 5 (27 reviews)" text
    - Rating distribution bar chart (5 horizontal bars showing count per star level)
    - Scrollable list of ReviewCard components underneath (paginated, 10 per page)
    - Fetches reviews from a new query: GET ratings WHERE company is the subject (rater_type='client' AND the company was awarded the event)

    **Company Profile Page Update** (`web-marketplace/app/companies/[id]/page.tsx`):
    - Add a "Reviews" tab/section below existing company information
    - Render `CompanyRatingsSummary` component
    - Pass `averageRating` and `reviewCount` from the company data (already fetched)

    **Quote List API Wiring** (`web-marketplace/app/api/marketplace/quotes/list/route.ts`):
    - When building the quote list response, JOIN to `marketplace_companies` to populate `company_rating` (from `average_rating`) and `company_review_count` (from `review_count`) on each quote
    - Replace any hardcoded placeholder values (0) with real data from the denormalized columns
    - This enables the existing `rankQuotesByBestValue()` client-side algorithm to use real rating data
  </action>
  <verify>
    - API route files exist and export GET/POST handlers
    - Component files exist and have proper React component exports
    - TypeScript compiles: `cd web && npx tsc --noEmit --skipLibCheck 2>&1 | head -30`
    - Quote list API JOINs to marketplace_companies for rating data (grep for 'average_rating')
  </verify>
  <done>
    Marketplace ratings API implements blind window logic (14-day, both-rated-early-reveal). Rating form, review card, and company summary components render on company profile pages. Quote list API populates company_rating from real aggregate data, enabling best-value sorting. Report API allows flagging reviews for admin moderation.
  </done>
</task>

</tasks>

<verification>
1. Migration 152 SQL is syntactically valid and adds all required columns/trigger
2. GET /api/marketplace/events/[id]/ratings returns blind-window-aware response
3. POST /api/marketplace/events/[id]/ratings enforces 14-day window and determines rater_type
4. Company profile page displays CompanyRatingsSummary with aggregate + individual reviews
5. Quote list API populates company_rating and company_review_count from marketplace_companies columns
6. Report API updates moderation_status on flagged ratings
7. TypeScript compilation succeeds
</verification>

<success_criteria>
- Ratings exist for marketplace events (migration 152 applied)
- Blind window correctly hides ratings until both submit or 14 days pass
- Company profiles show Google-Reviews-style rating display
- Quote sorting uses real rating data (not placeholder 0s)
- Reviews can be reported and admin can moderate
</success_criteria>

<output>
After completion, create `.planning/phases/36-ratings-messaging-disputes/36-01-SUMMARY.md`
</output>
