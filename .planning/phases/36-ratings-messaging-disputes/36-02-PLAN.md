---
phase: 36-ratings-messaging-disputes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/153_marketplace_messaging.sql
  - web/lib/marketplace/messaging-types.ts
  - web/app/api/marketplace/messages/conversations/route.ts
  - web/app/api/marketplace/messages/send/route.ts
  - web/app/api/marketplace/messages/conversations/[id]/read/route.ts
  - web/components/marketplace/messaging/MarketplaceInbox.tsx
  - web/components/marketplace/messaging/MarketplaceConversationRow.tsx
  - web/components/marketplace/messaging/MarketplaceMessageThread.tsx
  - web/components/marketplace/messaging/MarketplaceMessageInput.tsx
  - web-marketplace/app/messages/page.tsx
  - web-marketplace/app/events/[id]/page.tsx
  - web/lib/marketplace/notifications.ts
autonomous: true

must_haves:
  truths:
    - "Client can send messages to companies who have quoted on their event via an on-platform chat thread"
    - "Company can message about an event BEFORE submitting a quote to ask clarifying questions"
    - "All messages are stored on-platform with no contact details visible before award + deposit"
    - "Email notification is sent when a new message is received (sender name, ~100 char preview, event context, link to reply)"
    - "Both parties can access conversations from a central marketplace inbox AND from the event/quote detail page"
  artifacts:
    - path: "supabase/migrations/153_marketplace_messaging.sql"
      provides: "marketplace_conversations and marketplace_messages tables with user_id-scoped RLS"
      contains: "marketplace_conversations"
    - path: "web/app/api/marketplace/messages/send/route.ts"
      provides: "Send message API for marketplace conversations"
      exports: ["POST"]
    - path: "web/components/marketplace/messaging/MarketplaceInbox.tsx"
      provides: "Central marketplace inbox listing all conversations"
    - path: "web/components/marketplace/messaging/MarketplaceMessageThread.tsx"
      provides: "Chat-style message thread for marketplace conversations"
    - path: "web-marketplace/app/messages/page.tsx"
      provides: "Marketplace messages page with inbox and thread views"
  key_links:
    - from: "web/app/api/marketplace/messages/send/route.ts"
      to: "web/lib/marketplace/notifications.ts"
      via: "sendMarketplaceMessageNotification call after message insert"
      pattern: "sendMarketplaceMessageNotification"
    - from: "web/components/marketplace/messaging/MarketplaceInbox.tsx"
      to: "web/app/api/marketplace/messages/conversations/route.ts"
      via: "fetch conversation list on mount"
      pattern: "api/marketplace/messages/conversations"
    - from: "web-marketplace/app/events/[id]/page.tsx"
      to: "web/components/marketplace/messaging/MarketplaceMessageThread.tsx"
      via: "Messages tab renders thread for event conversation"
      pattern: "MarketplaceMessageThread"
---

<objective>
Implement per-event marketplace messaging between clients and companies, with a central marketplace inbox, chat-style message threads, and Airbnb-style email notifications.

Purpose: Marketplace messaging enables pre-quote clarifying questions and post-quote coordination WITHOUT exchanging contact details off-platform. This protects both parties and keeps SiteMedic as the trusted intermediary. The central inbox gives users a single place to manage all marketplace conversations.

Output: Migration 153 for marketplace messaging tables; messaging API routes (create conversation, send, mark read); inbox UI with conversation list and message thread; email notifications with sender name + preview; Messages tab on event detail pages.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@supabase/migrations/143_comms_docs_schema.sql
@web/app/api/messages/send/route.ts
@web/app/api/messages/conversations/route.ts
@web/app/(dashboard)/messages/components/ConversationList.tsx
@web/app/(dashboard)/messages/components/MessageThread.tsx
@web/lib/marketplace/notifications.ts
@web/lib/email/resend.ts
@web/lib/marketplace/types.ts
@web/lib/marketplace/quote-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and TypeScript types for marketplace messaging</name>
  <files>
    supabase/migrations/153_marketplace_messaging.sql
    web/lib/marketplace/messaging-types.ts
  </files>
  <action>
    **Migration 153** — Create separate marketplace messaging tables (NOT reusing internal org messaging):

    1. **`marketplace_conversations` table:**
       ```sql
       CREATE TABLE marketplace_conversations (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         event_id UUID NOT NULL REFERENCES marketplace_events(id) ON DELETE CASCADE,
         company_id UUID NOT NULL REFERENCES marketplace_companies(id) ON DELETE CASCADE,
         client_user_id UUID NOT NULL REFERENCES auth.users(id),
         company_user_id UUID NOT NULL REFERENCES auth.users(id),
         last_message_at TIMESTAMPTZ DEFAULT NOW(),
         last_message_preview TEXT,
         last_message_sender_id UUID REFERENCES auth.users(id),
         created_at TIMESTAMPTZ DEFAULT NOW(),
         updated_at TIMESTAMPTZ DEFAULT NOW(),
         UNIQUE(event_id, company_id)  -- one conversation per event+company pair
       );
       ```

    2. **`marketplace_messages` table:**
       ```sql
       CREATE TABLE marketplace_messages (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         conversation_id UUID NOT NULL REFERENCES marketplace_conversations(id) ON DELETE CASCADE,
         sender_id UUID NOT NULL REFERENCES auth.users(id),
         content TEXT NOT NULL,
         created_at TIMESTAMPTZ DEFAULT NOW()
       );
       ```

    3. **`marketplace_conversation_read_status` table:**
       ```sql
       CREATE TABLE marketplace_conversation_read_status (
         user_id UUID NOT NULL REFERENCES auth.users(id),
         conversation_id UUID NOT NULL REFERENCES marketplace_conversations(id) ON DELETE CASCADE,
         last_read_at TIMESTAMPTZ DEFAULT NOW(),
         PRIMARY KEY (user_id, conversation_id)
       );
       ```

    4. **RLS — user_id-scoped (cross-org by design):**
       - `marketplace_conversations`: SELECT/INSERT/UPDATE WHERE `auth.uid() IN (client_user_id, company_user_id)` — both parties can see their conversations
       - Platform admin: FOR ALL USING `is_platform_admin()`
       - `marketplace_messages`: SELECT WHERE conversation belongs to user (subquery check on marketplace_conversations). INSERT WITH CHECK sender_id = auth.uid() AND conversation belongs to user.
       - `marketplace_conversation_read_status`: user_id = auth.uid() for all operations

    5. **Indexes:**
       - `idx_mkt_conversations_event ON marketplace_conversations(event_id)`
       - `idx_mkt_conversations_company ON marketplace_conversations(company_id)`
       - `idx_mkt_conversations_client ON marketplace_conversations(client_user_id)`
       - `idx_mkt_conversations_company_user ON marketplace_conversations(company_user_id)`
       - `idx_mkt_messages_conversation ON marketplace_messages(conversation_id, created_at DESC)`
       - `idx_mkt_messages_sender ON marketplace_messages(sender_id)`

    6. **Trigger:** `update_updated_at_column()` on marketplace_conversations (reuse existing function)

    **TypeScript types** (`web/lib/marketplace/messaging-types.ts`):
    - `MarketplaceConversation` — mirrors table with additional `event_name?: string`, `company_name?: string`, `other_party_name?: string`, `unread_count?: number` (computed)
    - `MarketplaceMessage` — mirrors table with `sender_name?: string`
    - `MarketplaceConversationReadStatus` — mirrors table
    - `CreateConversationRequest = { event_id: string; company_id: string }`
    - `SendMarketplaceMessageRequest = { conversation_id: string; content: string }`
    - `MarketplaceConversationListResponse = { conversations: MarketplaceConversation[] }`
    - `MarketplaceMessageListResponse = { messages: MarketplaceMessage[]; conversation: MarketplaceConversation }`
  </action>
  <verify>
    - Migration file exists at `supabase/migrations/153_marketplace_messaging.sql`
    - TypeScript types file exists and compiles: `cd web && npx tsc --noEmit --skipLibCheck 2>&1 | head -30`
    - SQL contains CREATE TABLE for marketplace_conversations, marketplace_messages, marketplace_conversation_read_status
    - RLS policies use auth.uid() pattern (user-scoped, not org-scoped)
  </verify>
  <done>
    Migration 153 creates marketplace_conversations, marketplace_messages, and marketplace_conversation_read_status with user_id-scoped RLS. TypeScript types defined for all tables and request/response shapes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Messaging API routes, UI components, and email notifications</name>
  <files>
    web/app/api/marketplace/messages/conversations/route.ts
    web/app/api/marketplace/messages/send/route.ts
    web/app/api/marketplace/messages/conversations/[id]/read/route.ts
    web/components/marketplace/messaging/MarketplaceInbox.tsx
    web/components/marketplace/messaging/MarketplaceConversationRow.tsx
    web/components/marketplace/messaging/MarketplaceMessageThread.tsx
    web/components/marketplace/messaging/MarketplaceMessageInput.tsx
    web-marketplace/app/messages/page.tsx
    web-marketplace/app/events/[id]/page.tsx
    web/lib/marketplace/notifications.ts
  </files>
  <action>
    **API Routes:**

    **GET/POST `/api/marketplace/messages/conversations`:**
    - **GET**: List all marketplace conversations for the authenticated user.
      - Query `marketplace_conversations` WHERE `client_user_id = user.id OR company_user_id = user.id`
      - JOIN `marketplace_events` for `event_name`
      - JOIN `marketplace_companies` for `company_name`
      - Compute `unread_count` per conversation: COUNT messages WHERE `created_at > COALESCE(read_status.last_read_at, '1970-01-01')` AND `sender_id != user.id`
      - Compute `other_party_name`: If user is client, show company_name; if user is company, resolve client name from `profiles` or `marketplace_clients` via `client_user_id`
      - ORDER BY `last_message_at DESC`
      - Return `{ conversations: MarketplaceConversation[] }`

    - **POST**: Create or get existing conversation.
      - Body: `{ event_id, company_id }`
      - Auth check: User must be the event poster (client) OR the company admin
      - Determine `client_user_id` from `marketplace_events.posted_by` and `company_user_id` from `marketplace_companies.admin_user_id`
      - SELECT-then-INSERT pattern with UNIQUE constraint catch (same pattern as internal messaging from Phase 41-03)
      - Access check for companies: company must have a quote on the event (any status except 'withdrawn') OR be verified and the event is open (allowing pre-quote questions)
      - Return the conversation (new or existing)

    **POST `/api/marketplace/messages/send`:**
    - Auth: Must be authenticated and a participant in the conversation
    - Body: `{ conversation_id, content }` — content max 5000 chars
    - INSERT into `marketplace_messages`
    - UPDATE `marketplace_conversations` SET `last_message_at`, `last_message_preview` (truncated to 100 chars), `last_message_sender_id`
    - UPSERT sender's read status to NOW()
    - Fire-and-forget: call `sendMarketplaceMessageNotification()` for email to the OTHER party

    **PATCH `/api/marketplace/messages/conversations/[id]/read`:**
    - Auth: Must be a participant
    - UPSERT `marketplace_conversation_read_status` with `last_read_at = NOW()`

    **GET for messages within a conversation** (add to conversations/[id] route or send route):
    - Create `GET /api/marketplace/messages/conversations/[id]/route.ts`
    - Fetch conversation details + all messages ordered by `created_at ASC`
    - Include sender names (resolve from profiles table)
    - Mark conversation as read automatically on load

    **Email Notification** (add to `web/lib/marketplace/notifications.ts`):
    - `sendMarketplaceMessageNotification()` — Airbnb-style email:
      - TO: recipient email (resolve from profiles/auth.users)
      - SUBJECT: `New message about {eventName}`
      - BODY: Sender name, ~100 char message preview, event name + type, "Reply on SiteMedic" CTA button linking to `/marketplace/messages?conversation={id}` (or `/events/{eventId}#messages`)
      - Use same `FROM_ADDRESS` and Resend client pattern as existing notifications
      - Do NOT include full message content (prevent off-platform communication)

    **UI Components:**

    **MarketplaceInbox** (`web/components/marketplace/messaging/MarketplaceInbox.tsx`):
    - Two-panel layout (matching internal messaging pattern):
      - Left panel: Scrollable conversation list (MarketplaceConversationRow items)
      - Right panel: Active message thread (MarketplaceMessageThread)
    - Mobile: Single panel with back navigation
    - Shows "No conversations yet" empty state
    - 30-second polling for conversation list refresh (consistent with internal messaging before Realtime was added)

    **MarketplaceConversationRow** (`web/components/marketplace/messaging/MarketplaceConversationRow.tsx`):
    - Other party name (company name or client name)
    - Event name subtitle (smaller, gray text)
    - Last message preview (truncated)
    - Timestamp (relative: "2m ago", "Yesterday", etc.)
    - Unread count badge (blue dot or number badge)
    - Active/selected state highlighting

    **MarketplaceMessageThread** (`web/components/marketplace/messaging/MarketplaceMessageThread.tsx`):
    - Chat-style thread (flat layout, not chat bubbles — consistent with internal messaging)
    - Messages from current user right-aligned with blue background
    - Messages from other party left-aligned with gray background
    - Each message: sender name, content, timestamp
    - Auto-scroll to bottom on new messages
    - 10-second polling for new messages in active thread
    - Header: other party name + event name
    - On mount: calls mark-as-read API

    **MarketplaceMessageInput** (`web/components/marketplace/messaging/MarketplaceMessageInput.tsx`):
    - Text input with send button
    - Enter to send (consistent with internal messaging)
    - Shift+Enter for new line
    - Max 5000 chars with character count
    - Disabled state when sending

    **Marketplace Messages Page** (`web-marketplace/app/messages/page.tsx`):
    - Renders MarketplaceInbox as the main content
    - Page title: "Messages"
    - URL query param `?conversation=xxx` for deep linking from email

    **Event Detail Page Update** (`web-marketplace/app/events/[id]/page.tsx`):
    - Add "Messages" tab alongside existing tabs
    - For clients: Shows conversations with all companies who have messaged
    - For companies: Shows the single conversation for this event (create on first message)
    - Renders MarketplaceMessageThread inline
    - "Send a Message" button for companies that opens the thread and creates conversation if needed
  </action>
  <verify>
    - All API route files exist and export correct HTTP method handlers
    - All component files exist and export React components
    - TypeScript compiles: `cd web && npx tsc --noEmit --skipLibCheck 2>&1 | head -30`
    - `sendMarketplaceMessageNotification` function exists in notifications.ts
    - Messages page exists at web-marketplace/app/messages/page.tsx
  </verify>
  <done>
    Marketplace messaging works end-to-end: companies can message about events before/after quoting, clients can message companies who quoted. Central inbox lists all conversations. Chat-style threads with 10s polling. Airbnb-style email notifications with preview + CTA link. Event detail page has Messages tab.
  </done>
</task>

</tasks>

<verification>
1. Migration 153 creates all three tables with user_id-scoped RLS
2. Conversation creation enforces event+company uniqueness
3. Companies can start conversations pre-quote (verified company + open event)
4. Messages appear in real-time via polling (10s in thread, 30s for list)
5. Email notifications include sender name, preview, event context, reply link
6. Inbox shows conversations sorted by last_message_at DESC with unread badges
7. Event detail page has Messages tab with inline thread
8. TypeScript compilation succeeds
</verification>

<success_criteria>
- Marketplace conversations and messages stored in dedicated tables
- Both parties can send and receive messages through the platform
- No contact details exchanged before award + deposit
- Email notifications follow Airbnb pattern (preview, not full content)
- Central inbox and event-level access points both work
</success_criteria>

<output>
After completion, create `.planning/phases/36-ratings-messaging-disputes/36-02-SUMMARY.md`
</output>
