---
phase: 36-ratings-messaging-disputes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/154_marketplace_disputes.sql
  - web/lib/marketplace/dispute-types.ts
  - web/lib/marketplace/cancellation.ts
  - web/app/api/marketplace/events/[id]/dispute/route.ts
  - web/app/api/marketplace/events/[id]/cancel/route.ts
  - web/app/api/marketplace/disputes/[id]/resolve/route.ts
  - web/components/marketplace/disputes/DisputeForm.tsx
  - web/components/marketplace/disputes/DisputeDetail.tsx
  - web/components/marketplace/disputes/CancellationConfirmation.tsx
  - web-marketplace/app/events/[id]/page.tsx
  - web/app/(dashboard)/platform/disputes/page.tsx
  - web/lib/marketplace/notifications.ts
autonomous: true

must_haves:
  truths:
    - "Either party can raise a dispute after an event with a category, description, and optional evidence uploads"
    - "Filing a dispute immediately freezes the remainder payment until admin resolves it"
    - "Platform admin can review disputes and issue resolution (full refund, partial refund, dismiss, suspend)"
    - "Client cancellation follows tiered policy: >14 days = full deposit refund, 7-14 days = 50%, <7 days = full deposit retained"
    - "Cancellation confirmation step shows financial breakdown (deposit paid, tier, refund amount) before processing"
  artifacts:
    - path: "supabase/migrations/154_marketplace_disputes.sql"
      provides: "marketplace_disputes table, dispute-evidence storage bucket, remainder_hold column on bookings"
      contains: "marketplace_disputes"
    - path: "web/app/api/marketplace/events/[id]/cancel/route.ts"
      provides: "Marketplace cancellation API with tiered refund and Stripe refund"
      exports: ["POST"]
    - path: "web/app/api/marketplace/events/[id]/dispute/route.ts"
      provides: "Dispute filing API with remainder hold"
      exports: ["GET", "POST"]
    - path: "web/app/api/marketplace/disputes/[id]/resolve/route.ts"
      provides: "Admin dispute resolution API"
      exports: ["POST"]
    - path: "web/components/marketplace/disputes/CancellationConfirmation.tsx"
      provides: "Cancellation confirmation dialog with financial breakdown"
    - path: "web/app/(dashboard)/platform/disputes/page.tsx"
      provides: "Platform admin disputes queue"
  key_links:
    - from: "web/app/api/marketplace/events/[id]/dispute/route.ts"
      to: "bookings.remainder_hold"
      via: "Sets remainder_hold=true on related booking when dispute filed"
      pattern: "remainder_hold"
    - from: "web/app/api/marketplace/events/[id]/cancel/route.ts"
      to: "web/lib/marketplace/cancellation.ts"
      via: "calculateMarketplaceCancellationRefund function"
      pattern: "calculateMarketplaceCancellationRefund"
    - from: "web/app/api/marketplace/events/[id]/cancel/route.ts"
      to: "stripe.refunds.create"
      via: "Stripe refund on deposit PaymentIntent"
      pattern: "stripe.refunds.create"
---

<objective>
Implement dispute filing and resolution workflow, marketplace cancellation with tiered refund policy, and automatic remainder payment holds — completing the trust and safety infrastructure for the marketplace.

Purpose: Disputes protect both parties when things go wrong (no-shows, quality issues, billing problems). The cancellation policy with financial transparency (showing the breakdown before confirming) creates fair, predictable outcomes. Automatic remainder holds prevent payouts of disputed amounts. Admin resolution tools give the platform the ability to adjudicate fairly.

Output: Migration 154 for disputes table + evidence bucket + remainder_hold; dispute filing API + UI with evidence upload; admin dispute queue with resolution tools; marketplace cancellation API with tiered Stripe refunds; cancellation confirmation dialog showing financial breakdown.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@web/app/api/bookings/[id]/cancel/route.ts
@web/lib/marketplace/notifications.ts
@web/lib/marketplace/types.ts
@web/app/api/stripe/webhooks/route.ts
@supabase/functions/charge-remainder-payment/index.ts
@supabase/migrations/142_marketplace_storage_bucket.sql
@supabase/migrations/149_marketplace_award_payment.sql
@web/lib/marketplace/booking-bridge.ts
@web/lib/marketplace/award-calculations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration, storage bucket, and TypeScript types for disputes and cancellations</name>
  <files>
    supabase/migrations/154_marketplace_disputes.sql
    web/lib/marketplace/dispute-types.ts
    web/lib/marketplace/cancellation.ts
  </files>
  <action>
    **Migration 154** — Create disputes infrastructure:

    1. **`marketplace_disputes` table:**
       ```sql
       CREATE TABLE marketplace_disputes (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         event_id UUID NOT NULL REFERENCES marketplace_events(id) ON DELETE CASCADE,
         booking_id UUID REFERENCES bookings(id) ON DELETE SET NULL,
         filed_by UUID NOT NULL REFERENCES auth.users(id),
         filed_by_type TEXT NOT NULL CHECK (filed_by_type IN ('client', 'company')),

         -- Dispute details
         category TEXT NOT NULL CHECK (category IN (
           'no_show', 'late_cancellation', 'quality_issue',
           'billing_dispute', 'safety_concern'
         )),
         description TEXT NOT NULL,
         evidence_urls TEXT[] DEFAULT '{}',

         -- Resolution
         status TEXT NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'under_review', 'resolved')),
         resolution_type TEXT CHECK (resolution_type IN (
           'full_refund', 'partial_refund', 'dismissed', 'suspend_party'
         )),
         resolution_percent NUMERIC(5,2),  -- for partial_refund: admin sets %
         resolution_notes TEXT,
         resolved_by UUID REFERENCES auth.users(id),
         resolved_at TIMESTAMPTZ,

         -- Timestamps
         created_at TIMESTAMPTZ DEFAULT NOW(),
         updated_at TIMESTAMPTZ DEFAULT NOW()
       );
       ```

    2. **Add `remainder_hold` column to `bookings`:**
       ```sql
       ALTER TABLE bookings ADD COLUMN IF NOT EXISTS remainder_hold BOOLEAN DEFAULT FALSE;
       ALTER TABLE bookings ADD COLUMN IF NOT EXISTS remainder_hold_reason TEXT;
       ```
       This column is checked by the `charge-remainder-payment` Edge Function — held bookings are SKIPPED.

    3. **Add cancellation columns to `bookings`:**
       ```sql
       -- These may already exist from Phase 4 — use IF NOT EXISTS or check
       ALTER TABLE bookings ADD COLUMN IF NOT EXISTS marketplace_cancelled_at TIMESTAMPTZ;
       ALTER TABLE bookings ADD COLUMN IF NOT EXISTS marketplace_cancellation_reason TEXT;
       ALTER TABLE bookings ADD COLUMN IF NOT EXISTS marketplace_cancelled_by UUID REFERENCES auth.users(id);
       ALTER TABLE bookings ADD COLUMN IF NOT EXISTS marketplace_refund_amount NUMERIC(10,2);
       ALTER TABLE bookings ADD COLUMN IF NOT EXISTS marketplace_refund_percent NUMERIC(5,2);
       ```

    4. **RLS on `marketplace_disputes`:**
       - SELECT: `auth.uid() = filed_by` OR `auth.uid() IN (SELECT client_user_id FROM marketplace_conversations WHERE event_id = marketplace_disputes.event_id UNION SELECT company_user_id FROM marketplace_conversations WHERE event_id = marketplace_disputes.event_id)` — both parties of the event can view
       - Simpler approach: SELECT WHERE `auth.uid() = filed_by OR auth.uid() = (SELECT posted_by FROM marketplace_events WHERE id = event_id) OR auth.uid() IN (SELECT admin_user_id FROM marketplace_companies mc JOIN marketplace_quotes mq ON mc.id = mq.company_id WHERE mq.event_id = marketplace_disputes.event_id AND mq.status = 'awarded')`
       - INSERT: auth.uid() = filed_by
       - Platform admin: FOR ALL USING `is_platform_admin()`

    5. **`dispute-evidence` storage bucket:**
       ```sql
       INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
       VALUES (
         'dispute-evidence', 'dispute-evidence', false,
         10485760,  -- 10 MB
         ARRAY['application/pdf', 'image/jpeg', 'image/png', 'image/webp']
       );
       ```
       RLS: Upload allowed if dispute belongs to user. Download allowed if user is a party to the dispute OR platform admin.
       Path pattern: `{dispute_id}/{filename}`

    6. **Indexes:**
       - `idx_disputes_event ON marketplace_disputes(event_id)`
       - `idx_disputes_filed_by ON marketplace_disputes(filed_by)`
       - `idx_disputes_status ON marketplace_disputes(status) WHERE status != 'resolved'` (partial, for admin queue)
       - `idx_bookings_remainder_hold ON bookings(remainder_hold) WHERE remainder_hold = true` (partial, for cron)

    7. **Trigger:** `update_updated_at_column()` on marketplace_disputes

    **TypeScript types** (`web/lib/marketplace/dispute-types.ts`):
    - `DisputeCategory = 'no_show' | 'late_cancellation' | 'quality_issue' | 'billing_dispute' | 'safety_concern'`
    - `DisputeStatus = 'open' | 'under_review' | 'resolved'`
    - `ResolutionType = 'full_refund' | 'partial_refund' | 'dismissed' | 'suspend_party'`
    - `MarketplaceDispute` — mirrors table
    - `FileDisputeRequest = { event_id: string; category: DisputeCategory; description: string; evidence_files?: File[] }`
    - `ResolveDisputeRequest = { resolution_type: ResolutionType; resolution_percent?: number; resolution_notes: string }`
    - `DISPUTE_CATEGORY_LABELS: Record<DisputeCategory, string>` with human-readable labels
    - `CancellationReason = 'event_cancelled' | 'found_alternative' | 'budget_issue' | 'scheduling_conflict' | 'other'`
    - `CANCELLATION_REASON_LABELS: Record<CancellationReason, string>`
    - `CancellationBreakdown = { depositPaid: number; daysUntilEvent: number; tier: string; refundPercent: number; refundAmount: number; retainedAmount: number }`
    - `MarketplaceCancelRequest = { reason: CancellationReason; reason_detail?: string }`

    **Cancellation logic** (`web/lib/marketplace/cancellation.ts`):
    - `calculateMarketplaceCancellationRefund(depositPaid: number, eventStartDate: string): CancellationBreakdown`
      - Compute `daysUntilEvent` using `differenceInDays` from date-fns
      - Tier: >14 days = 100% refund, 7-14 days = 50% refund, <7 days = 0% refund
      - Return breakdown: depositPaid, daysUntilEvent, tier label, refundPercent, refundAmount, retainedAmount
    - `calculateCompanyCancellationRefund(depositPaid: number): CancellationBreakdown`
      - Company cancellation = always 100% refund to client
  </action>
  <verify>
    - Migration file exists at `supabase/migrations/154_marketplace_disputes.sql`
    - TypeScript types compile: `cd web && npx tsc --noEmit --skipLibCheck 2>&1 | head -30`
    - cancellation.ts exports `calculateMarketplaceCancellationRefund`
    - SQL contains CREATE TABLE marketplace_disputes, dispute-evidence bucket, remainder_hold column
  </verify>
  <done>
    Migration 154 creates marketplace_disputes table with RLS, dispute-evidence storage bucket, remainder_hold column on bookings, cancellation columns. TypeScript types cover disputes, cancellations, and resolution. Cancellation calculation logic handles both client (tiered) and company (full refund) scenarios.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dispute and cancellation API routes and UI</name>
  <files>
    web/app/api/marketplace/events/[id]/dispute/route.ts
    web/app/api/marketplace/events/[id]/cancel/route.ts
    web/app/api/marketplace/disputes/[id]/resolve/route.ts
    web/components/marketplace/disputes/DisputeForm.tsx
    web/components/marketplace/disputes/DisputeDetail.tsx
    web/components/marketplace/disputes/CancellationConfirmation.tsx
    web-marketplace/app/events/[id]/page.tsx
    web/app/(dashboard)/platform/disputes/page.tsx
    web/lib/marketplace/notifications.ts
  </files>
  <action>
    **API Routes:**

    **GET/POST `/api/marketplace/events/[id]/dispute`:**
    - **GET**: Fetch dispute(s) for an event.
      - Auth: must be event poster, awarded company admin, or platform admin
      - Return existing disputes for the event with evidence_urls

    - **POST**: File a new dispute.
      - Auth: must be event poster (client) OR awarded company admin
      - Body: `{ category, description }` — validated with Zod
      - Determine `filed_by_type` from user role (same logic as ratings rater_type)
      - Find related booking: `bookings WHERE marketplace_event_id = eventId AND source = 'marketplace'`
      - **Immediately set `remainder_hold = true`** on ALL related bookings: UPDATE bookings SET remainder_hold = true, remainder_hold_reason = 'dispute:{dispute_id}' WHERE marketplace_event_id = eventId
      - Handle evidence file uploads: If files included (multipart form), upload to `dispute-evidence/{disputeId}/{filename}` bucket, store URLs in `evidence_urls` array
      - Event must be in status 'completed' or 'in_progress' or 'confirmed' (cannot dispute draft/open/cancelled events)
      - Fire-and-forget: email notification to other party + platform admin about new dispute

    **POST `/api/marketplace/events/[id]/cancel`:**
    - Auth: Must be the event poster (client) OR awarded company admin
    - Body: `{ reason: CancellationReason, reason_detail?: string }`
    - Determine canceller type: client or company
    - **For client cancellation:**
      - Find bookings for this event: `bookings WHERE marketplace_event_id = eventId AND source = 'marketplace' AND status IN ('pending', 'confirmed')`
      - Calculate refund using `calculateMarketplaceCancellationRefund(booking.deposit_amount, eventStartDate)`
      - **Stripe refund**: If refundAmount > 0, refund on the deposit PaymentIntent (`booking.deposit_payment_intent_id`). Use partial refund amount (pence).
      - Update bookings: status = 'cancelled', marketplace_cancelled_at, marketplace_cancellation_reason, marketplace_cancelled_by, marketplace_refund_amount, marketplace_refund_percent
      - Update marketplace_events: status = 'cancelled'
      - Cancel any pending remainder charge by setting remainder_due_at to NULL or far-future
      - Release medic commitments: DELETE from medic_commitments WHERE booking_id IN (cancelled booking IDs)
    - **For company cancellation:**
      - Always full refund to client
      - Same booking cancellation flow but refundPercent = 100
      - Company can propose rescheduling via marketplace messaging first (this is UX guidance, not enforced)
    - Fire-and-forget: email notifications to both parties

    **POST `/api/marketplace/disputes/[id]/resolve`:**
    - Auth: Platform admin only (`is_platform_admin()` check)
    - Body: `{ resolution_type, resolution_percent?, resolution_notes }`
    - Update dispute: status = 'resolved', resolution fields, resolved_by, resolved_at
    - **Process resolution:**
      - `full_refund`: Refund full deposit via Stripe, cancel remainder, update booking status
      - `partial_refund`: Refund (resolution_percent / 100 * deposit_amount) via Stripe, adjust remainder proportionally
      - `dismissed`: Release remainder hold (SET remainder_hold = false), company keeps full payment
      - `suspend_party`: Flag the user account (out of scope for now — just log and set resolution)
    - Release remainder hold on bookings: UPDATE bookings SET remainder_hold = false WHERE marketplace_event_id = dispute.event_id
    - Fire-and-forget: email notifications to both parties about resolution

    **UI Components:**

    **DisputeForm** (`web/components/marketplace/disputes/DisputeForm.tsx`):
    - Category selector: Radio buttons or dropdown with 5 categories (No-show, Late cancellation, Quality issue, Billing dispute, Safety concern)
    - Description textarea (required, max 5000 chars)
    - Evidence upload: Drag-and-drop zone accepting PDF/JPEG/PNG (max 10MB per file, max 5 files)
    - Warning callout: "Filing a dispute will hold any remaining payment until resolved"
    - Submit button with loading state
    - Submits to POST `/api/marketplace/events/[id]/dispute`

    **DisputeDetail** (`web/components/marketplace/disputes/DisputeDetail.tsx`):
    - Shows dispute status badge (open=yellow, under_review=blue, resolved=green)
    - Category, description, filed by, date filed
    - Evidence section: Thumbnails for images, download links for PDFs
    - Timeline: Filed → Under Review → Resolved (with dates)
    - Resolution section (if resolved): Resolution type, notes, refund amount
    - Admin actions (if platform admin): "Mark Under Review" button, resolution form (dropdown for type, % input for partial, notes textarea)

    **CancellationConfirmation** (`web/components/marketplace/disputes/CancellationConfirmation.tsx`):
    - Props: `eventId`, `onConfirm`, `onCancel`
    - On mount: Calls a preview endpoint or computes locally using `calculateMarketplaceCancellationRefund`
    - Shows financial breakdown:
      - "Deposit paid: GBP X.XX"
      - "Days until event: N"
      - "Cancellation tier: [>14 days / 7-14 days / <7 days]"
      - Tier explanation text
      - "Refund amount: GBP X.XX (Y%)"
      - "Retained by company: GBP Z.ZZ"
    - Cancellation reason: Dropdown (Event cancelled, Found alternative, Budget issue, Scheduling conflict, Other) with optional detail text
    - Warning: Red callout for <7 days tier ("No refund will be issued")
    - Two buttons: "Cancel Event" (red, destructive) and "Go Back" (gray)
    - Confirmation step: After clicking "Cancel Event", show a final "Are you sure?" alert with the refund summary

    **Event Detail Page Update** (`web-marketplace/app/events/[id]/page.tsx`):
    - Add "Raise Dispute" button (visible only when event status is 'completed' or 'in_progress' and user is client or awarded company)
    - Add "Cancel Event" button (visible when event is 'awarded' or 'confirmed' and user is client or awarded company)
    - Clicking "Raise Dispute" opens DisputeForm in a modal/dialog
    - Clicking "Cancel Event" opens CancellationConfirmation in a modal/dialog
    - If dispute exists, show DisputeDetail instead of "Raise Dispute" button

    **Platform Admin Disputes Queue** (`web/app/(dashboard)/platform/disputes/page.tsx`):
    - Table listing all open/under_review disputes
    - Columns: Event name, Filed by, Category, Status, Date filed, Days open
    - Click row to navigate to dispute detail (inline or separate page)
    - Filter: by status (open, under_review, resolved, all)
    - Sort: by date filed (newest first)
    - Uses existing platform admin layout (`web/app/(dashboard)/platform/layout.tsx`)

    **Email Notifications** (add to `web/lib/marketplace/notifications.ts`):
    - `sendDisputeFiledNotification()`: Notify other party + admin that a dispute was filed
    - `sendDisputeResolvedNotification()`: Notify both parties of resolution outcome
    - `sendCancellationNotification()`: Notify both parties of cancellation with refund details
    - All follow existing pattern: FROM_ADDRESS, Resend client, try/catch, non-blocking
  </action>
  <verify>
    - All API route files exist and export correct HTTP method handlers
    - All component files exist and export React components
    - TypeScript compiles: `cd web && npx tsc --noEmit --skipLibCheck 2>&1 | head -30`
    - Dispute API sets remainder_hold = true (grep for 'remainder_hold')
    - Cancellation API calls Stripe refund (grep for 'stripe.refunds.create')
    - CancellationConfirmation shows financial breakdown (grep for 'refundAmount')
    - Platform disputes page exists at web/app/(dashboard)/platform/disputes/page.tsx
  </verify>
  <done>
    Disputes can be filed with category, description, and evidence. Filing auto-holds remainder payment. Admin can resolve disputes with 4 outcome types. Marketplace cancellation follows tiered refund policy (>14d=100%, 7-14d=50%, <7d=0%) with Stripe refund processing. Cancellation confirmation shows full financial breakdown before processing. Admin disputes queue provides platform-level dispute management.
  </done>
</task>

</tasks>

<verification>
1. Migration 154 creates marketplace_disputes, dispute-evidence bucket, and remainder_hold column
2. Filing a dispute sets remainder_hold=true on related bookings
3. Cancellation API calculates correct refund tier and processes Stripe refund
4. CancellationConfirmation dialog shows deposit, tier, refund amount, and retained amount
5. Admin disputes queue lists open disputes with resolution workflow
6. Admin resolution releases remainder hold and processes appropriate refund
7. Company cancellation always refunds 100% of deposit
8. Email notifications sent for dispute filed, resolved, and cancellation
9. TypeScript compilation succeeds
</verification>

<success_criteria>
- Disputes can be filed, held, and resolved by admin
- Remainder payment automatically held when dispute filed
- Marketplace cancellation enforces tiered refund policy
- Financial breakdown shown to user before confirming cancellation
- Stripe refund processed automatically based on tier
- Admin has queue to manage and resolve disputes
</success_criteria>

<output>
After completion, create `.planning/phases/36-ratings-messaging-disputes/36-03-SUMMARY.md`
</output>
