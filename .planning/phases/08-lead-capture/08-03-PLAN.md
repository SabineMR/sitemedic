---
phase: 08-lead-capture
plan: 08-03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - web/lib/queries/admin/submissions.ts
  - web/components/admin/contact-submissions-table.tsx
  - web/components/admin/quote-submissions-table.tsx
  - web/app/admin/submissions/page.tsx
  - web/app/admin/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin/submissions from the sidebar"
    - "Submissions page has two tabs: Contact and Quotes"
    - "Contact submissions table shows name, company, email, enquiry type, status, date"
    - "Quote submissions table shows quote ref, name, project type, medic count, status, actions"
    - "Admin can change lead status inline via dropdown (new/contacted/converted/closed)"
    - "Data refreshes via 60-second polling (near real-time)"
    - "Quote table has a Convert to Booking button that navigates to /admin/bookings/new with pre-fill params"
  artifacts:
    - path: "web/lib/queries/admin/submissions.ts"
      provides: "TanStack Query hooks for both submission tables"
      exports: ["useContactSubmissions", "useQuoteSubmissions", "useUpdateSubmissionStatus"]
    - path: "web/components/admin/contact-submissions-table.tsx"
      provides: "Filterable contact submissions table component"
      contains: "ContactSubmissionsTable"
    - path: "web/components/admin/quote-submissions-table.tsx"
      provides: "Filterable quote submissions table with Convert to Booking button"
      contains: "QuoteSubmissionsTable"
    - path: "web/app/admin/submissions/page.tsx"
      provides: "Admin submissions page with tab switcher"
      contains: "SubmissionsPage"
    - path: "web/app/admin/layout.tsx"
      provides: "Sidebar nav item for Leads"
      contains: "Leads"
  key_links:
    - from: "web/app/admin/submissions/page.tsx"
      to: "web/components/admin/contact-submissions-table.tsx"
      via: "import and render"
      pattern: "ContactSubmissionsTable"
    - from: "web/components/admin/contact-submissions-table.tsx"
      to: "web/lib/queries/admin/submissions.ts"
      via: "useContactSubmissions hook"
      pattern: "useContactSubmissions"
    - from: "web/components/admin/quote-submissions-table.tsx"
      to: "/admin/bookings/new"
      via: "router.push with URLSearchParams"
      pattern: "admin/bookings/new"
---

<objective>
Build the admin submissions page at `/admin/submissions` with two-tab UI for contact and quote leads, including TanStack Query hooks, filterable tables, inline status updates, and sidebar navigation.

Purpose: Admins need to see and manage every lead that comes in. This is the CRM view that makes lead capture actionable.
Output: 5 files — query hooks, 2 table components, page shell, and updated sidebar nav.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lead-capture/08-RESEARCH.md

Key references:
- Admin page pattern: `web/app/admin/customers/page.tsx` (page shell with header)
- Table component pattern: `web/components/admin/client-management-table.tsx` (plain HTML table, useMemo filtering, useState for filter state)
- Query hook pattern: `web/lib/queries/admin/bookings.ts` (useQuery with 60s polling, useRequireOrg, useMutation with onSettled invalidation)
- Sidebar nav: `web/app/admin/layout.tsx` (navItems array, Lucide icons, badge support)
- Dark theme: bg-gray-900, bg-gray-800/50, text-white, border-gray-700/50
</context>

<tasks>

<task id="08-03-T1" type="auto">
  <name>Create TanStack Query hooks for submissions</name>
  <files>web/lib/queries/admin/submissions.ts</files>
  <action>
Create `web/lib/queries/admin/submissions.ts` following the exact pattern from `web/lib/queries/admin/bookings.ts`.

```typescript
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { createClient } from '@/lib/supabase/client';
import { useRequireOrg } from '@/contexts/org-context';
```

**Types to define:**

```typescript
export interface ContactSubmission {
  id: string;
  org_id: string;
  first_name: string;
  last_name: string;
  company: string;
  email: string;
  phone: string | null;
  site_size: string | null;
  enquiry_type: string;
  message: string | null;
  status: 'new' | 'contacted' | 'converted' | 'closed';
  follow_up_notes: string | null;
  created_at: string;
  updated_at: string;
}

export interface QuoteSubmission {
  id: string;
  org_id: string;
  quote_ref: string;
  name: string;
  email: string;
  phone: string;
  company: string | null;
  worker_count: string | null;
  project_type: string | null;
  medic_count: string | null;
  duration_known: string | null;
  estimated_duration: string | null;
  site_address: string | null;
  coordinates: string | null;
  what3words_address: string | null;
  start_date: string | null;
  end_date: string | null;
  project_phase: string | null;
  special_requirements: string[] | null;
  calculated_price: number | null;
  status: 'new' | 'contacted' | 'converted' | 'closed';
  follow_up_notes: string | null;
  converted_booking_id: string | null;
  created_at: string;
  updated_at: string;
}
```

**Hooks to implement:**

1. `useContactSubmissions()`:
   - Uses `useRequireOrg()` to get orgId
   - queryKey: `['contact-submissions', orgId]`
   - Fetches from `contact_submissions` table, `.eq('org_id', orgId)`, `.order('created_at', { ascending: false })`
   - `refetchInterval: 60_000` (60-second polling)

2. `useQuoteSubmissions()`:
   - Same pattern as above
   - queryKey: `['quote-submissions', orgId]`
   - Fetches from `quote_submissions` table

3. `useUpdateSubmissionStatus()`:
   - Uses `useMutation` with `useQueryClient` for invalidation
   - mutationFn accepts `{ id: string; status: 'new' | 'contacted' | 'converted' | 'closed'; table: 'contact_submissions' | 'quote_submissions'; followUpNotes?: string }`
   - Updates `status` AND `updated_at: new Date().toISOString()` on the given table
   - If `followUpNotes` is provided, also update `follow_up_notes`
   - `.eq('id', id).eq('org_id', orgId)` (defense in depth)
   - `onSettled`: invalidate both `['contact-submissions', orgId]` and `['quote-submissions', orgId]`

Follow the exact import paths and patterns from `bookings.ts`. Use `createClient` from `@/lib/supabase/client` (NOT from `@supabase/supabase-js`).
  </action>
  <verify>
1. `grep "useContactSubmissions" web/lib/queries/admin/submissions.ts` — exported
2. `grep "useQuoteSubmissions" web/lib/queries/admin/submissions.ts` — exported
3. `grep "useUpdateSubmissionStatus" web/lib/queries/admin/submissions.ts` — exported
4. `grep "refetchInterval: 60_000" web/lib/queries/admin/submissions.ts` — 60s polling configured
5. `grep "updated_at" web/lib/queries/admin/submissions.ts` — manual updated_at in mutation
  </verify>
  <done>Three hooks exported: useContactSubmissions (60s polling), useQuoteSubmissions (60s polling), useUpdateSubmissionStatus (mutation with invalidation). All org-scoped via useRequireOrg.</done>
</task>

<task id="08-03-T2" type="auto">
  <name>Create contact and quote table components, page shell, and sidebar nav</name>
  <files>
    web/components/admin/contact-submissions-table.tsx
    web/components/admin/quote-submissions-table.tsx
    web/app/admin/submissions/page.tsx
    web/app/admin/layout.tsx
  </files>
  <action>
**File 1: `web/components/admin/contact-submissions-table.tsx`**

Create a client component following the exact pattern from `client-management-table.tsx`:

```typescript
'use client';

import { useState, useMemo } from 'react';
import { useContactSubmissions, useUpdateSubmissionStatus } from '@/lib/queries/admin/submissions';
import type { ContactSubmission } from '@/lib/queries/admin/submissions';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Search } from 'lucide-react';
```

Features:
- Props: none (fetches data via hook internally, same as ClientManagementTable)
- Search input that filters on first_name, last_name, email, company (client-side via useMemo)
- Status filter dropdown: All / New / Contacted / Converted / Closed
- Plain HTML `<table>` (NOT @tanstack/react-table) with Tailwind dark theme classes
- Columns: Name (first + last), Company, Email, Phone, Enquiry Type, Site Size, Status, Date
- Status badge with colors: new=`bg-blue-500/20 text-blue-300`, contacted=`bg-yellow-500/20 text-yellow-300`, converted=`bg-green-500/20 text-green-300`, closed=`bg-gray-500/20 text-gray-400`
- Inline status change via shadcn Select dropdown in the Status column (calls useUpdateSubmissionStatus mutation)
- Date formatted as DD/MM/YYYY using `new Date(created_at).toLocaleDateString('en-GB')`
- Loading state: "Loading submissions..." text
- Empty state: "No contact submissions found" centered text
- Table styling: `bg-gray-800/50 backdrop-blur-xl rounded-xl border border-gray-700/50` for the wrapper, `text-gray-300` for body cells, `text-gray-400 text-xs uppercase` for headers

**File 2: `web/components/admin/quote-submissions-table.tsx`**

Same structure as contact table but with quote-specific columns and the Convert to Booking button:

```typescript
'use client';

import { useState, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { useQuoteSubmissions, useUpdateSubmissionStatus } from '@/lib/queries/admin/submissions';
import type { QuoteSubmission } from '@/lib/queries/admin/submissions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Search, ArrowRight } from 'lucide-react';
```

Features:
- Same search/filter pattern as contact table (filters on name, email, company, quote_ref)
- Columns: Quote Ref, Name, Company, Project Type, Medics, Site Address, Start Date, Status, Actions
- Same status badge colors and inline status change
- "Convert to Booking" button in Actions column (only visible when status is NOT 'closed'):
  ```typescript
  function handleConvertToBooking(quote: QuoteSubmission) {
    const params = new URLSearchParams();
    if (quote.email) params.set('clientEmail', quote.email);
    if (quote.site_address) params.set('siteAddress', quote.site_address);
    if (quote.start_date) params.set('shiftDate', quote.start_date);
    if (quote.special_requirements?.includes('confined-space')) params.set('confinedSpace', '1');
    if (quote.special_requirements?.includes('trauma-specialist')) params.set('traumaSpecialist', '1');
    params.set('specialNotes', `Converted from quote ${quote.quote_ref}`);
    router.push(`/admin/bookings/new?${params.toString()}`);
  }
  ```
- Button styled as small: `<Button variant="outline" size="sm" className="border-blue-500/50 text-blue-300 hover:bg-blue-500/20">`
- Start Date formatted as DD/MM/YYYY or "—" if null

**File 3: `web/app/admin/submissions/page.tsx`**

Page shell following the exact pattern from `web/app/admin/customers/page.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { Inbox } from 'lucide-react';
import { ContactSubmissionsTable } from '@/components/admin/contact-submissions-table';
import { QuoteSubmissionsTable } from '@/components/admin/quote-submissions-table';
```

Structure:
- Same bg-gradient, header with backdrop-blur pattern as customers page
- Header: Inbox icon (blue-400) + "Leads" title + "Manage contact enquiries and quote requests" subtitle
- Tab switcher below header: two buttons for "Contact Enquiries" and "Quote Requests"
  - Active tab: `bg-blue-600 text-white`
  - Inactive tab: `bg-gray-700/50 text-gray-300 hover:bg-gray-700`
  - Tab container: `flex gap-2 mb-6`
- `useState<'contact' | 'quotes'>('contact')` for tab state
- Conditionally render `<ContactSubmissionsTable />` or `<QuoteSubmissionsTable />` based on active tab
- Wrapper: `<div className="p-8">`

**File 4: Modify `web/app/admin/layout.tsx`**

Add "Leads" nav item to the navItems array:

1. Add `Inbox` to the lucide-react import (line ~17-34):
   ```typescript
   import {
     LayoutDashboard,
     MapPin,
     Map,
     Calendar,
     ClipboardList,
     Clock,
     Users,
     Building2,
     TrendingUp,
     Settings,
     Banknote,
     RefreshCw,
     Crosshair,
     AlertOctagon,
     Shield,
     Bluetooth,
     Inbox,        // ADD THIS
   } from 'lucide-react';
   ```

2. Add the "Leads" nav item AFTER "Customers" (after the `Building2` item at line ~168) and BEFORE "Shift Swaps":
   ```typescript
   {
     name: 'Leads',
     href: '/admin/submissions',
     icon: <Inbox className="w-5 h-5" />,
   },
   ```

Do NOT add a badge to the Leads nav item (no count query in sidebar — keep it simple).
  </action>
  <verify>
1. `grep "ContactSubmissionsTable" web/components/admin/contact-submissions-table.tsx` — component exists
2. `grep "QuoteSubmissionsTable" web/components/admin/quote-submissions-table.tsx` — component exists
3. `grep "handleConvertToBooking\|Convert to Booking" web/components/admin/quote-submissions-table.tsx` — conversion button exists
4. `grep "admin/bookings/new" web/components/admin/quote-submissions-table.tsx` — correct navigation target
5. `grep "SubmissionsPage\|submissions" web/app/admin/submissions/page.tsx` — page exists
6. `grep "Inbox" web/app/admin/layout.tsx` — icon imported
7. `grep "Leads" web/app/admin/layout.tsx` — nav item added
8. `grep "admin/submissions" web/app/admin/layout.tsx` — correct href
9. Run `pnpm --filter web build 2>&1 | tail -10` to confirm no compilation errors
  </verify>
  <done>
  Contact submissions table renders with search, status filter, inline status change, and date formatting.
  Quote submissions table has same features plus "Convert to Booking" button that navigates to /admin/bookings/new with URL params.
  Submissions page has Contact/Quotes tab switcher.
  Sidebar has "Leads" nav item with Inbox icon between Customers and Shift Swaps.
  </done>
</task>

</tasks>

<verification>
1. All 5 files exist and compile without errors (`pnpm --filter web build`)
2. Query hooks use `useRequireOrg()` for org-scoped data access
3. Both tables use plain HTML `<table>` elements (NOT @tanstack/react-table)
4. Status badges use correct color mapping (blue/yellow/green/gray)
5. Quote table "Convert to Booking" button builds URLSearchParams correctly
6. Sidebar nav has "Leads" item with Inbox icon pointing to /admin/submissions
7. Tab switcher toggles between contact and quote views
</verification>

<success_criteria>
- Admin can navigate to /admin/submissions via sidebar "Leads" link
- Contact tab shows all contact submissions with search and status filter
- Quotes tab shows all quote submissions with search and status filter
- Admin can change any lead's status inline via dropdown
- "Convert to Booking" button on quotes navigates to /admin/bookings/new with correct URL params
- Data auto-refreshes every 60 seconds
- All UI follows dark theme with existing admin page patterns
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-capture/08-03-SUMMARY.md`
</output>
