---
phase: 08-lead-capture
plan: 08-04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - web/app/admin/bookings/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Navigating to /admin/bookings/new?clientEmail=test@co.uk&siteAddress=123+Main+St pre-fills those fields"
    - "Navigating to /admin/bookings/new with no params shows empty form (no regression)"
    - "confinedSpace=1 param checks the confined space checkbox"
    - "specialNotes param pre-fills the notes textarea"
    - "shiftDate param pre-fills the date picker"
  artifacts:
    - path: "web/app/admin/bookings/new/page.tsx"
      provides: "Booking form with URL search params pre-fill support"
      contains: "useSearchParams"
  key_links:
    - from: "web/components/admin/quote-submissions-table.tsx"
      to: "web/app/admin/bookings/new/page.tsx"
      via: "router.push with URLSearchParams"
      pattern: "clientEmail.*siteAddress"
    - from: "web/app/admin/bookings/new/page.tsx"
      to: "useSearchParams"
      via: "reads params on mount to seed form state"
      pattern: "searchParams\\.get"
---

<objective>
Enable the new booking form to accept URL search params for pre-filling, completing the quote-to-booking conversion flow.

Purpose: When an admin clicks "Convert to Booking" on a quote, the booking form opens with client email, site address, date, and special requirements already filled in. This saves time and reduces data entry errors.
Output: Modified `/admin/bookings/new/page.tsx` with useSearchParams pre-fill logic.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lead-capture/08-RESEARCH.md

Key references:
- Current file: `web/app/admin/bookings/new/page.tsx` (307 lines, useState form, no useSearchParams)
- The "Convert to Booking" button in `quote-submissions-table.tsx` (created in 08-03) builds URL with params: clientEmail, siteAddress, shiftDate, confinedSpace, traumaSpecialist, specialNotes
- Next.js App Router requires Suspense boundary for useSearchParams in client components
</context>

<tasks>

<task id="08-04-T1" type="auto">
  <name>Add useSearchParams pre-fill to new booking page</name>
  <files>web/app/admin/bookings/new/page.tsx</files>
  <action>
Modify `web/app/admin/bookings/new/page.tsx` to read URL search params on mount and seed the form state.

**Step 1: Add imports**

Add `useSearchParams` to the existing `next/navigation` import and add `Suspense` from React:

```typescript
import { useState, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
```

**Step 2: Extract the form into an inner component**

Next.js App Router requires a `Suspense` boundary around components that use `useSearchParams`. Wrap the existing page content:

Rename the current `NewBookingPage` function to `NewBookingForm`.

Create a new default export that wraps it in Suspense:

```typescript
export default function NewBookingPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800 flex items-center justify-center">
        <p className="text-gray-400">Loading...</p>
      </div>
    }>
      <NewBookingForm />
    </Suspense>
  );
}
```

**Step 3: Read search params and seed form state**

Inside `NewBookingForm` (the renamed function), add `useSearchParams` and modify the initial form state:

```typescript
function NewBookingForm() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [form, setForm] = useState({
    clientEmail: searchParams.get('clientEmail') ?? '',
    siteName: '',
    siteAddress: searchParams.get('siteAddress') ?? '',
    sitePostcode: '',
    siteContactName: '',
    siteContactPhone: '',
    shiftDate: searchParams.get('shiftDate') ?? '',
    shiftStartTime: '07:00',
    shiftEndTime: '19:00',
    qualification: 'paramedic',
    confinedSpace: searchParams.get('confinedSpace') === '1',
    traumaSpecialist: searchParams.get('traumaSpecialist') === '1',
    specialNotes: searchParams.get('specialNotes') ?? '',
  });

  // ... rest of the component unchanged
```

**Key mapping from URL params to form fields:**
- `clientEmail` -> `form.clientEmail` (string)
- `siteAddress` -> `form.siteAddress` (string)
- `shiftDate` -> `form.shiftDate` (ISO date string, e.g., '2026-03-01')
- `confinedSpace` -> `form.confinedSpace` (boolean, '1' = true)
- `traumaSpecialist` -> `form.traumaSpecialist` (boolean, '1' = true)
- `specialNotes` -> `form.specialNotes` (string, e.g., 'Converted from quote QT-AB12')

**Fields that are NOT pre-filled** (admin fills manually):
- `siteName` — quote does not capture this
- `sitePostcode` — not in quote data
- `siteContactName` / `siteContactPhone` — not in quote data
- `shiftStartTime` / `shiftEndTime` — defaults remain 07:00/19:00
- `qualification` — default remains 'paramedic'

**Do NOT change:**
- The form JSX/layout
- The handleSubmit function
- The SHIFT_TIMES constant
- Any styling or classes
- The existing imports (except adding useSearchParams and Suspense)
  </action>
  <verify>
1. `grep "useSearchParams" web/app/admin/bookings/new/page.tsx` — imported and used
2. `grep "Suspense" web/app/admin/bookings/new/page.tsx` — Suspense boundary present
3. `grep "searchParams.get('clientEmail')" web/app/admin/bookings/new/page.tsx` — pre-fill logic exists
4. `grep "searchParams.get('confinedSpace') === '1'" web/app/admin/bookings/new/page.tsx` — boolean conversion works
5. `grep "NewBookingForm" web/app/admin/bookings/new/page.tsx` — inner component exists
6. `grep "export default function NewBookingPage" web/app/admin/bookings/new/page.tsx` — wrapper exports correctly
7. Run `pnpm --filter web build 2>&1 | tail -10` to confirm no compilation errors
  </verify>
  <done>
  New booking form reads URL search params on mount.
  clientEmail, siteAddress, shiftDate, confinedSpace, traumaSpecialist, and specialNotes are pre-filled from URL params.
  When no params are present, form shows empty defaults (no regression).
  Suspense boundary wraps useSearchParams usage per Next.js App Router requirement.
  </done>
</task>

</tasks>

<verification>
1. File compiles without errors (`pnpm --filter web build`)
2. `useSearchParams` is imported from `next/navigation`
3. `Suspense` boundary wraps the form component
4. All 6 URL params are read: clientEmail, siteAddress, shiftDate, confinedSpace, traumaSpecialist, specialNotes
5. Boolean params (confinedSpace, traumaSpecialist) use `=== '1'` comparison
6. Default values are preserved for fields without params (no regression)
</verification>

<success_criteria>
- Navigating to `/admin/bookings/new?clientEmail=test@co.uk` pre-fills the email field
- Navigating to `/admin/bookings/new?confinedSpace=1` checks the confined space checkbox
- Navigating to `/admin/bookings/new` (no params) shows the empty form exactly as before
- The full conversion flow works: Quote table "Convert to Booking" -> navigates to pre-filled booking form
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-capture/08-04-SUMMARY.md`
</output>
