---
phase: 08-lead-capture
plan: 08-01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/115_lead_capture_tables.sql
  - web/.env.local.example
autonomous: true

must_haves:
  truths:
    - "contact_submissions table exists with all required columns and constraints"
    - "quote_submissions table exists with all required columns including TEXT[] for special_requirements"
    - "RLS is enabled on both tables with org-scoped SELECT + UPDATE policies"
    - "Platform admin has full CRUD access to both tables via is_platform_admin() policies"
    - "No anon INSERT policy exists — service role is the insert mechanism for public routes"
  artifacts:
    - path: "supabase/migrations/115_lead_capture_tables.sql"
      provides: "Both lead capture tables, indexes, RLS policies, platform admin policies"
      contains: "CREATE TABLE contact_submissions"
    - path: "web/.env.local.example"
      provides: "Documentation of new env vars needed"
      contains: "SUPABASE_SERVICE_ROLE_KEY"
  key_links:
    - from: "contact_submissions"
      to: "organizations"
      via: "org_id FK with ON DELETE CASCADE"
      pattern: "REFERENCES organizations"
    - from: "quote_submissions"
      to: "bookings"
      via: "converted_booking_id FK with ON DELETE SET NULL"
      pattern: "REFERENCES bookings"
---

<objective>
Create the `contact_submissions` and `quote_submissions` database tables with full schema, indexes, and RLS policies.

Purpose: These tables are the persistence layer that all subsequent plans depend on. Without them, API routes cannot write and admin pages cannot read.
Output: A single migration file `115_lead_capture_tables.sql` that creates both tables, all indexes, and all RLS policies.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-lead-capture/08-RESEARCH.md

Key references:
- Existing RLS pattern: `supabase/migrations/028_enable_org_rls.sql` (org-scoped SELECT/UPDATE using get_user_org_id())
- Platform admin pattern: `supabase/migrations/112_complete_platform_admin_rls.sql` (4 policies per table using is_platform_admin())
- Migration numbering: highest is 114, so next is 115
- UUID extension already enabled in earlier migrations (uuid_generate_v4() available)
</context>

<tasks>

<task id="08-01-T1" type="auto">
  <name>Create migration file with both tables, indexes, and RLS policies</name>
  <files>supabase/migrations/115_lead_capture_tables.sql</files>
  <action>
Create `supabase/migrations/115_lead_capture_tables.sql` with the following exact structure:

**1. contact_submissions table:**
```sql
CREATE TABLE contact_submissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  company TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  site_size TEXT,
  enquiry_type TEXT NOT NULL,
  message TEXT,
  status TEXT NOT NULL DEFAULT 'new'
    CHECK (status IN ('new', 'contacted', 'converted', 'closed')),
  follow_up_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

Indexes for contact_submissions:
- `idx_contact_submissions_org` on (org_id)
- `idx_contact_submissions_status` on (status)
- `idx_contact_submissions_created` on (created_at DESC)

**2. quote_submissions table:**
```sql
CREATE TABLE quote_submissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  quote_ref TEXT NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT NOT NULL,
  company TEXT,
  worker_count TEXT,
  project_type TEXT,
  medic_count TEXT,
  duration_known TEXT,
  estimated_duration TEXT,
  site_address TEXT,
  coordinates TEXT,
  what3words_address TEXT,
  start_date DATE,
  end_date DATE,
  project_phase TEXT,
  special_requirements TEXT[],
  calculated_price NUMERIC(10,2),
  status TEXT NOT NULL DEFAULT 'new'
    CHECK (status IN ('new', 'contacted', 'converted', 'closed')),
  follow_up_notes TEXT,
  converted_booking_id UUID REFERENCES bookings(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

Indexes for quote_submissions:
- `idx_quote_submissions_org` on (org_id)
- `idx_quote_submissions_status` on (status)
- `idx_quote_submissions_created` on (created_at DESC)
- `idx_quote_submissions_ref` on (quote_ref)

**3. RLS — Enable + org-scoped policies for both tables:**

For EACH table (contact_submissions AND quote_submissions):
- `ALTER TABLE {table} ENABLE ROW LEVEL SECURITY;`
- SELECT policy: `USING (org_id = get_user_org_id())`
- UPDATE policy: `USING (org_id = get_user_org_id())` with `WITH CHECK (org_id = get_user_org_id())`
- NO INSERT policy (service role bypasses RLS for public route inserts)
- NO DELETE policy (leads should not be deletable by org users)

**4. Platform admin policies for both tables (4 per table, 8 total):**

Follow the exact pattern from migration 112. For EACH table:
- SELECT: `USING (is_platform_admin())`
- INSERT: `WITH CHECK (is_platform_admin())`
- UPDATE: `USING (is_platform_admin()) WITH CHECK (is_platform_admin())`
- DELETE: `USING (is_platform_admin())`

**5. COMMENT ON TABLE statements:**
- `COMMENT ON TABLE contact_submissions IS 'Contact form submissions from public /contact page';`
- `COMMENT ON TABLE quote_submissions IS 'Quote builder submissions from public marketing site';`

Include a header comment block with migration number, date (2026-02-17), and purpose.

IMPORTANT: Do NOT add moddatetime triggers for updated_at. The project uses manual `updated_at` in update calls. Add a comment noting this convention.
  </action>
  <verify>
Run: `cat supabase/migrations/115_lead_capture_tables.sql | head -5` to confirm file exists.
Verify the file contains both CREATE TABLE statements, all 7 indexes, RLS ENABLE on both tables, 4 org-scoped policies (2 per table), 8 platform admin policies (4 per table), and 2 COMMENT ON TABLE statements.
Count: `grep -c "CREATE POLICY" supabase/migrations/115_lead_capture_tables.sql` should return 12 (2 org + 8 platform admin + 0 anon = wait, 4 org-scoped + 8 platform = 12).
  </verify>
  <done>Migration file exists with both tables, 7 indexes, 12 RLS policies, and 2 table comments. No moddatetime triggers.</done>
</task>

<task id="08-01-T2" type="auto">
  <name>Update .env.local.example with service role key and org ID vars</name>
  <files>web/.env.local.example</files>
  <action>
Add two new env vars to `web/.env.local.example` at the end, with clear comments:

```
# Supabase Service Role Key (server-only, NEVER expose to client)
# Required for public form submissions that bypass RLS
# Found in: Supabase Dashboard > Project Settings > API > service_role key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# ASG Organization UUID (server-only)
# The org_id to associate with public form submissions
# Query: SELECT id FROM organizations WHERE name ILIKE '%apex%' LIMIT 1
ASG_ORG_ID=your-asg-org-uuid-here
```

Do NOT modify any existing lines in the file.
  </action>
  <verify>
`grep "SUPABASE_SERVICE_ROLE_KEY" web/.env.local.example` returns a match.
`grep "ASG_ORG_ID" web/.env.local.example` returns a match.
  </verify>
  <done>.env.local.example documents both new server-only env vars with instructions on where to find the values.</done>
</task>

</tasks>

<verification>
1. `cat supabase/migrations/115_lead_capture_tables.sql` - file exists and is well-formed SQL
2. `grep -c "CREATE TABLE" supabase/migrations/115_lead_capture_tables.sql` returns 2
3. `grep -c "CREATE INDEX" supabase/migrations/115_lead_capture_tables.sql` returns 7
4. `grep -c "CREATE POLICY" supabase/migrations/115_lead_capture_tables.sql` returns 12
5. `grep -c "ENABLE ROW LEVEL SECURITY" supabase/migrations/115_lead_capture_tables.sql` returns 2
6. `grep "SUPABASE_SERVICE_ROLE_KEY" web/.env.local.example` returns a match
</verification>

<success_criteria>
- Migration 115 creates both tables with exact column types and constraints
- Both tables have org_id FK, status CHECK constraint, and proper indexes
- RLS is enabled with org-scoped SELECT + UPDATE + platform admin full CRUD
- No INSERT policy for anon/authenticated (service role handles public inserts)
- .env.local.example documents both new env vars
</success_criteria>

<output>
After completion, create `.planning/phases/08-lead-capture/08-01-SUMMARY.md`
</output>
