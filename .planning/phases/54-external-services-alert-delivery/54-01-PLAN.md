# 54-01 Plan — Alert Delivery Reliability and Cron Observability

## Objective

Harden external-service delivery operations by adding delivery retry/dead-letter tracking and cron run observability with operator-facing health metrics.

## Requirements Coverage IDs

- `OPS-04` — Delivery channels include retry/dead-letter visibility.
- `OPS-05` — Alert fan-out failures are captured and recoverable.
- `OPS-06` — Scheduled jobs expose run health and failure metadata.

## Tasks

- [x] **Task 1:** Add reliability schema
  - `170_marketplace_ops_alert_reliability.sql`
  - tables: `marketplace_alert_delivery_attempts`, `marketplace_job_runs`

- [x] **Task 2:** Wire runtime reliability + observability hooks
  - Notification helper logs sent/failed/dead-letter attempts and retries.
  - Cron routes record job starts/completions/failures.

- [x] **Task 3:** Expand ops monitoring surface
  - Platform integrity overview API includes dead-letter/retry + cron health data.
  - Integrity overview UI displays alert reliability and cron status.

## Verification Strategy

- `pnpm --dir web exec tsc --noEmit`
- `pnpm --dir web lint`
- `pnpm --dir web-marketplace exec tsc --noEmit`
- `pnpm --dir web-marketplace lint`
- `pnpm --dir web exec vitest run "lib/marketplace/attribution/__tests__/pass-on-invariants.test.ts" "lib/marketplace/integrity/__tests__/signals-risk-band.test.ts"`
- `pnpm run ops:promote-integrity`

## Risks + Mitigations

- Retry loops causing duplicate alerts: retries limited and dead-letter status used after max attempts.
- Observability blind spots: cron and delivery events persisted with explicit status/error metadata.
- Operator overload: dashboard surfaces compact summary metrics and latest cron status only.
