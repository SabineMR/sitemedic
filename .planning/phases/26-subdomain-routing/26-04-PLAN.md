---
phase: 26
plan: 04
name: Auth Cookie Scope Verification & Local Dev Testing
wave: 2
depends_on: [26-02]
autonomous: true
gap_closure: false
files_modified:
  - web/app/api/auth/signout/route.ts
---

<objective>
Verify that Supabase auth cookies are NOT widened to `.sitemedic.co.uk` (preventing cross-org session leaks) and that the existing login/signout flow works correctly after the middleware changes. Fix the signout route to handle subdomain redirects correctly.

Requirements addressed: Success Criterion 4 (each org subdomain requires its own sign-in).
</objective>

<must_haves>
- Supabase SSR cookie has no explicit domain attribute (defaults to request hostname)
- Signout route redirects to the correct origin (not hardcoded apex domain)
- Existing login flow works on apex domain (regression test)
</must_haves>

<tasks>

<task id="1" name="Fix signout route for subdomain support" type="code">
The current signout route at `web/app/api/auth/signout/route.ts` uses a hardcoded URL:

```typescript
return NextResponse.redirect(new URL('/login', process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:30500'));
```

This would redirect ALL signouts to the apex domain, breaking subdomain sessions. Update to use the request origin:

```typescript
export async function POST(request: Request) {
  // ... existing signout logic ...

  // Redirect to login on the SAME origin (preserves subdomain context)
  const origin = request.headers.get('origin') || request.headers.get('referer')?.split('/').slice(0, 3).join('/') || 'http://localhost:30500';
  return NextResponse.redirect(new URL('/login', origin));
}
```

This ensures signing out at `apex.sitemedic.co.uk` redirects to `apex.sitemedic.co.uk/login`, not `sitemedic.co.uk/login`.
</task>

<task id="2" name="Verify cookie scope in Supabase SSR" type="code">
Read the `@supabase/ssr` source or inspect the cookie options in `web/lib/supabase/middleware.ts`. Confirm that:

1. `setAll()` in the middleware client does NOT set `domain` on cookies
2. The `options` object passed to `supabaseResponse.cookies.set(name, value, options)` does not include a `domain` field

If the cookie options include `domain: '.sitemedic.co.uk'` (or similar), this is a CRITICAL security issue — remove it immediately.

Expected result: No explicit domain is set. Browser defaults to the exact request hostname. This is confirmed by `@supabase/ssr` source — it sets `path: '/'` but no `domain`.

Add a code comment in the middleware documenting this verification:
```typescript
// Cookie scope: @supabase/ssr does NOT set explicit cookie domain.
// Browser defaults to the exact hostname (e.g., apex.sitemedic.co.uk).
// This ensures session isolation between org subdomains — a session on
// apex.sitemedic.co.uk is NOT accessible from another.sitemedic.co.uk.
// NEVER add domain: '.sitemedic.co.uk' to cookie options.
```
</task>

<task id="3" name="Verify middleware flow preserves auth redirects" type="code">
Review the full middleware flow after 26-02 changes to ensure:

1. Unauthenticated users on apex domain → redirect to `/login` (unchanged)
2. Unauthenticated users on subdomain → redirect to `/login` (with org headers)
3. Authenticated users on `/login` → redirect to role-appropriate dashboard
4. Users without `org_id` → redirect to `/setup/organization`
5. Public routes (/, /pricing, legal pages, /api/) → pass through

No code changes expected — this is a verification task. If any flow is broken, fix it and document the fix.
</task>

</tasks>

<verification>
- [ ] Signout route uses request origin (not hardcoded NEXT_PUBLIC_SITE_URL)
- [ ] @supabase/ssr does not set cookie domain (confirmed by source inspection)
- [ ] Cookie scope documentation comment added to middleware
- [ ] Auth redirect flow works for apex domain (unauthenticated → /login)
- [ ] Auth redirect flow works for subdomain (unauthenticated → /login with org headers)
- [ ] Authenticated redirect flow works (login page → role-based dashboard)
</verification>
