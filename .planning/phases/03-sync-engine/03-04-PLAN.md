---
phase: 03-sync-engine
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/SyncErrorDisplay.tsx
  - src/components/RiddorSyncAlert.tsx
  - src/components/PhotoUploadProgress.tsx
  - src/components/SyncStatusIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "Failed sync surfaces plain language error with manual retry button"
    - "RIDDOR-reportable incident that fails to sync triggers a critical persistent banner"
    - "Photo upload progress visible as aggregate count (not per-photo spam)"
    - "Sync status indicator shows photo upload state alongside data sync state"
    - "Error messages are plain English for construction site medics (no technical jargon)"
  artifacts:
    - path: "src/components/SyncErrorDisplay.tsx"
      provides: "Error toast/banner with plain language message and retry button"
      exports: ["SyncErrorDisplay"]
    - path: "src/components/RiddorSyncAlert.tsx"
      provides: "Persistent critical banner for RIDDOR sync failures"
      exports: ["RiddorSyncAlert"]
    - path: "src/components/PhotoUploadProgress.tsx"
      provides: "Aggregate photo upload progress indicator"
      exports: ["PhotoUploadProgress"]
  key_links:
    - from: "src/components/SyncErrorDisplay.tsx"
      to: "src/contexts/SyncContext.tsx"
      via: "useSync() hook for error state and triggerSync"
      pattern: "useSync"
    - from: "src/components/RiddorSyncAlert.tsx"
      to: "src/services/SyncQueue.ts"
      via: "checks for failed RIDDOR items in sync queue"
      pattern: "priority.*===.*0|riddor"
    - from: "src/components/PhotoUploadProgress.tsx"
      to: "src/contexts/SyncContext.tsx"
      via: "reads pendingPhotoCount from sync state"
      pattern: "pendingPhotoCount"
---

<objective>
Create sync feedback UI components: error display with retry, RIDDOR critical alert, and photo upload progress.

Purpose: Medics need to know when sync fails, especially for RIDDOR-reportable incidents. Error messages must be plain English (not technical). Photo upload progress should be visible but unobtrusive. Per CONTEXT.md: success is silent (badge clears), failure surfaces with retry, RIDDOR failure is critical.

Output: Three new UI components for sync error handling, RIDDOR alerts, and photo progress, plus enhanced SyncStatusIndicator.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sync-engine/03-CONTEXT.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
@src/components/SyncStatusIndicator.tsx
@src/components/OfflineBanner.tsx
@src/contexts/SyncContext.tsx
@src/services/SyncQueue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncErrorDisplay and RiddorSyncAlert components</name>
  <files>
    src/components/SyncErrorDisplay.tsx
    src/components/RiddorSyncAlert.tsx
  </files>
  <action>
Create 2 components:

**1. `src/components/SyncErrorDisplay.tsx`** - Error banner with retry button

Shows when SyncContext state.status === 'error'. Displays plain-English error with a "Try Again" button.

Design requirements:
- Orange/amber background (#FEF3C7 border, #FFFBEB background) - consistent with OfflineBanner warning palette
- 56pt minimum tap target on retry button (gloves-on, per D-02-01-002)
- Plain English messages. Map technical errors to user-friendly text:
  - Network errors -> "Unable to reach the server. Check your signal and try again."
  - Auth errors -> "Your session has expired. Please log in again."
  - Server errors -> "The server is temporarily unavailable. Your data is safe and will sync later."
  - Unknown -> "Something went wrong with sync. Your data is saved locally."
- Auto-dismiss after 10 seconds if error was transient (retry succeeded)
- Shows retry button that calls `triggerSync()` from useSync()

```typescript
import React from 'react';
import { View, Text, Pressable, StyleSheet } from 'react-native';
import { useSync } from '../contexts/SyncContext';

function getPlainLanguageError(error: string | null): string {
  if (!error) return '';
  const lower = error.toLowerCase();
  if (lower.includes('network') || lower.includes('fetch') || lower.includes('timeout')) {
    return 'Unable to reach the server. Check your signal and try again.';
  }
  if (lower.includes('auth') || lower.includes('jwt') || lower.includes('401') || lower.includes('403')) {
    return 'Your session has expired. Please log in again.';
  }
  if (lower.includes('500') || lower.includes('502') || lower.includes('503') || lower.includes('server')) {
    return 'The server is temporarily unavailable. Your data is safe and will sync later.';
  }
  return 'Something went wrong with sync. Your data is saved locally.';
}

export function SyncErrorDisplay() {
  const { state, triggerSync } = useSync();

  if (state.status !== 'error' || !state.lastError) return null;

  return (
    <View style={styles.container}>
      <Text style={styles.message}>{getPlainLanguageError(state.lastError)}</Text>
      <Pressable
        onPress={triggerSync}
        style={styles.retryButton}
        hitSlop={{ top: 4, bottom: 4, left: 4, right: 4 }}
      >
        <Text style={styles.retryText}>Try Again</Text>
      </Pressable>
    </View>
  );
}
```

Styles: amber background (#FFFBEB), left border 4px amber (#F59E0B), padding 16px, flexDirection 'row', alignItems 'center', justifyContent 'space-between'. Retry button: blue background (#2563EB), white text, borderRadius 8, minHeight 48, minWidth 100, padding horizontal 16.

**2. `src/components/RiddorSyncAlert.tsx`** - Critical persistent banner for RIDDOR failures

This component checks the sync queue for failed RIDDOR items (priority 0 with retryCount > 0). If any exist, it shows a NON-DISMISSIBLE red banner at the top of the screen.

Per CONTEXT.md: "RIDDOR failure alerts: Must be critical alert per success criteria"
Implementation: persistent banner (cannot be dismissed while RIDDOR items are failing) + red color for urgency

```typescript
import React, { useState, useEffect, useCallback } from 'react';
import { View, Text, Pressable, StyleSheet } from 'react-native';
import { useSync } from '../contexts/SyncContext';
import { syncQueue } from '../services/SyncQueue';

export function RiddorSyncAlert() {
  const { state, triggerSync } = useSync();
  const [riddorFailCount, setRiddorFailCount] = useState(0);

  const checkRiddorFailures = useCallback(async () => {
    try {
      const items = await syncQueue.getPendingItems();
      const riddorFailed = items.filter(
        item => item.priority === 0 && item.retryCount > 0 && item.tableName !== 'photo_uploads'
      );
      setRiddorFailCount(riddorFailed.length);
    } catch (error) {
      console.error('[RiddorSyncAlert] Failed to check RIDDOR items:', error);
    }
  }, []);

  useEffect(() => {
    checkRiddorFailures();
    // Re-check every 10 seconds
    const interval = setInterval(checkRiddorFailures, 10000);
    return () => clearInterval(interval);
  }, [checkRiddorFailures, state.pendingCount]);

  if (riddorFailCount === 0) return null;

  return (
    <View style={styles.container}>
      <View style={styles.iconContainer}>
        <Text style={styles.icon}>!</Text>
      </View>
      <View style={styles.textContainer}>
        <Text style={styles.title}>RIDDOR Report Pending</Text>
        <Text style={styles.message}>
          {riddorFailCount} reportable {riddorFailCount === 1 ? 'incident has' : 'incidents have'} not synced.
          {'\n'}This must be reported. Retrying automatically.
        </Text>
      </View>
      <Pressable
        onPress={triggerSync}
        style={styles.retryButton}
        hitSlop={{ top: 4, bottom: 4, left: 4, right: 4 }}
      >
        <Text style={styles.retryText}>Sync Now</Text>
      </Pressable>
    </View>
  );
}
```

Styles: RED background (#FEE2E2), thick left border (#EF4444 4px), NON-DISMISSIBLE (no close button). Icon container with red circle and white exclamation mark. Title bold. Retry button red background (#EF4444), white text, 56pt min height.

Key distinction from SyncErrorDisplay:
- SyncErrorDisplay: shows for ANY sync error, amber, dismissible after success
- RiddorSyncAlert: shows ONLY for RIDDOR failures, red, non-dismissible until resolved
- Both can appear simultaneously (RIDDOR alert above error display)
  </action>
  <verify>
Verify files exist: `ls -la src/components/SyncErrorDisplay.tsx src/components/RiddorSyncAlert.tsx`
Grep for plain language: `grep -n "Unable to reach\|session has expired\|temporarily unavailable" src/components/SyncErrorDisplay.tsx`
Grep for RIDDOR check: `grep -n "priority.*===.*0" src/components/RiddorSyncAlert.tsx`
  </verify>
  <done>
SyncErrorDisplay shows plain English errors with retry button for general sync failures. RiddorSyncAlert shows persistent red banner for RIDDOR items that fail to sync, checking queue every 10 seconds for priority-0 items with retryCount > 0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PhotoUploadProgress and enhance SyncStatusIndicator</name>
  <files>
    src/components/PhotoUploadProgress.tsx
    src/components/SyncStatusIndicator.tsx
  </files>
  <action>
Create 1 new file and modify 1 existing file:

**1. `src/components/PhotoUploadProgress.tsx`** - Aggregate photo upload indicator

Shows "Uploading N photos..." with a simple progress bar when photos are pending upload. Per Research Pitfall 6: use aggregate notification, NOT per-photo notifications.

Only visible when pendingPhotoCount > 0. Compact design that fits below the SyncStatusIndicator.

```typescript
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { useSync } from '../contexts/SyncContext';

export function PhotoUploadProgress() {
  const { state } = useSync();

  if (state.pendingPhotoCount === 0) return null;

  // Each photo has 3 stages (thumbnail, preview, full)
  // Show logical photo count, not queue item count
  const logicalPhotoCount = Math.ceil(state.pendingPhotoCount / 3);

  return (
    <View style={styles.container}>
      <View style={styles.dot} />
      <Text style={styles.text}>
        Uploading {logicalPhotoCount} {logicalPhotoCount === 1 ? 'photo' : 'photos'}...
      </Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 12,
    paddingVertical: 4,
    backgroundColor: '#EFF6FF', // Light blue background
  },
  dot: {
    width: 8,
    height: 8,
    borderRadius: 4,
    backgroundColor: '#3B82F6', // Blue
    marginRight: 8,
  },
  text: {
    fontSize: 12,
    color: '#1D4ED8', // Dark blue
    fontWeight: '500',
  },
});
```

**2. Enhance `src/components/SyncStatusIndicator.tsx`**

Read the existing file first. Then make these targeted additions:

a) Import and use the `pendingPhotoCount` from useSync state alongside existing pendingCount
b) Update the label for 'pending' status to include photo count if any:
```typescript
const getLabel = () => {
  if (state.status === 'pending') {
    const dataCount = state.pendingCount;
    const photoCount = state.pendingPhotoCount || 0;
    const logicalPhotos = Math.ceil(photoCount / 3);

    if (dataCount > 0 && logicalPhotos > 0) {
      return `${dataCount} items, ${logicalPhotos} photos`;
    }
    if (logicalPhotos > 0) {
      return `${logicalPhotos} photos pending`;
    }
    return `${dataCount} pending`;
  }
  // ... rest of existing labels unchanged
};
```

c) Update the badge count to show total pending (data + logical photo count):
```typescript
const totalPending = state.pendingCount + Math.ceil((state.pendingPhotoCount || 0) / 3);
```

Keep all existing styles, color mapping, press handlers, and 48pt tap targets unchanged. Only modify the label computation and badge count.
  </action>
  <verify>
Verify files exist: `ls -la src/components/PhotoUploadProgress.tsx src/components/SyncStatusIndicator.tsx`
Grep for aggregate: `grep -n "logicalPhotoCount\|Uploading.*photo" src/components/PhotoUploadProgress.tsx`
Grep for enhanced label: `grep -n "pendingPhotoCount\|logicalPhotos" src/components/SyncStatusIndicator.tsx`
  </verify>
  <done>
PhotoUploadProgress shows aggregate "Uploading N photos..." (divides queue items by 3 stages per photo). SyncStatusIndicator badge and label updated to include photo counts alongside data item counts.
  </done>
</task>

</tasks>

<verification>
- SyncErrorDisplay maps technical errors to plain English (4 error categories)
- SyncErrorDisplay shows retry button with 48pt minimum tap target
- RiddorSyncAlert checks sync queue for priority 0 items with retryCount > 0
- RiddorSyncAlert is non-dismissible (no close button)
- PhotoUploadProgress shows aggregate count (divides by 3 stages)
- SyncStatusIndicator badge includes photo count
- All components use useSync() hook for state access
- All interactive elements meet 56pt minimum tap target (gloves-on)
</verification>

<success_criteria>
1. General sync errors show plain English message with "Try Again" button
2. RIDDOR sync failures show persistent red banner (non-dismissible) with "Sync Now" button
3. Photo upload progress shows aggregate "Uploading N photos..." (not per-photo)
4. Sync status badge shows combined data + photo pending count
5. All tap targets >= 48pt for gloves-on construction site usability
</success_criteria>

<output>
After completion, create `.planning/phases/03-sync-engine/03-04-SUMMARY.md`
</output>
