---
phase: 03-sync-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - mobile/tasks/backgroundSyncTask.ts
  - src/services/BackgroundSyncTask.ts
  - src/utils/syncScheduler.ts
autonomous: true

must_haves:
  truths:
    - "Background sync task is registered with iOS BGTaskScheduler via expo-background-task"
    - "Foreground sync polls every 30 seconds when app is active"
    - "Background sync fires at 15-minute minimum intervals when app is backgrounded"
    - "App state transitions (active/background) switch between foreground and background sync strategies"
  artifacts:
    - path: "mobile/tasks/backgroundSyncTask.ts"
      provides: "TaskManager.defineTask at global scope for BACKGROUND_SYNC"
      contains: "TaskManager.defineTask"
    - path: "src/services/BackgroundSyncTask.ts"
      provides: "Background task registration with expo-background-task"
      contains: "BackgroundTask.registerTaskAsync"
    - path: "src/utils/syncScheduler.ts"
      provides: "Hybrid sync coordinator (foreground polling + background task)"
      exports: ["SyncScheduler", "syncScheduler"]
  key_links:
    - from: "mobile/tasks/backgroundSyncTask.ts"
      to: "src/services/SyncQueue.ts"
      via: "imports syncQueue.processPendingItems()"
      pattern: "syncQueue\\.processPendingItems"
    - from: "src/utils/syncScheduler.ts"
      to: "src/services/BackgroundSyncTask.ts"
      via: "calls registerBackgroundSync on init"
      pattern: "registerBackgroundSync"
---

<objective>
Install sync dependencies and create hybrid foreground/background sync scheduling infrastructure.

Purpose: The 15-minute minimum for iOS background tasks (BGTaskScheduler) means foreground polling handles the user-facing 30-second sync interval, while background tasks handle sync when the app is not active. This hybrid approach is the foundation for all Phase 3 sync operations.

Output: New dependencies installed, background task definition at global scope, background task registration service, and sync scheduler that coordinates foreground polling with background task scheduling.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sync-engine/03-RESEARCH.md
@.planning/phases/03-sync-engine/03-CONTEXT.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
@src/services/SyncQueue.ts
@src/services/NetworkMonitor.ts
@src/contexts/SyncContext.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sync dependencies</name>
  <files>package.json</files>
  <action>
Install the following packages using pnpm:
- `expo-background-task` - Background task scheduling via iOS BGTaskScheduler
- `expo-task-manager` - Task definition and lifecycle management (required by expo-background-task)
- `react-native-background-upload` - Native background file uploads that continue when app is backgrounded
- `expo-file-system` - File reading for upload preparation (may already be transitive dep, install explicitly)

Run: `pnpm add expo-background-task expo-task-manager react-native-background-upload expo-file-system`

Do NOT install expo-image-manipulator (already in package.json).
Do NOT install @react-native-community/netinfo (already in package.json).
  </action>
  <verify>`pnpm list expo-background-task expo-task-manager react-native-background-upload expo-file-system` shows all 4 packages installed</verify>
  <done>All 4 sync dependencies are in package.json dependencies and installed in node_modules</done>
</task>

<task type="auto">
  <name>Task 2: Create background sync task definition and hybrid sync scheduler</name>
  <files>
    mobile/tasks/backgroundSyncTask.ts
    src/services/BackgroundSyncTask.ts
    src/utils/syncScheduler.ts
  </files>
  <action>
Create 3 files:

**1. `mobile/tasks/backgroundSyncTask.ts`** - Global-scope task definition
CRITICAL: TaskManager.defineTask MUST be at global scope (module level), NOT inside any React component or lifecycle. This is an Expo requirement.

```typescript
import * as TaskManager from 'expo-task-manager';
import { syncQueue } from '../../src/services/SyncQueue';

const BACKGROUND_SYNC_TASK = 'BACKGROUND_SYNC';

TaskManager.defineTask(BACKGROUND_SYNC_TASK, async () => {
  try {
    console.log('[BackgroundSync] Task started');
    const result = await syncQueue.processPendingItems();
    console.log(`[BackgroundSync] Completed: ${result.processed} synced, ${result.failed} failed`);

    // Photo uploads handled separately in Plan 03-02
    // Will be added here after PhotoUploadQueue is created

    return result.failed === 0
      ? TaskManager.BackgroundFetchResult.NewData
      : TaskManager.BackgroundFetchResult.Failed;
  } catch (error) {
    console.error('[BackgroundSync] Task failed:', error);
    return TaskManager.BackgroundFetchResult.Failed;
  }
});

export { BACKGROUND_SYNC_TASK };
```

**2. `src/services/BackgroundSyncTask.ts`** - Registration service
```typescript
import * as BackgroundTask from 'expo-background-task';
import { BACKGROUND_SYNC_TASK } from '../../mobile/tasks/backgroundSyncTask';

export async function registerBackgroundSync(): Promise<void> {
  try {
    await BackgroundTask.registerTaskAsync(BACKGROUND_SYNC_TASK, {
      minimumInterval: 15 * 60, // 15 minutes (iOS/Android minimum)
    });
    console.log('[BackgroundSyncTask] Registered successfully');
  } catch (error) {
    console.error('[BackgroundSyncTask] Registration failed:', error);
    // Non-fatal: background sync is a nice-to-have, foreground sync is primary
  }
}

export async function unregisterBackgroundSync(): Promise<void> {
  try {
    await BackgroundTask.unregisterTaskAsync(BACKGROUND_SYNC_TASK);
    console.log('[BackgroundSyncTask] Unregistered');
  } catch (error) {
    console.warn('[BackgroundSyncTask] Unregister failed (may not have been registered):', error);
  }
}
```

**3. `src/utils/syncScheduler.ts`** - Hybrid foreground/background coordinator
Implements the user decision: "batch and sync every 30 seconds" (foreground) + background task for when app is not active.

RIDDOR priority 0 items bypass the 30-second batch - they trigger immediate sync via the existing SyncQueue.enqueue() -> processPendingItems() path. The 30-second interval handles normal batched items.

```typescript
import { AppState, AppStateStatus } from 'react-native';
import { syncQueue } from '../services/SyncQueue';
import { registerBackgroundSync } from '../services/BackgroundSyncTask';
import { networkMonitor } from '../services/NetworkMonitor';

export class SyncScheduler {
  private foregroundInterval: ReturnType<typeof setInterval> | null = null;
  private appStateSubscription: any = null;
  private isStarted = false;

  async start(): Promise<void> {
    if (this.isStarted) return;
    this.isStarted = true;

    // Register background task (non-blocking, logs error if fails)
    await registerBackgroundSync();

    // Listen for app state changes
    this.appStateSubscription = AppState.addEventListener('change', this.handleAppStateChange);

    // Start foreground sync if app is currently active
    if (AppState.currentState === 'active') {
      this.startForegroundSync();
    }

    console.log('[SyncScheduler] Started');
  }

  stop(): void {
    this.stopForegroundSync();
    if (this.appStateSubscription) {
      this.appStateSubscription.remove();
      this.appStateSubscription = null;
    }
    this.isStarted = false;
    console.log('[SyncScheduler] Stopped');
  }

  private handleAppStateChange = (nextState: AppStateStatus): void => {
    if (nextState === 'active') {
      console.log('[SyncScheduler] App active - starting foreground sync');
      this.startForegroundSync();
      // Immediately process any items that accumulated while backgrounded
      this.syncNow();
    } else {
      console.log('[SyncScheduler] App backgrounded - stopping foreground sync');
      this.stopForegroundSync();
    }
  };

  private startForegroundSync(): void {
    if (this.foregroundInterval) return; // Already running

    // Poll every 30 seconds per user decision (CONTEXT.md batching strategy)
    this.foregroundInterval = setInterval(() => {
      this.syncNow();
    }, 30 * 1000);
  }

  private stopForegroundSync(): void {
    if (this.foregroundInterval) {
      clearInterval(this.foregroundInterval);
      this.foregroundInterval = null;
    }
  }

  /** Trigger immediate sync if online. Called by scheduler and can be called manually. */
  async syncNow(): Promise<{ processed: number; failed: number }> {
    const { isOnline } = networkMonitor.getConnectionInfo();
    if (!isOnline) {
      return { processed: 0, failed: 0 };
    }
    return syncQueue.processPendingItems();
  }
}

export const syncScheduler = new SyncScheduler();
```
  </action>
  <verify>
TypeScript compilation check: `cd /Users/sabineresoagli/GitHub/sitemedic && npx tsc --noEmit --skipLibCheck 2>&1 | head -20`
Verify files exist: `ls -la mobile/tasks/backgroundSyncTask.ts src/services/BackgroundSyncTask.ts src/utils/syncScheduler.ts`
  </verify>
  <done>
Three files created: background task definition at global scope, background task registration service, and hybrid sync scheduler that polls every 30 seconds in foreground and delegates to background task when app is inactive.
  </done>
</task>

</tasks>

<verification>
- `pnpm list expo-background-task expo-task-manager react-native-background-upload expo-file-system` shows all packages
- All 3 new TypeScript files compile without errors
- backgroundSyncTask.ts imports syncQueue from correct path
- syncScheduler.ts uses 30-second interval (per CONTEXT.md batching strategy)
- BackgroundSyncTask.ts uses 15-minute minimum interval (per RESEARCH.md critical finding)
</verification>

<success_criteria>
1. Four new dependencies installed (expo-background-task, expo-task-manager, react-native-background-upload, expo-file-system)
2. Background task defined at global scope with TaskManager.defineTask
3. Background task registration uses 15-minute minimum interval
4. Foreground sync polls every 30 seconds
5. App state changes toggle between foreground and background sync strategies
</success_criteria>

<output>
After completion, create `.planning/phases/03-sync-engine/03-01-SUMMARY.md`
</output>
