---
phase: 03-sync-engine
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/SyncQueue.ts
  - src/database/schema.ts
  - src/database/models/SyncQueueItem.ts
  - src/contexts/SyncContext.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Each sync queue item has a client-generated UUID (idempotency_key) created at enqueue time"
    - "The idempotency_key is included in the sync payload for create operations"
    - "Retry of a failed create uses the same idempotency_key, preventing duplicate server records"
    - "Server-side duplicate detection via ON CONFLICT on client_id column is documented for future Supabase migration"
  artifacts:
    - path: "src/services/SyncQueue.ts"
      provides: "Idempotency key generation and inclusion in create payloads"
      contains: "idempotency_key"
    - path: "src/database/schema.ts"
      provides: "idempotency_key column in sync_queue table"
      contains: "idempotency_key"
    - path: "src/database/models/SyncQueueItem.ts"
      provides: "idempotencyKey field on SyncQueueItem model"
      contains: "idempotencyKey"
  key_links:
    - from: "src/services/SyncQueue.ts"
      to: "expo-crypto"
      via: "import for UUID generation"
      pattern: "randomUUID|expo-crypto"
    - from: "src/services/SyncQueue.ts"
      to: "Supabase"
      via: "idempotency_key in create payload"
      pattern: "idempotency_key"
---

<objective>
Add client-generated UUID idempotency keys to the sync queue to prevent duplicate server records when create operations are retried after failure.

Purpose: The verification found that WatermelonDB uses auto-generated IDs and server_id is only set after the first successful sync. If a create operation succeeds on the server but the response fails to reach the client (network timeout), the retry would create a duplicate record. Adding an idempotency_key (client-generated UUID) to each sync queue item allows the server to detect and reject duplicate creates.

Output: Sync queue items carry a unique idempotency_key generated at enqueue time. Create payloads include this key. Server-side duplicate detection strategy documented for future Supabase migration.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sync-engine/03-VERIFICATION.md
@.planning/phases/03-sync-engine/03-05-SUMMARY.md
@src/services/SyncQueue.ts
@src/database/schema.ts
@src/database/models/SyncQueueItem.ts
@src/contexts/SyncContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add idempotency_key column to sync_queue schema and model</name>
  <files>
    src/database/schema.ts
    src/database/models/SyncQueueItem.ts
  </files>
  <action>
    1. In `src/database/schema.ts`, add a new column to the `sync_queue` table:
       ```typescript
       { name: 'idempotency_key', type: 'string' },
       ```
       Place it after the `record_id` column. This stores the client-generated UUID for each sync operation.

       IMPORTANT: Increment the schema version from 2 to 3. WatermelonDB requires a version bump when columns are added.

    2. In `src/database/models/SyncQueueItem.ts`, add the field:
       ```typescript
       @field('idempotency_key') idempotencyKey!: string
       ```
       Place it after the `recordId` field.

    Note: WatermelonDB schema migrations are needed for existing databases. For now, the schema version bump is sufficient since the app is in development (no production data to migrate). Add a comment noting that a migration adapter should be added before production release.
  </action>
  <verify>
    Grep for `idempotency_key` in src/database/schema.ts to confirm column exists.
    Grep for `idempotencyKey` in src/database/models/SyncQueueItem.ts to confirm field exists.
    Verify schema version is 3 in src/database/schema.ts.
  </verify>
  <done>
    sync_queue table has idempotency_key column, SyncQueueItem model has idempotencyKey field, schema version bumped to 3.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate idempotency keys at enqueue time and include in create payloads</name>
  <files>
    src/services/SyncQueue.ts
    src/contexts/SyncContext.tsx
  </files>
  <action>
    1. In `src/services/SyncQueue.ts`:

       a) Add import at top:
          ```typescript
          import * as Crypto from 'expo-crypto';
          ```

       b) In the `enqueue()` method, generate a UUID for the idempotency key:
          ```typescript
          const idempotencyKey = Crypto.randomUUID();
          ```
          Set it on the sync queue item:
          ```typescript
          item.idempotencyKey = idempotencyKey;
          ```

       c) In the `syncItem()` method, for the `'create'` case:
          - Before calling `supabase.from(item.tableName).insert(payload)`, parse the idempotency key from the item.
          - Add `client_id: item.idempotencyKey` to the payload object being sent to Supabase. This allows the server to detect duplicate creates.
          - Use the format:
            ```typescript
            const createPayload = { ...payload, client_id: item.idempotencyKey };
            const { data, error } = await supabase.from(item.tableName as any).insert(createPayload).select();
            ```

       d) Add a comment in the `syncItem()` create case explaining the duplicate prevention strategy:
          ```
          // Idempotency: client_id is a client-generated UUID included in every create payload.
          // If the server has a unique constraint on client_id, retrying this create will
          // result in a conflict (23505) instead of a duplicate record.
          // Server-side: Add `client_id UUID UNIQUE` column to Supabase tables in a future migration.
          // For now, client_id is sent but ignored by server until the migration is applied.
          ```

       e) In the `syncItem()` create case, after the `if (error) throw error` check, add handling for PostgreSQL unique constraint violation (error code 23505):
          ```typescript
          if (error) {
            // If duplicate detected (unique constraint on client_id), treat as success
            if (error.code === '23505' && error.message?.includes('client_id')) {
              console.log(`[SyncQueue] Duplicate create detected for ${item.tableName} (client_id: ${item.idempotencyKey}), treating as success`);
              // Still try to get the existing server record's ID
              const { data: existing } = await supabase
                .from(item.tableName as any)
                .select('id')
                .eq('client_id', item.idempotencyKey as any)
                .single();
              if (existing) {
                // Update local server_id
                const database = getDatabase();
                const localRecord = await database.collections
                  .get(item.tableName)
                  .find(item.recordId);
                await database.write(async () => {
                  await localRecord.update((record: any) => {
                    record.serverId = (existing as any).id;
                  });
                });
              }
              return; // Don't throw - treat as success
            }
            throw error;
          }
          ```

    2. The `enqueueSyncItem` wrapper in `src/contexts/SyncContext.tsx` does NOT need changes since it passes through to `syncQueue.enqueue()` which now generates the idempotency key internally.

    Note: The server-side `client_id UUID UNIQUE` column migration is NOT created in this plan. That belongs in a future Supabase migration (Phase 4+). The client-side idempotency key generation is the immediate fix. Until the server migration is applied, the `client_id` field will be included in payloads but ignored by the server. The `reference_number` unique constraint on treatments provides interim duplicate protection.
  </action>
  <verify>
    Grep for `randomUUID` in src/services/SyncQueue.ts to confirm UUID generation.
    Grep for `idempotencyKey` in src/services/SyncQueue.ts to confirm it's set on queue items.
    Grep for `client_id` in src/services/SyncQueue.ts to confirm it's included in create payloads.
    Grep for `23505` in src/services/SyncQueue.ts to confirm duplicate detection handling.
    Run `npx tsc --noEmit 2>&1 | grep -E "SyncQueue|SyncContext"` to verify no new TypeScript errors.
  </verify>
  <done>
    Sync queue generates UUID idempotency key at enqueue time. Create payloads include client_id field. Duplicate creates (23505 error) are handled gracefully as success. Server-side migration documented as future work.
  </done>
</task>

</tasks>

<verification>
1. `src/database/schema.ts` has `idempotency_key` column in sync_queue table, version = 3
2. `src/database/models/SyncQueueItem.ts` has `idempotencyKey` field
3. `src/services/SyncQueue.ts` generates UUID via `expo-crypto` at enqueue time
4. Create payloads include `client_id` from the idempotency key
5. Duplicate create (PostgreSQL 23505) handled as success, not re-thrown
6. `src/contexts/SyncContext.tsx` unchanged (enqueue wrapper passes through)
7. No new TypeScript errors
</verification>

<success_criteria>
- Every sync queue item has a client-generated UUID idempotency key
- Create operations include client_id in the Supabase payload
- Retry of a failed create uses the SAME idempotency key (persisted in WatermelonDB)
- Duplicate detection (23505) treats conflict as success and updates local server_id
- Server-side migration strategy documented in code comments
- expo-crypto (already installed) used for UUID generation
</success_criteria>

<output>
After completion, create `.planning/phases/03-sync-engine/03-07-SUMMARY.md`
</output>
