---
phase: 03-sync-engine
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/BackgroundSyncTask.ts
  - tasks/backgroundSyncTask.ts
  - package.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Background sync checks battery level before processing and skips if battery is critically low (<15%)"
    - "Background sync checks network type and skips photo uploads if only cellular is available"
    - "Battery and network constraints are logged for debugging without blocking foreground sync"
  artifacts:
    - path: "src/services/BackgroundSyncTask.ts"
      provides: "Background task registration (unchanged)"
    - path: "tasks/backgroundSyncTask.ts"
      provides: "Runtime battery and network constraint checks before sync processing"
      contains: "getBatteryLevelAsync"
    - path: "package.json"
      provides: "expo-battery dependency"
      contains: "expo-battery"
  key_links:
    - from: "tasks/backgroundSyncTask.ts"
      to: "expo-battery"
      via: "import and getBatteryLevelAsync() call"
      pattern: "getBatteryLevelAsync"
    - from: "tasks/backgroundSyncTask.ts"
      to: "@react-native-community/netinfo"
      via: "NetInfo.fetch() for network type check"
      pattern: "NetInfo\\.fetch"
---

<objective>
Add battery and network constraint checks to the background sync task to prevent battery drain during background processing.

Purpose: The verification found that expo-background-task only sets minimumInterval (15 minutes) but doesn't configure battery, network type, or device idle constraints. The expo-background-task API does NOT expose granular WorkManager-style constraint parameters (confirmed in research). The fix is to add runtime guards at the start of the background task that check battery level (via expo-battery) and network type (via NetInfo) before processing.

Output: Background sync task that skips processing when battery is critically low and skips photo uploads when only cellular is available.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sync-engine/03-VERIFICATION.md
@.planning/phases/03-sync-engine/03-01-SUMMARY.md
@tasks/backgroundSyncTask.ts
@src/services/BackgroundSyncTask.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-battery and add runtime battery/network constraint checks to background sync task</name>
  <files>
    package.json
    tasks/backgroundSyncTask.ts
    src/services/BackgroundSyncTask.ts
  </files>
  <action>
    1. Install expo-battery:
       ```
       pnpm add expo-battery
       ```

    2. Modify `tasks/backgroundSyncTask.ts` to add runtime constraint checks BEFORE processing:

       Import expo-battery and NetInfo:
       ```typescript
       import * as Battery from 'expo-battery';
       import NetInfo from '@react-native-community/netinfo';
       ```

       At the START of the TaskManager.defineTask callback (before any sync processing):

       a) **Battery check**: Call `Battery.getBatteryLevelAsync()` and `Battery.getBatteryStateAsync()`. If battery level < 0.15 (15%) AND battery state is NOT Battery.BatteryState.CHARGING, log a warning and return early (skip all background sync). This prevents draining a critically low battery.

       b) **Network type check**: Call `NetInfo.fetch()`. If `!netState.isConnected`, log and return early (no connectivity). Store the `netState.type` for use in photo upload decision.

       c) **Conditional photo upload**: Only call `photoUploadQueue.processPendingPhotos()` if network type is 'wifi'. If cellular only, skip photo uploads (data sync still processes since it's small payloads). Log that photo uploads were skipped due to cellular-only connectivity.

       The data sync (`syncQueue.processPendingItems()`) should ALWAYS proceed if battery is sufficient and network is connected (even on cellular), since data payloads are small (< 1KB each).

    3. Add a comment block at the top of `src/services/BackgroundSyncTask.ts` documenting the constraint strategy:
       ```
       // Constraint Strategy (expo-background-task limitation):
       // expo-background-task does NOT expose WorkManager-style constraint APIs.
       // Battery and network constraints are enforced at RUNTIME in tasks/backgroundSyncTask.ts:
       // - Battery: Skip sync if < 15% and not charging
       // - Network: Skip photo uploads if cellular-only (data sync proceeds on any connection)
       // - Idle: Not enforced (OS handles via BGTaskScheduler/WorkManager scheduling)
       ```

    Do NOT change the registration options in BackgroundSyncTask.ts (minimumInterval stays at 15 minutes). The constraints are runtime checks, not registration options.
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | grep -E "backgroundSyncTask|BackgroundSyncTask"` to verify no new TypeScript errors in the modified files.
    Grep for `getBatteryLevelAsync` in tasks/backgroundSyncTask.ts to confirm battery check is present.
    Grep for `NetInfo.fetch` in tasks/backgroundSyncTask.ts to confirm network check is present.
  </verify>
  <done>
    Background sync task checks battery level (< 15% + not charging = skip) and network type (cellular = skip photos) before processing. expo-battery is installed. Data sync proceeds on any connection type when battery is sufficient.
  </done>
</task>

</tasks>

<verification>
1. `tasks/backgroundSyncTask.ts` imports expo-battery and NetInfo
2. Battery level check prevents sync when < 15% and not charging
3. Network type check prevents photo uploads on cellular
4. Data sync still processes on cellular (small payloads are fine)
5. `src/services/BackgroundSyncTask.ts` has constraint documentation comment
6. expo-battery is in package.json dependencies
</verification>

<success_criteria>
- Background sync task has runtime battery guard (< 15% + not charging = skip all sync)
- Background sync task has runtime network guard (cellular = skip photo uploads only)
- expo-battery dependency installed
- No new TypeScript errors introduced
- Foreground sync is NOT affected by these constraints (constraints are background-task-only)
</success_criteria>

<output>
After completion, create `.planning/phases/03-sync-engine/03-06-SUMMARY.md`
</output>
