---
phase: 09-booking-data-completeness
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - web/components/admin/booking-approval-table.tsx
  - web/components/admin/booking-detail-panel.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking View Details in admin table opens the booking detail Sheet"
    - "Admin detail panel shows What3WordsDisplay component for what3words addresses"
    - "Recurring booking chain shows all N instances with per-instance status"
    - "Admin sees why a booking needed approval and who cancelled it"
  artifacts:
    - path: "web/components/admin/booking-approval-table.tsx"
      provides: "View Details wired to open BookingDetailPanel"
      contains: "setDetailDialogOpen"
    - path: "web/components/admin/booking-detail-panel.tsx"
      provides: "Detail panel with What3WordsDisplay and recurring chain"
      contains: "What3WordsDisplay"
  key_links:
    - from: "web/components/admin/booking-approval-table.tsx"
      to: "web/components/admin/booking-detail-panel.tsx"
      via: "BookingDetailPanel component with open/onOpenChange props"
      pattern: "BookingDetailPanel"
    - from: "web/components/admin/booking-detail-panel.tsx"
      to: "web/components/booking/what3words-display.tsx"
      via: "What3WordsDisplay component import"
      pattern: "What3WordsDisplay"
    - from: "web/components/admin/booking-detail-panel.tsx"
      to: "supabase bookings table"
      via: ".or() query for recurring chain"
      pattern: "parent_booking_id"
---

<objective>
Wire the admin "View Details" button to open the BookingDetailPanel, integrate the What3WordsDisplay component, and add the recurring booking chain view.

Purpose: This plan completes the admin booking detail experience by connecting all the pieces: the dead "View Details" button gets a click handler, the detail panel gets the shared What3WordsDisplay component, and recurring bookings show their full chain with per-instance status.
Output: A fully functional admin booking detail flow — click View Details, see everything about a booking including its recurring chain.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-booking-data-completeness/09-RESEARCH.md
@.planning/phases/09-booking-data-completeness/09-01-SUMMARY.md
@.planning/phases/09-booking-data-completeness/09-02-SUMMARY.md

@web/components/admin/booking-approval-table.tsx
@web/components/admin/booking-detail-panel.tsx
@web/components/booking/what3words-display.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire View Details button in booking-approval-table.tsx</name>
  <files>web/components/admin/booking-approval-table.tsx</files>
  <action>
Wire the dead "View Details" DropdownMenuItem to open the BookingDetailPanel Sheet.

1. Add imports at top of file:
   ```typescript
   import { BookingDetailPanel } from './booking-detail-panel';
   ```

2. Add state variables inside the `BookingApprovalTable` component (near the existing dialog state variables around line 104-116):
   ```typescript
   // Detail panel state
   const [detailPanelOpen, setDetailPanelOpen] = useState(false);
   const [selectedDetailBooking, setSelectedDetailBooking] = useState<BookingWithRelations | null>(null);
   ```

3. Find the "View Details" DropdownMenuItem (around line 443-445). Currently it has no onClick:
   ```typescript
   <DropdownMenuItem className="text-gray-300 hover:text-white hover:bg-gray-700">
     View Details
   </DropdownMenuItem>
   ```

   Replace with:
   ```typescript
   <DropdownMenuItem
     onClick={() => {
       setSelectedDetailBooking(booking);
       setDetailPanelOpen(true);
     }}
     className="text-gray-300 hover:text-white hover:bg-gray-700"
   >
     View Details
   </DropdownMenuItem>
   ```

   Note: `booking` is already available in this scope as `row.original` (see the `actions` column definition around line 432-434).

4. Add the BookingDetailPanel component at the bottom of the return JSX, after the OutOfTerritoryApproval modal (after line ~891, before the closing `</div>` of the main return):
   ```typescript
   {/* Booking Detail Panel */}
   <BookingDetailPanel
     booking={selectedDetailBooking}
     open={detailPanelOpen}
     onOpenChange={setDetailPanelOpen}
   />
   ```

Do NOT change any existing dialog logic, mutations, column definitions, or filter logic. Only add the state, the onClick, and the panel component.
  </action>
  <verify>
    - grep -n "BookingDetailPanel" web/components/admin/booking-approval-table.tsx — import and component usage
    - grep -n "detailPanelOpen" web/components/admin/booking-approval-table.tsx — state variable
    - grep -n "selectedDetailBooking" web/components/admin/booking-approval-table.tsx — state variable
    - grep -n "setDetailPanelOpen(true)" web/components/admin/booking-approval-table.tsx — onClick handler
  </verify>
  <done>
    - "View Details" DropdownMenuItem has an onClick that sets selectedDetailBooking and opens the detail panel
    - BookingDetailPanel rendered in the component tree with open/onOpenChange props
    - No existing functionality broken
  </done>
</task>

<task type="auto">
  <name>Task 2: Add What3WordsDisplay and recurring chain to detail panel</name>
  <files>web/components/admin/booking-detail-panel.tsx</files>
  <action>
Update the BookingDetailPanel to use the shared What3WordsDisplay component and add the recurring booking chain query.

**Part A: Integrate What3WordsDisplay**

1. Add import at top:
   ```typescript
   import { What3WordsDisplay } from '@/components/booking/what3words-display';
   ```

2. Find the what3words section in the component (where Plan 09-02 placed an inline `<span>` rendering). Replace the inline `formatWhat3Words` rendering with the What3WordsDisplay component:
   ```typescript
   {booking.what3words_address && (
     <div>
       <p className="text-xs text-gray-400 mb-1">What3Words</p>
       <What3WordsDisplay address={booking.what3words_address} />
     </div>
   )}
   ```
   Remove the `formatWhat3Words` import if it was used only for the inline display — the What3WordsDisplay component handles formatting internally.

**Part B: Add Recurring Booking Chain**

1. Add import for Supabase client:
   ```typescript
   import { createClient } from '@/lib/supabase/client';
   ```

2. Add `useEffect` and `useState` for the recurring chain query. Inside the component, add:
   ```typescript
   const [recurringChain, setRecurringChain] = useState<Array<{
     id: string;
     shift_date: string;
     shift_start_time: string;
     shift_end_time: string;
     status: string;
   }>>([]);
   const [chainLoading, setChainLoading] = useState(false);
   ```

3. Add a `useEffect` that fetches the recurring chain when the panel opens with a recurring booking:
   ```typescript
   useEffect(() => {
     if (!open || !booking?.is_recurring) {
       setRecurringChain([]);
       return;
     }

     async function fetchChain() {
       setChainLoading(true);
       try {
         const supabase = createClient();
         // Resolve root booking: if this is a child, use parent_booking_id; otherwise use this booking's id
         const rootId = booking!.parent_booking_id ?? booking!.id;

         const { data } = await supabase
           .from('bookings')
           .select('id, shift_date, shift_start_time, shift_end_time, status')
           .or(`id.eq.${rootId},parent_booking_id.eq.${rootId}`)
           .order('shift_date', { ascending: true });

         setRecurringChain(data || []);
       } catch (err) {
         console.error('Failed to fetch recurring chain:', err);
       } finally {
         setChainLoading(false);
       }
     }

     fetchChain();
   }, [open, booking?.id, booking?.is_recurring, booking?.parent_booking_id]);
   ```

4. Replace the recurring placeholder section (the div with `id="recurring-chain-container"` from Plan 09-02) with the actual chain view:
   ```typescript
   {booking.is_recurring && (
     <div className="border-b border-gray-700/50 pb-4 mb-4">
       <h3 className="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-3">
         Recurring Chain
       </h3>
       <div className="flex items-center gap-2 mb-3">
         <Badge className="bg-purple-500/20 text-purple-400 border-purple-500/30">
           {booking.recurrence_pattern === 'biweekly' ? 'Bi-weekly' : 'Weekly'}
         </Badge>
         {booking.recurring_until && (
           <span className="text-sm text-gray-400">
             until {new Date(booking.recurring_until).toLocaleDateString('en-GB', {
               day: 'numeric', month: 'short', year: 'numeric'
             })}
           </span>
         )}
       </div>

       {chainLoading ? (
         <p className="text-sm text-gray-500">Loading booking chain...</p>
       ) : recurringChain.length > 0 ? (
         <div className="bg-gray-800/50 rounded-lg border border-gray-700/50 overflow-hidden">
           <table className="w-full text-sm">
             <thead className="bg-gray-800 border-b border-gray-700/50">
               <tr>
                 <th className="text-left p-2 text-xs text-gray-400 font-semibold">Date</th>
                 <th className="text-left p-2 text-xs text-gray-400 font-semibold">Time</th>
                 <th className="text-left p-2 text-xs text-gray-400 font-semibold">Status</th>
               </tr>
             </thead>
             <tbody className="divide-y divide-gray-700/50">
               {recurringChain.map((instance) => {
                 const isCurrentBooking = instance.id === booking.id;
                 const statusColors: Record<string, string> = {
                   pending: 'bg-yellow-500/20 text-yellow-400',
                   confirmed: 'bg-green-500/20 text-green-400',
                   in_progress: 'bg-cyan-500/20 text-cyan-400',
                   completed: 'bg-purple-500/20 text-purple-400',
                   cancelled: 'bg-red-500/20 text-red-400',
                 };
                 const statusLabel: Record<string, string> = {
                   pending: 'Pending',
                   confirmed: 'Confirmed',
                   in_progress: 'In Progress',
                   completed: 'Completed',
                   cancelled: 'Cancelled',
                   pending_payment: 'Pending Payment',
                 };

                 return (
                   <tr
                     key={instance.id}
                     className={isCurrentBooking ? 'bg-blue-500/10' : ''}
                   >
                     <td className="p-2 text-gray-300" suppressHydrationWarning>
                       {new Date(instance.shift_date).toLocaleDateString('en-GB', {
                         day: 'numeric', month: 'short', year: 'numeric'
                       })}
                       {isCurrentBooking && (
                         <span className="ml-2 text-xs text-blue-400">(viewing)</span>
                       )}
                     </td>
                     <td className="p-2 text-gray-400">
                       {instance.shift_start_time?.substring(0, 5)} - {instance.shift_end_time?.substring(0, 5)}
                     </td>
                     <td className="p-2">
                       <Badge className={`text-xs ${statusColors[instance.status] || 'bg-gray-500/20 text-gray-400'}`}>
                         {statusLabel[instance.status] || instance.status}
                       </Badge>
                     </td>
                   </tr>
                 );
               })}
             </tbody>
           </table>
         </div>
       ) : (
         <p className="text-sm text-gray-500">No recurring instances found</p>
       )}

       <p className="text-xs text-gray-500 mt-2">
         {recurringChain.length} booking{recurringChain.length !== 1 ? 's' : ''} in this series
       </p>
     </div>
   )}
   ```

**Important notes:**
- Use `suppressHydrationWarning` on all date-rendered elements (established pattern D-04-03-001)
- The `statusColors` map must match the status badge colors used in booking-approval-table.tsx
- The current booking is highlighted with `bg-blue-500/10` and marked "(viewing)"
- Handle `pending_payment` status from recurring children (pre-existing inconsistency per Research)
- The `.or()` query fetches both parent and children in one query — no N+1 issue
  </action>
  <verify>
    - grep -n "What3WordsDisplay" web/components/admin/booking-detail-panel.tsx — imported and used
    - grep -n "recurringChain" web/components/admin/booking-detail-panel.tsx — state and render
    - grep -n "parent_booking_id" web/components/admin/booking-detail-panel.tsx — chain query logic
    - grep -n "fetchChain" web/components/admin/booking-detail-panel.tsx — useEffect fetch function
    - grep -n "isCurrentBooking" web/components/admin/booking-detail-panel.tsx — current booking highlight
    - cd web && npx tsc --noEmit 2>&1 | grep -i error | head -10 — no TypeScript errors
  </verify>
  <done>
    - View Details button opens BookingDetailPanel with full booking data
    - What3WordsDisplay component renders in admin detail panel
    - Recurring booking chain shows all instances with per-instance status, current booking highlighted
    - Success Criteria 2 fully met: "Admin sees why a booking needed approval and who cancelled it"
    - Success Criteria 3 met: "Recurring booking chain shows all N instances with per-instance status"
    - All 4 success criteria met across all 3 plans
  </done>
</task>

</tasks>

<verification>
1. `grep -n "setDetailPanelOpen\|selectedDetailBooking" web/components/admin/booking-approval-table.tsx` — state wired
2. `grep -n "BookingDetailPanel" web/components/admin/booking-approval-table.tsx` — component imported and rendered
3. `grep -n "What3WordsDisplay" web/components/admin/booking-detail-panel.tsx` — integrated
4. `grep -n "recurringChain\|fetchChain" web/components/admin/booking-detail-panel.tsx` — chain query exists
5. `grep -n "parent_booking_id" web/components/admin/booking-detail-panel.tsx` — root booking resolution
6. `cd web && npx tsc --noEmit 2>&1 | grep -i error | head -10` — no TypeScript errors
</verification>

<success_criteria>
- Clicking "View Details" in admin booking table opens the BookingDetailPanel Sheet
- What3WordsDisplay component renders in admin detail panel (copy + link)
- Recurring chain table shows all instances sorted by date with status badges
- Current booking highlighted in the chain
- TypeScript compiles without errors
- All 4 phase success criteria met:
  1. Client sees special notes and what3words (Plan 09-01)
  2. Admin sees approval reason and cancellation details (Plans 09-02 + 09-03)
  3. Recurring chain shows all instances (Plan 09-03)
  4. Refund amount visible when applicable (Plan 09-02)
</success_criteria>

<output>
After completion, create `.planning/phases/09-booking-data-completeness/09-03-SUMMARY.md`
</output>
