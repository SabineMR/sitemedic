---
phase: 09-booking-data-completeness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/components/booking/what3words-display.tsx
  - web/app/api/bookings/[id]/route.ts
  - web/components/booking/booking-confirmation.tsx
  - web/app/(booking)/book/confirmation/page.tsx
autonomous: true

must_haves:
  truths:
    - "Client sees their special notes on the booking confirmation page"
    - "Client sees their what3words address on the booking confirmation page with copy button and external link"
    - "Recurrence pattern and recurring weeks shown on confirmation when applicable"
  artifacts:
    - path: "web/components/booking/what3words-display.tsx"
      provides: "Read-only what3words display with copy and link"
      contains: "formatWhat3Words"
    - path: "web/app/api/bookings/[id]/route.ts"
      provides: "Booking detail API with what3words_address in response"
      contains: "what3words_address"
    - path: "web/components/booking/booking-confirmation.tsx"
      provides: "Booking confirmation with specialNotes and what3words props"
      contains: "specialNotes"
    - path: "web/app/(booking)/book/confirmation/page.tsx"
      provides: "Confirmation page mapping specialNotes and what3wordsAddress"
      contains: "what3wordsAddress"
  key_links:
    - from: "web/app/api/bookings/[id]/route.ts"
      to: "bookings table"
      via: "what3words_address field in response"
      pattern: "what3words_address.*booking\\.what3words_address"
    - from: "web/app/(booking)/book/confirmation/page.tsx"
      to: "web/components/booking/booking-confirmation.tsx"
      via: "specialNotes and what3wordsAddress props"
      pattern: "specialNotes.*bookingDetail"
    - from: "web/components/booking/booking-confirmation.tsx"
      to: "web/components/booking/what3words-display.tsx"
      via: "What3WordsDisplay component import"
      pattern: "What3WordsDisplay"
---

<objective>
Surface client-facing booking fields (specialNotes, what3words, recurrence info) on the confirmation page, and create a shared What3WordsDisplay component.

Purpose: Clients currently see a booking confirmation that omits their special notes and what3words address — data they entered during booking but never see again. This plan closes that gap.
Output: A reusable What3WordsDisplay component, an API fix to include what3words_address, and an extended confirmation page showing all client-relevant fields.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-booking-data-completeness/09-RESEARCH.md

@web/components/booking/booking-confirmation.tsx
@web/app/(booking)/book/confirmation/page.tsx
@web/app/api/bookings/[id]/route.ts
@web/lib/utils/what3words.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create What3WordsDisplay component and fix API route</name>
  <files>
    web/components/booking/what3words-display.tsx
    web/app/api/bookings/[id]/route.ts
  </files>
  <action>
1. Create `web/components/booking/what3words-display.tsx` — a read-only display component:
   - Import `formatWhat3Words` and `getWhat3WordsMapLink` from `@/lib/utils/what3words` (these already exist, do NOT re-implement)
   - Import `Copy` and `ExternalLink` icons from `lucide-react`
   - Props: `{ address: string }` where address is the raw what3words string (e.g. "filled.count.soap" or "///filled.count.soap")
   - Render: `///word.word.word` formatted text in blue mono font, a copy button using `navigator.clipboard.writeText(formatted)`, and an external link to `getWhat3WordsMapLink(address)` opening in new tab
   - Add a `useState` for copied state that resets after 2 seconds to show "Copied!" feedback
   - Use Tailwind classes consistent with existing component styles: `text-sm font-mono font-semibold text-blue-600`
   - Wrap in a `flex items-center gap-2` div
   - Both buttons should use `aria-label` for accessibility
   - Mark as `'use client'` (uses navigator.clipboard and useState)

2. Fix `web/app/api/bookings/[id]/route.ts` — add `what3words_address` to the response:
   - In the returned JSON object (line ~66-90), add `what3words_address: booking.what3words_address,` after `site_postcode` (around line 72)
   - The booking query already uses `select('*')` which fetches what3words_address from the DB. Only the response mapping is missing.
   - Do NOT modify the query or any other field in the response
  </action>
  <verify>
    - grep -n "what3words_address" web/app/api/bookings/[id]/route.ts — should show the field in the response object
    - grep -n "formatWhat3Words" web/components/booking/what3words-display.tsx — should show import from utils
    - grep -n "navigator.clipboard" web/components/booking/what3words-display.tsx — should show copy functionality
    - grep -n "getWhat3WordsMapLink" web/components/booking/what3words-display.tsx — should show link generation
  </verify>
  <done>
    - what3words-display.tsx exists with formatWhat3Words import, copy button, and external link
    - API route includes what3words_address in its response JSON
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend BookingConfirmation props and confirmation page mapping</name>
  <files>
    web/components/booking/booking-confirmation.tsx
    web/app/(booking)/book/confirmation/page.tsx
  </files>
  <action>
1. Extend `BookingConfirmationProps` in `web/components/booking/booking-confirmation.tsx`:
   - Add to the `booking` interface: `specialNotes?: string | null;` and `what3wordsAddress?: string | null;`
   - Import `What3WordsDisplay` from `./what3words-display`
   - Import `StickyNote` from `lucide-react` (for the special notes icon, or reuse `FileText` which is already imported)
   - After the "Site Location" section (MapPin block, around line 97), add a conditional render for what3words:
     ```
     {booking.what3wordsAddress && (
       <div className="flex items-start gap-3">
         <MapPin className="h-5 w-5 text-slate-500 mt-0.5" />
         <div>
           <p className="font-medium text-slate-900">What3Words Location</p>
           <What3WordsDisplay address={booking.what3wordsAddress} />
         </div>
       </div>
     )}
     ```
   - After the what3words section, add a conditional render for special notes:
     ```
     {booking.specialNotes && (
       <div className="flex items-start gap-3">
         <FileText className="h-5 w-5 text-slate-500 mt-0.5" />
         <div>
           <p className="font-medium text-slate-900">Special Notes</p>
           <p className="text-slate-600 whitespace-pre-wrap">{booking.specialNotes}</p>
         </div>
       </div>
     )}
     ```
   - Use `whitespace-pre-wrap` on special notes to preserve line breaks the client may have entered

2. Update the `fetchedBooking` object in `web/app/(booking)/book/confirmation/page.tsx`:
   - After the existing `recurring_weeks: 0,` line (around line 121), add:
     ```
     specialNotes: bookingDetail.booking.special_notes || null,
     what3wordsAddress: bookingDetail.booking.what3words_address || null,
     ```
   - The API route (fixed in Task 1) now returns `what3words_address` and already returns `special_notes`
   - Do NOT change the recurrence_pattern or recurring_weeks mapping — they already work correctly
  </action>
  <verify>
    - grep -n "specialNotes" web/components/booking/booking-confirmation.tsx — should show in props interface and render
    - grep -n "what3wordsAddress" web/components/booking/booking-confirmation.tsx — should show in props interface and render
    - grep -n "What3WordsDisplay" web/components/booking/booking-confirmation.tsx — should show import
    - grep -n "specialNotes" web/app/(booking)/book/confirmation/page.tsx — should show mapping from bookingDetail
    - grep -n "what3wordsAddress" web/app/(booking)/book/confirmation/page.tsx — should show mapping from bookingDetail
    - cd web && npx tsc --noEmit --pretty 2>&1 | head -30 — TypeScript should compile without errors related to these files
  </verify>
  <done>
    - BookingConfirmation renders specialNotes (conditional, with whitespace-pre-wrap) and what3words (with What3WordsDisplay component)
    - Confirmation page maps specialNotes and what3wordsAddress from API response to BookingConfirmation props
    - Success Criteria 1 met: "Client sees their special notes and what3words address on booking confirmation"
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "what3words_address" web/app/api/bookings/[id]/route.ts` — field present in response
2. `grep -rn "specialNotes\|what3wordsAddress" web/components/booking/booking-confirmation.tsx` — both fields in component
3. `grep -rn "What3WordsDisplay" web/components/booking/` — component exists and is imported
4. `ls web/components/booking/what3words-display.tsx` — file exists
5. `cd web && npx tsc --noEmit 2>&1 | grep -i error | head -10` — no TypeScript errors
</verification>

<success_criteria>
- What3WordsDisplay component exists at web/components/booking/what3words-display.tsx with copy + link functionality
- API route /api/bookings/[id] includes what3words_address in response
- BookingConfirmation shows specialNotes and what3wordsAddress when present
- Confirmation page maps both fields from API response
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-booking-data-completeness/09-01-SUMMARY.md`
</output>
