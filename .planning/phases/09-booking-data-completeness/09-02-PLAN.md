---
phase: 09-booking-data-completeness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/lib/queries/admin/bookings.ts
  - web/components/admin/booking-detail-panel.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees site contact name and phone in booking detail view"
    - "Admin sees approval reason when a booking required manual approval"
    - "Admin sees cancellation reason and who cancelled (when applicable)"
    - "Admin sees refund amount only when refund is greater than zero"
  artifacts:
    - path: "web/lib/queries/admin/bookings.ts"
      provides: "BookingWithRelations type with what3words_address field"
      contains: "what3words_address"
    - path: "web/components/admin/booking-detail-panel.tsx"
      provides: "Admin booking detail Sheet component"
      contains: "BookingDetailPanel"
  key_links:
    - from: "web/components/admin/booking-detail-panel.tsx"
      to: "web/lib/queries/admin/bookings.ts"
      via: "BookingWithRelations type import"
      pattern: "import.*BookingWithRelations"
    - from: "web/components/admin/booking-detail-panel.tsx"
      to: "approval_reason"
      via: "conditional render"
      pattern: "booking\\.approval_reason"
    - from: "web/components/admin/booking-detail-panel.tsx"
      to: "refund_amount"
      via: "conditional render when > 0"
      pattern: "refund_amount.*>.*0"
---

<objective>
Create the admin booking detail panel (Sheet slide-over) that surfaces all operational fields: site contact info, approval reason, cancellation details, and refund amount.

Purpose: Admins currently have a "View Details" dropdown option that does nothing. This plan creates the detail panel that shows the full operational context for every booking — why it needed approval, who cancelled it, and how to contact the site.
Output: A BookingDetailPanel Sheet component and the BookingWithRelations type fix.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-booking-data-completeness/09-RESEARCH.md

@web/lib/queries/admin/bookings.ts
@web/components/admin/booking-approval-table.tsx
@web/components/ui/sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix BookingWithRelations type</name>
  <files>web/lib/queries/admin/bookings.ts</files>
  <action>
Add `what3words_address: string | null;` to the `BookingWithRelations` interface.

Insert it after `site_postcode: string;` (line 22) and before `site_contact_name: string | null;` (line 23). The field is already fetched by the query via `select('*')` — only the TypeScript type is missing.

The line to add:
```
  what3words_address: string | null;
```

Do NOT change any other field in the interface. Do NOT change any query or hook logic.
  </action>
  <verify>
    - grep -n "what3words_address" web/lib/queries/admin/bookings.ts — should show the field in the interface
  </verify>
  <done>BookingWithRelations type includes what3words_address field, enabling TypeScript-safe access in admin components.</done>
</task>

<task type="auto">
  <name>Task 2: Create BookingDetailPanel Sheet component</name>
  <files>web/components/admin/booking-detail-panel.tsx</files>
  <action>
Create `web/components/admin/booking-detail-panel.tsx` — an admin booking detail panel using shadcn Sheet (slide-over from right).

**Component signature:**
```typescript
interface BookingDetailPanelProps {
  booking: BookingWithRelations | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}
```

**Implementation details:**

1. Mark as `'use client'`
2. Import `Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription` from `@/components/ui/sheet`
3. Import `BookingWithRelations` from `@/lib/queries/admin/bookings`
4. Import `Badge` from `@/components/ui/badge`
5. Import icons from `lucide-react`: `MapPin, Phone, User, Calendar, Clock, FileText, AlertTriangle, XCircle, DollarSign, Building2`
6. Import `CurrencyWithTooltip` from `@/components/CurrencyWithTooltip` (already used in booking-approval-table.tsx)

**Sheet structure — render these sections in order:**

a. **Header** (always shown):
   - Site name as SheetTitle
   - Status badge (reuse the same color scheme as booking-approval-table.tsx status column)
   - Booking ID in small text

b. **Date & Time** section:
   - Shift date formatted with `toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })` with `suppressHydrationWarning`
   - Start time - End time (shift_start_time/shift_end_time, slice to HH:MM)
   - Shift hours

c. **Site Details** section:
   - Site address + postcode
   - Site contact name (conditional: `booking.site_contact_name && ...`)
   - Site contact phone (conditional: `booking.site_contact_phone && ...`, render as `<a href="tel:...">` link)
   - What3Words address (conditional: `booking.what3words_address && ...`). For now, render it inline as a `<span className="font-mono text-sm text-blue-400">///word.word.word</span>` — the What3WordsDisplay component from Plan 09-01 will be integrated in Plan 09-03. Use `formatWhat3Words` from `@/lib/utils/what3words` which is a pure function (no API call, safe to import).

d. **Client & Medic** section:
   - Client company name from `booking.clients?.company_name`
   - Medic name from `booking.medics?.first_name + ' ' + booking.medics?.last_name` or "Unassigned"
   - Auto-matched badge if `booking.auto_matched`
   - Match score if `booking.match_score`

e. **Pricing** section:
   - Total, platform fee, medic payout using CurrencyWithTooltip
   - Travel surcharge (conditional, only if > 0)
   - Urgency premium (conditional, only if > 0)

f. **Approval Details** section (conditional: show section header + content only if `booking.requires_manual_approval`):
   - `booking.approval_reason` in a blue info box (`bg-blue-500/10 border border-blue-500/20 rounded-lg p-3`)
   - `booking.approved_by` and `booking.approved_at` if present

g. **Cancellation Details** section (conditional: show only if `booking.status === 'cancelled'`):
   - `booking.cancellation_reason` in a red info box (`bg-red-500/10 border border-red-500/20 rounded-lg p-3`)
   - `booking.cancelled_by` rendered as plain text (it may be a name or ID — render as-is per Research recommendation)
   - `booking.cancelled_at` formatted date

h. **Refund** section (conditional: show ONLY if `booking.refund_amount > 0`):
   - Refund amount with green text: `text-green-400`
   - Do NOT show this section when refund_amount is 0 (the DB default — showing GBP 0.00 is confusing)

i. **Special Notes** section (conditional: `booking.special_notes && ...`):
   - Render with `whitespace-pre-wrap` to preserve line breaks

j. **Recurring Info** section (conditional: `booking.is_recurring`):
   - Show recurrence pattern label ("Weekly" or "Bi-weekly")
   - Show recurring_until date if present
   - A placeholder div with `id="recurring-chain-container"` and text "Loading recurring chain..." — Plan 09-03 will replace this with the actual chain query

**Styling rules:**
- Use dark theme consistent with booking-approval-table.tsx: `bg-gray-900`, `text-white`, `text-gray-400` for labels
- Sheet should be `side="right"` with `className="w-[500px] sm:w-[600px] bg-gray-900 border-gray-700 overflow-y-auto"`
- Each section separated by `border-b border-gray-700/50 pb-4 mb-4`
- Section headers: `text-xs font-semibold uppercase tracking-wider text-gray-400 mb-3`
- Return early with `null` if `!booking`

**Export:** `export function BookingDetailPanel({ booking, open, onOpenChange }: BookingDetailPanelProps)`
  </action>
  <verify>
    - ls web/components/admin/booking-detail-panel.tsx — file exists
    - grep -n "BookingDetailPanel" web/components/admin/booking-detail-panel.tsx — component exported
    - grep -n "SheetContent" web/components/admin/booking-detail-panel.tsx — uses Sheet component
    - grep -n "approval_reason" web/components/admin/booking-detail-panel.tsx — renders approval reason
    - grep -n "cancellation_reason" web/components/admin/booking-detail-panel.tsx — renders cancellation reason
    - grep -n "refund_amount.*>" web/components/admin/booking-detail-panel.tsx — conditional refund render
    - grep -n "site_contact_name" web/components/admin/booking-detail-panel.tsx — renders site contact
    - grep -n "site_contact_phone" web/components/admin/booking-detail-panel.tsx — renders site phone
    - cd web && npx tsc --noEmit 2>&1 | grep -i "booking-detail-panel" | head -5 — no TS errors in this file
  </verify>
  <done>
    - BookingDetailPanel Sheet component exists with all admin-facing fields
    - Approval reason shown conditionally when booking requires manual approval
    - Cancellation details shown only for cancelled bookings
    - Refund amount shown only when > 0
    - Site contact name and phone shown when present
    - Success Criteria 2 partially met (panel exists, wiring in Plan 09-03)
    - Success Criteria 4 met: "Refund amount visible in admin view when applicable"
  </done>
</task>

</tasks>

<verification>
1. `grep -n "what3words_address" web/lib/queries/admin/bookings.ts` — type field exists
2. `ls web/components/admin/booking-detail-panel.tsx` — component file exists
3. `grep -n "refund_amount.*>" web/components/admin/booking-detail-panel.tsx` — conditional render
4. `grep -n "site_contact_name\|site_contact_phone" web/components/admin/booking-detail-panel.tsx` — both fields rendered
5. `grep -n "approval_reason\|cancellation_reason" web/components/admin/booking-detail-panel.tsx` — both fields rendered
</verification>

<success_criteria>
- BookingWithRelations includes what3words_address field
- BookingDetailPanel component renders all admin fields: site_contact_name, site_contact_phone, approval_reason, cancellation_reason, cancelled_by, refund_amount
- Refund amount only shown when > 0
- Approval and cancellation sections only shown when relevant
- Dark theme consistent with existing admin UI
</success_criteria>

<output>
After completion, create `.planning/phases/09-booking-data-completeness/09-02-SUMMARY.md`
</output>
