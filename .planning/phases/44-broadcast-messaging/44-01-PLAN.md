---
phase: 44-broadcast-messaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/151_broadcast_indexes.sql
  - web/app/api/messages/broadcast/route.ts
  - web/types/comms.types.ts
  - web/lib/queries/comms.ts
  - web/app/(dashboard)/messages/components/BroadcastComposeDialog.tsx
  - web/app/(dashboard)/messages/components/ConversationRow.tsx
  - web/app/(dashboard)/messages/components/ConversationList.tsx
  - web/app/(dashboard)/messages/components/MessageThread.tsx
  - web/app/(dashboard)/messages/page.tsx
  - web/app/(dashboard)/messages/[conversationId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can compose and send a broadcast message delivered to every medic in the org"
    - "Each medic sees broadcast messages in their conversation list as a distinct Broadcast channel with a Radio icon and Broadcast badge"
    - "Medics cannot reply to broadcasts -- MessageInput is hidden for medics viewing the broadcast conversation"
    - "Broadcast messages trigger real-time delivery via existing Realtime subscription and push notifications via existing Edge Function"
    - "Only one broadcast conversation per org exists (partial unique index prevents duplicates)"
  artifacts:
    - path: "supabase/migrations/151_broadcast_indexes.sql"
      provides: "Partial unique index for broadcast conversation per org + read tracking index"
      contains: "idx_conversations_org_broadcast"
    - path: "web/app/api/messages/broadcast/route.ts"
      provides: "POST endpoint for sending broadcasts"
      exports: ["POST"]
    - path: "web/app/(dashboard)/messages/components/BroadcastComposeDialog.tsx"
      provides: "Admin broadcast compose dialog with confirmation"
      min_lines: 50
    - path: "web/lib/queries/comms.ts"
      provides: "fetchConversationsWithUnread includes broadcast type"
      contains: "broadcast"
    - path: "web/app/(dashboard)/messages/components/ConversationRow.tsx"
      provides: "Broadcast type visual distinction"
      contains: "broadcast"
    - path: "web/app/(dashboard)/messages/components/MessageThread.tsx"
      provides: "Conditional MessageInput hidden for medic on broadcast"
      contains: "broadcast"
  key_links:
    - from: "web/app/(dashboard)/messages/components/BroadcastComposeDialog.tsx"
      to: "/api/messages/broadcast"
      via: "fetch POST on send"
      pattern: "fetch.*api/messages/broadcast"
    - from: "web/app/api/messages/broadcast/route.ts"
      to: "supabase.from('message_recipients')"
      via: "bulk insert recipient rows for all medics"
      pattern: "message_recipients.*insert"
    - from: "web/lib/queries/comms.ts"
      to: "conversations query"
      via: ".in('type', ['direct', 'broadcast'])"
      pattern: "in.*type.*direct.*broadcast"
---

<objective>
Build the broadcast send and delivery pipeline: migration for unique index, dedicated broadcast API route, admin compose UI with confirmation, and adapt the existing conversation list and message thread to handle the broadcast conversation type.

Purpose: This is the first half of Phase 44 -- getting broadcasts sent and visible. The admin can compose and send, medics see broadcasts arrive in real-time, and the conversation list distinguishes broadcast from direct conversations.

Output: Working broadcast send flow from admin compose to medic delivery, leveraging existing Realtime and push notification infrastructure.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-broadcast-messaging/44-CONTEXT.md
@.planning/phases/44-broadcast-messaging/44-RESEARCH.md

Key source files to reference:
@web/types/comms.types.ts
@web/lib/queries/comms.ts
@web/lib/queries/comms.hooks.ts
@web/app/api/messages/send/route.ts
@web/app/api/messages/conversations/route.ts
@web/app/(dashboard)/messages/page.tsx
@web/app/(dashboard)/messages/[conversationId]/page.tsx
@web/app/(dashboard)/messages/components/ConversationRow.tsx
@web/app/(dashboard)/messages/components/ConversationList.tsx
@web/app/(dashboard)/messages/components/MessageThread.tsx
@web/app/(dashboard)/messages/components/MessageItem.tsx
@web/app/(dashboard)/messages/components/EmptyState.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migration + broadcast API route + type updates</name>
  <files>
    supabase/migrations/151_broadcast_indexes.sql
    web/app/api/messages/broadcast/route.ts
    web/types/comms.types.ts
    web/lib/queries/comms.ts
  </files>
  <action>
    **1. Create migration `supabase/migrations/151_broadcast_indexes.sql`:**
    - Add partial unique index to prevent duplicate broadcast conversations per org:
      ```sql
      CREATE UNIQUE INDEX idx_conversations_org_broadcast
        ON conversations(org_id) WHERE type = 'broadcast';
      ```
    - Add composite index for read tracking queries (used by Plan 02 but best to add now):
      ```sql
      CREATE INDEX idx_message_recipients_message_read
        ON message_recipients(message_id, read_at);
      ```

    **2. Create `web/app/api/messages/broadcast/route.ts` (POST handler):**
    - Follow the same pattern as existing `/api/messages/send/route.ts` and `/api/messages/conversations/route.ts`
    - Use `requireOrgId()` from `@/lib/organizations/org-resolver` and `createClient()` from `@/lib/supabase/server`
    - Set `export const dynamic = 'force-dynamic'`
    - Auth check: verify user exists, get orgId, verify role is `org_admin` (return 403 if medic)
    - Parse body: `{ content: string }`. Validate content is non-empty string, max 5000 chars, trim it
    - Get-or-create broadcast conversation (single per org):
      1. SELECT from `conversations` WHERE `org_id = orgId` AND `type = 'broadcast'` using `.maybeSingle()`
      2. If not found, INSERT with `{ org_id: orgId, type: 'broadcast', created_by: user.id, medic_id: null }`
      3. Handle 23505 unique violation by falling back to SELECT (same pattern as `/api/messages/conversations/route.ts`)
    - Insert message into `messages` table: `{ conversation_id, org_id: orgId, sender_id: user.id, message_type: 'text', content: trimmedContent, status: 'sent' }`
    - Fetch all medics in org: `supabase.from('medics').select('user_id').eq('org_id', orgId)` -- NO filtering by available_for_work
    - Bulk insert `message_recipients` rows: one row per medic with `{ message_id: message.id, recipient_id: medic.user_id, org_id: orgId }`. This is critical -- without it, read tracking in Plan 02 will not work
    - Update conversation metadata: `last_message_at` and `last_message_preview` (truncated to 100 chars), same pattern as `/api/messages/send/route.ts`
    - Upsert sender's own `conversation_read_status` so admin doesn't see unread badge for own broadcasts
    - Return `{ conversationId, messageId, recipientCount }` with status 201
    - NOTE: The existing `on_message_insert_notify` DB trigger (migration 150) fires automatically on the message INSERT, which calls the `send-message-notification` Edge Function. That Edge Function already handles `conversation.type === 'broadcast'` for multi-recipient push delivery. No push notification code needed here.

    **3. Update `web/types/comms.types.ts`:**
    - Add a `BroadcastRecipientDetail` type below the existing `BroadcastReadSummary`:
      ```typescript
      /** Individual recipient detail for broadcast drilldown (admin view) */
      export interface BroadcastRecipientDetail {
        recipient_id: string;
        name: string;
        read_at: string | null;
        status: 'read' | 'unread';
      }
      ```

    **4. Update `web/lib/queries/comms.ts` -- `ConversationListItem` type and `fetchConversationsWithUnread`:**
    - Change `ConversationListItem.type` from `'direct'` to `'direct' | 'broadcast'`
    - Change `ConversationListItem.participant_role` from `'medic' | 'admin'` to `'medic' | 'admin' | 'broadcast'`
    - In `fetchConversationsWithUnread`, change the conversations query from `.eq('type', 'direct')` to `.in('type', ['direct', 'broadcast'])`
    - In the participant name resolution block (the `conversations.map` at the end), add a broadcast branch BEFORE the existing medic/admin logic:
      ```typescript
      if (conv.type === 'broadcast') {
        participantName = 'Broadcasts';
        participantRole = 'broadcast';
      } else if (userRole === 'medic') {
        // ... existing medic logic
      } else {
        // ... existing admin logic
      }
      ```
    - Update the return statement's `type` field: change `type: 'direct' as const` to `type: conv.type as 'direct' | 'broadcast'`
  </action>
  <verify>
    - `pnpm --filter web build` compiles without TypeScript errors
    - Migration file exists at `supabase/migrations/151_broadcast_indexes.sql` with both indexes
    - API route file exists at `web/app/api/messages/broadcast/route.ts` with POST export
    - `grep -r "broadcast" web/lib/queries/comms.ts` shows type union and `.in('type', ['direct', 'broadcast'])`
    - `grep "BroadcastRecipientDetail" web/types/comms.types.ts` confirms new type exists
  </verify>
  <done>
    - Migration 151 creates partial unique index on conversations(org_id) WHERE type='broadcast' and composite index on message_recipients(message_id, read_at)
    - POST /api/messages/broadcast creates broadcast conversation (if not exists), inserts message, bulk-inserts message_recipients for all org medics, updates conversation metadata
    - ConversationListItem type supports both 'direct' and 'broadcast' types
    - fetchConversationsWithUnread includes broadcast conversations with participant_name='Broadcasts'
  </done>
</task>

<task type="auto">
  <name>Task 2: Broadcast compose UI + conversation list/thread adaptations</name>
  <files>
    web/app/(dashboard)/messages/components/BroadcastComposeDialog.tsx
    web/app/(dashboard)/messages/components/ConversationRow.tsx
    web/app/(dashboard)/messages/components/ConversationList.tsx
    web/app/(dashboard)/messages/components/MessageThread.tsx
    web/app/(dashboard)/messages/page.tsx
    web/app/(dashboard)/messages/[conversationId]/page.tsx
  </files>
  <action>
    **1. Create `web/app/(dashboard)/messages/components/BroadcastComposeDialog.tsx`:**
    - 'use client' component
    - Props: `{ medicCount: number }` -- total active medics in org (displayed in confirmation)
    - Uses shadcn/ui `Dialog` for compose and `AlertDialog` for send confirmation (import from `@/components/ui/dialog` and `@/components/ui/alert-dialog`)
    - State: `open` (dialog open), `content` (textarea value), `showConfirm` (confirmation dialog), `sending` (loading state)
    - Dialog trigger: `<Button size="sm" variant="outline">` with `<Radio className="h-4 w-4 mr-1" />` icon and text "Broadcast"
    - Dialog content: title "Send Broadcast", textarea (4 rows, placeholder "Type your broadcast message...", className "w-full rounded-md border px-3 py-2 text-sm")
    - Below textarea: left side shows "Will be sent to {medicCount} medic(s)" in `text-xs text-muted-foreground`, right side shows Send button with `<Send className="h-4 w-4 mr-1" />` icon, disabled when content is empty
    - On Send click: show AlertDialog confirmation with title "Send to {medicCount} medics?", description "This broadcast will be delivered to all medics in your organisation. This action cannot be undone."
    - On confirm: POST to `/api/messages/broadcast` with `{ content: content.trim() }`, on success extract `conversationId` from response, clear state, close dialogs, `router.push(\`/messages/${conversationId}\`)` (import useRouter from next/navigation)
    - Show `Loader2` spinner on confirm button while sending
    - Import: `Radio, Send, Loader2` from `lucide-react`

    **2. Modify `web/app/(dashboard)/messages/components/ConversationRow.tsx`:**
    - Import `Radio` from `lucide-react` and `Badge` is already imported
    - In the avatar section, add a conditional: if `conversation.type === 'broadcast'`, render a `div` with `className="flex-shrink-0 w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center"` containing `<Radio className="h-5 w-5 text-blue-600" />`. Otherwise render the existing initial-based avatar
    - After the participant name `<span>`, add: if `conversation.type === 'broadcast'`, render `<Badge variant="secondary" className="text-[10px] ml-1">Broadcast</Badge>`
    - In the role indicator at the bottom, add broadcast handling: if `conversation.participant_role === 'broadcast'`, show nothing (or hide the role indicator entirely for broadcasts since "Broadcast" badge already identifies it). Use a conditional: `{conversation.participant_role !== 'broadcast' && (<span className="text-[10px]...">...</span>)}`

    **3. Modify `web/app/(dashboard)/messages/components/ConversationList.tsx`:**
    - No structural changes needed. The existing filter on `participant_name` will work for broadcasts (searching "Broadcast" will match). The ConversationRow already receives the full conversation object. Realtime subscription (useRealtimeMessages) already listens for message INSERTs on the org -- broadcast messages will trigger cache invalidation automatically.

    **4. Modify `web/app/(dashboard)/messages/components/MessageThread.tsx`:**
    - Add new props: `conversationType?: 'direct' | 'broadcast'` and `userRole?: string`
    - At the bottom where `<MessageInput>` is rendered, wrap it in a conditional:
      ```tsx
      {conversationType === 'broadcast' && userRole === 'medic' ? (
        <div className="px-4 py-3 border-t bg-muted/50 text-center text-sm text-muted-foreground">
          Broadcast messages are read-only
        </div>
      ) : (
        <MessageInput conversationId={conversationId} onMessageSent={handleMessageSent} />
      )}
      ```
    - This means: medics see "Broadcast messages are read-only" instead of the input. Admins still see MessageInput so they can send additional broadcasts directly from the thread (these go through the regular send API and appear in the broadcast conversation -- which is fine since admin is the only sender).
    - IMPORTANT: Actually, for admin sending from the thread, the regular `/api/messages/send` route does NOT create `message_recipients` rows. So admin should use the broadcast compose dialog for subsequent broadcasts too. Change the conditional to hide MessageInput for ALL users when `conversationType === 'broadcast'`, and show a different message for admin vs medic:
      ```tsx
      {conversationType === 'broadcast' ? (
        <div className="px-4 py-3 border-t bg-muted/50 text-center text-sm text-muted-foreground">
          {userRole === 'org_admin'
            ? 'Use the Broadcast button to send a new broadcast'
            : 'Broadcast messages are read-only'}
        </div>
      ) : (
        <MessageInput conversationId={conversationId} onMessageSent={handleMessageSent} />
      )}
      ```

    **5. Modify `web/app/(dashboard)/messages/page.tsx` (messages list page):**
    - Fetch medic count for BroadcastComposeDialog: add a Supabase query `supabase.from('medics').select('id', { count: 'exact', head: true }).eq('org_id', orgId)` to get the count. Can be done in parallel with fetchConversationsWithUnread.
    - Import `BroadcastComposeDialog` from `./components/BroadcastComposeDialog`
    - In the header bar (the `<div className="p-4 border-b flex items-center justify-between">`), add the BroadcastComposeDialog next to the MedicPicker, but only for `org_admin` role:
      ```tsx
      <div className="flex items-center gap-2">
        {role === 'org_admin' && <BroadcastComposeDialog medicCount={medicCount} />}
        <MedicPicker ... />
      </div>
      ```
    - Pass orgId to the medic count query. Extract `count` from the result.

    **6. Modify `web/app/(dashboard)/messages/[conversationId]/page.tsx` (conversation thread page):**
    - Fetch medic count (same query as above) in the parallel Promise.all
    - Import `BroadcastComposeDialog`
    - Add BroadcastComposeDialog next to MedicPicker in the sidebar header (same pattern as messages/page.tsx), only for `org_admin` role
    - Pass `conversationType={conversation.type}` and `userRole={role}` as new props to `<MessageThread>`
    - For the `participantName`, handle broadcast: if `conversation.type === 'broadcast'`, set participantName to 'Broadcasts' (it may already come from the conversations list, but the thread page also needs it when the conversation isn't in the sidebar list)
    - Get `role` from `user?.app_metadata?.role`
  </action>
  <verify>
    - `pnpm --filter web build` compiles without TypeScript errors
    - `grep -r "BroadcastComposeDialog" web/app/\(dashboard\)/messages/` shows import and usage in both page.tsx files
    - `grep "broadcast" web/app/\(dashboard\)/messages/components/ConversationRow.tsx` shows broadcast type handling
    - `grep "broadcast" web/app/\(dashboard\)/messages/components/MessageThread.tsx` shows conditional MessageInput hiding
    - `grep "Radio" web/app/\(dashboard\)/messages/components/ConversationRow.tsx` shows lucide icon import
  </verify>
  <done>
    - BroadcastComposeDialog renders a "Broadcast" button (org_admin only) that opens a compose dialog with textarea and confirmation step showing "Send to X medics?"
    - ConversationRow shows Radio icon + blue avatar + "Broadcast" badge for broadcast conversations, hides role indicator
    - MessageThread hides MessageInput for broadcast conversations (admin sees "Use the Broadcast button", medic sees "Broadcast messages are read-only")
    - Both messages/page.tsx and messages/[conversationId]/page.tsx render BroadcastComposeDialog for org_admin users
    - Broadcast messages appear in real-time via existing Realtime subscription (no changes needed to useRealtimeMessages)
  </done>
</task>

</tasks>

<verification>
1. As org_admin: click "Broadcast" button, type a message, confirm send -- message appears in a "Broadcasts" conversation in the list
2. As medic: broadcast conversation appears in conversation list with Radio icon and "Broadcast" badge
3. As medic: opening the broadcast conversation shows messages but NO message input (read-only notice visible)
4. As org_admin: broadcast conversation shows messages but NO inline message input (notice to use Broadcast button)
5. Sending a second broadcast adds to the same conversation (no duplicate conversations created)
6. Real-time: open medic view in separate tab, send broadcast from admin -- message appears instantly without refresh
7. `pnpm --filter web build` passes with no TypeScript errors
</verification>

<success_criteria>
- Org admin can compose and send broadcasts to all medics via dedicated API route
- Broadcasts appear in conversation list with distinct visual treatment (Radio icon, blue avatar, Broadcast badge)
- Single broadcast conversation per org (partial unique index enforced)
- Medics cannot reply to broadcasts (MessageInput hidden)
- Real-time delivery works via existing Supabase Realtime subscription
- Push notifications fire via existing Edge Function trigger
- message_recipients rows created for every medic on each broadcast send
</success_criteria>

<output>
After completion, create `.planning/phases/44-broadcast-messaging/44-01-SUMMARY.md`
</output>
