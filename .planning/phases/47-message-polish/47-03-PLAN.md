---
phase: 47-message-polish
plan: 03
type: execute
wave: 2
depends_on: ["47-01"]
files_modified:
  - web/app/api/messages/attachments/upload/route.ts
  - web/app/api/messages/attachments/download/route.ts
  - web/app/(dashboard)/messages/components/AttachmentPicker.tsx
  - web/app/(dashboard)/messages/components/MessageAttachment.tsx
  - web/app/(dashboard)/messages/components/MessageInput.tsx
  - web/app/(dashboard)/messages/components/MessageItem.tsx
  - web/types/comms.types.ts
autonomous: true

must_haves:
  truths:
    - "Users can click an attachment button in the message input area, select a file, and send it as a message"
    - "The attachment is uploaded to the message-attachments Supabase Storage bucket and appears inline in the conversation thread"
    - "The recipient can download the attached file via a download link in the message"
    - "Image attachments show a thumbnail preview; document attachments show a file icon with filename and size"
    - "Optional text content can be sent alongside an attachment (caption)"
    - "File validation prevents uploads over 10MB and restricts to allowed MIME types (PDF, JPEG, PNG, Word docs)"
  artifacts:
    - path: "web/app/api/messages/attachments/upload/route.ts"
      provides: "File upload endpoint that stores in message-attachments bucket and creates attachment message"
      exports: ["POST"]
    - path: "web/app/api/messages/attachments/download/route.ts"
      provides: "Signed URL generation for file download"
      exports: ["GET"]
    - path: "web/app/(dashboard)/messages/components/AttachmentPicker.tsx"
      provides: "File selection button and pending attachment preview"
      exports: ["AttachmentPicker"]
    - path: "web/app/(dashboard)/messages/components/MessageAttachment.tsx"
      provides: "Inline attachment display in message thread with download link"
      exports: ["MessageAttachment"]
    - path: "web/app/(dashboard)/messages/components/MessageInput.tsx"
      provides: "Message input with integrated attachment picker"
      contains: "AttachmentPicker"
    - path: "web/app/(dashboard)/messages/components/MessageItem.tsx"
      provides: "Message row rendering attachment messages with MessageAttachment"
      contains: "MessageAttachment"
  key_links:
    - from: "web/app/(dashboard)/messages/components/MessageInput.tsx"
      to: "/api/messages/attachments/upload"
      via: "FormData POST on send with file"
      pattern: "api/messages/attachments/upload"
    - from: "web/app/(dashboard)/messages/components/MessageAttachment.tsx"
      to: "/api/messages/attachments/download"
      via: "fetch signed URL for download"
      pattern: "api/messages/attachments/download"
    - from: "web/app/api/messages/attachments/upload/route.ts"
      to: "message-attachments bucket"
      via: "supabase.storage.from('message-attachments').upload()"
      pattern: "message-attachments"
---

<objective>
Add file attachment support to messages. Users can attach a file (PDF, image, Word doc) to a message via an attachment button in the compose area. The file is uploaded to the existing message-attachments Supabase Storage bucket, a message with type 'attachment' is created with metadata containing file info, and the attachment appears inline in the conversation thread with a thumbnail (images) or file icon (documents) and a download link. Optional text can accompany the attachment.

Purpose: Enables sharing of compliance documents, photos, and files within the messaging system -- critical for a medical workforce management platform where document exchange is frequent.
Output: Upload API route, download API route, AttachmentPicker component, MessageAttachment display component, MessageInput and MessageItem modifications.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-message-polish/47-RESEARCH.md

# Reference: existing document upload pattern from Phase 45
@web/app/api/documents/upload/route.ts

# Existing files to modify
@web/app/(dashboard)/messages/components/MessageInput.tsx
@web/app/(dashboard)/messages/components/MessageItem.tsx
@web/types/comms.types.ts
@web/app/api/messages/send/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upload and download API routes + attachment type</name>
  <files>
    web/app/api/messages/attachments/upload/route.ts
    web/app/api/messages/attachments/download/route.ts
    web/types/comms.types.ts
  </files>
  <action>
**Attachment metadata type (comms.types.ts):**

Add to `web/types/comms.types.ts`:
```typescript
/** Attachment metadata stored in messages.metadata JSONB */
export interface AttachmentMetadata {
  attachment: {
    storage_path: string;
    file_name: string;
    file_size_bytes: number;
    mime_type: string;
  };
}
```

**Upload API route (POST /api/messages/attachments/upload):**

Create `web/app/api/messages/attachments/upload/route.ts`:
- Follow the same FormData upload pattern as `/api/documents/upload/route.ts` from Phase 45
- Accept FormData with: `file` (required), `conversationId` (required), `content` (optional text caption)
- Export `dynamic = 'force-dynamic'`
- Set Next.js route segment config to allow larger body: `export const config = { api: { bodyParser: { sizeLimit: '11mb' } } }` -- OR use Next.js App Router equivalent: `export const maxDuration = 60;` (the App Router doesn't use bodyParser config, FormData parsing handles size via the runtime)
- ALLOWED_MIME_TYPES: `['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']`
- MAX_FILE_SIZE: `10 * 1024 * 1024` (10MB)
- Authenticate user and get orgId via `requireOrgId()`
- Validate: file type in allowed list, file size under limit, conversationId provided
- Verify conversation exists and belongs to user's org (same check as send route)
- Build storage path: `${orgId}/${conversationId}/${Date.now()}-${crypto.randomUUID().slice(0, 8)}-${sanitizedFileName}` (includes UUID fragment to prevent collisions, matching Phase 45 pattern)
- Sanitize filename: `file.name.replace(/[^a-zA-Z0-9._-]/g, '_')`
- Upload to message-attachments bucket: `supabase.storage.from('message-attachments').upload(storagePath, await file.arrayBuffer(), { contentType: file.type })`
- On upload success, insert message record:
```typescript
const { data: message, error: msgError } = await supabase
  .from('messages')
  .insert({
    conversation_id: conversationId,
    org_id: orgId,
    sender_id: user.id,
    message_type: 'attachment',
    content: captionText || null,
    metadata: {
      attachment: {
        storage_path: storagePath,
        file_name: file.name,
        file_size_bytes: file.size,
        mime_type: file.type,
      },
    },
    status: 'sent',
  })
  .select()
  .single();
```
- Update conversation metadata (last_message_at, last_message_preview) -- preview should show file icon emoji + filename: `last_message_preview: `ðŸ“Ž ${file.name}`.substring(0, 100)`
- Upsert sender's read status (same as send route)
- Return 201 with message record

**Download API route (GET /api/messages/attachments/download):**

Create `web/app/api/messages/attachments/download/route.ts`:
- Accept GET with query param: `path` (storage path from message metadata)
- Authenticate user and get orgId via `requireOrgId()`
- Validate that the storage path starts with the user's orgId (security: prevent cross-org download)
- Generate signed URL: `supabase.storage.from('message-attachments').createSignedUrl(path, 3600)` (1-hour expiry)
- Return `{ url: signedUrlData.signedUrl, fileName: extractedFileName }`
- Extract fileName from the storage path (last segment after the UUID prefix)
  </action>
  <verify>
- Upload route exists at `web/app/api/messages/attachments/upload/route.ts`
- Download route exists at `web/app/api/messages/attachments/download/route.ts`
- `pnpm build` succeeds
- AttachmentMetadata type exported from comms.types.ts
  </verify>
  <done>
- Upload endpoint accepts FormData with file + conversationId + optional caption
- File stored in message-attachments bucket with collision-resistant path
- Attachment message created with type='attachment' and metadata JSONB containing file info
- Download endpoint generates 1-hour signed URL for file retrieval
- Cross-org access prevented by validating storage path prefix matches user's orgId
  </done>
</task>

<task type="auto">
  <name>Task 2: Attachment UI components and MessageInput/MessageItem integration</name>
  <files>
    web/app/(dashboard)/messages/components/AttachmentPicker.tsx
    web/app/(dashboard)/messages/components/MessageAttachment.tsx
    web/app/(dashboard)/messages/components/MessageInput.tsx
    web/app/(dashboard)/messages/components/MessageItem.tsx
  </files>
  <action>
**AttachmentPicker component (NEW):**

Create `web/app/(dashboard)/messages/components/AttachmentPicker.tsx`:
- Client component ('use client')
- Props: `{ onFileSelected: (file: File) => void; disabled?: boolean }`
- Renders a Paperclip icon button (import `Paperclip` from lucide-react) next to the message input
- On click, opens a hidden `<input type="file" />` via ref.click()
- Accept attribute: `.pdf,.jpg,.jpeg,.png,.doc,.docx`
- On file selection, validates:
  - File size <= 10MB (if too large, show toast via sonner: "File too large. Maximum size is 10MB.")
  - MIME type in allowed list (if invalid, show toast: "File type not supported. Accepted: PDF, JPEG, PNG, Word.")
- If valid, calls `onFileSelected(file)`
- Uses `Button` variant="ghost" size="icon" for the Paperclip button, consistent with the Send button styling

**MessageAttachment component (NEW):**

Create `web/app/(dashboard)/messages/components/MessageAttachment.tsx`:
- Client component ('use client')
- Props: `{ metadata: AttachmentMetadata; className?: string }`
- Import icons from lucide-react: `FileText`, `Image`, `Download`, `File`
- Determine display based on mime_type:
  - Images (jpeg, jpg, png): Show thumbnail preview using signed URL (lazy-loaded). Use `<img>` with `className="max-w-xs max-h-48 rounded-md"` and `loading="lazy"`. Below the image, show filename + file size + download button.
  - PDFs: Show `FileText` icon (red-ish) + filename + file size + download button
  - Word docs: Show `File` icon + filename + file size + download button
  - Unknown: Show generic `File` icon + filename + file size + download button
- File size formatting: `formatFileSize(bytes)` utility -- KB for < 1MB, MB for >= 1MB (e.g., "254 KB", "2.1 MB")
- Download button: On click, fetch `/api/messages/attachments/download?path=${encodeURIComponent(storagePath)}`, get the signed URL, then open in new tab or trigger browser download via `window.open(url, '_blank')`
- For image thumbnails, also fetch the signed URL on component mount and set as img src. Use a loading state while fetching.
- Layout: Rounded border card (`border rounded-lg p-3`) containing the icon/preview + file info + download action. Compact design that fits within the message row.

**MessageInput modification:**

Update `web/app/(dashboard)/messages/components/MessageInput.tsx`:
- Import `AttachmentPicker` and `X` icon from lucide-react
- Add state: `const [pendingFile, setPendingFile] = useState<File | null>(null)`
- Add the AttachmentPicker button to the left of the textarea (before the textarea in the flex row), or between the textarea and send button
- When a file is selected (onFileSelected), set `pendingFile`
- Show a pending attachment preview above the textarea when `pendingFile` is set:
```tsx
{pendingFile && (
  <div className="px-3 pt-2">
    <div className="flex items-center gap-2 bg-muted rounded-md px-3 py-2 text-sm">
      <Paperclip className="h-4 w-4 text-muted-foreground" />
      <span className="truncate flex-1">{pendingFile.name}</span>
      <span className="text-xs text-muted-foreground">{formatFileSize(pendingFile.size)}</span>
      <button onClick={() => setPendingFile(null)} className="text-muted-foreground hover:text-foreground">
        <X className="h-4 w-4" />
      </button>
    </div>
  </div>
)}
```
- Modify `handleSend`:
  - If `pendingFile` is set, upload via FormData to `/api/messages/attachments/upload` instead of the text-only `/api/messages/send`
  - FormData includes: `file`, `conversationId`, `content` (text caption, if any)
  - Show upload progress state (setSending(true) during upload)
  - On success, clear both `content` and `pendingFile`
  - On error, show toast via sonner: "Failed to send attachment"
  - If no pendingFile, use existing text-only send logic (no change to current flow)
- Allow sending an attachment with no text, or text with no attachment, or both
- The Send button should be enabled if either `content.trim()` is non-empty OR `pendingFile` is set

**MessageItem modification:**

Update `web/app/(dashboard)/messages/components/MessageItem.tsx`:
- Import `MessageAttachment` and `AttachmentMetadata` type
- After the text content `<p>` tag, check if `message.message_type === 'attachment'` and `message.metadata` has an `attachment` key:
```tsx
{message.message_type === 'attachment' && message.metadata?.attachment && (
  <MessageAttachment
    metadata={message.metadata as AttachmentMetadata}
    className="mt-1"
  />
)}
```
- The text content (`message.content`) should still render above the attachment if present (caption text)
- If `message.message_type === 'attachment'` and `message.content` is null/empty, don't render the empty `<p>` tag
  </action>
  <verify>
- `pnpm build` succeeds
- AttachmentPicker renders Paperclip button and opens file input on click
- MessageAttachment renders different displays for images vs documents
- MessageInput shows pending file preview and sends via upload endpoint
- MessageItem renders attachment inline in the thread
  </verify>
  <done>
- Paperclip button in message compose area opens file picker
- Pending file shown as preview strip above textarea with remove button
- Send button uploads file to message-attachments bucket + creates attachment message
- Image attachments show thumbnail preview in thread; documents show file icon + name
- Download link generates signed URL and opens file in new tab
- Optional text caption supported alongside attachment
- File validation: 10MB max, PDF/JPEG/PNG/Word only, with toast error messages
  </done>
</task>

</tasks>

<verification>
1. Click Paperclip button -> file picker opens with correct accept filter
2. Select a 12MB file -> toast error "File too large. Maximum size is 10MB."
3. Select a valid PDF -> pending preview appears above textarea with filename and size
4. Click X on pending preview -> file removed, back to text-only mode
5. Type a caption + press Send with pending file -> file uploads, attachment message appears in thread
6. Attachment message shows FileText icon + filename + size + Download button
7. Click Download -> signed URL generated, file opens in new tab
8. Select a JPEG image -> send -> thumbnail preview appears inline in thread + download available
9. Send attachment with no text -> works (content is null, attachment displays alone)
10. Other party sees the attachment in their thread and can download it
11. `pnpm build` succeeds with no TypeScript errors
</verification>

<success_criteria>
- Users can attach files to messages via the compose area
- Attachments stored in message-attachments Supabase Storage bucket
- Attachments appear inline in conversation thread with appropriate display (thumbnail for images, file card for documents)
- Recipients can download attachments via signed URL
- File validation enforced: 10MB max, restricted MIME types
</success_criteria>

<output>
After completion, create `.planning/phases/47-message-polish/47-03-SUMMARY.md`
</output>
