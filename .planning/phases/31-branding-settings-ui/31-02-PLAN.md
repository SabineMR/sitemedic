---
phase: 31-branding-settings-ui
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - web/app/api/platform/organizations/[id]/branding/route.ts
  - web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx
  - web/app/platform/organizations/page.tsx
autonomous: true

must_haves:
  truths:
    - "Platform admin can navigate to any org in the organizations list and see a branding override section with the same form fields (company name, colour, tagline, logo upload)"
    - "Platform admin text field changes (company name, colour, tagline) auto-save and persist across page reloads"
    - "Platform admin can upload a logo for any org and the file is accessible at its Supabase Storage public URL"
    - "Changes made by platform admin are reflected in the org's portal on next page load"
    - "BrandingForm component is reused without code duplication across org admin and platform admin flows"
  artifacts:
    - path: "web/app/api/platform/organizations/[id]/branding/route.ts"
      provides: "GET/PUT/POST endpoints for platform admin branding override using service-role client"
      exports: ["GET", "PUT", "POST"]
      min_lines: 90
    - path: "web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx"
      provides: "BrandingForm component updated with optional logoUploadEndpoint prop for server-side logo upload"
      exports: ["BrandingForm"]
      min_lines: 160
    - path: "web/app/platform/organizations/page.tsx"
      provides: "Updated platform organizations page with expandable branding override section per org using BrandingForm"
      min_lines: 200
  key_links:
    - from: "web/app/platform/organizations/page.tsx"
      to: "web/app/api/platform/organizations/[id]/branding/route.ts"
      via: "BrandingForm apiEndpoint prop passes /api/platform/organizations/{id}/branding"
      pattern: "api/platform/organizations/.*/branding"
    - from: "web/app/api/platform/organizations/[id]/branding/route.ts"
      to: "org_branding table"
      via: "service-role Supabase client (bypasses RLS)"
      pattern: "getServiceClient|SUPABASE_SERVICE_ROLE_KEY"
    - from: "web/app/platform/organizations/page.tsx"
      to: "web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx"
      via: "import { BrandingForm } with apiEndpoint + logoUploadEndpoint props"
      pattern: "import.*BrandingForm"
    - from: "web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx"
      to: "logoUploadEndpoint POST"
      via: "when logoUploadEndpoint prop is set, POST FormData to that endpoint instead of client-side Supabase Storage"
      pattern: "logoUploadEndpoint.*fetch.*POST"
---

<objective>
Add platform admin branding override capability: a service-role API route (GET/PUT/POST) for reading/writing any org's branding and uploading logos, a small modification to BrandingForm to support server-side logo upload via a new `logoUploadEndpoint` prop, and an expandable branding section on each org card in the platform organizations page.

Purpose: Enables Sabine to configure branding on behalf of new subscribers who haven't set it up themselves (BRAND-02 requirement). This is the white-glove service for new org onboarding.

Output: One new API route, a modification to BrandingForm from 31-01, and an update to the platform organizations page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-branding-settings-ui/31-01-SUMMARY.md — BrandingForm component API (apiEndpoint prop, PreviewBranding type)

Key reference files (read these before implementing):
@web/app/api/platform/organizations/activate/route.ts — service-role client pattern (getServiceClient), platform admin auth check
@web/app/platform/organizations/page.tsx — current platform organizations page structure
@web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx — BrandingForm component to modify and reuse
@web/app/(dashboard)/admin/settings/branding/components/branding-preview.tsx — BrandingPreview component to reuse
@web/app/api/admin/branding/route.ts — org admin branding API (reference for data shape)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform admin branding API route with GET, PUT, and POST handlers</name>
  <files>
    web/app/api/platform/organizations/[id]/branding/route.ts
  </files>
  <action>
Create a new API route at `web/app/api/platform/organizations/[id]/branding/route.ts` with GET, PUT, and POST handlers.

**Auth pattern:** Copy from activate/route.ts:
- `createClient()` from `@/lib/supabase/server` for auth check
- `getUser()` -> verify `app_metadata.role === 'platform_admin'` -> 401/403 if not
- `getServiceClient()` helper (same as activate route) using `NEXT_PUBLIC_SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY`

**GET handler:**
- Extract `id` from route params (the org_id)
- Use service-role client to `SELECT * FROM org_branding WHERE org_id = id` (`.single()`)
- Return the branding data as JSON
- If no row found, return defaults: `{ company_name: null, tagline: null, primary_colour_hex: null, logo_path: null }`

**PUT handler:**
- Extract `id` from route params
- Parse JSON body: `{ company_name?, tagline?, primary_colour_hex?, logo_path? }`
- Validate hex colour if provided (same `/^#[0-9A-Fa-f]{6}$/` regex as admin/branding route)
- Use service-role client to UPDATE org_branding SET ... WHERE org_id = id
- Build updatePayload same way as admin/branding route (only set fields that are present in body, always set updated_at)
- Return updated row as JSON
- 400 for invalid hex, 401/403 for auth, 500 for DB errors

**POST handler (logo upload via FormData):**
- Extract `id` from route params (the org_id)
- Auth check: same platform_admin verification as GET/PUT
- Parse multipart form data: `const formData = await request.formData()`
- Extract file: `const file = formData.get('logo') as File`
- Validate file:
  - Must exist (400 if missing)
  - Type must be one of `image/png`, `image/jpeg`, `image/svg+xml` (400 if wrong type)
  - Size must be <= 2MB (400 if too large)
- Determine extension from file.type: `png`, `jpeg`/`jpg`, `svg`
- Convert File to ArrayBuffer then Buffer for upload: `const buffer = Buffer.from(await file.arrayBuffer())`
- Upload via service-role client: `supabase.storage.from('org-logos').upload(\`${orgId}/logo.${ext}\`, buffer, { contentType: file.type, upsert: true })`
- On upload success: update org_branding.logo_path via service-role client: `UPDATE org_branding SET logo_path = 'org-logos/{orgId}/logo.{ext}', updated_at = NOW() WHERE org_id = orgId`
- Get the public URL: `supabase.storage.from('org-logos').getPublicUrl(\`${orgId}/logo.${ext}\`)`
- Return JSON: `{ logo_path: 'org-logos/{orgId}/logo.{ext}', logo_url: publicUrl }`
- Error responses: 400 (missing file, wrong type, too large), 401/403 (auth), 500 (upload/DB error)

**Important details:**
- `export const dynamic = 'force-dynamic'`
- Use `import { createClient as createAdminClient } from '@supabase/supabase-js'` for service-role client (same pattern as activate route)
- No requireTier check — platform admin can override any org regardless of tier
- The route params pattern for Next.js 15 App Router: `{ params }: { params: Promise<{ id: string }> }` — must `await params` to get id
  </action>
  <verify>
```bash
# File exists and exports GET, PUT, and POST
grep -n "export async function GET\|export async function PUT\|export async function POST" web/app/api/platform/organizations/\[id\]/branding/route.ts
# Service-role pattern is present
grep -n "getServiceClient\|SUPABASE_SERVICE_ROLE_KEY" web/app/api/platform/organizations/\[id\]/branding/route.ts
# Platform admin auth check is present
grep -n "platform_admin" web/app/api/platform/organizations/\[id\]/branding/route.ts
# FormData parsing in POST handler
grep -n "formData\|FormData" web/app/api/platform/organizations/\[id\]/branding/route.ts
```
  </verify>
  <done>
Platform admin branding API route exists with GET/PUT/POST handlers. GET reads branding, PUT auto-saves text fields, POST accepts FormData for logo upload via service-role storage client. All handlers validate platform_admin role. POST validates file type/size before uploading.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add logoUploadEndpoint prop to BrandingForm for server-side logo upload</name>
  <files>
    web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx
  </files>
  <action>
Modify the BrandingForm component (created in 31-01) to support an optional `logoUploadEndpoint` prop. When this prop is set, logo upload goes through a server-side POST endpoint (FormData) instead of client-side Supabase Storage. This is needed because platform admin's JWT has org_id=NULL, so RLS blocks client-side storage uploads.

**Changes to BrandingForm props:**
- Add optional prop: `logoUploadEndpoint?: string`
- Existing props remain unchanged: `orgId`, `apiEndpoint`, `initialData`, `onPreviewChange`

**Changes to logo upload logic (handleUploadLogo function):**
- Add a conditional branch at the start of handleUploadLogo:
  ```
  if (logoUploadEndpoint) {
    // Server-side upload path (for platform admin)
    const formData = new FormData()
    formData.append('logo', logoFile)
    const res = await fetch(logoUploadEndpoint, { method: 'POST', body: formData })
    if (!res.ok) {
      const err = await res.json()
      throw new Error(err.error || 'Upload failed')
    }
    const data = await res.json()
    // Update existingLogoPath from response data.logo_path
    // Update logoPreviewUrl from response data.logo_url
    // Clear logoFile state
    // Toast success
  } else {
    // Existing client-side Supabase Storage upload (for org admin)
    // ... keep all existing code unchanged ...
  }
  ```
- The else branch retains all existing client-side upload logic unchanged — no regression for org admin usage
- Both branches end with the same cleanup: clear logoFile, toast success, set uploadingLogo false

**No other changes to BrandingForm.** The auto-save, colour picker, reset button, preview callback, and all other functionality remain identical. This is a minimal, targeted modification.
  </action>
  <verify>
```bash
# logoUploadEndpoint prop exists in the component
grep -n "logoUploadEndpoint" web/app/\(dashboard\)/admin/settings/branding/components/branding-form.tsx
# FormData is used for server-side upload
grep -n "new FormData\|formData.append" web/app/\(dashboard\)/admin/settings/branding/components/branding-form.tsx
# Both upload paths exist (client-side and server-side)
grep -c "supabase.storage\|logoUploadEndpoint" web/app/\(dashboard\)/admin/settings/branding/components/branding-form.tsx
```
Should return >= 2 (both paths present).
  </verify>
  <done>
BrandingForm now accepts an optional `logoUploadEndpoint` prop. When set, logo upload POSTs FormData to that endpoint. When not set (default), uses client-side Supabase Storage upload as before. Zero regression for org admin usage in 31-01.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add expandable branding section to platform organizations page</name>
  <files>
    web/app/platform/organizations/page.tsx
  </files>
  <action>
Update the platform organizations page to add a branding override capability for each active org, reusing BrandingForm and BrandingPreview components.

**Imports to add:**
- `import { BrandingForm } from '@/app/(dashboard)/admin/settings/branding/components/branding-form'`
- `import { BrandingPreview } from '@/app/(dashboard)/admin/settings/branding/components/branding-preview'`
- `import { Palette } from 'lucide-react'` (add to existing lucide import)

**State to add:**
- `const [expandedBrandingId, setExpandedBrandingId] = useState<string | null>(null)` — tracks which org has branding expanded (only one at a time)
- `const [brandingData, setBrandingData] = useState<Record<string, any>>({})` — caches fetched branding per org to avoid re-fetching on collapse/expand
- `const [brandingLoading, setBrandingLoading] = useState<string | null>(null)` — tracks which org is loading branding
- `const [previewBranding, setPreviewBranding] = useState<{ companyName: string; primaryColour: string; tagline: string; logoUrl: string }>({ companyName: '', primaryColour: '#2563eb', tagline: '', logoUrl: '' })` — live preview state

**Fetch branding on expand:**
- Create `handleToggleBranding(orgId: string)` function:
  - If `expandedBrandingId === orgId`, collapse: `setExpandedBrandingId(null)`, return
  - Set `setExpandedBrandingId(orgId)`
  - If branding already cached in `brandingData[orgId]`, use it to set previewBranding, return
  - Otherwise: set `setBrandingLoading(orgId)`, fetch `GET /api/platform/organizations/${orgId}/branding`
  - On success: store in `brandingData`, set previewBranding defaults from fetched data
  - On error: toast.error, collapse
  - Finally: `setBrandingLoading(null)`

**UI changes to each active org card:**
- Add a "Branding" button (Palette icon + "Branding" text) next to the existing badges/actions area on each org card
  - Button styling: small, outline-style, matches platform admin purple theme (`text-purple-300 hover:bg-purple-500/20 border-purple-500/30`)
  - Toggle: `onClick={() => handleToggleBranding(org.id)}`
  - Active state: when `expandedBrandingId === org.id`, highlight button background

- When `expandedBrandingId === org.id`, render an expandable section below the org card metrics:
  - If `brandingLoading === org.id`: show a centered Loader2 spinner
  - Otherwise: render a responsive grid `grid grid-cols-1 xl:grid-cols-2 gap-6` containing:
    - Left column: `<BrandingForm orgId={org.id} apiEndpoint={/api/platform/organizations/${org.id}/branding} logoUploadEndpoint={/api/platform/organizations/${org.id}/branding} initialData={brandingData[org.id]} onPreviewChange={setPreviewBranding} />`
    - Right column: `<BrandingPreview branding={previewBranding} />` with `xl:sticky xl:top-8` positioning
  - Section styling: border-t border-gray-700/50, pt-4 mt-4, subtle slide-down appearance
  - Match the purple-toned styling of the platform admin page

**Key details:**
- Only one org can have branding expanded at a time — clicking another collapses the previous
- The apiEndpoint and logoUploadEndpoint both point to the same route (`/api/platform/organizations/${orgId}/branding`) — the route distinguishes by HTTP method (PUT for text auto-save, POST for logo upload)
- BrandingForm's auto-save fires PUT requests to the platform admin endpoint (via apiEndpoint prop)
- BrandingForm's logo upload fires POST request to the platform admin endpoint (via logoUploadEndpoint prop)
- No tier check on the platform page — platform admin can edit branding for any org regardless of their subscription tier
  </action>
  <verify>
```bash
# BrandingForm import exists
grep -n "import.*BrandingForm" web/app/platform/organizations/page.tsx
# BrandingPreview import exists
grep -n "import.*BrandingPreview" web/app/platform/organizations/page.tsx
# Expandable state exists
grep -n "expandedBrandingId" web/app/platform/organizations/page.tsx
# API endpoint is passed to BrandingForm
grep -n "api/platform/organizations" web/app/platform/organizations/page.tsx
# logoUploadEndpoint is passed
grep -n "logoUploadEndpoint" web/app/platform/organizations/page.tsx
# Build check
cd /Users/sabineresoagli/GitHub/sitemedic/web && npx next build --no-lint 2>&1 | tail -20
```
  </verify>
  <done>
Platform organizations page has expandable branding override per org card. Clicking "Branding" button fetches branding data and shows BrandingForm + BrandingPreview in a responsive grid. BrandingForm reused with apiEndpoint and logoUploadEndpoint props pointing to the platform admin API route. Only one org expanded at a time. Auto-save and logo upload both route through service-role endpoint. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` completes without errors
2. Platform admin can expand branding on any org card and see current branding values loaded via GET
3. Platform admin text field changes auto-save via PUT `/api/platform/organizations/{id}/branding` (BrandingForm auto-save via apiEndpoint prop)
4. Platform admin logo upload works via POST `/api/platform/organizations/{id}/branding` (BrandingForm via logoUploadEndpoint prop, service-role storage upload)
5. Non-platform-admin users get 403 when calling the platform branding API route
6. Changes made by platform admin are reflected when the org admin loads their portal
7. Org admin BrandingForm usage (31-01) is unaffected — logoUploadEndpoint is optional, client-side Supabase upload still works when prop is absent
</verification>

<success_criteria>
- Service-role client used for all platform admin branding writes (RLS bypassed)
- Platform admin auth check on all three handlers (GET/PUT/POST)
- POST handler accepts FormData, validates file type/size, uploads via service-role storage client
- BrandingForm reused via apiEndpoint + logoUploadEndpoint props (no duplicate form code)
- logoUploadEndpoint prop is optional — org admin flow (31-01) is unchanged
- Auto-save on text fields via BrandingForm's built-in debounce
- Live preview updates via BrandingPreview component
- Expandable branding section per org card — clean UX, only one expanded at a time
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-branding-settings-ui/31-02-SUMMARY.md`
</output>
