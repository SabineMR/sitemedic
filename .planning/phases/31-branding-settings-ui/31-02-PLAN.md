---
phase: 31-branding-settings-ui
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - web/app/api/platform/organizations/[id]/branding/route.ts
  - web/app/platform/organizations/page.tsx
autonomous: true

must_haves:
  truths:
    - "Platform admin can navigate to any org in the organizations list and see a branding override section with the same form fields (company name, colour, tagline, logo upload)"
    - "Platform admin branding writes use a service-role Supabase client that bypasses RLS (org_id is NULL in platform admin JWT)"
    - "Logo upload by platform admin uses service-role storage client to bypass org-scoped RLS on the org-logos bucket"
    - "Changes made by platform admin are reflected in the org's portal on next page load"
  artifacts:
    - path: "web/app/api/platform/organizations/[id]/branding/route.ts"
      provides: "GET/PUT endpoints for platform admin branding override using service-role client"
      exports: ["GET", "PUT"]
      min_lines: 60
    - path: "web/app/platform/organizations/page.tsx"
      provides: "Updated platform organizations page with branding override expandable section per org"
      min_lines: 200
  key_links:
    - from: "web/app/platform/organizations/page.tsx"
      to: "web/app/api/platform/organizations/[id]/branding/route.ts"
      via: "fetch GET/PUT for branding data"
      pattern: "api/platform/organizations/.*/branding"
    - from: "web/app/api/platform/organizations/[id]/branding/route.ts"
      to: "org_branding table"
      via: "service-role Supabase client (bypasses RLS)"
      pattern: "getServiceClient|SUPABASE_SERVICE_ROLE_KEY"
---

<objective>
Add platform admin branding override capability — a service-role API route for reading/writing any org's branding, and an expandable branding section on each org card in the platform organizations page. Platform admin can upload a logo and set branding for any org as a white-glove setup service.

Purpose: Enables Sabine to configure branding on behalf of new subscribers who haven't set it up themselves (BRAND-02 requirement). This is the white-glove service for new org onboarding.

Output: One new API route and an update to the platform organizations page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-branding-settings-ui/31-01-SUMMARY.md — BrandingForm component API (apiEndpoint prop, PreviewBranding type)

Key reference files (read these before implementing):
@web/app/api/platform/organizations/activate/route.ts — service-role client pattern (getServiceClient), platform admin auth check
@web/app/platform/organizations/page.tsx — current platform organizations page structure
@web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx — BrandingForm component to reuse
@web/app/api/admin/branding/route.ts — org admin branding API (reference for data shape)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform admin branding API route</name>
  <files>
    web/app/api/platform/organizations/[id]/branding/route.ts
  </files>
  <action>
Create a new API route at `web/app/api/platform/organizations/[id]/branding/route.ts` with GET and PUT handlers.

**Auth pattern:** Copy from activate/route.ts:
- `createClient()` from `@/lib/supabase/server` for auth check
- `getUser()` → verify `app_metadata.role === 'platform_admin'` → 401/403 if not
- `getServiceClient()` helper (same as activate route) using `NEXT_PUBLIC_SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY`

**GET handler:**
- Extract `id` from route params (the org_id)
- Use service-role client to `SELECT * FROM org_branding WHERE org_id = id` (`.single()`)
- Return the branding data as JSON
- If no row found, return defaults: `{ company_name: null, tagline: null, primary_colour_hex: null, logo_path: null }`

**PUT handler:**
- Extract `id` from route params
- Parse JSON body: `{ company_name?, tagline?, primary_colour_hex?, logo_path? }`
- Validate hex colour if provided (same `/^#[0-9A-Fa-f]{6}$/` regex as admin/branding route)
- Use service-role client to UPDATE org_branding SET ... WHERE org_id = id
- Build updatePayload same way as admin/branding route (only set fields that are present in body, always set updated_at)
- Return updated row as JSON
- 400 for invalid hex, 401/403 for auth, 500 for DB errors

**Important details:**
- `export const dynamic = 'force-dynamic'`
- Use `import { createClient as createAdminClient } from '@supabase/supabase-js'` for service-role client (same pattern as activate route)
- No requireTier check — platform admin can override any org regardless of tier
- The route params pattern for Next.js 15 App Router: `{ params }: { params: Promise<{ id: string }> }` — must `await params` to get id
  </action>
  <verify>
```bash
# File exists and exports GET and PUT
grep -n "export async function GET\|export async function PUT" web/app/api/platform/organizations/\[id\]/branding/route.ts
# Service-role pattern is present
grep -n "getServiceClient\|SUPABASE_SERVICE_ROLE_KEY" web/app/api/platform/organizations/\[id\]/branding/route.ts
# Platform admin auth check is present
grep -n "platform_admin" web/app/api/platform/organizations/\[id\]/branding/route.ts
```
  </verify>
  <done>
Platform admin branding API route exists with GET/PUT, uses service-role client to bypass RLS, validates platform_admin role, validates hex colour format.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add branding override section to platform organizations page</name>
  <files>
    web/app/platform/organizations/page.tsx
  </files>
  <action>
Update the platform organizations page to add a branding override capability for each active org.

**Approach:** Add an expandable "Edit Branding" section to each org card in the organizations grid. When expanded, it shows a simplified inline branding form (NOT reusing BrandingForm component directly, because that component is a client component with its own Supabase client for logo upload — platform admin needs service-role for logo upload too, which requires a different upload approach via the API route).

**Implementation:**

1. Add state to track which org card has branding expanded: `const [expandedBrandingId, setExpandedBrandingId] = useState<string | null>(null)`

2. Add a "Branding" button to each org card (next to the Active badge). Clicking it toggles `expandedBrandingId`.

3. When expanded for an org, show an inline form section below the metrics:
   - Fetch branding on expand: `GET /api/platform/organizations/${orgId}/branding`
   - Company name text input (auto-save pattern with 500ms debounce using setTimeout/useRef)
   - Primary colour: `<input type="color">` + hex text input + swatch
   - Tagline text input
   - Logo upload: file input + Upload button → POST the file via a FormData-based upload through the API route, OR upload directly using Supabase client with anon key (public bucket allows uploads by authenticated users? No — platform admin org_id is NULL, so RLS blocks them)

   **Logo upload for platform admin:** Since platform admin can't upload via client-side Supabase (RLS blocks them — their org_id is NULL), implement a **server-side upload** approach:
   - Add a `POST` handler to the branding API route that accepts `multipart/form-data`
   - The POST handler uses service-role client to upload to `org-logos/{orgId}/logo.{ext}` via `supabase.storage.from('org-logos').upload(...)` with upsert
   - Then updates `org_branding.logo_path`
   - On the client side: select file, validate (same constraints: png/jpeg/svg, 2MB max), create FormData, POST to `/api/platform/organizations/${orgId}/branding` with the file

   **Actually, simpler approach:** Add a separate upload route or extend PUT to handle logo. Best pattern: add a **POST handler** to the branding route that handles file upload.

4. Auto-save for text fields: PUT to `/api/platform/organizations/${orgId}/branding` with debounce
5. Save status indicator inline: "Saving..." → "Saved"
6. "Reset Colour" button to reset to #2563eb

**Add to the branding route (Task 1 file):** Also add a POST handler for logo upload:
```typescript
export async function POST(request: NextRequest, { params }: ...) {
  // Auth check (platform_admin)
  // Parse multipart form data
  const formData = await request.formData();
  const file = formData.get('logo') as File;
  // Validate file type and size
  // Upload via service-role to org-logos/{orgId}/logo.{ext}
  // Update org_branding.logo_path
  // Return { logo_path, logo_url }
}
```

**Key details:**
- The expandable branding section uses a slide-down animation (or simple show/hide)
- Only one org can have branding expanded at a time (clicking another collapses the previous)
- Palette icon on the "Branding" button, consistent with settings page
- Match the purple-toned styling of the platform admin page (not the gray-toned admin page)
  </action>
  <verify>
```bash
# Branding button exists on org cards
grep -n "expandedBrandingId\|Edit Branding\|Branding" web/app/platform/organizations/page.tsx
# API endpoint is called
grep -n "api/platform/organizations" web/app/platform/organizations/page.tsx
# POST handler exists for logo upload
grep -n "export async function POST" web/app/api/platform/organizations/\[id\]/branding/route.ts
# Build check
cd /Users/sabineresoagli/GitHub/sitemedic/web && npx next build --no-lint 2>&1 | tail -20
```
  </verify>
  <done>
Platform organizations page has expandable branding override per org card. Platform admin can edit company name, colour, tagline (auto-save), and upload logo (explicit upload via service-role POST endpoint). Changes are written to org_branding via service-role client bypassing RLS. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` completes without errors
2. Platform admin can expand branding on any org card and see current branding values
3. Platform admin text field changes auto-save via PUT `/api/platform/organizations/{id}/branding`
4. Platform admin logo upload works (file → POST → service-role storage upload → logo_path updated)
5. Non-platform-admin users get 403 when calling the platform branding API route
6. Changes made by platform admin are reflected when the org admin loads their portal
</verification>

<success_criteria>
- Service-role client used for all platform admin branding writes (RLS bypassed)
- Platform admin auth check on all handlers (GET/PUT/POST)
- Logo upload via server-side POST handler (not client-side Supabase — platform admin org_id is NULL)
- Auto-save on text fields with inline status indicator
- Hex colour validation on server side
- Expandable branding section per org card — clean UX, only one expanded at a time
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-branding-settings-ui/31-02-SUMMARY.md`
</output>
