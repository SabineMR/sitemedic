---
phase: 31-branding-settings-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/(dashboard)/admin/settings/branding/page.tsx
  - web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx
  - web/app/(dashboard)/admin/settings/branding/components/branding-preview.tsx
  - web/app/admin/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Growth-tier org admin can navigate to /admin/settings/branding and see a full branding form with company name, primary colour, tagline, and logo upload fields"
    - "Text fields (company name, tagline, colour) auto-save after 500ms debounce via PUT /api/admin/branding — no manual save button"
    - "Logo upload is an explicit manual action (Upload Logo button) that uploads to org-logos/{org_id}/logo.{ext} via Supabase Storage with upsert:true"
    - "A live preview panel updates in real-time as the user types, showing portal header and sidebar mockup with current branding values"
    - "Reset to SiteMedic Defaults button resets the primary colour to #2563eb and triggers auto-save"
    - "Starter-tier org admin visiting the page sees UpgradePrompt from TierGate — the form is not exposed"
  artifacts:
    - path: "web/app/(dashboard)/admin/settings/branding/page.tsx"
      provides: "Branding settings page with TierGate, form + preview side-by-side layout"
      min_lines: 80
    - path: "web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx"
      provides: "Reusable BrandingForm component with auto-save debounce, logo upload, colour picker, reset button"
      exports: ["BrandingForm"]
      min_lines: 150
    - path: "web/app/(dashboard)/admin/settings/branding/components/branding-preview.tsx"
      provides: "Live preview panel showing portal header and sidebar mockup"
      exports: ["BrandingPreview"]
      min_lines: 40
  key_links:
    - from: "web/app/(dashboard)/admin/settings/branding/page.tsx"
      to: "web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx"
      via: "import { BrandingForm }"
      pattern: "import.*BrandingForm"
    - from: "web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx"
      to: "/api/admin/branding"
      via: "fetch PUT for auto-save"
      pattern: "fetch.*api/admin/branding.*PUT"
    - from: "web/app/(dashboard)/admin/settings/branding/page.tsx"
      to: "web/components/billing/tier-gate.tsx"
      via: "TierGate wrapping form"
      pattern: "<TierGate.*feature.*white_label"
---

<objective>
Create the org admin branding settings page at `/admin/settings/branding/` with a reusable BrandingForm component (auto-save text fields, explicit logo upload, colour picker with reset), a live preview panel, and TierGate wrapping for Growth tier enforcement.

Purpose: Enable Growth-tier org admins to self-serve their portal branding configuration (logo, colour, company name, tagline) without contacting Sabine. This is the primary BRAND-01 requirement.

Output: Three new files (page, form component, preview component) and an update to the existing settings page to link to the dedicated branding page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key reference files (read these before implementing):
@web/app/onboarding/branding/page.tsx — Phase 29-03 branding form (source of file upload, colour picker patterns)
@web/app/api/admin/branding/route.ts — existing GET/PUT endpoints with requireTier('white_label')
@web/contexts/branding-context.tsx — DEFAULT_BRANDING, hex validation regex
@web/components/billing/tier-gate.tsx — TierGate component interface
@web/app/admin/settings/page.tsx — existing settings page with inline branding section (to be updated with link)
@web/app/(dashboard)/riddor/[id]/page.tsx — auto-save debounce pattern (30s; we use 500ms)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrandingForm and BrandingPreview components</name>
  <files>
    web/app/(dashboard)/admin/settings/branding/components/branding-form.tsx
    web/app/(dashboard)/admin/settings/branding/components/branding-preview.tsx
  </files>
  <action>
Create two components:

**BrandingForm** (`branding-form.tsx`):
- 'use client' component
- Props: `{ orgId: string; apiEndpoint?: string; initialData?: { company_name: string; primary_colour_hex: string | null; tagline: string | null; logo_path: string | null }; onPreviewChange?: (branding: PreviewBranding) => void }`
  - `apiEndpoint` defaults to `/api/admin/branding` — allows 31-02 to pass a different platform admin endpoint
- State: companyName, primaryColour (#2563eb default), tagline, logoFile, logoPreviewUrl, existingLogoPath, uploadingLogo, saveStatus ('idle' | 'saving' | 'saved')
- **Auto-save logic (500ms debounce):**
  - Use `useRef<ReturnType<typeof setTimeout>>` for timer
  - `useEffect` on [companyName, primaryColour, tagline] (NOT initial render — use a `hasInitialized` ref to skip the first render)
  - On change: clear timer, set new 500ms timeout → PUT to apiEndpoint with `{ company_name, primary_colour_hex, tagline }`
  - Set saveStatus to 'saving' before fetch, 'saved' after 200, 'idle' after 2s timeout
  - Silent failures (console.error only, no toast — auto-save should be unobtrusive)
  - Validate hex before sending: only send if `/^#[0-9a-fA-F]{6}$/` matches, otherwise send null
  - Cleanup: clear timer on unmount
- **Live preview callback:** Call `onPreviewChange` on every state change (no debounce on preview — only on save). Preview gets real-time updates; save is debounced.
- **Company Name field:** Required, text input, placeholder "e.g. Apex Safety Group Ltd"
- **Primary Colour field:**
  - Row with: native `<input type="color">` + hex text input (font-mono, maxLength 7) + colour swatch div
  - Colour picker value: use validated hex or fallback #2563eb
  - Below: "Reset to SiteMedic Defaults" button (text-xs text-gray-500 hover:text-gray-300) — sets primaryColour to '#2563eb' (triggers auto-save via useEffect)
- **Tagline field:** Optional, text input, placeholder "e.g. Professional event medical services"
- **Logo Upload section:**
  - Hidden file input (ref), accept="image/png,image/jpeg,image/svg+xml"
  - Validation: ACCEPTED_TYPES check + 2MB max size → toast.error on failure
  - FileReader for local preview (setLogoPreviewUrl on load)
  - "Choose Logo" / "Change Logo" button (depending on whether preview exists)
  - When logoFile is set (new file selected): show "Upload Logo" button (blue, with Loader2 spinner when uploading)
  - handleUploadLogo: supabase.storage.from('org-logos').upload(`${orgId}/logo.${ext}`, file, { upsert: true }), then update org_branding.logo_path via apiEndpoint PUT
  - Toast success/error on upload result (logo upload is manual, not auto-save — user needs feedback)
  - Show existing logo if logoPreviewUrl is set (from initial load or new selection)
  - "PNG, JPEG, or SVG. Max 2MB." helper text below
- **Save status indicator:** Small inline text at bottom: "Saving..." when saving, "All changes saved" when saved (fades after 2s), nothing when idle. NOT a toast.
- Match styling from existing settings page: bg-gray-900/50 border-gray-700/50 rounded-xl inputs, text-gray-300 labels, etc.
- Import icons from lucide-react: Upload, ImageIcon, Loader2, Check
- Import toast from sonner (for logo upload only)
- Import createClient from '@/lib/supabase/client'

**BrandingPreview** (`branding-preview.tsx`):
- 'use client' component
- Props: `{ branding: { companyName: string; primaryColour: string; tagline: string; logoUrl: string } }`
- Renders a card with "Live Preview" header showing:
  - **Portal Header mockup:** Rounded container with primaryColour background, showing logo (if URL exists, img tag with h-8 object-contain) + company name (white, font-semibold) + tagline (white/80, text-xs)
  - **Sidebar accent mockup:** 2-3 small rectangles — first one using primaryColour, rest using gray-700, simulating sidebar menu items
  - **Browser tab mockup:** Small text showing "[Company Name] — SiteMedic" to preview the tab title
- Footer text: "Changes update in real-time" (text-xs text-gray-500)
- Styling: bg-gray-900/50 border border-gray-700/50 rounded-xl p-6, consistent with settings page cards
  </action>
  <verify>
Both files exist and export their named components:
```bash
grep -n "export function BrandingForm" web/app/\(dashboard\)/admin/settings/branding/components/branding-form.tsx
grep -n "export function BrandingPreview" web/app/\(dashboard\)/admin/settings/branding/components/branding-preview.tsx
```
Check auto-save pattern is present:
```bash
grep -c "setTimeout" web/app/\(dashboard\)/admin/settings/branding/components/branding-form.tsx
```
Should return >= 1.
  </verify>
  <done>
BrandingForm component exists with auto-save debounce, logo upload, colour picker with reset button, and inline save status indicator. BrandingPreview component exists with portal header + sidebar mockup. Both are reusable (BrandingForm accepts apiEndpoint prop for 31-02 reuse).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create branding settings page and update settings page link</name>
  <files>
    web/app/(dashboard)/admin/settings/branding/page.tsx
    web/app/admin/settings/page.tsx
  </files>
  <action>
**Branding Settings Page** (`web/app/(dashboard)/admin/settings/branding/page.tsx`):
- 'use client' component
- On mount: fetch user via `createClient().auth.getUser()`, extract orgId from app_metadata.org_id
- Fetch subscription tier via `GET /api/admin/subscription` (same pattern as admin/settings/page.tsx line 164-173)
- Fetch initial branding data via `GET /api/admin/branding`
- State: orgId, subscriptionTier, loading, initialBranding, previewBranding (live preview state)
- Layout:
  - Header section: "Branding Settings" title with Palette icon (pink-400), description text "Customise your portal's look — logo, colours, company name, and tagline. Changes auto-save as you type."
  - Back link to `/admin/settings` (ArrowLeft icon, same pattern as onboarding/branding/page.tsx)
  - `<TierGate feature="white_label" tier={subscriptionTier} upgradeMessage="Upgrade to the Growth plan to customise your portal branding, logo, and colours.">`
    - Inside TierGate: responsive grid — `grid grid-cols-1 lg:grid-cols-2 gap-8`
      - Left column: `<BrandingForm orgId={orgId} initialData={initialBranding} onPreviewChange={setPreviewBranding} />`
      - Right column: `<BrandingPreview branding={previewBranding} />` — sticky positioning (lg:sticky lg:top-8)
  - Loading state: centered spinner (same pattern as onboarding page)
- Default previewBranding state: `{ companyName: '', primaryColour: '#2563eb', tagline: '', logoUrl: '' }` — gets overwritten by initialData on load and by form changes in real-time
- Wrap BrandingForm in a bg-gray-800/50 rounded-2xl card for visual consistency with settings page

**Update existing settings page** (`web/app/admin/settings/page.tsx`):
- In the Branding section (around line 504-606), replace the inline branding form with:
  - Keep the section header `<h2>` with Palette icon outside TierGate (as per 30-02 decision)
  - Inside TierGate: replace the current inline form with a simpler card that:
    - Shows current branding summary (company name, colour swatch, logo status)
    - Has a "Manage Branding" link/button that navigates to `/admin/settings/branding`
    - Use NextLink for client-side navigation
  - This simplifies the massive settings page and moves the full branding editing to its dedicated page
  - Keep the TierGate wrapping: `<TierGate feature="white_label" tier={subscriptionTier as SubscriptionTier | null} upgradeMessage="...">`
- Remove the now-unused branding state variables from the settings page: `brandingLoading`, `savingBranding`, `brandCompanyName`, `brandTagline`, `brandColor`, `brandLogoPath`, `fetchBranding()`, `handleSaveBranding()` — these are all replaced by the dedicated page
- Add `import Link from 'next/link'` if not already present
  </action>
  <verify>
The branding settings page exists and imports its components:
```bash
grep -n "BrandingForm\|BrandingPreview\|TierGate" web/app/\(dashboard\)/admin/settings/branding/page.tsx
```
The settings page now links to the dedicated page instead of inline form:
```bash
grep -n "/admin/settings/branding" web/app/admin/settings/page.tsx
```
Build check:
```bash
cd /Users/sabineresoagli/GitHub/sitemedic/web && npx next build --no-lint 2>&1 | tail -20
```
  </verify>
  <done>
Branding settings page renders at /admin/settings/branding with TierGate, side-by-side form + preview, loading state, and back link. The existing settings page links to the dedicated branding page instead of embedding an inline form. Build passes without errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter web build` completes without TypeScript or build errors
2. Growth-tier org admin navigating to `/admin/settings/branding` sees the full branding form with preview
3. Starter-tier org admin sees UpgradePrompt instead of the form
4. Auto-save fires 500ms after typing (check Network tab for PUT /api/admin/branding requests)
5. Logo upload stores file at org-logos/{org_id}/logo.{ext} and updates org_branding.logo_path
6. Reset button changes colour to #2563eb
7. Preview panel updates in real-time as user types
8. Settings page (/admin/settings) shows branding summary with link to dedicated page
</verification>

<success_criteria>
- BrandingForm is a reusable component (accepts apiEndpoint prop) ready for 31-02 reuse
- Auto-save works with 500ms debounce on text fields, silent failures, inline status indicator
- Logo upload is explicit (not auto-saved), with validation, toast feedback, and Supabase Storage upsert
- Live preview updates instantly as user types (no debounce on preview)
- TierGate enforces Growth tier — Starter sees upgrade prompt
- Reset to SiteMedic Defaults button works for colour
- No accessibility/contrast warnings on colour picker (per CONTEXT.md)
- Settings page simplified — branding moved to dedicated page
</success_criteria>

<output>
After completion, create `.planning/phases/31-branding-settings-ui/31-01-SUMMARY.md`
</output>
