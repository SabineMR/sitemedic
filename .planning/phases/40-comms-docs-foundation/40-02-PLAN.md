---
phase: 40-comms-docs-foundation
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - supabase/migrations/144_comms_docs_storage.sql
  - web/types/comms.types.ts
autonomous: true

must_haves:
  truths:
    - "A private storage bucket 'medic-documents' exists with 10MB limit and PDF/JPEG/PNG/DOC/DOCX allowed types"
    - "A private storage bucket 'message-attachments' exists with 10MB limit and PDF/JPEG/PNG/DOC/DOCX allowed types"
    - "Storage RLS policies scope uploads and downloads to org_id via (storage.foldername(name))[1]"
    - "Platform admin can access all files in both buckets"
    - "TypeScript interfaces exist for Conversation, Message, MessageRecipient, ConversationReadStatus, DocumentCategory, Document, DocumentVersion"
  artifacts:
    - path: "supabase/migrations/144_comms_docs_storage.sql"
      provides: "Storage buckets and storage RLS policies"
      contains: "INSERT INTO storage.buckets"
    - path: "web/types/comms.types.ts"
      provides: "TypeScript interfaces for all v5.0 tables"
      contains: "export interface Conversation"
  key_links:
    - from: "storage.objects RLS"
      to: "get_user_org_id()"
      via: "(storage.foldername(name))[1] = (SELECT get_user_org_id())::text"
      pattern: "storage.foldername.*get_user_org_id"
    - from: "web/types/comms.types.ts"
      to: "143_comms_docs_schema.sql"
      via: "TypeScript interfaces matching SQL column definitions"
      pattern: "export interface (Conversation|Message|Document)"
---

<objective>
Create storage buckets for compliance documents and message attachments, with org-scoped RLS policies, and generate TypeScript type definitions for all v5.0 tables.

Purpose: Storage buckets provide the file storage layer for document uploads (Phase 45) and message attachments (Phase 47). TypeScript types enable type-safe data access in all subsequent v5.0 web and Edge Function code.

Output: `supabase/migrations/144_comms_docs_storage.sql` (storage buckets + RLS) and `web/types/comms.types.ts` (TypeScript interfaces).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-comms-docs-foundation/40-CONTEXT.md
@.planning/phases/40-comms-docs-foundation/40-RESEARCH.md
@.planning/phases/40-comms-docs-foundation/40-01-SUMMARY.md

# Reference files for established patterns:
@supabase/migrations/134_org_logos_bucket.sql
@supabase/migrations/142_marketplace_storage_bucket.sql
@web/types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 144 — storage buckets and storage RLS policies</name>
  <files>supabase/migrations/144_comms_docs_storage.sql</files>
  <action>
Create `supabase/migrations/144_comms_docs_storage.sql` with the following content:

**Header comment:**
```sql
-- Migration 144: Comms & Docs Storage Buckets (Phase 40-02)
-- Creates private storage buckets for medic compliance documents and message attachments
-- with org_id-scoped RLS policies following the established (storage.foldername(name))[1] pattern.
-- Part of v5.0 Internal Comms & Document Management.
```

**1. medic-documents bucket:**
```sql
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'medic-documents',
  'medic-documents',
  false,
  10485760,  -- 10 MB
  ARRAY[
    'application/pdf',
    'image/jpeg',
    'image/jpg',
    'image/png',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  ]
)
ON CONFLICT (id) DO NOTHING;
```

**2. message-attachments bucket:**
```sql
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'message-attachments',
  'message-attachments',
  false,
  10485760,  -- 10 MB
  ARRAY[
    'application/pdf',
    'image/jpeg',
    'image/jpg',
    'image/png',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  ]
)
ON CONFLICT (id) DO NOTHING;
```

**3. medic-documents storage RLS policies:**

Path convention: `{org_id}/{medic_id}/{category_slug}/{filename}`

```sql
-- Org users can upload docs to their org folder
CREATE POLICY "Org users upload medic documents"
  ON storage.objects FOR INSERT
  WITH CHECK (
    bucket_id = 'medic-documents'
    AND auth.uid() IS NOT NULL
    AND (storage.foldername(name))[1] = (SELECT get_user_org_id())::text
  );

-- Org users can view docs within their org folder
CREATE POLICY "Org users view medic documents"
  ON storage.objects FOR SELECT
  USING (
    bucket_id = 'medic-documents'
    AND (storage.foldername(name))[1] = (SELECT get_user_org_id())::text
  );

-- Org users can update docs within their org folder
CREATE POLICY "Org users update medic documents"
  ON storage.objects FOR UPDATE
  USING (
    bucket_id = 'medic-documents'
    AND (storage.foldername(name))[1] = (SELECT get_user_org_id())::text
  );

-- Org users can delete docs within their org folder (soft delete at DB level, but storage cleanup may need this)
CREATE POLICY "Org users delete medic documents"
  ON storage.objects FOR DELETE
  USING (
    bucket_id = 'medic-documents'
    AND (storage.foldername(name))[1] = (SELECT get_user_org_id())::text
  );

-- Platform admin: unrestricted access to all medic documents
CREATE POLICY "Platform admin all medic documents"
  ON storage.objects FOR ALL
  USING (
    bucket_id = 'medic-documents'
    AND is_platform_admin()
  );
```

**4. message-attachments storage RLS policies:**

Path convention: `{org_id}/{conversation_id}/{filename}`

```sql
-- Org users can upload attachments to their org folder
CREATE POLICY "Org users upload message attachments"
  ON storage.objects FOR INSERT
  WITH CHECK (
    bucket_id = 'message-attachments'
    AND auth.uid() IS NOT NULL
    AND (storage.foldername(name))[1] = (SELECT get_user_org_id())::text
  );

-- Org users can view attachments within their org folder
CREATE POLICY "Org users view message attachments"
  ON storage.objects FOR SELECT
  USING (
    bucket_id = 'message-attachments'
    AND (storage.foldername(name))[1] = (SELECT get_user_org_id())::text
  );

-- Org users can update attachments within their org folder
CREATE POLICY "Org users update message attachments"
  ON storage.objects FOR UPDATE
  USING (
    bucket_id = 'message-attachments'
    AND (storage.foldername(name))[1] = (SELECT get_user_org_id())::text
  );

-- Org users can delete attachments within their org folder
CREATE POLICY "Org users delete message attachments"
  ON storage.objects FOR DELETE
  USING (
    bucket_id = 'message-attachments'
    AND (storage.foldername(name))[1] = (SELECT get_user_org_id())::text
  );

-- Platform admin: unrestricted access to all message attachments
CREATE POLICY "Platform admin all message attachments"
  ON storage.objects FOR ALL
  USING (
    bucket_id = 'message-attachments'
    AND is_platform_admin()
  );
```
  </action>
  <verify>
Run `grep -c "INSERT INTO storage.buckets" supabase/migrations/144_comms_docs_storage.sql` — should return 2.
Run `grep -c "CREATE POLICY" supabase/migrations/144_comms_docs_storage.sql` — should return 10 (5 per bucket).
Run `grep -c "storage.foldername" supabase/migrations/144_comms_docs_storage.sql` — should return 8 (4 per bucket, excluding platform admin policies).
Run `grep -c "is_platform_admin" supabase/migrations/144_comms_docs_storage.sql` — should return 2.
  </verify>
  <done>
Migration 144 exists with 2 private storage buckets (medic-documents, message-attachments), each with 10MB limit and PDF/JPEG/PNG/DOC/DOCX allowed types. Storage RLS policies enforce org_id path scoping via (storage.foldername(name))[1] with platform admin bypass on both buckets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript type definitions for all v5.0 tables</name>
  <files>web/types/comms.types.ts</files>
  <action>
Create `web/types/comms.types.ts` following the same pattern as `web/types/database.types.ts` (manual TypeScript interfaces matching database columns).

```typescript
/**
 * v5.0 Internal Comms & Document Management TypeScript types
 *
 * Manual type definitions matching the Supabase schema from
 * 143_comms_docs_schema.sql and 144_comms_docs_storage.sql
 *
 * Phase 40: Comms & Docs Foundation
 */

// ── Messaging Types ──────────────────────────────────────────────

export type ConversationType = 'direct' | 'broadcast';
export type MessageType = 'text' | 'attachment' | 'system';
export type MessageStatus = 'sent' | 'delivered' | 'read';

export interface Conversation {
  id: string;
  org_id: string;
  type: ConversationType;
  subject: string | null;
  medic_id: string | null;
  created_by: string;
  last_message_at: string | null;
  last_message_preview: string | null;
  created_at: string;
  updated_at: string;
}

export interface Message {
  id: string;
  conversation_id: string;
  org_id: string;
  sender_id: string;
  message_type: MessageType;
  content: string | null;
  metadata: Record<string, unknown> | null;
  status: MessageStatus;
  deleted_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface MessageRecipient {
  id: string;
  message_id: string;
  recipient_id: string;
  org_id: string;
  delivered_at: string | null;
  read_at: string | null;
  created_at: string;
}

export interface ConversationReadStatus {
  user_id: string;
  conversation_id: string;
  org_id: string;
  last_read_at: string;
}

// ── Document Management Types ────────────────────────────────────

export type DocumentStatus = 'pending' | 'approved' | 'rejected' | 'expired' | 'archived';

export interface DocumentCategory {
  id: string;
  org_id: string;
  name: string;
  slug: string;
  is_required: boolean;
  is_active: boolean;
  sort_order: number;
  created_at: string;
  updated_at: string;
}

export interface Document {
  id: string;
  org_id: string;
  medic_id: string;
  category_id: string;
  current_version_id: string | null;
  status: DocumentStatus;
  reviewed_by: string | null;
  reviewed_at: string | null;
  review_notes: string | null;
  created_at: string;
  updated_at: string;
}

export interface DocumentVersion {
  id: string;
  document_id: string;
  org_id: string;
  storage_path: string;
  file_name: string;
  file_size_bytes: number | null;
  mime_type: string | null;
  issue_date: string | null;
  expiry_date: string | null;
  certificate_number: string | null;
  notes: string | null;
  version_number: number;
  uploaded_by: string;
  created_at: string;
}

// ── Convenience / Derived Types ──────────────────────────────────

/** Conversation with computed unread count (used in conversation list) */
export interface ConversationWithUnread extends Conversation {
  unread_count: number;
}

/** Message with sender profile info (used in message thread display) */
export interface MessageWithSender extends Message {
  sender_name: string;
  sender_role: string | null;
}

/** Document with current version details (used in document profile views) */
export interface DocumentWithVersion extends Document {
  category_name: string;
  category_slug: string;
  current_version: DocumentVersion | null;
}

/** Broadcast read tracking summary (used in admin broadcast view) */
export interface BroadcastReadSummary {
  message_id: string;
  total_recipients: number;
  read_count: number;
  delivered_count: number;
}
```

Do NOT modify `web/types/database.types.ts` — keep the new types in a separate file for clarity and to avoid conflicts with the existing types file.
  </action>
  <verify>
Run `grep -c "export interface" web/types/comms.types.ts` — should return at least 11.
Run `grep -c "export type" web/types/comms.types.ts` — should return at least 5.
Check that all 7 table interfaces exist: `grep -E "^export interface (Conversation|Message|MessageRecipient|ConversationReadStatus|DocumentCategory|Document|DocumentVersion) " web/types/comms.types.ts | wc -l` — should return 7.
Verify no TypeScript syntax errors: `npx tsc --noEmit web/types/comms.types.ts` (or check IDE diagnostics).
  </verify>
  <done>
TypeScript types file exists at web/types/comms.types.ts with interfaces for all 7 tables (Conversation, Message, MessageRecipient, ConversationReadStatus, DocumentCategory, Document, DocumentVersion) plus union types for enums (ConversationType, MessageType, MessageStatus, DocumentStatus) and convenience types (ConversationWithUnread, MessageWithSender, DocumentWithVersion, BroadcastReadSummary) for use in subsequent phases.
  </done>
</task>

</tasks>

<verification>
1. File exists: `ls supabase/migrations/144_comms_docs_storage.sql`
2. File exists: `ls web/types/comms.types.ts`
3. Two storage buckets created: medic-documents (private, 10MB) and message-attachments (private, 10MB)
4. Storage RLS uses `(storage.foldername(name))[1] = (SELECT get_user_org_id())::text` pattern
5. Platform admin bypass on both buckets
6. TypeScript interfaces match all columns from migration 143 tables
7. Enum types exported as union types (not TypeScript enums — matches project convention)
8. Convenience types provided for common UI patterns (conversation list, message thread, document profile)
</verification>

<success_criteria>
- Migration 144 creates 2 private storage buckets with correct file size limits and allowed MIME types
- Storage RLS policies enforce org_id path scoping on both buckets (INSERT, SELECT, UPDATE, DELETE + platform admin)
- TypeScript interfaces for all 7 v5.0 tables exist in web/types/comms.types.ts
- Types use string union types (not TypeScript enums) matching project convention
- Convenience types prepared for Phase 41+ UI work
</success_criteria>

<output>
After completion, create `.planning/phases/40-comms-docs-foundation/40-02-SUMMARY.md`
</output>
