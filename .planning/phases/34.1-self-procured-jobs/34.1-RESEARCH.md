# Phase 34.1: Self-Procured Jobs - Research

**Researched:** 2026-02-19
**Status:** Complete

## Existing Patterns to Reuse

### 1. Event Wizard (Phase 33) — Reference Architecture

**Store:** `web/stores/useEventPostingStore.ts` — Zustand with 4-step wizard
- Steps: Basic Info → Schedule & Location → Staffing & Equipment → Review
- Multi-day events, per-day staffing requirements, equipment checklist, draft persistence
- Actions: setStep, updateField, add/remove for dynamic arrays, loadDraft, reset

**Types:** `web/lib/marketplace/event-types.ts`
- Status workflow: draft → open → closed | cancelled | awarded
- Event types: construction, tv_film, motorsport, festivals, sporting_events, corporate, private_events, other
- Staffing roles: paramedic, emt, first_aider, doctor, nurse, other
- Equipment types: ambulance, defibrillator, first_aid_tent, stretcher, oxygen_supply, other

**Validation:** `web/lib/marketplace/event-schemas.ts`
- Step-level schemas: basicInfoSchema, schedulingSchema, staffingSchema
- Combined: eventFormSchema with budget_min ≤ budget_max
- Post-quote restrictions: eventUpdatePostQuotesSchema (EVNT-05)

**API Route:** `web/app/api/marketplace/events/route.ts`
- POST: Validate with Zod → auth check → create marketplace_events → set PostGIS location → insert event_days → insert staffing_requirements
- GET: Filter by status, type, posted_by, location radius, role; pagination

**Migration 145:** marketplace_events, event_days, event_staffing_requirements
- marketplace_events: posted_by, event_name, event_type, description, indoor_outdoor, expected_attendance, budget_min/max, location fields, quote_deadline, status, has_quotes, quote_count, equipment_required (JSONB)
- event_days: event_id (CASCADE), event_date, start_time, end_time, sort_order; UNIQUE(event_id, event_date)
- event_staffing_requirements: event_id (CASCADE), event_day_id (CASCADE, nullable=all days), role, quantity, additional_notes
- RLS: event_poster_manage_own, verified_companies_browse_open, platform_admin_all_events

### 2. Booking System & Revenue Split

**Source column (Migration 140):** `bookings.source` = 'direct' | 'marketplace'

**Per-medic revenue split (Migration 115):**
- `medics.platform_fee_percent` (DEFAULT 60) — overrideable per medic
- `medics.medic_payout_percent` (DEFAULT 40) — must sum to 100
- CONSTRAINT: sum = 100 (0.01 tolerance)

**Booking pricing (web/lib/booking/pricing.ts):**
1. hourly_total = base_rate × shift_hours
2. urgency_amount = hourly_total × (urgency_premium_percent / 100)
3. subtotal = hourly_total + urgency_amount + travel_surcharge
4. vat = subtotal × 0.20 (UK VAT)
5. total = subtotal + vat
6. platform_fee = total × (platform_fee_percent / 100)
7. medic_payout = total × (medic_payout_percent / 100)

**Referral system (Migration 115):**
- Booking columns: is_referral, referred_by, referral_payout_percent, referral_payout_amount, platform_net
- referral_payout = subtotal × referral_payout_percent / 100 (PRE-VAT)
- platform_net = platform_fee - referral_payout_amount

### 3. Quote System (Phase 34) — Adjacent Patterns

**Types:** `web/lib/marketplace/quote-types.ts`
- Status: draft | submitted | revised | withdrawn
- Staffing plan: named_medics | headcount_and_quals (discriminated union)
- Pricing breakdown (JSONB): staff_cost, equipment_cost, transport_cost, consumables_cost, custom_line_items[]

**Store:** `web/stores/useQuoteFormStore.ts` — Multi-section form with auto-save
- 2-second debounce draft auto-save, loadDraft/saveDraft
- Discriminated staffing plan type switch clears opposite type

**API:** `web/app/api/marketplace/quotes/submit/route.ts`
- Flow: Zod validate → auth → verify company (verified + can_submit_quotes) → check event open + deadline → validate minimum rates (HARD block) → check duplicates → insert/update

**Migration 146:** marketplace_quotes
- event_id (CASCADE), company_id (CASCADE), total_price, pricing_breakdown (JSONB), staffing_plan (JSONB), cover_letter, status, submitted_at
- RLS: company_manage_own, event_poster_view (non-draft), platform_admin_all
- Trigger: update_event_quote_count syncs has_quotes + quote_count

### 4. Marketplace Company Model (Phase 32)

**Types:** `web/lib/marketplace/types.ts`
- org_id (nullable FK organizations) — bidirectional crossover
- admin_user_id (FK auth.users), CQC fields, company details
- Stripe Connect: stripe_account_id
- Verification: pending | cqc_verified | verified | rejected | suspended | info_requested
- Flags: can_browse_events, can_submit_quotes

**Medic Commitments (Migration 140):**
- medic_id (FK medics), booking_id (FK bookings, nullable), marketplace_company_id (FK), event_date, time_range (TSRANGE)
- EXCLUSION USING GIST (medic_id WITH =, time_range WITH &&) — prevents double-booking at DB level

### 5. Dashboard Patterns

**My Events:** `web/app/marketplace/my-events/page.tsx`
- Events posted by current user, filters by status/search
- Table: Event | Type | Dates | Status | Quotes | Deadline | Actions
- Status-based actions: Draft (Edit, Publish, Delete), Open (Edit, Close, Cancel), Closed/Cancelled/Awarded (View)

**Company Profile:** `web/app/marketplace/companies/[id]/page.tsx`
- Verification badge, star rating, About, Certifications, Insurance & Compliance
- Contact details restricted: hidden unless awarded + deposit-paid

## Architecture Decisions for Phase 34.1

### Database Strategy
- **Reuse existing `bookings` table** with `source='direct'` — NO new tables for jobs
- **Reuse marketplace_events table** for self-procured events (add `source` column or use `is_self_procured` flag)
- **Alternative:** Create `direct_jobs` table that mirrors marketplace_events but simpler — avoids polluting marketplace queries
- **Recommended:** Reuse `marketplace_events` with a `source` column ('marketplace' | 'direct') — DRY, same schema, same timesheet/payout integration. Filter in RLS and queries.
- Add `agreed_price` field if not present (self-procured has fixed price, not budget range + quote competition)
- Client records: may need a `direct_clients` table or extend existing client model

### Self-Procured Job Flow (Simplified vs Marketplace)
| Aspect | Marketplace | Self-Procured |
|--------|------------|---------------|
| Entry point | /marketplace/post-event | /dashboard/log-job |
| Pricing | Budget range → quotes → award | Fixed agreed price upfront |
| Medic selection | Quote competition → award winner | Company assigns from roster directly |
| Commission | 60/40 (configurable per medic) | 0% platform / 100% company |
| Payment | Deposit on award + remainder post-event | Deposit on creation + remainder post-event |
| Quote deadline | Yes | N/A |
| Anonymisation | Yes (until award + deposit) | N/A (company knows client) |
| Status flow | draft → open → awarded → completed | draft → confirmed → in_progress → completed |

### Key Implementation Notes
1. **Self-procured jobs use `bookings.source='direct'`**
2. **Platform commission = 0%** — set `platform_fee_percent=0, medic_payout_percent=100`
3. **Full client record** — name, contact, address (not free text)
4. **Entry point:** SiteMedic dashboard "Log Job" button (NOT marketplace section)
5. **Dashboard:** Single filterable view with source badges ("Marketplace" / "Direct")
6. **Medic availability:** Check medic_commitments EXCLUSION constraint
7. **Compliance:** Full timesheets, PDFs, RIDDOR — same as marketplace
8. **Payment:** Stripe checkout deposit + remainder, same flow
9. **Payout:** Friday Stripe Connect pipeline, 0% platform fee

## Key File Locations

| Category | Path |
|----------|------|
| Event types | `web/lib/marketplace/event-types.ts` |
| Company model | `web/lib/marketplace/types.ts` |
| Quote types | `web/lib/marketplace/quote-types.ts` |
| Event wizard store | `web/stores/useEventPostingStore.ts` |
| Quote form store | `web/stores/useQuoteFormStore.ts` |
| Event schemas | `web/lib/marketplace/event-schemas.ts` |
| Minimum rates | `web/lib/marketplace/minimum-rates.ts` |
| Scoring algo | `web/lib/marketplace/quote-scoring.ts` |
| Event API | `web/app/api/marketplace/events/route.ts` |
| Quote submit API | `web/app/api/marketplace/quotes/submit/route.ts` |
| Booking match API | `web/app/api/bookings/match/route.ts` |
| My Events page | `web/app/marketplace/my-events/page.tsx` |
| Company profile | `web/app/marketplace/companies/[id]/page.tsx` |
| Pricing logic | `web/lib/booking/pricing.ts` |
| Booking types | `web/lib/booking/types.ts` |
| Migration 145 | `supabase/migrations/145_marketplace_events.sql` |
| Migration 146 | `supabase/migrations/146_marketplace_quotes.sql` |
| Migration 140 | `supabase/migrations/140_marketplace_foundation.sql` |
| Migration 115 | `supabase/migrations/115_referral_and_per_medic_rates.sql` |

## RESEARCH COMPLETE
