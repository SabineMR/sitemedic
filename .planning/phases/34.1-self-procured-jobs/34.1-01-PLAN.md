---
phase: 34.1-self-procured-jobs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/147_direct_jobs.sql
  - web/lib/direct-jobs/types.ts
  - web/lib/direct-jobs/schemas.ts
  - web/app/api/direct-jobs/route.ts
  - web/app/api/direct-jobs/[id]/route.ts
  - web/lib/queries/direct-jobs.ts
autonomous: true

must_haves:
  truths:
    - "Direct job records can be created with client details, event info, multi-day schedule, staffing, and agreed price"
    - "Direct jobs are stored alongside marketplace events with source='direct' discrimination"
    - "Client records are persisted as formal database rows (name, contact, address)"
    - "Direct jobs use 0% platform commission (platform_fee_percent=0, medic_payout_percent=100)"
  artifacts:
    - path: "supabase/migrations/147_direct_jobs.sql"
      provides: "direct_clients table, marketplace_events.source column, marketplace_events.agreed_price column, direct job status enum"
      contains: "direct_clients"
    - path: "web/lib/direct-jobs/types.ts"
      provides: "TypeScript types for direct clients, direct job, direct job status"
      exports: ["DirectClient", "DirectJob", "DirectJobStatus"]
    - path: "web/lib/direct-jobs/schemas.ts"
      provides: "Zod validation schemas for job wizard steps and combined form"
      exports: ["clientDetailsSchema", "jobInfoSchema", "jobScheduleSchema", "jobStaffingSchema", "jobPricingSchema", "directJobFormSchema"]
    - path: "web/app/api/direct-jobs/route.ts"
      provides: "POST create + GET list endpoints for direct jobs"
      exports: ["POST", "GET"]
    - path: "web/app/api/direct-jobs/[id]/route.ts"
      provides: "GET single + PUT update + DELETE endpoints for direct jobs"
      exports: ["GET", "PUT", "DELETE"]
    - path: "web/lib/queries/direct-jobs.ts"
      provides: "Supabase query functions for direct jobs and clients"
      exports: ["fetchDirectJobs", "fetchDirectJobById", "createDirectClient"]
  key_links:
    - from: "web/lib/direct-jobs/types.ts"
      to: "supabase/migrations/147_direct_jobs.sql"
      via: "TypeScript mirrors SQL schema"
      pattern: "DirectClient.*DirectJob"
    - from: "web/app/api/direct-jobs/route.ts"
      to: "web/lib/direct-jobs/schemas.ts"
      via: "Zod validation on POST"
      pattern: "directJobFormSchema.safeParse"
---

<objective>
Create the database foundation, TypeScript types, Zod validation schemas, and CRUD API routes for self-procured direct jobs.

Purpose: Establishes the data layer that all subsequent plans depend on -- the direct_clients table for client records, the source/agreed_price columns on marketplace_events for direct job discrimination, and the API routes for creating and listing direct jobs.

Output: Migration 147, TypeScript types, Zod schemas, and 5 API endpoints (create, list, get, update, delete).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34.1-self-procured-jobs/34.1-CONTEXT.md
@.planning/phases/34.1-self-procured-jobs/34.1-RESEARCH.md

Key reference files:
@web/lib/marketplace/event-types.ts (EventType, StaffingRole, EquipmentItem, IndoorOutdoor enums to reuse)
@web/lib/marketplace/event-schemas.ts (Zod patterns to follow)
@web/lib/marketplace/types.ts (MarketplaceCompany, BookingSource types)
@web/app/api/marketplace/events/route.ts (API pattern to follow)
@web/lib/booking/pricing.ts (pricing formula reference)
@supabase/migrations/145_marketplace_events.sql (marketplace_events schema to extend)
@supabase/migrations/140_marketplace_foundation.sql (bookings.source column, medic_commitments)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and TypeScript types</name>
  <files>
    supabase/migrations/147_direct_jobs.sql
    web/lib/direct-jobs/types.ts
  </files>
  <action>
Create migration 147_direct_jobs.sql with the following changes:

1. **direct_clients table** -- formal client records for self-procured jobs:
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - company_id UUID NOT NULL REFERENCES marketplace_companies(id) ON DELETE RESTRICT (the company that created this client record)
   - created_by UUID NOT NULL REFERENCES auth.users(id)
   - client_name TEXT NOT NULL
   - contact_name TEXT (may differ from company name)
   - contact_email TEXT
   - contact_phone TEXT
   - address_line_1 TEXT
   - address_line_2 TEXT
   - city TEXT
   - postcode TEXT
   - notes TEXT
   - created_at TIMESTAMPTZ DEFAULT now()
   - updated_at TIMESTAMPTZ DEFAULT now()
   - RLS: company admin can CRUD own company's clients (WHERE company_id IN (SELECT id FROM marketplace_companies WHERE admin_user_id = auth.uid()))
   - Platform admin has full access
   - Index on company_id

2. **Add columns to marketplace_events table**:
   - source TEXT NOT NULL DEFAULT 'marketplace' CHECK (source IN ('marketplace', 'direct'))
   - agreed_price NUMERIC(10,2) (null for marketplace events which use budget_min/max; required for direct jobs)
   - client_id UUID REFERENCES direct_clients(id) ON DELETE SET NULL (null for marketplace events)
   - Index on source for filtering
   - Update existing rows: UPDATE marketplace_events SET source = 'marketplace' WHERE source IS NULL (safety, though default handles it)

3. **Direct job status values**: Extend the marketplace_events.status CHECK constraint to include direct job statuses. The existing constraint allows: 'draft', 'open', 'closed', 'cancelled', 'awarded'. Add: 'confirmed', 'in_progress', 'completed'. Use ALTER TABLE ... DROP CONSTRAINT ... ADD CONSTRAINT to update the check.

4. **RLS updates for marketplace_events**: Add a new policy allowing company admin to manage their own direct jobs:
   - company_manage_own_direct_jobs: SELECT/INSERT/UPDATE/DELETE WHERE source = 'direct' AND posted_by = auth.uid()
   - The existing event_poster_manage_own policy covers marketplace events; this new one explicitly covers direct jobs

5. **Trigger**: update_marketplace_events_updated_at trigger (if not already present)

Then create `web/lib/direct-jobs/types.ts`:

```typescript
// Import shared types from marketplace
import type { EventType, StaffingRole, IndoorOutdoor, EquipmentItem } from '@/lib/marketplace/event-types';

// Direct job status: draft -> confirmed -> in_progress -> completed | cancelled
export type DirectJobStatus = 'draft' | 'confirmed' | 'in_progress' | 'completed' | 'cancelled';

export interface DirectClient {
  id: string;
  company_id: string;
  created_by: string;
  client_name: string;
  contact_name: string | null;
  contact_email: string | null;
  contact_phone: string | null;
  address_line_1: string | null;
  address_line_2: string | null;
  city: string | null;
  postcode: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

// A direct job is a marketplace_event with source='direct'
export interface DirectJob {
  id: string;
  posted_by: string;
  source: 'direct';
  client_id: string | null;
  client: DirectClient | null; // Joined
  event_name: string;          // Job name/title
  event_type: EventType;
  event_description: string | null;
  special_requirements: string | null;
  indoor_outdoor: IndoorOutdoor;
  expected_attendance: number | null;
  agreed_price: number;        // Fixed agreed price (required for direct)
  location_postcode: string;
  location_address: string | null;
  location_what3words: string | null;
  location_display: string | null;
  status: DirectJobStatus;
  equipment_required: EquipmentItem[];
  created_at: string;
  updated_at: string;
  // Related data (joined)
  event_days: Array<{
    id: string;
    event_date: string;
    start_time: string;
    end_time: string;
    sort_order: number;
  }>;
  event_staffing_requirements: Array<{
    id: string;
    event_day_id: string | null;
    role: StaffingRole;
    quantity: number;
    additional_notes: string | null;
  }>;
}

// Source badge labels
export const SOURCE_LABELS: Record<string, string> = {
  marketplace: 'Marketplace',
  direct: 'Direct',
};

export const DIRECT_JOB_STATUS_LABELS: Record<DirectJobStatus, string> = {
  draft: 'Draft',
  confirmed: 'Confirmed',
  in_progress: 'In Progress',
  completed: 'Completed',
  cancelled: 'Cancelled',
};
```

IMPORTANT: Do NOT modify existing migration files. Migration 147 is a new file. The marketplace_events table is extended with ALTER TABLE, not recreated.
  </action>
  <verify>
    - File exists: supabase/migrations/147_direct_jobs.sql
    - File exists: web/lib/direct-jobs/types.ts
    - Migration SQL is syntactically valid (no obvious errors)
    - Types file exports DirectClient, DirectJob, DirectJobStatus, SOURCE_LABELS, DIRECT_JOB_STATUS_LABELS
    - Types import from @/lib/marketplace/event-types
  </verify>
  <done>
    - direct_clients table defined with all columns, RLS, and indexes
    - marketplace_events extended with source, agreed_price, client_id columns
    - Status constraint updated to include direct job statuses
    - TypeScript types mirror SQL schema exactly
    - Source label map available for badge rendering
  </done>
</task>

<task type="auto">
  <name>Task 2: Zod schemas, query functions, and API routes</name>
  <files>
    web/lib/direct-jobs/schemas.ts
    web/lib/queries/direct-jobs.ts
    web/app/api/direct-jobs/route.ts
    web/app/api/direct-jobs/[id]/route.ts
  </files>
  <action>
Create `web/lib/direct-jobs/schemas.ts` with step-level Zod schemas for the job wizard. Follow the pattern from `web/lib/marketplace/event-schemas.ts`:

1. **clientDetailsSchema** -- Step 1 of wizard:
   - client_name: z.string().min(2).max(200) (required)
   - contact_name: z.string().max(200).optional().nullable()
   - contact_email: z.string().email().optional().nullable()
   - contact_phone: z.string().max(20).optional().nullable()
   - address_line_1: z.string().max(500).optional().nullable()
   - address_line_2: z.string().max(500).optional().nullable()
   - city: z.string().max(100).optional().nullable()
   - postcode: z.string().regex(ukPostcodeRegex).optional().nullable() (same regex from event-schemas.ts)
   - existing_client_id: z.string().uuid().optional().nullable() (select existing client OR create new)

2. **jobInfoSchema** -- Step 2 (reuse basicInfoSchema shape):
   - event_name: z.string().min(3).max(200) (this is the "job name")
   - event_type: z.enum([...EventType values])
   - event_description: z.string().max(5000).optional().nullable()
   - special_requirements: z.string().max(2000).optional().nullable()
   - indoor_outdoor: z.enum(['indoor', 'outdoor', 'mixed'])
   - expected_attendance: z.number().int().min(1).max(1000000).optional().nullable()

3. **jobScheduleSchema** -- Step 3 (same as schedulingSchema but WITHOUT quote_deadline):
   - event_days: z.array(...).min(1) (same shape as event-schemas.ts)
   - location_postcode, location_address, location_what3words, location_lat, location_lng, location_display
   - NO quote_deadline field (direct jobs don't have quote deadlines)

4. **jobStaffingSchema** -- Step 4 (same as staffingSchema but WITHOUT budget_min/max):
   - staffing_requirements: z.array(...).min(1)
   - equipment_required: z.array(...).default([])
   - NO budget_min/budget_max (direct jobs have agreed_price instead)

5. **jobPricingSchema** -- Step 5 (new for direct jobs):
   - agreed_price: z.number().min(1, 'Price must be at least 1.00')
   - deposit_percent: z.number().min(0).max(100).default(25) (configurable deposit %, default 25%)
   - notes: z.string().max(2000).optional().nullable()

6. **directJobFormSchema** -- Combined (merge all 5, no refinements needed since no budget_min/max comparison)

Create `web/lib/queries/direct-jobs.ts` with Supabase query functions:
- fetchDirectJobs(supabase, { companyId?, status?, source?, page?, limit? }) -- returns paginated list with client + event_days + staffing joined
- fetchDirectJobById(supabase, jobId) -- single job with all relations
- createDirectClient(supabase, clientData) -- insert into direct_clients, return client
- fetchDirectClients(supabase, companyId) -- list company's clients for dropdown

Create `web/app/api/direct-jobs/route.ts`:
- POST: Validate with directJobFormSchema -> auth check -> verify user is company admin with active subscription (check marketplace_companies.org_id links to organizations with active subscription_tier) -> create/find client record -> insert marketplace_events with source='direct' + agreed_price + client_id -> insert event_days -> insert staffing_requirements -> return { success: true, jobId }
- GET: Auth check -> list direct jobs for current user's company (source='direct') -> support status/page/limit filters -> return paginated list

Create `web/app/api/direct-jobs/[id]/route.ts`:
- GET: Auth check -> fetch single direct job by ID (verify source='direct' and user owns it) -> return with client + days + staffing
- PUT: Auth check -> validate partial update -> update marketplace_events row -> return updated job
- DELETE: Auth check -> only allow if status='draft' -> delete (CASCADE handles days + staffing) -> return success

IMPORTANT: The POST route must set platform_fee_percent=0 and medic_payout_percent=100 on any booking created from this job. For now, these values are stored as part of the agreed_price context (the actual booking creation happens in Plan 04). The event row itself stores source='direct' which downstream logic uses to determine 0% commission.

Follow the exact patterns from web/app/api/marketplace/events/route.ts for the API structure (NextRequest/NextResponse, Supabase client creation, error handling format).
  </action>
  <verify>
    - pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web build (or at minimum `pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web tsc --noEmit`) passes with no errors related to direct-jobs files
    - All 6 Zod schemas export correctly
    - API routes follow Next.js App Router conventions (named exports POST, GET, PUT, DELETE)
    - Query functions use typed Supabase client parameter
  </verify>
  <done>
    - 6 Zod schemas validate all wizard steps + combined form
    - 4 query functions handle CRUD operations for direct jobs and clients
    - POST /api/direct-jobs creates a direct job with client record and event data
    - GET /api/direct-jobs lists direct jobs with filtering and pagination
    - GET /api/direct-jobs/[id] returns a single direct job with all relations
    - PUT /api/direct-jobs/[id] updates a direct job
    - DELETE /api/direct-jobs/[id] deletes a draft direct job
  </done>
</task>

</tasks>

<verification>
- Migration 147 SQL file exists and is syntactically correct
- TypeScript types compile without errors
- Zod schemas cover all 5 wizard steps
- API routes handle authentication, validation, and error responses
- Query functions accept typed Supabase client and return typed results
- No modifications to existing migration files
</verification>

<success_criteria>
1. direct_clients table schema defined with RLS policies
2. marketplace_events extended with source, agreed_price, client_id columns
3. TypeScript types mirror SQL schema for DirectClient and DirectJob
4. Zod schemas validate each wizard step independently and combined
5. CRUD API routes for direct jobs follow established codebase patterns
6. All new files compile cleanly with existing codebase
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-self-procured-jobs/34.1-01-SUMMARY.md`
</output>
