---
phase: 34.1-self-procured-jobs
plan: 01
subsystem: database, api
tags: [supabase, postgresql, rls, zod, nextjs, api-routes, direct-jobs]

# Dependency graph
requires:
  - phase: 32-marketplace-foundation
    provides: marketplace_companies table, bookings.source column, medic_commitments
  - phase: 33-event-posting
    provides: marketplace_events table, event_days, event_staffing_requirements, PostGIS
provides:
  - direct_clients table for client records
  - marketplace_events.source column for direct/marketplace discrimination
  - marketplace_events.agreed_price column for direct job pricing
  - marketplace_events.client_id FK to direct_clients
  - Extended status constraint (confirmed, in_progress, completed)
  - TypeScript types (DirectClient, DirectJob, DirectJobStatus)
  - Zod schemas for 5-step wizard validation
  - CRUD API routes (create, list, get, update, delete)
  - Supabase query functions for direct jobs and clients
affects: [34.1-02 wizard UI, 34.1-03 dashboard integration, 34.1-04 payment flow, 34.1-05 client portal]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "source='direct' discrimination on marketplace_events for self-procured jobs"
    - "direct_clients table for company-owned client records"
    - "Multi-step Zod schemas (5 steps) merged into directJobFormSchema"
    - "quote_deadline set to 2099-12-31 for direct jobs (NOT NULL constraint workaround)"

key-files:
  created:
    - supabase/migrations/147_direct_jobs.sql
    - web/lib/direct-jobs/types.ts
    - web/lib/direct-jobs/schemas.ts
    - web/lib/queries/direct-jobs.ts
    - web/app/api/direct-jobs/route.ts
    - web/app/api/direct-jobs/[id]/route.ts
  modified: []

key-decisions:
  - "Direct jobs use source='direct' on marketplace_events (not a separate table)"
  - "agreed_price is nullable on marketplace_events (null for marketplace, required for direct)"
  - "Direct job default status is 'confirmed' (not 'open' — no quoting process)"
  - "quote_deadline set to far-future sentinel (2099-12-31) for direct jobs since column is NOT NULL"
  - "DELETE restricted to draft-only jobs — non-drafts must be cancelled instead"
  - "Company admin verified via marketplace_companies.admin_user_id = auth.uid()"

patterns-established:
  - "Direct job API routes at /api/direct-jobs follow same auth+validation+error pattern as /api/marketplace/events"
  - "directJobUpdateSchema uses all-optional fields for partial PUT updates"
  - "Client records resolved on POST: existing_client_id OR new client fields"

# Metrics
duration: 8min
completed: 2026-02-20
---

# Phase 34.1 Plan 01: Data Layer & API Routes Summary

**direct_clients table, marketplace_events source/agreed_price/client_id columns, 6 Zod wizard schemas, and 5 CRUD API endpoints for self-procured direct jobs**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-20T00:21:02Z
- **Completed:** 2026-02-20T00:29:13Z
- **Tasks:** 2
- **Files created:** 6

## Accomplishments
- Created direct_clients table with RLS (company admin + platform admin) and updated_at trigger
- Extended marketplace_events with source, agreed_price, client_id columns and expanded status constraint
- Built 6 Zod schemas for the 5-step wizard plus a combined form schema and partial update schema
- Implemented 5 API endpoints: POST create, GET list, GET single, PUT update, DELETE (draft-only)
- Created typed Supabase query functions for direct jobs and client records

## Task Commits

Each task was committed atomically:

1. **Task 1: Database migration and TypeScript types** - `dc250f5` (feat)
2. **Task 2: Zod schemas, query functions, and API routes** - `91338f5` (feat)

## Files Created/Modified
- `supabase/migrations/147_direct_jobs.sql` - direct_clients table, marketplace_events extensions, RLS policies, indexes
- `web/lib/direct-jobs/types.ts` - DirectClient, DirectJob, DirectJobStatus interfaces and label maps
- `web/lib/direct-jobs/schemas.ts` - 6 Zod schemas for wizard steps + combined form + update schema
- `web/lib/queries/direct-jobs.ts` - fetchDirectJobs, fetchDirectJobById, createDirectClient, fetchDirectClients
- `web/app/api/direct-jobs/route.ts` - POST create + GET list endpoints
- `web/app/api/direct-jobs/[id]/route.ts` - GET single + PUT update + DELETE endpoints

## Decisions Made
- **source='direct' discrimination**: Direct jobs stored in marketplace_events with source column rather than a separate table, maintaining single-table queries for combined dashboard views
- **agreed_price nullable**: Column is nullable on marketplace_events since marketplace events use budget_min/max instead; Zod enforces it as required for direct jobs
- **Default status 'confirmed'**: Direct jobs skip the marketplace quoting process, so non-draft jobs start as 'confirmed' (not 'open')
- **quote_deadline sentinel**: Set to 2099-12-31T23:59:59Z for direct jobs since the column is NOT NULL in the original schema; avoids altering the NOT NULL constraint
- **DELETE restricted to drafts**: Non-draft jobs have downstream implications (staffing, payments) so they must be cancelled rather than hard-deleted
- **Client resolution on POST**: The POST endpoint handles both creating new clients and linking to existing ones via existing_client_id field

## Deviations from Plan
None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required. Migration 147 will need to be applied to production Supabase alongside pending migrations (140-146).

## Next Phase Readiness
- Data layer complete: direct_clients table, marketplace_events extensions, TypeScript types, Zod schemas, and API routes all ready
- Plan 02 (Wizard UI) can build on the schemas and API routes created here
- Plan 03 (Dashboard) can use the source='direct' filter and SOURCE_LABELS for badge rendering
- Migration 147 needs to be applied to the production database before any direct jobs features go live

---
*Phase: 34.1-self-procured-jobs*
*Completed: 2026-02-20*
