---
phase: 34.1-self-procured-jobs
plan: 05
subsystem: api, ui
tags: [supabase, rls, ratings, client-portal, next.js, lucide]

# Dependency graph
requires:
  - phase: 34.1-01
    provides: direct_clients table, marketplace_events source/agreed_price/client_id columns
  - phase: 34.1-02
    provides: job creation wizard, jobs list page
  - phase: 34.1-03
    provides: combined jobs view, source filtering
provides:
  - Client-safe API endpoint excluding medic personal information
  - Client portal page for read-only job viewing
  - job_ratings table with RLS and bidirectional rating support
  - RatingForm and StarDisplay components
  - Ratings API (GET/POST) with completed-job enforcement
affects: [36-ratings-messaging-disputes, 34.1-CONTEXT]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "ClientSafeJob type pattern for stripping medic details from API responses"
    - "Upsert pattern for UNIQUE constraint on job_id + rater_user_id ratings"
    - "StarRatingInput with hover state for interactive star selection"

key-files:
  created:
    - web/app/api/direct-jobs/[id]/client-access/route.ts
    - web/app/(dashboard)/dashboard/jobs/[id]/client-portal/page.tsx
    - web/components/direct-jobs/ClientPortalView.tsx
    - web/app/api/direct-jobs/[id]/ratings/route.ts
    - web/components/direct-jobs/RatingForm.tsx
    - supabase/migrations/148_direct_job_ratings.sql
  modified:
    - web/app/(dashboard)/dashboard/jobs/[id]/page.tsx

key-decisions:
  - "job_ratings table in separate migration 148 (not appended to 147)"
  - "RLS uses split INSERT/UPDATE/DELETE policies (not FOR ALL) for rater's own ratings"
  - "is_platform_admin() function reused from migration 101 pattern"
  - "Rating section only visible when job status is 'completed'"
  - "deposit_percent defaults to 25% in API (no DB column yet)"
  - "Compliance reports returns empty array -- placeholder for future integration"
  - "Payment deposit_paid always false -- placeholder for Stripe integration in Phase 35"

patterns-established:
  - "ClientSafeJob interface: client-facing data shape with medic info stripped"
  - "StarDisplay read-only component for rating display across the app"
  - "Upsert with onConflict for idempotent rating submission"

# Metrics
duration: 13min
completed: 2026-02-19
---

# Phase 34.1 Plan 05: Client Portal & Bidirectional Ratings Summary

**Client-safe portal API excluding medic details, read-only ClientPortalView with payment/schedule/staffing sections, and 5-star bidirectional rating system with Lucide Star icons**

## Performance

- **Duration:** 13 min
- **Started:** 2026-02-20T00:52:09Z
- **Completed:** 2026-02-20T01:04:39Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Client-access API returns job data with staffing aggregated to role counts only (no medic IDs/names/contact)
- Client portal page provides professional read-only view with schedule table, payment breakdown, equipment, and compliance report placeholders
- job_ratings table with 5 RLS policies supporting bidirectional ratings (company rates client, client rates company)
- Interactive RatingForm with hover-state star selection and review textarea integrated into job detail page for completed jobs

## Task Commits

Each task was committed atomically:

1. **Task 1: Client portal API and page** - `345fd47` (feat)
2. **Task 2: Bidirectional ratings for direct jobs** - `bfc62cc` (feat)

## Files Created/Modified
- `web/app/api/direct-jobs/[id]/client-access/route.ts` - GET endpoint returning ClientSafeJob with medic info stripped
- `web/components/direct-jobs/ClientPortalView.tsx` - Read-only job view with 7 sections (overview, schedule, staffing, location, payment, equipment, compliance)
- `web/app/(dashboard)/dashboard/jobs/[id]/client-portal/page.tsx` - Client portal preview page with share-link button
- `supabase/migrations/148_direct_job_ratings.sql` - job_ratings table, 5 RLS policies, indexes, updated_at trigger
- `web/app/api/direct-jobs/[id]/ratings/route.ts` - GET ratings with average, POST upsert rating (completed jobs only)
- `web/components/direct-jobs/RatingForm.tsx` - 5-star interactive selector with StarDisplay read-only component
- `web/app/(dashboard)/dashboard/jobs/[id]/page.tsx` - Added rating section visible for completed jobs

## Decisions Made
- Created separate migration 148 for ratings table rather than appending to 147 -- cleaner migration boundaries
- Used split RLS policies (INSERT, UPDATE, DELETE separate) instead of FOR ALL for rater's own ratings -- clearer access control
- deposit_percent defaults to 25% in the API since there's no DB column for it yet -- will be driven by form data when payment integration completes
- compliance_reports and payment.deposit_paid return placeholder values -- will be populated by Phase 35 (Award Flow) and compliance reporting

## Deviations from Plan

None -- plan executed exactly as written.

## Issues Encountered
- Supabase returns `direct_clients` FK join as a typed array rather than single object in TypeScript -- fixed with `as unknown as` cast pattern consistent with existing codebase
- Job detail page files already existed from a prior commit (Plan 04 was already executed) -- integration proceeded as planned

## User Setup Required

None -- no external service configuration required. Migration 148 needs to be applied to production when ready.

## Next Phase Readiness
- Client portal and ratings complete all Plan 05 requirements
- Phase 34.1 is now fully complete (Plans 01-05 all executed)
- Migration 148 (job_ratings) needs to be added to the production migration backlog
- Phase 36 (Ratings, Messaging & Disputes) can extend the job_ratings table for marketplace ratings

---
*Phase: 34.1-self-procured-jobs*
*Completed: 2026-02-19*
