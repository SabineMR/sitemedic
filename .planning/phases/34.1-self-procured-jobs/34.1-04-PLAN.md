---
phase: 34.1-self-procured-jobs
plan: 04
type: execute
wave: 3
depends_on: ["34.1-02"]
files_modified:
  - web/app/api/direct-jobs/[id]/payment/route.ts
  - web/app/api/direct-jobs/[id]/confirm/route.ts
  - web/app/api/direct-jobs/[id]/assign-medic/route.ts
  - web/app/(dashboard)/dashboard/jobs/[id]/page.tsx
  - web/lib/direct-jobs/booking-bridge.ts
autonomous: true

must_haves:
  truths:
    - "The client pays through SiteMedic's Stripe checkout with a deposit amount based on agreed_price * deposit_percent"
    - "A booking record with source='direct' is created when the job is confirmed"
    - "The booking uses 0% platform commission (platform_fee_percent=0, medic_payout_percent=100)"
    - "Company can assign medics to the job with the same availability checking as marketplace (medic_commitments EXCLUSION constraint)"
  artifacts:
    - path: "web/app/api/direct-jobs/[id]/payment/route.ts"
      provides: "Stripe PaymentIntent creation for deposit payment"
      exports: ["POST"]
    - path: "web/app/api/direct-jobs/[id]/confirm/route.ts"
      provides: "Confirm job and create booking with source='direct'"
      exports: ["POST"]
    - path: "web/app/api/direct-jobs/[id]/assign-medic/route.ts"
      provides: "Assign medic from roster with availability checking"
      exports: ["POST", "DELETE"]
    - path: "web/lib/direct-jobs/booking-bridge.ts"
      provides: "Creates booking record from direct job with 0% commission"
      exports: ["createDirectJobBooking"]
    - path: "web/app/(dashboard)/dashboard/jobs/[id]/page.tsx"
      provides: "Job detail page with payment, medic assignment, and status management"
      min_lines: 100
  key_links:
    - from: "web/app/api/direct-jobs/[id]/confirm/route.ts"
      to: "web/lib/direct-jobs/booking-bridge.ts"
      via: "createDirectJobBooking call"
      pattern: "createDirectJobBooking"
    - from: "web/lib/direct-jobs/booking-bridge.ts"
      to: "bookings table"
      via: "Supabase insert with source='direct'"
      pattern: "source.*direct.*platform_fee_percent.*0"
    - from: "web/app/api/direct-jobs/[id]/assign-medic/route.ts"
      to: "medic_commitments table"
      via: "INSERT with EXCLUSION constraint check"
      pattern: "medic_commitments"
---

<objective>
Implement the payment flow (Stripe deposit + remainder), booking creation bridge, medic assignment with availability checking, and the job detail page for managing direct jobs.

Purpose: Connects self-procured jobs to the existing SiteMedic booking and payment infrastructure. The client pays via Stripe, a booking record is created with source='direct' and 0% commission, and medics are assigned with the same EXCLUSION constraint protection as marketplace jobs.

Output: Payment API, confirm API, medic assignment API, booking bridge function, and job detail page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34.1-self-procured-jobs/34.1-CONTEXT.md
@.planning/phases/34.1-self-procured-jobs/34.1-RESEARCH.md
@.planning/phases/34.1-self-procured-jobs/34.1-01-SUMMARY.md
@.planning/phases/34.1-self-procured-jobs/34.1-02-SUMMARY.md

Key reference files:
@web/lib/booking/pricing.ts (pricing formula with platform_fee_percent, 0% commission pattern)
@web/lib/booking/types.ts (PricingBreakdown, BookingFormData)
@web/lib/direct-jobs/types.ts (DirectJob, DirectClient)
@web/lib/marketplace/types.ts (MedicCommitment, MarketplaceCompany)
@supabase/migrations/140_marketplace_foundation.sql (medic_commitments EXCLUSION constraint, bookings.source column)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Booking bridge and payment/confirm API routes</name>
  <files>
    web/lib/direct-jobs/booking-bridge.ts
    web/app/api/direct-jobs/[id]/payment/route.ts
    web/app/api/direct-jobs/[id]/confirm/route.ts
  </files>
  <action>
Create `web/lib/direct-jobs/booking-bridge.ts`:
- Pure function `createDirectJobBooking(supabase, directJob, paymentIntentId?)` that:
  1. Reads the direct job with event_days and staffing_requirements
  2. Calculates shift hours from event_days (sum of all days: end_time - start_time)
  3. Creates a booking record in the `bookings` table with:
     - source: 'direct'
     - client_id: directJob.client_id (linked to the client record)
     - total_amount: directJob.agreed_price
     - platform_fee_percent: 0
     - medic_payout_percent: 100
     - platform_fee: 0
     - medic_payout: directJob.agreed_price (company gets 100%)
     - is_referral: false
     - referral_payout_amount: 0
     - platform_net: 0
     - status: 'confirmed'
     - shift_date: first event day's event_date
     - shift_start_time: first event day's start_time
     - shift_end_time: last event day's end_time (or first day's end_time for single-day)
     - All other required booking fields populated from the direct job data
     - stripe_payment_intent_id: paymentIntentId (if provided)
  4. Returns { bookingId, booking } or throws with descriptive error

IMPORTANT: Check the actual `bookings` table schema to ensure all required NOT NULL fields are populated. The bookings table was created in early migrations (v1.0) and may have fields like medic_id, site_name, etc. For direct jobs:
- medic_id: NULL initially (assigned later via assign-medic endpoint)
- site_name: use directJob.event_name
- site_address: use directJob.location_address
- site_postcode: use directJob.location_postcode
- Map any other required fields appropriately from the direct job data

Create `web/app/api/direct-jobs/[id]/payment/route.ts`:
- POST: Creates a Stripe PaymentIntent for the deposit amount
  1. Auth check -> verify user owns this direct job
  2. Fetch the direct job
  3. Calculate deposit: agreed_price * (deposit_percent / 100)
  4. Create Stripe PaymentIntent with amount in pence (GBP): Math.round(deposit * 100)
     - currency: 'gbp'
     - metadata: { direct_job_id: id, type: 'direct_job_deposit' }
     - Use the company's Stripe Connect account as the connected account if applicable, OR create a standard PaymentIntent (the exact pattern depends on whether the company has stripe_account_id -- check marketplace_companies)
  5. Return { clientSecret: paymentIntent.client_secret, depositAmount: deposit }

NOTE: If Stripe is not configured in development (no STRIPE_SECRET_KEY env var), return a mock response: { clientSecret: 'mock_secret_for_dev', depositAmount: deposit, mock: true }. This allows the wizard to function in development without Stripe keys.

Create `web/app/api/direct-jobs/[id]/confirm/route.ts`:
- POST: Confirms the direct job and creates a booking
  1. Auth check -> verify user owns this direct job
  2. Verify job status is 'draft' (only draft jobs can be confirmed)
  3. Call createDirectJobBooking() to create the booking record
  4. Update marketplace_events SET status = 'confirmed' WHERE id = job.id
  5. Return { success: true, bookingId }

This endpoint is called AFTER successful payment (the client pays the deposit first, then the job is confirmed). In development/testing, it can be called directly without payment verification.
  </action>
  <verify>
    - booking-bridge.ts exports createDirectJobBooking function
    - POST /api/direct-jobs/[id]/payment returns a clientSecret (or mock in dev)
    - POST /api/direct-jobs/[id]/confirm creates a booking with source='direct' and updates job status to 'confirmed'
    - Booking record has platform_fee_percent=0 and medic_payout_percent=100
    - pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web tsc --noEmit passes
  </verify>
  <done>
    - Booking bridge creates booking records with 0% commission for direct jobs
    - Payment endpoint creates Stripe PaymentIntent for deposit amount
    - Confirm endpoint transitions job from draft to confirmed and creates booking
    - All booking fields populated correctly from direct job data
  </done>
</task>

<task type="auto">
  <name>Task 2: Medic assignment API and job detail page</name>
  <files>
    web/app/api/direct-jobs/[id]/assign-medic/route.ts
    web/app/(dashboard)/dashboard/jobs/[id]/page.tsx
  </files>
  <action>
Create `web/app/api/direct-jobs/[id]/assign-medic/route.ts`:
- POST: Assign a medic to this direct job
  1. Auth check -> verify user owns this direct job
  2. Validate body: { medic_id: string } (required)
  3. Fetch the direct job with event_days to get date/time ranges
  4. For each event_day, attempt to insert a medic_commitment:
     - medic_id: body.medic_id
     - booking_id: the booking created from this job (if exists)
     - marketplace_company_id: user's marketplace_company.id
     - event_date: day.event_date
     - time_range: TSRANGE (constructed from start_time and end_time as timestamps)
  5. The medic_commitments table has an EXCLUSION constraint: EXCLUDE USING GIST (medic_id WITH =, time_range WITH &&)
     - If the INSERT violates this constraint (23P01 exclusion_violation), return 409 with { error: 'Medic is not available during this time', conflict: true }
     - This is the SAME availability checking used by the marketplace
  6. On success, also update the booking's medic_id if a booking exists
  7. Return { success: true, commitmentIds: [...] }

- DELETE: Remove a medic assignment
  1. Auth check -> verify user owns this direct job
  2. Validate body: { medic_id: string }
  3. Delete medic_commitments for this medic + this job's event days
  4. Clear the booking's medic_id if this was the assigned medic
  5. Return { success: true }

Create `web/app/(dashboard)/dashboard/jobs/[id]/page.tsx`:
- 'use client' page for viewing/managing a single direct job
- Fetch the direct job from GET /api/direct-jobs/[id]
- Layout sections:

  **Header:** Job name, status badge, source badge ("Direct"), action buttons based on status

  **Client Details card:** Client name, contact info, address (from joined client record)

  **Job Details card:** Event type, description, special requirements, indoor/outdoor, attendance

  **Schedule card:** Day-by-day breakdown (date, start time, end time) in a clean table

  **Staffing card:** Staffing requirements table (role, quantity, notes) + equipment list

  **Pricing card:** Agreed price prominently displayed, deposit breakdown (X% = GBP Y), "0% platform commission" note

  **Medic Assignment section:** (only visible for confirmed/in_progress jobs)
  - List of currently assigned medics (if any)
  - "Assign Medic" button that opens a dialog/modal
  - Dialog: simple medic picker -- fetch available medics from the company's roster (if Phase 37 roster exists) OR from the org's medics list. For now, use a simple text input for medic_id with a note that a proper picker will be added when Phase 37 (Company Roster) ships. OR if the medics table is accessible, fetch medics and show a searchable dropdown.
  - On assign: POST /api/direct-jobs/[id]/assign-medic
  - Handle 409 conflict: show "Medic is not available during this time" error
  - "Remove" button next to each assigned medic

  **Payment section:** (only visible for draft status)
  - "Confirm & Pay Deposit" button
  - On click: POST /api/direct-jobs/[id]/payment to get clientSecret
  - In production: render Stripe Elements checkout form with the clientSecret
  - In development (mock=true): show a "Simulate Payment" button that directly calls POST /api/direct-jobs/[id]/confirm
  - After successful payment/confirmation: refresh the page to show updated status

  **Status management buttons:**
  - Draft: "Confirm Job" (triggers payment flow), "Edit" (Link to wizard?), "Delete"
  - Confirmed: "Start Job" (sets status to in_progress)
  - In Progress: "Complete Job" (sets status to completed)
  - Completed: read-only view
  - Cancelled: read-only view

Loading state: skeleton loader matching codebase patterns.
404 handling: if job not found or not owned by user, show "Job not found" page.
  </action>
  <verify>
    - /dashboard/jobs/[id] renders job details with all sections
    - Medic assignment works (POST creates medic_commitments)
    - Availability conflict (EXCLUSION constraint) returns 409 and displays error
    - Payment flow creates PaymentIntent (or mock in dev)
    - Confirm flow creates booking with source='direct' and 0% commission
    - Status transitions work: draft -> confirmed -> in_progress -> completed
    - pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web tsc --noEmit passes
  </verify>
  <done>
    - Job detail page shows all information: client, schedule, staffing, pricing, medic assignments
    - Medic assignment uses medic_commitments EXCLUSION constraint for availability checking
    - Payment flow creates Stripe deposit PaymentIntent
    - Confirm flow creates booking with source='direct', platform_fee_percent=0, medic_payout_percent=100
    - Status management allows progression through the job lifecycle
  </done>
</task>

</tasks>

<verification>
- Direct job can be confirmed and a booking record is created with source='direct'
- Booking has platform_fee_percent=0 and medic_payout_percent=100
- Medic assignment checks availability via medic_commitments EXCLUSION constraint
- Double-booking a medic returns 409 conflict error
- Payment flow creates a Stripe PaymentIntent for the deposit amount
- Job detail page displays all job information and management actions
</verification>

<success_criteria>
1. Stripe deposit payment flow works (or mock in development)
2. Booking bridge creates bookings with source='direct' and 0% platform commission
3. Medic assignment uses the same EXCLUSION constraint availability checking as marketplace
4. Job detail page provides full job management (view, assign medics, payment, status transitions)
5. Company receives 100% of the agreed price (0% platform commission)
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-self-procured-jobs/34.1-04-SUMMARY.md`
</output>
