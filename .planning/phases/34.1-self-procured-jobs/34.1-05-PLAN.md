---
phase: 34.1-self-procured-jobs
plan: 05
type: execute
wave: 3
depends_on: ["34.1-02", "34.1-03"]
files_modified:
  - web/app/(dashboard)/dashboard/jobs/[id]/client-portal/page.tsx
  - web/app/api/direct-jobs/[id]/client-access/route.ts
  - web/app/api/direct-jobs/[id]/ratings/route.ts
  - web/components/direct-jobs/ClientPortalView.tsx
  - web/components/direct-jobs/RatingForm.tsx
autonomous: true

must_haves:
  truths:
    - "The client gets portal access to view job status, compliance reports, and payments at admin level only"
    - "Client portal shows no access to individual medic details"
    - "Bidirectional ratings supported -- client and company can rate each other for self-procured jobs"
    - "Full client records are accessible through the portal"
  artifacts:
    - path: "web/app/(dashboard)/dashboard/jobs/[id]/client-portal/page.tsx"
      provides: "Client-facing read-only view of job status, reports, payments"
      min_lines: 60
    - path: "web/app/api/direct-jobs/[id]/client-access/route.ts"
      provides: "API endpoint returning client-safe job data (no medic details)"
      exports: ["GET"]
    - path: "web/app/api/direct-jobs/[id]/ratings/route.ts"
      provides: "POST to submit rating, GET to view ratings for a job"
      exports: ["POST", "GET"]
    - path: "web/components/direct-jobs/RatingForm.tsx"
      provides: "Star rating + review form component"
      exports: ["RatingForm"]
  key_links:
    - from: "web/app/(dashboard)/dashboard/jobs/[id]/client-portal/page.tsx"
      to: "/api/direct-jobs/[id]/client-access"
      via: "fetch for client-safe data"
      pattern: "fetch.*client-access"
    - from: "web/app/api/direct-jobs/[id]/client-access/route.ts"
      to: "marketplace_events + bookings"
      via: "Supabase query excluding medic details"
      pattern: "source.*direct"
    - from: "web/components/direct-jobs/RatingForm.tsx"
      to: "/api/direct-jobs/[id]/ratings"
      via: "POST on form submit"
      pattern: "fetch.*ratings"
---

<objective>
Build the client portal access for self-procured job clients and bidirectional ratings for direct jobs.

Purpose: Clients who hired via a self-procured job need to see their job's status, compliance reports, and payment information -- but without access to individual medic details. Ratings allow both parties to rate each other, building trust for future work. This addresses success criteria 5, 6, and 8.

Output: Client portal page, client-safe API endpoint, ratings API, and rating form component.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34.1-self-procured-jobs/34.1-CONTEXT.md
@.planning/phases/34.1-self-procured-jobs/34.1-01-SUMMARY.md
@.planning/phases/34.1-self-procured-jobs/34.1-02-SUMMARY.md
@.planning/phases/34.1-self-procured-jobs/34.1-03-SUMMARY.md

Key reference files:
@web/lib/direct-jobs/types.ts (DirectJob, DirectClient types)
@web/app/(dashboard)/dashboard/jobs/[id]/page.tsx (job detail page from Plan 04)
@web/app/(dashboard)/layout.tsx (dashboard layout)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Client portal API and page</name>
  <files>
    web/app/api/direct-jobs/[id]/client-access/route.ts
    web/components/direct-jobs/ClientPortalView.tsx
    web/app/(dashboard)/dashboard/jobs/[id]/client-portal/page.tsx
  </files>
  <action>
Create `web/app/api/direct-jobs/[id]/client-access/route.ts`:
- GET endpoint that returns a client-safe view of the direct job
- Auth check -> verify the requesting user is either:
  a) The company admin who created the job (full view)
  b) A client user linked to this job's client record (client view -- to be implemented when client accounts exist)
  c) For now, implement company admin access only; client auth will be added when client invitation flow exists
- Return job data WITHOUT medic details:
  - Include: job name, status, event type, description, dates/times, location, staffing COUNTS (e.g., "2 Paramedics, 1 EMT") but NOT individual medic names/IDs, equipment, agreed price, deposit info, payment status
  - Include: client record details (name, contact, address)
  - Exclude: medic_id, medic names, medic contact info, medic_commitments details
  - Include: compliance report links (if booking exists and reports have been generated) -- link to the weekly PDF reports associated with the booking
  - Include: payment summary (deposit paid: yes/no, amount paid, amount remaining)
- This endpoint is the foundation for when clients get their own portal login (Phase 34.1 CONTEXT says "company can invite them to create one")

Create `web/components/direct-jobs/ClientPortalView.tsx`:
- Reusable component that renders the client-safe job view
- Props: { job: ClientSafeJob } (the response from client-access API)
- Sections:
  1. **Job Overview:** Name, status badge, event type
  2. **Schedule:** Day-by-day date/time table
  3. **Staffing Summary:** Role counts only ("2 Paramedics, 1 EMT") -- NO individual medic info
  4. **Location:** Address, postcode (no what3words -- too detailed for client)
  5. **Payment Summary:** Agreed price, deposit amount, deposit paid status, remainder amount
  6. **Compliance Reports:** Links to generated weekly PDFs (if booking has them). If no reports yet, show "Reports will be available once the job is in progress"
  7. **Equipment:** List of required equipment
- Clean, professional layout suitable for client viewing
- Info banner at top: "This is a read-only view of your job details"

Create `web/app/(dashboard)/dashboard/jobs/[id]/client-portal/page.tsx`:
- 'use client' page accessible at /dashboard/jobs/[id]/client-portal
- Fetches from GET /api/direct-jobs/[id]/client-access
- Renders ClientPortalView component
- "Share with Client" button (copies the URL or generates an invite link -- for now, just copies the URL)
- Back button to /dashboard/jobs/[id] (company admin view)
- This page is primarily for the company admin to preview what the client would see. When client accounts are implemented, clients would see this same view via their own authentication.

Define a TypeScript interface for the client-safe response:
```typescript
interface ClientSafeJob {
  id: string;
  event_name: string;
  status: string;
  event_type: string;
  event_description: string | null;
  special_requirements: string | null;
  indoor_outdoor: string;
  expected_attendance: number | null;
  agreed_price: number;
  deposit_percent: number;
  location_postcode: string;
  location_address: string | null;
  equipment_required: Array<{ type: string; notes?: string }>;
  event_days: Array<{ event_date: string; start_time: string; end_time: string }>;
  staffing_summary: Array<{ role: string; total_quantity: number }>; // Aggregated, no individual medics
  client: {
    client_name: string;
    contact_name: string | null;
    contact_email: string | null;
    contact_phone: string | null;
  };
  payment: {
    deposit_amount: number;
    deposit_paid: boolean;
    remainder_amount: number;
    total_paid: number;
  };
  compliance_reports: Array<{ id: string; report_date: string; pdf_url: string }>;
}
```
  </action>
  <verify>
    - GET /api/direct-jobs/[id]/client-access returns job data without medic IDs/names
    - /dashboard/jobs/[id]/client-portal renders the ClientPortalView
    - Staffing section shows role counts only, not individual medic details
    - Payment summary shows deposit breakdown
    - pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web tsc --noEmit passes
  </verify>
  <done>
    - Client-safe API returns job data excluding all medic personal information
    - Client portal page shows job overview, schedule, staffing counts, payments, and compliance reports
    - Staffing information is aggregated (role counts only)
    - Payment summary shows deposit and remainder breakdown
    - Page serves as preview for company admin and future foundation for client access
  </done>
</task>

<task type="auto">
  <name>Task 2: Bidirectional ratings for direct jobs</name>
  <files>
    web/app/api/direct-jobs/[id]/ratings/route.ts
    web/components/direct-jobs/RatingForm.tsx
  </files>
  <action>
The ratings system for Phase 36 (Ratings, Messaging & Disputes) hasn't been built yet. For Phase 34.1, we need to create a minimal ratings foundation that self-procured jobs can use, which Phase 36 will later extend for marketplace jobs.

Create a lightweight ratings table via a new migration section in 147_direct_jobs.sql (OR if Plan 01 already committed that migration, create 148_direct_job_ratings.sql):

```sql
-- Job ratings for self-procured jobs (extended in Phase 36 for marketplace)
CREATE TABLE IF NOT EXISTS job_ratings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id UUID NOT NULL REFERENCES marketplace_events(id) ON DELETE CASCADE,
  booking_id UUID REFERENCES bookings(id) ON DELETE SET NULL,
  rater_user_id UUID NOT NULL REFERENCES auth.users(id),
  rater_type TEXT NOT NULL CHECK (rater_type IN ('company', 'client')),
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  review TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  -- One rating per rater per job
  UNIQUE(job_id, rater_user_id)
);

-- RLS
ALTER TABLE job_ratings ENABLE ROW LEVEL SECURITY;
-- Job participants can view ratings
CREATE POLICY job_ratings_view ON job_ratings FOR SELECT USING (true);
-- Rater can insert/update own rating
CREATE POLICY job_ratings_manage_own ON job_ratings FOR ALL USING (rater_user_id = auth.uid());
-- Platform admin full access
CREATE POLICY job_ratings_admin ON job_ratings FOR ALL USING (
  EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role = 'platform_admin')
);
```

NOTE: If the user_roles table or platform_admin check pattern differs in this codebase, adapt accordingly. Check the existing RLS patterns in migrations 140-146.

Create `web/app/api/direct-jobs/[id]/ratings/route.ts`:
- POST: Submit a rating
  1. Auth check
  2. Validate body: { rating: number (1-5), review?: string }
  3. Verify the job exists, is source='direct', and status is 'completed' (ratings only after job completion)
  4. Determine rater_type: if user is the company admin who posted the job -> 'company', if user is the client -> 'client'
  5. For now, only company rating is supported (client rating requires client auth, deferred)
  6. Upsert into job_ratings (one rating per user per job)
  7. Return { success: true, rating }

- GET: Get ratings for a job
  1. Auth check
  2. Fetch all job_ratings where job_id matches
  3. Return { ratings: [...], averageRating: number }

Create `web/components/direct-jobs/RatingForm.tsx`:
- 'use client' component
- Props: { jobId: string, existingRating?: { rating: number; review: string } }
- Star rating input: 5 clickable stars (use simple SVG star icons or Lucide Star icons). Filled stars for selected rating, outline for unselected.
- Review textarea (optional, max 2000 chars)
- Submit button
- On submit: POST /api/direct-jobs/[id]/ratings
- If existingRating is provided, pre-fill the form (user is editing their rating)
- Loading and error states
- Confirmation message after submission

Integrate the RatingForm into the job detail page from Plan 04:
- Add a "Rate This Job" section to `web/app/(dashboard)/dashboard/jobs/[id]/page.tsx` that appears ONLY when the job status is 'completed'
- Show the RatingForm for the company admin to rate the client
- Show any existing ratings (both company's and client's if available)
- Display star ratings as filled/unfilled stars

IMPORTANT: This is a MINIMAL ratings foundation. Phase 36 will build the full marketplace ratings system (14-day window, review moderation, profile display, sort influence). This plan only needs to support the success criterion: "Bidirectional ratings supported for self-procured jobs."
  </action>
  <verify>
    - POST /api/direct-jobs/[id]/ratings creates a rating (only for completed jobs)
    - GET /api/direct-jobs/[id]/ratings returns ratings with average
    - RatingForm renders 5-star selector and review textarea
    - Rating section only appears on job detail page when status='completed'
    - Migration creates job_ratings table with RLS
    - pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web tsc --noEmit passes
  </verify>
  <done>
    - job_ratings table exists with RLS policies
    - Company admin can rate the client after job completion (1-5 stars + review)
    - Ratings API supports submit and retrieval
    - RatingForm component renders interactive star selector
    - Rating section integrated into job detail page for completed jobs
    - Foundation laid for Phase 36 to extend with marketplace ratings
  </done>
</task>

</tasks>

<verification>
- Client portal page shows job details without medic personal information
- Client portal shows payment summary with deposit breakdown
- Rating form allows 1-5 star selection with optional review text
- Ratings can only be submitted for completed jobs
- Duplicate ratings are prevented (UNIQUE constraint on job_id + rater_user_id)
- All new files compile without TypeScript errors
</verification>

<success_criteria>
1. Client portal provides admin-level view (job status, compliance reports, payments) with no medic personal details
2. Bidirectional ratings table exists with RLS (company can rate client, client can rate company)
3. Company admin can submit a star rating (1-5) and written review for completed direct jobs
4. Rating form is integrated into the job detail page, visible only for completed jobs
5. Client-safe API correctly excludes medic names, IDs, and contact information from response
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-self-procured-jobs/34.1-05-SUMMARY.md`
</output>
