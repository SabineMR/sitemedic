---
phase: 34.1-self-procured-jobs
plan: 04
subsystem: api, payments, ui
tags: [stripe, supabase, next.js, booking-bridge, medic-commitments, exclusion-constraint]

# Dependency graph
requires:
  - phase: 34.1-02
    provides: Job creation wizard, jobs list page, direct jobs API routes
  - phase: 32-01
    provides: marketplace_companies table, medic_commitments EXCLUSION constraint
  - phase: 34.1-01
    provides: direct_clients table, marketplace_events source/agreed_price/client_id columns
provides:
  - Booking bridge (createDirectJobBooking) with source='direct' and 0% commission
  - Stripe PaymentIntent creation for deposit payments
  - Job confirmation with automatic booking creation
  - Medic assignment with EXCLUSION constraint availability checking
  - Job detail page with full lifecycle management
affects: [34.1-05-status-webhooks, 35-award-flow, 36-dispute-resolution]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Booking bridge pattern: map domain object to bookings table"
    - "EXCLUSION constraint error handling: catch 23P01 for schedule conflicts"
    - "Dev mock fallback: return mock PaymentIntent when no STRIPE_SECRET_KEY"

key-files:
  created:
    - web/lib/direct-jobs/booking-bridge.ts
    - web/app/api/direct-jobs/[id]/payment/route.ts
    - web/app/api/direct-jobs/[id]/confirm/route.ts
    - web/app/api/direct-jobs/[id]/assign-medic/route.ts
    - web/app/(dashboard)/dashboard/jobs/[id]/page.tsx
  modified:
    - FEATURES.md

key-decisions:
  - "Booking bridge sets client_id=null because direct_clients is a separate table from bookings.client_id (which refs clients)"
  - "agreed_price treated as total including VAT -- split into subtotal/vat for bookings schema compatibility"
  - "Dev mock PaymentIntent returned when STRIPE_SECRET_KEY not set -- enables UI testing without Stripe credentials"
  - "Medic commitments created per event_day (not per job) -- EXCLUSION constraint checks each day independently"

patterns-established:
  - "Booking bridge: createDirectJobBooking maps domain object to bookings table with source='direct', platform_fee=0"
  - "23P01 error handling: catch PostgreSQL EXCLUSION violation and return user-friendly SCHEDULE_CONFLICT response"
  - "Dynamic Stripe import: only import @/lib/stripe/server when STRIPE_SECRET_KEY exists to avoid throw on module load"

# Metrics
duration: 9min
completed: 2026-02-20
---

# Phase 34.1 Plan 04: Payment, Booking Bridge, Medic Assignment, Job Detail Summary

**Stripe deposit payment, booking bridge with source='direct' and 0% commission, medic assignment via EXCLUSION constraint, and 795-line job detail page with full lifecycle management**

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-20T00:50:54Z
- **Completed:** 2026-02-20T01:00:25Z
- **Tasks:** 2
- **Files created:** 5

## Accomplishments
- Booking bridge creates bookings with source='direct', platform_fee=0, medic_payout=100% -- direct jobs now integrate with the full booking lifecycle (timesheets, invoices, payroll)
- Stripe PaymentIntent creation for deposit payments (25% default) with dev mock fallback
- Medic assignment uses the same medic_commitments EXCLUSION constraint as marketplace, preventing double-booking with PostgreSQL 23P01 error detection
- Job detail page (795 lines) provides comprehensive management: client info, job details, schedule, staffing, pricing (0% commission highlighted), medic assignment with conflict detection, payment flow, status transitions

## Task Commits

Each task was committed atomically:

1. **Task 1: Booking bridge and payment/confirm API routes** - `d81084a` (feat)
2. **Task 2: Medic assignment API and job detail page** - `d7ab0c0` (feat)

## Files Created/Modified
- `web/lib/direct-jobs/booking-bridge.ts` - createDirectJobBooking function mapping direct job fields to bookings table
- `web/app/api/direct-jobs/[id]/payment/route.ts` - POST route creating Stripe PaymentIntent for deposit (or mock in dev)
- `web/app/api/direct-jobs/[id]/confirm/route.ts` - POST route transitioning draft->confirmed and creating booking via bridge
- `web/app/api/direct-jobs/[id]/assign-medic/route.ts` - POST/DELETE routes for medic assignment with EXCLUSION constraint
- `web/app/(dashboard)/dashboard/jobs/[id]/page.tsx` - Full job detail page (795 lines) with all management sections
- `FEATURES.md` - Added Phase 34.1 implementation progress section

## Decisions Made
- **Booking bridge sets client_id=null**: Direct jobs use `direct_clients` table, not the `clients` table that `bookings.client_id` references. The client info is stored in `special_notes` instead.
- **agreed_price treated as total including VAT**: The bridge splits it into subtotal (total/1.20) and VAT for bookings schema compatibility.
- **Dynamic Stripe import**: Only import `@/lib/stripe/server` when `STRIPE_SECRET_KEY` exists to avoid the module-level throw on import.
- **Medic commitments per event_day**: Each event day gets its own commitment row, allowing the EXCLUSION constraint to check each day independently for overlaps.

## Deviations from Plan

None -- plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None -- no external service configuration required. Stripe PaymentIntent creation gracefully falls back to mock mode in development.

## Next Phase Readiness
- All 4 plans of Phase 34.1 complete (01-04). Plan 05 (status webhooks/notifications) is next if planned.
- Direct jobs now have full lifecycle: create -> confirm (with booking) -> assign medics -> payment -> start -> complete
- The booking bridge pattern can be reused for marketplace award flow (Phase 35) with different commission rates
- EXCLUSION constraint pattern for medic assignment is proven and can be used in marketplace award flow

---
*Phase: 34.1-self-procured-jobs*
*Completed: 2026-02-20*
