---
phase: 34.1-self-procured-jobs
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/api/direct-jobs/route.ts
  - web/app/api/direct-jobs/[id]/client-access/route.ts
  - web/app/(dashboard)/dashboard/jobs/[id]/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "POST /api/direct-jobs returns 403 when the company's org has no active subscription"
    - "POST /api/direct-jobs succeeds when the company's org has an active subscription"
    - "Job detail page contains a visible link to the client portal preview"
    - "Client-access API returns deposit_paid=true when a confirmed booking exists for the job"
  artifacts:
    - path: "web/app/api/direct-jobs/route.ts"
      provides: "Subscription-gated direct job creation"
      contains: "subscription_tier"
    - path: "web/app/api/direct-jobs/[id]/client-access/route.ts"
      provides: "Payment status derived from booking existence"
      contains: "bookings"
    - path: "web/app/(dashboard)/dashboard/jobs/[id]/page.tsx"
      provides: "Client portal navigation link"
      contains: "client-portal"
  key_links:
    - from: "web/app/api/direct-jobs/route.ts"
      to: "marketplace_companies.org_id -> organizations.subscription_tier"
      via: "Supabase join query"
      pattern: "subscription_tier"
    - from: "web/app/api/direct-jobs/[id]/client-access/route.ts"
      to: "bookings table"
      via: "Supabase query for source=direct booking matching job"
      pattern: "bookings.*source.*direct"
    - from: "web/app/(dashboard)/dashboard/jobs/[id]/page.tsx"
      to: "/dashboard/jobs/[id]/client-portal"
      via: "Next.js Link component"
      pattern: "client-portal"
---

<objective>
Close 2 verification gaps from Phase 34.1: (1) add subscription check to POST /api/direct-jobs so only companies with active SiteMedic subscriptions can create direct jobs, and (2) fix client portal wiring -- add link from job detail page, wire deposit_paid to actual booking status.

Purpose: Phase 34.1 goal requires "companies with a SiteMedic subscription" but current API allows any marketplace company. Client portal exists but is orphaned (no navigation link) and has hardcoded payment status.
Output: Patched API route with subscription gate, wired client-access API with real payment status, job detail page with client portal link.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34.1-self-procured-jobs/34.1-VERIFICATION.md

Key files to read before modifying:
@web/app/api/direct-jobs/route.ts
@web/app/api/direct-jobs/[id]/client-access/route.ts
@web/app/(dashboard)/dashboard/jobs/[id]/page.tsx
@web/lib/billing/require-tier.ts (reference for subscription check pattern)
@web/lib/direct-jobs/booking-bridge.ts (reference for how bookings are created)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subscription check to POST /api/direct-jobs and wire client portal</name>
  <files>
    web/app/api/direct-jobs/route.ts
    web/app/api/direct-jobs/[id]/client-access/route.ts
    web/app/(dashboard)/dashboard/jobs/[id]/page.tsx
  </files>
  <action>
**1. Subscription check in POST /api/direct-jobs/route.ts (Gap 1)**

After the existing marketplace_companies query (lines 52-63), add a subscription check. The approach:

After confirming the user is a company admin, query the company's `org_id` from marketplace_companies (add `org_id` to the existing select), then query `organizations` to check `subscription_tier` is not null and `subscription_status` is 'active' or 'trialing'.

Specifically, modify the existing query at line 52 to also select `org_id`:
```ts
const { data: company, error: companyError } = await supabase
  .from('marketplace_companies')
  .select('id, verification_status, org_id')
  .eq('admin_user_id', user.id)
  .single();
```

Then, after the company check (after line 63), add:
```ts
// Verify company's organization has an active subscription
if (!company.org_id) {
  return NextResponse.json(
    { error: 'Your company must be linked to a SiteMedic organization with an active subscription to create direct jobs' },
    { status: 403 }
  );
}

const { data: org, error: orgError } = await supabase
  .from('organizations')
  .select('subscription_tier, subscription_status')
  .eq('id', company.org_id)
  .single();

if (orgError || !org || !org.subscription_tier) {
  return NextResponse.json(
    { error: 'An active SiteMedic subscription is required to create direct jobs' },
    { status: 403 }
  );
}

// Allow active or trialing subscriptions
const validStatuses = ['active', 'trialing'];
if (org.subscription_status && !validStatuses.includes(org.subscription_status)) {
  return NextResponse.json(
    { error: 'Your SiteMedic subscription must be active to create direct jobs' },
    { status: 403 }
  );
}
```

Do NOT use the `requireTier()` helper from `web/lib/billing/require-tier.ts` because that resolves org from user's `app_metadata.org_id` which may differ from the marketplace company's `org_id`. Instead, resolve the org from the marketplace_companies.org_id directly.

Do NOT modify the GET handler -- listing existing jobs should work regardless of subscription status.

**2. Wire deposit_paid in GET /api/direct-jobs/[id]/client-access/route.ts (Gap 2a)**

After fetching the job (around line 108), add a query to check if a booking exists for this direct job. The booking bridge creates bookings with `source='direct'` and stores the job name in `site_name`. However, a more reliable approach: query bookings where `source='direct'` AND `org_id` matches the company's org AND `site_name` matches the job's `event_name` AND `shift_date` matches the first event day.

Actually, the simplest reliable approach: after the job query, add a query to find bookings with `source='direct'` AND `site_name = job.event_name` AND `special_notes` containing `Direct Job:`. If a booking exists with status 'confirmed' or better, treat deposit as paid.

```ts
// Check payment status via booking existence
let depositPaid = false;
let totalPaid = 0;

// The booking bridge creates bookings with source='direct' and the job name in site_name
const { data: relatedBooking } = await supabase
  .from('bookings')
  .select('id, status, total')
  .eq('source', 'direct')
  .eq('site_name', job.event_name)
  .eq('site_postcode', job.location_postcode)
  .in('status', ['confirmed', 'in_progress', 'completed'])
  .limit(1)
  .maybeSingle();

if (relatedBooking) {
  depositPaid = true;
  totalPaid = depositAmount; // Deposit was paid if booking is confirmed
  if (relatedBooking.status === 'completed') {
    totalPaid = agreedPrice; // Full amount paid on completion
  }
}
```

Then update the payment object in the clientSafe response (lines 175-180) to use these values:
```ts
payment: {
  deposit_amount: depositAmount,
  deposit_paid: depositPaid,
  remainder_amount: remainderAmount,
  total_paid: totalPaid,
},
```

Remove the comments about "Will be driven by Stripe PaymentIntent status in Phase 35" and "Will be updated when payment integration is complete".

Keep `compliance_reports: []` as-is with a comment explaining no compliance reporting system exists yet. This is NOT a gap that can be closed -- there is no compliance reporting feature to wire to.

**3. Add client portal link to job detail page (Gap 2c)**

In `web/app/(dashboard)/dashboard/jobs/[id]/page.tsx`, add a "View Client Portal" button/link in the header area (around line 398-401, after the status badges). Add it as a Link component:

```tsx
import { ExternalLink } from 'lucide-react'; // Add to existing imports
```

After the 0% Commission badge (after line 398), add:
```tsx
<Link
  href={`/dashboard/jobs/${id}/client-portal`}
  className="inline-flex items-center gap-1.5 rounded-full bg-purple-50 px-2.5 py-0.5 text-xs font-medium text-purple-700 border border-purple-200 hover:bg-purple-100 transition-colors"
>
  <ExternalLink className="h-3 w-3" />
  Client Portal
</Link>
```

This places it alongside the existing event type badge and 0% commission badge for visual consistency.
  </action>
  <verify>
1. Run `cd /Users/sabineresoagli/GitHub/sitemedic/web && npx tsc --noEmit` to verify TypeScript compiles
2. Grep for "subscription_tier" in web/app/api/direct-jobs/route.ts to confirm subscription check exists
3. Grep for "deposit_paid: false" in web/app/api/direct-jobs/[id]/client-access/route.ts -- should NOT match (removed hardcoded false)
4. Grep for "client-portal" in web/app/(dashboard)/dashboard/jobs/[id]/page.tsx to confirm link exists
5. Grep for "bookings" in web/app/api/direct-jobs/[id]/client-access/route.ts to confirm payment wiring exists
  </verify>
  <done>
- POST /api/direct-jobs returns 403 with subscription error when company has no org_id or no active subscription_tier
- POST /api/direct-jobs succeeds for companies with active/trialing subscription
- GET /api/direct-jobs (list) is NOT affected by subscription check
- Client-access API returns deposit_paid=true when a confirmed booking exists for the direct job
- Client-access API returns deposit_paid=false when no booking exists yet
- Job detail page shows a purple "Client Portal" link badge next to the 0% Commission badge
- compliance_reports remains [] with explanatory comment (no compliance system exists to wire to)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes with no errors
2. POST /api/direct-jobs has subscription_tier check between company lookup and job creation
3. Client-access API queries bookings table to determine deposit_paid status
4. Job detail page has visible Link to /dashboard/jobs/[id]/client-portal
5. No hardcoded `deposit_paid: false` remains in client-access route
</verification>

<success_criteria>
- Gap 1 (Truth #1): Subscription check blocks non-subscribers from creating direct jobs
- Gap 2c (Truth #5): Client portal is reachable from job detail page via visible link
- Gap 2a (Truth #5): deposit_paid reflects actual booking status rather than hardcoded false
- Gap 2b (compliance_reports): Documented as not closable -- no compliance reporting system exists. Remains [] with clear comment.
- Gap 2d (client auth): Explicitly deferred per CONTEXT.md -- not addressed in this plan
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-self-procured-jobs/34.1-06-SUMMARY.md`
</output>
