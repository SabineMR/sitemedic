---
phase: 34.1-self-procured-jobs
plan: 06
subsystem: api
tags: [subscription, stripe, supabase, next.js, direct-jobs, client-portal, bookings]

# Dependency graph
requires:
  - phase: 34.1-self-procured-jobs (plans 01-05)
    provides: Direct jobs API, client-access endpoint, job detail page, booking bridge
provides:
  - Subscription-gated direct job creation (blocks non-subscribers)
  - Dynamic deposit_paid status derived from booking existence
  - Client portal navigation link from job detail page
affects: [phase-35-award-flow-payment, client-portal-auth]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Subscription check via marketplace_companies.org_id -> organizations join (not requireTier helper)"
    - "Booking existence check for payment status (name+postcode+org+date matching)"

key-files:
  created: []
  modified:
    - web/app/api/direct-jobs/route.ts
    - web/app/api/direct-jobs/[id]/client-access/route.ts
    - web/app/(dashboard)/dashboard/jobs/[id]/page.tsx

key-decisions:
  - "Subscription check resolves org from marketplace_companies.org_id (not user app_metadata.org_id via requireTier) because company org may differ from user's personal org"
  - "NULL subscription_status treated as active (legacy orgs per migration 133 convention)"
  - "Booking lookup uses name+postcode+org+date matching with TODO for proper FK in future migration"

patterns-established:
  - "Direct subscription gating: query marketplace_companies.org_id -> organizations.subscription_tier for marketplace-specific checks"

# Metrics
duration: 1min
completed: 2026-02-20
---

# Phase 34.1 Plan 06: Gap Closure Summary

**Subscription gate on POST /api/direct-jobs blocking non-subscribers, dynamic deposit_paid from booking existence, and client portal link on job detail page**

## Performance

- **Duration:** 1 min
- **Started:** 2026-02-20T03:31:24Z
- **Completed:** 2026-02-20T03:32:52Z
- **Tasks:** 1
- **Files modified:** 3

## Accomplishments
- POST /api/direct-jobs now returns 403 when company has no org_id, no subscription_tier, or subscription_status is past_due/cancelled
- Client-access API dynamically determines deposit_paid by querying bookings table for matching source=direct booking
- Job detail page shows purple "Client Portal" link badge alongside existing event type and 0% commission badges

## Task Commits

Each task was committed atomically:

1. **Task 1: Add subscription check and wire client portal** - `d81c653` (feat)

## Files Created/Modified
- `web/app/api/direct-jobs/route.ts` - Added subscription_tier + subscription_status check after company lookup, before job creation
- `web/app/api/direct-jobs/[id]/client-access/route.ts` - Replaced hardcoded deposit_paid:false with booking existence query
- `web/app/(dashboard)/dashboard/jobs/[id]/page.tsx` - Added ExternalLink import and Client Portal link badge in header

## Decisions Made
- Used direct marketplace_companies.org_id -> organizations join instead of requireTier() helper, because requireTier resolves org from user's app_metadata.org_id which may differ from the marketplace company's org_id
- NULL subscription_status treated as active per migration 133 convention (legacy orgs not yet on Stripe billing)
- Booking lookup uses site_name + site_postcode + org_id + shift_date matching (TODO for proper FK in future migration noted in code)
- compliance_reports remains [] with explanatory comment -- no compliance reporting system exists to wire to

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Phase 34.1 gap closure complete -- subscription gating and client portal wiring verified
- Ready for Phase 35 (Award Flow & Payment) which will add Stripe payment integration
- TODO in client-access route notes need for proper FK link from marketplace_events to bookings in future migration

---
*Phase: 34.1-self-procured-jobs*
*Completed: 2026-02-20*
