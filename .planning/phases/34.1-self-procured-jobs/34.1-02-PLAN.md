---
phase: 34.1-self-procured-jobs
plan: 02
type: execute
wave: 2
depends_on: ["34.1-01"]
files_modified:
  - web/stores/useDirectJobStore.ts
  - web/app/(dashboard)/dashboard/jobs/create/page.tsx
  - web/components/direct-jobs/wizard/ClientDetailsStep.tsx
  - web/components/direct-jobs/wizard/JobInfoStep.tsx
  - web/components/direct-jobs/wizard/JobScheduleStep.tsx
  - web/components/direct-jobs/wizard/JobStaffingStep.tsx
  - web/components/direct-jobs/wizard/JobPricingStep.tsx
  - web/components/direct-jobs/wizard/JobReviewStep.tsx
  - web/app/(dashboard)/dashboard/jobs/page.tsx
autonomous: true

must_haves:
  truths:
    - "A company user can navigate to a job creation wizard from the SiteMedic platform dashboard (NOT the marketplace section)"
    - "The wizard collects client details, event type, multi-day dates/times, location, staffing requirements, equipment, and agreed price in a step-by-step flow"
    - "Full client records are created (name, contact, address) as formal records in the system"
    - "The wizard creates a direct job via the API with all collected data"
  artifacts:
    - path: "web/stores/useDirectJobStore.ts"
      provides: "Zustand store managing 5-step wizard state with draft persistence"
      exports: ["useDirectJobStore"]
    - path: "web/app/(dashboard)/dashboard/jobs/create/page.tsx"
      provides: "Wizard page with step navigation and submission"
      min_lines: 80
    - path: "web/components/direct-jobs/wizard/ClientDetailsStep.tsx"
      provides: "Step 1: client name, contact, address, existing client selector"
      min_lines: 50
    - path: "web/components/direct-jobs/wizard/JobPricingStep.tsx"
      provides: "Step 5: agreed price input, deposit percentage, notes"
      min_lines: 40
    - path: "web/app/(dashboard)/dashboard/jobs/page.tsx"
      provides: "Jobs list page with 'Log Job' button linking to wizard"
      min_lines: 30
  key_links:
    - from: "web/stores/useDirectJobStore.ts"
      to: "web/lib/direct-jobs/schemas.ts"
      via: "validation on step advance"
      pattern: "import.*schemas"
    - from: "web/app/(dashboard)/dashboard/jobs/create/page.tsx"
      to: "web/stores/useDirectJobStore.ts"
      via: "useDirectJobStore hook"
      pattern: "useDirectJobStore"
    - from: "web/app/(dashboard)/dashboard/jobs/create/page.tsx"
      to: "/api/direct-jobs"
      via: "fetch POST on submit"
      pattern: "fetch.*api/direct-jobs"
---

<objective>
Build the self-procured job creation wizard with a Zustand store for state management, 5-step wizard UI, and submission flow.

Purpose: This is the core user-facing feature -- the "Log Job" entry point that companies use to record jobs they sourced themselves. The wizard follows the same depth and UX patterns as the marketplace event posting wizard (Phase 33) but lives in the main SiteMedic platform dashboard, not the marketplace section.

Output: Zustand store, 6 wizard step components, wizard page, and a jobs list page with "Log Job" button.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34.1-self-procured-jobs/34.1-CONTEXT.md
@.planning/phases/34.1-self-procured-jobs/34.1-RESEARCH.md
@.planning/phases/34.1-self-procured-jobs/34.1-01-SUMMARY.md

Key reference files:
@web/stores/useEventPostingStore.ts (Zustand wizard store pattern to follow)
@web/lib/marketplace/event-schemas.ts (Zod step validation pattern)
@web/lib/direct-jobs/types.ts (types from Plan 01)
@web/lib/direct-jobs/schemas.ts (schemas from Plan 01)
@web/app/api/direct-jobs/route.ts (API from Plan 01)
@web/app/(dashboard)/layout.tsx (dashboard layout -- wizard lives here)
@web/app/(dashboard)/dashboard/page.tsx (existing dashboard page for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zustand store and wizard step components</name>
  <files>
    web/stores/useDirectJobStore.ts
    web/components/direct-jobs/wizard/ClientDetailsStep.tsx
    web/components/direct-jobs/wizard/JobInfoStep.tsx
    web/components/direct-jobs/wizard/JobScheduleStep.tsx
    web/components/direct-jobs/wizard/JobStaffingStep.tsx
    web/components/direct-jobs/wizard/JobPricingStep.tsx
    web/components/direct-jobs/wizard/JobReviewStep.tsx
  </files>
  <action>
Create `web/stores/useDirectJobStore.ts` following the exact pattern from `useEventPostingStore.ts`:

**State shape:**
```
currentStep: number (0-5, 6 steps total: Client -> Info -> Schedule -> Staffing -> Pricing -> Review)

// Step 1: Client Details
existing_client_id: string | null  (select existing client from dropdown)
client_name: string
contact_name: string
contact_email: string
contact_phone: string
address_line_1: string
address_line_2: string
city: string
postcode: string

// Step 2: Job Info (mirrors basicInfoSchema)
event_name: string (job title)
event_type: EventType | ''
event_description: string
special_requirements: string
indoor_outdoor: IndoorOutdoor
expected_attendance: number | null

// Step 3: Schedule & Location (mirrors schedulingSchema but no quote_deadline)
event_days: EventDayInput[] (same shape as event posting store)
location_postcode: string
location_address: string
location_what3words: string
location_lat: number | null
location_lng: number | null
location_display: string

// Step 4: Staffing & Equipment (mirrors staffingSchema but no budget)
staffing_requirements: StaffingInput[]
equipment_required: EquipmentItem[]

// Step 5: Pricing
agreed_price: number | null
deposit_percent: number (default 25)
pricing_notes: string

// Meta
isSubmitting: boolean
error: string | null
```

**Actions:** setStep, updateField, addEventDay, removeEventDay, updateEventDay, addStaffingRequirement, removeStaffingRequirement, updateStaffingRequirement, toggleEquipment, updateEquipmentNotes, setExistingClient(clientId, clientData), setSubmitting, setError, reset

When setExistingClient is called with a DirectClient object, populate all client fields from the object. When called with null, clear client fields.

**Wizard step components** (all 'use client'):

1. **ClientDetailsStep.tsx**:
   - Radio toggle: "New Client" / "Existing Client"
   - If "Existing Client": dropdown fetching from GET /api/direct-jobs/clients?company_id=X (we'll add this endpoint). On select, auto-fill all client fields from the selected client. Show a compact summary of the selected client.
   - If "New Client": form fields for client_name (required), contact_name, contact_email, contact_phone, address_line_1, address_line_2, city, postcode
   - Validate with clientDetailsSchema on "Next" click
   - Use Tailwind classes consistent with existing form patterns in the codebase

2. **JobInfoStep.tsx**:
   - Reuse the exact same field layout as the marketplace event wizard Step 1
   - event_name input (labeled "Job Name"), event_type select dropdown, event_description textarea, special_requirements textarea, indoor_outdoor radio group, expected_attendance number input
   - Validate with jobInfoSchema on "Next"

3. **JobScheduleStep.tsx**:
   - Multi-day date picker (same as event posting wizard Step 2)
   - Per-day start_time and end_time inputs
   - Add/remove day buttons
   - Location fields: postcode input, address (can use Google Places autocomplete if available), what3words input
   - NO quote_deadline field (this is the key difference from marketplace)
   - Validate with jobScheduleSchema on "Next"

4. **JobStaffingStep.tsx**:
   - Staffing requirements: dynamic array with role (StaffingRole select), quantity (number), additional_notes (text)
   - Add/remove staffing requirement buttons
   - Equipment checklist: same checkbox grid as marketplace event wizard
   - NO budget_min/budget_max fields (key difference -- direct jobs use agreed_price)
   - Validate with jobStaffingSchema on "Next"

5. **JobPricingStep.tsx**:
   - agreed_price: number input with GBP currency prefix, labeled "Agreed Price (inc. VAT)"
   - deposit_percent: slider or number input (0-100, default 25), with calculated deposit amount shown (agreed_price * deposit_percent / 100)
   - pricing_notes: textarea for any pricing notes
   - Show summary: "Client pays GBP X.XX deposit now, GBP Y.YY remainder after job"
   - Validate with jobPricingSchema on "Next"

6. **JobReviewStep.tsx**:
   - Read-only summary of all 5 steps in sections
   - Client details card, Job info card, Schedule card (day-by-day), Staffing card, Pricing card
   - "Create Job" submit button + "Save as Draft" button
   - On submit: call POST /api/direct-jobs with all store data, handle loading/error states
   - On success: redirect to /dashboard/jobs with success toast (or simple alert)
   - Commission notice: small info box "0% platform commission -- covered by your subscription"

Each step component receives no props -- they read/write directly to the Zustand store via useDirectJobStore hook. Each step has "Back" and "Next" buttons (except step 0 has no "Back" and step 5 has "Submit" instead of "Next").
  </action>
  <verify>
    - pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web tsc --noEmit passes
    - Store exports useDirectJobStore with all state fields and actions
    - All 6 step components render without errors
    - Step components import from useDirectJobStore
  </verify>
  <done>
    - Zustand store manages all 6 wizard steps with typed state
    - ClientDetailsStep supports both new and existing client selection
    - All steps validate with their respective Zod schemas before advancing
    - JobReviewStep displays read-only summary and handles form submission
    - 0% commission is clearly communicated in the review step
  </done>
</task>

<task type="auto">
  <name>Task 2: Wizard page, jobs list page, and dashboard entry point</name>
  <files>
    web/app/(dashboard)/dashboard/jobs/create/page.tsx
    web/app/(dashboard)/dashboard/jobs/page.tsx
  </files>
  <action>
Create `web/app/(dashboard)/dashboard/jobs/create/page.tsx`:
- 'use client' page
- Step indicator/progress bar at top (Step 1 of 6, Step 2 of 6, etc.) with step labels: Client, Job Info, Schedule, Staffing, Pricing, Review
- Renders the current step component based on useDirectJobStore().currentStep
- Step navigation is handled by each step component's Back/Next buttons (which call store.setStep)
- Page title: "Log New Job"
- Breadcrumb: Dashboard > Jobs > Log Job
- On successful submission (from ReviewStep), redirect to /dashboard/jobs

Create `web/app/(dashboard)/dashboard/jobs/page.tsx`:
- 'use client' page that lists the company's direct jobs
- Header: "My Jobs" with a prominent "Log Job" button (Link to /dashboard/jobs/create) styled as primary blue button (matching the "Post New Event" button pattern in my-events/page.tsx)
- Fetch from GET /api/direct-jobs on mount
- Table columns: Job Name | Client | Type | Date(s) | Status | Agreed Price | Actions
- Status badges using Tailwind colour classes (draft=gray, confirmed=green, in_progress=blue, completed=emerald, cancelled=red)
- Empty state: "You haven't logged any jobs yet. Log your first job to track self-procured work." with a "Log Your First Job" CTA button
- Actions column: Draft (Edit, Delete), Confirmed (View), In Progress (View), Completed (View), Cancelled (View)
- Search by job name input
- Status filter dropdown (All, Draft, Confirmed, In Progress, Completed, Cancelled)
- Follow the exact table/filter pattern from web/app/marketplace/my-events/page.tsx

Also add a clients list API endpoint if not created in Plan 01:
- web/app/api/direct-jobs/clients/route.ts: GET endpoint that returns the company's clients for the ClientDetailsStep dropdown. Auth check -> fetch direct_clients where company_id matches the user's marketplace company -> return list sorted by client_name.

IMPORTANT: The entry point is in the SiteMedic platform dashboard at /dashboard/jobs, NOT in /marketplace. This is a core distinction from CONTEXT.md.
  </action>
  <verify>
    - Navigate to /dashboard/jobs (should render jobs list page)
    - Navigate to /dashboard/jobs/create (should render wizard with step 1)
    - "Log Job" button links to /dashboard/jobs/create
    - Step indicator shows current step position
    - Empty state renders when no jobs exist
    - pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web tsc --noEmit passes
  </verify>
  <done>
    - Wizard page renders all 6 steps with navigation and progress indicator
    - Jobs list page shows the company's direct jobs in a filterable table
    - "Log Job" button is prominently placed on the jobs list page
    - Entry point is at /dashboard/jobs (SiteMedic platform, NOT marketplace)
    - Clients dropdown API endpoint serves existing clients for selection
  </done>
</task>

</tasks>

<verification>
- /dashboard/jobs page renders with "Log Job" button
- /dashboard/jobs/create page renders wizard starting at Step 1 (Client Details)
- Can navigate through all 6 wizard steps using Back/Next buttons
- Submitting the wizard creates a direct job via POST /api/direct-jobs
- Jobs list page shows created jobs with correct status badges
- All files compile without TypeScript errors
</verification>

<success_criteria>
1. Company user can access the job creation wizard from /dashboard/jobs
2. Wizard collects client details (new or existing), job info, schedule, staffing, and pricing in 6 steps
3. Client records are created as formal database records via the API
4. Created jobs appear in the /dashboard/jobs list with correct status and pricing
5. The wizard entry point is in the SiteMedic platform dashboard, not the marketplace section
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-self-procured-jobs/34.1-02-SUMMARY.md`
</output>
