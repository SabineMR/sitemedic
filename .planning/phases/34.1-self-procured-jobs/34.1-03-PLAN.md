---
phase: 34.1-self-procured-jobs
plan: 03
type: execute
wave: 2
depends_on: ["34.1-01"]
files_modified:
  - web/app/(dashboard)/dashboard/jobs/combined/page.tsx
  - web/components/direct-jobs/SourceBadge.tsx
  - web/components/direct-jobs/SourceFilter.tsx
  - web/app/api/direct-jobs/combined/route.ts
autonomous: true

must_haves:
  truths:
    - "The SiteMedic platform dashboard shows both marketplace and self-procured jobs in a single filterable view"
    - "Each job displays a source badge: 'Marketplace' (blue) or 'Direct' (green)"
    - "A filter dropdown allows filtering by: All / Marketplace / Direct"
    - "The marketplace dashboard shows ONLY marketplace-sourced jobs (no direct jobs visible)"
  artifacts:
    - path: "web/app/(dashboard)/dashboard/jobs/combined/page.tsx"
      provides: "Combined jobs view with source badges and filter"
      min_lines: 80
    - path: "web/components/direct-jobs/SourceBadge.tsx"
      provides: "Reusable source badge component"
      exports: ["SourceBadge"]
    - path: "web/components/direct-jobs/SourceFilter.tsx"
      provides: "Source filter dropdown component"
      exports: ["SourceFilter"]
    - path: "web/app/api/direct-jobs/combined/route.ts"
      provides: "API endpoint returning combined marketplace + direct jobs"
      exports: ["GET"]
  key_links:
    - from: "web/app/(dashboard)/dashboard/jobs/combined/page.tsx"
      to: "/api/direct-jobs/combined"
      via: "fetch on mount"
      pattern: "fetch.*api/direct-jobs/combined"
    - from: "web/components/direct-jobs/SourceBadge.tsx"
      to: "web/lib/direct-jobs/types.ts"
      via: "SOURCE_LABELS import"
      pattern: "import.*SOURCE_LABELS"
---

<objective>
Create the combined jobs dashboard view that shows both marketplace-awarded and self-procured jobs in a single filterable view with source badges.

Purpose: Companies need to see ALL their work in one place -- both marketplace wins and self-procured jobs. The source badge and filter provide clear distinction. This is success criterion 4 from the phase goal.

Output: Combined jobs page, source badge component, source filter component, and a combined API endpoint.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34.1-self-procured-jobs/34.1-CONTEXT.md
@.planning/phases/34.1-self-procured-jobs/34.1-01-SUMMARY.md

Key reference files:
@web/lib/direct-jobs/types.ts (SOURCE_LABELS, DirectJob, DirectJobStatus)
@web/lib/marketplace/event-types.ts (MarketplaceEventWithDetails, EventStatus, EVENT_STATUS_LABELS)
@web/app/marketplace/my-events/page.tsx (table/filter UI pattern to follow)
@web/app/(dashboard)/layout.tsx (dashboard layout context)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Source badge and filter components</name>
  <files>
    web/components/direct-jobs/SourceBadge.tsx
    web/components/direct-jobs/SourceFilter.tsx
  </files>
  <action>
Create `web/components/direct-jobs/SourceBadge.tsx`:
- Small reusable badge component that accepts a `source` prop ('marketplace' | 'direct')
- Marketplace badge: blue background (bg-blue-100 text-blue-700), label "Marketplace"
- Direct badge: green background (bg-green-100 text-green-700), label "Direct"
- Uses SOURCE_LABELS from types.ts for labels
- Consistent sizing with existing status badges in the codebase (rounded-full px-2 py-0.5 text-xs font-medium)

```typescript
interface SourceBadgeProps {
  source: 'marketplace' | 'direct';
}
```

Create `web/components/direct-jobs/SourceFilter.tsx`:
- Dropdown filter component that accepts `value` and `onChange` props
- Options: All / Marketplace / Direct
- Matches the select element styling from my-events/page.tsx (rounded-md border border-gray-300 px-3 py-2 text-sm)
- "All" is the default

```typescript
interface SourceFilterProps {
  value: string;
  onChange: (value: string) => void;
}
```
  </action>
  <verify>
    - SourceBadge renders correct badge for 'marketplace' and 'direct' sources
    - SourceFilter renders dropdown with 3 options
    - Both components export correctly and compile without errors
  </verify>
  <done>
    - SourceBadge displays "Marketplace" (blue) or "Direct" (green) badge
    - SourceFilter provides All/Marketplace/Direct filtering
    - Components follow existing codebase styling patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Combined API endpoint and dashboard page</name>
  <files>
    web/app/api/direct-jobs/combined/route.ts
    web/app/(dashboard)/dashboard/jobs/combined/page.tsx
  </files>
  <action>
Create `web/app/api/direct-jobs/combined/route.ts`:
- GET endpoint that returns both marketplace and direct jobs for the current user's company
- Auth check -> get user's marketplace_company (via admin_user_id = auth.uid()) -> query marketplace_events
- Query: SELECT *, event_days(*), event_staffing_requirements(*) FROM marketplace_events WHERE posted_by = user.id
- Support query params:
  - source: 'marketplace' | 'direct' | 'all' (default 'all')
  - status: filter by specific status
  - search: filter by event_name ILIKE
  - page/limit: pagination (default page=1, limit=20)
- For direct jobs (source='direct'), also join the client record: JOIN direct_clients ON marketplace_events.client_id = direct_clients.id
- Sort by created_at DESC (newest first)
- Return: { jobs: CombinedJob[], total: number, page: number, limit: number }

The response shape for each job should include:
- All marketplace_events fields (id, event_name, event_type, status, source, agreed_price, created_at, etc.)
- event_days array
- event_staffing_requirements array
- client: DirectClient | null (only for source='direct')
- quote_count: number (only relevant for marketplace events, 0 for direct)

Create `web/app/(dashboard)/dashboard/jobs/combined/page.tsx`:
- 'use client' page
- Title: "All Jobs"
- Two action buttons in header: "Log Job" (Link to /dashboard/jobs/create, green) and "Post Event" (Link to /marketplace/events/create, blue) -- showing both entry points
- Filter bar: SourceFilter component + status filter dropdown + search input (same layout as my-events/page.tsx)
- Table columns: Job/Event | Source | Client/Type | Date(s) | Status | Price/Budget | Actions
  - Source column: SourceBadge component
  - Client/Type column: For direct jobs, show client_name. For marketplace events, show EVENT_TYPE_LABELS[event_type]
  - Price/Budget column: For direct jobs, show "GBP X,XXX" (agreed_price). For marketplace events, show budget range "GBP X - Y" or "No budget set"
  - Status column: Combined status badge supporting both DirectJobStatus and EventStatus values
  - Actions column: View link to appropriate detail page (/dashboard/jobs/[id] for direct, /marketplace/events/[id] for marketplace)
- Empty state: "No jobs or events found. Log a job or post an event to get started."
- Loading skeleton (matching existing codebase pattern)

IMPORTANT: The marketplace My Events page at /marketplace/my-events must NOT show direct jobs. The existing query already filters by posted_by=me, but since direct jobs are also in marketplace_events with posted_by=user.id, the marketplace events API (or the my-events page) must add a filter: WHERE source = 'marketplace' (or source IS NULL for backwards compatibility). Add source='marketplace' filter to the GET /api/marketplace/events endpoint when posted_by is specified, so marketplace pages exclude direct jobs.

Modify `web/app/api/marketplace/events/route.ts` GET handler: When building the standard (non-spatial) query, add `.neq('source', 'direct')` to exclude direct jobs from marketplace event listings. This ensures the marketplace dashboard only shows marketplace events. Do NOT break the existing spatial query path.
  </action>
  <verify>
    - GET /api/direct-jobs/combined returns jobs from both sources
    - GET /api/direct-jobs/combined?source=direct returns only direct jobs
    - GET /api/direct-jobs/combined?source=marketplace returns only marketplace events
    - /dashboard/jobs/combined page renders with source badges on each row
    - Source filter dropdown changes the displayed results
    - GET /api/marketplace/events (existing) no longer returns direct jobs
    - pnpm --dir /Users/sabineresoagli/GitHub/sitemedic/web tsc --noEmit passes
  </verify>
  <done>
    - Combined API returns both marketplace and direct jobs with source discrimination
    - Combined page shows source badges ("Marketplace" blue, "Direct" green) on every row
    - Source filter works: All shows both, Marketplace shows only marketplace, Direct shows only direct
    - Marketplace events API excludes direct jobs (marketplace dashboard unaffected)
    - Both "Log Job" and "Post Event" entry points are visible in the combined view
  </done>
</task>

</tasks>

<verification>
- Combined jobs page accessible at /dashboard/jobs/combined
- Source badges render correctly on both job types
- Filter dropdown filters by source
- Marketplace My Events page does NOT show direct jobs
- Status badges work for both marketplace statuses (draft/open/closed/cancelled/awarded) and direct statuses (draft/confirmed/in_progress/completed/cancelled)
</verification>

<success_criteria>
1. Combined view shows both marketplace-awarded and self-procured jobs in one table
2. Source badges clearly distinguish "Marketplace" from "Direct" jobs
3. Filter dropdown supports All / Marketplace / Direct filtering
4. Marketplace dashboard (My Events) shows only marketplace-sourced jobs -- no direct jobs leak through
5. Platform admin would see direct jobs in the main SiteMedic admin, not in the marketplace admin
</success_criteria>

<output>
After completion, create `.planning/phases/34.1-self-procured-jobs/34.1-03-SUMMARY.md`
</output>
