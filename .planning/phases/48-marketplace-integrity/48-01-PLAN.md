---
phase: 48-marketplace-integrity
plan: 01
title: Source and Fee Integrity Foundation
status: ready
owner: gsd
---

# 48-01 Plan

## Objective

Establish immutable source provenance and fee-policy invariants so self-sourced and marketplace-sourced economics cannot silently drift in storage or write paths.

## Requirements Covered

- INT-01, INT-02, INT-03, INT-04

## Must-Have Truths

1. Every job and booking persists source provenance (`self_sourced` or `marketplace_sourced`) with audit-friendly metadata.
2. Self-sourced jobs remain subscription-covered (no per-job commission).
3. Marketplace-sourced jobs retain marketplace fee policy.
4. Pass-on flows keep original source provenance unless explicit admin override flow is implemented.

## Task Breakdown

- [ ] **Task 1: Add DB provenance + fee invariants**
  - Create migration `164_marketplace_integrity_provenance.sql`.
  - Add provenance fields and fee-policy constraints to relevant marketplace/direct entities.
  - Add immutability guard trigger for non-admin provenance reclassification.

- [ ] **Task 2: Update cross-app type contracts**
  - Update type + schema contracts in `web/` and `web-marketplace/` to include provenance/fee-policy fields.
  - Ensure enums match SQL values exactly.

- [ ] **Task 3: Wire write paths**
  - Direct job flows always persist `self_sourced` + subscription fee policy.
  - Marketplace write paths always persist marketplace fee policy.
  - Preserve source provenance during pass-on transitions.

## Dependencies

- Task 1 before Task 2 and Task 3.
- Task 2 before final Task 3 wiring compile checks.

## Verification Strategy

- Grep checks for provenance/fee fields + trigger:
  - `rg -n "source_provenance|fee_policy|BEFORE UPDATE|is_platform_admin" supabase/migrations/164_marketplace_integrity_provenance.sql`
- Compile/type checks:
  - `pnpm --dir web exec tsc --noEmit`
  - `pnpm --dir web-marketplace exec tsc --noEmit` (record pre-existing debt separately if unrelated)
- Wiring checks:
  - `rg -n "source_provenance|fee_policy|subscription|commission" web web-marketplace`

## Risks and Mitigations

- **Risk:** Legacy rows violate new constraints.
  - **Mitigation:** Backfill safe defaults in migration before NOT NULL/CHECK enforcement.
- **Risk:** App and DB enum drift.
  - **Mitigation:** Update type contracts in same execution slice and verify with `tsc`.
- **Risk:** Hidden path mutates provenance.
  - **Mitigation:** DB immutability trigger blocks silent reclassification globally.

## Policy Decisions Locked for Build

- Pass-on provenance lock: origin source remains unchanged by handoff.
- Co-shared policy for Scenario C: dual-sided fee model (5% + 5%).
- Client self-attestation is not a primary integrity control; 48-01 foundation must support signal-driven enforcement.

## Suggested Commit Slices

1. `feat(48-01): add provenance and fee-integrity migration`
2. `feat(48-01): add provenance type contracts`
3. `feat(48-01): wire direct and marketplace write paths`
