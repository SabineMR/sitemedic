---
phase: 33-event-posting-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/145_marketplace_events.sql
  - web/lib/marketplace/event-types.ts
  - web/lib/marketplace/event-schemas.ts
  - web/app/api/marketplace/events/route.ts
  - web/app/api/marketplace/events/[id]/route.ts
  - web/app/api/marketplace/events/[id]/close/route.ts
autonomous: true

must_haves:
  truths:
    - "marketplace_events table exists with event details, location coordinates (GEOGRAPHY POINT), status workflow, quote deadline, and draft support"
    - "event_days table exists for multi-day events with per-day date and start/end times"
    - "event_staffing_requirements table exists with role and quantity, queryable for qualification-based event discovery"
    - "RLS policies allow event poster to manage own events (including drafts), verified companies to browse open events only, and platform admin full access"
    - "PostGIS extension enabled for ST_DWithin radius queries on event location"
    - "TypeScript types and Zod validation schemas exist for all event entities"
    - "API routes support creating an event (with days + staffing + equipment), fetching events, updating events (with pre/post-quote edit restrictions), and closing/cancelling events"
  artifacts:
    - path: "supabase/migrations/145_marketplace_events.sql"
      provides: "marketplace_events, event_days, event_staffing_requirements tables with RLS, indexes, triggers"
      contains: "CREATE TABLE marketplace_events"
    - path: "web/lib/marketplace/event-types.ts"
      provides: "TypeScript interfaces for events, event days, staffing requirements"
      exports: ["MarketplaceEvent", "EventDay", "EventStaffingRequirement", "EventStatus", "EventType", "StaffingRole", "EquipmentItem"]
    - path: "web/lib/marketplace/event-schemas.ts"
      provides: "Zod validation schemas for event posting wizard steps"
      exports: ["basicInfoSchema", "schedulingSchema", "staffingSchema", "eventFormSchema"]
    - path: "web/app/api/marketplace/events/route.ts"
      provides: "POST (create event) and GET (list events) endpoints"
      exports: ["POST", "GET"]
    - path: "web/app/api/marketplace/events/[id]/route.ts"
      provides: "GET (single event), PUT (update event with edit restrictions) endpoints"
      exports: ["GET", "PUT"]
    - path: "web/app/api/marketplace/events/[id]/close/route.ts"
      provides: "POST endpoint to close/cancel an event"
      exports: ["POST"]
  key_links:
    - from: "supabase/migrations/145_marketplace_events.sql"
      to: "auth.users table"
      via: "posted_by FK for event ownership, RLS uses auth.uid()"
      pattern: "posted_by.*auth\\.uid\\(\\)"
    - from: "supabase/migrations/145_marketplace_events.sql"
      to: "marketplace_companies table"
      via: "RLS policy checks verification_status for browse access"
      pattern: "marketplace_companies.*verification_status.*verified"
    - from: "web/lib/marketplace/event-schemas.ts"
      to: "web/lib/marketplace/event-types.ts"
      via: "Zod schemas produce types matching TypeScript interfaces"
      pattern: "import.*event-types"
    - from: "web/app/api/marketplace/events/route.ts"
      to: "supabase/migrations/145_marketplace_events.sql"
      via: "API routes insert/query marketplace_events via Supabase client"
      pattern: "from\\('marketplace_events'\\)"
---

<objective>
Create the event database schema, TypeScript types, Zod validation schemas, and API routes for marketplace event CRUD operations.

Purpose: This is the foundation for all Phase 33 UI work. The event posting wizard (33-02) and event discovery (33-03) both depend on these tables, types, and API routes existing first.

Output: 1 SQL migration file (3 tables), 2 TypeScript library files (types + Zod schemas), 3 API route files (events CRUD + close/cancel).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-event-posting-discovery/33-RESEARCH.md
@.planning/phases/33-event-posting-discovery/33-CONTEXT.md

# Prior phase — database patterns to follow:
@supabase/migrations/140_marketplace_foundation.sql
@supabase/migrations/141_compliance_documents.sql
@web/lib/marketplace/types.ts

# Existing patterns:
@supabase/migrations/028_enable_org_rls.sql
@web/app/api/marketplace/register/route.ts
@web/lib/booking/vertical-requirements.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create marketplace events migration (tables, RLS, indexes)</name>
  <files>supabase/migrations/145_marketplace_events.sql</files>
  <action>
Create migration file `145_marketplace_events.sql` with:

**1. Enable PostGIS extension** (for radius-based event discovery):
```sql
CREATE EXTENSION IF NOT EXISTS postgis;
```

**2. Create `marketplace_events` table:**
- `id` UUID PK with gen_random_uuid()
- `posted_by` UUID NOT NULL FK to auth.users(id) — the client user who created this event
- `event_name` TEXT NOT NULL
- `event_type` TEXT NOT NULL with CHECK constraint for ('construction', 'tv_film', 'motorsport', 'festivals', 'sporting_events', 'corporate', 'private_events', 'other') — aligns with existing vertical types
- `event_description` TEXT
- `special_requirements` TEXT — free text for additional details
- `indoor_outdoor` TEXT NOT NULL DEFAULT 'outdoor' with CHECK for ('indoor', 'outdoor', 'mixed')
- `expected_attendance` INT
- `budget_min` DECIMAL(10,2) — optional budget range lower bound
- `budget_max` DECIMAL(10,2) — optional budget range upper bound
- `location_postcode` TEXT NOT NULL
- `location_address` TEXT — full address from Google Places
- `location_what3words` TEXT — optional fallback for remote locations
- `location_coordinates` GEOGRAPHY(POINT, 4326) — for ST_DWithin radius queries
- `location_display` TEXT — approximate area only (town/city + postcode area) shown to medics before quoting
- `quote_deadline` TIMESTAMPTZ NOT NULL — after this, no new quotes accepted
- `status` TEXT NOT NULL DEFAULT 'draft' with CHECK for ('draft', 'open', 'closed', 'cancelled', 'awarded')
- `has_quotes` BOOLEAN NOT NULL DEFAULT FALSE — flipped when first quote arrives; controls edit restrictions (EVNT-05)
- `quote_count` INT NOT NULL DEFAULT 0 — denormalized count for display on list/detail views
- `equipment_required` JSONB NOT NULL DEFAULT '[]'::jsonb — array of { type: string, notes?: string }. Equipment types: 'ambulance', 'defibrillator', 'first_aid_tent', 'stretcher', 'oxygen_supply', 'other'
- `created_at` TIMESTAMPTZ DEFAULT NOW()
- `updated_at` TIMESTAMPTZ DEFAULT NOW()

**3. Create `event_days` table** (multi-day support — a 3-day festival has 3 rows):
- `id` UUID PK with gen_random_uuid()
- `event_id` UUID NOT NULL FK to marketplace_events(id) ON DELETE CASCADE
- `event_date` DATE NOT NULL
- `start_time` TIME NOT NULL
- `end_time` TIME NOT NULL
- `sort_order` INT NOT NULL DEFAULT 0
- UNIQUE constraint on (event_id, event_date) — one row per day per event

**4. Create `event_staffing_requirements` table** (per-day or all-days staffing — separate table for query-based qualification matching in discovery):
- `id` UUID PK with gen_random_uuid()
- `event_id` UUID NOT NULL FK to marketplace_events(id) ON DELETE CASCADE
- `event_day_id` UUID FK to event_days(id) ON DELETE CASCADE — NULL means "applies to all days"
- `role` TEXT NOT NULL with CHECK for ('paramedic', 'emt', 'first_aider', 'doctor', 'nurse', 'other')
- `quantity` INT NOT NULL DEFAULT 1 CHECK (quantity > 0)
- `additional_notes` TEXT

**5. Enable RLS on all three tables.**

**6. RLS policies on `marketplace_events`** — IMPORTANT: use auth.uid() NOT get_user_org_id() (marketplace is cross-org):
- `event_poster_manage_own`: FOR ALL USING (posted_by = auth.uid()) — poster can CRUD their own events including drafts
- `verified_companies_browse_open`: FOR SELECT USING (status = 'open' AND EXISTS (SELECT 1 FROM marketplace_companies WHERE admin_user_id = auth.uid() AND verification_status = 'verified' AND can_browse_events = true)) — only verified companies see open events
- `platform_admin_all_events`: FOR ALL USING (is_platform_admin())

**7. RLS policies on `event_days`:**
- `event_day_via_event_poster`: FOR ALL USING (EXISTS (SELECT 1 FROM marketplace_events WHERE id = event_days.event_id AND posted_by = auth.uid()))
- `event_day_via_verified_browse`: FOR SELECT USING (EXISTS (SELECT 1 FROM marketplace_events WHERE id = event_days.event_id AND status = 'open') AND EXISTS (SELECT 1 FROM marketplace_companies WHERE admin_user_id = auth.uid() AND verification_status = 'verified' AND can_browse_events = true))
- `platform_admin_all_event_days`: FOR ALL USING (is_platform_admin())

**8. RLS policies on `event_staffing_requirements`:**
- `staffing_via_event_poster`: FOR ALL USING (EXISTS (SELECT 1 FROM marketplace_events WHERE id = event_staffing_requirements.event_id AND posted_by = auth.uid()))
- `staffing_via_verified_browse`: FOR SELECT USING (EXISTS (SELECT 1 FROM marketplace_events WHERE id = event_staffing_requirements.event_id AND status = 'open') AND EXISTS (SELECT 1 FROM marketplace_companies WHERE admin_user_id = auth.uid() AND verification_status = 'verified' AND can_browse_events = true))
- `platform_admin_all_staffing`: FOR ALL USING (is_platform_admin())

**9. Triggers:**
- Reuse `update_updated_at_column()` trigger on marketplace_events

**10. Indexes:**
- `idx_events_posted_by` ON marketplace_events(posted_by)
- `idx_events_status` ON marketplace_events(status)
- `idx_events_event_type` ON marketplace_events(event_type)
- `idx_events_quote_deadline` ON marketplace_events(quote_deadline)
- `idx_events_location_coordinates` USING GIST ON marketplace_events(location_coordinates) — spatial index for radius queries
- `idx_events_status_type_deadline` ON marketplace_events(status, event_type, quote_deadline) — composite for filtered browsing
- `idx_event_days_event_id` ON event_days(event_id)
- `idx_event_days_event_date` ON event_days(event_date)
- `idx_staffing_event_id` ON event_staffing_requirements(event_id)
- `idx_staffing_role` ON event_staffing_requirements(role) — for qualification-based discovery filtering

**11. Comments:**
Add COMMENT ON TABLE and COMMENT ON COLUMN for key fields documenting the marketplace event lifecycle and edit restriction logic.
  </action>
  <verify>
Run `grep -c "CREATE TABLE" supabase/migrations/145_marketplace_events.sql` — should return 3 (marketplace_events, event_days, event_staffing_requirements).
Run `grep -c "CREATE POLICY" supabase/migrations/145_marketplace_events.sql` — should return 9 (3 per table).
Run `grep "GEOGRAPHY" supabase/migrations/145_marketplace_events.sql` — should match the location_coordinates column.
Run `grep "postgis" supabase/migrations/145_marketplace_events.sql` — should match the extension.
Run `grep -c "CREATE INDEX" supabase/migrations/145_marketplace_events.sql` — should return 10.
Run `grep "USING GIST" supabase/migrations/145_marketplace_events.sql` — should match the spatial index.
  </verify>
  <done>marketplace_events table with full event fields including GEOGRAPHY coordinates, status workflow, quote deadline, and edit restriction tracking. event_days for multi-day support. event_staffing_requirements for queryable per-day staffing roles. All 3 tables have RLS policies using auth.uid() for cross-org marketplace access. Spatial GIST index on coordinates for radius queries. 10 indexes total for performant discovery filtering.</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types, Zod schemas, and event API routes</name>
  <files>web/lib/marketplace/event-types.ts, web/lib/marketplace/event-schemas.ts, web/app/api/marketplace/events/route.ts, web/app/api/marketplace/events/[id]/route.ts, web/app/api/marketplace/events/[id]/close/route.ts</files>
  <action>
**File 1: `web/lib/marketplace/event-types.ts`**

TypeScript interfaces mirroring the SQL schema:

```typescript
// Event status workflow
export type EventStatus = 'draft' | 'open' | 'closed' | 'cancelled' | 'awarded';

// Event types (align with existing booking verticals)
export type EventType = 'construction' | 'tv_film' | 'motorsport' | 'festivals' | 'sporting_events' | 'corporate' | 'private_events' | 'other';

// Staffing roles
export type StaffingRole = 'paramedic' | 'emt' | 'first_aider' | 'doctor' | 'nurse' | 'other';

// Indoor/outdoor
export type IndoorOutdoor = 'indoor' | 'outdoor' | 'mixed';

// Equipment items (stored as JSONB)
export interface EquipmentItem {
  type: 'ambulance' | 'defibrillator' | 'first_aid_tent' | 'stretcher' | 'oxygen_supply' | 'other';
  notes?: string;
}

// Main event interface
export interface MarketplaceEvent {
  id: string;
  posted_by: string;
  event_name: string;
  event_type: EventType;
  event_description: string | null;
  special_requirements: string | null;
  indoor_outdoor: IndoorOutdoor;
  expected_attendance: number | null;
  budget_min: number | null;
  budget_max: number | null;
  location_postcode: string;
  location_address: string | null;
  location_what3words: string | null;
  location_coordinates: unknown; // PostGIS geography type
  location_display: string | null;
  quote_deadline: string;
  status: EventStatus;
  has_quotes: boolean;
  quote_count: number;
  equipment_required: EquipmentItem[];
  created_at: string;
  updated_at: string;
}

// Event day
export interface EventDay {
  id: string;
  event_id: string;
  event_date: string;
  start_time: string;
  end_time: string;
  sort_order: number;
}

// Staffing requirement
export interface EventStaffingRequirement {
  id: string;
  event_id: string;
  event_day_id: string | null;
  role: StaffingRole;
  quantity: number;
  additional_notes: string | null;
}

// Event with related data (for detail views)
export interface MarketplaceEventWithDetails extends MarketplaceEvent {
  event_days: EventDay[];
  staffing_requirements: EventStaffingRequirement[];
}

// Human-readable labels
export const EVENT_TYPE_LABELS: Record<EventType, string> = {
  construction: 'Construction',
  tv_film: 'Film & TV',
  motorsport: 'Motorsport',
  festivals: 'Festival',
  sporting_events: 'Sporting Event',
  corporate: 'Corporate',
  private_events: 'Private Event',
  other: 'Other',
};

export const STAFFING_ROLE_LABELS: Record<StaffingRole, string> = {
  paramedic: 'Paramedic',
  emt: 'EMT',
  first_aider: 'First Aider',
  doctor: 'Doctor',
  nurse: 'Nurse',
  other: 'Other',
};

export const EQUIPMENT_TYPE_LABELS: Record<EquipmentItem['type'], string> = {
  ambulance: 'Ambulance',
  defibrillator: 'Defibrillator / AED',
  first_aid_tent: 'First Aid Tent',
  stretcher: 'Stretcher',
  oxygen_supply: 'Oxygen Supply',
  other: 'Other',
};
```

**File 2: `web/lib/marketplace/event-schemas.ts`**

Zod validation schemas for the multi-step event posting wizard:

```typescript
import { z } from 'zod';

// UK postcode validation
const ukPostcodeRegex = /^[A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2}$/i;

// Step 1: Basic Info
export const basicInfoSchema = z.object({
  event_name: z.string().min(3, 'Event name must be at least 3 characters').max(200),
  event_type: z.enum(['construction', 'tv_film', 'motorsport', 'festivals', 'sporting_events', 'corporate', 'private_events', 'other']),
  event_description: z.string().max(5000).optional().nullable(),
  special_requirements: z.string().max(2000).optional().nullable(),
  indoor_outdoor: z.enum(['indoor', 'outdoor', 'mixed']),
  expected_attendance: z.number().int().min(1).max(1000000).optional().nullable(),
});

// Step 2: Schedule & Location
export const schedulingSchema = z.object({
  event_days: z.array(z.object({
    event_date: z.string().min(1, 'Date is required'),
    start_time: z.string().min(1, 'Start time is required'),
    end_time: z.string().min(1, 'End time is required'),
  })).min(1, 'At least one event day is required'),
  location_postcode: z.string().regex(ukPostcodeRegex, 'Enter a valid UK postcode'),
  location_address: z.string().optional().nullable(),
  location_what3words: z.string().optional().nullable(),
  location_lat: z.number().optional().nullable(),
  location_lng: z.number().optional().nullable(),
  location_display: z.string().optional().nullable(),
  quote_deadline: z.string().min(1, 'Quote deadline is required'),
});

// Step 3: Staffing & Equipment
export const staffingSchema = z.object({
  staffing_requirements: z.array(z.object({
    event_day_id: z.string().optional().nullable(), // null = all days
    role: z.enum(['paramedic', 'emt', 'first_aider', 'doctor', 'nurse', 'other']),
    quantity: z.number().int().min(1, 'At least 1 required'),
    additional_notes: z.string().max(500).optional().nullable(),
  })).min(1, 'At least one staffing requirement is required'),
  equipment_required: z.array(z.object({
    type: z.enum(['ambulance', 'defibrillator', 'first_aid_tent', 'stretcher', 'oxygen_supply', 'other']),
    notes: z.string().max(500).optional(),
  })).default([]),
  budget_min: z.number().min(0).optional().nullable(),
  budget_max: z.number().min(0).optional().nullable(),
});

// Combined schema for full event creation (server-side validation)
export const eventFormSchema = basicInfoSchema
  .merge(schedulingSchema)
  .merge(staffingSchema)
  .refine(
    (data) => !data.budget_min || !data.budget_max || data.budget_min <= data.budget_max,
    { message: 'Minimum budget cannot exceed maximum', path: ['budget_min'] }
  );

// Update schema — after quotes, only description + special_requirements editable (EVNT-05)
export const eventUpdatePreQuotesSchema = basicInfoSchema
  .merge(schedulingSchema)
  .merge(staffingSchema);

export const eventUpdatePostQuotesSchema = z.object({
  event_description: z.string().max(5000).optional().nullable(),
  special_requirements: z.string().max(2000).optional().nullable(),
});
```

**File 3: `web/app/api/marketplace/events/route.ts`**

POST (create event) and GET (list events with filters):

- `export const dynamic = 'force-dynamic'`
- **POST handler:**
  - Get authenticated user via `createClient()` and `supabase.auth.getUser()`
  - Validate body with `eventFormSchema`
  - Check the user has `marketplace_enabled = true` on their client record (or is a platform admin)
  - Build `location_coordinates` as `ST_MakePoint(lng, lat)::geography` via raw SQL or Supabase RPC if lat/lng provided
  - INSERT into `marketplace_events` — set status to `'draft'` if `save_as_draft` flag is true, otherwise `'open'`
  - INSERT event_days rows (bulk insert from event_days array)
  - INSERT event_staffing_requirements rows (bulk insert from staffing_requirements array)
  - Return 201 with created event ID
  - **Important:** Wrap all inserts in a transaction-like pattern — if child inserts fail, the event should still be created but log the error

- **GET handler:**
  - Supports query params: `status`, `event_type`, `posted_by` (for "my events"), `page`, `limit`
  - For medic discovery queries: `lat`, `lng`, `radius_miles` (converts to meters for ST_DWithin), `role` (filter by staffing role)
  - Default: return open events ordered by quote_deadline ASC (soonest deadline first)
  - Include event_days and staffing_requirements as nested data via Supabase `.select('*, event_days(*), event_staffing_requirements(*)')`
  - For location-based queries with lat/lng: use Supabase RPC or raw SQL with `ST_DWithin(location_coordinates, ST_MakePoint(lng, lat)::geography, radius_meters)` and `ST_Distance` for sorting by distance
  - Pagination: use offset/limit pattern
  - Return 200 with events array and total count

**File 4: `web/app/api/marketplace/events/[id]/route.ts`**

GET (single event) and PUT (update event with edit restrictions):

- `export const dynamic = 'force-dynamic'`
- **GET handler:**
  - Fetch event by ID with nested event_days and staffing_requirements
  - RLS handles access control (poster sees own, verified companies see open, admin sees all)
  - Return 200 with full event details

- **PUT handler:**
  - Get authenticated user, verify they are the poster (`posted_by = auth.uid()`)
  - Check `has_quotes` flag on the event:
    - If `has_quotes = false` (no quotes yet): validate with `eventUpdatePreQuotesSchema` — all fields editable
    - If `has_quotes = true`: validate with `eventUpdatePostQuotesSchema` — only description and special_requirements editable (EVNT-05)
  - If updating full event (pre-quotes): also replace event_days and staffing_requirements (delete old, insert new)
  - Return 200 with updated event

**File 5: `web/app/api/marketplace/events/[id]/close/route.ts`**

POST to close or cancel an event (EVNT-06):

- `export const dynamic = 'force-dynamic'`
- **POST handler:**
  - Accept body: `{ action: 'close' | 'cancel', reason?: string }`
  - Verify poster owns the event
  - Verify event is in 'open' or 'draft' status
  - Update status to 'closed' or 'cancelled'
  - Return 200 with updated event
  - **Note:** Notification to medics who quoted is a stub/comment for now — actual notifications built in Phase 38. Add a `// TODO: Phase 38 — notify medics who quoted on this event` comment where the notification would be triggered.
  </action>
  <verify>
Run `ls web/lib/marketplace/event-types.ts web/lib/marketplace/event-schemas.ts` — both files exist.
Run `ls web/app/api/marketplace/events/route.ts web/app/api/marketplace/events/*/route.ts` — all API route files exist.
Run `grep "eventFormSchema" web/lib/marketplace/event-schemas.ts` — should match the combined schema export.
Run `grep "MarketplaceEvent" web/lib/marketplace/event-types.ts` — should match the main event interface.
Run `grep "force-dynamic" web/app/api/marketplace/events/route.ts` — should match.
Run `grep "has_quotes" web/app/api/marketplace/events/*/route.ts` — should match the edit restriction check.
Run `grep "eventUpdatePostQuotesSchema" web/app/api/marketplace/events/*/route.ts` — should match in the PUT handler.
  </verify>
  <done>TypeScript types mirror SQL schema with human-readable label maps for UI. Zod schemas validate each wizard step independently and provide separate pre/post-quote update schemas enforcing EVNT-05 edit restrictions. API routes support full CRUD: create event with nested days/staffing (POST), list events with location/role/type filters (GET), fetch single event (GET), update with edit restrictions (PUT), close/cancel (POST). All routes use auth.uid() verification and Supabase RLS for access control.</done>
</task>

</tasks>

<verification>
1. Migration file `145_marketplace_events.sql` exists with 3 CREATE TABLE statements
2. PostGIS extension enabled for geography column and spatial queries
3. RLS policies use auth.uid() NOT get_user_org_id() (marketplace is cross-org)
4. Verified companies can only SELECT open events (not drafts, closed, or cancelled)
5. GIST index exists on location_coordinates for radius queries
6. TypeScript interfaces in event-types.ts match SQL column names
7. Zod schemas validate all wizard steps with UK postcode regex
8. Separate pre/post-quote update schemas enforce EVNT-05 edit restrictions
9. API routes use `export const dynamic = 'force-dynamic'`
10. GET events route supports lat/lng/radius filtering with ST_DWithin
11. PUT route checks has_quotes to determine which fields are editable
12. Close/cancel route has TODO comment for Phase 38 notifications
</verification>

<success_criteria>
- Migration file syntactically valid with 3 tables, 9 RLS policies, 10 indexes
- No usage of get_user_org_id() in the events migration
- PostGIS extension created and GEOGRAPHY column defined with SRID 4326
- TypeScript types compile without errors
- Zod schemas correctly split by wizard step
- All 3 API route files follow existing marketplace API patterns (createClient, auth check, force-dynamic)
- Edit restriction logic is clear: has_quotes = false → full edit, has_quotes = true → description + special_requirements only
</success_criteria>

<output>
After completion, create `.planning/phases/33-event-posting-discovery/33-01-SUMMARY.md`
</output>
