---
phase: 33-event-posting-discovery
plan: 03
type: execute
wave: 2
depends_on: [33-01]
files_modified:
  - web/app/marketplace/events/page.tsx
  - web/app/marketplace/events/layout.tsx
  - web/app/marketplace/events/[id]/page.tsx
  - web/components/marketplace/events/EventListRow.tsx
  - web/components/marketplace/events/EventFilters.tsx
  - web/components/marketplace/events/EventMap.tsx
  - web/lib/queries/marketplace/events.ts
autonomous: true

must_haves:
  truths:
    - "Verified medics/company owners can browse open events in a list-row layout showing event name, type, dates, staffing needs, budget range, location + distance, quote deadline, and quote count"
    - "Company owners can search events by city/place name (Google Places autocomplete) AND UK region dropdown side by side"
    - "Individual medics can search events by 'Near me' radius from their profile postcode, default 50 miles, adjustable"
    - "Events can be filtered by event type, date range, and required qualification level"
    - "List view can toggle to map view showing event pins across the search area"
    - "Event detail page shows approximate area only (town/city + postcode area), NOT exact pin — exact location revealed after quoting"
    - "Only verified medics whose qualifications match staffing requirements see matching events (application-level filtering on top of RLS)"
  artifacts:
    - path: "web/app/marketplace/events/page.tsx"
      provides: "Event discovery browse page with list/map toggle, filters, search"
    - path: "web/app/marketplace/events/[id]/page.tsx"
      provides: "Event detail page with approximate location and staffing summary"
    - path: "web/components/marketplace/events/EventListRow.tsx"
      provides: "Single event row component for the list view"
    - path: "web/components/marketplace/events/EventFilters.tsx"
      provides: "Filter bar with type, date, location search, qualification level, radius"
    - path: "web/components/marketplace/events/EventMap.tsx"
      provides: "Google Maps component showing event pins"
    - path: "web/lib/queries/marketplace/events.ts"
      provides: "React Query hooks for fetching events with filters"
      exports: ["useMarketplaceEvents", "useMarketplaceEvent"]
  key_links:
    - from: "web/app/marketplace/events/page.tsx"
      to: "web/lib/queries/marketplace/events.ts"
      via: "Uses useMarketplaceEvents hook for data fetching with filter params"
      pattern: "useMarketplaceEvents"
    - from: "web/lib/queries/marketplace/events.ts"
      to: "web/app/api/marketplace/events/route.ts"
      via: "Fetches from GET /api/marketplace/events with query params"
      pattern: "api/marketplace/events"
    - from: "web/components/marketplace/events/EventFilters.tsx"
      to: "web/app/marketplace/events/page.tsx"
      via: "Filter state changes trigger refetch via URL params or callback"
      pattern: "onFilterChange"
    - from: "web/app/marketplace/events/[id]/page.tsx"
      to: "web/lib/queries/marketplace/events.ts"
      via: "Uses useMarketplaceEvent hook for single event detail fetch"
      pattern: "useMarketplaceEvent"
---

<objective>
Build the medic/company event discovery experience: browse page with list + map views, search by location, filter by type/date/qualifications, and event detail page with approximate location.

Purpose: Verified medics and company owners need to find events matching their qualifications and coverage area. Company owners are the primary searchers (managing teams across regions), while individual medics search "near me". The discovery UX must serve both use cases with dense, scannable list rows and optional map view.

Output: Event browse page, event detail page, filter components, map component, React Query hooks for event data.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-event-posting-discovery/33-CONTEXT.md
@.planning/phases/33-event-posting-discovery/33-RESEARCH.md
@.planning/phases/33-event-posting-discovery/33-01-SUMMARY.md

# Pattern references:
@web/components/admin/client-management-table.tsx
@web/components/QuoteBuilder.tsx
@web/lib/marketplace/event-types.ts
@web/lib/marketplace/event-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create React Query hooks and event browse page with filters</name>
  <files>web/lib/queries/marketplace/events.ts, web/app/marketplace/events/page.tsx, web/app/marketplace/events/layout.tsx, web/components/marketplace/events/EventListRow.tsx, web/components/marketplace/events/EventFilters.tsx</files>
  <action>
**File 1: `web/lib/queries/marketplace/events.ts`**

React Query hooks for marketplace event data:

```typescript
import { useQuery } from '@tanstack/react-query';

// Filter params type
export interface EventFilterParams {
  status?: string;           // default: 'open'
  event_type?: string;       // filter by type
  role?: string;             // filter by required staffing role
  lat?: number;              // for radius search
  lng?: number;
  radius_miles?: number;     // default 50
  date_from?: string;        // filter events starting from this date
  date_to?: string;          // filter events ending before this date
  page?: number;
  limit?: number;            // default 20
  posted_by?: string;        // 'me' for my events
}

// Fetch events list
export function useMarketplaceEvents(filters: EventFilterParams) {
  return useQuery({
    queryKey: ['marketplace-events', filters],
    queryFn: async () => {
      const params = new URLSearchParams();
      Object.entries(filters).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== '') {
          params.set(key, String(value));
        }
      });
      const res = await fetch(`/api/marketplace/events?${params.toString()}`);
      if (!res.ok) throw new Error('Failed to fetch events');
      return res.json();
    },
  });
}

// Fetch single event
export function useMarketplaceEvent(eventId: string) {
  return useQuery({
    queryKey: ['marketplace-event', eventId],
    queryFn: async () => {
      const res = await fetch(`/api/marketplace/events/${eventId}`);
      if (!res.ok) throw new Error('Failed to fetch event');
      return res.json();
    },
    enabled: !!eventId,
  });
}
```

**File 2: `web/app/marketplace/events/layout.tsx`**

Simple layout:
```typescript
export const metadata = { title: 'Browse Events - SiteMedic Marketplace' };
```

**File 3: `web/app/marketplace/events/page.tsx`**

Client component ('use client') — the main event discovery page:

- **State management:**
  - `filters` state object (type EventFilterParams) — initialized from URL search params for shareable links
  - `viewMode` state: 'list' | 'map' — toggle between views
  - `userLocation` state: { lat, lng } | null — from user's profile postcode or browser geolocation

- **On mount:**
  - Detect if the user is a company owner (check marketplace_companies for auth.uid()) or an individual medic
  - For individual medics: auto-populate lat/lng from their profile postcode if available
  - Set default radius to 50 miles

- **Data fetching:**
  - Use `useMarketplaceEvents(filters)` hook
  - Refetch on filter changes

- **Layout:**
  - **Top bar:** Page title "Browse Events" + view toggle (List / Map icons)
  - **Filter bar:** EventFilters component (see below)
  - **Results count:** "X events found" with location context (e.g. "within 50 miles" or "in London")
  - **Content area:**
    - List mode: Dense event rows using EventListRow component. One event per row, scannable.
    - Map mode: EventMap component (Task 2) with event pins
  - **Pagination:** Simple page controls at bottom (Previous / Next / page numbers)

- **Empty state:** "No events match your filters. Try widening your search area or adjusting filters."
- **Loading state:** Skeleton rows (5 placeholder rows)

**File 4: `web/components/marketplace/events/EventListRow.tsx`**

Single event row component — dense, scannable layout per CONTEXT decisions:

```
| Event Name & Type Badge | Date(s) | Staffing Needs | Budget | Location + Distance | Deadline | Quotes |
```

- **Event Name + Type:** Event name as link to detail page, small badge for event type (coloured)
- **Date(s):** First day date. If multi-day: "22 Mar - 24 Mar" format. Show day count badge if > 1 day
- **Staffing Needs:** Compact summary: "2× Paramedic, 1× EMT" — truncate if many, show "+N more" tooltip
- **Budget:** "£500 - £1,200" or "Not specified" (grey text)
- **Location + Distance:** Town/city name + postcode area (location_display). If user has lat/lng, show "~X miles away"
  - Calculate distance client-side from user coordinates to event coordinates (simple haversine — event coordinates available from API for display purposes but NOT the exact pin, just for distance calc)
  - **Important:** Do NOT show exact coordinates or address to the medic. Only location_display (approximate area).
- **Deadline:** Relative format: "2 days left", "5 hours left" — highlight red if <24 hours
- **Quotes:** Quote count badge: "4 quotes"
- Entire row clickable → navigates to event detail page

**File 5: `web/components/marketplace/events/EventFilters.tsx`**

Filter bar component with two search modes per CONTEXT decisions:

- **Company Owner mode** (detected from parent page):
  - **Area search:** Google Places Autocomplete input for city/place name search (UK restricted, types: ['(cities)'])
    - On place_changed: extract lat/lng and use as search center
  - **UK Region dropdown** (side by side with area search):
    - Options: London, South East, South West, East of England, East Midlands, West Midlands, Yorkshire, North West, North East, Scotland, Wales, Northern Ireland
    - On select: set predefined lat/lng for region center with large radius (100 miles)

- **Individual Medic mode:**
  - **"Near me" radius search:**
    - Pre-filled with their profile postcode
    - Adjustable radius slider or dropdown: 10, 25, 50, 75, 100, 150 miles (default 50)

- **Common filters (both modes):**
  - Event type multi-select (checkboxes or multi-select dropdown) from EVENT_TYPE_LABELS
  - Date range picker: "From" and "To" date inputs
  - Qualification level dropdown: filter by required staffing role (from STAFFING_ROLE_LABELS)
  - "Clear filters" button

- Filter changes update the parent page's filter state (via callback or URL params)
- Filters are applied on change (no separate "Apply" button needed — live filtering)
  </action>
  <verify>
Run `ls web/lib/queries/marketplace/events.ts` — exists.
Run `ls web/app/marketplace/events/page.tsx` — exists.
Run `ls web/components/marketplace/events/EventListRow.tsx web/components/marketplace/events/EventFilters.tsx` — both exist.
Run `grep "useMarketplaceEvents" web/lib/queries/marketplace/events.ts` — should match the hook export.
Run `grep "viewMode\|list.*map" web/app/marketplace/events/page.tsx` — should match the list/map toggle.
Run `grep "company\|medic\|Near me\|radius" web/components/marketplace/events/EventFilters.tsx` — should match the two search modes.
Run `grep "UK Region\|region\|London\|South East" web/components/marketplace/events/EventFilters.tsx` — should match the region dropdown.
Run `grep "location_display" web/components/marketplace/events/EventListRow.tsx` — should match approximate location display.
  </verify>
  <done>React Query hooks for marketplace events with full filter param support. Browse page with list/map toggle, automatic user type detection (company owner vs individual medic). Event list rows show dense, scannable info: name + type badge, dates, staffing summary, budget, approximate location with distance, deadline with urgency highlighting, quote count. Filter bar has dual search modes: company owners get area search (Google Places) + UK region dropdown, individual medics get "Near me" radius search. Common filters: event type, date range, qualification level. Live filtering on change.</done>
</task>

<task type="auto">
  <name>Task 2: Create event detail page and map view component</name>
  <files>web/app/marketplace/events/[id]/page.tsx, web/components/marketplace/events/EventMap.tsx</files>
  <action>
**File 1: `web/app/marketplace/events/[id]/page.tsx`**

Client component for event detail view:

- Fetch event with `useMarketplaceEvent(params.id)` hook
- Loading: Skeleton layout
- Error/not found: Alert with back link

- **Page layout:**
  - **Header section:**
    - Event name (h1)
    - Type badge + Status badge
    - Quote deadline with countdown: "Quotes due in 3 days" or "Quotes closed" (past deadline)
    - Quote count: "X quotes received"

  - **Details section** (Card or bordered sections):
    - **About:** Description, special requirements, indoor/outdoor badge, expected attendance
    - **Schedule:** Table of event days — Date, Start Time, End Time per row. Multi-day events show clear day-by-day breakdown.
    - **Location:** Show APPROXIMATE area only — `location_display` field (town/city + postcode area).
      - Do NOT show the exact address, postcode, or coordinates.
      - Show a small static map image centered on the approximate area (optional, can use Google Static Maps API with zoom level 10-11 to show general area without exact pin). If not using static map, just show the text area.
      - Note below location: "Exact address provided after you submit a quote"
    - **Staffing Requirements:** Table — Role, Quantity, Day Assignment (or "All days"), Notes. Group by day for multi-day events.
    - **Equipment Required:** Bulleted list of selected equipment with any notes.
    - **Budget:** Budget range if provided, or "No budget specified" in grey.

  - **Action section** (sticky bottom bar or prominent CTA):
    - "Submit a Quote" button (primary) — **disabled in Phase 33** with tooltip "Quoting available soon" (actual quoting built in Phase 34)
    - If the viewing user is the event poster: show "Edit Event" button instead, linking to edit page

- **Breadcrumb:** Browse Events > {Event Name}

**File 2: `web/components/marketplace/events/EventMap.tsx`**

Google Maps component for the map view on the browse page:

- Accept props: `events` array (with lat/lng from location_coordinates), `center` (from search), `radius` (optional circle overlay)
- Render Google Map using the existing Google Maps loaded on the page (check for `window.google`)
  - Use `@react-google-maps/api` or the existing Google Maps pattern from the codebase
  - If neither exists, use the Google Maps JavaScript API directly with refs
- **Markers:**
  - One marker per event at its coordinates
  - Marker click shows InfoWindow with: Event name, type, dates, staffing summary, "View Details" link
  - Markers clustered if many events in same area (optional: use MarkerClusterer)
- **Search radius circle** (optional): If user searched by radius, show a circle overlay centered on their search point
- **Fit bounds:** Auto-zoom to fit all visible event markers
- **No exact address shown:** The marker is placed at approximate coordinates (which is the event's actual coordinates for the map view — this is intentional since the map shows general area distribution, not street-level precision). The detail page still shows approximate area only.
- Responsive: fills container width, min-height 400px

- **Important:** The map view is for company owners to see event distribution across areas. Individual event pins on the map do show position, but the event detail page still withholds exact address until a quote is submitted. The map gives geographic context without revealing full address details.
  </action>
  <verify>
Run `ls web/app/marketplace/events/*/page.tsx` — detail page exists.
Run `ls web/components/marketplace/events/EventMap.tsx` — map component exists.
Run `grep "location_display" web/app/marketplace/events/*/page.tsx` — should match approximate location display.
Run `grep "Exact address\|after.*quote" web/app/marketplace/events/*/page.tsx` — should match the location privacy note.
Run `grep "Submit a Quote\|Quoting available" web/app/marketplace/events/*/page.tsx` — should match the disabled quote button with Phase 34 note.
Run `grep "google.maps\|Map\|Marker\|InfoWindow" web/components/marketplace/events/EventMap.tsx` — should match Google Maps integration.
Run `grep "useMarketplaceEvent" web/app/marketplace/events/*/page.tsx` — should match the React Query hook usage.
  </verify>
  <done>Event detail page shows full event information with approximate location only (location_display), note about exact address after quoting, schedule table, staffing table, equipment list, and budget. Quote button disabled with Phase 34 note. Map component renders Google Maps with event markers, InfoWindows on click with event summary and detail link, optional radius circle overlay, and auto-zoom to fit bounds. Company owners can visualise event distribution across their coverage area.</done>
</task>

</tasks>

<verification>
1. Events browse page loads open events for verified companies (RLS enforced server-side)
2. List rows show all required fields: name, type, dates, staffing, budget, location+distance, deadline, quotes
3. Company owners see area search (Google Places) + UK region dropdown
4. Individual medics see "Near me" radius search with adjustable distance
5. Filters for event type, date range, and qualification level all work
6. List ↔ map toggle works without losing filter state
7. Map shows event markers with InfoWindow popups
8. Event detail page shows location_display ONLY (not exact address/postcode/coordinates)
9. "Exact address provided after you submit a quote" note is visible on detail page
10. Quote button is disabled with Phase 34 note
11. Breadcrumb navigation works (Browse Events > Event Name)
12. Pagination works on event list
13. Empty state shows when no events match filters
</verification>

<success_criteria>
- React Query hooks correctly parameterize API calls with filter params
- Browse page renders event list with all required columns per CONTEXT specification
- Two distinct search modes based on user type (company owner vs individual medic)
- Google Places autocomplete for area search + UK region dropdown
- Radius search defaults to 50 miles for individual medics
- Map component renders Google Maps with event markers
- Event detail page respects location privacy (approximate area only)
- All filter combinations produce valid API requests
- Loading and empty states render correctly
</success_criteria>

<output>
After completion, create `.planning/phases/33-event-posting-discovery/33-03-SUMMARY.md`
</output>
