---
phase: 33-event-posting-discovery
plan: 02
type: execute
wave: 2
depends_on: [33-01]
files_modified:
  - web/stores/useEventPostingStore.ts
  - web/app/marketplace/events/create/page.tsx
  - web/app/marketplace/events/create/layout.tsx
  - web/components/marketplace/event-wizard/BasicInfoStep.tsx
  - web/components/marketplace/event-wizard/ScheduleLocationStep.tsx
  - web/components/marketplace/event-wizard/StaffingEquipmentStep.tsx
  - web/components/marketplace/event-wizard/ReviewStep.tsx
  - web/app/marketplace/my-events/page.tsx
  - web/app/marketplace/events/[id]/edit/page.tsx
autonomous: true

must_haves:
  truths:
    - "A client can navigate through a 4-step wizard to post an event with all required fields: name, type, description, dates/times, location, staffing, equipment, and optional budget"
    - "Location entry uses Google Places autocomplete with UK restriction, and has what3words fallback for remote locations"
    - "Staffing requirements support per-day assignment for multi-day events with role picker and quantity"
    - "Events can be saved as draft and resumed later from the client's My Events dashboard"
    - "The review step shows a complete summary before submission with option to go back and edit any step"
    - "Client's My Events page shows all posted events (drafts, open, closed, cancelled, awarded) with status badges and actions"
    - "Edit page enforces EVNT-05: all fields editable before quotes, only description and special requirements after quotes"
    - "Close/cancel action is available on open events with confirmation dialog"
  artifacts:
    - path: "web/stores/useEventPostingStore.ts"
      provides: "Zustand store managing 4-step wizard state with draft persistence"
      exports: ["useEventPostingStore"]
    - path: "web/app/marketplace/events/create/page.tsx"
      provides: "Event posting wizard page with step navigation and progress bar"
    - path: "web/components/marketplace/event-wizard/BasicInfoStep.tsx"
      provides: "Step 1: event name, type, description, special requirements, indoor/outdoor, attendance"
    - path: "web/components/marketplace/event-wizard/ScheduleLocationStep.tsx"
      provides: "Step 2: event days (add/remove), times, Google Places postcode/address, what3words, quote deadline"
    - path: "web/components/marketplace/event-wizard/StaffingEquipmentStep.tsx"
      provides: "Step 3: role picker with quantities, per-day assignment, equipment checklist, budget range with nudge"
    - path: "web/components/marketplace/event-wizard/ReviewStep.tsx"
      provides: "Step 4: full summary, submit as draft or publish, edit-step links"
    - path: "web/app/marketplace/my-events/page.tsx"
      provides: "Client's event management dashboard with list, status badges, edit/close/cancel actions"
    - path: "web/app/marketplace/events/[id]/edit/page.tsx"
      provides: "Edit event page with pre/post-quote field restrictions"
  key_links:
    - from: "web/stores/useEventPostingStore.ts"
      to: "web/lib/marketplace/event-schemas.ts"
      via: "Store validates step data using Zod schemas before allowing navigation"
      pattern: "import.*event-schemas"
    - from: "web/app/marketplace/events/create/page.tsx"
      to: "web/app/api/marketplace/events/route.ts"
      via: "Submit handler POSTs to /api/marketplace/events"
      pattern: "fetch.*api/marketplace/events"
    - from: "web/app/marketplace/my-events/page.tsx"
      to: "web/app/api/marketplace/events/route.ts"
      via: "Fetches events with posted_by filter from GET /api/marketplace/events"
      pattern: "posted_by"
    - from: "web/app/marketplace/events/[id]/edit/page.tsx"
      to: "web/app/api/marketplace/events/[id]/route.ts"
      via: "PUT to update event, checks has_quotes for field restrictions"
      pattern: "has_quotes"
---

<objective>
Build the event posting wizard UI (4-step form) and client event management pages (My Events dashboard, edit page, close/cancel).

Purpose: Clients need an intuitive way to post events with all required details, manage their listings, and have proper edit restrictions based on whether quotes have been received. This plan delivers the full client-side event management experience.

Output: 1 Zustand store, 4 wizard step components, event posting page, My Events dashboard, edit event page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-event-posting-discovery/33-CONTEXT.md
@.planning/phases/33-event-posting-discovery/33-RESEARCH.md
@.planning/phases/33-event-posting-discovery/33-01-SUMMARY.md

# Pattern references:
@web/stores/useMarketplaceRegistrationStore.ts
@web/app/marketplace/register/page.tsx
@web/components/booking/booking-form.tsx
@web/components/QuoteBuilder.tsx
@web/components/ui/what3words-input.tsx
@web/lib/marketplace/event-types.ts
@web/lib/marketplace/event-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand store and 4-step event posting wizard</name>
  <files>web/stores/useEventPostingStore.ts, web/app/marketplace/events/create/page.tsx, web/app/marketplace/events/create/layout.tsx, web/components/marketplace/event-wizard/BasicInfoStep.tsx, web/components/marketplace/event-wizard/ScheduleLocationStep.tsx, web/components/marketplace/event-wizard/StaffingEquipmentStep.tsx, web/components/marketplace/event-wizard/ReviewStep.tsx</files>
  <action>
**File 1: `web/stores/useEventPostingStore.ts`**

Create Zustand store following the pattern from `useMarketplaceRegistrationStore.ts`:

```typescript
// State shape:
interface EventPostingState {
  // Current step (0-3 for 4 steps)
  currentStep: number;

  // Step 1: Basic Info
  event_name: string;
  event_type: EventType | '';
  event_description: string;
  special_requirements: string;
  indoor_outdoor: IndoorOutdoor;
  expected_attendance: number | null;

  // Step 2: Schedule & Location
  event_days: Array<{ event_date: string; start_time: string; end_time: string }>;
  location_postcode: string;
  location_address: string;
  location_what3words: string;
  location_lat: number | null;
  location_lng: number | null;
  location_display: string;
  quote_deadline: string;

  // Step 3: Staffing & Equipment
  staffing_requirements: Array<{ event_day_id: string | null; role: StaffingRole | ''; quantity: number; additional_notes: string }>;
  equipment_required: EquipmentItem[];
  budget_min: number | null;
  budget_max: number | null;

  // Meta
  isSubmitting: boolean;
  error: string | null;
  draftId: string | null; // If editing an existing draft

  // Actions
  setStep: (step: number) => void;
  updateBasicInfo: (data: Partial<...>) => void;
  updateSchedule: (data: Partial<...>) => void;
  updateStaffing: (data: Partial<...>) => void;
  addEventDay: () => void;
  removeEventDay: (index: number) => void;
  addStaffingRequirement: () => void;
  removeStaffingRequirement: (index: number) => void;
  toggleEquipment: (type: EquipmentItem['type']) => void;
  setSubmitting: (v: boolean) => void;
  setError: (e: string | null) => void;
  setDraftId: (id: string | null) => void;
  loadDraft: (event: MarketplaceEventWithDetails) => void;
  reset: () => void;
}
```

- Import types from `web/lib/marketplace/event-types.ts`
- Default state: 1 event day (empty), 1 staffing requirement (empty), no equipment
- `loadDraft` populates the entire store from an existing draft event (for resuming)
- `reset` clears everything to default state

**File 2: `web/app/marketplace/events/create/layout.tsx`**

Simple layout wrapper — add metadata:
```typescript
export const metadata = { title: 'Post an Event - SiteMedic Marketplace' };
```

**File 3: `web/app/marketplace/events/create/page.tsx`**

Client component ('use client') with:
- Step indicator/progress bar at top (Steps: Basic Info → Schedule & Location → Staffing & Equipment → Review)
- Renders the appropriate step component based on `currentStep` from the store
- Next/Previous buttons at bottom of each step
- On "Next": validate current step with the matching Zod schema (basicInfoSchema, schedulingSchema, staffingSchema). Show validation errors inline. Only advance if valid.
- On "Previous": navigate back without validation (preserve data)
- On step 4 (Review): show "Save as Draft" and "Publish Event" buttons
  - "Save as Draft": POST to /api/marketplace/events with `save_as_draft: true`
  - "Publish Event": POST to /api/marketplace/events with `save_as_draft: false`
- After successful submit: redirect to `/marketplace/my-events` with success toast
- If `draftId` exists in URL params (e.g., `?draft=uuid`): fetch draft event on mount and call `loadDraft()`

**File 4: `web/components/marketplace/event-wizard/BasicInfoStep.tsx`**

Step 1 component:
- Event name text input (required)
- Event type dropdown using Select component with options from EVENT_TYPE_LABELS
- Description textarea (optional)
- Special requirements textarea (optional)
- Indoor/outdoor radio group (3 options)
- Expected attendance number input (optional)
- All fields read from / write to the Zustand store
- Validation errors displayed inline using Zod schema validation on "Next"

**File 5: `web/components/marketplace/event-wizard/ScheduleLocationStep.tsx`**

Step 2 component:
- **Event Days section:**
  - Dynamic list of day rows — each row has: date picker (Calendar component), start time input, end time input
  - "Add another day" button (calls store.addEventDay)
  - Remove button on each day (if more than 1 day exists)
  - Days sorted by date

- **Location section:**
  - Postcode input with UK validation (show error if invalid format)
  - Google Places Autocomplete on the address field — follow pattern from QuoteBuilder.tsx:
    - `componentRestrictions: { country: 'gb' }`
    - `types: ['geocode']`
    - On place_changed: extract formatted_address, lat/lng, and auto-derive location_display (extract town/city from address_components)
    - Auto-fill what3words via `coordinatesToWhat3Words(lat, lng)` if available
  - What3words input (optional fallback) — use existing What3WordsInput component from `web/components/ui/what3words-input.tsx`
  - Small helper text: "For remote locations like fields or festival sites, use what3words or drop a pin"

- **Quote Deadline:**
  - Date/time picker for deadline
  - Must be before the first event day
  - Helper text: "After this date, no new quotes can be submitted"

**File 6: `web/components/marketplace/event-wizard/StaffingEquipmentStep.tsx`**

Step 3 component:
- **Staffing Requirements section:**
  - Dynamic list of staffing rows — each row has:
    - Role dropdown (Select with options from STAFFING_ROLE_LABELS)
    - Quantity number input (min 1)
    - Day assignment dropdown: "All days" or specific day from event_days (show date labels)
    - Additional notes text input (optional)
  - "Add another role" button
  - Remove button on each row (if more than 1)

- **Equipment Checklist section:**
  - Checkbox list of standard equipment (from EQUIPMENT_TYPE_LABELS): ambulance, defibrillator/AED, first aid tent, stretcher, oxygen supply
  - Each checked item can have optional notes text input
  - "Other" checkbox with free text field for anything not listed

- **Budget Range section (optional with nudge):**
  - Two number inputs: "Minimum" and "Maximum" (GBP)
  - If both left empty, show gentle info alert: "Events with budgets tend to get more quotes"
  - Budget nudge should feel helpful, not mandatory — use an info-style Alert component

**File 7: `web/components/marketplace/event-wizard/ReviewStep.tsx`**

Step 4 component:
- Read-only summary of all entered data grouped by section:
  - **Basic Info:** Event name, type badge, description, special requirements, indoor/outdoor, attendance
  - **Schedule:** List of days with dates and times, quote deadline
  - **Location:** Postcode, address (if entered), what3words (if entered), approximate area display
  - **Staffing:** Table of roles × quantities × day assignments
  - **Equipment:** Checked items list
  - **Budget:** Range or "Not specified"
- Each section has an "Edit" link that navigates back to the relevant step (store.setStep)
- Two action buttons:
  - "Save as Draft" (secondary/outline) — saves with draft status
  - "Publish Event" (primary) — publishes as open
- Loading state on buttons during submission
  </action>
  <verify>
Run `ls web/stores/useEventPostingStore.ts` — exists.
Run `ls web/app/marketplace/events/create/page.tsx` — exists.
Run `ls web/components/marketplace/event-wizard/BasicInfoStep.tsx web/components/marketplace/event-wizard/ScheduleLocationStep.tsx web/components/marketplace/event-wizard/StaffingEquipmentStep.tsx web/components/marketplace/event-wizard/ReviewStep.tsx` — all 4 step components exist.
Run `grep "useEventPostingStore" web/stores/useEventPostingStore.ts` — should match the store export.
Run `grep "Google Places\|Autocomplete\|google.maps" web/components/marketplace/event-wizard/ScheduleLocationStep.tsx` — should match Places integration.
Run `grep "what3words" web/components/marketplace/event-wizard/ScheduleLocationStep.tsx` — should match what3words fallback.
Run `grep "Save as Draft\|Publish Event" web/components/marketplace/event-wizard/ReviewStep.tsx` — should match both submit options.
  </verify>
  <done>4-step event posting wizard with Zustand store for state management. Step 1: basic info with type dropdown. Step 2: multi-day schedule with Google Places autocomplete (UK) and what3words fallback for remote locations. Step 3: per-day staffing role picker with quantities, equipment checklist, and optional budget with nudge. Step 4: review summary with edit links and save-as-draft or publish options. Zod validation enforced on each step transition.</done>
</task>

<task type="auto">
  <name>Task 2: Create My Events dashboard and edit event page with restrictions</name>
  <files>web/app/marketplace/my-events/page.tsx, web/app/marketplace/events/[id]/edit/page.tsx</files>
  <action>
**File 1: `web/app/marketplace/my-events/page.tsx`**

Client component for the client's event management dashboard:

- Fetch events from `GET /api/marketplace/events?posted_by=me` (the API uses auth.uid() to filter)
- Page title: "My Events"
- **Event list** — display as a table (follow pattern from client-management-table.tsx):
  - Columns: Event Name, Type (badge), Date(s), Status (badge), Quotes, Deadline, Actions
  - Status badges with colours: draft (grey), open (green), closed (yellow), cancelled (red), awarded (blue)
  - Quote count: "X quotes" link
  - Deadline: show date, highlight in red if past deadline
  - Actions dropdown per row:
    - Draft: "Edit", "Publish", "Delete"
    - Open: "Edit", "Close", "Cancel"
    - Closed/Cancelled: "View"
    - Awarded: "View"
- **Filters:**
  - Status dropdown: All, Draft, Open, Closed, Cancelled, Awarded
  - Search by event name (local filter with useMemo)
- **Empty state:** "You haven't posted any events yet. Post your first event to find medical cover." with CTA button linking to `/marketplace/events/create`
- Loading state: Skeleton rows
- "Post New Event" button at top right linking to `/marketplace/events/create`

**Actions implementation:**
- "Publish" (draft → open): PATCH or use existing PUT endpoint to update status to 'open'
- "Close": call POST `/api/marketplace/events/{id}/close` with action: 'close' — show confirmation dialog first
- "Cancel": call POST `/api/marketplace/events/{id}/close` with action: 'cancel' — show confirmation dialog with warning about notifying quoted medics
- "Delete" (drafts only): call DELETE or use close with action 'cancel' for drafts
- "Edit": navigate to `/marketplace/events/{id}/edit`
- "View": navigate to `/marketplace/events/{id}` (detail page built in 33-03)

**File 2: `web/app/marketplace/events/[id]/edit/page.tsx`**

Client component for editing an existing event:

- Fetch event details from `GET /api/marketplace/events/{id}`
- Verify the current user is the poster (redirect to my-events if not)
- **Pre-quote editing** (has_quotes = false):
  - Show the same 4-step wizard as the create page, but pre-populated with existing data
  - Use `useEventPostingStore.loadDraft(event)` to populate the store
  - On submit: PUT to `/api/marketplace/events/{id}` with full data
  - All fields editable

- **Post-quote editing** (has_quotes = true):
  - Show a simplified form — NOT the full wizard
  - Only two editable fields: Description textarea and Special Requirements textarea
  - Display other fields as read-only (event name, type, dates, location, staffing, equipment, budget)
  - Info alert at top: "Some fields cannot be edited because quotes have been received. You can still update the description and special requirements."
  - On submit: PUT to `/api/marketplace/events/{id}` with only description + special_requirements

- Both modes:
  - "Save Changes" button with loading state
  - "Cancel" link back to My Events
  - Success toast on save, redirect to My Events
  </action>
  <verify>
Run `ls web/app/marketplace/my-events/page.tsx web/app/marketplace/events/*/edit/page.tsx` — both files exist.
Run `grep "My Events\|my-events" web/app/marketplace/my-events/page.tsx` — should match.
Run `grep "has_quotes" web/app/marketplace/events/*/edit/page.tsx` — should match the edit restriction logic.
Run `grep "Close\|Cancel\|confirmation" web/app/marketplace/my-events/page.tsx` — should match close/cancel actions.
Run `grep "posted_by\|posted_by=me" web/app/marketplace/my-events/page.tsx` — should match the filter.
  </verify>
  <done>My Events dashboard shows all client events with status badges, quote counts, and action dropdowns (edit/publish/close/cancel per status). Edit page enforces EVNT-05: full wizard pre-population before quotes arrive, simplified description-only form after quotes. Close/cancel actions have confirmation dialogs with warning about medic notifications. Draft events can be published directly from the dashboard.</done>
</task>

</tasks>

<verification>
1. Event posting wizard has 4 steps with progress indicator
2. Step navigation validates current step with Zod schema before advancing
3. Google Places autocomplete initialised with `{ country: 'gb' }` restriction
4. What3words input available as fallback for remote locations
5. Multi-day support: days can be added/removed dynamically
6. Per-day staffing assignment: role dropdown shows specific days or "All days"
7. Equipment checklist has checkboxes for standard items + "Other" with free text
8. Budget nudge appears as info alert when budget left empty
9. Review step shows complete summary with edit links per section
10. "Save as Draft" and "Publish Event" both work from review step
11. My Events dashboard has status-appropriate action menus per event
12. Edit page switches between full wizard (pre-quotes) and restricted form (post-quotes)
13. Close/cancel shows confirmation dialog before API call
</verification>

<success_criteria>
- Wizard navigates correctly through all 4 steps with back/next
- Zod validation prevents advancing with invalid data (errors shown inline)
- Google Places autocomplete triggers on the address field and extracts lat/lng
- Staffing requirements allow per-day assignment for multi-day events
- Draft save and publish both call API correctly
- My Events dashboard loads events filtered by current user
- Edit page enforces has_quotes restriction on which fields are editable
- Close/cancel actions hit the correct API endpoint with confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/33-event-posting-discovery/33-02-SUMMARY.md`
</output>
