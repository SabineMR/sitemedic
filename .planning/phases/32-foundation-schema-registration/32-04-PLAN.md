---
phase: 32-foundation-schema-registration
plan: 04
type: execute
wave: 3
depends_on: ["32-01", "32-02"]
files_modified:
  - supabase/functions/stripe-connect/index.ts
  - web/app/api/marketplace/stripe-connect/route.ts
  - web/app/marketplace/register/stripe-callback/page.tsx
  - web/app/marketplace/register/page.tsx
autonomous: false

user_setup:
  - service: Stripe
    why: "Stripe Connect Express for marketplace company payouts"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys (already configured)"
    dashboard_config:
      - task: "Ensure Stripe Connect is enabled for 'company' business_type"
        location: "Stripe Dashboard -> Connect -> Settings"

must_haves:
  truths:
    - "A marketplace company can initiate Stripe Connect Express onboarding from Step 4 of the registration wizard or from their company dashboard"
    - "Stripe creates an Express account with business_type='company' (not 'individual') and the company's name and registration number"
    - "The onboarding link redirects the company to Stripe-hosted identity verification, then back to SiteMedic"
    - "After completing Stripe onboarding, the marketplace_companies row is updated with stripe_account_id and stripe_onboarding_complete=true"
    - "If the company leaves Stripe onboarding incomplete, they can return later to complete it via a refresh link"
  artifacts:
    - path: "supabase/functions/stripe-connect/index.ts"
      provides: "New 'create_company_express_account' action in existing Edge Function"
      contains: "create_company_express_account"
    - path: "web/app/api/marketplace/stripe-connect/route.ts"
      provides: "Next.js API route that invokes the stripe-connect Edge Function for marketplace companies"
      exports: ["POST"]
    - path: "web/app/marketplace/register/stripe-callback/page.tsx"
      provides: "Callback page after Stripe Connect onboarding (success or refresh)"
      min_lines: 30
  key_links:
    - from: "web/app/api/marketplace/stripe-connect/route.ts"
      to: "supabase/functions/stripe-connect/index.ts"
      via: "Supabase Edge Function invocation"
      pattern: "functions\\.invoke\\('stripe-connect'"
    - from: "supabase/functions/stripe-connect/index.ts"
      to: "marketplace_companies table"
      via: "Update stripe_account_id after account creation"
      pattern: "from\\('marketplace_companies'\\)"
    - from: "web/app/marketplace/register/stripe-callback/page.tsx"
      to: "marketplace_companies table"
      via: "Check onboarding status on callback"
      pattern: "stripe_onboarding_complete"
    - from: "web/app/marketplace/register/page.tsx"
      to: "/api/marketplace/stripe-connect"
      via: "fetch POST from Step 4 'Start Stripe Onboarding' button"
      pattern: "fetch.*api/marketplace/stripe-connect"
---

<objective>
Add Stripe Connect Express onboarding for marketplace companies to the existing stripe-connect Edge Function and create the supporting API route and callback page.

Purpose: Marketplace companies need Stripe Express accounts to receive payouts when clients pay for their services. This extends the existing Stripe Connect pattern (which creates individual accounts for medics) with a new company-type account flow.

Output: New action in stripe-connect Edge Function, marketplace Stripe API route, Stripe callback page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-foundation-schema-registration/32-RESEARCH.md
@.planning/phases/32-foundation-schema-registration/32-CONTEXT.md
@.planning/phases/32-foundation-schema-registration/32-01-SUMMARY.md
@.planning/phases/32-foundation-schema-registration/32-02-SUMMARY.md

# CRITICAL: Read these carefully before modifying
@supabase/functions/stripe-connect/index.ts        # EXISTING Edge Function — add new action, do not break existing actions
@supabase/functions/_shared/stripe.ts              # Shared Stripe instance
@web/app/api/stripe/webhooks/route.ts              # Existing Stripe webhook pattern
@web/lib/marketplace/types.ts                      # Types from Plan 01
@web/app/marketplace/register/page.tsx             # Wizard UI from Plan 02 — Step 4 needs "Start Onboarding" button
@web/stores/useMarketplaceRegistrationStore.ts     # Zustand store from Plan 02 — has stripeAccountId/stripeOnboardingComplete state
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add company Express account action to stripe-connect Edge Function</name>
  <files>supabase/functions/stripe-connect/index.ts</files>
  <action>
Read the existing `stripe-connect/index.ts` Edge Function carefully. It currently handles actions: `create_express_account`, `create_payment_intent`, `create_customer`, `check_account_status`.

Add a NEW action `create_company_express_account` to the existing switch/if-else block. Do NOT modify existing actions.

The new action accepts:
```typescript
{
  action: 'create_company_express_account',
  company_id: string,      // marketplace_companies.id
  company_name: string,
  company_email: string,
  company_reg_number?: string,
}
```

Implementation of the new action:

1. **Verify the company exists and the requesting user is the admin:**
   Query marketplace_companies to confirm company_id exists and admin_user_id matches the authenticated user. If not, return 403.

2. **Check if company already has a Stripe account:**
   If marketplace_companies.stripe_account_id is already set, generate a new Account Link (for incomplete onboarding retry) instead of creating a new account.

3. **Create Stripe Express account** (only if no existing account):
   ```typescript
   const account = await stripe.accounts.create({
     type: 'express',
     country: 'GB',
     business_type: 'company',      // KEY DIFFERENCE from existing individual flow
     capabilities: {
       transfers: { requested: true },
     },
     company: {
       name: data.company_name,
       registration_number: data.company_reg_number || undefined,
     },
     email: data.company_email,
     metadata: {
       marketplace_company_id: data.company_id,
       source: 'marketplace',
     },
   });
   ```

4. **Update marketplace_companies with stripe_account_id:**
   ```typescript
   await supabase
     .from('marketplace_companies')
     .update({ stripe_account_id: account.id })
     .eq('id', data.company_id);
   ```

5. **Generate Account Link for onboarding:**
   ```typescript
   const accountLink = await stripe.accountLinks.create({
     account: account.id,
     refresh_url: `${SITE_URL}/marketplace/register/stripe-callback?refresh=true&company_id=${data.company_id}`,
     return_url: `${SITE_URL}/marketplace/register/stripe-callback?complete=true&company_id=${data.company_id}`,
     type: 'account_onboarding',
   });
   ```

6. **Return the onboarding URL:**
   ```typescript
   return new Response(
     JSON.stringify({
       account_id: account.id,
       onboarding_url: accountLink.url,
     }),
     { headers: { 'Content-Type': 'application/json', ...corsHeaders } }
   );
   ```

**IMPORTANT:** Do not alter the function signature, CORS handling, or any existing action implementations. Only add the new case to the action handler.
  </action>
  <verify>
Run `grep "create_company_express_account" supabase/functions/stripe-connect/index.ts` — should match the new action.
Run `grep "business_type.*company" supabase/functions/stripe-connect/index.ts` — should match 'company' type.
Run `grep "create_express_account" supabase/functions/stripe-connect/index.ts` — should match BOTH original individual and new company actions (2+ matches).
Run `grep "marketplace_company_id" supabase/functions/stripe-connect/index.ts` — should match the metadata.
Verify the existing `create_express_account` action is unchanged by checking its function body is intact.
  </verify>
  <done>New 'create_company_express_account' action added to existing stripe-connect Edge Function. Creates Stripe Express accounts with business_type='company', stores stripe_account_id on marketplace_companies, generates Account Link for hosted onboarding. Existing actions (create_express_account, create_payment_intent, create_customer, check_account_status) remain unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Create marketplace Stripe Connect API route and callback page</name>
  <files>web/app/api/marketplace/stripe-connect/route.ts, web/app/marketplace/register/stripe-callback/page.tsx</files>
  <action>
**File 1: `web/app/api/marketplace/stripe-connect/route.ts`**

POST endpoint that proxies to the stripe-connect Edge Function with the `create_company_express_account` action.

Implementation:
1. Authenticate the user via createClient()
2. Get request body: `{ companyId: string }`
3. Fetch marketplace_companies row to get company details (company_name, company_email, company_reg_number)
4. Verify user is the admin_user_id of this company — return 403 if not
5. Invoke the stripe-connect Edge Function:
   ```typescript
   const { data, error } = await supabase.functions.invoke('stripe-connect', {
     body: {
       action: 'create_company_express_account',
       company_id: companyId,
       company_name: company.company_name,
       company_email: company.company_email,
       company_reg_number: company.company_reg_number,
     },
   });
   ```
6. Return the `{ account_id, onboarding_url }` from the Edge Function response
7. Handle errors gracefully — if Edge Function returns error, pass it through

**File 2: `web/app/marketplace/register/stripe-callback/page.tsx`**

Client component that handles the return from Stripe Connect onboarding.

Reads URL params:
- `complete=true` — user completed Stripe onboarding
- `refresh=true` — user needs to restart onboarding (Stripe link expired)
- `company_id=xxx` — the marketplace company ID

**On `complete=true`:**
1. Call the stripe-connect Edge Function with `check_account_status` action to verify the Express account's `charges_enabled` and `payouts_enabled` status
2. If onboarding is truly complete: update marketplace_companies `stripe_onboarding_complete = true`
3. Show success UI: "Stripe Connect onboarding complete! You're all set to receive payouts."
4. Show "Return to Dashboard" button linking to marketplace company dashboard (or registration completion page)

**On `refresh=true`:**
1. Show message: "Your Stripe onboarding link expired. Click below to continue."
2. Show "Resume Onboarding" button that calls `/api/marketplace/stripe-connect` again to get a fresh Account Link
3. Redirect to the new Account Link URL

**Error handling:**
- If company_id is missing: show error
- If user is not the admin of the company: show unauthorized error
- If Stripe account doesn't exist: show error and offer to start onboarding

Use the same clean layout as the registration wizard (no dashboard sidebar — this is a public-facing page). Use `lucide-react` icons (CheckCircle for success, RefreshCw for refresh, AlertCircle for errors).
  </action>
  <verify>
Run `grep "stripe-connect" web/app/api/marketplace/stripe-connect/route.ts` — should match the Edge Function invocation.
Run `grep "create_company_express_account" web/app/api/marketplace/stripe-connect/route.ts` — should match the action.
Run `grep "stripe_onboarding_complete" web/app/marketplace/register/stripe-callback/page.tsx` — should match the completion update.
Run `ls web/app/marketplace/register/stripe-callback/` — should list page.tsx.
Visit http://localhost:30500/marketplace/register/stripe-callback?complete=true&company_id=test — should render callback page (may show error for invalid company, which is expected).
  </verify>
  <done>Marketplace Stripe Connect API route invokes existing Edge Function with new company action. Callback page handles both completion (updates stripe_onboarding_complete) and refresh (generates new Account Link). Company admin can initiate onboarding from registration wizard Step 4 and return to complete it later if needed.</done>
</task>

<task type="auto">
  <name>Task 3: Wire "Start Stripe Onboarding" button into registration wizard Step 4</name>
  <files>web/app/marketplace/register/page.tsx</files>
  <action>
Modify the existing registration wizard page (created by Plan 02) to replace the Step 4 placeholder with a working Stripe Connect onboarding initiation.

**Update Step 4 of the wizard:**

Replace the placeholder message ("Stripe Connect onboarding will be available once your company is verified") with:

1. **Before registration is submitted** (companyId not yet created):
   - Keep the current "Complete Registration" button
   - After successful registration, show the Stripe onboarding option

2. **After registration is submitted** (companyId exists from registration response):
   - Show "Start Stripe Onboarding" button (green, prominent)
   - On click: call `/api/marketplace/stripe-connect` with `{ companyId }` from the registration response
   - On success: `window.location.href = data.onboarding_url` (redirect to Stripe)
   - Show loading state during the API call
   - Show "Skip for now" link that redirects to a success/dashboard page instead
   - Show info text: "You can complete Stripe onboarding later from your company dashboard"

3. **Update the Zustand store usage:**
   - After registration submission, store the `companyId` in component state (or add to Zustand store)
   - The stripeAccountId and stripeOnboardingComplete from the store are updated on callback

Use existing UI components. The "Start Stripe Onboarding" button should use the Stripe brand color or green to stand out.
  </action>
  <verify>
Run `grep "stripe-connect" web/app/marketplace/register/page.tsx` — should match the API call to Stripe Connect.
Run `grep "Start.*Stripe\|Start.*Onboarding\|stripe.*onboarding" web/app/marketplace/register/page.tsx` — should match the button text/label.
Run `grep "onboarding_url" web/app/marketplace/register/page.tsx` — should match the redirect.
  </verify>
  <done>Registration wizard Step 4 now has a working "Start Stripe Onboarding" button that calls the Stripe Connect API, redirects to Stripe's hosted onboarding, with a "Skip for now" option. The onboarding entry point is fully wired into the UI.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stripe Connect Express onboarding for marketplace companies: new Edge Function action (business_type='company'), API route, callback page, and "Start Stripe Onboarding" button wired into the registration wizard Step 4.</what-built>
  <how-to-verify>
    1. Start dev server: `pnpm dev` (port 30500)
    2. Register a marketplace company (complete Steps 1-3 of the registration wizard)
    3. On Step 4, click "Start Stripe Onboarding" (or equivalent button)
    4. Verify you're redirected to Stripe's hosted onboarding page (in test mode, this shows Stripe's test onboarding form)
    5. Complete the Stripe test onboarding
    6. Verify you're redirected back to /marketplace/register/stripe-callback with complete=true
    7. Verify the success message appears and marketplace_companies.stripe_onboarding_complete is updated
    8. Check the Stripe Dashboard -> Connect -> Accounts — verify a new Express account with business_type='company' was created
    9. Verify the existing Stripe Connect actions (create_express_account for individual medics) still work — test by checking an existing medic's Stripe account status
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. stripe-connect Edge Function has BOTH `create_express_account` (individual) and `create_company_express_account` (company) actions
2. Company Express account created with `business_type: 'company'`
3. Account Link URLs correctly point to /marketplace/register/stripe-callback with query params
4. Callback page handles both ?complete=true and ?refresh=true scenarios
5. marketplace_companies.stripe_account_id is set after account creation
6. marketplace_companies.stripe_onboarding_complete is set after successful callback
7. Existing stripe-connect actions remain functional (no regression)
8. Registration wizard Step 4 has a working "Start Stripe Onboarding" button that calls the API and redirects to Stripe
</verification>

<success_criteria>
- Stripe Express account created with business_type='company' in test mode
- Onboarding link redirects to Stripe's hosted flow
- Return callback updates marketplace_companies correctly
- Existing medic Stripe Connect flow unaffected
- Error cases handled gracefully (expired links, unauthorized access, missing company)
</success_criteria>

<output>
After completion, create `.planning/phases/32-foundation-schema-registration/32-04-SUMMARY.md`
</output>
