---
phase: 32-foundation-schema-registration
plan: 03
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - web/app/platform/verification/page.tsx
  - web/app/platform/verification/[id]/page.tsx
  - web/app/api/marketplace/verify/route.ts
  - supabase/functions/cqc-verify/index.ts
  - web/lib/marketplace/admin-actions.ts
autonomous: false

must_haves:
  truths:
    - "Platform admin sees a list of pending/info-requested marketplace company registrations sorted oldest-first"
    - "Platform admin can click a company to see full details: company info, CQC verification status, uploaded documents with signed URL previews"
    - "Platform admin can approve (sets verified + can_submit_quotes=true), reject (with reason), or request more info on a company"
    - "Approved companies get verification_status='verified' and can_submit_quotes=true"
    - "Daily CQC check Edge Function runs for all verified/cqc_verified companies and auto-suspends any whose CQC status is no longer 'Registered'"
    - "Document expiry check identifies expired compliance documents and suspends the company from quoting"
  artifacts:
    - path: "web/app/platform/verification/page.tsx"
      provides: "Admin verification queue listing all pending marketplace companies"
      min_lines: 50
    - path: "web/app/platform/verification/[id]/page.tsx"
      provides: "Admin detail view for a single marketplace company with approve/reject/request-info actions"
      min_lines: 80
    - path: "web/app/api/marketplace/verify/route.ts"
      provides: "POST endpoint for admin approve/reject/request-info actions"
      exports: ["POST"]
    - path: "supabase/functions/cqc-verify/index.ts"
      provides: "Edge Function for daily CQC status checks and document expiry monitoring"
    - path: "web/lib/marketplace/admin-actions.ts"
      provides: "Server-side admin action functions for verification workflow"
      exports: ["approveCompany", "rejectCompany", "requestMoreInfo", "suspendCompany"]
  key_links:
    - from: "web/app/platform/verification/page.tsx"
      to: "marketplace_companies table"
      via: "Supabase select with verification_status filter"
      pattern: "from\\('marketplace_companies'\\)"
    - from: "web/app/api/marketplace/verify/route.ts"
      to: "web/lib/marketplace/admin-actions.ts"
      via: "imports admin action functions"
      pattern: "import.*admin-actions"
    - from: "supabase/functions/cqc-verify/index.ts"
      to: "marketplace_companies table"
      via: "Supabase service-role client update"
      pattern: "from\\('marketplace_companies'\\)"
    - from: "web/app/platform/verification/[id]/page.tsx"
      to: "compliance-documents bucket"
      via: "Signed URLs for document preview"
      pattern: "createSignedUrl"
---

<objective>
Build the admin verification queue, approve/reject/request-info workflow, and automated CQC + document expiry compliance monitoring.

Purpose: Registered companies need admin review before they can quote on events. This plan creates the platform admin interface for reviewing registrations and the automated background checks that ensure ongoing compliance (CQC status and document expiry).

Output: Admin verification queue pages, verify API route, admin action library, CQC daily check Edge Function with document expiry monitoring.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-foundation-schema-registration/32-RESEARCH.md
@.planning/phases/32-foundation-schema-registration/32-CONTEXT.md
@.planning/phases/32-foundation-schema-registration/32-01-SUMMARY.md

# Existing patterns to follow:
@web/app/platform/page.tsx                         # Platform admin dashboard pattern
@web/app/platform/organizations/page.tsx           # Admin list view pattern
@web/app/platform/layout.tsx                       # Platform admin layout
@supabase/functions/cert-expiry-checker/index.ts   # Existing cert expiry Edge Function pattern
@supabase/functions/riddor-deadline-checker/index.ts # Scheduled Edge Function pattern
@web/lib/email/templates.ts                        # Email template pattern for notifications
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin verification queue and detail page</name>
  <files>web/app/platform/verification/page.tsx, web/app/platform/verification/[id]/page.tsx, web/lib/marketplace/admin-actions.ts</files>
  <action>
**File 1: `web/lib/marketplace/admin-actions.ts`**

Server-side admin action functions. All use Supabase service-role client (platform admin has org_id=NULL, so RLS would block direct writes — follow existing pattern from platform admin API routes).

```typescript
// approveCompany(companyId, adminUserId)
// - Sets verification_status='verified', can_submit_quotes=true, verified_at=now(), verified_by=adminUserId
// - Updates all pending compliance_documents for this company to review_status='approved', reviewed_by=adminUserId
// - Sends approval email via Resend (use existing email template pattern)

// rejectCompany(companyId, adminUserId, reason)
// - Sets verification_status='rejected', rejection_reason=reason
// - Sends rejection email with reason

// requestMoreInfo(companyId, adminUserId, notes)
// - Sets verification_status='info_requested'
// - Sends "more info needed" email with the admin's notes

// suspendCompany(companyId, reason)
// - Sets verification_status='suspended', can_submit_quotes=false, suspension_reason=reason, suspended_at=now()
// - Sends suspension email
// - Returns list of active bookings from marketplace for this company (for admin review)
```

Each function:
1. Creates a service-role Supabase client (NOT the request client — use `createServiceRoleClient()` or equivalent pattern from existing codebase)
2. Performs the update
3. Sends the email notification via Resend (follow pattern from `web/lib/email/templates.ts`)
4. Returns `{ success: boolean, error?: string }`

**File 2: `web/app/platform/verification/page.tsx`** (Server Component)

Admin verification queue page. Follow existing platform admin list view patterns from `web/app/platform/organizations/page.tsx`.

Layout:
- Page title: "Marketplace Verification Queue"
- Tab filters: "Pending" (default), "Info Requested", "All" (includes verified, rejected, suspended)
- Table columns: Company Name, CQC Provider ID, CQC Status (green "Auto-verified" badge or yellow "Not verified"), Documents Uploaded (count), Submitted Date, Status badge
- Sort: oldest first (FIFO for fair processing)
- Each row clickable — links to `/platform/verification/{id}`
- Empty state: "No pending verifications" with appropriate icon

Data fetching:
```typescript
const { data: companies } = await supabase
  .from('marketplace_companies')
  .select(`
    id, company_name, company_email, cqc_provider_id,
    cqc_auto_verified, cqc_registration_status,
    verification_status, created_at,
    compliance_documents (count)
  `)
  .in('verification_status', ['pending', 'cqc_verified', 'info_requested'])
  .order('created_at', { ascending: true });
```

Use the platform admin layout (already at `web/app/platform/layout.tsx`). Add a navigation link to "Verification" in the platform admin sidebar if not already present.

**File 3: `web/app/platform/verification/[id]/page.tsx`** (Server Component with Client Actions)

Company verification detail page. Shows:

**Company Information section:**
- Company name, reg number, address, postcode, phone, email
- Coverage areas
- Description
- Linked SiteMedic org (if org_id is set, show link to the org)

**CQC Verification section:**
- CQC Provider ID with link to `https://www.cqc.org.uk/provider/{providerId}`
- Auto-verified status (green badge if cqc_auto_verified=true)
- Registration status from CQC
- Last checked timestamp
- "Re-check CQC" button (calls the CQC verify endpoint again)

**Compliance Documents section:**
- Table: Document Type | File Name | Expiry Date | Certificate Number | Status (pending/approved/rejected) | Actions
- Each document row has a "View" button that generates a short-lived signed URL (1 hour) and opens in a new tab
- Admin can individually approve or reject each document with optional notes
- Show which required document types are missing

**Admin Actions section** (at bottom, prominent):
- Three buttons: "Approve" (green), "Reject" (red), "Request More Info" (yellow/amber)
- "Reject" and "Request More Info" show a textarea for reason/notes before confirming
- "Approve" shows a confirmation dialog: "This will allow {company_name} to submit quotes on the marketplace. Continue?"
- All actions call `/api/marketplace/verify` POST endpoint
- After action: redirect back to verification queue with success toast

Use `sonner` for toasts. Use `lucide-react` icons (CheckCircle, XCircle, AlertTriangle, FileText, ExternalLink, Shield).
  </action>
  <verify>
Run `ls web/app/platform/verification/` — should list page.tsx and [id]/ directory.
Run `ls web/app/platform/verification/\[id\]/` — should list page.tsx.
Run `grep "approveCompany" web/lib/marketplace/admin-actions.ts` — should match the export.
Run `grep "marketplace_companies" web/app/platform/verification/page.tsx` — should match the query.
Run `grep "createSignedUrl" web/app/platform/verification/\[id\]/page.tsx` — should match the signed URL generation.
Visit http://localhost:30500/platform/verification as platform admin — should render the queue.
  </verify>
  <done>Admin verification queue lists pending companies sorted oldest-first with status badges and document counts. Detail page shows full company info, CQC status, compliance documents with signed URL previews, and approve/reject/request-info action buttons. All admin actions update the company status and send email notifications.</done>
</task>

<task type="auto">
  <name>Task 2: Create verify API route and CQC daily check Edge Function</name>
  <files>web/app/api/marketplace/verify/route.ts, supabase/functions/cqc-verify/index.ts</files>
  <action>
**File 1: `web/app/api/marketplace/verify/route.ts`**

POST endpoint for admin verification actions. Accepts:
```typescript
{
  companyId: string;
  action: 'approve' | 'reject' | 'request_info';
  notes?: string;  // required for reject and request_info
}
```

Implementation:
1. Authenticate the user via createClient()
2. Verify the user has platform_admin role (check user.app_metadata.role === 'platform_admin')
3. If not platform admin: return 403
4. Validate input: companyId required, action must be one of the three valid values, notes required for reject/request_info
5. Call the appropriate function from `@/lib/marketplace/admin-actions`:
   - 'approve' -> approveCompany(companyId, user.id)
   - 'reject' -> rejectCompany(companyId, user.id, notes)
   - 'request_info' -> requestMoreInfo(companyId, user.id, notes)
6. Return `{ success: true }` or `{ error: string }` with appropriate status code

**File 2: `supabase/functions/cqc-verify/index.ts`**

Edge Function for daily CQC status checks AND document expiry monitoring. This is designed to be invoked by Supabase cron (pg_cron) or called manually by admin.

Follow the existing Edge Function pattern from `cert-expiry-checker/index.ts` and `riddor-deadline-checker/index.ts`.

Implementation:

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const CQC_BASE_URL = 'https://api.cqc.org.uk/public/v1';
const CQC_PARTNER_CODE = Deno.env.get('CQC_PARTNER_CODE') || 'SiteMedic';

serve(async (req) => {
  // CORS headers (follow existing pattern from other Edge Functions)
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  );

  const results = { cqc_checked: 0, cqc_suspended: 0, docs_expired: 0, docs_expiring_soon: 0 };

  // === PART 1: CQC Status Checks ===
  // Fetch all active marketplace companies (verified or cqc_verified)
  const { data: companies } = await supabase
    .from('marketplace_companies')
    .select('id, cqc_provider_id, company_name, company_email, verification_status')
    .in('verification_status', ['verified', 'cqc_verified']);

  if (companies?.length) {
    for (const company of companies) {
      // Rate limit: 50ms between requests to respect CQC API
      await new Promise(r => setTimeout(r, 50));

      try {
        const res = await fetch(
          `${CQC_BASE_URL}/providers/${company.cqc_provider_id}?partnerCode=${CQC_PARTNER_CODE}`
        );

        if (!res.ok) {
          console.warn(`CQC API error for ${company.cqc_provider_id}: ${res.status}`);
          continue; // Don't suspend on API errors
        }

        const provider = await res.json();
        results.cqc_checked++;

        if (provider.registrationStatus !== 'Registered') {
          // Suspend the company
          await supabase
            .from('marketplace_companies')
            .update({
              verification_status: 'suspended',
              can_submit_quotes: false,
              suspension_reason: `CQC status changed to: ${provider.registrationStatus}`,
              suspended_at: new Date().toISOString(),
              cqc_registration_status: provider.registrationStatus,
              cqc_last_checked_at: new Date().toISOString(),
            })
            .eq('id', company.id);

          // TODO: Send suspension email via Resend (or invoke notification-service Edge Function)
          // TODO: Flag active marketplace bookings for admin review

          results.cqc_suspended++;
        } else {
          // Update last checked timestamp
          await supabase
            .from('marketplace_companies')
            .update({
              cqc_last_checked_at: new Date().toISOString(),
              cqc_registration_status: 'Registered',
            })
            .eq('id', company.id);
        }
      } catch (err) {
        console.error(`CQC check failed for ${company.cqc_provider_id}:`, err);
        // Don't suspend on network errors
      }
    }
  }

  // === PART 2: Document Expiry Checks ===
  // Find approved compliance documents that have expired or are expiring within 30 days
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

  // Find expired documents (expiry_date <= today AND review_status = 'approved')
  const { data: expiredDocs } = await supabase
    .from('compliance_documents')
    .select('id, company_id, document_type, expiry_date')
    .eq('review_status', 'approved')
    .lte('expiry_date', today);

  if (expiredDocs?.length) {
    // Mark expired documents
    for (const doc of expiredDocs) {
      await supabase
        .from('compliance_documents')
        .update({ review_status: 'expired' })
        .eq('id', doc.id);
    }

    // Group by company and suspend companies with expired required documents
    const companyIds = [...new Set(expiredDocs.map(d => d.company_id))];
    for (const companyId of companyIds) {
      const companyExpiredTypes = expiredDocs
        .filter(d => d.company_id === companyId)
        .map(d => d.document_type);

      // Check if any expired doc is a required type
      const requiredTypes = ['public_liability_insurance', 'employers_liability_insurance', 'professional_indemnity_insurance', 'dbs_certificate'];
      const hasExpiredRequired = companyExpiredTypes.some(t => requiredTypes.includes(t));

      if (hasExpiredRequired) {
        await supabase
          .from('marketplace_companies')
          .update({
            verification_status: 'suspended',
            can_submit_quotes: false,
            suspension_reason: `Document expired: ${companyExpiredTypes.join(', ')}`,
            suspended_at: new Date().toISOString(),
          })
          .eq('id', companyId)
          .in('verification_status', ['verified', 'cqc_verified']); // Only suspend currently active

        // TODO: Send expiry notification email
        results.docs_expired++;
      }
    }
  }

  // Find documents expiring within 30 days (for warning emails)
  const thirtyDaysFromNow = new Date();
  thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
  const cutoffDate = thirtyDaysFromNow.toISOString().split('T')[0];

  const { data: expiringDocs } = await supabase
    .from('compliance_documents')
    .select('id, company_id, document_type, expiry_date')
    .eq('review_status', 'approved')
    .gt('expiry_date', today)
    .lte('expiry_date', cutoffDate);

  results.docs_expiring_soon = expiringDocs?.length || 0;
  // TODO: Send warning emails for documents expiring within 30 days

  return new Response(JSON.stringify(results), {
    headers: { 'Content-Type': 'application/json' },
  });
});
```

Make sure the CORS headers variable is defined at the top following the existing Edge Function pattern (check `_shared/` for a shared CORS config).
  </action>
  <verify>
Run `grep "platform_admin" web/app/api/marketplace/verify/route.ts` — should match the admin check.
Run `grep "approve.*reject.*request_info" web/app/api/marketplace/verify/route.ts` — should match action handling.
Run `grep "CQC_BASE_URL" supabase/functions/cqc-verify/index.ts` — should match the CQC API base URL.
Run `grep "docs_expired" supabase/functions/cqc-verify/index.ts` — should match the document expiry check.
Run `grep "PART 1.*PART 2" supabase/functions/cqc-verify/index.ts` — should match both check sections.
  </verify>
  <done>Admin verify endpoint handles approve/reject/request-info with proper platform_admin authorization check. CQC daily check Edge Function verifies all active companies against CQC API (with 50ms rate limiting) and suspends any whose status changed. Document expiry check marks expired documents and suspends companies with expired required documents. Both suspended companies and 30-day warning docs are tracked for notification.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Admin verification queue with company detail view, approve/reject/request-info workflow, and automated CQC + document expiry monitoring Edge Function.</what-built>
  <how-to-verify>
    1. Start dev server: `pnpm dev` (port 30500)
    2. Log in as platform admin
    3. Navigate to http://localhost:30500/platform/verification
    4. Verify the queue shows any pending marketplace companies (create one via the registration wizard first if needed)
    5. Click a company to see the detail view
    6. Verify company info, CQC status, and document list render correctly
    7. Test "Approve" action — confirm the company's verification_status changes to 'verified' and can_submit_quotes becomes true
    8. Test "Reject" action on another company — confirm rejection reason is stored
    9. Verify the CQC daily check Edge Function exists at supabase/functions/cqc-verify/index.ts and has both CQC and document expiry check logic
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Platform admin can access /platform/verification and see pending companies
2. Company detail page shows all info including CQC verification status and compliance documents
3. Signed URLs for document viewing are short-lived (1 hour)
4. Approve action sets verified + can_submit_quotes=true + sends email
5. Reject action stores reason + sends email
6. Request more info sets status + sends email with admin notes
7. CQC daily check Edge Function fetches all active companies from CQC API
8. Document expiry check marks expired docs and suspends companies with expired required documents
9. No RLS bypass — admin actions use service-role client
</verification>

<success_criteria>
- Admin verification queue renders with correct data
- All three admin actions work correctly (approve, reject, request_info)
- CQC Edge Function compiles and handles both CQC checks and document expiry
- Suspended companies have can_submit_quotes=false
- Email notifications sent for all status changes
</success_criteria>

<output>
After completion, create `.planning/phases/32-foundation-schema-registration/32-03-SUMMARY.md`
</output>
