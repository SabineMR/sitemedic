---
phase: 32-foundation-schema-registration
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - web/stores/useMarketplaceRegistrationStore.ts
  - web/app/marketplace/register/page.tsx
  - web/app/marketplace/register/layout.tsx
  - web/app/api/marketplace/register/route.ts
  - web/app/api/marketplace/cqc-verify/route.ts
  - web/app/api/marketplace/upload-document/route.ts
autonomous: false

user_setup:
  - service: CQC API
    why: "CQC provider verification at signup"
    env_vars:
      - name: CQC_PARTNER_CODE
        source: "Register with CQC via syndicationapi@cqc.org.uk (use 'SiteMedic' as default for dev)"

must_haves:
  truths:
    - "A company admin can fill in company details (name, reg number, address, postcode, phone, email, coverage areas, description) in Step 1 of the wizard"
    - "The system instantly verifies the CQC provider ID via API in Step 2 and shows the company name from CQC if valid"
    - "Company admin can upload compliance documents (public liability, employer's liability, professional indemnity, DBS) in Step 3"
    - "After completing the wizard, a marketplace_companies row is created with verification_status='pending' (or 'cqc_verified' if CQC passed)"
    - "An existing SiteMedic org user registering on the marketplace pre-fills company details from their org and links via org_id"
    - "After registration, the company can browse events (can_browse_events=true) but cannot submit quotes (can_submit_quotes=false)"
  artifacts:
    - path: "web/stores/useMarketplaceRegistrationStore.ts"
      provides: "Zustand store managing multi-step wizard state across all 4 steps"
      exports: ["useMarketplaceRegistrationStore"]
    - path: "web/app/marketplace/register/page.tsx"
      provides: "4-step registration wizard UI (company details, CQC verification, document upload, Stripe Connect)"
      min_lines: 100
    - path: "web/app/api/marketplace/register/route.ts"
      provides: "POST endpoint to create marketplace_companies row with documents"
      exports: ["POST"]
    - path: "web/app/api/marketplace/cqc-verify/route.ts"
      provides: "POST endpoint for instant CQC provider verification"
      exports: ["POST"]
    - path: "web/app/api/marketplace/upload-document/route.ts"
      provides: "POST endpoint for uploading compliance documents to storage bucket"
      exports: ["POST"]
  key_links:
    - from: "web/app/marketplace/register/page.tsx"
      to: "web/stores/useMarketplaceRegistrationStore.ts"
      via: "Zustand store hook"
      pattern: "useMarketplaceRegistrationStore"
    - from: "web/app/marketplace/register/page.tsx"
      to: "/api/marketplace/cqc-verify"
      via: "fetch POST from Step 2 CQC verification"
      pattern: "fetch.*api/marketplace/cqc-verify"
    - from: "web/app/api/marketplace/register/route.ts"
      to: "marketplace_companies table"
      via: "Supabase insert"
      pattern: "from\\('marketplace_companies'\\)"
    - from: "web/app/api/marketplace/upload-document/route.ts"
      to: "compliance-documents bucket"
      via: "Supabase Storage upload"
      pattern: "storage\\.from\\('compliance-documents'\\)"
---

<objective>
Build the multi-step company registration wizard and supporting API routes for marketplace companies and lightweight client signup.

Purpose: This is the primary user-facing entry point for the marketplace. CQC-registered medical companies complete a 4-step wizard (company details -> CQC verification -> document upload -> Stripe Connect placeholder) to register. Existing SiteMedic orgs can link their account. Clients get a lightweight marketplace flag.

Output: Registration wizard page, Zustand store, 3 API routes (register, CQC verify, document upload), layout file.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-foundation-schema-registration/32-RESEARCH.md
@.planning/phases/32-foundation-schema-registration/32-CONTEXT.md
@.planning/phases/32-foundation-schema-registration/32-01-SUMMARY.md

# Existing patterns to follow:
@web/stores/useScheduleBoardStore.ts              # Zustand store pattern
@web/app/(auth)/signup/page.tsx                    # Existing multi-step signup pattern
@web/lib/supabase/middleware.ts                    # Auth + subdomain routing
@web/lib/marketplace/types.ts                      # Types from Plan 01
@web/lib/marketplace/cqc-client.ts                 # CQC client from Plan 01
@web/lib/marketplace/compliance.ts                 # Compliance utils from Plan 01
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand registration store and API routes</name>
  <files>web/stores/useMarketplaceRegistrationStore.ts, web/app/api/marketplace/register/route.ts, web/app/api/marketplace/cqc-verify/route.ts, web/app/api/marketplace/upload-document/route.ts</files>
  <action>
**File 1: `web/stores/useMarketplaceRegistrationStore.ts`**

Create a Zustand store following the pattern in `useScheduleBoardStore.ts`. The store manages state for the 4-step registration wizard:

```typescript
import { create } from 'zustand';
import type { RegistrationStep, DocumentType } from '@/lib/marketplace/types';

interface UploadedDocument {
  type: DocumentType;
  fileName: string;
  storagePath: string;
  expiryDate: string | null;
  certificateNumber: string | null;
  staffMemberName: string | null;  // for DBS
}

interface RegistrationState {
  currentStep: RegistrationStep;
  // Step 1: Company details
  companyName: string;
  companyRegNumber: string;
  companyEmail: string;
  companyPhone: string;
  companyAddress: string;
  companyPostcode: string;
  coverageAreas: string[];
  companyDescription: string;
  // Step 2: CQC verification
  cqcProviderId: string;
  cqcVerified: boolean;
  cqcProviderName: string;
  cqcRegistrationStatus: string;
  // Step 3: Document uploads
  uploadedDocuments: UploadedDocument[];
  // Step 4: Stripe Connect (placeholder — actual onboarding in Plan 04)
  stripeAccountId: string | null;
  stripeOnboardingComplete: boolean;
  // Metadata
  existingOrgId: string | null;  // set when existing SiteMedic org registers
  isSubmitting: boolean;
  error: string | null;

  // Actions
  setStep: (step: RegistrationStep) => void;
  updateCompanyDetails: (data: Partial<RegistrationState>) => void;
  setCqcVerification: (providerId: string, verified: boolean, providerName: string, status: string) => void;
  addDocument: (doc: UploadedDocument) => void;
  removeDocument: (storagePath: string) => void;
  setStripeAccount: (accountId: string, complete: boolean) => void;
  setExistingOrg: (orgId: string, orgData: { name: string; email: string; phone?: string; address?: string; postcode?: string }) => void;
  setSubmitting: (submitting: boolean) => void;
  setError: (error: string | null) => void;
  reset: () => void;
}
```

Implement all actions. The `setExistingOrg` action pre-fills company details from an existing org. The `reset` action clears all state back to defaults (currentStep: 'company-details', empty strings, empty arrays, nulls).

**File 2: `web/app/api/marketplace/cqc-verify/route.ts`**

POST endpoint accepting `{ cqcProviderId: string }`. Uses `verifyCQCProvider` from `@/lib/marketplace/cqc-client`. Returns `{ valid, providerName, registrationStatus, error }`. No auth required for this endpoint (the CQC API is public), but rate limit by IP if possible (or just log for now).

**File 3: `web/app/api/marketplace/upload-document/route.ts`**

POST endpoint accepting multipart FormData with fields: `file` (the document), `companyId` (string), `documentType` (DocumentType), `expiryDate` (optional string), `certificateNumber` (optional string), `staffMemberName` (optional string).

Implementation:
1. Authenticate the user via `createClient()` server-side
2. Verify the user is the admin_user_id of the company (query marketplace_companies)
3. Upload file to Supabase Storage: `compliance-documents/{companyId}/{documentType}/{filename}`
4. Create a `compliance_documents` row with the metadata
5. Return `{ success: true, document: { id, storagePath, fileName } }`

Handle errors: file too large (>10MB), invalid MIME type, unauthorized.

**File 4: `web/app/api/marketplace/register/route.ts`**

POST endpoint accepting the full registration payload:
```typescript
{
  companyName: string;
  companyRegNumber?: string;
  companyEmail: string;
  companyPhone?: string;
  companyAddress?: string;
  companyPostcode?: string;
  coverageAreas?: string[];
  companyDescription?: string;
  cqcProviderId: string;
  cqcVerified: boolean;
  cqcProviderName: string;
  cqcRegistrationStatus: string;
  existingOrgId?: string;
}
```

Implementation:
1. Authenticate the user
2. Check if user already has a marketplace_companies entry (prevent duplicates)
3. If `existingOrgId` is provided: verify user belongs to that org (check user.app_metadata.org_id)
4. If `existingOrgId` is NOT provided: create a new `organizations` row with the company details, then set the user's app_metadata.org_id to the new org ID
5. Create `marketplace_companies` row:
   - `org_id` = existingOrgId or newly created org ID
   - `admin_user_id` = authenticated user ID
   - `verification_status` = 'cqc_verified' if CQC passed, 'pending' otherwise
   - `cqc_auto_verified` = cqcVerified
   - `can_browse_events` = true
   - `can_submit_quotes` = false (until admin verifies)
6. Return `{ success: true, companyId: string }`

Use Supabase service-role client for the insert (since the user may not have an existing org_id, RLS might block). Follow the pattern in existing admin API routes that use service-role.
  </action>
  <verify>
Run `grep "useMarketplaceRegistrationStore" web/stores/useMarketplaceRegistrationStore.ts` — should match the export.
Run `grep "verifyCQCProvider" web/app/api/marketplace/cqc-verify/route.ts` — should match the import.
Run `grep "compliance-documents" web/app/api/marketplace/upload-document/route.ts` — should match the storage bucket reference.
Run `grep "marketplace_companies" web/app/api/marketplace/register/route.ts` — should match the insert.
Check all 4 files compile: `npx tsc --noEmit` in the web directory.
  </verify>
  <done>Zustand store manages wizard state with step navigation, pre-fill from existing org, and document tracking. Three API routes handle CQC verification, document upload to private bucket, and company registration with bidirectional crossover (existing org linking or new org creation).</done>
</task>

<task type="auto">
  <name>Task 2: Create registration wizard UI</name>
  <files>web/app/marketplace/register/page.tsx, web/app/marketplace/register/layout.tsx</files>
  <action>
**File 1: `web/app/marketplace/register/layout.tsx`**

Simple layout wrapper for the marketplace registration pages. Should NOT include the main dashboard sidebar/header (this is a public-facing registration flow). Include basic branding (SiteMedic logo), a progress indicator showing the 4 steps, and a clean centered layout. Follow the pattern from `web/app/(auth)/signup/page.tsx` for public-facing layout.

**File 2: `web/app/marketplace/register/page.tsx`**

Create a 4-step registration wizard. This is a client component (`'use client'`) that uses the Zustand store.

**Step 1: Company Details**
- Form fields: Company Name (required), Company Registration Number, Email (required), Phone, Address, Postcode, Coverage Areas (multi-input for postcode prefixes), Description (textarea)
- If user has an existing org (check via API call on mount to see if they have app_metadata.org_id), pre-fill from org data and show a banner: "We've pre-filled your details from your SiteMedic account"
- Manual validation: company name required, email required and valid format
- "Next" button advances to Step 2

**Step 2: CQC Verification**
- Input field for CQC Provider ID (e.g., "1-123456")
- "Verify" button calls `/api/marketplace/cqc-verify` endpoint
- Shows loading spinner during verification
- On success (valid=true): show green checkmark, display provider name from CQC, store cqcVerified=true
- On failure (valid=false): show red error with reason (not found, not Registered, API error). Allow retry.
- "Next" button only enabled when cqcVerified=true
- Help text: "Find your CQC provider ID at cqc.org.uk/provider/[your-id]"

**Step 3: Document Upload**
- Show a list of required document types from REQUIRED_DOCUMENT_TYPES
- For each type: upload button, file name display after upload, expiry date picker, certificate number input
- For DBS certificates: additional "Staff Member Name" field
- Upload via `/api/marketplace/upload-document` endpoint
- Show progress/loading state per document
- Uploaded documents show with green check. Missing documents show as "Required" with yellow indicator.
- "Next" button enabled even if not all docs uploaded (they can be uploaded later, but the company stays in 'pending' status)
- Show info banner: "You can continue without uploading all documents now, but your company won't be verified until all required documents are reviewed"

**Step 4: Review & Submit (placeholder for Stripe Connect)**
- Show summary of all entered data
- Review company details, CQC verification status, uploaded documents count
- "Complete Registration" button calls `/api/marketplace/register` with all data from the store
- On success: redirect to a "Registration Submitted" confirmation page or show a success message
- Show message: "Stripe Connect onboarding will be available once your company is verified"
- After successful submission, call store.reset()

**General UI guidelines:**
- Use existing UI components from the codebase (buttons, inputs, cards — check web/components/ui/ for available shadcn components)
- Use Tailwind CSS following existing patterns
- Use `sonner` for toast notifications on errors and success
- Use `lucide-react` icons for visual indicators (CheckCircle, AlertCircle, Upload, Building2, Shield, etc.)
- Mobile-responsive (but primarily desktop-focused for registration)
- Progress bar at top showing current step (1 of 4, 2 of 4, etc.)
- Back button to return to previous step (except Step 1)
  </action>
  <verify>
Run `ls web/app/marketplace/register/` — should list page.tsx and layout.tsx.
Run `grep "'use client'" web/app/marketplace/register/page.tsx` — should match (client component).
Run `grep "useMarketplaceRegistrationStore" web/app/marketplace/register/page.tsx` — should match the store import.
Run `grep "cqc-verify" web/app/marketplace/register/page.tsx` — should match the API call.
Run `grep "upload-document" web/app/marketplace/register/page.tsx` — should match the upload call.
Manually visit http://localhost:30500/marketplace/register — should render Step 1 form.
  </verify>
  <done>4-step registration wizard renders correctly with step navigation, form validation, CQC verification via API call, document upload with progress tracking, and registration submission. Existing SiteMedic org users see pre-filled data. Progress bar shows current step.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Multi-step marketplace company registration wizard with CQC verification, document upload, and company creation. Includes Zustand store for wizard state, 3 API routes, and responsive wizard UI.</what-built>
  <how-to-verify>
    1. Start dev server: `pnpm dev` (port 30500)
    2. Navigate to http://localhost:30500/marketplace/register
    3. Verify Step 1: Company Details form renders with all fields
    4. Fill in company details and click "Next"
    5. Verify Step 2: Enter a CQC Provider ID and click "Verify" — check the CQC API call works (try "1-101" or similar test ID)
    6. Verify Step 3: Upload a test document — confirm it appears in the list
    7. Verify Step 4: Review summary shows all entered data
    8. Submit the registration and confirm success message appears
    9. Check Supabase: verify marketplace_companies row was created with correct verification_status
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Registration wizard loads at /marketplace/register with 4-step progress indicator
2. Company details form validates required fields (company name, email)
3. CQC verification calls external API and shows result (valid or invalid with reason)
4. Document upload sends files to compliance-documents storage bucket
5. Registration submission creates marketplace_companies row with correct verification_status
6. Existing SiteMedic org users see pre-filled company details
7. Zustand store persists state between step navigation (forward and back)
</verification>

<success_criteria>
- All 4 wizard steps functional with correct validation
- CQC API verification works for valid and invalid provider IDs
- Documents upload to private compliance-documents bucket
- marketplace_companies row created with correct status on submission
- Store state persists across step navigation
- No console errors during the full registration flow
</success_criteria>

<output>
After completion, create `.planning/phases/32-foundation-schema-registration/32-02-SUMMARY.md`
</output>
