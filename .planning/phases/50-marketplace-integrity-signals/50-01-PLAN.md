# 50-01 Plan — Signal Ingestion and Explainable Risk Scoring

## Objective

Detect likely marketplace-to-direct leakage by recording explainable integrity signals and computing event-level risk bands for manual review workflows.

## Requirements Coverage IDs

- `INT-09` — Signal model persists anti-gaming evidence in an auditable format.
- `INT-10` — Marketplace-to-direct migration patterns are ingested and scored.
- `INT-11` — Operator-visible risk output is available via API and dashboard UI.

## Tasks

- [x] **Task 1:** Add signal + score schema
  - Migration: `166_marketplace_integrity_signals.sql`
  - Tables: `marketplace_integrity_signals`, `marketplace_integrity_scores`
  - RLS and indexes included.

- [x] **Task 2:** Build ingestion + scoring service
  - Service: `web/lib/marketplace/integrity/signals.ts`
  - Hooks:
    - direct job create path (`THREAD_NO_CONVERT`, `PROXIMITY_CLONE`, `MARKETPLACE_TO_DIRECT_SWITCH`)
    - pass-on lifecycle path (`PASS_ON_ACTIVITY`)

- [x] **Task 3:** Expose risk visibility
  - APIs:
    - `GET /api/marketplace/integrity/events/[eventId]`
    - `GET /api/platform/marketplace/integrity/events/[eventId]`
  - UI:
    - `IntegrityRiskCard` on direct job detail page.

## Verification Strategy

- Grep schema and wiring checks for signal types and score updates.
- `pnpm --dir web exec tsc --noEmit`
- `pnpm --dir web lint`
- `pnpm --dir web test -- <integrity tests>`

## Risks + Mitigations

- False positives from weak single signals → use weighted confidence and review-first enforcement.
- Hidden write path gaps → emit from both direct creation and pass-on lifecycle transitions.
- Explainability drift → persist signal details and top signal types in score snapshot.
