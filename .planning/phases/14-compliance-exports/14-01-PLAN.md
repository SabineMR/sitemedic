---
phase: 14-compliance-exports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/medic/payslips/page.tsx
autonomous: true

must_haves:
  truths:
    - "Medic clicks Download and PDF opens in <2 seconds when pdf_url exists in DB"
    - "Medic clicks Download and edge function is called when pdf_url is null (older payslips)"
    - "Toast shows success/error feedback for both paths"
  artifacts:
    - path: "web/app/medic/payslips/page.tsx"
      provides: "Payslip list with optimised download (stored URL first, edge function fallback)"
      contains: "payslip:payslips("
  key_links:
    - from: "web/app/medic/payslips/page.tsx"
      to: "supabase.storage payslips bucket"
      via: "pdf_url direct open or edge function fallback"
      pattern: "pdf_url.*window\\.open|functions\\.invoke"
---

<objective>
Fix payslip PDF download to use the stored `pdf_url` from the `payslips` table when available, falling back to the edge function only when `pdf_url` is null (older records pre-migration 032).

Purpose: Success criterion 1 -- "Medic downloads their December 2025 payslip as a PDF in 2 clicks." Current implementation calls the edge function every time (3-5s cold start). With pdf_url check, downloads are instant for payslips that already have a stored URL.

Output: Updated `web/app/medic/payslips/page.tsx` with payslips join and optimised download logic.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-compliance-exports/14-RESEARCH.md
@web/app/medic/payslips/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add payslips table join and optimise download logic</name>
  <files>web/app/medic/payslips/page.tsx</files>
  <action>
  1. Update the `Payslip` interface to include optional payslip fields:
     - Add `payslip_pdf_url: string | null` and `payslip_reference: string | null` to the interface.

  2. Update the `fetchPayslips` Supabase query to join the `payslips` table. The current query selects from `timesheets` with a join to `bookings`. Add a join to `payslips` via `timesheet_id`:
     ```
     payslip:payslips(id, pdf_url, payslip_reference)
     ```
     Use a LEFT join (not `!inner`) because older timesheets may not have a payslip record yet.
     Map the joined data: set `payslip_pdf_url` from `p.payslip?.pdf_url` and `payslip_reference` from `p.payslip?.payslip_reference` when mapping the query result to the Payslip array.

  3. Rewrite the `handleDownload` function with two-path logic:
     - **Path A (fast path):** If `payslip.payslip_pdf_url` is not null, call `window.open(payslip.payslip_pdf_url, '_blank')` directly. Show `toast.success('Payslip opened')`. No edge function call needed.
     - **Path B (fallback):** If `payslip.payslip_pdf_url` is null, call the existing edge function `generate-payslip-pdf` with `{ timesheet_id: payslip.id, medic_id: medicId }`. Handle `data.pdf_url` and `data.pdf_base64` responses exactly as the current code does.
     - Keep the existing error handling with try/catch and `toast.error`.
     - Keep the `setDownloadingId` / `setDownloadingId(null)` loading state wrapper.

  4. Display the payslip reference in the list item if available. In the list row, below the "Paid ..." or "Approved ..." text, add:
     ```
     {p.payslip_reference && (
       <span className="text-gray-500">Ref: {p.payslip_reference}</span>
     )}
     ```

  IMPORTANT: The `payslips` table uses `timesheet_id` as the foreign key linking to `timesheets.id`. The Supabase join syntax is `payslip:payslips(id, pdf_url, payslip_reference)` which auto-detects the FK. If the auto-detect fails, use `payslip:payslips!timesheet_id(id, pdf_url, payslip_reference)`.

  IMPORTANT: Signed URLs on payslips are 365 days (intentional per D-06.5-11-002). Do NOT change this to 7 days.

  IMPORTANT: The payslip join may return `null` (no payslip record) for older timesheets or an object. Guard with `?.` operator.
  </action>
  <verify>
  - `pnpm build` completes without errors
  - Grep the file for `payslip:payslips(` to confirm the join is present (LEFT join, not !inner)
  - Grep the file for `payslip_pdf_url` to confirm the fast-path check exists
  - Grep for `functions.invoke('generate-payslip-pdf'` to confirm the fallback path is preserved
  </verify>
  <done>
  - Payslip download checks `pdf_url` first (instant open) before falling back to edge function
  - Payslip reference number displayed in list when available
  - Build passes with no type errors
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- File contains both fast-path (pdf_url direct) and fallback (edge function) download logic
- Payslips join includes `payslip:payslips(id, pdf_url, payslip_reference)` (LEFT join)
</verification>

<success_criteria>
- Medic with stored pdf_url gets instant PDF open (no edge function call)
- Medic with null pdf_url still gets PDF via edge function (existing behaviour)
- Build passes, no runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-compliance-exports/14-01-SUMMARY.md`
</output>
