---
phase: 14-compliance-exports
plan: 04
type: execute
wave: 2
depends_on: ["14-03"]
files_modified:
  - web/app/medic/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "Medic sees employment status (Self Employed or Umbrella) clearly displayed"
    - "Medic sees CEST assessment result and date when available"
    - "Medic sees CEST PDF download link when cest_pdf_url is available"
    - "IR35 section distinguishes employment_status from cest_assessment_result (two separate fields)"
  artifacts:
    - path: "web/app/medic/profile/page.tsx"
      provides: "Enhanced IR35 section with assessment date and CEST PDF link"
      contains: "cest_assessment_date"
  key_links:
    - from: "web/app/medic/profile/page.tsx"
      to: "medics table"
      via: "select('*') already fetches employment_status, cest_assessment_result, cest_assessment_date, cest_pdf_url"
      pattern: "cest_assessment_date|cest_pdf_url"
---

<objective>
Enhance the IR35 status section on medic profile to show the CEST assessment date and a download link for the CEST PDF when available. The current section shows employment_status and cest_assessment_result but omits the assessment date and PDF.

Purpose: Success criterion 4 -- "IR35 section shows 'Self-employed -- last assessed 2026-01-15'." Current IR35 section shows status fields but not the assessment date. Also adds CEST PDF download link for compliance documentation.

Output: Updated `web/app/medic/profile/page.tsx` IR35 section with assessment date and PDF link.

NOTE: IR35 assessment history (last 3 assessments) is descoped -- only the current assessment is stored in the schema. There is no ir35_history table. This plan shows current assessment only, matching the success criterion exactly.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-compliance-exports/14-RESEARCH.md
@.planning/phases/14-compliance-exports/14-03-SUMMARY.md
@web/app/medic/profile/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance IR35 section with assessment date and CEST PDF link</name>
  <files>web/app/medic/profile/page.tsx</files>
  <action>
  NOTE: Plan 14-03 already added `cest_assessment_date: string | null` to the `MedicData` interface. This plan extends IR35 further.

  1. **Add `cest_pdf_url` to the `MedicData` interface** (if not already added by 14-03):
     ```typescript
     cest_pdf_url: string | null;
     ```

  2. **Import additional icons.** Import `FileDown` and `Calendar` from `lucide-react` if not already imported.

  3. **Rewrite the IR35 Status section** (the card at lines ~165-183 in the original file). Replace the existing IR35 content with an enhanced version:

     ```tsx
     {/* IR35 Status */}
     <div className="bg-gray-800/50 border border-gray-700/50 rounded-2xl p-6">
       <h2 className="text-white font-semibold text-lg mb-4">IR35 Status</h2>
       {medic.employment_status ? (
         <div className="space-y-4">
           {/* Primary status banner */}
           <div className={`flex items-center justify-between p-3 rounded-xl ${
             medic.employment_status === 'self_employed'
               ? 'bg-blue-900/20 border border-blue-700/30'
               : 'bg-purple-900/20 border border-purple-700/30'
           }`}>
             <div>
               <p className="text-white font-semibold capitalize">
                 {medic.employment_status.replace('_', ' ')}
               </p>
               {medic.cest_assessment_date && (
                 <p className="text-gray-400 text-sm flex items-center gap-1 mt-0.5">
                   <Calendar className="w-3 h-3" />
                   Last assessed {format(new Date(medic.cest_assessment_date), 'dd MMM yyyy')}
                 </p>
               )}
             </div>
             {medic.cest_pdf_url && (
               <a
                 href={medic.cest_pdf_url}
                 target="_blank"
                 rel="noopener noreferrer"
                 className="flex items-center gap-1.5 px-3 py-1.5 bg-gray-700/50 hover:bg-gray-600/50 text-gray-300 rounded-lg text-sm transition-all"
               >
                 <FileDown className="w-4 h-4" />
                 CEST PDF
               </a>
             )}
           </div>

           {/* Detail fields */}
           <div className="grid grid-cols-2 gap-4">
             {medic.utr && <InfoRow label="UTR Number" value={medic.utr} />}
             {medic.umbrella_company_name && (
               <InfoRow label="Umbrella Company" value={medic.umbrella_company_name} />
             )}
             {medic.cest_assessment_result && (
               <InfoRow
                 label="CEST Result"
                 value={medic.cest_assessment_result.replace(/_/g, ' ')}
                 capitalize
               />
             )}
             {medic.cest_assessment_date && (
               <InfoRow
                 label="Assessment Date"
                 value={format(new Date(medic.cest_assessment_date), 'dd MMM yyyy')}
               />
             )}
           </div>
         </div>
       ) : (
         <div className="flex items-center gap-2 text-yellow-400 text-sm">
           <XCircle className="w-4 h-4" />
           IR35 status not yet submitted -- contact your administrator
         </div>
       )}
     </div>
     ```

  IMPORTANT: `employment_status` and `cest_assessment_result` are SEPARATE fields. `employment_status` is 'self_employed' | 'umbrella' (always set). `cest_assessment_result` is 'outside_ir35' | 'inside_ir35' | 'unknown' | null. Do NOT conflate them (Research Pitfall 3).

  IMPORTANT: Use `.replace(/_/g, ' ')` (not `.replace('_', ' ')`) to replace ALL underscores, not just the first one. The existing code uses `.replace('_', ' ')` which misses subsequent underscores -- fix this while enhancing.

  IMPORTANT: `format` from `date-fns` should already be imported from plan 14-03. If not, add the import.

  IMPORTANT: The `select('*')` query already returns all these fields. No query change needed.
  </action>
  <verify>
  - `pnpm build` completes without errors
  - Grep for `cest_assessment_date` confirms the date is displayed
  - Grep for `cest_pdf_url` confirms PDF download link exists
  - Grep for `Last assessed` confirms the assessment date label
  - Grep for `CEST PDF` confirms download button text
  </verify>
  <done>
  - IR35 section shows employment status with colored banner (blue for self-employed, purple for umbrella)
  - Assessment date shown as "Last assessed DD MMM YYYY" when available
  - CEST PDF download button shown when cest_pdf_url is available
  - Detail grid shows UTR, umbrella company, CEST result, and assessment date
  - Employment status and CEST result are displayed as separate fields (not conflated)
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- IR35 section displays employment status, assessment date, and CEST PDF link
- All fields use data from existing `select('*')` query -- no new API calls
</verification>

<success_criteria>
- Medic sees "Self Employed -- Last assessed 15 Jan 2026" in IR35 section
- CEST PDF download link appears when cest_pdf_url is not null
- UTR shown for self-employed, umbrella company shown for umbrella workers
- CEST result shown separately from employment status
</success_criteria>

<output>
After completion, create `.planning/phases/14-compliance-exports/14-04-SUMMARY.md`
</output>
