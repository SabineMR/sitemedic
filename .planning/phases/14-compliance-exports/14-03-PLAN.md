---
phase: 14-compliance-exports
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/medic/profile/page.tsx
autonomous: true

must_haves:
  truths:
    - "Medic sees yellow banner when any certification expires within 30 days"
    - "Medic sees red banner when any certification expires within 7 days"
    - "Banner shows cert type, days remaining, and renewal link"
    - "No banner shown when all certs are >30 days from expiry"
    - "Page does not crash when certifications is null or empty"
  artifacts:
    - path: "web/app/medic/profile/page.tsx"
      provides: "Certification expiry banners above personal info section"
      contains: "getExpiringCerts"
  key_links:
    - from: "web/app/medic/profile/page.tsx"
      to: "medics.certifications JSONB"
      via: "select('*') already fetches certifications"
      pattern: "medic\\.certifications"
---

<objective>
Add certification expiry banners to the medic profile page. Show yellow warning banners for certs expiring in 8-30 days and red critical banners for certs expiring in 0-7 days, with renewal links.

Purpose: Success criterion 3 -- "Medic profile shows yellow banner 'CSCS expires in 18 days -- Renew now'." The backend cron sends email reminders but there is no in-app visual alert. Medics who miss emails need to see the alert when they open their profile.

Output: Updated `web/app/medic/profile/page.tsx` with expiry banner UI and cert computation logic.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-compliance-exports/14-RESEARCH.md
@web/app/medic/profile/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add certification expiry banners to medic profile</name>
  <files>web/app/medic/profile/page.tsx</files>
  <action>
  1. **Extend the `MedicData` interface** to include the certifications field:
     ```typescript
     certifications: Array<{ type: string; expiry_date: string; cert_number: string }> | null;
     ```
     Also add `cest_assessment_date: string | null;` (needed by plan 14-04 which modifies this same file next -- adding it now avoids a type conflict).

  2. **Add renewal URLs constant** at the top of the file (outside the component):
     ```typescript
     const RENEWAL_URLS: Record<string, string> = {
       'CSCS': 'https://www.cscs.uk.com/apply-for-card/',
       'CPCS': 'https://www.cpcscards.com/renewal',
       'IPAF': 'https://www.ipaf.org/en/training',
       'PASMA': 'https://www.pasma.co.uk/training',
       'Gas Safe': 'https://www.gassaferegister.co.uk/',
     };
     ```

  3. **Add a helper function** `getExpiringCerts` outside the component:
     ```typescript
     interface CertExpiry {
       type: string;
       expiry_date: string;
       cert_number: string;
       days_remaining: number;
     }

     function getExpiringCerts(certifications: Array<{ type: string; expiry_date: string; cert_number: string }> | null): {
       critical: CertExpiry[];  // 0-7 days
       warning: CertExpiry[];   // 8-30 days
     } {
       const certs = certifications || [];
       const now = new Date();
       const critical: CertExpiry[] = [];
       const warning: CertExpiry[] = [];

       for (const cert of certs) {
         const expiry = new Date(cert.expiry_date);
         const daysLeft = Math.ceil((expiry.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
         if (daysLeft <= 0) {
           critical.push({ ...cert, days_remaining: daysLeft });
         } else if (daysLeft <= 7) {
           critical.push({ ...cert, days_remaining: daysLeft });
         } else if (daysLeft <= 30) {
           warning.push({ ...cert, days_remaining: daysLeft });
         }
       }

       return { critical, warning };
     }
     ```

  4. **Compute expiring certs in the component body** (inside `MedicProfilePage`, after the `if (!medic)` guard):
     ```typescript
     const { critical, warning } = getExpiringCerts(medic.certifications);
     ```

  5. **Add banner UI** between the "Availability Toggle" section and the "Personal Info" section (after the availability toggle div, before the personal info card). Import `AlertTriangle` and `ExternalLink` from `lucide-react`:

     ```tsx
     {/* Certification Expiry Alerts */}
     {critical.length > 0 && (
       <div className="bg-red-900/20 border border-red-700/30 rounded-2xl p-4 space-y-2">
         <div className="flex items-center gap-2 text-red-400 font-semibold">
           <AlertTriangle className="w-5 h-5" />
           Urgent: Certification{critical.length > 1 ? 's' : ''} Expiring
         </div>
         {critical.map((cert) => (
           <div key={cert.cert_number} className="flex items-center justify-between text-sm">
             <span className="text-red-300">
               {cert.type} {cert.days_remaining <= 0
                 ? 'has EXPIRED'
                 : `expires in ${cert.days_remaining} day${cert.days_remaining !== 1 ? 's' : ''}`}
             </span>
             {RENEWAL_URLS[cert.type] && (
               <a
                 href={RENEWAL_URLS[cert.type]}
                 target="_blank"
                 rel="noopener noreferrer"
                 className="flex items-center gap-1 text-red-400 hover:text-red-300 underline text-sm"
               >
                 Renew now <ExternalLink className="w-3 h-3" />
               </a>
             )}
           </div>
         ))}
       </div>
     )}

     {warning.length > 0 && (
       <div className="bg-yellow-900/20 border border-yellow-700/30 rounded-2xl p-4 space-y-2">
         <div className="flex items-center gap-2 text-yellow-400 font-semibold">
           <AlertTriangle className="w-5 h-5" />
           Certification{warning.length > 1 ? 's' : ''} Expiring Soon
         </div>
         {warning.map((cert) => (
           <div key={cert.cert_number} className="flex items-center justify-between text-sm">
             <span className="text-yellow-300">
               {cert.type} expires in {cert.days_remaining} day{cert.days_remaining !== 1 ? 's' : ''}
             </span>
             {RENEWAL_URLS[cert.type] && (
               <a
                 href={RENEWAL_URLS[cert.type]}
                 target="_blank"
                 rel="noopener noreferrer"
                 className="flex items-center gap-1 text-yellow-400 hover:text-yellow-300 underline text-sm"
               >
                 Renew now <ExternalLink className="w-3 h-3" />
               </a>
             )}
           </div>
         ))}
       </div>
     )}
     ```

  6. **Add a Certifications section** below Qualifications (or merge into Qualifications) that shows all current certs with their expiry dates. This provides context even when no banners are showing:

     ```tsx
     {/* Certifications */}
     {(medic.certifications || []).length > 0 && (
       <div className="bg-gray-800/50 border border-gray-700/50 rounded-2xl p-6">
         <h2 className="text-white font-semibold text-lg mb-4">Certifications</h2>
         <div className="space-y-3">
           {(medic.certifications || []).map((cert) => {
             const expiry = new Date(cert.expiry_date);
             const daysLeft = Math.ceil((expiry.getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
             const isExpired = daysLeft <= 0;
             const isWarning = daysLeft > 0 && daysLeft <= 30;
             return (
               <div key={cert.cert_number} className="flex items-center justify-between">
                 <div>
                   <span className="text-white font-medium">{cert.type}</span>
                   <span className="text-gray-500 text-sm ml-2">#{cert.cert_number}</span>
                 </div>
                 <span className={`text-sm ${isExpired ? 'text-red-400' : isWarning ? 'text-yellow-400' : 'text-green-400'}`}>
                   {isExpired ? 'Expired' : `Expires ${format(expiry, 'dd MMM yyyy')}`}
                 </span>
               </div>
             );
           })}
         </div>
       </div>
     )}
     ```

     Import `format` from `date-fns` at the top of the file.

  IMPORTANT: Guard `medic.certifications || []` before any `.map()` or `.length` -- the field can be null for medics without certifications.
  IMPORTANT: The `select('*')` query already fetches `certifications` from the medics table. No query change needed.
  IMPORTANT: Also add `cest_assessment_date` to MedicData interface now to avoid merge conflicts with 14-04. The field is already returned by `select('*')`.
  </action>
  <verify>
  - `pnpm build` completes without errors
  - Grep for `getExpiringCerts` confirms helper function exists
  - Grep for `RENEWAL_URLS` confirms renewal links are present
  - Grep for `AlertTriangle` confirms banner icons are imported
  - Grep for `certifications || \[\]` confirms null guard is present
  </verify>
  <done>
  - Red banners appear for certs expiring in 0-7 days (or already expired)
  - Yellow banners appear for certs expiring in 8-30 days
  - Each banner shows cert type, days remaining, and "Renew now" link
  - Certifications section shows all certs with color-coded expiry dates
  - Page handles null/empty certifications gracefully
  - MedicData interface includes certifications and cest_assessment_date fields
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- Certification banners render based on expiry date proximity
- Renewal URLs point to correct external sites
- No crash on null certifications
</verification>

<success_criteria>
- Medic with CSCS expiring in 18 days sees yellow banner "CSCS expires in 18 days -- Renew now"
- Medic with expired cert sees red banner "[Type] has EXPIRED"
- Medic with no expiring certs sees no banners
- Certifications section lists all certs with expiry dates
</success_criteria>

<output>
After completion, create `.planning/phases/14-compliance-exports/14-03-SUMMARY.md`
</output>
