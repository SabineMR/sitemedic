---
phase: 14-compliance-exports
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/lib/utils/export-pdf.ts
  - web/lib/utils/export-csv.ts
  - web/app/(dashboard)/riddor/page.tsx
  - web/components/admin/timesheet-batch-approval.tsx
  - web/app/admin/bookings/page.tsx
  - web/app/admin/revenue/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin exports RIDDOR incidents as formatted PDF from the RIDDOR page"
    - "Admin exports timesheets as CSV from the timesheets page"
    - "Admin exports bookings as CSV from the bookings page"
    - "Admin exports revenue/invoice data as CSV from the revenue page"
  artifacts:
    - path: "web/lib/utils/export-pdf.ts"
      provides: "exportRIDDORIncidentsPDF function"
      contains: "exportRIDDORIncidentsPDF"
    - path: "web/lib/utils/export-csv.ts"
      provides: "exportTimesheetsCSV, exportBookingsCSV, exportInvoicesCSV functions"
      contains: "exportTimesheetsCSV"
    - path: "web/app/(dashboard)/riddor/page.tsx"
      provides: "Export PDF button in RIDDOR page header"
      contains: "exportRIDDORIncidentsPDF"
    - path: "web/components/admin/timesheet-batch-approval.tsx"
      provides: "Export CSV button in timesheet batch approval"
      contains: "exportTimesheetsCSV"
    - path: "web/app/admin/bookings/page.tsx"
      provides: "Export CSV button in bookings page"
      contains: "exportBookingsCSV"
    - path: "web/app/admin/revenue/page.tsx"
      provides: "Export CSV button in revenue page"
      contains: "exportInvoicesCSV"
  key_links:
    - from: "web/app/(dashboard)/riddor/page.tsx"
      to: "web/lib/utils/export-pdf.ts"
      via: "import and call exportRIDDORIncidentsPDF"
      pattern: "exportRIDDORIncidentsPDF\\(incidents\\)"
    - from: "web/components/admin/timesheet-batch-approval.tsx"
      to: "web/lib/utils/export-csv.ts"
      via: "import and call exportTimesheetsCSV"
      pattern: "exportTimesheetsCSV"
---

<objective>
Add export buttons to four admin/dashboard pages: RIDDOR (PDF), timesheets (CSV), bookings (CSV), and revenue/invoices (CSV). All export functions follow established patterns in export-pdf.ts and export-csv.ts.

Purpose: Success criterion 2 -- "Admin exports all RIDDOR incidents for Q1 2026 as a formatted PDF." Also enables CSV export of timesheets, bookings, and revenue records for accounting and compliance.

Output: 4 new export functions in utility files + 4 export buttons wired into their respective pages.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-compliance-exports/14-RESEARCH.md
@web/lib/utils/export-pdf.ts
@web/lib/utils/export-csv.ts
@web/app/(dashboard)/riddor/page.tsx
@web/components/admin/timesheet-batch-approval.tsx
@web/app/admin/bookings/page.tsx
@web/app/admin/revenue/page.tsx
@web/lib/queries/riddor.ts
@web/lib/queries/admin/timesheets.ts
@web/lib/queries/admin/bookings.ts
@web/lib/queries/admin/revenue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 4 export functions to utility files</name>
  <files>web/lib/utils/export-pdf.ts, web/lib/utils/export-csv.ts</files>
  <action>
  **A. Add `exportRIDDORIncidentsPDF` to `web/lib/utils/export-pdf.ts`:**

  Import the `RIDDORIncident` type from `@/lib/queries/riddor`. Add a new exported function following the exact `exportTreatmentsPDF` pattern:

  - Title: "RIDDOR Incident Report"
  - Subtitle: "SiteMedic" + generated timestamp
  - Table columns: Date (detected_at, dd/MM/yyyy), Worker (workers.first_name + workers.last_name), Injury (treatments.injury_type with `.replace(/-/g, ' ')`), Body Part (treatments.body_part with `.replace(/_/g, ' ')` and fallback ''), Category (category with `.replace(/_/g, ' ')`), Confidence (confidence_level), Status (status), Deadline (deadline_date, dd/MM/yyyy)
  - Column widths: 25, 40, 45, 35, 40, 25, 25, 25
  - Color-code confidence column: HIGH = red [239,68,68], MEDIUM = amber [245,158,11], LOW = gray [156,163,175]
  - Use same headStyles, bodyStyles, alternateRowStyles as `exportTreatmentsPDF`
  - Footer with page numbers matching existing pattern
  - Filename: `riddor-incidents-${format(new Date(), 'yyyy-MM-dd')}.pdf`

  **B. Add `exportTimesheetsCSV` to `web/lib/utils/export-csv.ts`:**

  Import `TimesheetWithDetails` from `@/lib/queries/admin/timesheets`. Add:

  ```typescript
  export function exportTimesheetsCSV(timesheets: TimesheetWithDetails[]) {
    const csvData = timesheets.map((t) => ({
      'Date': t.booking?.shift_date ? format(new Date(t.booking.shift_date), 'dd/MM/yyyy') : '',
      'Medic': t.medic ? `${t.medic.first_name} ${t.medic.last_name}` : 'Unknown',
      'Client': t.booking?.client?.company_name || '',
      'Site': t.booking?.site_name || '',
      'Scheduled Hours': t.scheduled_hours,
      'Logged Hours': t.logged_hours,
      'Payout Amount': `Â£${t.payout_amount.toFixed(2)}`,
      'Status': t.payout_status,
      'Paid At': t.paid_at ? format(new Date(t.paid_at), 'dd/MM/yyyy HH:mm') : '',
    }));
    // ... same blob/download pattern as exportTreatmentsCSV
  }
  ```
  Filename: `timesheets-export-${format(new Date(), 'yyyy-MM-dd')}.csv`

  **C. Add `exportBookingsCSV` to `web/lib/utils/export-csv.ts`:**

  Accept `bookings: any[]` (the bookings from `useBookings()` hook which returns `BookingWithRelations[]`). Import is not strictly needed since the shape is used inline. Columns:
  - Date (shift_date, dd/MM/yyyy), Client (clients?.company_name || ''), Site (site_name), Address (site_address), Start (shift_start_time), End (shift_end_time), Medic (medics ? first+last : 'Unassigned'), Total (formatted GBP), Platform Fee (formatted GBP), Medic Payout (formatted GBP), Status
  Filename: `bookings-export-${format(new Date(), 'yyyy-MM-dd')}.csv`

  **D. Add `exportInvoicesCSV` to `web/lib/utils/export-csv.ts`:**

  This exports completed booking revenue records (there is no invoices table -- revenue page uses bookings data). Accept `bookings: any[]` (the raw bookings from the revenue query). Columns:
  - Date (shift_date, dd/MM/yyyy), Client (clients name from join or ''), Site Postcode (site_postcode), Total (GBP), Platform Fee (GBP), Medic Payout (GBP), Status
  Filename: `invoice-history-${format(new Date(), 'yyyy-MM-dd')}.csv`

  IMPORTANT: All CSV functions MUST use `jsonToCSV` from `react-papaparse` and include the BOM prefix `'\uFEFF'`. Never build CSV strings manually.
  IMPORTANT: All dates in UK format (dd/MM/yyyy) per D-04-05-001.
  IMPORTANT: Export what the user sees (filtered data), not all data.
  </action>
  <verify>
  - `pnpm build` passes
  - Grep `export-pdf.ts` for `exportRIDDORIncidentsPDF` confirms function exists
  - Grep `export-csv.ts` for `exportTimesheetsCSV`, `exportBookingsCSV`, `exportInvoicesCSV` confirms all 3 exist
  </verify>
  <done>
  - 4 new export functions added following established patterns
  - All use proper libraries (jsPDF/autoTable for PDF, jsonToCSV for CSV)
  - UK date format throughout
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire export buttons into 4 pages</name>
  <files>web/app/(dashboard)/riddor/page.tsx, web/components/admin/timesheet-batch-approval.tsx, web/app/admin/bookings/page.tsx, web/app/admin/revenue/page.tsx</files>
  <action>
  **A. RIDDOR page (`web/app/(dashboard)/riddor/page.tsx`):**

  This is a client component (already has `'use client'`). Import `exportRIDDORIncidentsPDF` from `@/lib/utils/export-pdf` and `Download` from `lucide-react`. Add an export button next to the status filter in the card header (line ~95, inside the `<div className="flex items-center justify-between">`):

  ```tsx
  <div className="flex items-center gap-3">
    <Button
      variant="outline"
      size="sm"
      onClick={() => exportRIDDORIncidentsPDF(incidents)}
      disabled={incidents.length === 0}
    >
      <Download className="mr-2 h-4 w-4" />
      Export PDF
    </Button>
    <Select ...existing filter...>
  ```

  Also import `Button` from `@/components/ui/button` and `Download` from `lucide-react`.

  **B. Timesheet batch approval (`web/components/admin/timesheet-batch-approval.tsx`):**

  This is a client component. Import `exportTimesheetsCSV` from `@/lib/utils/export-csv`. Before adding the export button, first READ the file `web/components/admin/timesheet-batch-approval.tsx` to identify the local state variable that holds the timesheets array currently rendered by the table. It is likely named `timesheets`, `data`, `filteredData`, or `initialData`. Use that exact variable name in the `exportTimesheetsCSV()` call below.

  Add an export button in the component header area. Find the section where the payout summary / action buttons are rendered and add:

  ```tsx
  <Button
    variant="outline"
    size="sm"
    onClick={() => exportTimesheetsCSV(VARIABLE_NAME_FROM_FILE)}
    disabled={!VARIABLE_NAME_FROM_FILE || VARIABLE_NAME_FROM_FILE.length === 0}
  >
    <Download className="mr-2 h-4 w-4" />
    Export CSV
  </Button>
  ```

  Where `VARIABLE_NAME_FROM_FILE` is replaced with the actual variable name discovered by reading the file. Import `Download` from `lucide-react` (may already be imported as `FileText` is there).

  **C. Bookings page (`web/app/admin/bookings/page.tsx`):**

  This is a client component. Import `exportBookingsCSV` from `@/lib/utils/export-csv` and `Download` from `lucide-react`. Add an export button in the header next to the "New Booking" link:

  ```tsx
  <button
    onClick={() => exportBookingsCSV(bookings)}
    disabled={bookings.length === 0}
    className="px-4 py-2.5 bg-gray-700/50 hover:bg-gray-600/50 text-gray-300 rounded-xl text-sm font-medium transition-all flex items-center gap-2 disabled:opacity-50"
  >
    <Download className="w-4 h-4" />
    Export CSV
  </button>
  ```

  Place it before the "New Booking" link in the header flex container.

  **D. Revenue page (`web/app/admin/revenue/page.tsx`):**

  This is a client component. Import `exportInvoicesCSV` from `@/lib/utils/export-csv` and `Download` from `lucide-react`. The revenue data comes from `useRevenue(timeRange)` which returns `data` of type `RevenueData`. The raw bookings are not directly exposed by the hook -- the hook aggregates them.

  To export invoice/booking data, add a dedicated fetch-and-export function or expose the bookings. The simplest approach: add an export button that fetches bookings directly when clicked:

  Before writing the handler, first READ `web/app/admin/revenue/page.tsx` to check for an existing `orgId` variable or org context import. Look for patterns like `const { org } = useRequireOrg()`, `const orgId = ...`, or similar. If found, use the existing variable. If not found, import the org context hook (check the codebase for the correct import path -- likely `@/contexts/org-context` or `@/hooks/useRequireOrg`) and extract `org.id`.

  ```tsx
  async function handleExportInvoices() {
    const supabase = createClient();
    const startDate = getDateRange(timeRange);
    const { data: bookings } = await supabase
      .from('bookings')
      .select('id, shift_date, site_postcode, total, medic_payout, platform_fee, status, clients:client_id(company_name), medics:medic_id(first_name, last_name)')
      .eq('org_id', orgId)
      .eq('status', 'completed')
      .gte('shift_date', startDate.toISOString())
      .order('shift_date', { ascending: false });
    if (bookings) exportInvoicesCSV(bookings);
  }
  ```

  Import `createClient` from `@/lib/supabase/client`. For `getDateRange`, it is not exported from revenue.ts. Inline the logic:
  ```typescript
  const weeksMap = { last_4_weeks: 28, last_12_weeks: 84, last_52_weeks: 364 };
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - weeksMap[timeRange]);
  ```

  Place the export button in the header area, next to the time range selector:

  ```tsx
  <button
    onClick={handleExportInvoices}
    className="px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 text-gray-300 rounded-lg text-sm font-medium transition-all flex items-center gap-2"
  >
    <Download className="w-4 h-4" />
    Export CSV
  </button>
  ```

  IMPORTANT: All 4 pages are client components. All browser APIs (URL.createObjectURL, document.createElement) work fine. No server component issues.
  IMPORTANT: Export the filtered/visible data, not all data (per D-04-05-002).
  </action>
  <verify>
  - `pnpm build` passes
  - Grep `riddor/page.tsx` for `exportRIDDORIncidentsPDF` confirms wiring
  - Grep `timesheet-batch-approval.tsx` for `exportTimesheetsCSV` confirms wiring
  - Grep `bookings/page.tsx` for `exportBookingsCSV` confirms wiring
  - Grep `revenue/page.tsx` for `exportInvoicesCSV` confirms wiring
  </verify>
  <done>
  - RIDDOR page has "Export PDF" button that downloads a formatted incident report
  - Timesheets page has "Export CSV" button
  - Bookings page has "Export CSV" button
  - Revenue page has "Export CSV" button for invoice/booking data
  - All exports use filtered/visible data
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- All 4 export functions exist in utility files
- All 4 pages have visible export buttons
- Export functions follow existing patterns (jsPDF for PDF, jsonToCSV for CSV)
</verification>

<success_criteria>
- Admin can export RIDDOR incidents as formatted PDF
- Admin can export timesheets, bookings, and revenue as CSV files
- All exports respect current filters (export what you see)
- UK date format in all exports
</success_criteria>

<output>
After completion, create `.planning/phases/14-compliance-exports/14-02-SUMMARY.md`
</output>
