---
phase: 14-compliance-exports
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - web/components/contracts/contract-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Version history PDF download links work (no 404)"
    - "Status timeline shows human-readable event descriptions (not raw JSON)"
    - "Amendment trail events show status transitions with from/to labels"
    - "Payment schedule shows milestone progress with visual indicators"
    - "Contract header PDF download link works"
    - "Version history rows display version status labels (e.g. draft, amended, signed)"
  artifacts:
    - path: "web/components/contracts/contract-detail.tsx"
      provides: "Fixed PDF downloads, readable event trail, milestone tracker, version status labels"
      contains: "createSignedUrl"
  key_links:
    - from: "web/components/contracts/contract-detail.tsx"
      to: "supabase.storage contracts bucket"
      via: "createSignedUrl for version PDF downloads"
      pattern: "createSignedUrl.*604800"
    - from: "web/components/contracts/contract-detail.tsx"
      to: "contract.events"
      via: "formatEventDescription renders human-readable event data"
      pattern: "formatEventDescription"
---

<objective>
Fix contract detail page: repair dead PDF download links, make the status timeline human-readable (not raw JSON), ensure version status labels are displayed, and enhance the payment schedule into a visual milestone tracker.

Purpose: Success criterion 5 -- "Contract detail shows 3 versions: v1 (draft), v2 (amended), v3 (signed)." Current version history shows versions but download links 404 (API route `/api/contracts/[id]/pdf` does not exist). Status timeline dumps raw JSON. Payment schedule exists but lacks milestone progress indicators. Version status labels may not be prominently displayed.

Output: Updated `web/components/contracts/contract-detail.tsx` with working downloads, readable timeline, version status labels, and milestone tracker.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-compliance-exports/14-RESEARCH.md
@web/components/contracts/contract-detail.tsx
@web/lib/contracts/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PDF download links with client-side signed URLs and add version status labels</name>
  <files>web/components/contracts/contract-detail.tsx</files>
  <action>
  The component is already a client component ('use client'). Import `createClient` from `@/lib/supabase/client`.

  0. **Confirm property names before using them.** Before replacing the header download button, grep `web/lib/contracts/types.ts` for `currentVersion` or `current_version` to confirm the exact property name used on the Contract type. Use the confirmed name (e.g., `contract.currentVersion` or `contract.current_version`) in the replacement code below. Also check if `ContractVersion` has a `status` field by grepping for `status` in the types file. If the version type does NOT have a `status` field, look for an alternative like `version_status` or derive it from the version data.

  1. **Add a download handler function** inside the `ContractDetail` component:

     ```typescript
     const [downloadingVersion, setDownloadingVersion] = React.useState<number | null>(null);

     async function handleDownloadPDF(storagePath: string, version: number) {
       setDownloadingVersion(version);
       try {
         const supabase = createClient();
         const { data, error } = await supabase.storage
           .from('contracts')
           .createSignedUrl(storagePath, 604800); // 7 days per D-05-02-001

         if (error || !data?.signedUrl) {
           console.error('Failed to generate download URL:', error);
           return;
         }
         window.open(data.signedUrl, '_blank');
       } catch (err) {
         console.error('Download error:', err);
       }
       setDownloadingVersion(null);
     }
     ```

  2. **Fix the header "Download PDF" button** (lines ~327-334). Replace the `<a href={pdfUrl} download>` pattern with a button that calls the handler. Use the confirmed property name from step 0:

     Replace:
     ```tsx
     {pdfUrl && (
       <Button variant="outline" asChild>
         <a href={pdfUrl} download>
           <Download className="mr-2 h-4 w-4" />
           Download PDF
         </a>
       </Button>
     )}
     ```

     With (using confirmed property name):
     ```tsx
     {contract.CONFIRMED_PROP?.storage_path && (
       <Button
         variant="outline"
         onClick={() => handleDownloadPDF(
           contract.CONFIRMED_PROP!.storage_path,
           contract.CONFIRMED_PROP!.version
         )}
         disabled={downloadingVersion === contract.CONFIRMED_PROP?.version}
       >
         <Download className="mr-2 h-4 w-4" />
         {downloadingVersion === contract.CONFIRMED_PROP?.version ? 'Loading...' : 'Download PDF'}
       </Button>
     )}
     ```

     Remove the `pdfUrl` constant (line ~108-110) as it is no longer needed.

  3. **Fix version history download links** (lines ~425-437). Replace the `<a href>` with a button that calls the handler:

     Replace:
     ```tsx
     <Button variant="link" size="sm" className="h-auto p-0 mt-1" asChild>
       <a href={`/api/contracts/${contract.id}/pdf?version=${version.version}`} download>
         Download
       </a>
     </Button>
     ```

     With:
     ```tsx
     {version.storage_path && (
       <Button
         variant="link"
         size="sm"
         className="h-auto p-0 mt-1"
         onClick={() => handleDownloadPDF(version.storage_path, version.version)}
         disabled={downloadingVersion === version.version}
       >
         <Download className="mr-1 h-3 w-3" />
         {downloadingVersion === version.version ? 'Loading...' : 'Download'}
       </Button>
     )}
     ```

  4. **Ensure version status labels are displayed.** In the version history card where each version row is rendered, confirm that `version.status` (or the equivalent field from step 0) is displayed as a visible label/badge. If it is NOT already rendered, add a status badge next to each version number:

     ```tsx
     <Badge variant={
       version.status === 'signed' ? 'default' :
       version.status === 'draft' ? 'secondary' :
       version.status === 'amended' ? 'outline' : 'secondary'
     }>
       {version.status}
     </Badge>
     ```

     Import `Badge` from `@/components/ui/badge` if needed. The badge should appear on each version row so that the user can see "v1 draft", "v2 amended", "v3 signed" at a glance.

  IMPORTANT: Use 604800 seconds (7 days) for contract signed URL expiry, per D-05-02-001.
  IMPORTANT: The storage_path is already on the ContractVersion type (see types.ts line 104). No type changes needed.
  IMPORTANT: Guard with `version.storage_path` check -- versions without a generated PDF (e.g., draft amendments) may have null storage_path.
  </action>
  <verify>
  - Grep for `createSignedUrl` confirms signed URL generation is in place
  - Grep for `/api/contracts` confirms the dead route reference is removed
  - Grep for `604800` confirms 7-day expiry
  - Grep for `version.status` or a Badge rendering the version status to confirm status labels are visible in version history rows
  - `pnpm build` passes
  </verify>
  <done>
  - Header "Download PDF" button generates a signed URL and opens it
  - Version history download buttons generate signed URLs (no 404s)
  - Loading state shown while signed URL is being generated
  - Dead `/api/contracts/[id]/pdf` route references are removed
  - Each version row in version history displays a visible status label (e.g. draft, amended, signed)
  </done>
</task>

<task type="auto">
  <name>Task 2: Make status timeline human-readable and enhance milestone tracker</name>
  <files>web/components/contracts/contract-detail.tsx</files>
  <action>
  1. **Add a `formatEventDescription` helper** outside the component:

     ```typescript
     function formatEventDescription(
       eventType: string,
       eventData: Record<string, unknown>
     ): string {
       switch (eventType) {
         case 'status_change': {
           const from = String(eventData.from || '').replace(/_/g, ' ');
           const to = String(eventData.to || '').replace(/_/g, ' ');
           const reason = eventData.reason ? ` -- ${eventData.reason}` : '';
           return `Status changed from ${from} to ${to}${reason}`;
         }
         case 'email_sent': {
           const to = eventData.to || 'client';
           return `Email sent to ${to}`;
         }
         case 'email_opened':
           return 'Client opened the email';
         case 'email_clicked':
           return 'Client clicked the contract link';
         case 'signature_captured': {
           const name = eventData.signedByName || 'Client';
           return `Signed by ${name}`;
         }
         case 'payment_captured': {
           const amount = typeof eventData.amount === 'number'
             ? new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(eventData.amount / 100)
             : '';
           return `Payment received${amount ? ': ' + amount : ''}`;
         }
         case 'version_created':
           return 'New version created';
         case 'amendment_created':
           return 'Amendment created';
         case 'terminated':
           return 'Contract terminated';
         default:
           return eventType.replace(/_/g, ' ');
       }
     }
     ```

  2. **Update the Status Timeline rendering** (lines ~369-388). Replace the raw JSON dump with the formatted description:

     Replace:
     ```tsx
     <div className="text-sm font-medium">
       {event.event_type.replace(/_/g, ' ').toUpperCase()}
     </div>
     <div className="text-xs text-muted-foreground">
       {formatDateTime(event.created_at)}
     </div>
     {event.event_data && (
       <div className="text-xs text-muted-foreground mt-1">
         {JSON.stringify(event.event_data)}
       </div>
     )}
     ```

     With:
     ```tsx
     <div className="text-sm font-medium capitalize">
       {event.event_type.replace(/_/g, ' ')}
     </div>
     <div className="text-xs text-muted-foreground">
       {formatDateTime(event.created_at)}
     </div>
     <div className="text-xs text-muted-foreground mt-1">
       {formatEventDescription(event.event_type, event.event_data || {})}
     </div>
     {event.actor_id && (
       <div className="text-xs text-muted-foreground mt-0.5 italic">
         by Admin
       </div>
     )}
     ```

     Note: Actor names require a users join which is out of scope. Display "by Admin" for non-null actor_id and omit for system events (null actor_id). This is the pragmatic approach recommended in Research.

  3. **Enhance the Payment Schedule into a milestone tracker.** Add step numbers and a visual progress bar. Replace the Payment Schedule card content (lines ~228-310):

     First, compute milestone status above the JSX:
     ```typescript
     const milestones = [
       ...(contract.upfront_amount > 0 ? [{
         label: 'Upfront Payment',
         description: 'Due before service',
         amount: contract.upfront_amount,
         paid: !!contract.upfront_paid_at,
         paidAt: contract.upfront_paid_at,
       }] : []),
       ...(contract.completion_amount > 0 ? [{
         label: 'Completion Payment',
         description: 'Due on completion',
         amount: contract.completion_amount,
         paid: !!contract.completion_paid_at,
         paidAt: contract.completion_paid_at,
       }] : []),
       ...(contract.net30_amount > 0 ? [{
         label: 'Net 30 Payment',
         description: 'Due 30 days after completion',
         amount: contract.net30_amount,
         paid: !!contract.net30_paid_at,
         paidAt: contract.net30_paid_at,
       }] : []),
     ];
     const paidCount = milestones.filter((m) => m.paid).length;
     const progressPercent = milestones.length > 0 ? Math.round((paidCount / milestones.length) * 100) : 0;
     ```

     Replace the Payment Schedule CardContent with:
     ```tsx
     <CardContent>
       {/* Progress bar */}
       {milestones.length > 0 && (
         <div className="mb-4">
           <div className="flex items-center justify-between text-sm mb-1">
             <span className="text-muted-foreground">Payment Progress</span>
             <span className="font-medium">{paidCount}/{milestones.length} milestones</span>
           </div>
           <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
             <div
               className="bg-green-500 h-2 rounded-full transition-all"
               style={{ width: `${progressPercent}%` }}
             />
           </div>
         </div>
       )}

       {/* Milestone list */}
       <div className="space-y-3">
         {milestones.map((milestone, index) => (
           <div key={index} className="flex items-center justify-between border-b pb-3 last:border-0">
             <div className="flex items-center gap-3">
               <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                 milestone.paid
                   ? 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400'
                   : 'bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400'
               }`}>
                 {milestone.paid ? <CheckCircle className="h-4 w-4" /> : index + 1}
               </div>
               <div>
                 <div className="font-medium">{milestone.label}</div>
                 <div className="text-sm text-muted-foreground">
                   {milestone.description}
                 </div>
               </div>
             </div>
             <div className="text-right">
               <div className="font-bold">{formatGBP(milestone.amount)}</div>
               {milestone.paid ? (
                 <div className="text-sm text-green-600 flex items-center gap-1">
                   <CheckCircle className="h-3 w-3" />
                   Paid{milestone.paidAt ? ` ${formatDate(milestone.paidAt)}` : ''}
                 </div>
               ) : (
                 <div className="text-sm text-amber-600 flex items-center gap-1">
                   <XCircle className="h-3 w-3" />
                   Unpaid
                 </div>
               )}
             </div>
           </div>
         ))}
       </div>
     </CardContent>
     ```

  IMPORTANT: `formatGBP` divides by 100 (amounts are in pence). Keep existing formatGBP function.
  IMPORTANT: Actor_id is a UUID. Displaying "by Admin" for non-null and omitting for null is the pragmatic approach. A full user lookup would require schema changes or an additional query.
  </action>
  <verify>
  - `pnpm build` passes
  - Grep for `formatEventDescription` confirms helper exists
  - Grep for `JSON.stringify` in contract-detail.tsx should return 0 results (raw JSON removed)
  - Grep for `Payment Progress` confirms milestone progress bar exists
  - Grep for `milestones.length` confirms milestone computation
  </verify>
  <done>
  - Status timeline shows human-readable descriptions instead of raw JSON
  - Status change events show "Status changed from draft to sent"
  - Signature events show "Signed by [name]"
  - Payment events show amount in GBP
  - Payment schedule shows milestone progress bar with X/Y milestones
  - Each milestone has a step number (or checkmark if paid), label, amount, and status
  </done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- No dead `/api/contracts/[id]/pdf` route references remain
- Version downloads use client-side signed URLs (7-day expiry)
- Version status labels (draft, amended, signed) are visible on each version row
- Status timeline is human-readable (no raw JSON)
- Payment schedule shows visual milestone progress
</verification>

<success_criteria>
- Clicking "Download" on any contract version opens the PDF (no 404)
- Each version row shows its status label (e.g. v1 draft, v2 amended, v3 signed)
- Status timeline shows readable event descriptions with timestamps
- Payment progress bar shows X/Y milestones with green fill
- Each payment milestone shows step number, label, amount, and paid/unpaid status
</success_criteria>

<output>
After completion, create `.planning/phases/14-compliance-exports/14-05-SUMMARY.md`
</output>
