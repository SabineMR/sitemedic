---
phase: 25-billing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/.env.local
  - web/.env.example
autonomous: false
user_setup:
  - service: stripe
    why: "Billing subscription products and prices for three tiers"
    env_vars:
      - name: STRIPE_PRICE_STARTER
        source: "Stripe Dashboard -> Products -> SiteMedic Starter -> copy all 6 Price IDs (comma-separated)"
      - name: STRIPE_PRICE_GROWTH
        source: "Stripe Dashboard -> Products -> SiteMedic Growth -> copy all 6 Price IDs (comma-separated)"
      - name: STRIPE_PRICE_ENTERPRISE
        source: "Stripe Dashboard -> Products -> SiteMedic Enterprise -> copy all 6 Price IDs (comma-separated)"
      - name: STRIPE_BILLING_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> billing-webhooks endpoint -> Signing secret"
    dashboard_config:
      - task: "Create 3 Products (SiteMedic Starter, SiteMedic Growth, SiteMedic Enterprise) with 6 Prices each (GBP/EUR/USD x monthly/annual)"
        location: "Stripe Dashboard -> Products -> Add product (test mode)"
      - task: "Register billing webhook endpoint at /api/stripe/billing-webhooks"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"
      - task: "Enable Stripe Tax with UK VAT registration"
        location: "Stripe Dashboard -> Settings -> Tax"

must_haves:
  truths:
    - "Three Stripe Products exist in test mode with correct names and pricing"
    - "Each Product has 6 Prices: GBP/EUR/USD x monthly/annual"
    - "STRIPE_BILLING_WEBHOOK_SECRET is a distinct env var from STRIPE_WEBHOOK_SECRET"
    - "All 18 Price IDs are captured in env vars"
  artifacts:
    - path: "web/.env.example"
      provides: "Template showing all required billing env vars"
      contains: "STRIPE_BILLING_WEBHOOK_SECRET"
  key_links:
    - from: "web/.env.local"
      to: "Stripe Dashboard Products"
      via: "Price IDs stored as comma-separated env vars"
      pattern: "STRIPE_PRICE_STARTER"
---

<objective>
Create three Stripe Products (Starter, Growth, Enterprise) with 18 Prices total (3 currencies x 2 intervals x 3 tiers) in the Stripe Dashboard test mode. Register the billing webhook endpoint. Capture all Price IDs and the billing webhook signing secret as env vars.

Purpose: Stripe Products and Prices must exist before any checkout session can be created (Phase 29). The billing webhook endpoint must be registered before any subscription event can be received. This is the prerequisite plumbing for all subscription billing.

Output: Updated .env.example with billing env var template. User completes Stripe Dashboard setup and populates .env.local with real values.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-billing-infrastructure/25-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add billing env vars to .env.example template</name>
  <files>web/.env.example</files>
  <action>
Add the following billing-specific environment variables to web/.env.example (append to end, under a new "# Stripe Billing (Phase 25)" section):

```
# Stripe Billing (Phase 25)
# Price IDs: comma-separated, 6 per tier (GBP-mo, GBP-yr, EUR-mo, EUR-yr, USD-mo, USD-yr)
STRIPE_PRICE_STARTER=
STRIPE_PRICE_GROWTH=
STRIPE_PRICE_ENTERPRISE=
# Billing webhook signing secret (SEPARATE from Connect STRIPE_WEBHOOK_SECRET)
STRIPE_BILLING_WEBHOOK_SECRET=
```

Do NOT modify any existing env vars. Only append.
  </action>
  <verify>Read web/.env.example and confirm all 4 new env vars are present: STRIPE_PRICE_STARTER, STRIPE_PRICE_GROWTH, STRIPE_PRICE_ENTERPRISE, STRIPE_BILLING_WEBHOOK_SECRET</verify>
  <done>.env.example contains all 4 billing env var placeholders with clear comments explaining the comma-separated Price ID format and the distinction from Connect webhook secret</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Create Stripe Products, Prices, and register billing webhook</name>
  <action>The user must complete the following steps in the Stripe Dashboard (test mode):</action>
  <instructions>
**Step 1: Enable Stripe Tax (one-time)**
1. Go to Stripe Dashboard -> Settings -> Tax
2. Add your UK VAT registration
3. Enable automatic tax calculation

**Step 2: Create 3 Products with 18 Prices**

For each product below, go to Stripe Dashboard -> Products -> Add product:

**Product 1: SiteMedic Starter**
- Tax code: txcd_10103001 (SaaS)
- Create 6 recurring Prices (all tax_behavior: exclusive):
  - GBP 149/month
  - GBP 1,490/year (= 149 x 10, "2 months free")
  - EUR 179/month
  - EUR 1,790/year (= 179 x 10)
  - USD 189/month
  - USD 1,890/year (= 189 x 10)

**Product 2: SiteMedic Growth**
- Tax code: txcd_10103001
- Create 6 recurring Prices:
  - GBP 299/month
  - GBP 2,990/year
  - EUR 349/month
  - EUR 3,490/year
  - USD 379/month
  - USD 3,790/year

**Product 3: SiteMedic Enterprise**
- Tax code: txcd_10103001
- Create 6 recurring Prices:
  - GBP 599/month
  - GBP 5,990/year
  - EUR 699/month
  - EUR 6,990/year
  - USD 749/month
  - USD 7,490/year

**Step 3: Copy Price IDs**
After creating all Prices, copy each Price ID (price_xxx) and populate web/.env.local:
```
STRIPE_PRICE_STARTER=price_xxx,price_xxx,price_xxx,price_xxx,price_xxx,price_xxx
STRIPE_PRICE_GROWTH=price_xxx,price_xxx,price_xxx,price_xxx,price_xxx,price_xxx
STRIPE_PRICE_ENTERPRISE=price_xxx,price_xxx,price_xxx,price_xxx,price_xxx,price_xxx
```
Order: GBP-mo, GBP-yr, EUR-mo, EUR-yr, USD-mo, USD-yr

**Step 4: Register billing webhook endpoint**
1. Go to Stripe Dashboard -> Developers -> Webhooks -> Add endpoint
2. Endpoint URL: `https://your-domain.vercel.app/api/stripe/billing-webhooks`
   (For local dev: use `stripe listen --forward-to localhost:30500/api/stripe/billing-webhooks`)
3. Select events: checkout.session.completed, customer.subscription.created, customer.subscription.updated, customer.subscription.deleted, invoice.paid, invoice.payment_failed
4. Copy the signing secret and add to web/.env.local:
```
STRIPE_BILLING_WEBHOOK_SECRET=whsec_xxx
```

**Step 5: Verify**
Confirm that STRIPE_BILLING_WEBHOOK_SECRET in .env.local is DIFFERENT from STRIPE_WEBHOOK_SECRET.
  </instructions>
  <resume-signal>Type "done" when all Products, Prices, and webhook endpoint are created and env vars populated in .env.local</resume-signal>
</task>

</tasks>

<verification>
1. web/.env.example contains STRIPE_PRICE_STARTER, STRIPE_PRICE_GROWTH, STRIPE_PRICE_ENTERPRISE, STRIPE_BILLING_WEBHOOK_SECRET
2. web/.env.local contains real Price IDs (price_xxx format) for all 3 tiers
3. web/.env.local contains STRIPE_BILLING_WEBHOOK_SECRET (whsec_xxx format)
4. STRIPE_BILLING_WEBHOOK_SECRET != STRIPE_WEBHOOK_SECRET
</verification>

<success_criteria>
- 3 Stripe Products exist in test mode with correct names
- 18 Stripe Prices exist (3 tiers x 3 currencies x 2 intervals) with correct amounts
- Billing webhook endpoint registered in Stripe Dashboard with 6 event types
- All Price IDs captured in STRIPE_PRICE_STARTER, STRIPE_PRICE_GROWTH, STRIPE_PRICE_ENTERPRISE env vars
- STRIPE_BILLING_WEBHOOK_SECRET populated and distinct from STRIPE_WEBHOOK_SECRET
</success_criteria>

<output>
After completion, create `.planning/phases/25-billing-infrastructure/25-01-SUMMARY.md`
</output>
