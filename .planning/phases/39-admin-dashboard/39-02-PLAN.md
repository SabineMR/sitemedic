---
phase: 39-admin-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - supabase/migrations/162_marketplace_admin_moderation.sql
  - web/app/api/platform/marketplace/entities/route.ts
  - web/app/api/platform/marketplace/moderation/route.ts
  - web/lib/queries/platform/marketplace-entities.ts
  - web/app/platform/marketplace/entities/page.tsx
  - web/components/platform/marketplace/EntityModerationPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Platform admin can view and manage marketplace events, quotes, awards, and disputes from one workspace"
    - "Platform admin can suspend or ban marketplace users with mandatory reason capture"
    - "All moderation actions are persisted in an immutable audit trail"
    - "Entity list API uses server-side filtering and pagination"
  artifacts:
    - path: "supabase/migrations/162_marketplace_admin_moderation.sql"
      provides: "Moderation audit table + helper policies/functions"
      contains: "CREATE TABLE marketplace_user_moderation_audit"
    - path: "web/app/api/platform/marketplace/entities/route.ts"
      provides: "Unified entity listing endpoint"
      exports: ["GET"]
    - path: "web/app/api/platform/marketplace/moderation/route.ts"
      provides: "Suspend/ban/reinstate endpoint"
      exports: ["POST"]
  key_links:
    - from: "web/app/platform/marketplace/entities/page.tsx"
      to: "web/app/api/platform/marketplace/entities/route.ts"
      via: "fetch with tab/filter/query params"
      pattern: "api/platform/marketplace/entities"
    - from: "web/app/api/platform/marketplace/moderation/route.ts"
      to: "marketplace_user_moderation_audit"
      via: "INSERT audit row per action"
      pattern: "marketplace_user_moderation_audit"
---

<objective>
Deliver ADMIN-02 and ADMIN-04 by shipping a unified entity operations workspace and auditable moderation controls.

Purpose: Platform admins need one place to triage marketplace operations (entities + users) and enforce safety/quality policies quickly.

Output: moderation migration, entities API, moderation API, data hooks, and `/platform/marketplace/entities` UI.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-admin-dashboard/39-CONTEXT.md
@.planning/phases/39-admin-dashboard/39-RESEARCH.md
@.planning/phases/39-admin-dashboard/39-01-SUMMARY.md

# Existing moderation-related references:
@web/lib/marketplace/admin-actions.ts
@web/app/platform/users/page.tsx
@web/app/platform/disputes/page.tsx
@supabase/migrations/139_site_manager_is_active.sql
@supabase/migrations/154_marketplace_disputes.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 162 for moderation auditability</name>
  <files>supabase/migrations/162_marketplace_admin_moderation.sql</files>
  <action>
Create `162_marketplace_admin_moderation.sql` with:
- Table `marketplace_user_moderation_audit` fields:
  - id UUID PK
  - target_user_id UUID NOT NULL
  - target_role TEXT
  - action TEXT CHECK ('suspend','ban','reinstate')
  - reason TEXT NOT NULL
  - metadata JSONB default '{}'
  - performed_by UUID NOT NULL
  - performed_at TIMESTAMPTZ default now()
- Indexes on target_user_id and performed_at desc.
- RLS enabled with platform-admin-only read/insert policies.
- Optional helper SQL function to write moderation event if it reduces API complexity.

Do not alter historical rows and do not directly disable auth users in migration.
  </action>
  <verify>
- `grep -n "marketplace_user_moderation_audit" supabase/migrations/162_marketplace_admin_moderation.sql`
- `grep -n "action" supabase/migrations/162_marketplace_admin_moderation.sql`
- `grep -n "CREATE POLICY" supabase/migrations/162_marketplace_admin_moderation.sql`
  </verify>
  <done>
Moderation actions now have a durable audit backbone.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build entity management + moderation APIs and UI</name>
  <files>
    web/app/api/platform/marketplace/entities/route.ts
    web/app/api/platform/marketplace/moderation/route.ts
    web/lib/queries/platform/marketplace-entities.ts
    web/app/platform/marketplace/entities/page.tsx
    web/components/platform/marketplace/EntityModerationPanel.tsx
  </files>
  <action>
Create `/api/platform/marketplace/entities` GET:
- Platform-admin auth guard
- Query params: `entity` (events|quotes|awards|disputes|users), `status`, `search`, `page`, `limit`
- Service-role reads with pagination and total count
- Return normalized shape for table rendering

Create `/api/platform/marketplace/moderation` POST:
- Platform-admin auth guard
- Body: `{ targetUserId, action, reason, context? }`
- Enforce `reason` min length
- Apply moderation side effects:
  - set `profiles.is_active=false` on suspend/ban, true on reinstate
  - set company quote permissions off when target maps to a marketplace company admin
- Insert audit row in `marketplace_user_moderation_audit`

Create UI route `/platform/marketplace/entities`:
- Tabbed entity view for events/quotes/awards/disputes/users
- Search + status filter + pagination controls
- Detail panel with moderation action buttons for user rows
- Reuse existing badge and table patterns from platform pages
  </action>
  <verify>
- `grep -n "entity" web/app/api/platform/marketplace/entities/route.ts`
- `grep -n "marketplace_user_moderation_audit" web/app/api/platform/marketplace/moderation/route.ts`
- `grep -n "suspend\|ban\|reinstate" web/components/platform/marketplace/EntityModerationPanel.tsx`
  </verify>
  <done>
Platform admins can search and manage all key marketplace entities, then enforce user moderation with full audit history.
  </done>
</task>

</tasks>

<verification>
1. Entity page can filter/switch across all required ADMIN-02 entities.
2. Suspend/ban/reinstate updates user/company behavior and records an audit row.
3. Moderation endpoint is blocked for non-platform-admin users.
4. Pagination works for large entity tables.
</verification>

<success_criteria>
- ADMIN-02 and ADMIN-04 are functionally complete.
- Every moderation action is attributable and reviewable.
- No client-side full dataset loading for entity tables.
</success_criteria>

<output>
After completion, create `.planning/phases/39-admin-dashboard/39-02-SUMMARY.md`
</output>
