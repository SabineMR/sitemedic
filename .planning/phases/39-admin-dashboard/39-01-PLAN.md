---
phase: 39-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/161_marketplace_admin_metrics.sql
  - web/app/api/platform/marketplace/metrics/route.ts
  - web/lib/queries/platform/marketplace-metrics.ts
  - web/app/platform/marketplace/page.tsx
  - web/app/platform/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Platform admin can see marketplace metrics: total events, total quotes, conversion rate, total marketplace revenue"
    - "Metrics can be filtered by date window (7d, 30d, 90d, all)"
    - "Metrics data path is platform-admin-only and does not rely on org_id context"
    - "Dashboard renders quickly with server-side aggregation (no client-side full-table scans)"
  artifacts:
    - path: "supabase/migrations/161_marketplace_admin_metrics.sql"
      provides: "Metrics SQL function/view(s) for platform dashboard"
      contains: "CREATE OR REPLACE FUNCTION get_marketplace_admin_metrics"
    - path: "web/app/api/platform/marketplace/metrics/route.ts"
      provides: "Platform admin metrics endpoint with date-range support"
      exports: ["GET"]
    - path: "web/app/platform/marketplace/page.tsx"
      provides: "Marketplace admin metrics dashboard UI"
      contains: "Marketplace Dashboard"
  key_links:
    - from: "web/app/platform/marketplace/page.tsx"
      to: "web/app/api/platform/marketplace/metrics/route.ts"
      via: "fetch('/api/platform/marketplace/metrics?...')"
      pattern: "api/platform/marketplace/metrics"
    - from: "web/app/api/platform/marketplace/metrics/route.ts"
      to: "get_marketplace_admin_metrics"
      via: "Supabase RPC call"
      pattern: "rpc\('get_marketplace_admin_metrics'"
---

<objective>
Deliver ADMIN-01 by building the platform-marketplace metrics foundation and dashboard.

Purpose: Gives platform admins a single trusted view of marketplace health and revenue so they can monitor launch quality and spot problems quickly.

Output: migration 161 metrics function(s), metrics API route, React Query hook, dashboard page, and a sidebar nav entry.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-admin-dashboard/39-CONTEXT.md
@.planning/phases/39-admin-dashboard/39-RESEARCH.md

# Existing platform patterns:
@web/app/platform/layout.tsx
@web/app/platform/page.tsx
@web/app/api/platform/users/route.ts
@supabase/migrations/110_platform_metrics_functions.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 161 for marketplace admin metrics</name>
  <files>supabase/migrations/161_marketplace_admin_metrics.sql</files>
  <action>
Create `161_marketplace_admin_metrics.sql` with:
- SQL function `get_marketplace_admin_metrics(window_days INT DEFAULT 30)` returning one row with:
  - total_events_posted
  - total_quotes_submitted (status in submitted/revised/awarded/rejected)
  - awarded_events_count
  - conversion_rate_percent
  - marketplace_revenue_gbp
  - open_disputes_count
- Optional helper view for date-bounded event/quote aggregates if useful.
- Platform admin safety: function should be `SECURITY DEFINER` and only executable by authenticated platform-admin API path.
- `GRANT EXECUTE` only where consistent with existing platform metrics pattern.
- Add indexes only if query plans require them and they are missing.

Important: do not backfill or mutate production data, only schema/function definitions.
  </action>
  <verify>
Run SQL grep checks:
- Function exists: `grep -n "get_marketplace_admin_metrics" supabase/migrations/161_marketplace_admin_metrics.sql`
- Revenue field appears: `grep -n "marketplace_revenue" supabase/migrations/161_marketplace_admin_metrics.sql`
- Conversion formula appears: `grep -n "conversion_rate" supabase/migrations/161_marketplace_admin_metrics.sql`
  </verify>
  <done>
Migration 161 provides a reusable marketplace metrics function that can serve dashboard cards in a single call.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build platform marketplace metrics API + dashboard UI</name>
  <files>
    web/app/api/platform/marketplace/metrics/route.ts
    web/lib/queries/platform/marketplace-metrics.ts
    web/app/platform/marketplace/page.tsx
    web/app/platform/layout.tsx
  </files>
  <action>
Create `GET /api/platform/marketplace/metrics`:
- Auth check via server client + enforce `user.app_metadata.role === 'platform_admin'`
- Accept `window` query param: `7 | 30 | 90 | all` (map `all` to NULL/no window)
- Use service-role client for RPC call to `get_marketplace_admin_metrics`
- Return normalized JSON payload for UI cards

Create React Query hook `useMarketplaceAdminMetrics(window)` in `web/lib/queries/platform/marketplace-metrics.ts`.

Create `/platform/marketplace/page.tsx`:
- Header + window selector
- Metric cards for ADMIN-01 values
- Lightweight supporting table/list (e.g., top-level health snippets)
- Loading/error/empty states matching existing platform style

Update platform sidebar (`web/app/platform/layout.tsx`) to include `Marketplace` nav item linking to `/platform/marketplace`.
  </action>
  <verify>
- `grep -n "api/platform/marketplace/metrics" web/app/platform/marketplace/page.tsx`
- `grep -n "get_marketplace_admin_metrics" web/app/api/platform/marketplace/metrics/route.ts`
- `grep -n "Marketplace" web/app/platform/layout.tsx`
  </verify>
  <done>
Platform admins can open `/platform/marketplace` and see trusted marketplace metrics with date-window filtering.
  </done>
</task>

</tasks>

<verification>
1. Metrics endpoint returns all required ADMIN-01 fields in one response.
2. Date-window filter changes values correctly.
3. Non-platform users receive 403 on metrics endpoint.
4. `/platform/marketplace` is reachable from platform sidebar and renders without runtime errors.
</verification>

<success_criteria>
- ADMIN-01 fully satisfied with production-grade metrics plumbing.
- Metrics render in under ~1 second on typical local dataset.
- No org-bound RLS assumptions break platform-admin access.
</success_criteria>

<output>
After completion, create `.planning/phases/39-admin-dashboard/39-01-SUMMARY.md`
</output>
