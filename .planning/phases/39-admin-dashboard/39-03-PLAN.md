---
phase: 39-admin-dashboard
plan: 03
type: execute
wave: 3
depends_on: ["39-01", "39-02"]
files_modified:
  - supabase/migrations/163_marketplace_admin_settings.sql
  - web/app/api/platform/marketplace/settings/route.ts
  - web/lib/marketplace/admin-settings.ts
  - web/app/platform/marketplace/settings/page.tsx
  - web/lib/marketplace/award-calculations.ts
  - web/stores/useEventPostingStore.ts
autonomous: true

must_haves:
  truths:
    - "Platform admin can configure default commission rate"
    - "Platform admin can configure default deposit percentage"
    - "Platform admin can configure default quote deadline behavior"
    - "Settings are persisted centrally and changes are audit logged"
    - "Marketplace flows consume configured defaults instead of hardcoded values"
  artifacts:
    - path: "supabase/migrations/163_marketplace_admin_settings.sql"
      provides: "Config + audit tables with platform-admin RLS"
      contains: "CREATE TABLE marketplace_admin_settings"
    - path: "web/app/api/platform/marketplace/settings/route.ts"
      provides: "GET/PUT settings management endpoint"
      exports: ["GET", "PUT"]
    - path: "web/lib/marketplace/admin-settings.ts"
      provides: "Typed server utility for reading marketplace admin settings"
      exports: ["getMarketplaceAdminSettings"]
  key_links:
    - from: "web/app/platform/marketplace/settings/page.tsx"
      to: "web/app/api/platform/marketplace/settings/route.ts"
      via: "fetch GET/PUT"
      pattern: "api/platform/marketplace/settings"
    - from: "web/lib/marketplace/award-calculations.ts"
      to: "web/lib/marketplace/admin-settings.ts"
      via: "default deposit/commission fallback path"
      pattern: "getMarketplaceAdminSettings"
---

<objective>
Deliver ADMIN-03 by making marketplace commission/deposit/deadline defaults platform-configurable and wired into runtime logic.

Purpose: Removes hardcoded business constants and lets platform owners tune marketplace economics safely with full audit traceability.

Output: settings migration, settings API, settings UI, and integration into key marketplace runtime paths.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-admin-dashboard/39-CONTEXT.md
@.planning/phases/39-admin-dashboard/39-RESEARCH.md
@.planning/phases/39-admin-dashboard/39-01-SUMMARY.md
@.planning/phases/39-admin-dashboard/39-02-SUMMARY.md

# Existing defaults currently hardcoded:
@web/lib/marketplace/award-calculations.ts
@web/lib/marketplace/award-schemas.ts
@web/stores/useEventPostingStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 163 for marketplace admin settings + audit</name>
  <files>supabase/migrations/163_marketplace_admin_settings.sql</files>
  <action>
Create `163_marketplace_admin_settings.sql` with:
- `marketplace_admin_settings` singleton-style table columns:
  - id UUID PK
  - default_commission_percent NUMERIC(5,2) NOT NULL
  - default_deposit_percent INT NOT NULL
  - default_quote_deadline_hours INT NOT NULL
  - updated_by UUID
  - updated_at TIMESTAMPTZ
  - created_at TIMESTAMPTZ
- CHECK constraints:
  - commission between 0 and 100
  - deposit between 1 and 100
  - deadline hours between 1 and 720
- Seed one default row matching current behavior.
- `marketplace_admin_settings_audit` table capturing before/after values, actor, reason, timestamp.
- RLS: platform-admin read/write on settings and audit tables.
  </action>
  <verify>
- `grep -n "CREATE TABLE marketplace_admin_settings" supabase/migrations/163_marketplace_admin_settings.sql`
- `grep -n "marketplace_admin_settings_audit" supabase/migrations/163_marketplace_admin_settings.sql`
- `grep -n "CHECK" supabase/migrations/163_marketplace_admin_settings.sql`
  </verify>
  <done>
Marketplace defaults are centralized with validation and auditability.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build settings API/UI and wire defaults into runtime marketplace flows</name>
  <files>
    web/app/api/platform/marketplace/settings/route.ts
    web/lib/marketplace/admin-settings.ts
    web/app/platform/marketplace/settings/page.tsx
    web/lib/marketplace/award-calculations.ts
    web/stores/useEventPostingStore.ts
  </files>
  <action>
Create `/api/platform/marketplace/settings`:
- GET: platform-admin-only, returns current settings row
- PUT: validates payload, requires change reason, updates settings row, writes audit entry

Create `web/lib/marketplace/admin-settings.ts`:
- `getMarketplaceAdminSettings()` typed helper
- Safe fallback to current hardcoded defaults when settings unavailable

Create `/platform/marketplace/settings/page.tsx`:
- Form fields for commission, deposit, quote-deadline default
- Save action with optimistic UI and confirmation toast
- Recent changes panel from audit table

Integrate settings into runtime:
- Update award/deposit logic in `award-calculations.ts` to consume configured defaults where applicable.
- Update event posting default quote deadline in `useEventPostingStore.ts` (or server-side event creation fallback) to use configured hours.
  </action>
  <verify>
- `grep -n "GET\|PUT" web/app/api/platform/marketplace/settings/route.ts`
- `grep -n "getMarketplaceAdminSettings" web/lib/marketplace/award-calculations.ts`
- `grep -n "default_quote_deadline_hours" web/app/platform/marketplace/settings/page.tsx`
  </verify>
  <done>
Platform admins can tune marketplace economics/defaults from UI, and marketplace runtime reads these values consistently.
  </done>
</task>

</tasks>

<verification>
1. Settings page loads existing values and saves validated updates.
2. Invalid values (out-of-range) are rejected by API and DB constraints.
3. Every settings update creates an audit row with actor + reason.
4. Updated defaults are reflected in award/event flows without redeploy.
</verification>

<success_criteria>
- ADMIN-03 complete with secure, auditable configuration management.
- Hardcoded business defaults replaced by settings-backed reads in key paths.
</success_criteria>

<output>
After completion, create `.planning/phases/39-admin-dashboard/39-03-SUMMARY.md`
</output>
