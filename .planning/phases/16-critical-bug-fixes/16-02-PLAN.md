---
plan: 02
phase: 16-critical-bug-fixes
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/(dashboard)/riddor/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin opens a draft RIDDOR incident and sees a category dropdown and override reason textarea"
    - "Changing category or override reason triggers the existing 30-second auto-save timer"
    - "The Draft Review card is hidden when incident status is not 'draft'"
  artifacts:
    - path: "web/app/(dashboard)/riddor/[id]/page.tsx"
      provides: "RIDDOR detail page with draft editing inputs"
      contains: "setDraftCategory"
      contains_2: "setDraftOverrideReason"
  key_links:
    - from: "web/app/(dashboard)/riddor/[id]/page.tsx select onChange"
      to: "setDraftCategory state setter"
      via: "onChange handler"
      pattern: "setDraftCategory\\(e\\.target\\.value\\)"
    - from: "web/app/(dashboard)/riddor/[id]/page.tsx textarea onChange"
      to: "setDraftOverrideReason state setter"
      via: "onChange handler"
      pattern: "setDraftOverrideReason\\(e\\.target\\.value\\)"
---

# Plan 16-02: RIDDOR detail draft edit inputs

## Objective

Add a "Draft Review" card to the RIDDOR detail page with a category `<select>` dropdown and an override reason `<textarea>`, both wired to the existing state setters so the 30-second auto-save timer actually persists user changes.

Purpose: The page already has `draftCategory`/`setDraftCategory` and `draftOverrideReason`/`setDraftOverrideReason` state, plus a 30-second auto-save timer watching those values. But zero inputs are bound to the setters — the state is initialized once from the database and never changes. This makes draft editing impossible.

Output: One modified source file with a new Card section visible only for draft incidents.

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md

The RIDDOR detail page (`web/app/(dashboard)/riddor/[id]/page.tsx`) already has:
- `draftCategory` / `setDraftCategory` state (line 37)
- `draftOverrideReason` / `setDraftOverrideReason` state (line 38)
- `hasInitialized` ref to prevent auto-save on initial load (line 42)
- 30-second debounced auto-save `useEffect` watching `[draftCategory, draftOverrideReason]` (lines 68-91)
- Save-on-unmount `useEffect` (lines 94-109)
- `Card`, `CardHeader`, `CardContent`, `CardTitle`, `CardDescription` already imported (line 24)

The only missing piece: UI inputs that call `setDraftCategory` and `setDraftOverrideReason`.

**RIDDOR categories** (UK RIDDOR 2013 reporting categories):
- `over_7_day_incapacitation`
- `specified_injury`
- `dangerous_occurrence`
- `occupational_disease`
- `gas_incident`

## Tasks

<task id="1" title="Add Draft Review card with category select and override reason textarea">

## Objective
Insert a "Draft Review" Card between the "Incident Details" card (ends at line 273) and the "Treatment Information" card (starts at line 276). The card renders only when `incident.status === 'draft'` and contains a category dropdown and override reason textarea wired to the existing state setters.

## Files
- `web/app/(dashboard)/riddor/[id]/page.tsx` — insert new JSX block after line 273 (after Incident Details `</Card>`)

## Implementation

After the closing `</Card>` of the "Incident Details" card (line 273) and before the `{/* Treatment Information */}` comment (line 275), insert the following JSX block:

```tsx
        {/* Draft Review — editable fields for draft incidents */}
        {incident.status === 'draft' && (
          <Card className="md:col-span-2 border-amber-300/50">
            <CardHeader>
              <CardTitle>Draft Review</CardTitle>
              <CardDescription>
                Edit category and override reason before submitting. Changes auto-save every 30 seconds.
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <label htmlFor="draft-category" className="block text-sm font-medium text-muted-foreground mb-1">
                  RIDDOR Category
                </label>
                <select
                  id="draft-category"
                  value={draftCategory}
                  onChange={(e) => setDraftCategory(e.target.value)}
                  className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                >
                  <option value="">Select category...</option>
                  <option value="over_7_day_incapacitation">Over 7 Day Incapacitation</option>
                  <option value="specified_injury">Specified Injury</option>
                  <option value="dangerous_occurrence">Dangerous Occurrence</option>
                  <option value="occupational_disease">Occupational Disease</option>
                  <option value="gas_incident">Gas Incident</option>
                </select>
              </div>
              <div>
                <label htmlFor="draft-override-reason" className="block text-sm font-medium text-muted-foreground mb-1">
                  Override Reason
                </label>
                <textarea
                  id="draft-override-reason"
                  value={draftOverrideReason}
                  onChange={(e) => setDraftOverrideReason(e.target.value)}
                  rows={4}
                  placeholder="Explain why this incident requires RIDDOR reporting or why the auto-flagged category should be changed..."
                  className="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-y"
                />
              </div>
            </CardContent>
          </Card>
        )}
```

**Key details:**
- `md:col-span-2` makes it span both columns in the grid, matching "Treatment Information" and other full-width cards.
- `border-amber-300/50` gives a subtle amber border to indicate this is a draft-editable area (similar to the existing Deadline Alert card).
- Uses shadcn/ui CSS variable classes (`border-input`, `bg-background`, `ring-ring`, `text-muted-foreground`) to match the existing dark/light theme.
- `htmlFor` + `id` attributes for accessibility.
- The `<select>` and `<textarea>` are standard HTML elements styled with Tailwind, matching the existing page pattern (no shadcn/ui Select component needed since the page uses native HTML for simplicity).
- Changing either input updates state, which triggers the existing `useEffect` on lines 68-91 to schedule a 30-second auto-save via `updateRIDDORDraft`.

**Do NOT:**
- Add any new imports (Card, CardHeader, etc. are already imported).
- Modify the existing state declarations, useEffect hooks, or auto-save logic.
- Add new state variables.

## Verification
1. `grep -n "setDraftCategory" web/app/\\(dashboard\\)/riddor/\\[id\\]/page.tsx` returns matches for both the state declaration AND the select onChange handler.
2. `grep -n "setDraftOverrideReason" web/app/\\(dashboard\\)/riddor/\\[id\\]/page.tsx` returns matches for both the state declaration AND the textarea onChange handler.
3. `grep -n "Draft Review" web/app/\\(dashboard\\)/riddor/\\[id\\]/page.tsx` returns a match (card title exists).
4. `grep -n "incident.status === 'draft'" web/app/\\(dashboard\\)/riddor/\\[id\\]/page.tsx` returns a match (conditional render guard exists).
5. `pnpm build` completes without errors.

## Done
- Draft RIDDOR incidents show a "Draft Review" card with a category dropdown (5 RIDDOR categories) and an override reason textarea.
- Changing either field triggers the existing 30-second auto-save timer.
- Non-draft incidents do not show the card.

</task>

## Verification

```bash
# 1. Both setters are wired to inputs
grep -c "setDraftCategory" "web/app/(dashboard)/riddor/[id]/page.tsx"
# Expected: 2 (state declaration + onChange)

grep -c "setDraftOverrideReason" "web/app/(dashboard)/riddor/[id]/page.tsx"
# Expected: 2 (state declaration + onChange)

# 2. Draft Review card exists
grep "Draft Review" "web/app/(dashboard)/riddor/[id]/page.tsx"
# Expected: 1 match

# 3. Conditional on draft status
grep "incident.status === 'draft'" "web/app/(dashboard)/riddor/[id]/page.tsx"
# Expected: at least 2 matches (existing auto-save guard + new card guard)

# 4. Build succeeds
pnpm build
```

## Success Criteria

1. The RIDDOR detail page renders a "Draft Review" card with a category `<select>` and override reason `<textarea>` when `incident.status === 'draft'`.
2. Changing category calls `setDraftCategory`, changing reason calls `setDraftOverrideReason`, both triggering the existing 30-second auto-save.
3. The card is hidden for non-draft incidents.
4. `pnpm build` passes.

## Output

After completion, create `.planning/phases/16-critical-bug-fixes/16-02-SUMMARY.md`
