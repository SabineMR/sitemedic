---
plan: 01
phase: 16-critical-bug-fixes
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/medic/payslips/page.tsx
  - web/stores/useMedicLocationsStore.ts
autonomous: true

must_haves:
  truths:
    - "Medic navigates to /medic/payslips and sees their approved/paid timesheets listed (not an empty list)"
    - "No console.warn statements exist in useMedicLocationsStore.ts"
  artifacts:
    - path: "web/app/medic/payslips/page.tsx"
      provides: "Payslip list page with correct medic_id query"
      contains: ".eq('medic_id', medic.id)"
    - path: "web/stores/useMedicLocationsStore.ts"
      provides: "Zustand store for medic locations without console.warn"
  key_links:
    - from: "web/app/medic/payslips/page.tsx"
      to: "medics table"
      via: "supabase .from('medics').select('id').eq('user_id', user.id).single()"
      pattern: "\\.eq\\('medic_id', medic\\.id\\)"
---

# Plan 16-01: Payslip medic_id fix + console.warn removal

## Objective

Fix the payslip page query that uses the wrong ID (auth `user.id` instead of `medic.id`) causing an empty list for all medics, and remove a residual `console.warn` from the production location store.

Purpose: These are two independent one-line fixes in separate files. The payslip bug breaks a key E2E flow (medics cannot see their payslips). The console.warn is leftover debug noise in production.

Output: Two corrected source files.

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md

**Bug 1 — Payslip query:** In `web/app/medic/payslips/page.tsx`, the function fetches the medic record via `.from('medics').select('id').eq('user_id', user.id).single()` on line 47-51. This correctly resolves the medics table primary key. However, the timesheets query on line 65 uses `.eq('medic_id', user.id)` (the auth UUID) instead of `.eq('medic_id', medic.id)` (the medics table UUID). Since `timesheets.medic_id` is a foreign key to `medics(id)`, the query returns zero rows for every medic.

**Bug 2 — console.warn:** In `web/stores/useMedicLocationsStore.ts` line 121, a `console.warn('[Realtime] Received partial update for unknown medic:', medicId)` remains. The `return state;` on line 122 correctly handles the case — the warn is debug noise.

## Tasks

<task id="1" title="Fix payslip medic_id query and add null guard">

## Objective
Change the timesheets query to use `medic.id` instead of `user.id`, and add an early return if `medic` is null so the query never fires with an undefined ID.

## Files
- `web/app/medic/payslips/page.tsx` — lines 53-65

## Implementation

In `web/app/medic/payslips/page.tsx`, make two changes inside the `fetchPayslips` async function:

**Change 1 (line 53):** Replace the bare `if (medic)` guard with a null guard that exits early:

```ts
// BEFORE (line 53):
if (medic) setMedicId(medic.id);

// AFTER:
if (!medic) {
  setLoading(false);
  return;
}
setMedicId(medic.id);
```

**Change 2 (line 65):** Fix the query filter:

```ts
// BEFORE (line 65):
.eq('medic_id', user.id)

// AFTER:
.eq('medic_id', medic.id)
```

No other lines change. The rest of the function remains identical.

## Verification
1. `grep -n "medic_id.*user\\.id" web/app/medic/payslips/page.tsx` returns zero matches (old pattern gone).
2. `grep -n "medic_id.*medic\\.id" web/app/medic/payslips/page.tsx` returns a match on the query line.
3. `grep -n "if (!medic)" web/app/medic/payslips/page.tsx` returns a match (null guard exists).
4. `pnpm build` completes without errors.

## Done
- The timesheets query uses `medic.id` (medics table PK), not `user.id` (auth UUID).
- If no medic record exists, the function sets loading to false and returns early without querying timesheets.

</task>

<task id="2" title="Remove console.warn from useMedicLocationsStore">

## Objective
Remove the `console.warn` on line 121 of the location store. Keep the `return state;` on line 122 — the logic is correct, only the log line is unwanted in production.

## Files
- `web/stores/useMedicLocationsStore.ts` — line 121

## Implementation

In `web/stores/useMedicLocationsStore.ts`, delete line 121:

```ts
// BEFORE (lines 120-123):
        } else {
          console.warn('[Realtime] Received partial update for unknown medic:', medicId);
          return state;
        }

// AFTER (lines 120-122):
        } else {
          return state;
        }
```

Delete only the `console.warn(...)` line. Do not touch anything else.

## Verification
1. `grep -n "console.warn" web/stores/useMedicLocationsStore.ts` returns zero matches.
2. `pnpm build` completes without errors.

## Done
- Zero `console.warn` statements in `useMedicLocationsStore.ts`.
- The `return state;` branch still correctly handles partial updates for unknown medics.

</task>

## Verification

```bash
# 1. No old pattern remains
grep -rn "medic_id.*user\\.id" web/app/medic/payslips/page.tsx
# Expected: no output

# 2. Correct pattern exists
grep -rn "medic_id.*medic\\.id" web/app/medic/payslips/page.tsx
# Expected: 1 match

# 3. No console.warn in store
grep -rn "console.warn" web/stores/useMedicLocationsStore.ts
# Expected: no output

# 4. Build succeeds
pnpm build
```

## Success Criteria

1. `web/app/medic/payslips/page.tsx` queries timesheets with `.eq('medic_id', medic.id)` and has a null guard for missing medic records.
2. `web/stores/useMedicLocationsStore.ts` contains zero `console.warn` statements.
3. `pnpm build` passes.

## Output

After completion, create `.planning/phases/16-critical-bug-fixes/16-01-SUMMARY.md`
