---
phase: 21-film-tv-production-vertical
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/treatment/new.tsx
  - services/taxonomy/certification-types.ts
  - web/types/certification.types.ts
autonomous: true

must_haves:
  truths:
    - "When orgVertical is 'tv_film', the treatment form displays a Production Details section with Production Title, Patient Role picker, SFX/Pyrotechnic Involved toggle, and Scene/Shot Context fields"
    - "Film/TV production details are written to verticalExtraFields as JSON when auto-save fires"
    - "Film/TV production details are included in the enqueueSyncItem payload as vertical_extra_fields"
    - "ScreenSkills Production Safety Passport and EFR are valid cert types in both mobile and web cert type registries"
  artifacts:
    - path: "app/treatment/new.tsx"
      provides: "Film/TV conditional form section with 4 fields"
      contains: "orgVertical === 'tv_film'"
    - path: "services/taxonomy/certification-types.ts"
      provides: "New cert types ScreenSkills Production Safety Passport and EFR"
      contains: "ScreenSkills Production Safety Passport"
    - path: "web/types/certification.types.ts"
      provides: "New cert types mirrored for web"
      contains: "ScreenSkills Production Safety Passport"
  key_links:
    - from: "app/treatment/new.tsx (formValues)"
      to: "app/treatment/new.tsx (useAutoSave)"
      via: "verticalExtraFields key in formValues and fieldMapping"
      pattern: "verticalExtraFields.*vertical_extra_fields"
    - from: "app/treatment/new.tsx (handleCompleteTreatment)"
      to: "enqueueSyncItem payload"
      via: "vertical_extra_fields: treatment.verticalExtraFields ?? null"
      pattern: "vertical_extra_fields.*verticalExtraFields"
---

<objective>
Add the Film/TV production-specific conditional section to the treatment form (FILM-01) and register two new cert types needed by FILM-03.

Purpose: Crew members on film/TV productions require production context captured at incident time — production title, patient role, SFX involvement, and scene context. These fields gate RIDDOR completeness for F2508 forms. The new cert types (ScreenSkills Production Safety Passport, EFR) must exist in both cert registries before Plan 21-02 can reference them in the tv_film cert ordering.

Output: Four Film/TV fields written to verticalExtraFields JSONB; two new cert type entries in both mobile and web cert files.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-film-tv-production-vertical/21-RESEARCH.md
@app/treatment/new.tsx
@services/taxonomy/certification-types.ts
@web/types/certification.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Film/TV conditional section to treatment form with verticalExtraFields wiring</name>
  <files>app/treatment/new.tsx</files>
  <action>
Make the following changes to `app/treatment/new.tsx`:

**1. Add Film/TV state variables** (after line 76 where `certValidationError` is declared):
```typescript
// Film/TV production fields (FILM-01)
const [productionTitle, setProductionTitle] = useState<string>('');
const [patientRole, setPatientRole] = useState<string>('');
const [sfxInvolved, setSfxInvolved] = useState<boolean>(false);
const [sceneContext, setSceneContext] = useState<string>('');
const [showPatientRolePicker, setShowPatientRolePicker] = useState(false);
```

**2. Add FILM_TV_PATIENT_ROLES constant** (after the state variables, before the `initializeTreatment` function):
```typescript
const FILM_TV_PATIENT_ROLES = [
  { id: 'cast', label: 'Cast' },
  { id: 'stunt-performer', label: 'Stunt Performer' },
  { id: 'director', label: 'Director' },
  { id: 'camera', label: 'Camera' },
  { id: 'grip', label: 'Grip' },
  { id: 'lighting', label: 'Lighting' },
  { id: 'art-dept', label: 'Art Dept' },
  { id: 'costume', label: 'Costume' },
  { id: 'other-crew', label: 'Other Crew' },
];
```

**3. Add filmTvExtras to formValues** (in the `formValues` object, after `isRiddorReportable`):
```typescript
verticalExtraFields: orgVertical === 'tv_film' ? JSON.stringify({
  production_title: productionTitle,
  patient_role: patientRole,
  sfx_involved: sfxInvolved,
  scene_context: sceneContext,
}) : null,
```

**4. Add verticalExtraFields to fieldMapping** (in the `fieldMapping` object, after `isRiddorReportable: 'is_riddor_reportable'`):
```typescript
verticalExtraFields: 'vertical_extra_fields',
```

**5. Add vertical_extra_fields to enqueueSyncItem payload** (in `handleCompleteTreatment`, after the `event_vertical: treatment.eventVertical ?? null` line at line 334):
```typescript
vertical_extra_fields: treatment.verticalExtraFields ?? null,
```

**6. Add Film/TV conditional form section** (between the closing `</View>` of Section 1 at line 418 and the `{/* Section 2: Injury Details */}` comment at line 420):
```typescript
{/* Film/TV Production Details — FILM-01 */}
{orgVertical === 'tv_film' && (
  <View style={styles.section}>
    <Text style={styles.sectionTitle}>Production Details</Text>

    <Text style={styles.fieldLabel}>Production Title</Text>
    <TextInput
      style={styles.textArea}
      placeholder="e.g. The Crown S8"
      value={productionTitle}
      onChangeText={setProductionTitle}
      autoCapitalize="words"
    />

    <Text style={styles.fieldLabel}>Patient Role *</Text>
    <Pressable
      style={styles.pickerButton}
      onPress={() => setShowPatientRolePicker(true)}
    >
      <Text style={styles.pickerButtonText}>{patientRole || 'Select role...'}</Text>
    </Pressable>

    <Text style={styles.fieldLabel}>SFX / Pyrotechnic Involved</Text>
    <Pressable
      style={[styles.pickerButton, sfxInvolved && { borderColor: '#F59E0B', borderWidth: 2 }]}
      onPress={() => setSfxInvolved(!sfxInvolved)}
    >
      <Text style={styles.pickerButtonText}>{sfxInvolved ? 'Yes — SFX/Pyrotechnic involved' : 'No'}</Text>
    </Pressable>

    <Text style={styles.fieldLabel}>Scene / Shot Context</Text>
    <TextInput
      style={styles.textArea}
      placeholder="e.g. Car chase scene, Stage 4"
      value={sceneContext}
      onChangeText={setSceneContext}
      multiline
      numberOfLines={3}
      textAlignVertical="top"
    />
  </View>
)}
```

**7. Add BottomSheetPicker for Patient Role** (inside the BottomSheetPicker block area — after the existing `showBodyPartPicker` BottomSheetPicker render, before the closing `</View>` of the entire screen). Find where other BottomSheetPicker components are rendered (they are modal overlays, look for `showInjuryPicker`, `showOutcomePicker` picker renders) and add:
```typescript
{/* Film/TV Patient Role Picker */}
{orgVertical === 'tv_film' && showPatientRolePicker && (
  <BottomSheetPicker
    title="Patient Role"
    items={FILM_TV_PATIENT_ROLES}
    onSelect={(item) => {
      setPatientRole(item.label);
      setShowPatientRolePicker(false);
    }}
    onClose={() => setShowPatientRolePicker(false)}
  />
)}
```

**Critical constraints:**
- verticalExtraFields uses `@text` in Treatment model — it stores a raw JSON string. Do NOT use JSON.parse anywhere in this file; it is parsed at the call site (Supabase sync layer).
- The key `'tv_film'` must be used exactly — never `'film-tv'` or `'film_tv'`.
- The `fieldMapping` entry maps camelCase JS key to snake_case DB column: `verticalExtraFields: 'vertical_extra_fields'`.
- enqueueSyncItem payload already has `event_vertical` at line 334 — add `vertical_extra_fields` immediately after it.
  </action>
  <verify>
Run TypeScript check: `cd /Users/sabineresoagli/GitHub/sitemedic && npx tsc --noEmit 2>&1 | grep -i "new.tsx"` — must return no errors.
Grep check: `grep -n "tv_film\|verticalExtraFields\|vertical_extra_fields\|productionTitle\|patientRole\|sfxInvolved\|sceneContext" /Users/sabineresoagli/GitHub/sitemedic/app/treatment/new.tsx` — must show all 6 occurrences across state, formValues, fieldMapping, and enqueueSyncItem.
  </verify>
  <done>
- `orgVertical === 'tv_film'` conditional block exists in JSX between Section 1 and Section 2
- `productionTitle`, `patientRole`, `sfxInvolved`, `sceneContext` state vars declared
- `verticalExtraFields` present in both `formValues` (with JSON.stringify) and `fieldMapping` (mapped to `'vertical_extra_fields'`)
- `vertical_extra_fields: treatment.verticalExtraFields ?? null` present in enqueueSyncItem payload
- BottomSheetPicker renders for patient role picker when `showPatientRolePicker === true`
- TypeScript reports no errors for new.tsx
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ScreenSkills Production Safety Passport and EFR cert types to both cert registries</name>
  <files>
    services/taxonomy/certification-types.ts
    web/types/certification.types.ts
  </files>
  <action>
**File 1: `services/taxonomy/certification-types.ts`**

Add two new cert types to the `CERT_TYPES` array (add a new Film/TV section after the `// ── Events & Festivals` section, before `// ── Education`):

```typescript
// ── Film / TV Production ────────────────────────────────────────────────
'ScreenSkills Production Safety Passport',
'EFR',
```

Add the corresponding entries to `CERT_TYPE_INFO`:
```typescript
'ScreenSkills Production Safety Passport': {
  label: 'ScreenSkills Production Safety Passport',
  category: 'medical',
  description: 'ScreenSkills Production Safety Passport (CPD-based, no fixed expiry)',
},
'EFR': {
  label: 'Emergency First Responder (EFR)',
  category: 'medical',
  description: 'Emergency First Responder — basic pre-hospital first aid',
},
```

Note: Use category `'medical'` for both — EFR and ScreenSkills are clinical/safety credentials, not construction or events credentials. The `CertCategory` type already includes `'medical'`.

**File 2: `web/types/certification.types.ts`**

Add the same two cert types to `UK_CERT_TYPES` array (add a Film/TV section after the Events & Festivals section, before Education):
```typescript
// ── Film / TV Production ────────────────────────────────────────────────
'ScreenSkills Production Safety Passport',  // ScreenSkills Production Safety Passport (CPD-based)
'EFR',                                       // Emergency First Responder — basic pre-hospital first aid
```

Then find the `CERT_TYPE_METADATA` record in `web/types/certification.types.ts` (it follows the pattern of `UK_CERT_TYPES`) and add the two new entries with the same structure as the existing entries in that file (matching whatever `validityPeriodMonths`, `renewalRequirements`, `issuingBody` fields that record uses).

Read the existing CERT_TYPE_METADATA entries to match the exact field structure before adding:
- `ScreenSkills Production Safety Passport`: issuingBody `'ScreenSkills'`, no fixed validity period (CPD-based) — use `validityPeriodMonths: null` or omit if optional; `renewalRequirements: 'CPD-based — no fixed expiry'`
- `EFR`: issuingBody `'Various (Highfield / RCN / FPHC)'`, `validityPeriodMonths: 36`, `renewalRequirements: 'Renewal every 3 years'`

**Critical constraint:** Both files must be updated in the same execution — if only one file is updated, TypeScript on the web side will have missing cert types in the union type, causing type errors in web components that reference `UKCertType`.
  </action>
  <verify>
Run: `cd /Users/sabineresoagli/GitHub/sitemedic && npx tsc --noEmit 2>&1 | grep -i "certification"` — no errors.
Run: `grep -c "ScreenSkills Production Safety Passport" /Users/sabineresoagli/GitHub/sitemedic/services/taxonomy/certification-types.ts /Users/sabineresoagli/GitHub/sitemedic/web/types/certification.types.ts` — must show 2 matches in each file (one in the array, one in the info/metadata record).
  </verify>
  <done>
- `'ScreenSkills Production Safety Passport'` appears in `CERT_TYPES` array and `CERT_TYPE_INFO` record in `services/taxonomy/certification-types.ts`
- `'EFR'` appears in `CERT_TYPES` array and `CERT_TYPE_INFO` record in `services/taxonomy/certification-types.ts`
- Both cert types mirrored identically in `UK_CERT_TYPES` array and `CERT_TYPE_METADATA` record in `web/types/certification.types.ts`
- TypeScript reports no errors for either cert file
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -n "tv_film\|Production Details\|productionTitle\|sfxInvolved\|vertical_extra_fields" /Users/sabineresoagli/GitHub/sitemedic/app/treatment/new.tsx` — shows all Film/TV additions
2. `grep "ScreenSkills Production Safety Passport\|EFR" /Users/sabineresoagli/GitHub/sitemedic/services/taxonomy/certification-types.ts` — 2 matches (array + info record)
3. `grep "ScreenSkills Production Safety Passport\|EFR" /Users/sabineresoagli/GitHub/sitemedic/web/types/certification.types.ts` — 2 matches (array + metadata record)
4. `cd /Users/sabineresoagli/GitHub/sitemedic && npx tsc --noEmit 2>&1 | head -20` — no new TypeScript errors introduced by Plan 21-01 changes
</verification>

<success_criteria>
- Film/TV conditional section renders when `orgVertical === 'tv_film'` with all 4 fields: Production Title (TextInput), Patient Role (BottomSheetPicker), SFX/Pyrotechnic Involved (toggle Pressable), Scene/Shot Context (TextInput)
- verticalExtraFields is written during auto-save (fieldMapping contains `verticalExtraFields: 'vertical_extra_fields'`)
- vertical_extra_fields appears in enqueueSyncItem payload (syncs to Supabase on treatment completion)
- Both `'ScreenSkills Production Safety Passport'` and `'EFR'` are registered cert types in both the mobile and web cert registries
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/21-film-tv-production-vertical/21-01-SUMMARY.md`
</output>
