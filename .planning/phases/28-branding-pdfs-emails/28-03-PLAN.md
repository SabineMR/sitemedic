---
phase: 28-branding-pdfs-emails
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - web/lib/email/types.ts
  - web/lib/email/templates/booking-confirmation-email.tsx
  - web/lib/email/templates/medic-assignment-email.tsx
  - web/lib/email/templates/booking-received-email.tsx
  - web/app/api/email/booking-confirmation/route.ts
  - web/lib/email/send-booking-received.ts
  - supabase/functions/_shared/email-templates.ts
autonomous: true

must_haves:
  truths:
    - "Booking confirmation email shows the org's company name and logo instead of 'Apex Safety Group Ltd'"
    - "Medic assignment email shows the org's company name instead of 'Apex Safety Group'"
    - "Booking received email shows the org's company name instead of 'Apex Safety Group Ltd'"
    - "Invoice notification email shows the org's company name instead of 'SiteMedic'"
    - "Email accent colour (buttons, header) uses the org's primary_colour_hex instead of hardcoded blue"
    - "'Powered by SiteMedic' appears in email footer for Starter tier only"
  artifacts:
    - path: "web/lib/email/types.ts"
      provides: "EmailBranding interface for email templates"
      exports: ["EmailBranding"]
    - path: "web/lib/email/templates/booking-confirmation-email.tsx"
      provides: "Branded booking confirmation email with required branding prop"
      contains: "branding: EmailBranding"
    - path: "web/lib/email/templates/medic-assignment-email.tsx"
      provides: "Branded medic assignment email with required branding prop"
      contains: "branding: EmailBranding"
    - path: "web/lib/email/templates/booking-received-email.tsx"
      provides: "Branded booking received email with required branding prop"
      contains: "branding: EmailBranding"
    - path: "web/app/api/email/booking-confirmation/route.ts"
      provides: "Route that fetches org branding before sending emails"
      contains: "org_branding"
    - path: "web/lib/email/send-booking-received.ts"
      provides: "Helper that fetches org branding before sending email"
      contains: "org_branding"
    - path: "supabase/functions/_shared/email-templates.ts"
      provides: "sendInvoiceEmail with org branding"
      contains: "company_name"
  key_links:
    - from: "web/app/api/email/booking-confirmation/route.ts"
      to: "org_branding table"
      via: "supabase.from('org_branding').select()"
      pattern: "org_branding"
    - from: "web/lib/email/send-booking-received.ts"
      to: "org_branding table"
      via: "supabase.from('org_branding').select()"
      pattern: "org_branding"
    - from: "web/lib/email/templates/booking-confirmation-email.tsx"
      to: "web/lib/email/types.ts"
      via: "EmailBranding import"
      pattern: "EmailBranding"
---

<objective>
Add org branding to all 4 email templates and their sending routes.

Purpose: Client-facing and medic-facing emails currently hardcode "Apex Safety Group Ltd" or "SiteMedic" branding. This plan creates a shared `EmailBranding` type, updates all 4 email templates to accept branding as a required prop (org logo, company name, primary colour), and updates the 3 sending routes to fetch `org_branding` before rendering. Tier-conditional "Powered by SiteMedic" attribution is added to email footers.

Output: All transactional emails display the org's brand identity. No hardcoded "Apex Safety Group" or "SiteMedic" branding remains in any client/medic-facing email.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-branding-pdfs-emails/28-CONTEXT.md
@.planning/phases/28-branding-pdfs-emails/28-RESEARCH.md

Key files to read before implementing:
@web/lib/email/templates/booking-confirmation-email.tsx
@web/lib/email/templates/medic-assignment-email.tsx
@web/lib/email/templates/booking-received-email.tsx
@web/app/api/email/booking-confirmation/route.ts
@web/lib/email/send-booking-received.ts
@supabase/functions/_shared/email-templates.ts
@web/lib/billing/feature-gates.ts (for hasFeature pattern â€” CAN import in Next.js routes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EmailBranding type and update all 4 email templates</name>
  <files>
    web/lib/email/types.ts
    web/lib/email/templates/booking-confirmation-email.tsx
    web/lib/email/templates/medic-assignment-email.tsx
    web/lib/email/templates/booking-received-email.tsx
  </files>
  <action>
**File 1: `web/lib/email/types.ts`** (NEW FILE)

Create the shared branding interface for email templates:

```typescript
/**
 * Org branding data for email templates.
 * Fetched from org_branding table before rendering any transactional email.
 */
export interface EmailBranding {
  companyName: string;
  logoUrl: string | null;          // Full public URL to org logo
  primaryColourHex: string | null; // e.g. '#1A2B3C'
  tagline: string | null;
  showPoweredBy: boolean;          // true for Starter tier, false for Growth/Enterprise
}

/** Default branding when no org branding is configured. */
export const DEFAULT_EMAIL_BRANDING: EmailBranding = {
  companyName: 'SiteMedic',
  logoUrl: null,
  primaryColourHex: '#2563eb',  // Default blue matching current hardcoded button colour
  tagline: null,
  showPoweredBy: true,
};
```

**File 2: `web/lib/email/templates/booking-confirmation-email.tsx`**

1. Import `EmailBranding` from `@/lib/email/types`
2. Add `branding: EmailBranding` to `BookingConfirmationEmailProps` (REQUIRED prop)
3. Add a branded header section at top of email body (before "Booking Confirmed" heading):
   - If `branding.logoUrl`: render `<Img src={branding.logoUrl} alt={branding.companyName} width="150" />` (import `Img` from `@react-email/components`)
   - If no logo: render company name as large text header
   - Use `branding.primaryColourHex` for the heading colour and button background (replace hardcoded `#2563eb`)
4. Update footer: replace hardcoded "Apex Safety Group Ltd - UK paramedic staffing with built-in compliance" with:
   - `{branding.companyName}` + `{branding.tagline || ''}`
   - If `branding.showPoweredBy`: append " | Powered by SiteMedic" as a link to `https://sitemedic.co.uk`
5. Update the button style to use `branding.primaryColourHex || '#2563eb'` for backgroundColor

**File 3: `web/lib/email/templates/medic-assignment-email.tsx`**

Same pattern as booking-confirmation:
1. Import `EmailBranding` from `@/lib/email/types`
2. Add `branding: EmailBranding` to `MedicAssignmentEmailProps` (REQUIRED)
3. Add branded header (logo or company name text)
4. Use `branding.primaryColourHex` for button colour (replace hardcoded `#2563eb`)
5. Update footer: replace hardcoded "Apex Safety Group - You have been assigned to this booking" with:
   - `{branding.companyName} - You have been assigned to this booking. Please confirm your availability.`
   - If `branding.showPoweredBy`: append "Powered by SiteMedic" link
6. Update button backgroundColor to `branding.primaryColourHex || '#2563eb'`

**File 4: `web/lib/email/templates/booking-received-email.tsx`**

Same pattern:
1. Import `EmailBranding` from `@/lib/email/types`
2. Add `branding: EmailBranding` to `BookingReceivedEmailProps` (REQUIRED)
3. Add branded header
4. Use `branding.primaryColourHex` for button colour
5. Update footer: replace hardcoded "Apex Safety Group Ltd -- UK paramedic staffing with built-in compliance" with branded version + conditional "Powered by SiteMedic"
6. Update button backgroundColor

**IMPORTANT:** The `Img` component from `@react-email/components` is the correct way to add images in react-email templates (NOT `<img>` HTML tag). Check if `Img` is already imported; if not, add it to the imports. If `Img` is not available in the installed version, use a standard `<img>` tag wrapped in appropriate styling.

**IMPORTANT:** Email styles must be inline (not CSS classes) for email client compatibility. The existing templates already use inline styles -- maintain this pattern.
  </action>
  <verify>
    - File exists: `web/lib/email/types.ts` with `EmailBranding` export
    - All 3 template files import `EmailBranding` from `@/lib/email/types`
    - All 3 template props interfaces include `branding: EmailBranding` (not optional)
    - Grep for "Apex Safety Group" across `web/lib/email/templates/` returns zero matches
    - Grep for hardcoded `#2563eb` in button styles -- should reference `branding.primaryColourHex` instead (may still have fallback `|| '#2563eb'`)
    - Each template conditionally renders "Powered by SiteMedic" based on `branding.showPoweredBy`
  </verify>
  <done>
    All 4 email templates accept a required `branding: EmailBranding` prop and render the org's company name, logo (if available), and primary colour. No hardcoded "Apex Safety Group" text remains. "Powered by SiteMedic" is tier-gated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update email sending routes to fetch org branding</name>
  <files>
    web/app/api/email/booking-confirmation/route.ts
    web/lib/email/send-booking-received.ts
    supabase/functions/_shared/email-templates.ts
  </files>
  <action>
**File 1: `web/app/api/email/booking-confirmation/route.ts`**

This route sends 2 emails (client booking confirmation + medic assignment). Both need branding.

1. Import `EmailBranding, DEFAULT_EMAIL_BRANDING` from `@/lib/email/types`
2. Import `hasFeature` from `@/lib/billing/feature-gates` (CAN import in Next.js routes)
3. After fetching the booking (around line 63), fetch org branding:
   ```typescript
   // Fetch org branding for email templates
   const { data: orgBranding } = await supabase
     .from('org_branding')
     .select('company_name, logo_path, primary_colour_hex, tagline')
     .eq('org_id', booking.org_id)  // bookings table has org_id
     .single();

   // Fetch org tier for "Powered by SiteMedic" check
   const { data: org } = await supabase
     .from('organizations')
     .select('subscription_tier')
     .eq('id', booking.org_id)
     .single();

   const logoUrl = orgBranding?.logo_path
     ? `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/org-logos/${orgBranding.logo_path}`
     : null;

   const branding: EmailBranding = orgBranding
     ? {
         companyName: orgBranding.company_name || 'SiteMedic',
         logoUrl,
         primaryColourHex: orgBranding.primary_colour_hex,
         tagline: orgBranding.tagline,
         showPoweredBy: !hasFeature(org?.subscription_tier ?? null, 'white_label'),
       }
     : DEFAULT_EMAIL_BRANDING;
   ```
4. Pass `branding` to both `BookingConfirmationEmail()` and `MedicAssignmentEmail()` render calls
5. Update the `from` field in `resend.emails.send()`:
   - Current client email: `from: 'ASG Bookings <bookings@sitemedic.co.uk>'`
   - New: `from: \`${branding.companyName} Bookings <bookings@sitemedic.co.uk>\``
   - Current medic email: `from: 'Apex Safety Group <bookings@sitemedic.co.uk>'`
   - New: `from: \`${branding.companyName} <bookings@sitemedic.co.uk>\``

**File 2: `web/lib/email/send-booking-received.ts`**

1. Import `EmailBranding, DEFAULT_EMAIL_BRANDING` from `@/lib/email/types`
2. Import `hasFeature` from `@/lib/billing/feature-gates`
3. After fetching the booking (around line 19), fetch org branding:
   ```typescript
   const { data: orgBranding } = await supabase
     .from('org_branding')
     .select('company_name, logo_path, primary_colour_hex, tagline')
     .eq('org_id', booking.org_id)
     .single();

   const { data: org } = await supabase
     .from('organizations')
     .select('subscription_tier')
     .eq('id', booking.org_id)
     .single();

   const logoUrl = orgBranding?.logo_path
     ? `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/org-logos/${orgBranding.logo_path}`
     : null;

   const branding: EmailBranding = orgBranding
     ? {
         companyName: orgBranding.company_name || 'SiteMedic',
         logoUrl,
         primaryColourHex: orgBranding.primary_colour_hex,
         tagline: orgBranding.tagline,
         showPoweredBy: !hasFeature(org?.subscription_tier ?? null, 'white_label'),
       }
     : DEFAULT_EMAIL_BRANDING;
   ```
4. Pass `branding` to `BookingReceivedEmail()` render call
5. Update the `from` field: `from: \`${branding.companyName} Bookings <bookings@sitemedic.co.uk>\``

**File 3: `supabase/functions/_shared/email-templates.ts`**

Update the `sendInvoiceEmail` function. This is an Edge Function using inline HTML (not @react-email), so it needs a different approach. It does NOT have access to `hasFeature()` or the `EmailBranding` type from `web/`.

1. Add branding parameters to `sendInvoiceEmail`:
   ```typescript
   interface InvoiceEmailBranding {
     companyName: string;
     logoUrl: string | null;
     primaryColourHex: string | null;
     showPoweredBy: boolean;
   }

   export async function sendInvoiceEmail(
     clientEmail: string,
     invoice: InvoiceDetails,
     branding?: InvoiceEmailBranding  // Optional for backward compatibility during rollout
   ): Promise<{ success: boolean; error?: string }>
   ```
2. Default branding if not provided: `{ companyName: 'SiteMedic', logoUrl: null, primaryColourHex: '#7c3aed', showPoweredBy: true }`
3. Update the HTML template in sendInvoiceEmail:
   - Replace gradient colours with `branding.primaryColourHex` (or keep purple gradient as default)
   - Replace the `<h1>` "Invoice Ready" with `${branding.companyName} -- Invoice Ready`
   - If `branding.logoUrl`: add `<img src="${branding.logoUrl}" style="max-height:50px; margin-bottom:12px;" />` in the header
   - Replace "SiteMedic Team" sign-off with `${branding.companyName} Team`
   - If `branding.showPoweredBy`: add "Powered by SiteMedic | sitemedic.co.uk" link in footer
   - Replace `from: 'SiteMedic Invoices <invoices@sitemedic.co.uk>'` with `from: \`${b.companyName} Invoices <invoices@sitemedic.co.uk>\``
   - Replace subject `Invoice ${invoice.invoiceNumber} from SiteMedic` with `Invoice ${invoice.invoiceNumber} from ${b.companyName}`
4. Do NOT modify `sendPayoutFailureEmail` or `sendCashFlowAlert` -- these are platform admin alerts, not client-facing. They correctly use "SiteMedic Platform" branding.

**NOTE:** The caller of `sendInvoiceEmail` (likely the invoice PDF generation function or a webhook) must be updated to pass branding. Check who calls `sendInvoiceEmail` and update the call site to fetch and pass branding. If the call site is in the `generate-invoice-pdf` function (already updated in 28-02), add the branding pass-through there. If it is called from elsewhere, update that call site too.
  </action>
  <verify>
    - `web/app/api/email/booking-confirmation/route.ts` queries `org_branding` table before sending
    - `web/app/api/email/booking-confirmation/route.ts` passes `branding` to both BookingConfirmationEmail and MedicAssignmentEmail
    - `web/lib/email/send-booking-received.ts` queries `org_branding` table before sending
    - `web/lib/email/send-booking-received.ts` passes `branding` to BookingReceivedEmail
    - `supabase/functions/_shared/email-templates.ts` sendInvoiceEmail accepts branding parameter
    - Grep for "Apex Safety Group" across all email-related files returns zero matches
    - Grep for hardcoded `from: 'ASG Bookings` or `from: 'Apex Safety Group` returns zero matches
    - The `from` field in all resend.emails.send() calls uses `branding.companyName`
    - sendPayoutFailureEmail and sendCashFlowAlert remain unchanged (platform alerts)
  </verify>
  <done>
    All email sending routes fetch org branding before rendering and pass it to templates. The `from` field uses the org's company name. `sendInvoiceEmail` accepts optional branding. No hardcoded "Apex Safety Group" or "SiteMedic" branding remains in client/medic-facing emails.
  </done>
</task>

</tasks>

<verification>
1. Grep across `web/lib/email/templates/` for "Apex Safety" -- zero matches
2. Grep across `web/lib/email/` and `web/app/api/email/` for hardcoded `from: '.*Apex` or `from: '.*ASG` -- zero matches
3. Grep for "SiteMedic" in email templates -- should only appear in "Powered by SiteMedic" conditional path
4. All 3 email templates require `branding: EmailBranding` prop (TypeScript error if omitted)
5. `sendInvoiceEmail` uses `branding.companyName` in subject line and from field
</verification>

<success_criteria>
- `EmailBranding` type created and shared across all email templates
- All 4 email templates (booking-confirmation, medic-assignment, booking-received, invoice-notification) render org branding
- All 3 sending routes (booking-confirmation route, send-booking-received helper, sendInvoiceEmail) fetch org_branding before rendering
- Email accent colours use org's primary_colour_hex
- "Powered by SiteMedic" attribution appears only for Starter-tier orgs
- No hardcoded "Apex Safety Group Ltd", "Apex Safety Group", "ASG", or "SiteMedic" branding in client/medic-facing emails (except conditional attribution)
- Platform admin alert emails (payout failure, cash flow) remain unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/28-branding-pdfs-emails/28-03-SUMMARY.md`
</output>
