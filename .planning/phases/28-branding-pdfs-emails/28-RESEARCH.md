# Phase 28: Branding — PDFs & Emails — Research

**Researched:** 2026-02-18
**Status:** Complete

## 1. PDF Edge Functions Inventory (8 in scope)

| # | Function | Renderer | Hardcoded Branding | Document Component |
|---|----------|----------|-------------------|-------------------|
| 1 | generate-weekly-report | @react-pdf/renderer 4.3.2 (JSX) | "SiteMedic" in Header.tsx logo placeholder + Footer.tsx "Generated by SiteMedic" | components/ReportDocument.tsx → Header.tsx, Footer.tsx |
| 2 | generate-invoice-pdf | **HTML template** (NOT @react-pdf) | Generic "INVOICE" title, "SiteMedic Ltd" in footer bank details | Inline `generateInvoiceHTML()` |
| 3 | riddor-f2508-generator | @react-pdf/renderer 4.3.2 (JSX) | "SiteMedic treatment records" in footer | F2508Document.tsx |
| 4 | generate-payslip-pdf | @react-pdf/renderer 4.3.2 (createElement) | "SiteMedic" as companyName in header | components/PayslipDocument.tsx |
| 5 | fa-incident-generator | @react-pdf/renderer 4.3.2 (createElement) | author="SiteMedic" + "Generated by SiteMedic" in footer | FAPlayerDocument.tsx, FASpectatorDocument.tsx |
| 6 | motorsport-incident-generator | @react-pdf/renderer 4.3.2 (JSX) | "SiteMedic treatment records" in footer | MotorsportIncidentDocument.tsx |
| 7 | event-incident-report-generator | @react-pdf/renderer 4.3.2 (createElement) | "SiteMedic treatment records" in footer | PurpleGuideDocument.tsx |
| 8 | motorsport-stats-sheet-generator | @react-pdf/renderer 4.3.2 (createElement) | "Generated by SiteMedic" in footer | MotorsportStatsDocument.tsx |

### Key findings

- **7 of 8 use @react-pdf/renderer**, 1 (generate-invoice-pdf) uses inline HTML template
- **None currently use `<Image>` with remote URLs** — no existing precedent for logo loading in PDFs
- All use service role Supabase client with same env vars (`SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`)
- Org ID available via: request body (`org_id`), JWT extraction, or joined from treatments/bookings
- Weekly report has a component structure (components/ dir); others have flat document files
- Payslip document has the most structured header (company name, address sections)

### Supabase client patterns in Edge Functions

Two patterns in use:
```typescript
// Pattern A: Inline creation (most functions — prefer this)
const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

// Pattern B: Module-level constant (older functions: invoice, payslip)
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!;
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
```

### org_branding fetch pattern (for Edge Functions)

```typescript
const { data: branding } = await supabase
  .from('org_branding')
  .select('company_name, logo_path, primary_colour_hex, tagline')
  .eq('org_id', orgId)
  .single();

// Logo URL construction (from Phase 26-02 decision):
const logoUrl = branding?.logo_path
  ? `${Deno.env.get('SUPABASE_URL')}/storage/v1/object/public/org-logos/${branding.logo_path}`
  : null;
```

## 2. Email Templates Inventory

### 3 templates in scope (per roadmap)

| # | Roadmap Name | File | Framework | Hardcoded Branding |
|---|-------------|------|-----------|-------------------|
| 1 | booking-confirmation | `web/lib/email/templates/booking-confirmation-email.tsx` | @react-email/components | Footer: "Apex Safety Group Ltd - UK paramedic staffing with built-in compliance" |
| 2 | shift-alert (medic assignment) | `web/lib/email/templates/medic-assignment-email.tsx` | @react-email/components | Footer: "Apex Safety Group - You have been assigned to this booking" |
| 3 | invoice-notification | `supabase/functions/_shared/email-templates.ts` (sendInvoiceEmail fn) | Inline HTML | "SiteMedic" in header, "SiteMedic Team" in sign-off |

### Additional templates with hardcoded branding (noted for completeness)

| Template | Location | Branding |
|----------|----------|----------|
| booking-received | `web/lib/email/templates/booking-received-email.tsx` | "Apex Safety Group Ltd" in footer |
| cert-expiry | `supabase/functions/certification-expiry-checker/email-templates.ts` | "Apex Safety Group Ltd" footer, from: "SiteMedic Compliance" |
| riddor-deadline | `supabase/functions/riddor-deadline-checker/email-templates.ts` | from: "SiteMedic Compliance" |
| invoice-reminder | `web/app/api/invoices/send-reminder/route.ts` | "SiteMedic" in header and footer |
| payout-failure | `supabase/functions/_shared/email-templates.ts` | "SiteMedic Platform" |
| cash-flow-alert | `supabase/functions/_shared/email-templates.ts` | "SiteMedic Platform" |

**Decision needed by planner:** The roadmap scopes 3 templates, but `booking-received-email.tsx` also hardcodes "Apex Safety Group Ltd" and is sent to clients. It shares the same footer pattern as booking-confirmation. Recommend including it as a 4th template update (minimal additional work — same pattern).

## 3. Email Sending Call Sites

### In scope (web/ Next.js routes)

| Route | Templates Used | resend.emails.send() calls |
|-------|---------------|--------------------------|
| `web/app/api/email/booking-confirmation/route.ts` | BookingConfirmationEmail, MedicAssignmentEmail | 2 (client + medic) |
| `web/lib/email/send-booking-received.ts` | BookingReceivedEmail | 1 |

These routes need to fetch org_branding before rendering and pass it as a prop.

### In scope (Edge Functions)

| Function | Template | resend.emails.send() call |
|----------|----------|--------------------------|
| `supabase/functions/_shared/email-templates.ts` | sendInvoiceEmail (inline HTML) | 1 |

### Out of scope (platform admin alerts — no client-facing branding)

- `_shared/email-templates.ts`: sendPayoutFailureEmail, sendCashFlowAlert — platform alerts to Sabine
- `certification-expiry-checker/email-templates.ts` — compliance alert
- `riddor-deadline-checker/email-templates.ts` — compliance alert
- `web/app/api/invoices/send-reminder/route.ts` — invoice reminder

## 4. @react-pdf/renderer Image in Deno Edge

### Current state
- **No existing `<Image>` usage** across any of the 8 PDF Edge Functions
- All use `<Text>` and `<View>` only — logos are text placeholders
- @react-pdf/renderer 4.3.2 is the consistent version across all functions

### Technical approach for logo

**Option A: Remote URL (preferred if works)**
```tsx
import { Image } from 'npm:@react-pdf/renderer@4.3.2';
<Image src={logoUrl} style={{ width: 60, height: 60 }} />
```
Risk: @react-pdf/renderer needs to fetch the URL at render time. In Deno Edge, network access to Supabase Storage public URL should work, but untested.

**Option B: ArrayBuffer → base64 data URI (fallback)**
```typescript
const response = await fetch(logoUrl);
const buffer = await response.arrayBuffer();
const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
const dataUri = `data:image/png;base64,${base64}`;
// Then: <Image src={dataUri} />
```
More reliable but adds ~100ms fetch + encode overhead per PDF.

**Recommendation:** Plan 28-01 should test Option A first with a minimal PDF. If it fails, implement Option B as documented fallback.

## 5. org_branding Schema

```sql
CREATE TABLE org_branding (
  id                  UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id              UUID NOT NULL UNIQUE REFERENCES organizations(id),
  logo_path           TEXT,              -- e.g. 'org-uuid/logo.png'
  primary_colour_hex  TEXT,              -- e.g. '#1A2B3C' (nullable)
  company_name        TEXT,              -- pre-populated from organizations.name
  tagline             TEXT,              -- optional
  created_at          TIMESTAMPTZ,
  updated_at          TIMESTAMPTZ
);
```

Logo public URL: `${SUPABASE_URL}/storage/v1/object/public/org-logos/${logo_path}`

### Existing TypeScript types

No shared OrgBranding TypeScript type exists yet. The web portal uses `useBranding()` hook from `BrandingProvider` (Phase 27), but Edge Functions and email templates need their own type.

## 6. Shared Component Feasibility

### PDF shared header

A `BrandedPdfHeader` component could work for 7 of 8 functions (all @react-pdf ones). The component would accept:
```typescript
interface BrandedPdfHeaderProps {
  companyName: string;
  documentType: string;  // "Weekly Report", "Invoice", "F2508 RIDDOR Report", etc.
  logoUrl?: string | null;
  primaryColour?: string | null;
}
```

**Location:** `supabase/functions/_shared/pdf-branding.tsx`

The invoice PDF (HTML template) needs a separate HTML-based header.

### Email shared branding

The 2 @react-email templates in `web/lib/email/templates/` could share an `EmailHeader` and `EmailFooter` component. The Edge Function email (sendInvoiceEmail) uses inline HTML and needs separate handling.

## 7. How Org ID is Available Per Function

| Function | Org ID Source |
|----------|--------------|
| generate-weekly-report | Request body `org_id`, or first org fallback |
| generate-invoice-pdf | JWT extraction → `app_metadata.org_id` |
| riddor-f2508-generator | Join: `riddor_incidents → organizations` |
| generate-payslip-pdf | No direct org_id — needs adding via payslip→medic→org join |
| fa-incident-generator | Join: `treatments → organizations` |
| motorsport-incident-generator | Join: `treatments → organizations` |
| event-incident-report-generator | `treatment.org_id` in select |
| motorsport-stats-sheet-generator | Join: `bookings → org_settings` |

**Risk:** `generate-payslip-pdf` has no org_id in current query. Needs a join path: `payslips → medics → [org_id on medics table?]`. Planner should verify the schema.

## 8. Risks and Recommendations

### High confidence
- Fetching org_branding from Edge Functions using service role — proven pattern
- Updating @react-email templates with branding props — straightforward
- Creating shared OrgBranding TypeScript type

### Medium confidence
- **@react-pdf/renderer `<Image>` with remote Supabase Storage URL in Deno Edge** — untested. Must validate with a test PDF before updating all 8 functions. Fallback: fetch → base64 data URI.
- **generate-invoice-pdf HTML template** needs different branding approach (HTML header vs @react-pdf component)

### Low risk
- Tier-based "Powered by SiteMedic" — needs tier check in each function. Org's subscription_tier available via organizations join. Feature gates `hasFeature()` is in web/ only, not in Edge Functions — need inline tier check.

### Recommendations for planner

1. **Plan 28-01 (PDF branding):** Start with `<Image>` test in a single function (generate-weekly-report is ideal — has component structure). If test passes, create shared `BrandedPdfHeader` in `_shared/` and roll out to all 8. Handle generate-invoice-pdf separately (HTML template).

2. **Plan 28-02 (Email branding):** Create `OrgBranding` interface. Update the 3 (ideally 4, include booking-received) @react-email templates with branding prop. Update sending routes to fetch org_branding. Handle Edge Function invoice email separately.

3. **Tier check for attribution:** Each function needs to check org's subscription_tier to decide whether to show "Powered by SiteMedic". Since `hasFeature()` is web-only, use a simple `tier === 'starter'` check after fetching org data.

---

## RESEARCH COMPLETE
