---
phase: 28-branding-pdfs-emails
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - supabase/functions/generate-invoice-pdf/index.ts
  - supabase/functions/riddor-f2508-generator/index.ts
  - supabase/functions/riddor-f2508-generator/F2508Document.tsx
  - supabase/functions/generate-payslip-pdf/index.ts
  - supabase/functions/generate-payslip-pdf/components/PayslipDocument.tsx
  - supabase/functions/fa-incident-generator/index.ts
  - supabase/functions/fa-incident-generator/FAPlayerDocument.tsx
  - supabase/functions/fa-incident-generator/FASpectatorDocument.tsx
  - supabase/functions/motorsport-incident-generator/index.ts
  - supabase/functions/motorsport-incident-generator/MotorsportIncidentDocument.tsx
  - supabase/functions/event-incident-report-generator/index.ts
  - supabase/functions/event-incident-report-generator/PurpleGuideDocument.tsx
  - supabase/functions/motorsport-stats-sheet-generator/index.ts
  - supabase/functions/motorsport-stats-sheet-generator/MotorsportStatsDocument.tsx
autonomous: true

must_haves:
  truths:
    - "Every PDF generated by any of the 8 Edge Functions shows the org's company name in the header"
    - "Every PDF footer shows 'Powered by SiteMedic' for Starter tier only"
    - "No hardcoded 'SiteMedic', 'Apex Safety Group', or 'SiteMedic Ltd' text remains in any PDF function"
    - "Invoice PDF (HTML template) shows org company name in header instead of generic 'INVOICE'"
  artifacts:
    - path: "supabase/functions/generate-invoice-pdf/index.ts"
      provides: "Invoice PDF with org branding in HTML template"
      contains: "fetchOrgBranding"
    - path: "supabase/functions/riddor-f2508-generator/index.ts"
      provides: "RIDDOR PDF with org branding"
      contains: "fetchOrgBranding"
    - path: "supabase/functions/generate-payslip-pdf/index.ts"
      provides: "Payslip PDF with org branding"
      contains: "fetchOrgBranding"
    - path: "supabase/functions/fa-incident-generator/index.ts"
      provides: "FA incident PDF with org branding"
      contains: "fetchOrgBranding"
    - path: "supabase/functions/motorsport-incident-generator/index.ts"
      provides: "Motorsport incident PDF with org branding"
      contains: "fetchOrgBranding"
    - path: "supabase/functions/event-incident-report-generator/index.ts"
      provides: "Event incident PDF with org branding"
      contains: "fetchOrgBranding"
    - path: "supabase/functions/motorsport-stats-sheet-generator/index.ts"
      provides: "Motorsport stats PDF with org branding"
      contains: "fetchOrgBranding"
  key_links:
    - from: "all 7 remaining index.ts files"
      to: "supabase/functions/_shared/branding-helpers.ts"
      via: "fetchOrgBranding import"
      pattern: "fetchOrgBranding"
    - from: "all 6 @react-pdf document components"
      to: "supabase/functions/_shared/pdf-branding.tsx"
      via: "BrandedPdfHeader, BrandedPdfFooter"
      pattern: "BrandedPdf"
---

<objective>
Roll out org branding to the remaining 7 PDF Edge Functions using the shared infrastructure created in 28-01.

Purpose: After 28-01 validated the approach with `generate-weekly-report`, this plan applies the same pattern mechanically to all remaining PDF functions. Each function gets: (1) org_id resolution, (2) `fetchOrgBranding()` call, (3) branding prop passed to document component, (4) `BrandedPdfHeader` and `BrandedPdfFooter` replacing hardcoded text. The invoice PDF uses an HTML template (not @react-pdf) so it gets an HTML-based branded header instead.

Output: All 8 PDF Edge Functions produce org-branded documents with tier-conditional "Powered by SiteMedic" attribution.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-branding-pdfs-emails/28-RESEARCH.md
@.planning/phases/28-branding-pdfs-emails/28-01-SUMMARY.md

Key files to read before implementing (read ALL of these):
@supabase/functions/_shared/branding-helpers.ts (created in 28-01)
@supabase/functions/_shared/pdf-branding.tsx (created in 28-01)
@supabase/functions/generate-weekly-report/index.tsx (reference implementation from 28-01)

Then read each function's index file and document component before modifying:
@supabase/functions/generate-invoice-pdf/index.ts
@supabase/functions/riddor-f2508-generator/index.ts
@supabase/functions/riddor-f2508-generator/F2508Document.tsx
@supabase/functions/generate-payslip-pdf/index.ts
@supabase/functions/generate-payslip-pdf/components/PayslipDocument.tsx
@supabase/functions/fa-incident-generator/index.ts
@supabase/functions/fa-incident-generator/FAPlayerDocument.tsx
@supabase/functions/fa-incident-generator/FASpectatorDocument.tsx
@supabase/functions/motorsport-incident-generator/index.ts
@supabase/functions/motorsport-incident-generator/MotorsportIncidentDocument.tsx
@supabase/functions/event-incident-report-generator/index.ts
@supabase/functions/event-incident-report-generator/PurpleGuideDocument.tsx
@supabase/functions/motorsport-stats-sheet-generator/index.ts
@supabase/functions/motorsport-stats-sheet-generator/MotorsportStatsDocument.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Brand the 6 @react-pdf PDF functions</name>
  <files>
    supabase/functions/riddor-f2508-generator/index.ts
    supabase/functions/riddor-f2508-generator/F2508Document.tsx
    supabase/functions/generate-payslip-pdf/index.ts
    supabase/functions/generate-payslip-pdf/components/PayslipDocument.tsx
    supabase/functions/fa-incident-generator/index.ts
    supabase/functions/fa-incident-generator/FAPlayerDocument.tsx
    supabase/functions/fa-incident-generator/FASpectatorDocument.tsx
    supabase/functions/motorsport-incident-generator/index.ts
    supabase/functions/motorsport-incident-generator/MotorsportIncidentDocument.tsx
    supabase/functions/event-incident-report-generator/index.ts
    supabase/functions/event-incident-report-generator/PurpleGuideDocument.tsx
    supabase/functions/motorsport-stats-sheet-generator/index.ts
    supabase/functions/motorsport-stats-sheet-generator/MotorsportStatsDocument.tsx
  </files>
  <action>
For each of the 6 @react-pdf functions, apply the EXACT same pattern used in `generate-weekly-report` (28-01). Read that function's index.tsx and document component first as reference.

**Pattern per function (repeat for each):**

**Step A: Resolve org_id in the index file.** Each function gets org_id differently:

| Function | How to get org_id |
|----------|------------------|
| riddor-f2508-generator | Already fetches `riddor_incidents` with `organizations` join. Extract `org_id` from the joined organizations data, or add `org_id` to the riddor_incidents select if available directly. |
| generate-payslip-pdf | Add `org_id` to the medics select: change `medics(first_name, last_name, ...)` to `medics(first_name, last_name, ..., org_id)`. Then use `payslip.medics.org_id`. |
| fa-incident-generator | Fetches treatments. Add `org_id` to the treatment select if not already there, or get it from the treatment data. Check the existing query. |
| motorsport-incident-generator | Same as fa-incident -- fetches treatment data. Add `org_id` to select. |
| event-incident-report-generator | Already selects `org_id` (confirmed in research -- line 75 of index.ts). Use it directly. |
| motorsport-stats-sheet-generator | Fetches bookings with org_settings join. Bookings have `org_id`. Use `booking.org_id` or add it to the select. |

**Step B: Fetch branding in the index file.**
```typescript
import { fetchOrgBranding, fetchLogoAsDataUri } from '../_shared/branding-helpers.ts';

// After org_id is available:
const branding = await fetchOrgBranding(supabase, orgId);
let logoSrc = branding.logo_url;
if (logoSrc) {
  const dataUri = await fetchLogoAsDataUri(logoSrc);
  if (dataUri) logoSrc = dataUri;
}
```

**Step C: Pass branding to the document component.**
Add `branding` and `logoSrc` props to the document component call in renderToBuffer().

**Step D: Update the document component.**
1. Import `OrgBranding` from `../_shared/branding-helpers.ts` (or `../../_shared/...` depending on nesting)
2. Import `BrandedPdfHeader` and `BrandedPdfFooter` from `../_shared/pdf-branding.tsx`
3. Add `branding: OrgBranding` (required) and `logoSrc?: string | null` to the component props
4. Replace any hardcoded header (text containing "SiteMedic") with `<BrandedPdfHeader>`
5. Replace any hardcoded footer (text containing "SiteMedic" or "Generated by") with `<BrandedPdfFooter>`
6. Use appropriate `documentType` string for each:
   - riddor-f2508-generator: "F2508 RIDDOR Report"
   - generate-payslip-pdf: "Payslip"
   - fa-incident-generator (player): "FA Match Day Injury Form"
   - fa-incident-generator (spectator): "SGSA Medical Incident Report"
   - motorsport-incident-generator: "Motorsport Incident Report"
   - event-incident-report-generator: "Incident Report"
   - motorsport-stats-sheet-generator: "Medical Statistics Sheet"

**Step E: Remove hardcoded branding.**
Search each file for: "SiteMedic", "Apex Safety", "companyName" hardcoded strings.
- Replace `author="SiteMedic"` in document metadata with `author={branding.company_name}`
- Remove any hardcoded company name strings

**IMPORTANT for import paths:** Some functions are flat (index.ts + Document.tsx in same dir), some have a components/ subdirectory. Adjust relative import paths accordingly:
- Flat structure: `../_shared/branding-helpers.ts`
- With components/: `../../_shared/branding-helpers.ts` (from components dir)

**IMPORTANT for functions using `serve()` vs `Deno.serve()`:** Some older functions use `import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'`. Do NOT change this -- only add the branding integration, don't refactor the serve pattern.
  </action>
  <verify>
    For each of the 6 @react-pdf functions, verify:
    - index.ts imports `fetchOrgBranding` from `_shared/branding-helpers.ts`
    - index.ts calls `fetchOrgBranding(supabase, orgId)` before `renderToBuffer()`
    - Document component accepts `branding: OrgBranding` as a required prop
    - Document component uses `BrandedPdfHeader` and/or `BrandedPdfFooter`
    - Grep for hardcoded "SiteMedic" in each function directory (excluding _shared/) returns zero results except in conditional "Powered by" paths
    - Grep for "Apex Safety" across all function directories returns zero results
  </verify>
  <done>
    All 6 @react-pdf PDF functions fetch org branding and render org-branded headers and footers using shared components. No hardcoded branding text remains.
  </done>
</task>

<task type="auto">
  <name>Task 2: Brand the invoice HTML template PDF</name>
  <files>
    supabase/functions/generate-invoice-pdf/index.ts
  </files>
  <action>
The invoice PDF uses an HTML template (`generateInvoiceHTML()` function), NOT @react-pdf. It cannot use `BrandedPdfHeader`/`BrandedPdfFooter` components. Instead, inject branding directly into the HTML template.

**Step A: Get org_id.**
The function already extracts org_id from JWT via `getOrgIdFromRequest(req)` and stores it in `userOrgId`. Use this directly.

**Step B: Fetch branding.**
```typescript
import { fetchOrgBranding } from '../_shared/branding-helpers.ts';
```
After the invoice fetch and org validation (around line 96), add:
```typescript
const branding = await fetchOrgBranding(supabase, userOrgId);
```

**Step C: Update `generateInvoiceHTML()` function.**
1. Add `branding` parameter to the function signature: `generateInvoiceHTML(data: any, branding: OrgBranding)`
2. Replace the header section:
   - Current: `<div class="title">INVOICE</div>`
   - New: `<div class="title">${branding.company_name} -- Invoice</div>`
   - If `branding.logo_url`: add `<img src="${branding.logo_url}" style="max-height: 60px; max-width: 200px;" />` above the title
   - If `branding.primary_colour_hex`: use it for the header title colour
3. Replace the footer section:
   - Current: bank details with no branding
   - Add: if Starter tier, append "Powered by SiteMedic | sitemedic.co.uk" at bottom
   - Replace any "SiteMedic Ltd" text with `branding.company_name`

**Step D: Pass branding to the function call.**
Change `generateInvoiceHTML(invoiceData)` to `generateInvoiceHTML(invoiceData, branding)`.

**NOTE:** The invoice HTML template uses `<img>` tags (standard HTML), not `@react-pdf/renderer` `<Image>`. Remote URLs work fine in HTML -- no data URI fallback needed for the invoice template itself. However, the HTML is stored as a buffer and uploaded to storage (not rendered in a browser), so the logo URL must be the full public URL that will resolve when the HTML is later opened.
  </action>
  <verify>
    - `generateInvoiceHTML` accepts a `branding` parameter
    - Grep for `"INVOICE"` as standalone title text returns no matches (replaced with company name)
    - Grep for `"SiteMedic Ltd"` returns no matches
    - `fetchOrgBranding` is called before `generateInvoiceHTML`
    - The HTML template includes `branding.company_name` in the header
    - "Powered by SiteMedic" appears conditionally based on tier
  </verify>
  <done>
    Invoice PDF HTML template shows org company name and optional logo in the header. "Powered by SiteMedic" attribution appears only for Starter tier. All hardcoded branding removed from the invoice function.
  </done>
</task>

</tasks>

<verification>
1. Grep across ALL `supabase/functions/*/` directories (excluding `_shared/`) for hardcoded "SiteMedic" -- should only appear in "Powered by SiteMedic" conditional paths and platform alert emails (which are out of scope)
2. Grep for "Apex Safety" across all function directories -- should return zero matches
3. Every PDF function's index file imports and calls `fetchOrgBranding`
4. Every @react-pdf document component accepts `branding: OrgBranding` as a required prop
5. `generate-invoice-pdf` passes branding to `generateInvoiceHTML()`
</verification>

<success_criteria>
- All 8 PDF Edge Functions (7 @react-pdf + 1 HTML) fetch org branding before rendering
- All PDF headers show org company name instead of "SiteMedic"
- All PDF footers show tier-conditional "Powered by SiteMedic" attribution
- No hardcoded "SiteMedic", "SiteMedic Ltd", "Apex Safety Group", or "Apex Safety Group Ltd" remains in any PDF function code (except conditional attribution)
- The branding prop is TypeScript-required in all document components
</success_criteria>

<output>
After completion, create `.planning/phases/28-branding-pdfs-emails/28-02-SUMMARY.md`
</output>
