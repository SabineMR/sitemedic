---
phase: 28-branding-pdfs-emails
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/_shared/pdf-branding.tsx
  - supabase/functions/_shared/branding-helpers.ts
  - supabase/functions/generate-weekly-report/components/Header.tsx
  - supabase/functions/generate-weekly-report/components/Footer.tsx
  - supabase/functions/generate-weekly-report/components/ReportDocument.tsx
  - supabase/functions/generate-weekly-report/index.tsx
autonomous: true

must_haves:
  truths:
    - "Weekly report PDF header shows the org's company name and logo instead of 'SiteMedic' placeholder"
    - "Weekly report PDF footer shows 'Powered by SiteMedic' for Starter tier and org company name for Growth/Enterprise"
    - "An org with no logo configured gets a text-only header with company name (no broken image)"
    - "Shared branding helpers are available in _shared/ for all other PDF functions to reuse"
  artifacts:
    - path: "supabase/functions/_shared/pdf-branding.tsx"
      provides: "BrandedPdfHeader and BrandedPdfFooter @react-pdf components"
      exports: ["BrandedPdfHeader", "BrandedPdfFooter"]
    - path: "supabase/functions/_shared/branding-helpers.ts"
      provides: "fetchOrgBranding helper, OrgBranding type, fetchLogoAsDataUri fallback"
      exports: ["fetchOrgBranding", "OrgBranding", "fetchLogoAsDataUri"]
    - path: "supabase/functions/generate-weekly-report/index.tsx"
      provides: "Weekly report with org branding integration"
    - path: "supabase/functions/generate-weekly-report/components/ReportDocument.tsx"
      provides: "ReportDocument accepting branding prop"
  key_links:
    - from: "supabase/functions/generate-weekly-report/index.tsx"
      to: "supabase/functions/_shared/branding-helpers.ts"
      via: "fetchOrgBranding(supabase, orgId)"
      pattern: "fetchOrgBranding"
    - from: "supabase/functions/generate-weekly-report/components/Header.tsx"
      to: "supabase/functions/_shared/pdf-branding.tsx"
      via: "BrandedPdfHeader component"
      pattern: "BrandedPdfHeader"
    - from: "supabase/functions/_shared/branding-helpers.ts"
      to: "org_branding table"
      via: "supabase.from('org_branding').select().eq('org_id', orgId)"
      pattern: "org_branding"
---

<objective>
Create shared PDF branding infrastructure and pilot-test it on `generate-weekly-report`.

Purpose: The `@react-pdf/renderer` `<Image>` component with a remote Supabase Storage URL has never been tested in Deno Edge. This plan creates the shared branding helpers and components in `_shared/`, then validates the approach end-to-end in the weekly report function -- the one PDF function with a component directory structure that makes it easiest to integrate. If remote `<Image>` fails, the fallback (fetch -> base64 data URI) is implemented in the same plan. Once this plan succeeds, 28-02 rolls out the proven pattern mechanically to the remaining 7 functions.

Output: Shared `_shared/pdf-branding.tsx` (header + footer components), `_shared/branding-helpers.ts` (fetch helper + types), and a fully branded `generate-weekly-report` function.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-branding-pdfs-emails/28-CONTEXT.md
@.planning/phases/28-branding-pdfs-emails/28-RESEARCH.md

Key files to read before implementing:
@supabase/functions/generate-weekly-report/index.tsx
@supabase/functions/generate-weekly-report/components/Header.tsx
@supabase/functions/generate-weekly-report/components/Footer.tsx
@supabase/functions/generate-weekly-report/components/ReportDocument.tsx
@supabase/functions/generate-weekly-report/styles.ts
@supabase/functions/_shared/email-templates.ts (for existing _shared patterns)
@web/lib/billing/feature-gates.ts (for tier check pattern â€” but do NOT import this in Edge Functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared branding infrastructure in _shared/</name>
  <files>
    supabase/functions/_shared/branding-helpers.ts
    supabase/functions/_shared/pdf-branding.tsx
  </files>
  <action>
**File 1: `supabase/functions/_shared/branding-helpers.ts`**

Create the shared branding fetch helper and types used by all 8 PDF Edge Functions.

1. Define `OrgBranding` interface:
   ```typescript
   export interface OrgBranding {
     company_name: string;
     logo_path: string | null;
     primary_colour_hex: string | null;
     tagline: string | null;
     logo_url: string | null;        // Computed: full public URL or null
     subscription_tier: string | null; // For "Powered by SiteMedic" tier check
   }
   ```

2. Create `fetchOrgBranding(supabase, orgId)` function:
   - Query `org_branding` table: `select('company_name, logo_path, primary_colour_hex, tagline').eq('org_id', orgId).single()`
   - Query `organizations` table: `select('subscription_tier').eq('id', orgId).single()` (separate query -- org_branding does not have tier)
   - Compute `logo_url`: if `logo_path` exists, construct `${Deno.env.get('SUPABASE_URL')}/storage/v1/object/public/org-logos/${logo_path}`, else null
   - Return `OrgBranding` with all fields populated
   - Fallback if no branding row exists: return `{ company_name: 'SiteMedic', logo_path: null, primary_colour_hex: null, tagline: null, logo_url: null, subscription_tier: null }`

3. Create `fetchLogoAsDataUri(logoUrl: string): Promise<string | null>` function:
   - Fetch the logo URL via `fetch()`
   - Convert ArrayBuffer to base64: `btoa(String.fromCharCode(...new Uint8Array(buffer)))`
   - Detect content type from response headers (image/png, image/jpeg, etc.)
   - Return `data:${contentType};base64,${base64}` string
   - Return null on any error (network, invalid response, etc.)
   - This is the FALLBACK if `@react-pdf/renderer` `<Image src={remoteUrl}>` fails in Deno

4. Create `showPoweredBySiteMedic(tier: string | null): boolean` helper:
   - Returns `true` if tier is null or 'starter'
   - Returns `false` for 'growth' and 'enterprise'
   - This is an inline check, NOT importing from `web/lib/billing/feature-gates.ts` (that module uses `process.env` which does not exist in Deno Edge)

**File 2: `supabase/functions/_shared/pdf-branding.tsx`**

Create reusable `@react-pdf/renderer` components for branded PDF headers and footers. All 7 @react-pdf PDF functions will use these.

1. Import from `npm:@react-pdf/renderer@4.3.2` (match existing version across all functions)
2. Import `React` from `npm:react@18.3.1` (match existing version -- some functions use 18.2.0 but 18.3.1 is newer and used by fa-incident-generator)

3. Create `BrandedPdfHeader` component:
   ```typescript
   interface BrandedPdfHeaderProps {
     companyName: string;
     documentType: string;  // e.g. "Weekly Report", "F2508 RIDDOR Report"
     logoSrc?: string | null; // Remote URL or data URI
     primaryColour?: string | null;
   }
   ```
   - Layout: logo on left (60x60 if provided, skip if null), company name + document type on right
   - Header text format: "{companyName} -- {documentType}" (em dash separator, per CONTEXT.md decision)
   - If no logo: text-only header with company name prominently displayed
   - Use `Image` from @react-pdf/renderer for logo (try remote URL first)
   - Style the header with a bottom border line using `primaryColour` if provided, else `#1e293b`

4. Create `BrandedPdfFooter` component:
   ```typescript
   interface BrandedPdfFooterProps {
     companyName: string;
     showPoweredBy: boolean; // true for Starter tier
     projectName?: string;   // Some PDFs include project name in footer
   }
   ```
   - Uses `render` prop pattern (like existing Footer.tsx) for page numbers: `Page X of Y`
   - If `showPoweredBy` is true: include "Powered by SiteMedic | sitemedic.co.uk" text
   - If `showPoweredBy` is false: just company name + page numbers
   - Keep `Confidential` marker if projectName provided
   - Mark as `fixed` (appears on every page)

Export both components.
  </action>
  <verify>
    - File exists: `supabase/functions/_shared/branding-helpers.ts`
    - File exists: `supabase/functions/_shared/pdf-branding.tsx`
    - `OrgBranding` interface is exported
    - `fetchOrgBranding` function is exported
    - `fetchLogoAsDataUri` function is exported
    - `showPoweredBySiteMedic` function is exported
    - `BrandedPdfHeader` component is exported
    - `BrandedPdfFooter` component is exported
    - No import from `web/` directory (Edge Functions cannot import from Next.js app)
    - Uses `npm:@react-pdf/renderer@4.3.2` (not bare import)
  </verify>
  <done>
    Shared branding helpers and @react-pdf components exist in `_shared/` with all types, fetch helpers, and fallback logic ready for consumption by all 8 PDF Edge Functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate branding into generate-weekly-report (pilot test)</name>
  <files>
    supabase/functions/generate-weekly-report/index.tsx
    supabase/functions/generate-weekly-report/components/ReportDocument.tsx
    supabase/functions/generate-weekly-report/components/Header.tsx
    supabase/functions/generate-weekly-report/components/Footer.tsx
  </files>
  <action>
This is the pilot test for the `<Image>` approach. The weekly report already has `orgId` available in `index.tsx` (from request body or first-org fallback).

**Update `index.tsx`:**

1. Import `fetchOrgBranding` and `fetchLogoAsDataUri` from `../_shared/branding-helpers.ts`
2. After `orgId` is resolved (around line 161), fetch branding:
   ```typescript
   const branding = await fetchOrgBranding(supabase, orgId);
   ```
3. If `branding.logo_url` exists, attempt to pre-fetch as data URI (the fallback path):
   ```typescript
   let logoSrc = branding.logo_url;
   // Fallback: if @react-pdf can't load remote URLs in Deno, use data URI
   if (logoSrc) {
     const dataUri = await fetchLogoAsDataUri(logoSrc);
     if (dataUri) logoSrc = dataUri;
   }
   ```
   NOTE: Start with the data URI approach directly (it is the safer path for Deno Edge). The remote URL approach can be tested later if performance optimization is needed. The research flagged this as MEDIUM confidence, so default to the reliable path.
4. Pass branding to `ReportDocument`:
   ```tsx
   <ReportDocument data={reportData} branding={branding} logoSrc={logoSrc} />
   ```

**Update `components/ReportDocument.tsx`:**

1. Import `OrgBranding` type from `../../_shared/branding-helpers.ts`
2. Add `branding: OrgBranding` and `logoSrc?: string | null` to `ReportDocumentProps` (make branding required so TypeScript errors if omitted)
3. Pass branding props down to `Header` and `Footer`

**Update `components/Header.tsx`:**

1. Replace the current hardcoded implementation with `BrandedPdfHeader` from `../../_shared/pdf-branding.tsx`
2. Keep the report-specific details (project name, week ending, medic name, generated date) below the branded header
3. The `HeaderProps` interface should add `companyName`, `documentType`, `logoSrc`, `primaryColour` (or accept the full branding object)
4. Remove the `<Text style={styles.logoPlaceholder}>SiteMedic</Text>` placeholder

**Update `components/Footer.tsx`:**

1. Replace with `BrandedPdfFooter` from `../../_shared/pdf-branding.tsx`
2. Pass `showPoweredBy` based on `showPoweredBySiteMedic(branding.subscription_tier)`
3. Keep the project name in the footer (passed through)
4. Remove hardcoded "Generated by SiteMedic" text
  </action>
  <verify>
    - `ReportDocument` requires `branding: OrgBranding` prop (removing it causes TypeScript error)
    - No "SiteMedic" string remains in Header.tsx or Footer.tsx (except via "Powered by SiteMedic" conditional)
    - `index.tsx` calls `fetchOrgBranding(supabase, orgId)` before rendering
    - `index.tsx` calls `fetchLogoAsDataUri()` for logo pre-fetch
    - Grep for "logoPlaceholder" in Header.tsx returns no matches
    - Grep for "Generated by SiteMedic" in Footer.tsx returns no matches
  </verify>
  <done>
    `generate-weekly-report` fetches org branding from the database, passes it to the document component, and renders the org's company name (and logo if configured) in the PDF header. The "Powered by SiteMedic" attribution appears only for Starter-tier orgs. This validates the shared infrastructure for all remaining PDF functions.
  </done>
</task>

</tasks>

<verification>
1. Grep across `supabase/functions/generate-weekly-report/` for hardcoded "SiteMedic" -- should only appear in "Powered by SiteMedic" conditional path
2. `supabase/functions/_shared/branding-helpers.ts` exports: OrgBranding, fetchOrgBranding, fetchLogoAsDataUri, showPoweredBySiteMedic
3. `supabase/functions/_shared/pdf-branding.tsx` exports: BrandedPdfHeader, BrandedPdfFooter
4. `ReportDocument` interface requires `branding: OrgBranding` -- compile error if omitted
</verification>

<success_criteria>
- Shared PDF branding infrastructure created and proven in one function
- `generate-weekly-report` renders org company name in header, tier-conditional attribution in footer
- Logo integration uses data URI approach (reliable Deno Edge path)
- No hardcoded "SiteMedic" branding in weekly report output (except tier-gated attribution)
- All shared components and helpers are generic enough for remaining 7 functions
</success_criteria>

<output>
After completion, create `.planning/phases/28-branding-pdfs-emails/28-01-SUMMARY.md`
</output>
