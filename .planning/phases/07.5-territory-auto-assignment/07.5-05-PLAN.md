---
phase: 07.5-territory-auto-assignment
plan: 05
type: execute
wave: 3
depends_on: ["07.5-03", "07.5-04"]
files_modified:
  - web/components/admin/territory-map.tsx
  - web/app/admin/territories/territory-detail.tsx
  - web/app/admin/territories/page.tsx
autonomous: false

must_haves:
  truths:
    - "Visual coverage map updates with 5-minute refresh and color-coded utilization"
    - "Admin can click a postcode sector marker on the map to see assigned medic, stats, and recent bookings"
    - "Territory detail panel shows recent bookings for the selected territory"
    - "Map legend shows utilization color bands (green <50%, yellow 50-80%, red >80%)"
    - "Assignment panel integrates with map (assigning a medic updates the map marker color)"
  artifacts:
    - path: "web/components/admin/territory-map.tsx"
      provides: "Enhanced map with clickable markers that open detail panel"
      contains: "onTerritoryClick"
    - path: "web/app/admin/territories/territory-detail.tsx"
      provides: "Territory detail side panel with medic info, stats, recent bookings"
      contains: "TerritoryDetail"
    - path: "web/app/admin/territories/page.tsx"
      provides: "Fully integrated territories page with map, detail panel, assignments, and alerts"
      contains: "selectedTerritory"
  key_links:
    - from: "web/components/admin/territory-map.tsx"
      to: "web/app/admin/territories/territory-detail.tsx"
      via: "onTerritoryClick callback prop"
      pattern: "onTerritoryClick"
    - from: "web/app/admin/territories/territory-detail.tsx"
      to: "web/lib/queries/admin/territories.ts"
      via: "useAssignMedicToTerritory for inline assignment"
      pattern: "useAssignMedicToTerritory"
    - from: "web/app/admin/territories/page.tsx"
      to: "web/app/admin/territories/assignment-panel.tsx"
      via: "AssignmentPanel component integration"
      pattern: "AssignmentPanel"
---

<objective>
Enhance the coverage map with clickable territory markers that open a detail panel, add recent bookings to the detail view, and integrate all Plan 03/04 components into the final territories page layout.

Purpose: Success Criteria #9 requires real-time map with 5-minute refresh. Success Criteria #10 requires admin can click a sector to see assigned medic, stats, and recent bookings. This plan creates the final integrated experience combining map, detail panel, drag-drop assignments, coverage alerts, and hiring recommendations.

Output: Enhanced territory map with click handlers, territory detail panel, fully integrated territories page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.5-territory-auto-assignment/07.5-RESEARCH.md
@.planning/phases/07.5-territory-auto-assignment/07.5-01-SUMMARY.md
@.planning/phases/07.5-territory-auto-assignment/07.5-03-SUMMARY.md
@.planning/phases/07.5-territory-auto-assignment/07.5-04-SUMMARY.md

Key existing files:
@web/components/admin/territory-map.tsx (existing map component)
@web/app/admin/territories/page.tsx (existing page with Plan 04 additions)
@web/app/admin/territories/assignment-panel.tsx (drag-drop panel from Plan 03)
@web/app/admin/territories/coverage-alerts.tsx (alerts from Plan 04)
@web/app/admin/territories/hiring-panel.tsx (hiring panel from Plan 04)
@web/lib/queries/admin/territories.ts (territory queries + mutations from Plan 03)
@web/lib/queries/admin/bookings.ts (booking queries for recent bookings)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance territory map and create territory detail panel</name>
  <files>web/components/admin/territory-map.tsx, web/app/admin/territories/territory-detail.tsx</files>
  <action>
**Enhanced territory-map.tsx:**

Update the existing TerritoryMapInner component:
1. Accept new props: `onTerritoryClick?: (territory: TerritoryWithMetrics) => void` and `selectedTerritoryId?: string`
2. When a CircleMarker is clicked, call `onTerritoryClick(territory)` instead of just showing popup
3. Highlight the selected territory with a larger radius (16 vs 12) and a thicker border (weight 3 vs 1) in blue (#3b82f6)
4. Keep the popup on hover for quick stats, but click triggers the detail panel
5. Change the map refetch interval comment to note 5-minute refresh (this is controlled by the parent query, not the component itself -- just document it)
6. Add a "Refresh" button in the map legend area that calls `onRefreshClick?: () => void`
7. Animate the selected marker with a subtle pulse (CSS animation on the circle)

**territory-detail.tsx:**

Create a 'use client' component `TerritoryDetail` as a slide-in right panel:
1. Props: `territory: TerritoryWithMetrics | null`, `onClose: () => void`
2. Panel slides in from the right (w-96, full height) with dark background matching admin theme
3. Header: Postcode sector, region, close button (X)
4. Sections:
   a. **Assigned Medics:**
      - Primary medic name (or "Unassigned" with red badge)
      - Secondary medic name (or "None" with gray badge)
      - "Change" button next to each that opens a small medic selector dropdown (using useAssignMedicToTerritory mutation)
   b. **Utilization:**
      - Utilization percentage with colored progress bar
      - Utilization trend text ("Stable" / "Increasing" / "Decreasing") -- compare to previous metric if available
   c. **Metrics Summary:**
      - Total bookings (number)
      - Confirmed bookings (green number)
      - Rejected bookings (red number if >0)
      - Rejection rate (colored by severity)
      - Fulfillment rate
   d. **Recent Bookings:**
      - Fetch last 5 bookings for this territory's postcode_sector from bookings table
      - Query: supabase.from('bookings').select('id, shift_date, status, client_id, medic_id, shift_hours').eq('site_postcode', territory.postcode_sector).order('shift_date', { ascending: false }).limit(5)
      - Each booking shows: date, status badge (confirmed=green, pending=yellow, cancelled=red), shift hours
      - Use TanStack Query inline hook for the bookings fetch (only when territory is selected)
   e. **Territory Notes:**
      - Display existing `notes` field from territory
      - "Edit" button to update notes (textarea + save button)

5. Use `useEffect` to animate panel entrance (translate-x-full -> translate-x-0)
6. Click outside panel or press Escape to close
  </action>
  <verify>
- Map markers are clickable and trigger onTerritoryClick
- Selected marker is visually highlighted
- Territory detail panel slides in from right
- Recent bookings section fetches and displays correctly
- Medic "Change" button triggers assignment mutation
- Panel closes on Escape key and outside click
  </verify>
  <done>
Territory map markers are clickable, opening a detail panel showing assigned medics, utilization metrics, recent bookings, and territory notes. Selected marker is visually highlighted on the map.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate all components into final territories page</name>
  <files>web/app/admin/territories/page.tsx</files>
  <action>
Rewrite the territories page.tsx to integrate ALL Phase 7.5 components into a cohesive layout:

**Page Layout (top to bottom):**
1. **Header** (existing, keep as-is): "Territory Coverage" title with icon
2. **Summary Stats Bar** (from Plan 04): Total, Assigned, Unassigned, Avg Utilization, Active Alerts
3. **Tab Navigation**: Two tabs: "Coverage Map" (default) and "Assignment Manager"
   - **Coverage Map Tab:**
     - CoverageAlerts (from Plan 04) -- collapsible
     - HiringPanel (from Plan 04) -- collapsible
     - Enhanced TerritoryMap (modified in this plan) -- 50vh height
     - TerritoryList (existing) -- scrollable below map
   - **Assignment Manager Tab:**
     - AssignmentPanel (from Plan 03) -- full-width drag-drop interface
4. **Territory Detail Side Panel** (from this plan): Slides in when territory is clicked on map or in list

**State Management:**
- `selectedTerritory: TerritoryWithMetrics | null` -- tracks which territory's detail panel is open
- `activeTab: 'coverage' | 'assignment'` -- tab state

**Data Flow:**
- Use `useTerritories()` with 5-minute polling: Set `refetchInterval: 300000` (5 minutes, changed from 60 seconds for the map-specific performance per Success Criteria #9). NOTE: Actually, keep the 60-second interval in the query hook and use a separate state flag if needed. The 5-minute refresh is a SUCCESS CRITERIA requirement, so change the useTerritories refetchInterval from 60000 to 300000 to match.
- Pass `onTerritoryClick` to TerritoryMap and also add click handler on TerritoryList rows
- When territory is clicked (map or list), set `selectedTerritory` and show detail panel

**TerritoryList Enhancement:**
- Add click handler on rows: clicking a row opens the TerritoryDetail panel for that territory
- Add cursor-pointer styling on hover

**Responsive Layout:**
- On mobile (<lg): tabs stack full-width, detail panel overlays instead of side panel
- On desktop (>=lg): tabs fill width, detail panel is side-by-side
  </action>
  <verify>
- Page renders all 4 component groups: stats, alerts, map, list
- Tab navigation switches between Coverage Map and Assignment Manager
- Clicking territory marker on map opens detail panel
- Clicking territory row in list opens detail panel
- Detail panel shows recent bookings
- useTerritories polling is set to 300000 (5 minutes)
- Assignment changes update map and list immediately via query invalidation
  </verify>
  <done>
Territories page integrates coverage map, assignment manager, coverage gap alerts, hiring recommendations, and territory detail panel into a tabbed interface. Map refreshes every 5 minutes. Admin can click any territory for full detail view with recent bookings.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Full territory management admin page with:
- Coverage map with clickable markers and 5-minute auto-refresh
- Drag-drop medic assignment panel
- Coverage gap alerts with severity styling
- Hiring recommendation panel grouped by region
- Territory detail panel with recent bookings
- Tab navigation between coverage view and assignment view
  </what-built>
  <how-to-verify>
1. Run `pnpm dev` on port 30500
2. Navigate to `/admin/territories`
3. Verify Coverage Map tab:
   a. Map loads with colored markers
   b. Click a marker -- detail panel slides in from right with territory info
   c. Coverage gap alerts show (if any territories have >10% rejection rate)
   d. Hiring recommendations show (if any territories have >80% utilization)
4. Switch to Assignment Manager tab:
   a. Medic cards show on left with utilization bars
   b. Territory list shows on right with drop zones
   c. Drag a medic card onto a territory's primary/secondary slot
   d. Assignment should persist (refresh page to confirm)
5. Verify summary stats bar shows correct counts
6. Verify 5-minute polling (or check network tab for refetch interval)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Coverage map displays color-coded territories with working click interaction
2. Territory detail panel shows: assigned medic, stats, recent bookings
3. Assignment panel allows drag-drop medic assignment
4. All Plan 03 and Plan 04 components render correctly in integrated page
5. Tab navigation works between coverage view and assignment view
6. 5-minute polling updates map markers
7. Summary stats bar shows accurate territory health overview
</verification>

<success_criteria>
- Visual coverage map updates with 5-minute refresh and color-coded utilization (SC #9)
- Admin can click postcode sector to see assigned medic, stats, recent bookings (SC #10)
- Drag-drop assignment works from Assignment Manager tab (SC #2)
- Coverage gaps and hiring triggers display correctly (SC #7, #8)
- All components integrate into cohesive tabbed interface
</success_criteria>

<output>
After completion, create `.planning/phases/07.5-territory-auto-assignment/07.5-05-SUMMARY.md`
</output>
