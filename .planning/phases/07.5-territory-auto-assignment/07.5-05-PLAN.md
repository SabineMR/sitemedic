---
phase: 07.5-territory-auto-assignment
plan: 05
type: execute
wave: 3
depends_on: ["07.5-02", "07.5-03", "07.5-04"]
files_modified:
  - web/components/admin/territory-map.tsx
  - web/app/admin/territories/territory-detail.tsx
  - web/app/admin/territories/page.tsx
  - web/lib/territory/__tests__/auto-assignment-success-rate.test.ts
autonomous: false

must_haves:
  truths:
    - "Visual coverage map updates with 5-minute refresh and color-coded utilization"
    - "Admin can click a postcode sector marker on the map to see assigned medic, stats, and recent bookings"
    - "Territory detail panel shows recent bookings for the selected territory"
    - "Map legend shows utilization color bands (green <50%, yellow 50-80%, red >80%)"
    - "Assignment panel integrates with map (assigning a medic updates the map marker color)"
    - "Auto-assignment algorithm matches 95%+ of 100 simulated bookings (verified by test)"
  artifacts:
    - path: "web/components/admin/territory-map.tsx"
      provides: "Enhanced map with clickable markers that open detail panel"
      contains: "onTerritoryClick"
    - path: "web/app/admin/territories/territory-detail.tsx"
      provides: "Territory detail side panel with medic info, stats, recent bookings"
      contains: "TerritoryDetail"
    - path: "web/app/admin/territories/page.tsx"
      provides: "Fully integrated territories page with map, detail panel, assignments, and alerts"
      contains: "selectedTerritory"
    - path: "web/lib/territory/__tests__/auto-assignment-success-rate.test.ts"
      provides: "95% success rate verification test with 100 simulated bookings"
      contains: "expect(successRate).toBeGreaterThanOrEqual(0.95)"
  key_links:
    - from: "web/components/admin/territory-map.tsx"
      to: "web/app/admin/territories/territory-detail.tsx"
      via: "onTerritoryClick callback prop"
      pattern: "onTerritoryClick"
    - from: "web/app/admin/territories/territory-detail.tsx"
      to: "web/lib/queries/admin/territories.ts"
      via: "useAssignMedicToTerritory for inline assignment"
      pattern: "useAssignMedicToTerritory"
    - from: "web/app/admin/territories/page.tsx"
      to: "web/app/admin/territories/assignment-panel.tsx"
      via: "AssignmentPanel component integration"
      pattern: "AssignmentPanel"
    - from: "web/app/admin/territories/territory-detail.tsx"
      to: "web/lib/territory/auto-assignment.ts"
      via: "formatScoreBreakdown and calculateAutoMatchScore for medic fit display"
      pattern: "import.*auto-assignment"
---

<objective>
Enhance the coverage map with clickable territory markers that open a detail panel, add recent bookings to the detail view, and integrate all Plan 03/04 components into the final territories page layout.

Purpose: Success Criteria #9 requires real-time map with 5-minute refresh. Success Criteria #10 requires admin can click a sector to see assigned medic, stats, and recent bookings. This plan creates the final integrated experience combining map, detail panel, drag-drop assignments, coverage alerts, and hiring recommendations.

Output: Enhanced territory map with click handlers, territory detail panel, fully integrated territories page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.5-territory-auto-assignment/07.5-RESEARCH.md
@.planning/phases/07.5-territory-auto-assignment/07.5-01-SUMMARY.md
@.planning/phases/07.5-territory-auto-assignment/07.5-02-SUMMARY.md
@.planning/phases/07.5-territory-auto-assignment/07.5-03-SUMMARY.md
@.planning/phases/07.5-territory-auto-assignment/07.5-04-SUMMARY.md

Key existing files:
@web/components/admin/territory-map.tsx (existing map component)
@web/app/admin/territories/page.tsx (existing page with Plan 04 additions)
@web/app/admin/territories/assignment-panel.tsx (drag-drop panel from Plan 03)
@web/app/admin/territories/coverage-alerts.tsx (alerts from Plan 04)
@web/app/admin/territories/hiring-panel.tsx (hiring panel from Plan 04)
@web/lib/queries/admin/territories.ts (territory queries + mutations from Plan 03)
@web/lib/queries/admin/bookings.ts (booking queries for recent bookings)
@web/lib/territory/auto-assignment.ts (client-side scoring module from Plan 02: rankMedicsForBooking, calculateAutoMatchScore, formatScoreBreakdown)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance territory map and create territory detail panel</name>
  <files>web/components/admin/territory-map.tsx, web/app/admin/territories/territory-detail.tsx</files>
  <action>
**Enhanced territory-map.tsx:**

Update the existing TerritoryMapInner component:
1. Accept new props: `onTerritoryClick?: (territory: TerritoryWithMetrics) => void` and `selectedTerritoryId?: string`
2. When a CircleMarker is clicked, call `onTerritoryClick(territory)` instead of just showing popup
3. Highlight the selected territory with a larger radius (16 vs 12) and a thicker border (weight 3 vs 1) in blue (#3b82f6)
4. Keep the popup on hover for quick stats, but click triggers the detail panel
5. Change the map refetch interval comment to note 5-minute refresh (this is controlled by the parent query, not the component itself -- just document it)
6. Add a "Refresh" button in the map legend area that calls `onRefreshClick?: () => void`
7. Animate the selected marker with a subtle pulse (CSS animation on the circle)

**territory-detail.tsx:**

Create a 'use client' component `TerritoryDetail` as a slide-in right panel:
1. Props: `territory: TerritoryWithMetrics | null`, `onClose: () => void`
2. Panel slides in from the right (w-96, full height) with dark background matching admin theme
3. Header: Postcode sector, region, close button (X)
4. Sections:
   a. **Assigned Medics:**
      - Primary medic name (or "Unassigned" with red badge)
      - Secondary medic name (or "None" with gray badge)
      - Below each assigned medic, show the auto-assignment score breakdown using `formatScoreBreakdown()` from `@/lib/territory/auto-assignment` (Plan 02). This shows WHY this medic is a good/poor fit for this territory.
      - "Change" button next to each that opens a small medic selector dropdown (using useAssignMedicToTerritory mutation). The dropdown items should show `calculateAutoMatchScore()` results to help admin pick the best replacement.
   b. **Utilization:**
      - Utilization percentage with colored progress bar
      - Utilization trend text ("Stable" / "Increasing" / "Decreasing") -- compare to previous metric if available
   c. **Metrics Summary:**
      - Total bookings (number)
      - Confirmed bookings (green number)
      - Rejected bookings (red number if >0)
      - Rejection rate (colored by severity)
      - Fulfillment rate
   d. **Recent Bookings:**
      - Fetch last 5 bookings for this territory's postcode_sector from bookings table
      - Query: supabase.from('bookings').select('id, shift_date, status, client_id, medic_id, shift_hours').eq('site_postcode', territory.postcode_sector).order('shift_date', { ascending: false }).limit(5)
      - Each booking shows: date, status badge (confirmed=green, pending=yellow, cancelled=red), shift hours
      - Use TanStack Query inline hook for the bookings fetch (only when territory is selected)
   e. **Territory Notes:**
      - Display existing `notes` field from territory
      - "Edit" button to update notes (textarea + save button)

5. Use `useEffect` to animate panel entrance (translate-x-full -> translate-x-0)
6. Click outside panel or press Escape to close
  </action>
  <verify>
- Map markers are clickable and trigger onTerritoryClick
- Selected marker is visually highlighted
- Territory detail panel slides in from right
- Recent bookings section fetches and displays correctly (query returns up to 5 bookings for selected territory's postcode_sector, ordered by shift_date desc)
- Recent bookings only fetch when territory is selected (TanStack Query enabled: !!territory)
- Medic "Change" button triggers assignment mutation
- Panel closes on Escape key and outside click
  </verify>
  <done>
Territory map markers are clickable, opening a detail panel showing assigned medics, utilization metrics, recent bookings, and territory notes. Selected marker is visually highlighted on the map.
  </done>
</task>

<task type="auto">
  <name>Task 2a: Add summary stats bar and tab navigation scaffold to territories page</name>
  <files>web/app/admin/territories/page.tsx</files>
  <action>
Update the territories page.tsx to add the page scaffold:

1. **Summary Stats Bar** below the existing header:
   - Import `aggregateTerritoryMetrics` from `@/lib/territory/metrics.ts`
   - Display in a row of stat cards: Total territories, Assigned (have primary medic), Unassigned (no primary medic), Avg Utilization %, Active Alerts count
   - Style as a flex row with gap-4, each card is a small rounded box with label and value

2. **Tab Navigation** below the stats bar:
   - Add state: `const [activeTab, setActiveTab] = useState<'coverage' | 'assignment'>('coverage')`
   - Render two tab buttons: "Coverage Map" and "Assignment Manager"
   - Active tab has blue border-bottom and white text, inactive has gray text
   - Below tabs, conditionally render content based on `activeTab`

3. **Coverage Map Tab content (placeholder wiring):**
   - Render existing TerritoryMap and TerritoryList (as they currently are)
   - Keep existing map and list rendering unchanged for now

4. **Assignment Manager Tab content (placeholder):**
   - Import AssignmentPanel from `./assignment-panel` (from Plan 03)
   - Render `<AssignmentPanel />` when activeTab === 'assignment'

5. **Change useTerritories refetchInterval** from 60000 to 300000 (5 minutes) to match Success Criteria #9.
  </action>
  <verify>
- Summary stats bar renders with correct counts from aggregateTerritoryMetrics
- Tab navigation switches between "Coverage Map" and "Assignment Manager"
- Coverage Map tab shows existing map and territory list
- Assignment Manager tab shows AssignmentPanel component
- useTerritories polling is 300000 (5 minutes)
  </verify>
  <done>
Territories page has summary stats bar with territory health overview and tab navigation between Coverage Map and Assignment Manager views. Polling interval set to 5 minutes.
  </done>
</task>

<task type="auto">
  <name>Task 2b: Integrate coverage alerts and hiring panel into Coverage Map tab</name>
  <files>web/app/admin/territories/page.tsx</files>
  <action>
Update the Coverage Map tab section in page.tsx:

1. **Import and render CoverageAlerts** from `./coverage-alerts` (from Plan 04):
   - Place above the map, inside the Coverage Map tab
   - Pass `territories` prop from useTerritories data
   - Make collapsible (default expanded)

2. **Import and render HiringPanel** from `./hiring-panel` (from Plan 04):
   - Place below CoverageAlerts, above the map
   - Pass `territories` prop
   - Make collapsible (default collapsed)

3. **Page layout order within Coverage Map tab:**
   - CoverageAlerts (collapsible, expanded by default)
   - HiringPanel (collapsible, collapsed by default)
   - Enhanced TerritoryMap (50vh height)
   - TerritoryList (scrollable below map)
  </action>
  <verify>
- CoverageAlerts component renders with territory data
- HiringPanel component renders with territory data
- Both components are collapsible
- Layout order is: alerts -> hiring -> map -> list
  </verify>
  <done>
Coverage gap alerts and hiring recommendation panels integrated into Coverage Map tab with collapsible sections.
  </done>
</task>

<task type="auto">
  <name>Task 2c: Wire map/list click handlers and territory detail panel state</name>
  <files>web/app/admin/territories/page.tsx</files>
  <action>
Add territory selection and detail panel integration to page.tsx:

1. **State management:**
   - Add: `const [selectedTerritory, setSelectedTerritory] = useState<TerritoryWithMetrics | null>(null)`

2. **Wire TerritoryMap click handler:**
   - Pass `onTerritoryClick={setSelectedTerritory}` to TerritoryMap
   - Pass `selectedTerritoryId={selectedTerritory?.id}` for map highlight

3. **Wire TerritoryList click handler:**
   - Add `onRowClick={setSelectedTerritory}` prop to TerritoryList (or wrap rows with onClick)
   - Add cursor-pointer styling on hover for territory rows

4. **Render TerritoryDetail panel:**
   - Import TerritoryDetail from `./territory-detail` (from Task 1 of this plan)
   - Render `<TerritoryDetail territory={selectedTerritory} onClose={() => setSelectedTerritory(null)} />` conditionally when selectedTerritory is not null
   - Panel slides in from right, overlaying map on mobile (<lg) or side-by-side on desktop (>=lg)

5. **Responsive layout:**
   - On mobile (<lg): detail panel overlays as full-width sheet
   - On desktop (>=lg): detail panel is w-96 side panel, map/list shrinks to accommodate
  </action>
  <verify>
- Clicking territory marker on map opens detail panel with correct territory data
- Clicking territory row in list opens detail panel
- Detail panel closes when close button or Escape is pressed
- setSelectedTerritory(null) clears the panel
- Responsive layout works: overlay on mobile, side-by-side on desktop
- Assignment changes from detail panel update map and list via query invalidation
  </verify>
  <done>
Map and list territory click handlers wired to open detail panel. Territory detail panel integrates as responsive side panel with full territory info including recent bookings and auto-assignment scores.
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify auto-assignment 95% success rate with simulated bookings</name>
  <files>web/lib/territory/__tests__/auto-assignment-success-rate.test.ts</files>
  <action>
Create a test file `web/lib/territory/__tests__/auto-assignment-success-rate.test.ts` that validates the auto-assignment algorithm achieves a 95% success rate:

1. **Generate 100 simulated bookings** with realistic variation:
   - Distribute across 20 postcode sectors (5 bookings each)
   - Mix of shift types: standard (70%), confined_space_required (15%), trauma_specialist_required (15%)
   - Shift dates spread across 2 weeks (weekdays only)
   - Random shift_start_time between 08:00-14:00

2. **Generate 30 simulated medics** with realistic profiles:
   - Each assigned to 1-3 primary territories
   - Utilization ranging from 20% to 90%
   - Rating ranging from 3.5 to 5.0
   - 60% have confined_space cert, 40% have trauma cert
   - All have available_for_work = true

3. **Run `rankMedicsForBooking()`** from `web/lib/territory/auto-assignment.ts` for each of the 100 bookings against the medic pool:
   - A booking is "successfully matched" if `rankMedicsForBooking()` returns at least 1 candidate with `is_available === true` AND `has_required_certs === true` AND `total_score > 0`
   - Count successes vs failures

4. **Assert success rate >= 95%:**
   ```typescript
   const successRate = successCount / 100;
   expect(successRate).toBeGreaterThanOrEqual(0.95);
   ```

5. **Log detailed failure analysis** for any booking that fails to match:
   - Which postcode sector had no candidates
   - Was it a cert requirement issue or an availability issue
   - This helps identify if the algorithm needs tuning

Import `rankMedicsForBooking` from `@/lib/territory/auto-assignment` and create mock MedicWithMetrics objects.

This test validates Success Criteria #11: "Auto-assignment successfully matches 95% of bookings (tested with 100 simulated bookings)".
  </action>
  <verify>
- Test file runs with `cd web && pnpm test auto-assignment-success-rate`
- Test passes with success rate >= 95%
- Failure analysis log shows reasons for any unmatched bookings
  </verify>
  <done>
Auto-assignment algorithm verified to achieve 95%+ success rate against 100 simulated bookings with varied postcodes, shift types, and medic profiles. Any failures are logged with root cause analysis.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Full territory management admin page with:
- Coverage map with clickable markers and 5-minute auto-refresh
- Drag-drop medic assignment panel
- Coverage gap alerts with severity styling
- Hiring recommendation panel grouped by region
- Territory detail panel with recent bookings
- Tab navigation between coverage view and assignment view
- Auto-assignment algorithm verified at 95%+ success rate with 100 simulated bookings
  </what-built>
  <how-to-verify>
1. Run `pnpm dev` on port 30500
2. Navigate to `/admin/territories`
3. Verify Coverage Map tab:
   a. Map loads with colored markers
   b. Click a marker -- detail panel slides in from right with territory info
   c. Coverage gap alerts show (if any territories have >10% rejection rate)
   d. Hiring recommendations show (if any territories have >80% utilization)
4. Switch to Assignment Manager tab:
   a. Medic cards show on left with utilization bars
   b. Territory list shows on right with drop zones
   c. Drag a medic card onto a territory's primary/secondary slot
   d. Assignment should persist (refresh page to confirm)
5. Verify summary stats bar shows correct counts
6. Verify 5-minute polling (or check network tab for refetch interval)
7. Run `cd web && pnpm test auto-assignment-success-rate` and confirm 95%+ pass rate
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Coverage map displays color-coded territories with working click interaction
2. Territory detail panel shows: assigned medic, stats, recent bookings
3. Assignment panel allows drag-drop medic assignment
4. All Plan 03 and Plan 04 components render correctly in integrated page
5. Tab navigation works between coverage view and assignment view
6. 5-minute polling updates map markers
7. Summary stats bar shows accurate territory health overview
</verification>

<success_criteria>
- Visual coverage map updates with 5-minute refresh and color-coded utilization (SC #9)
- Admin can click postcode sector to see assigned medic, stats, recent bookings (SC #10)
- Drag-drop assignment works from Assignment Manager tab (SC #2)
- Coverage gaps and hiring triggers display correctly (SC #7, #8)
- All components integrate into cohesive tabbed interface
</success_criteria>

<output>
After completion, create `.planning/phases/07.5-territory-auto-assignment/07.5-05-SUMMARY.md`
</output>
