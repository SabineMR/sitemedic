---
phase: 07.5-territory-auto-assignment
plan: 03
subsystem: ui
tags: [dnd-kit, drag-drop, react, tanstack-query, supabase]

# Dependency graph
requires:
  - phase: 07.5-01
    provides: Territory metrics aggregation and TerritoryWithMetrics type
  - phase: 07.5-02
    provides: Client-side auto-assignment scoring module (calculateAutoMatchScore, formatScoreBreakdown)
provides:
  - Drag-drop territory assignment UI with @dnd-kit/core
  - API endpoint for territory medic assignments (POST /api/admin/territories/assign)
  - TanStack Query mutations with optimistic updates (useAssignMedicToTerritory, useUnassignMedic)
  - Keyboard-accessible alternative to drag-drop (Select dropdown + Assign button)
  - Self-contained AssignmentPanel component ready for page integration
affects: [07.5-05]

# Tech tracking
tech-stack:
  added: ["@dnd-kit/core for drag-and-drop", "optimistic updates pattern"]
  patterns: ["Split-pane layout for drag-source and drop-target", "DragOverlay for visual feedback", "Keyboard fallback for accessibility"]

key-files:
  created:
    - web/app/admin/territories/assignment-panel.tsx
    - web/app/api/admin/territories/assign/route.ts
  modified:
    - web/lib/queries/admin/territories.ts

key-decisions:
  - "Use @dnd-kit/core (not useSortable) for free drag between sidebar and table"
  - "Optimistic updates show assignment immediately, rollback on error"
  - "Keyboard fallback required for WCAG compliance and gloves-on use"
  - "Medic search and availability filter in sidebar for large medic rosters"

patterns-established:
  - "Pattern 1: Drag-drop with accessible keyboard fallback (DndContext + Select dropdown)"
  - "Pattern 2: Split droppable ID format (territoryId:role) for multi-target drops"
  - "Pattern 3: Utilization color coding consistent across admin UI (green <50%, yellow 50-80%, red >80%)"

# Metrics
duration: 4min
completed: 2026-02-17
---

# Phase 07.5 Plan 03: Drag-Drop Assignment Panel Summary

**Drag-drop territory assignment UI with @dnd-kit, optimistic TanStack Query mutations, and keyboard-accessible fallback for medic-to-territory assignment**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-17T01:08:01Z
- **Completed:** 2026-02-17T01:12:00Z (approx)
- **Tasks:** 3
- **Files modified:** 2 (1 created, 1 modified)

## Accomplishments
- Admin can drag medics from sidebar onto territory primary/secondary slots
- Assignment persists to database with instant optimistic UI update
- Keyboard alternative (Select + Assign button) provides WCAG accessibility
- Medic cards show utilization bars, territory count, star rating, and availability status
- Territory drop zones highlight on hover and show assigned medic with unassign button

## Task Commits

Each task was committed atomically:

1. **Task 1: Create territory assignment API route and mutation hook** - `390ac82` (feat) - NOTE: Committed in prior 07.5-04 execution
2. **Task 2: Build drag-drop assignment panel with dnd-kit** - `8b7804a` (feat)
3. **Task 3: Verify assignment panel renders independently and is importable** - `03a4d53` (test)

**Plan metadata:** (will be added in final commit)

_Note: Task 1 (API + mutations) was already committed in 07.5-04 execution (390ac82). This execution completed Tasks 2-3._

## Files Created/Modified
- `web/app/admin/territories/assignment-panel.tsx` - Split-pane drag-drop assignment UI with DndContext, draggable medic cards, droppable territory slots, keyboard fallback, and medic search/filter
- `web/app/api/admin/territories/assign/route.ts` - POST endpoint handling territory medic assignments with org_id validation, supports both assign (medic_id) and unassign (null) operations
- `web/lib/queries/admin/territories.ts` - Added useAssignMedicToTerritory and useUnassignMedic mutations with optimistic updates, rollback on error, and automatic query invalidation

## Decisions Made

**D-07.5-03-001:** Use @dnd-kit/core useDraggable (not useSortable) for free drag-drop
- **Rationale:** Medics drag from sidebar to territory table (not list reordering), requires free positioning not constrained sorting

**D-07.5-03-002:** Split droppable ID format `{territoryId}:{role}` for multi-target drops
- **Rationale:** Each territory has two drop zones (primary and secondary), ID format enables single onDragEnd handler to extract both territory and role

**D-07.5-03-003:** Optimistic updates with rollback on mutation error
- **Rationale:** Instant UI feedback for drag-drop feels natural, matches useUpdateMedicAvailability pattern from medics.ts, rollback prevents UI state mismatch on failure

**D-07.5-03-004:** Keyboard fallback via Select dropdown + Assign button
- **Rationale:** Drag-drop not accessible to keyboard-only users or gloves-on medics, WCAG requires keyboard alternative, Select provides searchable dropdown for large medic lists

**D-07.5-03-005:** API route handles both assign and unassign (medic_id can be null)
- **Rationale:** Single endpoint simplifies logic, null medic_id triggers unassign, reduces API surface area

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**Task 1 files already committed:** API route and mutation hooks were already created in 07.5-04 execution (commit 390ac82). This execution completed the AssignmentPanel component (Tasks 2-3) which was missing from prior execution.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Plan 07.5-05:** AssignmentPanel component verified as self-contained and importable. Plan 05 will wire it into territories page.tsx via tab navigation along with CoverageAlerts and HiringPanel components.

**Component contract:**
- Default export: `AssignmentPanel`
- Props: None (fetches own data via hooks)
- Dependencies: useMedics(), useTerritories(), useAssignMedicToTerritory(), useUnassignMedic()

---
*Phase: 07.5-territory-auto-assignment*
*Completed: 2026-02-17*
