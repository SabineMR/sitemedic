---
phase: 07.5-territory-auto-assignment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/auto-assign-medic-v2/index.ts
  - web/lib/territory/auto-assignment.ts
autonomous: true

must_haves:
  truths:
    - "Auto-assignment ranks medics by: distance -> utilization (<70% preferred) -> qualifications -> availability -> rating (>4.5 stars)"
    - "Calendar availability check prevents double-booking (existing bookings on same shift_date block assignment)"
    - "Auto-assignment logs confidence score and ranking breakdown for each candidate"
    - "Medics with expired certifications are excluded from candidate pool"
  artifacts:
    - path: "supabase/functions/auto-assign-medic-v2/index.ts"
      provides: "Enhanced auto-assignment Edge Function with calendar check and cert validation"
      contains: "findCandidateMedics"
    - path: "web/lib/territory/auto-assignment.ts"
      provides: "Client-side scoring transparency for admin review"
      exports: ["rankMedicsForBooking", "AutoAssignmentScore", "calculateAutoMatchScore"]
  key_links:
    - from: "supabase/functions/auto-assign-medic-v2/index.ts"
      to: "bookings table"
      via: "calendar conflict check query"
      pattern: "bookings.*shift_date"
    - from: "web/lib/territory/auto-assignment.ts"
      to: "web/lib/queries/admin/medics.ts"
      via: "MedicWithMetrics type import"
      pattern: "import.*MedicWithMetrics"
---

<objective>
Enhance the auto-assignment algorithm to include calendar availability checking, certification validation, and transparent scoring for admin review. Create a client-side scoring module for the admin UI.

Purpose: Success Criteria #3 requires medics ranked by distance -> utilization -> qualifications -> availability -> rating. The existing V2 Edge Function has 7-factor scoring but needs calendar conflict checking and certification expiry validation. A client-side scoring module enables the admin to see WHY a medic was ranked #1.

Output: Enhanced Edge Function with calendar check, client-side auto-assignment scoring module.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.5-territory-auto-assignment/07.5-RESEARCH.md

Key existing files:
@supabase/functions/auto-assign-medic-v2/index.ts (existing 7-factor scoring algorithm)
@web/lib/queries/admin/medics.ts (MedicWithMetrics type)
@web/lib/bookings/out-of-territory.ts (travel cost calculation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance auto-assign Edge Function with calendar check and cert validation</name>
  <files>supabase/functions/auto-assign-medic-v2/index.ts</files>
  <action>
Read the existing auto-assign-medic-v2/index.ts fully, then enhance the `findCandidateMedics` function:

1. **Calendar availability check:** Insert this step AFTER `findCandidateMedics` returns the initial candidate array but BEFORE the scoring loop begins. Specifically:
   a. Collect all candidate medic IDs into a `candidateIds` array from the `findCandidateMedics` result.
   b. Execute a single batch query: `supabase.from('bookings').select('medic_id, shift_date, shift_start_time, shift_end_time').in('medic_id', candidateIds).eq('shift_date', requestedShiftDate).in('status', ['confirmed', 'in_progress'])`.
   c. Build a `Set<string>` of medic IDs that have conflicting bookings (where existing shift times overlap the requested shift_start_time through shift_end_time).
   d. Filter the candidate array to remove any medic whose ID is in the conflict set: `candidates = candidates.filter(c => !conflictSet.has(c.medic_id))`.
   e. Only THEN proceed to the scoring loop over the remaining candidates.
   This ensures the calendar check uses a single batch query (not N+1) and is integrated between candidate retrieval and scoring.

2. **Certification validation:** Check if the booking requires `confined_space_required` or `trauma_specialist_required`. If so, filter out medics who lack the corresponding `has_confined_space_cert` or `has_trauma_cert`. This is a hard filter (not a scoring factor).

3. **Adjust scoring weights** to match Success Criteria #3 ranking priority:
   - Distance: 30% (was 25%) -- highest priority per requirements
   - Utilization: 20% (was 15%) -- prefer <70% utilization per requirements
   - Qualifications: 15% (was 20%) -- already hard-filtered, bonus for extra certs
   - Availability: 15% (unchanged) -- includes territory proximity
   - Rating: 15% (was 10%) -- prefer >4.5 stars per requirements
   - Performance: 5% (was 10%) -- RIDDOR compliance bonus

4. **Utilization preference:** In the utilization scoring, give maximum points (20) to medics with <70% utilization (matches "prefer <70%"), linearly decrease for 70-100%.

5. **Rating bonus:** Give bonus points when rating >4.5 stars (matches requirement "rating >4.5 stars").

6. **Log the scoring breakdown** in the auto_schedule_logs table for each assignment attempt, including all candidate scores for admin transparency.

IMPORTANT: Preserve all existing functionality. Only modify the scoring weights, add calendar check, and add cert validation. Do NOT change the function signature or response format.
  </action>
  <verify>
Review the modified Edge Function for:
- Calendar conflict query is batch (not N+1 loop) and is placed AFTER findCandidateMedics but BEFORE the scoring loop
- Candidates with conflicting bookings are filtered out before scoring begins
- Certification filtering uses hard filter (not scoring)
- Scoring weights sum to 100%
- Utilization prefers <70% (gives max points below 70%)
- Rating bonus for >4.5 stars
- Auto_schedule_logs includes full scoring breakdown
  </verify>
  <done>
Auto-assignment Edge Function enhanced with calendar conflict checking (prevents double-booking), certification validation (hard filter), adjusted scoring weights matching Phase 7.5 requirements, and full scoring breakdown logging for admin transparency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client-side auto-assignment scoring module</name>
  <files>web/lib/territory/auto-assignment.ts</files>
  <action>
Create `web/lib/territory/auto-assignment.ts` that mirrors the Edge Function scoring logic for client-side transparency:

1. **AutoAssignmentScore interface:**
```typescript
export interface AutoAssignmentScore {
  medic_id: string;
  medic_name: string;
  total_score: number; // 0-100
  distance_score: number; // 0-30
  utilization_score: number; // 0-20
  qualification_score: number; // 0-15
  availability_score: number; // 0-15
  rating_score: number; // 0-15
  performance_score: number; // 0-5
  is_primary_territory: boolean;
  is_available: boolean;
  has_required_certs: boolean;
  travel_time_minutes: number | null;
  utilization_pct: number;
}
```

2. **calculateAutoMatchScore function:** Takes a medic (MedicWithMetrics) and booking parameters (postcode, requirements), returns AutoAssignmentScore. This is a pure function that uses the same formulas as the Edge Function but works with client-side data (no Google Maps API calls -- travel_time_minutes passed in from cached data).

3. **rankMedicsForBooking function:** Takes an array of MedicWithMetrics, booking parameters, and optional cached travel times. Returns sorted AutoAssignmentScore[] (highest score first). Filters out unavailable medics and those lacking required certs.

4. **formatScoreBreakdown function:** Takes AutoAssignmentScore, returns human-readable string showing each scoring dimension with percentage and raw value. Example: "Distance: 28/30 (12 min travel) | Utilization: 18/20 (45%) | ..."

Import MedicWithMetrics from `@/lib/queries/admin/medics`.

Add JSDoc comments explaining each scoring formula and WHY that weight was chosen (reference Phase 7.5 requirements).
  </action>
  <verify>
Check TypeScript compilation:
- All imports resolve
- AutoAssignmentScore interface is exportable
- rankMedicsForBooking returns correctly sorted array
- formatScoreBreakdown produces readable output
  </verify>
  <done>
Client-side auto-assignment scoring module provides transparent ranking visibility for admin UI. Mirrors Edge Function scoring logic so admin can see WHY each medic was ranked at their position.
  </done>
</task>

</tasks>

<verification>
1. Edge Function compiles in Deno (no TypeScript errors)
2. Calendar conflict check uses batch query (not N+1)
3. Scoring weights: distance 30 + utilization 20 + qualifications 15 + availability 15 + rating 15 + performance 5 = 100
4. Client-side scoring module exports all declared functions and types
5. Utilization scoring prefers <70% (max points below 70%)
</verification>

<success_criteria>
- Auto-assignment algorithm ranks by: distance -> utilization (<70% preferred) -> qualifications -> availability -> rating (>4.5 stars)
- Calendar availability check prevents double-booking
- Scoring breakdown logged for admin review
- Client-side module mirrors server scoring for UI transparency
</success_criteria>

<output>
After completion, create `.planning/phases/07.5-territory-auto-assignment/07.5-02-SUMMARY.md`
</output>
