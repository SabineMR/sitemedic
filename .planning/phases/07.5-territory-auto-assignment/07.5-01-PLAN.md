---
phase: 07.5-territory-auto-assignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/031_territory_metrics_cron.sql
  - web/lib/territory/metrics.ts
  - web/lib/territory/hiring-triggers.ts
  - web/lib/territory/coverage-gaps.ts
autonomous: true

must_haves:
  truths:
    - "Admin sees accurate territory metrics updated daily (utilization, rejection rate, fulfillment rate per postcode sector)"
    - "Admin receives hiring trigger alerts when territory utilization exceeds 80% for 3+ weeks or fulfillment drops below 90%"
    - "Coverage gap alerts only appear for territories with meaningful booking volume (10+ bookings), avoiding false positives"
    - "Admin can identify understaffed territories at a glance (high rejection rate, low fulfillment, high utilization visible in territory list)"
  artifacts:
    - path: "supabase/migrations/031_territory_metrics_cron.sql"
      provides: "pg_cron job for daily territory metrics aggregation"
      contains: "cron.schedule"
    - path: "web/lib/territory/metrics.ts"
      provides: "Utilization calculation logic with weekly aggregation"
      exports: ["calculateUtilization", "aggregateTerritoryMetrics"]
    - path: "web/lib/territory/hiring-triggers.ts"
      provides: "Hiring trigger detection with severity levels"
      exports: ["detectHiringTriggers", "HiringTrigger"]
    - path: "web/lib/territory/coverage-gaps.ts"
      provides: "Coverage gap detection with 3-week persistence and volume filter"
      exports: ["detectCoverageGaps", "CoverageGap"]
  key_links:
    - from: "supabase/migrations/031_territory_metrics_cron.sql"
      to: "territory_metrics table"
      via: "pg_cron INSERT INTO territory_metrics"
      pattern: "INSERT INTO territory_metrics"
    - from: "web/lib/territory/hiring-triggers.ts"
      to: "web/lib/territory/metrics.ts"
      via: "import metrics calculations"
      pattern: "import.*metrics"
---

<objective>
Create the territory metrics aggregation foundation: a pg_cron job that calculates daily territory metrics (utilization, rejection rate, fulfillment rate) and TypeScript business logic for hiring trigger detection and coverage gap analysis.

Purpose: The territory coverage map and hiring alerts need pre-aggregated metrics to avoid real-time query timeouts on 11,000+ territories. Daily metrics provide the data foundation for all UI components in subsequent plans.

Output: Migration file for pg_cron job, TypeScript modules for hiring triggers and coverage gap detection.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.5-territory-auto-assignment/07.5-RESEARCH.md

Key existing files:
@supabase/migrations/002_business_operations.sql (territory_metrics table schema)
@web/lib/queries/admin/territories.ts (existing territory queries, TerritoryWithMetrics type)
@web/lib/queries/admin/medics.ts (MedicWithMetrics type, utilization calculation pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pg_cron migration for daily territory metrics aggregation</name>
  <files>supabase/migrations/031_territory_metrics_cron.sql</files>
  <action>
Create migration `031_territory_metrics_cron.sql` that:

1. Adds `hiring_trigger_weeks` column to territory_metrics table (INT DEFAULT 0) to track consecutive weeks of high utilization.

2. Creates a pg_cron job scheduled at `'0 3 * * *'` (3 AM UTC daily) named `'aggregate-territory-metrics'` that:
   - Calculates metrics for each territory with bookings in the last 7 days
   - Counts total_bookings, confirmed_bookings, rejected_bookings per postcode_sector
   - Calculates rejection_rate as (rejected_bookings / total_bookings * 100) where total_bookings > 0
   - Calculates fulfillment_rate as (confirmed_bookings / total_bookings * 100) where total_bookings > 0
   - Calculates primary_medic_utilization as (confirmed bookings this week / 5 working days * 100), capped at 100
   - Uses UPSERT (ON CONFLICT postcode_sector, metric_date DO UPDATE) for idempotency
   - Joins territories table with bookings table on site_postcode matching territory postcode_sector
   - Filters bookings where shift_date >= CURRENT_DATE - INTERVAL '7 days'
   - Includes org_id in the territory_metrics table (add column if not exists via ALTER TABLE)

3. Adds a weekly hiring trigger aggregation job `'weekly-hiring-triggers'` scheduled `'0 4 * * 1'` (4 AM UTC every Monday) that:
   - Counts consecutive weeks where primary_medic_utilization > 80% per territory
   - Updates hiring_trigger_weeks column

Use the existing pg_cron pattern from supabase/migrations/021_friday_payout_cron.sql.

IMPORTANT: Check if org_id column already exists on territory_metrics before adding. Use `IF NOT EXISTS` pattern.
  </action>
  <verify>
Review migration SQL for syntax correctness. Verify:
- pg_cron schedule expressions are valid
- UPSERT uses correct ON CONFLICT columns (postcode_sector, metric_date)
- Aggregation query joins territories with bookings correctly
- org_id filtering is included
  </verify>
  <done>
Migration file creates daily metrics aggregation cron job and weekly hiring trigger accumulator. Territory metrics table extended with hiring_trigger_weeks tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript territory business logic modules</name>
  <files>web/lib/territory/metrics.ts, web/lib/territory/hiring-triggers.ts, web/lib/territory/coverage-gaps.ts</files>
  <action>
Create three TypeScript modules in `web/lib/territory/`:

**metrics.ts:**
- Export `calculateUtilization(confirmedBookings: number, workingDays?: number): number` -- returns 0-100 percentage, default 5 working days, capped at 100
- Export `aggregateTerritoryMetrics(territories: TerritoryWithMetrics[]): TerritoryMetricsSummary` -- returns totals for all territories (total assigned, unassigned, avg utilization, total bookings, avg rejection rate)
- Export `TerritoryMetricsSummary` interface

**hiring-triggers.ts:**
- Export `HiringTrigger` interface with fields: territory_id, postcode_sector, region, trigger_type ('high_utilization' | 'low_fulfillment' | 'coverage_gap'), severity ('info' | 'warning' | 'critical'), message (human-readable), metric_value, threshold, weeks_active (number of consecutive weeks)
- Export `detectHiringTriggers(territories: TerritoryWithMetrics[]): HiringTrigger[]`
  - High utilization: >80% for 3+ weeks = critical, >70% = warning
  - Low fulfillment: <90% AND total_bookings > 10 = critical
  - Coverage gap: rejection_rate >10% AND total_bookings > 10 = warning (>25% = critical)
  - Message format: "Hire medic in {region} ({postcode_sector} sectors, {utilization}% utilization)"
- Export `groupTriggersByRegion(triggers: HiringTrigger[]): Map<string, HiringTrigger[]>` for grouped display

**coverage-gaps.ts:**
- Export `CoverageGap` interface extending existing CoverageGapAlert from territories.ts with additional fields: weeks_persisting (number), minimum_volume_met (boolean), recommended_action (string)
- Export `detectCoverageGaps(territories: TerritoryWithMetrics[]): CoverageGap[]`
  - Filter territories with rejection_rate > 10%
  - Require minimum 10 bookings in analysis period (Pitfall 5 from research)
  - Calculate severity: warning (10-25%), critical (>25%)
  - Generate recommended_action: "Assign secondary medic" if no secondary, "Consider hiring" if both primary and secondary assigned and still high rejection
- Export `sortGapsBySeverity(gaps: CoverageGap[]): CoverageGap[]` -- critical first, then by rejection rate desc

Import TerritoryWithMetrics type from existing `@/lib/queries/admin/territories`.

Use JSDoc comments explaining WHY each threshold was chosen (reference research findings on 75-85% optimal utilization).
  </action>
  <verify>
Check that all three files export the correct types and functions. Verify:
- TypeScript compiles without errors: `cd web && npx tsc --noEmit web/lib/territory/metrics.ts web/lib/territory/hiring-triggers.ts web/lib/territory/coverage-gaps.ts` (or check IDE diagnostics)
- All imports resolve correctly
- No circular dependencies
  </verify>
  <done>
Three TypeScript modules provide territory business logic: metrics calculation, hiring trigger detection with severity levels and regional grouping, and coverage gap analysis with minimum volume filtering and recommended actions.
  </done>
</task>

</tasks>

<verification>
1. Migration file `031_territory_metrics_cron.sql` is valid SQL with pg_cron scheduling
2. TypeScript modules compile and export correct types
3. Hiring trigger thresholds match requirements: >80% utilization for 3+ weeks, fulfillment <90%, rejection >10%
4. Coverage gap detection includes minimum volume filter (>10 bookings) to prevent false positives
5. All functions are pure (no side effects, no database calls) for easy testing
</verification>

<success_criteria>
- pg_cron job will aggregate territory metrics daily at 3 AM UTC
- Hiring triggers detect 3 conditions: high utilization, low fulfillment, coverage gaps
- Coverage gap detection avoids false positives with minimum booking volume
- Business logic modules are importable by Plan 04 (UI) and Plan 05 (integration)
</success_criteria>

<output>
After completion, create `.planning/phases/07.5-territory-auto-assignment/07.5-01-SUMMARY.md`
</output>
