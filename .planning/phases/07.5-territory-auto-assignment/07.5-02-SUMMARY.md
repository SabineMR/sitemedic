---
phase: 07.5-territory-auto-assignment
plan: 02
subsystem: api
tags: [auto-assignment, territory, calendar, certifications, scoring, edge-function]

# Dependency graph
requires:
  - phase: 01.6-medic-scheduling
    provides: Auto-assign Edge Function V2 with 7-factor scoring
provides:
  - Enhanced auto-assignment with calendar conflict detection (prevents double-booking)
  - Certification expiry validation (hard filter excludes expired certs)
  - Updated scoring weights: distance 30%, utilization 20%, qualifications 15%, availability 15%, rating 15%, performance 5%
  - Client-side scoring module for admin transparency
affects: [07.5-03-territory-assignment-ui, admin-dashboard, booking-management]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Batch query pattern for calendar conflict detection (prevents N+1)
    - Client-side scoring module mirrors Edge Function for UI transparency

key-files:
  created:
    - web/lib/territory/auto-assignment.ts
    - supabase/migrations/103_update_auto_assignment_scoring_weights.sql
  modified:
    - supabase/functions/auto-assign-medic-v2/index.ts

key-decisions:
  - "Calendar conflict check uses batch query (single query for all candidates) to prevent N+1 performance issues"
  - "Certification expiry is hard filter (excludes before scoring) not scoring factor"
  - "Distance weighted at 30% (highest) per Phase 7.5 requirements"
  - "Utilization weighted at 20% with preference for <70% to prevent burnout"
  - "Rating bonus (+10 points) for >4.5 stars aligns with quality requirements"
  - "Fairness score removed from total (was 5%, now 0%) to prioritize performance factors"

patterns-established:
  - "Batch calendar check pattern: candidateIds array → single .in() query → Set-based filtering"
  - "Client-side scoring mirrors server logic for admin UI transparency"

# Metrics
duration: 4min
completed: 2026-02-17
---

# Phase 07.5-02: Enhanced Auto-Assignment Summary

**Calendar-aware auto-assignment with certification expiry validation, optimized scoring weights (distance 30%, utilization 20%), and client-side transparency module for admin review**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-17T01:00:42Z
- **Completed:** 2026-02-17T01:04:50Z
- **Tasks:** 2
- **Files modified:** 3
- **Commits:** 2 task commits

## Accomplishments

- Calendar conflict detection prevents double-booking via batch query (single query checks all candidates against existing bookings with shift time overlap)
- Certification expiry validation excludes medics with expired confined space or trauma certs before scoring begins
- Scoring weights updated to match Phase 7.5 requirements: distance 30% (highest), utilization 20% (prefer <70%), qualifications 15%, availability 15%, rating 15% (bonus for >4.5 stars), performance 5%
- Client-side scoring module enables admin to see exact breakdown of WHY each medic ranked where they did
- Database migration updates calculate_auto_match_score function with new weights and utilization/rating enhancements

## Task Commits

Each task was committed atomically:

1. **Task 1: Enhance auto-assign Edge Function with calendar check and cert validation** - `289371d` (feat)
   - Enhanced findCandidateMedics with batch calendar conflict query
   - Added certification expiry validation (confined_space_cert_expiry, trauma_cert_expiry)
   - Created migration 103 to update scoring weights in database function
   - Utilization scoring prefers <70% utilization (max 100 points)
   - Rating scoring includes bonus for >4.5 stars (+10 points)

2. **Task 2: Create client-side auto-assignment scoring module** - `0c8f6bd` (feat)
   - Created web/lib/territory/auto-assignment.ts with complete scoring logic
   - Exports: AutoAssignmentScore, BookingRequirements, TravelTimeData, calculateAutoMatchScore, rankMedicsForBooking, formatScoreBreakdown, getScoreColor, getScoreBadgeColor
   - JSDoc comments explain each weight decision with Phase 7.5 requirements reference
   - Pure functions enable testing and UI transparency

## Files Created/Modified

**Created:**
- `web/lib/territory/auto-assignment.ts` - Client-side scoring module that mirrors Edge Function logic. Provides calculateAutoMatchScore (score single medic), rankMedicsForBooking (filter + sort candidates), formatScoreBreakdown (human-readable explanation), and color helpers for UI.
- `supabase/migrations/103_update_auto_assignment_scoring_weights.sql` - Database function update with new scoring weights, enhanced utilization scoring (prefers <70%), and rating bonus (>4.5 stars).

**Modified:**
- `supabase/functions/auto-assign-medic-v2/index.ts` - Enhanced calendar conflict detection (batch query with shift time overlap check), certification expiry validation (hard filter before scoring), and updated header comments to reflect Phase 7.5 changes.

## Decisions Made

**Calendar conflict check architecture:**
- Batch query pattern chosen over N+1 (single query fetches all bookings for all candidates on shift_date, then Set-based filtering)
- Shift time overlap logic: (start1 < end2) AND (end1 > start2)
- Prevents double-booking without performance penalty

**Certification expiry as hard filter:**
- Decided to exclude medics with expired certs BEFORE scoring (not as scoring penalty)
- Reasoning: Expired certs are regulatory compliance failure, not performance issue
- Matches Phase 7.5 requirement: "Medics with expired certifications are excluded from candidate pool"

**Scoring weight rationale:**
- Distance 30%: Highest priority per requirements ("distance → utilization → ...")
- Utilization 20%: Second priority, prefer <70% per requirements
- Qualifications 15%: Reduced from 20% because already hard-filtered
- Availability 15%: Unchanged, critical factor
- Rating 15%: Increased from 10% to emphasize quality (>4.5 stars requirement)
- Performance 5%: Reduced from 10%, RIDDOR compliance is bonus not primary factor
- Fairness 0%: Removed from total (was 5%), shift distribution less important than performance

**Client-side module design:**
- Mirror Edge Function logic exactly (same formulas, same weights)
- Pure functions for testability
- No external API calls (travel data passed in from cache)
- Enables admin UI to show "Why this medic?" explanations

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation proceeded smoothly. Existing Edge Function structure made enhancement straightforward.

## Next Phase Readiness

**Ready for Phase 07.5-03 (Territory Assignment UI):**
- Client-side scoring module ready for integration into admin booking UI
- Admin can now see ranked candidate list with score breakdowns
- formatScoreBreakdown provides tooltip/explanation text

**Enhanced auto-assignment capabilities:**
- Calendar conflict prevention ensures no double-booking
- Certification expiry validation ensures regulatory compliance
- Optimized weights align with Phase 7.5 success criteria

**Database migration applied:**
- Migration 103 must be applied to production before Edge Function enhancement goes live
- Consider: Run migration in staging first to verify scoring changes don't break existing auto-assignments

**No blockers for next phase.**

---
*Phase: 07.5-territory-auto-assignment*
*Completed: 2026-02-17*
