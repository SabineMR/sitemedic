---
phase: 07.5-territory-auto-assignment
plan: 04
type: execute
wave: 2
depends_on: ["07.5-01"]
files_modified:
  - web/app/admin/territories/coverage-alerts.tsx
  - web/app/admin/territories/hiring-panel.tsx
  - web/lib/queries/admin/territories.ts
autonomous: true

must_haves:
  truths:
    - "Coverage gap alerts show when rejection rate >10% in a territory for 3+ weeks with >10 bookings"
    - "Hiring recommendations display: 'Hire medic in {Region} ({sectors}, {utilization}% utilization)'"
    - "Alerts are grouped by region for actionable overview"
    - "Warning and critical severity levels use distinct visual styling (yellow/red)"
  artifacts:
    - path: "web/app/admin/territories/coverage-alerts.tsx"
      provides: "Coverage gap alert panel with severity-based styling"
      contains: "CoverageGap"
    - path: "web/app/admin/territories/hiring-panel.tsx"
      provides: "Hiring trigger recommendations grouped by region"
      contains: "HiringTrigger"
    - path: "web/lib/queries/admin/territories.ts"
      provides: "Updated territory queries with hiring trigger data"
      contains: "hiring_trigger_weeks"
  key_links:
    - from: "web/app/admin/territories/coverage-alerts.tsx"
      to: "web/lib/territory/coverage-gaps.ts"
      via: "detectCoverageGaps function import"
      pattern: "import.*detectCoverageGaps"
    - from: "web/app/admin/territories/hiring-panel.tsx"
      to: "web/lib/territory/hiring-triggers.ts"
      via: "detectHiringTriggers function import"
      pattern: "import.*detectHiringTriggers"
---

<objective>
Build the coverage gap detection alerts and hiring trigger recommendation panels for the territory admin page. These components consume the business logic from Plan 01 to display actionable alerts to the admin.

Purpose: Success Criteria #7 requires coverage gap alerts when rejection rate >10% for 3+ weeks. Success Criteria #8 requires hiring recommendations like "Hire medic in North London (N1-N22 sectors, 85% utilization)". This plan creates the UI components that surface these alerts.

Output: Coverage alerts component, hiring recommendations panel, updated territory query to include hiring trigger data.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.5-territory-auto-assignment/07.5-RESEARCH.md
@.planning/phases/07.5-territory-auto-assignment/07.5-01-SUMMARY.md

Key existing files:
@web/lib/territory/hiring-triggers.ts (detectHiringTriggers, HiringTrigger, groupTriggersByRegion -- from Plan 01)
@web/lib/territory/coverage-gaps.ts (detectCoverageGaps, CoverageGap, sortGapsBySeverity -- from Plan 01)
@web/lib/queries/admin/territories.ts (TerritoryWithMetrics, calculateCoverageGaps -- existing)
@web/app/admin/territories/page.tsx (existing territories page where these components will be mounted)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build coverage gap alerts and hiring recommendations components</name>
  <files>web/app/admin/territories/coverage-alerts.tsx, web/app/admin/territories/hiring-panel.tsx</files>
  <action>
**coverage-alerts.tsx:**

Create a 'use client' component `CoverageAlerts` that:
1. Accepts `territories: TerritoryWithMetrics[]` prop
2. Calls `detectCoverageGaps(territories)` from `@/lib/territory/coverage-gaps`
3. Calls `sortGapsBySeverity()` to order critical gaps first
4. Renders a collapsible panel with header "Coverage Gaps ({count})"
5. Each gap displays:
   - Severity badge (red "Critical" or yellow "Warning")
   - Postcode sector and region
   - Rejection rate as percentage with absolute numbers ("5/50 rejected")
   - Weeks persisting (if available from metrics)
   - Recommended action text
   - "View Territory" button that scrolls to territory in list
6. If no gaps, show a green checkmark with "All territories have healthy coverage"
7. Use shadcn Alert component with variant based on severity
8. Style: critical = red border + bg-red-500/10, warning = yellow border + bg-yellow-500/10

**hiring-panel.tsx:**

Create a 'use client' component `HiringPanel` that:
1. Accepts `territories: TerritoryWithMetrics[]` prop
2. Calls `detectHiringTriggers(territories)` from `@/lib/territory/hiring-triggers`
3. Calls `groupTriggersByRegion()` to group triggers by region
4. Renders a panel with header "Hiring Recommendations"
5. Groups hiring triggers by region with each region as a collapsible section:
   - Region name as header with count badge
   - Each trigger shows: severity icon, message, metric value vs threshold, trigger type badge
6. Trigger types styled distinctly:
   - high_utilization: orange icon (TrendingUp from lucide-react)
   - low_fulfillment: red icon (AlertTriangle)
   - coverage_gap: yellow icon (MapPin)
7. Critical triggers show a pulsing red dot indicator
8. Message format matches requirement: "Hire medic in North London (N1-N22 sectors, 85% utilization)"
9. If no triggers, show "No hiring recommendations. All territories operating within normal parameters."

Both components use the existing dark admin UI theme (gray-800/50 backgrounds, white text, border-gray-700/50).
  </action>
  <verify>
- CoverageAlerts renders gaps sorted by severity
- HiringPanel groups triggers by region
- Severity styling uses correct colors (red=critical, yellow=warning)
- Both components handle empty state gracefully
- Message format matches: "Hire medic in {Region} ({sectors}, {utilization}% utilization)"
  </verify>
  <done>
Coverage gap alerts display territories with >10% rejection rate, grouped by severity with recommended actions. Hiring recommendations panel groups triggers by region with severity indicators and actionable messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update territory query and wire components into territories page</name>
  <files>web/lib/queries/admin/territories.ts, web/app/admin/territories/page.tsx</files>
  <action>
**Update territories.ts:**

1. Add `hiring_trigger_weeks` to the TerritoryWithMetrics interface (number, defaults to 0)
2. Update `fetchTerritoriesWithMetrics()` to also fetch the `hiring_trigger_weeks` field from territory_metrics table (if it exists)
3. Map hiring_trigger_weeks into the returned TerritoryWithMetrics objects
4. Update the `calculateCoverageGaps()` function to also check `total_bookings > 10` minimum volume filter (matching Plan 01 logic). Currently it only checks rejection_rate > 10% but per Pitfall 5, low-volume territories cause false positives.

**Update page.tsx:**

1. Import the new `CoverageAlerts` and `HiringPanel` components
2. Replace the existing inline coverage gap alerts section with `<CoverageAlerts territories={territories} />`
3. Add `<HiringPanel territories={territories} />` below the CoverageAlerts, above the map
4. Add a summary stats bar between header and alerts showing:
   - Total territories count
   - Assigned (have primary medic) count
   - Unassigned (no primary medic) count
   - Average utilization percentage
   - Active hiring alerts count
5. Use the `aggregateTerritoryMetrics()` from `@/lib/territory/metrics.ts` for the summary

Keep the existing map and territory list sections unchanged.
  </action>
  <verify>
- TerritoryWithMetrics type includes hiring_trigger_weeks
- calculateCoverageGaps includes minimum volume filter
- Territories page renders CoverageAlerts, HiringPanel, summary stats, map, and territory list
- No TypeScript errors from updated types
  </verify>
  <done>
Territory query extended with hiring trigger data. Territories page now shows: summary stats bar -> coverage gap alerts -> hiring recommendations -> coverage map -> territory list. Coverage gaps filter out low-volume false positives.
  </done>
</task>

</tasks>

<verification>
1. Coverage gap alerts fire when rejection rate >10% AND total bookings >10
2. Hiring recommendations display with region grouping and correct message format
3. Territories page renders all sections in correct order
4. Summary stats bar shows territory counts and average utilization
5. Both components handle empty state (no gaps, no triggers)
6. Severity styling is visually distinct (red critical, yellow warning)
</verification>

<success_criteria>
- Coverage gap alerts trigger when booking rejection rate >10% in territory with minimum volume
- Hiring recommendations display: "Hire medic in {Region} ({sectors}, {utilization}% utilization)"
- Alerts grouped by severity and region for actionable admin overview
- Summary stats provide quick territory health overview
</success_criteria>

<output>
After completion, create `.planning/phases/07.5-territory-auto-assignment/07.5-04-SUMMARY.md`
</output>
