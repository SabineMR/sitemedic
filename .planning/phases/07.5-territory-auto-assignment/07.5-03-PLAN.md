---
phase: 07.5-territory-auto-assignment
plan: 03
type: execute
wave: 2
depends_on: ["07.5-01", "07.5-02"]
files_modified:
  - web/app/admin/territories/assignment-panel.tsx
  - web/app/api/admin/territories/assign/route.ts
  - web/lib/queries/admin/territories.ts
autonomous: true

must_haves:
  truths:
    - "Admin can drag a medic card and drop it onto a territory to assign as primary or secondary"
    - "Assignment persists to database and updates territory list immediately via optimistic update"
    - "Medic list shows available medics with utilization bars and territory count"
    - "Keyboard fallback exists for medic assignment (Assign button as alternative to drag-drop)"
  artifacts:
    - path: "web/app/admin/territories/assignment-panel.tsx"
      provides: "Drag-drop medic-to-territory assignment UI with dnd-kit"
      contains: "DndContext"
    - path: "web/app/api/admin/territories/assign/route.ts"
      provides: "API route for updating territory medic assignments"
      exports: ["POST"]
    - path: "web/lib/queries/admin/territories.ts"
      provides: "New useAssignMedicToTerritory mutation hook"
      contains: "useAssignMedicToTerritory"
  key_links:
    - from: "web/app/admin/territories/assignment-panel.tsx"
      to: "web/lib/queries/admin/territories.ts"
      via: "useAssignMedicToTerritory mutation"
      pattern: "useAssignMedicToTerritory"
    - from: "web/app/api/admin/territories/assign/route.ts"
      to: "supabase territories table"
      via: "UPDATE territories SET primary_medic_id or secondary_medic_id"
      pattern: "territories.*update"
    - from: "web/app/admin/territories/assignment-panel.tsx"
      to: "@dnd-kit/core"
      via: "DndContext + drag-drop handlers"
      pattern: "DndContext.*onDragEnd"
    - from: "web/app/admin/territories/assignment-panel.tsx"
      to: "web/lib/territory/auto-assignment.ts"
      via: "calculateAutoMatchScore and formatScoreBreakdown for medic ranking display"
      pattern: "import.*auto-assignment"
---

<objective>
Build the admin drag-drop assignment panel where medics can be dragged onto territory rows to assign them as primary or secondary medic. Create the API route for persisting assignments and the TanStack Query mutation with optimistic updates.

Purpose: Success Criteria #2 requires admin to assign primary + secondary medic to postcode sectors via drag-drop. This plan creates the interactive assignment UI using dnd-kit (already installed) with optimistic updates for instant feedback.

Output: Drag-drop assignment panel component, territory assignment API route, TanStack Query mutation hook.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.5-territory-auto-assignment/07.5-RESEARCH.md
@.planning/phases/07.5-territory-auto-assignment/07.5-01-SUMMARY.md
@.planning/phases/07.5-territory-auto-assignment/07.5-02-SUMMARY.md

Key existing files:
@web/lib/queries/admin/territories.ts (TerritoryWithMetrics, useTerritories, fetchTerritoriesWithMetrics)
@web/lib/queries/admin/medics.ts (MedicWithMetrics, useMedics, useUpdateMedicAvailability -- pattern for optimistic mutations)
@web/app/admin/territories/page.tsx (existing territories page)
@web/components/admin/territory-list.tsx (existing territory table)
@web/lib/territory/auto-assignment.ts (client-side scoring module from Plan 02: calculateAutoMatchScore, formatScoreBreakdown)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create territory assignment API route and mutation hook</name>
  <files>web/app/api/admin/territories/assign/route.ts, web/lib/queries/admin/territories.ts</files>
  <action>
**API Route (`web/app/api/admin/territories/assign/route.ts`):**

Create a POST endpoint that:
1. Accepts JSON body: `{ territory_id: string, medic_id: string, role: 'primary' | 'secondary' }`
2. Validates the user is authenticated using Supabase SSR cookie-based auth (import `createClient` from `@/lib/supabase/server`)
3. Updates the territories table:
   - If role is 'primary': SET primary_medic_id = medic_id
   - If role is 'secondary': SET secondary_medic_id = medic_id
4. Validates that the medic exists in the medics table before assignment
5. Returns 200 with updated territory data
6. Returns 400 for invalid input, 401 for unauthorized, 404 for missing territory/medic
7. Include org_id check: verify territory belongs to user's org

Follow the existing API route patterns (e.g., check how other admin API routes handle auth and org_id).

**Mutation Hook (add to `web/lib/queries/admin/territories.ts`):**

Add `useAssignMedicToTerritory()` mutation hook following the EXACT pattern from `useUpdateMedicAvailability()` in medics.ts:
1. `mutationFn`: POST to `/api/admin/territories/assign` with territory_id, medic_id, role
2. `onMutate`: Cancel queries, snapshot previous data, optimistically update territory with new medic assignment. Update the medic name in the TerritoryWithMetrics cache.
3. `onError`: Rollback to snapshot
4. `onSuccess`: Invalidate both territory and medic queries (since medic's territory_assignments changes)

Also add `useUnassignMedic()` mutation for removing an assignment (sets primary_medic_id or secondary_medic_id to null).

IMPORTANT: Use `useRequireOrg()` for org_id in query cache keys, matching the existing pattern.
  </action>
  <verify>
- API route handles all error cases (400, 401, 404)
- Mutation hook follows same optimistic update pattern as useUpdateMedicAvailability
- org_id is included in all queries and cache keys
- Both assign and unassign mutations work correctly
  </verify>
  <done>
API route persists medic-to-territory assignments. TanStack Query mutation hooks provide optimistic updates for instant UI feedback on assignment changes, with rollback on failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build drag-drop assignment panel with dnd-kit</name>
  <files>web/app/admin/territories/assignment-panel.tsx</files>
  <action>
Create `web/app/admin/territories/assignment-panel.tsx` as a 'use client' component:

**Layout (split-pane):**
- Left sidebar (w-1/3): "Available Medics" panel showing draggable medic cards
- Right area (w-2/3): Territory list with drop zones for primary and secondary columns

**Medic Cards (draggable):**
- Use `useDraggable` from @dnd-kit/core (NOT useSortable -- we need free drag, not list sorting)
- Each card shows: medic name, utilization bar (colored green/yellow/red), territory count, star rating
- Below each medic card, show the auto-assignment match score using `formatScoreBreakdown()` from `@/lib/territory/auto-assignment` (imported from Plan 02). When a territory drop zone is hovered, compute and display the score for that medic-territory pair using `calculateAutoMatchScore()`.
- Cards show a "grip" handle icon (use GripVertical from lucide-react)
- Disabled state (opacity-50) for unavailable medics (available_for_work === false)

**Territory Drop Zones:**
- Use `useDroppable` from @dnd-kit/core for each territory row's primary and secondary slots
- Drop zone highlights blue when a medic is being dragged over it
- Empty slots show dashed border with "Drop medic here" text
- Filled slots show medic name with an "X" button to unassign

**Drag-and-Drop Logic:**
- `onDragEnd` handler:
  - Extract medicId from `active.id`
  - Extract territoryId and role ('primary' | 'secondary') from `over.id` (format: `{territoryId}:{role}`)
  - Call `assignMedic.mutate({ territory_id: territoryId, medic_id: medicId, role })`
- Use `DragOverlay` for visual drag feedback (shows medic card at cursor)

**Keyboard Fallback:**
- Below each territory row, add a small "Assign" button that opens a select dropdown with available medics
- This provides accessibility for keyboard-only users (Pitfall 6 from research)

**Search/Filter on Medic Panel:**
- Text input to filter medics by name
- Toggle to show only available medics

Use the `useMedics()` hook from medics.ts for the medic list.
Use the `useTerritories()` hook for territories.
Use the `useAssignMedicToTerritory()` mutation from Task 1.

Match the existing admin UI style: dark background (gray-800/50), backdrop-blur, border-gray-700/50, white text.
  </action>
  <verify>
- Component renders medic cards on left, territory drop zones on right
- Dragging a medic card shows DragOverlay
- Dropping on a territory slot triggers assignment mutation
- Keyboard "Assign" button exists as fallback
- Unassign "X" button removes assignment
- Medic search/filter works
  </verify>
  <done>
Admin can drag medics from sidebar and drop onto territory primary/secondary slots. Assignment persists via API with optimistic updates. Keyboard fallback ensures accessibility. Medic panel includes search filtering.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify assignment panel renders independently and is importable</name>
  <files>web/app/admin/territories/assignment-panel.tsx</files>
  <action>
Verify that `assignment-panel.tsx` can be imported and rendered by Plan 05's page.tsx integration:

1. Confirm the component has a default or named export that page.tsx can import (e.g., `export default function AssignmentPanel()` or `export function AssignmentPanel()`)
2. Confirm all internal imports resolve (dnd-kit, hooks, territory queries, auto-assignment module)
3. Confirm the component does NOT require page-level props that would prevent standalone rendering -- it should fetch its own data via `useMedics()` and `useTerritories()` hooks internally
4. Run TypeScript compilation check: `cd web && npx tsc --noEmit` to verify no type errors in the assignment panel or its dependencies

Note: Actual wiring into page.tsx with tab navigation happens in Plan 05 Task 2. This task only verifies the component is self-contained and importable.
  </action>
  <verify>
- `npx tsc --noEmit` passes without errors related to assignment-panel.tsx
- Component exports a renderable function component
- Component fetches its own data (does not require territories/medics as props from parent)
  </verify>
  <done>
AssignmentPanel component verified as self-contained and importable. Ready for Plan 05 to wire into territories page via tab navigation.
  </done>
</task>

</tasks>

<verification>
1. API route correctly validates auth, org_id, and updates territories table
2. Optimistic updates provide instant visual feedback on assignment
3. Drag-drop uses dnd-kit (not custom pointer events) per research recommendation
4. Keyboard fallback provides accessible alternative to drag-drop
5. Territory list shows assigned medics with unassign capability
6. Both primary and secondary medic slots are droppable
</verification>

<success_criteria>
- Admin can drag medic to territory primary/secondary slot
- Assignment persists to database and reflects immediately in UI
- Keyboard "Assign" button works as alternative to drag-drop
- Unassigning a medic clears the slot
- Medic panel shows utilization and availability status
- AssignmentPanel component is importable and functional when mounted (actual page wiring into territories page.tsx happens in Plan 05)
</success_criteria>

<output>
After completion, create `.planning/phases/07.5-territory-auto-assignment/07.5-03-SUMMARY.md`
</output>
