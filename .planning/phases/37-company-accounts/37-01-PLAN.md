---
phase: 37-company-accounts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/156_company_roster_medics.sql
  - web/lib/marketplace/roster-types.ts
  - web/lib/marketplace/roster-schemas.ts
  - web/lib/marketplace/medic-availability.ts
  - web/app/api/marketplace/roster/route.ts
  - web/app/api/marketplace/roster/[id]/route.ts
  - web/app/api/marketplace/roster/invite/route.ts
  - web/app/api/marketplace/roster/accept/route.ts
  - web/app/api/marketplace/companies/[id]/profile/route.ts
  - web/lib/queries/marketplace/roster.ts
autonomous: true

must_haves:
  truths:
    - "company_roster_medics table exists with many-to-many relationship between companies and medics"
    - "RLS policies enforce company admin can CRUD own roster, medics can view their memberships, platform admin sees all"
    - "Trigger validates named medics in quotes belong to active roster"
    - "Roster API routes support add, remove, update, list, invite, and accept operations"
    - "TypeScript types and Zod schemas exist for all roster operations"
  artifacts:
    - path: "supabase/migrations/156_company_roster_medics.sql"
      provides: "Junction table, RLS, triggers, indexes, denormalized aggregation columns"
      contains: "company_roster_medics"
    - path: "web/lib/marketplace/roster-types.ts"
      provides: "TypeScript types for roster medics, company profile display, availability"
      exports: ["CompanyRosterMedic", "CompanyProfileDisplay", "RosterMedicStatus"]
    - path: "web/lib/marketplace/roster-schemas.ts"
      provides: "Zod validation schemas for roster operations"
      exports: ["rosterAddSchema", "rosterUpdateSchema", "rosterInviteSchema"]
    - path: "web/app/api/marketplace/roster/route.ts"
      provides: "GET (list roster) and POST (add medic) endpoints"
      exports: ["GET", "POST"]
    - path: "web/app/api/marketplace/roster/[id]/route.ts"
      provides: "PATCH (update medic) and DELETE (remove medic) endpoints"
      exports: ["PATCH", "DELETE"]
    - path: "web/app/api/marketplace/roster/invite/route.ts"
      provides: "POST endpoint for email invitations with signed JWT"
      exports: ["POST"]
    - path: "web/app/api/marketplace/roster/accept/route.ts"
      provides: "POST endpoint for accepting roster invitations via token"
      exports: ["POST"]
    - path: "web/app/api/marketplace/companies/[id]/profile/route.ts"
      provides: "GET endpoint for company profile with denormalized aggregations"
      exports: ["GET"]
    - path: "web/lib/queries/marketplace/roster.ts"
      provides: "React Query hooks for roster data"
      exports: ["useCompanyRoster", "useCompanyProfile"]
    - path: "web/lib/marketplace/medic-availability.ts"
      provides: "Availability checking utility functions"
      exports: ["isMedicAvailableOnDate", "getAvailableRosterMedicsForEvent"]
  key_links:
    - from: "supabase/migrations/156_company_roster_medics.sql"
      to: "marketplace_companies"
      via: "company_id FK"
      pattern: "REFERENCES marketplace_companies"
    - from: "supabase/migrations/156_company_roster_medics.sql"
      to: "marketplace_quotes"
      via: "validate_quote_roster_membership trigger"
      pattern: "BEFORE INSERT OR UPDATE ON marketplace_quotes"
    - from: "web/app/api/marketplace/roster/route.ts"
      to: "company_roster_medics"
      via: "Supabase client queries"
      pattern: "from\\('company_roster_medics'\\)"
    - from: "web/lib/queries/marketplace/roster.ts"
      to: "web/app/api/marketplace/roster/route.ts"
      via: "fetch in useQuery"
      pattern: "fetch.*api/marketplace/roster"
---

<objective>
Create the database foundation, TypeScript types, Zod schemas, API routes, and React Query hooks for company roster management.

Purpose: This is the data layer that all roster UI, assignment, and profile features depend on. Without the junction table, triggers, and API routes, no roster operations are possible.

Output: Migration 156 with company_roster_medics table (RLS, triggers, indexes), full TypeScript type system, Zod validation, 5 API routes (list, add, update/remove, invite, accept), company profile API, availability utilities, and React Query hooks.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-company-accounts/37-RESEARCH.md
@.planning/phases/37-company-accounts/37-CONTEXT.md

Key existing files to reference:
@supabase/migrations/140_marketplace_foundation.sql (marketplace_companies table, medic_commitments, RLS pattern)
@supabase/migrations/146_marketplace_quotes.sql (staffing_plan JSONB structure for named_medics validation)
@supabase/migrations/152_marketplace_ratings.sql (company aggregate trigger pattern to follow)
@web/lib/marketplace/types.ts (MarketplaceCompany, MedicCommitment types)
@web/lib/marketplace/quote-types.ts (StaffingPlanItem, StaffingPlan discriminated union)
@web/lib/queries/marketplace/quotes.ts (React Query hook pattern)
@web/app/api/marketplace/companies/[id]/reviews/route.ts (API route pattern with params)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and trigger functions</name>
  <files>supabase/migrations/156_company_roster_medics.sql</files>
  <action>
Create migration 156_company_roster_medics.sql with the following:

**1. company_roster_medics table:**
- id UUID PK, company_id FK to marketplace_companies ON DELETE CASCADE, medic_id FK to medics ON DELETE CASCADE
- status TEXT NOT NULL DEFAULT 'active' CHECK IN ('pending', 'active', 'inactive', 'suspended')
- title TEXT (company-specific role, e.g. "Senior Paramedic")
- hourly_rate DECIMAL(10,2) (company-specific rate override, nullable)
- qualifications TEXT[] (company-specific qualification list, nullable = inherit from medics table)
- available BOOLEAN DEFAULT TRUE
- unavailable_reason TEXT, unavailable_from DATE, unavailable_until DATE
- invitation_email TEXT (for pending invitations where medic_id is not yet known)
- invitation_token TEXT (signed JWT token for acceptance)
- invitation_sent_at TIMESTAMPTZ, invitation_accepted_at TIMESTAMPTZ
- joined_at TIMESTAMPTZ DEFAULT NOW(), left_at TIMESTAMPTZ
- added_by UUID NOT NULL REFERENCES auth.users(id)
- created_at TIMESTAMPTZ DEFAULT NOW(), updated_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE(company_id, medic_id)

**2. RLS policies (user_id-based, matching marketplace pattern — NOT org_id):**
- Company admins (admin_user_id on marketplace_companies) can CRUD their own roster
- Medics can SELECT their own roster memberships (WHERE medic_id IN (SELECT id FROM medics WHERE user_id = auth.uid()))
- Platform admin has full access via is_platform_admin()
- Authenticated users can SELECT active roster medics for verified companies (for profile display)

**3. Denormalized columns on marketplace_companies:**
- ALTER TABLE marketplace_companies ADD COLUMN IF NOT EXISTS roster_size INTEGER DEFAULT 0
- ALTER TABLE marketplace_companies ADD COLUMN IF NOT EXISTS insurance_status TEXT DEFAULT 'unverified' CHECK IN ('verified', 'expired', 'unverified')

**4. Trigger: update_company_roster_aggregations()**
- Fires AFTER INSERT OR UPDATE OR DELETE on company_roster_medics
- Recalculates roster_size = COUNT(*) WHERE status = 'active' for the affected company_id
- Uses COALESCE for DELETE operations (OLD.company_id)
- Pattern: Follow Phase 36 trigger update_company_rating_aggregate() style

**5. Trigger: validate_quote_roster_membership()**
- Fires BEFORE INSERT OR UPDATE ON marketplace_quotes
- Only checks when staffing_plan->>'type' = 'named_medics'
- For each named_medic in staffing_plan->'named_medics' array, verify medic_id exists in company_roster_medics WHERE company_id = NEW.company_id AND status = 'active'
- RAISE EXCEPTION if any medic not found in active roster
- IMPORTANT: Use a different variable name than `medic_id` for the loop variable to avoid ambiguity with the column name — use `v_medic_id` instead

**6. Trigger: updated_at auto-update**
- Reuse existing update_updated_at_column() function

**7. Indexes:**
- idx_company_roster_medics_company_id ON company_roster_medics(company_id)
- idx_company_roster_medics_medic_id ON company_roster_medics(medic_id)
- idx_company_roster_medics_status ON company_roster_medics(status)
- idx_company_roster_medics_company_status ON company_roster_medics(company_id, status) — composite for filtered roster queries

Do NOT modify existing tables beyond the ALTERs on marketplace_companies. Do NOT add any columns to medics or marketplace_quotes.
  </action>
  <verify>
Run: `cat supabase/migrations/156_company_roster_medics.sql | head -5` to confirm file exists.
Verify trigger function names: validate_quote_roster_membership and update_company_roster_aggregations.
Verify RLS policies reference auth.uid() (not get_user_org_id()).
Verify UNIQUE(company_id, medic_id) constraint exists.
  </verify>
  <done>
Migration file exists with company_roster_medics table, 4+ RLS policies, 3 trigger functions (aggregation, roster validation, updated_at), 4 indexes, and 2 ALTER TABLE statements on marketplace_companies.
  </done>
</task>

<task type="auto">
  <name>Task 2: TypeScript types, Zod schemas, availability utilities, API routes, and React Query hooks</name>
  <files>
web/lib/marketplace/roster-types.ts
web/lib/marketplace/roster-schemas.ts
web/lib/marketplace/medic-availability.ts
web/app/api/marketplace/roster/route.ts
web/app/api/marketplace/roster/[id]/route.ts
web/app/api/marketplace/roster/invite/route.ts
web/app/api/marketplace/roster/accept/route.ts
web/app/api/marketplace/companies/[id]/profile/route.ts
web/lib/queries/marketplace/roster.ts
  </files>
  <action>
**roster-types.ts:**
- RosterMedicStatus = 'pending' | 'active' | 'inactive' | 'suspended'
- InsuranceStatus = 'verified' | 'expired' | 'unverified'
- CompanyRosterMedic interface mirroring company_roster_medics table (all columns)
- CompanyRosterMedicWithDetails extends CompanyRosterMedic with medic_name, medic_email (from joined medics table)
- CompanyProfileDisplay: { id, company_name, company_description, coverage_areas, roster_size, average_rating, review_count, insurance_status, verification_status, created_at, team_preview: Array of { medic_id, name, qualification, title, available } }
- RosterInvitation: { company_id, invitation_email, invitation_token, expires_at }
- Label maps: ROSTER_STATUS_LABELS, INSURANCE_STATUS_LABELS

**roster-schemas.ts:**
- rosterAddSchema: Zod schema for POST /roster (companyId required, medicId required for direct add)
- rosterInviteSchema: Zod schema for POST /roster/invite (companyId required, email required, title optional, qualifications optional)
- rosterUpdateSchema: Zod schema for PATCH /roster/[id] (title, hourly_rate, qualifications, available, unavailable_from, unavailable_until, unavailable_reason — all optional)
- rosterAcceptSchema: Zod schema for POST /roster/accept (token required)
- Use Zod v3 syntax (project uses Zod 3.x in web/lib, Zod 4 only in web-app)

**medic-availability.ts:**
- isMedicAvailableOnDate(unavailableFrom, unavailableUntil, targetDate): boolean — checks roster unavailable window
- getAvailableRosterMedics(rosterMedics: CompanyRosterMedicWithDetails[], eventDates: string[]): filtered array
- Uses date-fns isWithinInterval, parseISO for date logic
- Export both functions

**API routes:**

1. **GET /api/marketplace/roster?companyId=X** — List roster medics for a company. Joins medics table for name/email. Filters by status query param (default: 'active'). Returns CompanyRosterMedicWithDetails[]. Auth: company admin or platform admin.

2. **POST /api/marketplace/roster** — Direct add medic to roster. Body: { companyId, medicId }. Validates companyId ownership via admin_user_id = auth.uid(). Sets status='active', joined_at=now(). Returns created roster entry. Auth: company admin.

3. **PATCH /api/marketplace/roster/[id]** — Update roster medic (title, qualifications, availability). Auth: company admin.

4. **DELETE /api/marketplace/roster/[id]** — Soft-remove medic from roster: sets status='inactive', left_at=now(). Does NOT delete the row (preserves audit trail + historical quote references). Auth: company admin.

5. **POST /api/marketplace/roster/invite** — Send email invitation. Body: { companyId, email, title?, qualifications? }. Creates roster entry with status='pending', invitation_email, invitation_token (signed JWT with company_id + email + exp 7d using process.env.JWT_SECRET or a fallback for dev). Sends email via Resend (with try/catch, dev fallback to console.log if no RESEND_API_KEY). Auth: company admin.

6. **POST /api/marketplace/roster/accept** — Accept invitation. Body: { token }. Verifies JWT, finds matching pending roster entry by company_id + invitation_email, updates medic_id to current user's medic record (lookup medics WHERE user_id = auth.uid()), sets status='active', invitation_accepted_at=now(). Auth: any authenticated user.

7. **GET /api/marketplace/companies/[id]/profile** — Company profile with denormalized aggregations. Reads directly from marketplace_companies (roster_size, average_rating, review_count, insurance_status already denormalized). Also fetches up to 5 active roster medics for team_preview (name + qualification + title + available status only — no email, phone, or private details). Returns CompanyProfileDisplay. Auth: any authenticated user.

All API routes follow the existing pattern:
- import createClient from @/lib/supabase/server
- export const dynamic = 'force-dynamic'; export const runtime = 'nodejs';
- Validate with Zod schemas
- Return NextResponse.json with appropriate status codes

**React Query hooks (web/lib/queries/marketplace/roster.ts):**
- useCompanyRoster(companyId, statusFilter?): fetches GET /api/marketplace/roster
- useCompanyProfile(companyId): fetches GET /api/marketplace/companies/[id]/profile
- Follow existing pattern from web/lib/queries/marketplace/quotes.ts (staleTime, gcTime, enabled flag)
  </action>
  <verify>
Run: `ls web/lib/marketplace/roster-types.ts web/lib/marketplace/roster-schemas.ts web/lib/marketplace/medic-availability.ts web/app/api/marketplace/roster/route.ts web/app/api/marketplace/roster/invite/route.ts web/app/api/marketplace/roster/accept/route.ts web/app/api/marketplace/companies/[id]/profile/route.ts web/lib/queries/marketplace/roster.ts` to confirm all files exist.
Run: `cd /Users/sabineresoagli/GitHub/sitemedic && pnpm --filter web exec tsc --noEmit --pretty 2>&1 | tail -20` to check TypeScript compilation (or equivalent check).
Verify roster-types.ts exports CompanyRosterMedic and CompanyProfileDisplay.
Verify roster-schemas.ts exports rosterAddSchema and rosterInviteSchema.
  </verify>
  <done>
All 9 files created. TypeScript types cover all roster entities. Zod schemas validate all API inputs. 7 API routes provide full CRUD + invitation workflow. React Query hooks enable client-side data fetching. Availability utility provides date-range checking.
  </done>
</task>

</tasks>

<verification>
1. Migration 156 creates company_roster_medics with correct FKs, RLS, triggers, and indexes
2. validate_quote_roster_membership trigger rejects quotes with non-roster medics
3. update_company_roster_aggregations trigger keeps marketplace_companies.roster_size in sync
4. All API routes authenticate and authorize correctly (company admin for mutations, any auth for profile)
5. TypeScript types match migration schema exactly
6. Zod schemas validate all required fields
7. React Query hooks follow existing project pattern
</verification>

<success_criteria>
- company_roster_medics table defined in migration with UNIQUE(company_id, medic_id)
- 4+ RLS policies on company_roster_medics using auth.uid() pattern
- validate_quote_roster_membership trigger on marketplace_quotes
- roster_size and insurance_status columns added to marketplace_companies
- 7 API routes all return valid JSON responses
- TypeScript types exported and importable
- React Query hooks follow staleTime/gcTime pattern from existing hooks
</success_criteria>

<output>
After completion, create `.planning/phases/37-company-accounts/37-01-SUMMARY.md`
</output>
