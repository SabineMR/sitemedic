---
phase: 37-company-accounts
plan: 02
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - web/stores/useCompanyRosterStore.ts
  - web/app/(dashboard)/dashboard/marketplace/roster/page.tsx
  - web/components/marketplace/roster/RosterList.tsx
  - web/components/marketplace/roster/AddMedicModal.tsx
  - web/components/marketplace/roster/InviteMedicModal.tsx
  - web/components/marketplace/roster/RosterMedicCard.tsx
  - web/app/(dashboard)/dashboard/marketplace/roster/accept/page.tsx
autonomous: true

must_haves:
  truths:
    - "Company admin can view their roster with status, qualification, and availability info"
    - "Company admin can add an existing SiteMedic medic directly to the roster"
    - "Company admin can invite a medic by email with a signed invitation link"
    - "Company admin can remove a medic from the roster (soft-remove to inactive)"
    - "An invited medic can accept the invitation and join the roster"
  artifacts:
    - path: "web/stores/useCompanyRosterStore.ts"
      provides: "Zustand state for roster management UI"
      exports: ["useCompanyRosterStore"]
    - path: "web/app/(dashboard)/dashboard/marketplace/roster/page.tsx"
      provides: "Roster management page for company admins"
      min_lines: 50
    - path: "web/components/marketplace/roster/RosterList.tsx"
      provides: "Filterable roster list with status badges and action buttons"
      min_lines: 60
    - path: "web/components/marketplace/roster/AddMedicModal.tsx"
      provides: "Modal for directly adding an existing medic by search/select"
      min_lines: 40
    - path: "web/components/marketplace/roster/InviteMedicModal.tsx"
      provides: "Modal for sending email invitation with optional title and qualifications"
      min_lines: 40
    - path: "web/components/marketplace/roster/RosterMedicCard.tsx"
      provides: "Individual medic row/card in roster list with status badge and actions"
      min_lines: 30
    - path: "web/app/(dashboard)/dashboard/marketplace/roster/accept/page.tsx"
      provides: "Invitation acceptance page that processes JWT token from URL"
      min_lines: 30
  key_links:
    - from: "web/app/(dashboard)/dashboard/marketplace/roster/page.tsx"
      to: "web/lib/queries/marketplace/roster.ts"
      via: "useCompanyRoster hook"
      pattern: "useCompanyRoster"
    - from: "web/components/marketplace/roster/AddMedicModal.tsx"
      to: "/api/marketplace/roster"
      via: "fetch POST"
      pattern: "fetch.*api/marketplace/roster"
    - from: "web/components/marketplace/roster/InviteMedicModal.tsx"
      to: "/api/marketplace/roster/invite"
      via: "fetch POST"
      pattern: "fetch.*api/marketplace/roster/invite"
    - from: "web/app/(dashboard)/dashboard/marketplace/roster/accept/page.tsx"
      to: "/api/marketplace/roster/accept"
      via: "fetch POST with token"
      pattern: "fetch.*api/marketplace/roster/accept"
---

<objective>
Build the company roster management UI — the admin interface where company owners add, invite, manage, and remove medics from their roster.

Purpose: Company admins need a visual interface to manage their medic team. This is the primary workflow for building a company's roster, which is required before assigning medics to quotes (Plan 03).

Output: Roster management page at /dashboard/marketplace/roster with add/invite modals, roster list with filtering, medic cards with status badges and actions, and invitation acceptance page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-company-accounts/37-RESEARCH.md
@.planning/phases/37-company-accounts/37-CONTEXT.md
@.planning/phases/37-company-accounts/37-01-SUMMARY.md

Key existing files to reference:
@web/stores/useMarketplaceRegistrationStore.ts (Zustand store pattern)
@web/stores/useQuoteFormStore.ts (Zustand store pattern with form state)
@web/lib/marketplace/roster-types.ts (types from Plan 01)
@web/lib/marketplace/roster-schemas.ts (Zod schemas from Plan 01)
@web/lib/queries/marketplace/roster.ts (React Query hooks from Plan 01)
@web/app/(dashboard)/dashboard/marketplace/page.tsx (existing marketplace page pattern)
@web/components/marketplace/quote-submission/StaffingPlanSection.tsx (named medics UI pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zustand store and roster management page with list component</name>
  <files>
web/stores/useCompanyRosterStore.ts
web/app/(dashboard)/dashboard/marketplace/roster/page.tsx
web/components/marketplace/roster/RosterList.tsx
web/components/marketplace/roster/RosterMedicCard.tsx
  </files>
  <action>
**useCompanyRosterStore.ts:**
Create Zustand store following useMarketplaceRegistrationStore pattern:
- State: companyId (string), statusFilter ('all' | 'active' | 'pending' | 'inactive' — default 'all'), searchTerm (string), addModalOpen (boolean), inviteModalOpen (boolean), selectedMedicId (string | null)
- Actions: setCompanyId, setStatusFilter, setSearchTerm, openAddModal/closeAddModal, openInviteModal/closeInviteModal, setSelectedMedicId, reset
- Keep it simple — data fetching is in React Query hooks, not the store

**roster/page.tsx:**
Company admin roster management page at `/dashboard/marketplace/roster`.
- 'use client' component
- Fetch current user's marketplace company (supabase query marketplace_companies WHERE admin_user_id = user.id) to get companyId
- If no company found, show "Register your company first" message with link to marketplace registration
- Use useCompanyRoster(companyId, statusFilter) from React Query hooks
- Page header: "Team Roster" with company name
- Two action buttons in header: "Add Medic" (opens AddMedicModal) and "Invite Medic" (opens InviteMedicModal)
- Status filter tabs: All, Active, Pending, Inactive (using Zustand store statusFilter)
- Search input for filtering by name
- Render RosterList with the fetched roster data
- Show count: "X medics" badge next to header
- Use Tailwind for styling, consistent with existing marketplace pages

**RosterList.tsx:**
- Props: roster: CompanyRosterMedicWithDetails[], isLoading: boolean
- Maps over roster and renders RosterMedicCard for each
- Empty state: "No medics on your roster yet. Add team members to start quoting." with Add/Invite buttons
- Loading state: skeleton cards (3 placeholder cards)
- Grid layout: 1 col on mobile, 2 on md, 3 on lg

**RosterMedicCard.tsx:**
- Props: medic: CompanyRosterMedicWithDetails, onRemove: (id) => void, onEdit: (id) => void
- Card layout with: medic name (bold), title/role below name, qualification badges (Tailwind Badge component), status badge (green for active, amber for pending, gray for inactive, red for suspended)
- If medic has unavailable_from/until set and current date is within range, show "Temporarily unavailable" amber badge with date range
- Action buttons: "Edit" (pencil icon), "Remove" (trash icon with confirmation)
- Remove calls DELETE /api/marketplace/roster/[id] then invalidates React Query cache
- Use sonner toast for success/error feedback
- If status is 'pending', show "Invitation sent" with invitation_sent_at date instead of action buttons, plus a "Resend" button
  </action>
  <verify>
Run: `ls web/stores/useCompanyRosterStore.ts web/app/\\(dashboard\\)/dashboard/marketplace/roster/page.tsx web/components/marketplace/roster/RosterList.tsx web/components/marketplace/roster/RosterMedicCard.tsx` to confirm all files exist.
Verify page.tsx imports useCompanyRoster hook and useCompanyRosterStore.
Verify RosterMedicCard renders status badges for all 4 statuses.
  </verify>
  <done>
Zustand store provides UI state management. Roster page loads company roster via React Query. RosterList renders grid of RosterMedicCards with status badges, qualification tags, availability indicators, and action buttons (edit, remove, resend invite).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add medic, invite medic modals, and invitation acceptance page</name>
  <files>
web/components/marketplace/roster/AddMedicModal.tsx
web/components/marketplace/roster/InviteMedicModal.tsx
web/app/(dashboard)/dashboard/marketplace/roster/accept/page.tsx
  </files>
  <action>
**AddMedicModal.tsx:**
Direct-add modal for adding an existing SiteMedic medic to the roster.
- Opens from useCompanyRosterStore.addModalOpen
- Uses Dialog component from @/components/ui/dialog
- Search input that queries medics by name (GET /api/marketplace/roster?search=X — or direct Supabase query of medics table WHERE first_name ILIKE or last_name ILIKE, limited to 10 results)
- Display search results as a list: name, qualification, email
- Selecting a medic shows their details with a "Add to Roster" button
- Optional fields: title (text input, e.g. "Senior Paramedic"), qualifications override (multi-select from STAFFING_ROLE_LABELS)
- On submit: POST /api/marketplace/roster with { companyId, medicId, title?, qualifications? }
- On success: toast("Medic added to roster"), close modal, invalidate useCompanyRoster query
- On error: show error message (e.g., "Medic already on your roster" for unique constraint violation)
- Important: The search should query medics from the medics table (not just roster). This allows adding any SiteMedic medic. The API handles the insert.

**InviteMedicModal.tsx:**
Email invitation modal for medics not yet on the platform (or easier invite flow).
- Opens from useCompanyRosterStore.inviteModalOpen
- Uses Dialog component
- Fields: email (required), title (optional), qualifications (optional multi-select)
- On submit: POST /api/marketplace/roster/invite with { companyId, email, title?, qualifications? }
- On success: toast("Invitation sent to {email}"), close modal, invalidate useCompanyRoster query
- On error: show error message
- Show note: "The medic will receive an email invitation valid for 7 days."

**roster/accept/page.tsx:**
Invitation acceptance page at `/dashboard/marketplace/roster/accept?token=X`.
- 'use client' component
- Reads token from URL search params (useSearchParams)
- On mount, calls POST /api/marketplace/roster/accept with { token }
- Shows loading state: "Accepting invitation..."
- On success: shows "Welcome to {company_name} roster!" with link to marketplace dashboard
- On error (expired, invalid, already accepted): shows appropriate error message with link to marketplace dashboard
- If user is not logged in, redirect to login page with return URL to this page
  </action>
  <verify>
Run: `ls web/components/marketplace/roster/AddMedicModal.tsx web/components/marketplace/roster/InviteMedicModal.tsx web/app/\\(dashboard\\)/dashboard/marketplace/roster/accept/page.tsx` to confirm all files exist.
Verify AddMedicModal has search functionality and POST to /api/marketplace/roster.
Verify InviteMedicModal has email field and POST to /api/marketplace/roster/invite.
Verify accept page reads token from URL params.
  </verify>
  <done>
AddMedicModal allows searching and directly adding existing SiteMedic medics. InviteMedicModal sends email invitations with 7-day expiry. Accept page processes JWT tokens from invitation links and adds medics to the roster. All modals use sonner toasts and invalidate React Query cache on success.
  </done>
</task>

</tasks>

<verification>
1. Roster page loads at /dashboard/marketplace/roster for a company admin
2. Status filter tabs (All/Active/Pending/Inactive) filter the roster list
3. AddMedicModal search finds existing SiteMedic medics and adds them to roster
4. InviteMedicModal sends invitation email (dev mode: console.log) and creates pending entry
5. RosterMedicCard shows correct status badges and action buttons per status
6. Remove action soft-removes medic (status='inactive') and updates list
7. Accept page processes token and shows success/error state
</verification>

<success_criteria>
- Company admin can navigate to /dashboard/marketplace/roster and see their team
- Adding a medic via search creates an active roster entry immediately
- Inviting a medic creates a pending roster entry with invitation details
- Removing a medic sets status to inactive (not deleted)
- Invitation acceptance page works with valid tokens
- All UI uses consistent Tailwind styling and existing component library (Dialog, Badge, Button, Input)
</success_criteria>

<output>
After completion, create `.planning/phases/37-company-accounts/37-02-SUMMARY.md`
</output>
