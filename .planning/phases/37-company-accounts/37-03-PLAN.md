---
phase: 37-company-accounts
plan: 03
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - web/components/marketplace/roster/CompanyProfileCard.tsx
  - web/components/marketplace/roster/MeetTheTeam.tsx
  - web/components/marketplace/roster/MedicAvailabilityModal.tsx
  - web/components/marketplace/roster/RosterMedicPicker.tsx
  - web/components/marketplace/quote-submission/StaffingPlanSection.tsx
  - web/app/(dashboard)/dashboard/marketplace/company/[id]/page.tsx
  - web/lib/marketplace/company-profile.ts
autonomous: true

must_haves:
  truths:
    - "Company profiles display company name, roster size, average rating, total events completed, and insurance status"
    - "Company profiles show a 'Meet the Team' section with individual medic names, qualifications, and availability"
    - "Company admin can manage medic availability within the roster (date-range blocking)"
    - "When quoting with named medics, company can select from their active roster"
    - "Roster changes reflect in quoting: removing a paramedic reduces available paramedic-qualified staff"
  artifacts:
    - path: "web/app/(dashboard)/dashboard/marketplace/company/[id]/page.tsx"
      provides: "Company profile page with stats, ratings, insurance, and team preview"
      min_lines: 60
    - path: "web/components/marketplace/roster/CompanyProfileCard.tsx"
      provides: "Company header card with stats grid (roster size, rating, insurance, coverage)"
      min_lines: 40
    - path: "web/components/marketplace/roster/MeetTheTeam.tsx"
      provides: "Team preview section showing active roster medics with names and qualifications"
      min_lines: 40
    - path: "web/components/marketplace/roster/MedicAvailabilityModal.tsx"
      provides: "Modal for setting medic unavailability date ranges"
      min_lines: 50
    - path: "web/components/marketplace/roster/RosterMedicPicker.tsx"
      provides: "Medic picker that filters by qualification and availability for quote staffing plan"
      min_lines: 50
    - path: "web/components/marketplace/quote-submission/StaffingPlanSection.tsx"
      provides: "Updated staffing plan section wired to real roster data via RosterMedicPicker"
      min_lines: 80
    - path: "web/lib/marketplace/company-profile.ts"
      provides: "Helper to transform API profile data for display"
      exports: ["formatCompanyProfile", "getInsuranceBadgeColor"]
  key_links:
    - from: "web/app/(dashboard)/dashboard/marketplace/company/[id]/page.tsx"
      to: "/api/marketplace/companies/[id]/profile"
      via: "useCompanyProfile hook"
      pattern: "useCompanyProfile"
    - from: "web/components/marketplace/roster/RosterMedicPicker.tsx"
      to: "/api/marketplace/roster"
      via: "useCompanyRoster hook filtered by qualification"
      pattern: "useCompanyRoster"
    - from: "web/components/marketplace/quote-submission/StaffingPlanSection.tsx"
      to: "web/components/marketplace/roster/RosterMedicPicker.tsx"
      via: "RosterMedicPicker component for named medics selection"
      pattern: "RosterMedicPicker"
    - from: "web/components/marketplace/roster/MedicAvailabilityModal.tsx"
      to: "/api/marketplace/roster/[id]"
      via: "PATCH with availability fields"
      pattern: "fetch.*api/marketplace/roster"
---

<objective>
Build the company profile display and wire roster data to the quoting workflow — including the "Meet the Team" section, medic availability management, and roster-aware medic picker for quote staffing plans.

Purpose: Clients need to see rich company profiles to make informed award decisions. Companies need to assign real roster medics when quoting (not free-text names). Availability management ensures accurate capacity planning.

Output: Company profile page with stats and team preview, availability management modal, roster-aware medic picker for quote submission, and updated StaffingPlanSection wired to real roster data.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-company-accounts/37-RESEARCH.md
@.planning/phases/37-company-accounts/37-CONTEXT.md
@.planning/phases/37-company-accounts/37-01-SUMMARY.md

Key existing files to reference:
@web/lib/marketplace/roster-types.ts (CompanyProfileDisplay, CompanyRosterMedicWithDetails from Plan 01)
@web/lib/marketplace/medic-availability.ts (availability checking utilities from Plan 01)
@web/lib/queries/marketplace/roster.ts (useCompanyRoster, useCompanyProfile hooks from Plan 01)
@web/app/api/marketplace/companies/[id]/profile/route.ts (profile API from Plan 01)
@web/components/marketplace/quote-submission/StaffingPlanSection.tsx (current named medics UI to update)
@web/stores/useQuoteFormStore.ts (quote form store with addNamedMedic action)
@web/lib/marketplace/quote-types.ts (StaffingPlanItem type with medic_id, name, qualification)
@web/components/marketplace/ratings/CompanyRatingsSummary.tsx (ratings display pattern)
@web/app/api/marketplace/companies/[id]/reviews/route.ts (reviews API pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Company profile page with stats card and Meet the Team section</name>
  <files>
web/app/(dashboard)/dashboard/marketplace/company/[id]/page.tsx
web/components/marketplace/roster/CompanyProfileCard.tsx
web/components/marketplace/roster/MeetTheTeam.tsx
web/lib/marketplace/company-profile.ts
  </files>
  <action>
**company-profile.ts:**
Helper utilities for company profile display:
- formatCompanyProfile(raw): transforms API response to display-ready format (formats dates, handles nulls)
- getInsuranceBadgeColor(status: InsuranceStatus): returns Tailwind classes — 'verified' = green-100/green-800, 'expired' = red-100/red-800, 'unverified' = gray-100/gray-800
- getVerificationBadgeLabel(status): maps verification statuses to human-readable labels

**CompanyProfileCard.tsx:**
Company header card with key metrics.
- Props: company: CompanyProfileDisplay
- Card component (from @/components/ui/card) with:
  - Company name (large heading) with verified badge if verification_status = 'verified' (use existing VerifiedBadge from @/web/components/marketplace/VerifiedBadge.tsx)
  - Company description paragraph below name
  - Stats grid (2 cols on mobile, 4 cols on md+):
    1. "Team Size" — roster_size number (large bold)
    2. "Rating" — average_rating with Star icon (lucide-react) filled yellow, review_count in parentheses below
    3. "Insurance" — insurance_status badge with appropriate color from getInsuranceBadgeColor
    4. "Coverage" — coverage_areas joined with commas
  - "Member since" with formatted created_at date at bottom

**MeetTheTeam.tsx:**
Team preview section showing active roster medics.
- Props: teamPreview: CompanyProfileDisplay['team_preview'], companyId: string, isOwnProfile: boolean
- Card with "Meet the Team" heading
- Grid layout: 1 col mobile, 2 cols md, 3 cols lg
- Each team member: bordered card with name (bold), qualification badge, title if present, "Temporarily unavailable" amber badge if available === false
- If isOwnProfile: show "Manage Roster" link to /dashboard/marketplace/roster at bottom
- If teamPreview empty: show "No team members listed yet" with appropriate icon
- Max 6 members shown in preview; if roster_size > 6, show "+X more" text

**company/[id]/page.tsx:**
Company profile page at /dashboard/marketplace/company/[id].
- 'use client' component
- Uses useCompanyProfile(companyId) from React Query hooks
- Also fetch company reviews using existing reviews API pattern (GET /api/marketplace/companies/[id]/reviews)
- Determine isOwnProfile: compare current user's company admin_user_id
- Layout (vertical stack, max-w-4xl mx-auto):
  1. CompanyProfileCard (stats, description, badges)
  2. MeetTheTeam section (team preview)
  3. CompanyRatingsSummary (existing component from Phase 36 — already built, just render with companyId)
- Loading state: skeleton placeholders
- Not found state: "Company not found"
  </action>
  <verify>
Run: `ls web/app/\\(dashboard\\)/dashboard/marketplace/company/\\[id\\]/page.tsx web/components/marketplace/roster/CompanyProfileCard.tsx web/components/marketplace/roster/MeetTheTeam.tsx web/lib/marketplace/company-profile.ts` to confirm all files exist.
Verify page.tsx uses useCompanyProfile hook.
Verify CompanyProfileCard renders all 4 stat items (team size, rating, insurance, coverage).
Verify MeetTheTeam renders team members with qualification badges.
  </verify>
  <done>
Company profile page displays full company info with stats grid, team preview, and ratings summary. Profile card shows roster size, rating, insurance status, and coverage areas. Meet the Team section shows up to 6 active medics with names, qualifications, and availability indicators.
  </done>
</task>

<task type="auto">
  <name>Task 2: Availability modal, roster medic picker, and StaffingPlanSection wiring</name>
  <files>
web/components/marketplace/roster/MedicAvailabilityModal.tsx
web/components/marketplace/roster/RosterMedicPicker.tsx
web/components/marketplace/quote-submission/StaffingPlanSection.tsx
  </files>
  <action>
**MedicAvailabilityModal.tsx:**
Modal for company admin to set medic availability (date-range blocking).
- Props: medicId: string | null, medicName: string, isOpen: boolean, onClose: () => void, companyId: string
- Uses Dialog from @/components/ui/dialog
- Date range selection: "Unavailable from" and "Unavailable until" using date inputs (HTML input type="date" for simplicity — matches existing pattern, avoids importing heavy calendar component)
- Reason text input (optional): e.g., "Training", "Sick leave", "On assignment elsewhere"
- "Clear availability" button to remove unavailability (sets available=true, clears dates)
- Submit: PATCH /api/marketplace/roster/[medicId] with { available: false, unavailable_from, unavailable_until, unavailable_reason }
- Clear: PATCH /api/marketplace/roster/[medicId] with { available: true, unavailable_from: null, unavailable_until: null, unavailable_reason: null }
- Success: sonner toast, close modal, invalidate useCompanyRoster query
- Show current unavailability if medic already has dates set (pre-populate form)

**RosterMedicPicker.tsx:**
Reusable picker for selecting roster medics when building a staffing plan in quote submission.
- Props: companyId: string, onSelect: (medic: { medic_id: string, name: string, qualification: StaffingRole }) => void, excludeIds?: string[] (medics already selected in plan), requiredQualification?: StaffingRole
- Fetches active roster medics via useCompanyRoster(companyId, 'active')
- Filters out already-selected medics (excludeIds)
- If requiredQualification provided, filters to medics with matching qualification in their qualifications array
- Each row shows: medic name, title, qualifications as badges, availability indicator (green dot = available, amber dot = unavailable with date range tooltip)
- Clicking a medic calls onSelect with their id, name, and primary qualification
- Empty state: "No available medics matching these qualifications" or "All medics already assigned"
- Uses Popover or Dialog for the picker UI (rendered inline in the form, not a full modal)

**StaffingPlanSection.tsx (UPDATE existing file):**
Modify the existing named_medics flow to use RosterMedicPicker instead of free-text entry.

Current behavior: User types a medic name (free text) and selects a qualification from dropdown, then clicks "Add". This creates a StaffingPlanItem with a crypto.randomUUID() as medic_id.

New behavior:
- When staffing plan type is 'named_medics', replace the free-text name input + dropdown with the RosterMedicPicker component
- RosterMedicPicker needs companyId — get from useQuoteFormStore (add companyId to the store if not present) or from a prop. If companyId is not available (shouldn't happen for verified companies), fall back to free-text entry with a warning.
- When a medic is selected from the picker, call store.addNamedMedic with their real medic_id, name, and qualification from the roster
- The headcount_and_quals flow remains unchanged (no roster picker needed)
- Show "X available {qualification}" count next to each headcount row if roster data available (nice-to-have, implement if straightforward)
- CRITICAL: Preserve ALL existing headcount_and_quals functionality. Only modify the named_medics flow.
- Import RosterMedicPicker and wire the onSelect callback to addNamedMedic
- Pass excludeIds (already selected medic IDs from current staffing plan) to prevent double-selection
  </action>
  <verify>
Run: `ls web/components/marketplace/roster/MedicAvailabilityModal.tsx web/components/marketplace/roster/RosterMedicPicker.tsx web/components/marketplace/quote-submission/StaffingPlanSection.tsx` to confirm all files exist.
Verify StaffingPlanSection imports RosterMedicPicker.
Verify RosterMedicPicker uses useCompanyRoster hook.
Verify MedicAvailabilityModal PATCH request includes availability fields.
Run: `cd /Users/sabineresoagli/GitHub/sitemedic && pnpm --filter web exec tsc --noEmit --pretty 2>&1 | tail -20` to check TypeScript compilation.
  </verify>
  <done>
MedicAvailabilityModal allows date-range unavailability blocking with optional reason. RosterMedicPicker provides qualification-filtered, availability-aware medic selection for quote staffing plans. StaffingPlanSection is wired to real roster data — named medics are selected from the company's active roster (not free-text), enforcing roster membership at the UI level before the database trigger catches it.
  </done>
</task>

</tasks>

<verification>
1. Company profile page loads at /dashboard/marketplace/company/[id] with all aggregation stats
2. CompanyProfileCard shows roster_size, average_rating, insurance_status, coverage_areas
3. MeetTheTeam shows up to 6 active medics with names, qualifications, availability badges
4. MedicAvailabilityModal sets and clears date-range unavailability via PATCH
5. RosterMedicPicker filters by qualification and availability, excludes already-selected medics
6. StaffingPlanSection named_medics flow uses RosterMedicPicker (real roster data, not free text)
7. Headcount + qualifications flow in StaffingPlanSection remains unchanged
8. All components use existing UI library (Card, Badge, Dialog, Button, Input)
</verification>

<success_criteria>
- Company profile page renders correctly with all 4 stat metrics and team preview
- Availability modal saves date ranges and clear button removes them
- RosterMedicPicker shows only active, available medics matching required qualification
- StaffingPlanSection named_medics flow selects from roster (medic_id is real, not generated UUID)
- Removing a paramedic from roster causes them to not appear in the picker for paramedic-qualified quotes
- Insurance status badge shows correct color (green/red/gray)
</success_criteria>

<output>
After completion, create `.planning/phases/37-company-accounts/37-03-SUMMARY.md`
</output>
