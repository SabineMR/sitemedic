---
phase: 10-realtime-ops-polish
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - web/components/admin/MedicTrackingMap.tsx
autonomous: true

must_haves:
  truths:
    - "Map marker popup shows medic name, booking site name, and shift hours (e.g., 07:00-15:00)"
    - "Shift times display as HH:MM format, not HH:MM:SS"
    - "Popup gracefully handles missing shift times (no crash, no 'undefined')"
  artifacts:
    - path: "web/components/admin/MedicTrackingMap.tsx"
      provides: "Enhanced Popup with shift time display"
      contains: "shift_start_time"
  key_links:
    - from: "web/components/admin/MedicTrackingMap.tsx"
      to: "useMedicLocationsStore medicContext"
      via: "MedicLocation interface fields populated by Plan 10-01"
      pattern: "shift_start_time.*slice"
---

<objective>
Add shift time display to the command centre map marker popups, completing the "Kai Jensen — Royal Exchange Site, 07:00-15:00" requirement.

Purpose: Admins hovering over a map dot need to see the full context: who, where, and when. Plan 10-01 provides the data; this plan renders it.
Output: Updated `MedicTrackingMap.tsx` with shift times in the Leaflet Popup.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-realtime-ops-polish/10-RESEARCH.md
@.planning/phases/10-realtime-ops-polish/10-01-SUMMARY.md

@web/components/admin/MedicTrackingMap.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shift time fields to MedicLocation interface and render in Popup</name>
  <files>web/components/admin/MedicTrackingMap.tsx</files>
  <action>
  Modify `MedicTrackingMap.tsx` to display shift times in the map marker popup:

  1. **Update the MedicLocation interface** (defined at the top of this file, around line 15). Add two new optional fields:
     ```typescript
     shift_start_time?: string;  // PostgreSQL TIME: "07:00:00"
     shift_end_time?: string;    // PostgreSQL TIME: "15:00:00"
     ```
     These MUST be optional (`?`) because not all medic locations will have shift context (e.g., pings from medics without active bookings).

  2. **Update the Popup JSX** inside the existing `<Popup>` component. The popup currently renders `medic.medic_name` and `medic.site_name`. Add a shift time line below the existing content:
     ```tsx
     {medic.shift_start_time && medic.shift_end_time && (
       <div className="text-xs text-gray-500">
         Shift: {medic.shift_start_time.slice(0, 5)}{'\u2013'}{medic.shift_end_time.slice(0, 5)}
       </div>
     )}
     ```
     Use `.slice(0, 5)` because PostgreSQL TIME type returns `"07:00:00"` — slice to get `"07:00"`.
     Use en-dash (\u2013) between times for typographic correctness.

  3. **Ensure the popup shows the full format** matching success criteria: "Kai Jensen — Royal Exchange Site, 07:00-15:00". The existing popup already shows name and site; the shift times complete the picture. Verify the existing popup structure shows:
     - Line 1: medic_name (bold/prominent)
     - Line 2: site_name
     - Line 3 (new): Shift: 07:00-15:00

  **DO NOT:**
  - Make shift_start_time or shift_end_time required fields (would break existing data)
  - Add photo/avatar to the popup (no column exists in medics table)
  </action>
  <verify>
  1. Run `pnpm --filter web build` — no TypeScript errors
  2. Grep for shift_start_time in the file: `grep -n "shift_start_time" web/components/admin/MedicTrackingMap.tsx` — should show interface field and Popup JSX usage
  3. Grep for slice: `grep -n "slice(0, 5)" web/components/admin/MedicTrackingMap.tsx` — should show time formatting
  </verify>
  <done>
  - MedicLocation interface includes optional shift_start_time and shift_end_time fields
  - Popup displays shift times in HH:MM format when available
  - Popup gracefully hides shift line when times are not available
  - Full marker shows: "Name — Site, HH:MM-HH:MM" format
  - TypeScript builds without errors
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` passes
- MedicLocation interface has shift_start_time and shift_end_time as optional strings
- Popup conditionally renders shift times with .slice(0, 5) formatting
</verification>

<success_criteria>
Command centre map marker popup shows "Kai Jensen — Royal Exchange Site, 07:00-15:00" format when a medic with an active booking is displayed.
</success_criteria>

<output>
After completion, create `.planning/phases/10-realtime-ops-polish/10-02-SUMMARY.md`
</output>
