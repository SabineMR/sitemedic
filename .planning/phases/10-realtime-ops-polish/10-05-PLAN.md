---
phase: 10-realtime-ops-polish
plan: 05
type: execute
wave: 2
depends_on: ["10-04"]
files_modified:
  - web/components/admin/AlertPanel.tsx
  - web/app/admin/command-center/page.tsx
autonomous: true

must_haves:
  truths:
    - "Unacknowledged alerts older than 15 minutes show red pulsing border and background"
    - "Escalation sound fires once per alert when crossing the 15-minute threshold"
    - "Each alert type shows a suggested action text (9 types mapped)"
    - "Contact button shows 'Send Message' mailto fallback when medicPhone is null"
    - "Escalation uses triggered_at timestamp (not stale seconds_since_triggered)"
  artifacts:
    - path: "web/components/admin/AlertPanel.tsx"
      provides: "Escalation timer, suggested actions lookup, escalation sound"
      contains: "SUGGESTED_ACTIONS"
    - path: "web/app/admin/command-center/page.tsx"
      provides: "Send Message fallback button when medicPhone is null"
      contains: "Send Message"
  key_links:
    - from: "AlertPanel escalation check"
      to: "alert.triggered_at"
      via: "client-side elapsed time calculation"
      pattern: "Date\\.now\\(\\).*triggered_at"
    - from: "AlertPanel escalation sound"
      to: "playAlertSound(severity)"
      via: "useRef Set tracking fired alert IDs"
      pattern: "escalatedRef.*playAlertSound"
    - from: "command-center page"
      to: "mailto fallback"
      via: "!medicPhone conditional render"
      pattern: "!medicPhone.*Send Message"
---

<objective>
Add auto-escalation (red pulse + sound) for 15-minute unacknowledged alerts, suggested actions per alert type, and a contact fallback when medicPhone is null.

Purpose: Admins need visual urgency for stale alerts, guidance on what to do for each alert type, and a way to contact medics even when phone number is missing.
Output: Updated `AlertPanel.tsx` with escalation, suggested actions, and sound. Updated `command-center/page.tsx` with mailto fallback button.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-realtime-ops-polish/10-RESEARCH.md
@.planning/phases/10-realtime-ops-polish/10-04-SUMMARY.md

@web/components/admin/AlertPanel.tsx
@web/stores/useMedicAlertsStore.ts
@web/app/admin/command-center/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add suggested actions, escalation timer, and escalation sound to AlertPanel</name>
  <files>web/components/admin/AlertPanel.tsx</files>
  <action>
  Modify `AlertPanel.tsx` to add three features: suggested actions, auto-escalation visual, and escalation sound.

  **A. Suggested Actions (static lookup table)**

  1. Add a `SUGGESTED_ACTIONS` constant near the top of the file (outside the component, alongside any existing `getAlertIcon` or styling helpers):
     ```typescript
     const SUGGESTED_ACTIONS: Record<string, string> = {
       battery_low: 'Contact medic to ensure device is charging',
       battery_critical: 'Call medic immediately — device may go offline',
       late_arrival: 'Call medic — may need to arrange replacement',
       early_departure: 'Call medic to confirm departure reason',
       connection_lost: 'Call medic — may need assistance',
       not_moving_20min: 'Call medic to check status',
       geofence_failure: 'Verify medic is at the correct site',
       gps_accuracy_poor: 'Ask medic to move to an open area for better signal',
       shift_overrun: 'Confirm whether shift is being extended or medic should depart',
     };
     ```

  2. Render the suggested action inside each alert card, below the alert details:
     ```tsx
     {SUGGESTED_ACTIONS[alert.alert_type] && (
       <p className="mt-1 text-xs italic text-gray-500">
         Suggested: {SUGGESTED_ACTIONS[alert.alert_type]}
       </p>
     )}
     ```

  **B. Auto-Escalation Visual (15-minute threshold)**

  3. Add a `useRef` import (if not already imported) and a tick state for live re-rendering:
     ```typescript
     import { useEffect, useState, useRef } from 'react';

     // Inside the component:
     const [tick, setTick] = useState(0);
     useEffect(() => {
       const interval = setInterval(() => setTick(t => t + 1), 60_000); // Re-render every 60s
       return () => clearInterval(interval);
     }, []);
     ```

  4. For each alert in the render, compute escalation status from `triggered_at` (NOT `seconds_since_triggered` — that value is stale from fetch time, per Pitfall 3 from research):
     ```typescript
     const elapsedSeconds = Math.floor(
       (Date.now() - new Date(alert.triggered_at).getTime()) / 1000
     );
     const isEscalated = elapsedSeconds >= 900 && !alert.is_dismissed; // 15 minutes
     ```

  5. Apply escalation CSS to the alert card:
     ```tsx
     className={`... ${
       isEscalated ? 'animate-pulse border-red-600 bg-red-900/20' : ''
     }`}
     ```
     Merge this with the existing alert card class logic. The escalation styling should override the normal severity-based border/background.

  **C. Escalation Sound (fire once per alert)**

  6. Add a ref to track which alerts have already fired the escalation sound:
     ```typescript
     const escalatedSoundRef = useRef<Set<string>>(new Set());
     ```

  7. Add a `useEffect` that checks for newly escalated alerts and plays the sound once:
     ```typescript
     const playAlertSound = useMedicAlertsStore((state) => state.playAlertSound);

     useEffect(() => {
       alerts.forEach(alert => {
         if (alert.is_dismissed) return;
         const elapsed = Math.floor(
           (Date.now() - new Date(alert.triggered_at).getTime()) / 1000
         );
         if (elapsed >= 900 && !escalatedSoundRef.current.has(alert.id)) {
           escalatedSoundRef.current.add(alert.id);
           playAlertSound(alert.alert_severity);
         }
       });
     }, [alerts, tick, playAlertSound]);
     ```
     The `tick` dependency ensures this re-evaluates every 60 seconds. The `Set<string>` ref ensures each alert's escalation sound fires only once, not repeatedly.

  **DO NOT:**
  - Use `alert.seconds_since_triggered` for escalation — it is stale (calculated at query time, never updates)
  - Fire the escalation sound on every tick — use the ref Set to fire once per alert
  - Apply escalation styling to dismissed alerts
  </action>
  <verify>
  1. Run `pnpm --filter web build` — no TypeScript errors
  2. Grep for SUGGESTED_ACTIONS: `grep -n "SUGGESTED_ACTIONS" web/components/admin/AlertPanel.tsx` — should show Record and usage
  3. Grep for triggered_at usage: `grep -n "triggered_at" web/components/admin/AlertPanel.tsx` — should show elapsed calculation
  4. Grep for escalation: `grep -n "isEscalated\|escalatedSoundRef\|animate-pulse" web/components/admin/AlertPanel.tsx` — should show all three
  5. Verify tick timer: `grep -n "setTick\|60_000" web/components/admin/AlertPanel.tsx` — should show 60-second interval
  6. Verify NO seconds_since_triggered usage for escalation: `grep -n "seconds_since_triggered" web/components/admin/AlertPanel.tsx` — should NOT appear in escalation logic
  </verify>
  <done>
  - All 9 alert types have suggested action text displayed
  - Alerts unacknowledged >15 minutes show animate-pulse + red border + red background
  - Escalation computed from triggered_at (not seconds_since_triggered)
  - Escalation sound fires once per alert via ref-tracked Set
  - 60-second re-render interval keeps escalation status live
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Send Message" mailto fallback when medicPhone is null</name>
  <files>web/app/admin/command-center/page.tsx</files>
  <action>
  Modify the command centre page to show a "Send Message" fallback button when `medicPhone` is null:

  1. Read `command-center/page.tsx` to find the existing contact buttons. Currently both "Call" and "SMS" buttons are `disabled={!medicPhone}` when the selected medic has no phone number.

  2. **Add a fallback button** that appears INSTEAD OF the disabled buttons when `medicPhone` is null (not falsy due to empty string — check for `!medicPhone`):
     ```tsx
     {!medicPhone && selectedMedic && (
       <a
         href={`mailto:?subject=${encodeURIComponent(`Message for ${selectedMedic.medic_name}`)}&body=${encodeURIComponent(`Hi ${selectedMedic.medic_name},\n\n`)}`}
         className="flex-1 inline-flex items-center justify-center gap-2 rounded-lg bg-purple-600 py-3 text-sm font-medium text-white hover:bg-purple-700"
       >
         Send Message
       </a>
     )}
     ```
     Alternatively, if the medic's email is available from the store/context, use it as the mailto recipient. Check the selectedMedic object for an email field.

  3. **Conditionally show the existing Call/SMS buttons** only when `medicPhone` is truthy:
     ```tsx
     {medicPhone && (
       <>
         {/* existing Call button */}
         {/* existing SMS button */}
       </>
     )}
     ```

  4. The "Send Message" button should be visually distinct (purple or blue) to differentiate from Call (green) and SMS (blue) buttons.

  **Read the full page.tsx first** to understand the existing contact button structure before modifying.
  </action>
  <verify>
  1. Run `pnpm --filter web build` — no TypeScript errors
  2. Grep for "Send Message": `grep -n "Send Message" web/app/admin/command-center/page.tsx` — should show fallback button
  3. Grep for medicPhone conditional: `grep -n "!medicPhone" web/app/admin/command-center/page.tsx` — should show the fallback conditional
  </verify>
  <done>
  - When medicPhone is null and a medic is selected, "Send Message" mailto button appears
  - When medicPhone exists, normal Call/SMS buttons appear
  - No buttons are disabled with no alternative action
  - TypeScript builds without errors
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` passes
- 9 alert types have suggested actions
- Escalation triggers at 15 minutes using triggered_at
- Escalation sound fires once per alert
- Contact fallback shows "Send Message" when medicPhone is null
</verification>

<success_criteria>
1. Unacknowledged geofence_failure alert escalates to red pulsing state after 15 minutes
2. Each alert type shows a contextual suggested action
3. Escalation sound fires once (not repeatedly) per alert
4. Admins can contact medics even when phone number is missing
</success_criteria>

<output>
After completion, create `.planning/phases/10-realtime-ops-polish/10-05-SUMMARY.md`
</output>
