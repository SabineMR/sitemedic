---
phase: 10-realtime-ops-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - web/components/booking/payment-form.tsx
autonomous: true
user_setup:
  - service: support-email
    why: "Payment failure mailto link"
    env_vars:
      - name: NEXT_PUBLIC_SUPPORT_EMAIL
        source: "Set in .env.local — e.g., support@sitemedic.co.uk"

must_haves:
  truths:
    - "User sees a Retry button after payment failure that re-attempts the same PaymentIntent"
    - "User sees a Contact Support mailto link with the booking reference number pre-filled"
    - "User sees their booking reference number (bookingId) on the failure screen"
    - "Retrying payment does not remount Elements or destroy the PaymentIntent context"
  artifacts:
    - path: "web/components/booking/payment-form.tsx"
      provides: "Payment retry UI with retry button, support link, reference number"
      contains: "paymentFailed"
  key_links:
    - from: "web/components/booking/payment-form.tsx retry button"
      to: "stripe.confirmPayment"
      via: "same handleSubmit function called again"
      pattern: "confirmPayment"
    - from: "web/components/booking/payment-form.tsx support link"
      to: "NEXT_PUBLIC_SUPPORT_EMAIL"
      via: "mailto href with bookingId"
      pattern: "mailto.*SUPPORT_EMAIL"
---

<objective>
Add a payment failure recovery UI: retry button, "Contact Support" mailto link, and booking reference number display so users can self-recover from payment failures.

Purpose: Payment failures currently leave users stuck with a red error box and no actions. This plan gives them a clear path to retry or get help.
Output: Updated `payment-form.tsx` with retry state, retry button, support link, and reference number.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-realtime-ops-polish/10-RESEARCH.md

@web/components/booking/payment-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add payment retry button, reference number, and support mailto to CheckoutForm</name>
  <files>web/components/booking/payment-form.tsx</files>
  <action>
  Modify the `CheckoutForm` component in `payment-form.tsx` to add payment failure recovery:

  1. **Add state for payment failure tracking:**
     ```typescript
     const [paymentFailed, setPaymentFailed] = useState(false);
     ```

  2. **Update the error handling in handleSubmit** (the existing function that calls `stripe.confirmPayment`). After the existing `setError(submitError.message)` line, add:
     ```typescript
     setPaymentFailed(true);
     ```
     This tracks that a failure has occurred so we can show the recovery UI.

  3. **When retry is clicked, reset error state before re-attempting.** The retry button should call the same `handleSubmit` function. At the top of `handleSubmit`, add:
     ```typescript
     setError(null);
     setPaymentFailed(false);
     ```
     This clears the previous error before re-attempting. The same `stripe.confirmPayment` call with the same `clientSecret` (already held in `<Elements>` context) safely re-attempts the PaymentIntent.

  4. **Add the failure recovery UI in JSX**, shown when `paymentFailed` is true. Place this BELOW the existing error message display:
     ```tsx
     {paymentFailed && (
       <div className="space-y-4 rounded-lg border border-red-200 bg-red-50 p-4">
         <div className="text-sm text-gray-700">
           <p className="font-medium">Reference: {bookingId}</p>
           <p className="mt-1 text-gray-500">Please quote this reference if contacting support.</p>
         </div>

         <div className="flex flex-col gap-2 sm:flex-row">
           <Button
             type="submit"
             variant="outline"
             disabled={loading}
             className="flex-1"
           >
             {loading ? 'Retrying...' : 'Try Again'}
           </Button>

           <a
             href={`mailto:${process.env.NEXT_PUBLIC_SUPPORT_EMAIL ?? 'support@sitemedic.co.uk'}?subject=${encodeURIComponent(`Payment Issue - Ref ${bookingId}`)}`}
             className="flex-1 inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
           >
             Contact Support
           </a>
         </div>
       </div>
     )}
     ```

  5. **Ensure the form wraps the retry button.** The retry button has `type="submit"` so it triggers the existing form's `onSubmit` handler (which calls `handleSubmit`). Verify the button is inside the `<form>` element.

  **CRITICAL — DO NOT:**
  - Add a `key` prop to `<Elements>` that changes on error/retry — this would destroy the PaymentIntent context (Pitfall 2 from research)
  - Remount `<Elements>` — keep the same `clientSecret`
  - Create a new PaymentIntent on retry — the existing one is reusable
  - Hardcode the support email — use `process.env.NEXT_PUBLIC_SUPPORT_EMAIL` with fallback

  **Note:** The `bookingId` is already a prop to `CheckoutForm` (verified from line 20 of the file: `{ bookingId, total }`). No changes needed to prop drilling.
  </action>
  <verify>
  1. Run `pnpm --filter web build` — no TypeScript errors
  2. Grep for paymentFailed: `grep -n "paymentFailed" web/components/booking/payment-form.tsx` — should show state, setter in error handler, and JSX conditional
  3. Grep for SUPPORT_EMAIL: `grep -n "SUPPORT_EMAIL" web/components/booking/payment-form.tsx` — should show env var usage in mailto
  4. Grep for bookingId in JSX: `grep -n "Reference.*bookingId" web/components/booking/payment-form.tsx` — should show reference number display
  5. Verify no key prop on Elements: `grep -n "key=" web/components/booking/payment-form.tsx` — should NOT show a dynamic key on Elements
  </verify>
  <done>
  - Payment failure shows a Retry button that calls the same handleSubmit (same PaymentIntent)
  - Booking reference number (bookingId) is displayed prominently
  - "Contact Support" mailto link uses NEXT_PUBLIC_SUPPORT_EMAIL env var with bookingId in subject
  - Elements component is NOT remounted on retry
  - TypeScript builds without errors
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web build` passes
- Retry button triggers same handleSubmit (no new PaymentIntent)
- Reference number visible on failure screen
- Mailto link includes booking reference in subject
- No Elements remounting on retry
</verification>

<success_criteria>
Payment failure page has a working retry button that re-attempts the same payment intent, a booking reference number, and a Contact Support mailto link.
</success_criteria>

<output>
After completion, create `.planning/phases/10-realtime-ops-polish/10-03-SUMMARY.md`
</output>
