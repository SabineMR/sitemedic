# 49-01 Plan — SOLO + PASS-ON Operational Attribution Lifecycle

## Objective

Implement the first operational attribution slice for Phase 49 by shipping end-to-end SOLO and PASS-ON lifecycle handling (initiate, accept/decline, and chain-of-custody visibility) on top of Phase 48 provenance invariants.

Purpose: make attribution operational (not just schema-level) while enforcing locked policies:
- pass-on keeps original provenance by default,
- client self-attestation is never treated as a primary integrity control,
- co-share behavior is explicitly deferred to 49-02 (no Scenario C implementation in this plan).

## Requirements Coverage IDs

- `INT-05` — SOLO lifecycle attribution is explicit, queryable, and immutable in practice.
- `INT-06` — PASS-ON lifecycle preserves origin provenance and fee policy through handoff acceptance.
- `INT-07` — Chain-of-custody events are append-only, actor-attributed, and auditable.
- `INT-08` — Integrity control is system-enforced (server/db signals), not client self-attestation.

## Atomic Tasks With Target Files

### Task 1 — Add SOLO/PASS-ON attribution operations schema (foundation)

**Target files**
- `supabase/migrations/165_marketplace_integrity_operations_solo_pass_on.sql`
- `web/lib/marketplace/attribution/types.ts`
- `web-marketplace/lib/marketplace/attribution-types.ts`

**Action**
- Create pass-on operational tables for handoff state and custody history (append-only history table + handoff table).
- Add lifecycle enums/statuses for SOLO/PASS-ON only (`solo`, `pass_on_pending`, `pass_on_accepted`, `pass_on_declined`).
- Add DB constraints/triggers that enforce:
  - origin provenance is inherited on pass-on (no implicit reclassification),
  - fee policy snapshot remains consistent with inherited provenance,
  - custody rows are append-only and actor/timestamp attributed.
- Add indexes for `origin_event_id`, `event_id`, and handoff status lookup.
- Do not add co-share writes in this migration (reserved for 49-02).

### Task 2 — Implement PASS-ON operational write flows with invariant enforcement

**Target files**
- `web/lib/marketplace/attribution/service.ts`
- `web/app/api/marketplace/attribution/pass-on/route.ts`
- `web/app/api/marketplace/attribution/pass-on/[handoffId]/accept/route.ts`
- `web/app/api/marketplace/attribution/pass-on/[handoffId]/decline/route.ts`
- `web/lib/marketplace/booking-bridge.ts`
- `web-marketplace/lib/marketplace/booking-bridge.ts`

**Action**
- Add service-layer functions to initiate, accept, and decline pass-on handoffs.
- Enforce accepting-party authorization and ownership checks server-side (not UI trust).
- On accept, persist downstream linkage while preserving original `source_provenance` and `source_origin_event_id`.
- Emit custody events for `initiated`, `accepted`, `declined` transitions with actor metadata.
- Ensure booking bridge preserves origin attribution snapshot for any pass-on-derived booking records.
- Explicitly avoid any dependency on client confirmation fields for control decisions.

### Task 3 — Add attribution read-model, timeline surface, and regression tests

**Target files**
- `web/app/api/marketplace/attribution/events/[eventId]/route.ts`
- `web/lib/queries/marketplace/attribution.ts`
- `web/components/marketplace/attribution/AttributionChainTimeline.tsx`
- `web/app/(dashboard)/dashboard/jobs/[id]/page.tsx`
- `web/lib/marketplace/attribution/__tests__/pass-on-invariants.test.ts`

**Action**
- Add read API that returns attribution lifecycle state + full custody timeline for an event/job.
- Add a dashboard timeline panel showing SOLO/PASS-ON state, origin reference, and custody entries (actor + timestamp + event).
- Add focused Vitest coverage for pass-on invariant helpers:
  - origin provenance inheritance,
  - no drift on accept,
  - custody sequence correctness.
- Keep UI/data model scoped to SOLO/PASS-ON only; co-share labels/logic excluded.

## Verification Strategy

- `rg -n "pass_on|attribution|chain_of_custody|source_origin_event_id" supabase/migrations/165_marketplace_integrity_operations_solo_pass_on.sql`
- `rg -n "source_provenance|fee_policy|source_origin_event_id" web/app/api/marketplace/attribution web/lib/marketplace/attribution web/lib/marketplace/booking-bridge.ts web-marketplace/lib/marketplace/booking-bridge.ts`
- `pnpm --dir web test -- web/lib/marketplace/attribution/__tests__/pass-on-invariants.test.ts`
- `pnpm --dir web exec tsc --noEmit`
- `pnpm --dir web-marketplace exec tsc --noEmit`

## Risks + Mitigations

- **Risk:** hidden write paths bypass PASS-ON service and miss custody logging.
  - **Mitigation:** centralize write logic in `attribution/service.ts` and grep for direct writes in verification.
- **Risk:** provenance drift sneaks in via booking bridge updates.
  - **Mitigation:** preserve origin snapshot in both bridge implementations and assert with tests.
- **Risk:** lifecycle mismatch between handoff and custody tables.
  - **Mitigation:** constrain status transitions at DB level and write custody rows transactionally.
- **Risk:** co-share scope leaks into 49-01 and inflates complexity.
  - **Mitigation:** hard-scope to SOLO/PASS-ON statuses; defer Scenario C to 49-02.

## Suggested Commit Slices

1. `feat(49-01): add solo/pass-on attribution operations schema and custody ledger`
2. `feat(49-01): implement pass-on initiate/accept/decline APIs with invariant checks`
3. `feat(49-01): preserve origin attribution in booking bridge pass-on paths`
4. `feat(49-01): add attribution timeline API/UI and pass-on invariant tests`

## Must-Have Observable Truths

1. A company can run a SOLO lifecycle and the job shows a stable attribution state with no handoff events.
2. A company can initiate PASS-ON and the receiving company can accept or decline through explicit operational endpoints.
3. When PASS-ON is accepted, original provenance remains unchanged by default (no implicit reclassification).
4. Fee-policy snapshot remains aligned with inherited provenance during PASS-ON transitions.
5. Every SOLO/PASS-ON state change is visible in a chain-of-custody timeline with actor and timestamp.
6. The lifecycle remains enforceable without relying on client self-attestation as a primary integrity gate.
