---
phase: 02-mobile-core
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - mobile/app/treatment/new.tsx
  - mobile/app/treatment/[id].tsx
  - mobile/components/forms/BodyDiagramPicker.tsx
  - mobile/components/forms/AutoSaveForm.tsx
autonomous: true

must_haves:
  truths:
    - "Medic can log full treatment with photos and signature in under 90 seconds"
    - "Treatment logger auto-saves locally every 10 seconds"
    - "Treatment captures: worker, injury type, body part, mechanism, treatment, photos, signature, outcome"
    - "Each treatment gets unique reference number (SITE-YYYYMMDD-NNN format)"
  artifacts:
    - path: "mobile/app/treatment/new.tsx"
      provides: "New treatment workflow screen"
      min_lines: 100
    - path: "mobile/app/treatment/[id].tsx"
      provides: "Treatment view/edit screen"
      min_lines: 80
    - path: "mobile/components/forms/AutoSaveForm.tsx"
      provides: "WatermelonDB-bound auto-save form wrapper"
      min_lines: 40
    - path: "mobile/components/forms/BodyDiagramPicker.tsx"
      provides: "Body part selection via tappable regions or pick list"
      min_lines: 50
  key_links:
    - from: "mobile/app/treatment/new.tsx"
      to: "mobile/components/forms/AutoSaveForm.tsx"
      via: "Wraps treatment form for auto-save"
      pattern: "AutoSaveForm|withObservables"
    - from: "mobile/app/treatment/new.tsx"
      to: "mobile/components/forms/PhotoCapture.tsx"
      via: "Import for treatment photos"
      pattern: "PhotoCapture"
    - from: "mobile/app/treatment/new.tsx"
      to: "mobile/components/forms/SignaturePad.tsx"
      via: "Import for treatment signature"
      pattern: "SignaturePad"
    - from: "mobile/app/treatment/new.tsx"
      to: "mobile/services/taxonomy/injury-types.ts"
      via: "Import INJURY_TYPES for pick list"
      pattern: "INJURY_TYPES"
---

<objective>
Build the full treatment logging workflow with auto-save, supporting all TREAT-01 through TREAT-10 and TREAT-12 requirements for the complete treatment log mode.

Purpose: Treatment logging is the core clinical workflow. A medic must capture worker, injury details, body part, treatment given, photos, signature, and outcome in under 90 seconds. Auto-save ensures zero data loss even if interrupted by patient care.
Output: New treatment screen, treatment view/edit screen, auto-save form wrapper, body diagram picker.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-core/02-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AutoSaveForm wrapper and BodyDiagramPicker</name>
  <files>mobile/components/forms/AutoSaveForm.tsx, mobile/components/forms/BodyDiagramPicker.tsx</files>
  <action>
  **AutoSaveForm.tsx:**
  Follow research Pattern 1 (Auto-Save Form with WatermelonDB Reactive Observables).

  Create a reusable auto-save hook (not HOC -- hooks are more flexible with Expo Router):

  ```
  export function useAutoSave<T extends Model>(
    record: T,
    formValues: Record<string, any>,
    fieldMapping: Record<string, string>, // form field -> model field mapping
    debounceMs: number = 500
  ): { isSaving: boolean; lastSaved: number | null }
  ```

  - Uses useEffect watching formValues
  - Debounces updates by debounceMs (default 500ms, satisfies TREAT-10 "auto-save every 10 seconds" -- 500ms is even better)
  - Calls record.update() with mapped fields
  - Tracks isSaving state and lastSaved timestamp
  - Shows subtle "Saved" indicator when auto-save completes
  - Catches and logs errors without crashing (defensive)

  Also export AutoSaveIndicator component:
  - Shows "Saving..." during save, "Saved {time}" after, nothing initially
  - Small text at top of form, grey color, does not take tap target space

  **BodyDiagramPicker.tsx:**
  - Props: selectedBodyPart: string | null, onSelect: (bodyPartId: string) => void
  - Renders BODY_PARTS array from taxonomy as a grid of large tappable buttons (2 columns)
  - Each button: 56pt height, shows body part label
  - Selected button: highlighted with thicker border and blue background
  - Uses BottomSheetPicker for presentation (opens as bottom sheet modal)
  - Optionally: simple body outline SVG with tappable regions (if time permits, otherwise grid buttons are sufficient and faster to build)
  - Import BODY_PARTS from services/taxonomy/body-parts.ts
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit`.
  Verify useAutoSave hook accepts a WatermelonDB Model and debounce parameter.
  Verify BodyDiagramPicker imports BODY_PARTS taxonomy.
  Verify BodyDiagramPicker renders 56pt tap targets.
  </verify>
  <done>useAutoSave hook provides debounced auto-persistence to WatermelonDB for any form. BodyDiagramPicker shows body parts as tappable grid with 56pt targets.</done>
</task>

<task type="auto">
  <name>Task 2: Build complete treatment logging workflow</name>
  <files>mobile/app/treatment/new.tsx, mobile/app/treatment/[id].tsx</files>
  <action>
  **new.tsx (New Treatment Workflow):**
  This is the full treatment form (TREAT-12) capturing all clinical data.

  On screen mount:
  1. Create new Treatment record in WatermelonDB immediately (empty record with generated ID)
  2. Generate reference number: format SITE-YYYYMMDD-NNN where NNN is sequential daily count (TREAT-09)
     - Query today's treatments count, increment
  3. Set created_at to Date.now() (epoch ms per D-01-03-002)
  4. Wire useAutoSave hook to persist all field changes

  Form layout (single scrollable screen, NOT multi-step wizard per research anti-pattern):

  Section 1 - Worker Selection:
  - WorkerSearchPicker component (from Plan 03)
  - If Plan 03 not yet built, create placeholder with TextInput

  Section 2 - Injury Details:
  - Injury/Illness Category: BottomSheetPicker with INJURY_TYPES taxonomy (TREAT-02)
  - Body Part: BodyDiagramPicker component (TREAT-03)
  - Mechanism of Injury: TextInput (multiline, 80px min height) + common presets as chips above (e.g., "Struck by object", "Fall", "Manual handling", "Contact with sharp edge") (TREAT-04)

  Section 3 - Treatment Given:
  - Treatment picker: BottomSheetPicker with TREATMENT_TYPES taxonomy (TREAT-05), allow multiple selections
  - Additional notes: TextInput (multiline) for free text detail

  Section 4 - Photos:
  - PhotoCapture component with maxPhotos=4 (TREAT-06)
  - Photo URIs stored as JSON string in treatment record (photo_uris field)

  Section 5 - Outcome:
  - BottomSheetPicker with OUTCOME_CATEGORIES taxonomy (TREAT-07)

  Section 6 - Signature:
  - "Capture Signature" button opens SignaturePad modal (TREAT-08)
  - After capture, show signature preview image
  - Signature stored as base64 string in treatment record

  Footer:
  - AutoSaveIndicator showing save status
  - "Complete Treatment" button (56pt, primary) -- marks treatment as status='complete'
  - "Save Draft" text link -- treatment already auto-saved, this just navigates back

  RIDDOR detection: If selected injury type has isRiddorReportable: true, show amber warning banner: "This may be RIDDOR reportable. It will be flagged for review." Set riddor_flagged: true on record.

  **[id].tsx (Treatment View/Edit):**
  - Load treatment by ID from route params
  - Read-only view if status='complete', editable if status='draft'
  - Display all fields with labels
  - Photos displayed as full-width images
  - Signature displayed as image
  - "Edit" button switches to edit mode (re-uses same form layout)
  - RIDDOR flag shown prominently if set

  All inputs use fontSize: 18, all buttons 56pt minimum height.
  High contrast colors throughout (UX-02).
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit`.
  Verify new.tsx creates Treatment record on mount.
  Verify reference number generation uses SITE-YYYYMMDD-NNN format.
  Verify form has all 6 sections: Worker, Injury, Treatment, Photos, Outcome, Signature.
  Verify INJURY_TYPES, TREATMENT_TYPES, OUTCOME_CATEGORIES, BODY_PARTS imported from taxonomy.
  Verify RIDDOR warning banner shown when isRiddorReportable is true.
  Verify useAutoSave is wired to treatment record.
  Verify PhotoCapture and SignaturePad components are imported.
  </verify>
  <done>Full treatment workflow captures all clinical data in single scrollable form with auto-save. Reference numbers generated. RIDDOR auto-flagging on injury selection. Photos (up to 4) and digital signature supported. Draft/complete status tracking.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd mobile && npx tsc --noEmit`
- Treatment form has all fields per TREAT-01 through TREAT-12
- Auto-save persists to WatermelonDB on every field change (debounced 500ms)
- Reference number format: SITE-YYYYMMDD-NNN
- RIDDOR flag triggers on RIDDOR injury types
- Photos limited to 4, signature captured in full-screen modal
</verification>

<success_criteria>
- TREAT-01: Worker selection via search picker with quick-add
- TREAT-02: Injury category from RIDDOR + minor taxonomy
- TREAT-03: Body part via tappable picker
- TREAT-04: Mechanism with presets + free text
- TREAT-05: Treatment from pick list + free text
- TREAT-06: Up to 4 compressed photos
- TREAT-07: Outcome from pick list
- TREAT-08: Digital signature capture
- TREAT-09: Unique reference SITE-YYYYMMDD-NNN
- TREAT-10: Auto-save every 500ms (exceeds 10s requirement)
- TREAT-12: Full log mode with all details
- All tap targets 56pt minimum, high contrast
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-core/02-04-SUMMARY.md`
</output>
