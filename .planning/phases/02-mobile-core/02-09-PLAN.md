---
phase: 02-mobile-core
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/app/treatment/new.tsx
  - mobile/components/forms/AutoSaveForm.tsx
  - mobile/app/safety/daily-check.tsx
  - mobile/app/safety/near-miss.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Treatment auto-saves locally every 10 seconds when form values change"
    - "Auto-save indicator shows 'Saving...' during save and 'Saved {time}' after"
    - "All forms using auto-save use consistent 10-second interval"
  artifacts:
    - path: "mobile/app/treatment/new.tsx"
      provides: "Treatment form with 10s auto-save interval"
      contains: "useAutoSave.*10000"
    - path: "mobile/components/forms/AutoSaveForm.tsx"
      provides: "useAutoSave hook with 10000ms default"
      contains: "debounceMs.*10000"
  key_links:
    - from: "mobile/app/treatment/new.tsx"
      to: "mobile/components/forms/AutoSaveForm.tsx"
      via: "useAutoSave hook call with 10000ms"
      pattern: "useAutoSave.*10000"
---

<objective>
Fix auto-save timing to match TREAT-10 requirement (10 seconds) and verify template preset completeness for sub-30-second workflow.

Purpose: Close 2 verification gaps -- the BLOCKER (auto-save 500ms vs 10s) and the WARNING (template preset structure unclear). The auto-save timing is a documented deviation that needs resolution. The template presets need taxonomy ID validation.

Output: Auto-save interval corrected to 10 seconds across all forms. Template presets confirmed as complete with valid taxonomy IDs.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-core/02-04-SUMMARY.md
@.planning/phases/02-mobile-core/02-05-SUMMARY.md
@.planning/phases/02-mobile-core/02-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix auto-save timing to 10 seconds and verify template presets</name>
  <files>
    mobile/app/treatment/new.tsx
    mobile/components/forms/AutoSaveForm.tsx
    mobile/app/safety/daily-check.tsx
    mobile/app/safety/near-miss.tsx
    mobile/services/taxonomy/injury-types.ts
    mobile/services/taxonomy/treatment-types.ts
    mobile/services/taxonomy/body-parts.ts
    mobile/services/taxonomy/outcome-categories.ts
    mobile/app/treatment/templates.tsx
  </files>
  <action>
    **Auto-save timing fix (BLOCKER):**

    1. In `mobile/components/forms/AutoSaveForm.tsx`, change the default debounceMs parameter from 500 to 10000:
       - Line 39: Change `debounceMs: number = 500` to `debounceMs: number = 10000`
       - Update the JSDoc comment on line 32 to say "default 10000ms (10 seconds)" instead of "default 500ms"
       - Update the file header comment on line 5 to say "Debounced auto-save (default 10s)" instead of "default 500ms"
       - Update the usage example in the header comment to show `10000` instead of `500`

    2. In `mobile/app/treatment/new.tsx`, line 173: Change `useAutoSave(treatment, formValues, fieldMapping, 500)` to `useAutoSave(treatment, formValues, fieldMapping, 10000)`
       - This matches TREAT-10 requirement: "Treatment auto-saves locally every 10 seconds"

    3. Check `mobile/app/safety/daily-check.tsx` for any auto-save usage -- if it uses useAutoSave with an explicit 500ms value, change to 10000. If it uses the default (no explicit value), the default change in step 1 will handle it. Decision D-02-07-008 specified "Auto-save debounce 500ms on field changes" for daily checks, but this was before the requirement was clarified. Update to 10000 for consistency.

    4. Check `mobile/app/safety/near-miss.tsx` for any auto-save usage. If found, update similarly.

    **Why 10 seconds instead of 500ms:** The success criteria (TREAT-10) explicitly states "auto-saves locally every 10 seconds." While 500ms was chosen for better UX responsiveness, this creates a requirement mismatch that fails verification. 10 seconds is appropriate because: (a) it reduces unnecessary database writes on every keystroke, (b) WatermelonDB writes are synchronous on the main thread and frequent writes can cause UI jank, (c) 10 seconds is still fast enough that no meaningful work is lost if the app crashes.

    **Template preset verification (WARNING):**

    5. Read each taxonomy file and verify that the taxonomy IDs used in PRESET_TEMPLATES (in `mobile/app/treatment/templates.tsx`) match actual entries:
       - `laceration` must exist in injury-types.ts
       - `contusion` must exist in injury-types.ts
       - `headache` must exist in injury-types.ts
       - `splinter` must exist in injury-types.ts
       - `foreign-body-eye` must exist in injury-types.ts
       - `sprain-strain` must exist in injury-types.ts
       - `minor-burn` must exist in injury-types.ts
       - `nausea-dizziness` must exist in injury-types.ts
       - `cleaned-dressed` must exist in treatment-types.ts
       - `ice-pack` must exist in treatment-types.ts
       - `rest-welfare` must exist in treatment-types.ts
       - `removed-foreign-body` must exist in treatment-types.ts
       - `eye-wash` must exist in treatment-types.ts
       - `wrist-hand`, `arm-elbow`, `head-face`, `finger-thumb`, `eye`, `ankle-foot` must exist in body-parts.ts
       - `returned-to-work-same-duties`, `returned-to-work-light-duties` must exist in outcome-categories.ts

    6. If any taxonomy ID does NOT match, fix the ID in templates.tsx to match the actual taxonomy. Log any mismatches found.

    7. If all IDs match, add a code comment at the top of PRESET_TEMPLATES array: `// All taxonomy IDs verified against: injury-types.ts, treatment-types.ts, body-parts.ts, outcome-categories.ts`
  </action>
  <verify>
    Run these grep commands to confirm:
    - `grep -n 'debounceMs.*10000' mobile/components/forms/AutoSaveForm.tsx` -- should show default parameter
    - `grep -n 'useAutoSave.*10000' mobile/app/treatment/new.tsx` -- should show 10000 on line ~173
    - `grep -n 'taxonomy IDs verified' mobile/app/treatment/templates.tsx` -- should show verification comment
    - Verify no remaining instances of 500ms debounce: `grep -rn 'useAutoSave.*500' mobile/` should return NO results
  </verify>
  <done>
    - AutoSaveForm.tsx default changed from 500 to 10000
    - treatment/new.tsx auto-save call uses 10000ms
    - All other auto-save callers use 10000ms (or the new default)
    - All 8 template preset taxonomy IDs verified against actual taxonomy files
    - No taxonomy ID mismatches remain
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Fixed auto-save interval from 500ms to 10 seconds (TREAT-10) and verified all 8 preset template taxonomy IDs match actual taxonomy data.
  </what-built>
  <how-to-verify>
    1. Open the treatment form (New Treatment)
    2. Start typing in a field (e.g., mechanism of injury)
    3. Watch the auto-save indicator -- it should NOT show "Saving..." immediately
    4. Wait ~10 seconds after your last change -- the indicator should then show "Saving..." followed by "Saved just now"
    5. Go to Quick Treatment Log (templates screen)
    6. Select a worker, then tap "Minor Cut" template
    7. Verify the treatment detail screen shows: Injury = Laceration, Body Part = Wrist/Hand, Treatment = Cleaned & Dressed, Outcome = Returned to Work (Same Duties)
    8. Repeat with "Sprain/Strain" template -- verify Injury = Sprain/Strain, Body Part = Ankle/Foot, Outcome = Light Duties
  </how-to-verify>
  <resume-signal>Type "approved" if auto-save timing and template defaults look correct, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- grep confirms 10000ms default in AutoSaveForm.tsx
- grep confirms 10000ms usage in treatment/new.tsx
- No 500ms auto-save calls remain anywhere in mobile/
- Template taxonomy IDs all validated against source taxonomy files
- TREAT-10 requirement now satisfied
- TREAT-11 (sub-30s quick mode) presets confirmed complete
</verification>

<success_criteria>
1. Auto-save interval is 10000ms (10 seconds) everywhere, matching TREAT-10
2. All 8 preset templates auto-fill valid taxonomy IDs for injury, treatment, body part, and outcome
3. Human verification confirms auto-save timing feels correct and template defaults populate correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-core/02-09-SUMMARY.md`
</output>
