---
phase: 02-mobile-core
plan: 05
type: execute
wave: 3
depends_on: ["02-04"]
files_modified:
  - mobile/app/treatment/templates.tsx
  - mobile/components/forms/PresetTemplateCard.tsx
  - mobile/app/(tabs)/treatments.tsx
autonomous: true

must_haves:
  truths:
    - "Medic can log minor treatment in under 30 seconds using preset template"
    - "Preset templates auto-fill injury type, treatment, body part, and outcome"
    - "Medic can view list of all treatments with search and filter"
  artifacts:
    - path: "mobile/app/treatment/templates.tsx"
      provides: "Template picker screen for quick-entry mode"
      min_lines: 60
    - path: "mobile/components/forms/PresetTemplateCard.tsx"
      provides: "Large tappable preset template card component"
      min_lines: 30
    - path: "mobile/app/(tabs)/treatments.tsx"
      provides: "Treatment log list view tab"
      min_lines: 60
  key_links:
    - from: "mobile/app/treatment/templates.tsx"
      to: "@nozbe/watermelondb"
      via: "Creates pre-filled treatment record"
      pattern: "database\\.get.*treatments.*create"
    - from: "mobile/app/treatment/templates.tsx"
      to: "mobile/app/treatment/[id].tsx"
      via: "Navigates to treatment form after preset selection"
      pattern: "router\\.push.*treatment"
---

<objective>
Build the quick treatment mode with preset templates for sub-30-second minor treatment logging, and the treatment log list view for browsing all treatments.

Purpose: 80% of construction site treatments are minor (cuts, bruises, headaches). Preset templates auto-fill common fields so the medic only needs to select worker + template + confirm, hitting the <30 second target (TREAT-11). The treatment list view provides the daily log for review and reporting.
Output: Template picker screen, preset card component, treatments list tab.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-core/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preset template cards and template picker screen</name>
  <files>mobile/components/forms/PresetTemplateCard.tsx, mobile/app/treatment/templates.tsx</files>
  <action>
  **PresetTemplateCard.tsx:**
  Follow research Pattern 5 (Preset Templates for Quick Entry).
  - Props: label: string, icon: string, subtitle: string, onPress: () => void, isSelected?: boolean
  - Large tappable card: minHeight: 80, full width, borderRadius: 12
  - Icon on left (32px), label (fontSize: 20, fontWeight: '700'), subtitle below (fontSize: 14, grey)
  - Press feedback: opacity 0.8
  - High contrast colors, marginVertical: 8

  **templates.tsx (Template Picker Screen):**
  Define PRESET_TEMPLATES array with at least 8 common construction site minor injuries:

  1. Minor Cut -- defaults: injuryType='laceration-minor', treatment='cleaned-and-dressed', bodyPart='wrist-hand', outcome='returned-to-work-same-duties'
  2. Bruise -- defaults: injuryType='contusion', treatment='ice-pack', bodyPart='arm-elbow', outcome='returned-to-work-same-duties'
  3. Headache -- defaults: injuryType='headache', treatment='rest-in-welfare', bodyPart='head-face', outcome='returned-to-work-same-duties'
  4. Splinter -- defaults: injuryType='splinter', treatment='removed-foreign-body', bodyPart='finger-thumb', outcome='returned-to-work-same-duties'
  5. Eye Irritation -- defaults: injuryType='foreign-body-eye', treatment='eye-wash', bodyPart='eye', outcome='returned-to-work-same-duties'
  6. Sprain/Strain -- defaults: injuryType='sprain-strain', treatment='ice-pack', bodyPart='ankle-foot', outcome='returned-to-work-light-duties'
  7. Minor Burn -- defaults: injuryType='minor-burn', treatment='cleaned-and-dressed', bodyPart='wrist-hand', outcome='returned-to-work-same-duties'
  8. Nausea/Dizziness -- defaults: injuryType='nausea-dizziness', treatment='rest-in-welfare', bodyPart='head-face', outcome='returned-to-work-same-duties'

  Workflow:
  1. Screen shows WorkerSearchPicker at top (select worker FIRST for speed)
  2. Below: grid of PresetTemplateCards (2 columns on larger screens, 1 column on small)
  3. On template tap:
     a. Create new Treatment record with all preset defaults filled
     b. Generate reference number (SITE-YYYYMMDD-NNN)
     c. Set worker_id from selected worker
     d. Navigate to treatment/[id].tsx for quick review
  4. "Full Treatment" button at bottom navigates to treatment/new.tsx (for non-template cases)

  The defaults use taxonomy IDs that match the taxonomy files from Plan 01 (kebab-case IDs).
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit`.
  Verify PRESET_TEMPLATES has at least 8 entries.
  Verify each preset has injuryType, treatment, bodyPart, outcome defaults using taxonomy IDs.
  Verify WorkerSearchPicker appears before template selection.
  Verify tapping template creates Treatment record in WatermelonDB.
  </verify>
  <done>8 preset templates for common construction injuries. Worker selection first, then one-tap template creates pre-filled treatment. Medic reviews/confirms on treatment form. Achievable in <30 seconds (TREAT-11).</done>
</task>

<task type="auto">
  <name>Task 2: Create treatments list view tab</name>
  <files>mobile/app/(tabs)/treatments.tsx</files>
  <action>
  Create the treatment log list view for the main tab bar.

  **Layout:**
  - Screen title: "Treatment Log"
  - Action buttons at top: "Quick Log" (navigates to templates.tsx) + "Full Treatment" (navigates to treatment/new.tsx), both 56pt, side by side
  - Search bar below buttons: filter treatments by worker name, injury type (debounced 300ms)
  - FlatList of treatment records, sorted by created_at descending (most recent first)

  **Treatment list item:**
  - Reference number (bold, e.g., "SITE-20260215-003")
  - Worker name + injury type on same line
  - Treatment date + time
  - Outcome as StatusBadge (green for returned-to-work, amber for light-duties/sent-home, red for A&E/ambulance/hospitalized)
  - RIDDOR flag indicator if riddor_flagged is true (red badge)
  - Status: "Draft" or "Complete" as small label
  - Tap navigates to treatment/[id].tsx

  **Data loading:**
  - Use WatermelonDB withObservables or useQuery to reactively load treatments
  - Query: database.get('treatments').query(Q.sortBy('created_at', Q.desc))
  - Apply search filter with Q.or() on worker name and injury type fields
  - Lazy loading for performance (UX-08)

  **Empty state:**
  - Show message: "No treatments logged today" with "Log Treatment" button

  All text high contrast, all interactive elements 56pt minimum.
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit`.
  Verify treatments sorted by created_at desc.
  Verify Quick Log and Full Treatment buttons are present.
  Verify search filters by worker name and injury type.
  Verify list items show reference number, worker, injury, outcome badge, RIDDOR flag.
  Verify empty state has call-to-action button.
  </verify>
  <done>Treatment log tab shows all treatments sorted by most recent, with search/filter, Quick Log and Full Treatment action buttons, outcome status badges, and RIDDOR flag indicators.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd mobile && npx tsc --noEmit`
- 8 preset templates cover common construction injuries
- Quick log workflow: select worker -> tap template -> review/confirm (< 30 seconds)
- Treatment list view shows all treatments with search and status badges
- RIDDOR flag visible in list view
</verification>

<success_criteria>
- TREAT-11: Quick log mode completes in <30 seconds (worker + template tap + confirm)
- Template picker has 8+ construction-specific presets
- Treatments list view with search, sort by date, outcome badges
- RIDDOR flag indicators visible in list
- All tap targets 56pt minimum
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-core/02-05-SUMMARY.md`
</output>
