---
phase: 02-mobile-core
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/services/photo-processor.ts
  - mobile/components/forms/PhotoCapture.tsx
  - mobile/components/forms/SignaturePad.tsx
autonomous: true

must_haves:
  truths:
    - "Photos compress on-device to 100-200KB before storage"
    - "Multiple photos can be selected (up to 4) in a single picker session"
    - "Signature can be captured on full-screen canvas with gloves on"
  artifacts:
    - path: "mobile/services/photo-processor.ts"
      provides: "Photo capture and compression pipeline"
      exports: ["captureAndCompressPhotos", "takePhotoAndCompress"]
      min_lines: 40
    - path: "mobile/components/forms/PhotoCapture.tsx"
      provides: "Multi-photo picker component with thumbnails and removal"
      min_lines: 60
    - path: "mobile/components/forms/SignaturePad.tsx"
      provides: "Full-screen signature canvas modal"
      min_lines: 50
  key_links:
    - from: "mobile/services/photo-processor.ts"
      to: "expo-image-manipulator"
      via: "manipulateAsync for resize + compress"
      pattern: "manipulateAsync"
    - from: "mobile/components/forms/PhotoCapture.tsx"
      to: "mobile/services/photo-processor.ts"
      via: "import captureAndCompressPhotos"
      pattern: "captureAndCompressPhotos"
    - from: "mobile/components/forms/SignaturePad.tsx"
      to: "react-native-signature-canvas"
      via: "SignatureCanvas component"
      pattern: "SignatureCanvas"
---

<objective>
Build the photo capture/compression pipeline and signature pad component used by treatment logging, near-miss capture, and daily safety checks.

Purpose: Photo evidence and digital signatures are shared across multiple workflows (treatments, near-misses, daily checks). Building these as reusable services prevents duplication and ensures consistent compression (100-200KB target per PHOTO-02).
Output: Photo processor service, PhotoCapture component, SignaturePad component.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-core/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create photo processor service with compression pipeline</name>
  <files>mobile/services/photo-processor.ts</files>
  <action>
  Create photo processor service following research Pattern 3 (Photo Capture with On-Device Compression).

  Export 3 functions:

  **captureAndCompressPhotos(limit: number = 4): Promise<string[]>**
  - Request media library permissions via ImagePicker.requestMediaLibraryPermissionsAsync()
  - Launch picker with: mediaTypes: ['images'], allowsMultipleSelection: true, selectionLimit: limit, quality: 1.0, allowsEditing: false
  - Important: quality: 1.0 and allowsEditing: false to prevent iOS GIF compression bug (research Pitfall 1)
  - For each selected asset, compress with compressPhoto()
  - Return array of compressed URIs

  **takePhotoAndCompress(): Promise<string | null>**
  - Request camera permissions via ImagePicker.requestCameraPermissionsAsync()
  - Launch camera with: mediaTypes: ['images'], allowsEditing: false, quality: 1.0
  - Compress with compressPhoto()
  - Return single compressed URI or null if cancelled

  **compressPhoto(uri: string): Promise<string>** (internal, exported for testing)
  - Use ImageManipulator.manipulateAsync with:
    - Resize: { width: 1200 } (auto-maintains aspect ratio)
    - compress: 0.7 (JPEG quality 70%)
    - format: ImageManipulator.SaveFormat.JPEG
  - Per research Pitfall 6: if resulting file is likely still too large, do a second pass at width: 800 and compress: 0.5
  - Return compressed URI

  Handle errors gracefully: catch permission denied and return empty array, log but don't crash on compression failure.
  Use proper TypeScript types for all function signatures.
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit` to verify types compile.
  Verify file exports captureAndCompressPhotos, takePhotoAndCompress, compressPhoto.
  Verify ImageManipulator.manipulateAsync is called with resize width 1200 and compress 0.7.
  Verify quality: 1.0 is used in ImagePicker (not pre-compressing).
  </verify>
  <done>Photo processor service handles camera + gallery capture with on-device compression to JPEG, resize to 1200px width, 70% quality. Permission errors handled gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Create PhotoCapture component and SignaturePad component</name>
  <files>mobile/components/forms/PhotoCapture.tsx, mobile/components/forms/SignaturePad.tsx</files>
  <action>
  **PhotoCapture.tsx:**
  - Props: photoUris: string[], onPhotosChange: (uris: string[]) => void, maxPhotos?: number (default 4)
  - Displays existing photos as full-width cards (not small thumbnails -- research anti-pattern)
  - Each photo card: Image preview (200px height), large "Remove" button (56pt tap target, red variant)
  - Two action buttons at bottom (56pt each): "Take Photo" (calls takePhotoAndCompress) and "Choose from Library" (calls captureAndCompressPhotos with remaining limit)
  - Calculate remaining: maxPhotos - photoUris.length. Disable buttons when limit reached.
  - Show count label: "Photos: {current}/{max}"
  - Import and use captureAndCompressPhotos and takePhotoAndCompress from photo-processor service
  - Use ScrollView for photo cards (multiple photos need scrolling)
  - Import LargeTapButton from ../ui/LargeTapButton for action buttons (if available from Plan 01, otherwise inline 56pt Pressable -- Plan 01 runs in parallel)

  **SignaturePad.tsx:**
  - Follow research Pattern 4 (Signature Capture with Full-Screen Canvas) exactly
  - Props: onSave: (base64: string) => void, visible: boolean, onClose: () => void, title?: string (default "Sign here")
  - Full-screen Modal with animationType="slide", presentationStyle="fullScreen"
  - SignatureCanvas from react-native-signature-canvas
  - penColor="#000000", dotSize={3}, minWidth={3}, maxWidth={4} (thick stroke for gloves)
  - WebView webStyle: large buttons (min-height: 56px), large font (18px), high contrast
  - Clear and Save buttons in footer with 56pt tap targets
  - Cancel button that calls onClose
  - descriptionText prop shows title
  - onOK handler calls onSave with base64 string, then onClose
  - Handle edge case: signature canvas may show blank in Expo Go dev mode (research Pitfall 4) -- add comment noting this is expected behavior, works in production/dev client builds
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit` to verify types compile.
  Verify PhotoCapture imports from photo-processor.ts.
  Verify PhotoCapture has maxPhotos prop defaulting to 4.
  Verify SignaturePad uses react-native-signature-canvas with dotSize: 3.
  Verify SignaturePad renders full-screen Modal.
  </verify>
  <done>PhotoCapture shows full-width photo cards with camera/gallery buttons (4 photo limit). SignaturePad provides full-screen canvas with thick stroke for gloves-on signing. Both use 56pt minimum tap targets.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd mobile && npx tsc --noEmit`
- Photo service uses proper compression pipeline (resize first, then JPEG compress)
- PhotoCapture enforces 4-photo limit
- SignaturePad uses full-screen modal with thick pen stroke
</verification>

<success_criteria>
- Photo compression pipeline: capture -> resize 1200px -> JPEG 70% quality
- Camera and gallery both supported with proper permissions
- PhotoCapture limits to 4 photos with full-width cards (not thumbnails)
- SignaturePad full-screen with 3-4px thick stroke for gloves
- All components export TypeScript interfaces
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-core/02-02-SUMMARY.md`
</output>
