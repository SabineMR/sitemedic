---
phase: 02-mobile-core
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - mobile/components/forms/WorkerSearchPicker.tsx
  - mobile/app/worker/new.tsx
  - mobile/app/worker/[id].tsx
  - mobile/app/worker/quick-add.tsx
autonomous: true

must_haves:
  truths:
    - "Medic can add worker during induction with health screening data"
    - "Medic can view worker treatment history in 2 taps during emergency"
    - "Medic can search workers by name, company, or role simultaneously"
    - "Quick-add creates minimal worker record to unblock treatment logging"
  artifacts:
    - path: "mobile/components/forms/WorkerSearchPicker.tsx"
      provides: "Autocomplete search with inline quick-add"
      min_lines: 60
    - path: "mobile/app/worker/new.tsx"
      provides: "Full worker induction form"
      min_lines: 80
    - path: "mobile/app/worker/[id].tsx"
      provides: "Worker profile view with treatment history"
      min_lines: 60
  key_links:
    - from: "mobile/components/forms/WorkerSearchPicker.tsx"
      to: "@nozbe/watermelondb"
      via: "Q.or query for multi-field search"
      pattern: "Q\\.or"
    - from: "mobile/app/worker/[id].tsx"
      to: "treatments"
      via: "WatermelonDB query for worker's treatments"
      pattern: "query.*worker_id"
---

<objective>
Build the worker profile system: search/select, quick-add, full induction form, and profile view with treatment history.

Purpose: Workers are the foundation of every treatment log and near-miss report. The medic needs fast worker selection (search-first) and the ability to quickly add new workers during induction without interrupting clinical workflow (TREAT-01, WORK-01 through WORK-06).
Output: Worker search picker component, full induction form, quick-add modal, and profile/history view.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-core/02-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkerSearchPicker with inline quick-add</name>
  <files>mobile/components/forms/WorkerSearchPicker.tsx</files>
  <action>
  Create worker search component following research Pattern 6 (Worker Search with Inline Quick-Add).

  **Props interface:**
  - onSelect: (workerId: string) => void
  - selectedWorkerId?: string (shows selected worker name)
  - placeholder?: string (default "Search worker by name, company, or role")

  **Search behavior:**
  - Use react-native-autocomplete-dropdown for typeahead search
  - On text change (debounced 300ms), query WatermelonDB workers table
  - Search across name, company, and role fields simultaneously using Q.or() with Q.like() and Q.sanitizeLikeString()
  - Per research Pitfall 7: normalize search query by removing accents (normalize('NFD').replace(/[\u0300-\u036f]/g, '')) and lowercasing. Store normalized version in separate columns (name_normalized, company_normalized) -- note: need to add these columns to WatermelonDB schema if not present. For now, do client-side normalization on search results.
  - Display results as: "Name - Company (Last treatment: date)" per CONTEXT.md decision
  - TextInput style: fontSize: 18, minHeight: 56 (gloves-on)

  **Quick-add behavior:**
  - When searchQuery.length > 0 and results are empty, show "Quick Add" button
  - Quick-add button opens a minimal inline form: name (pre-filled from search query), company (required)
  - On save, creates worker record with isIncomplete: true flag for follow-up
  - Calls onSelect(newWorker.id) after creation

  **Selected state:**
  - When selectedWorkerId is set, show worker name with "Change" button instead of search input
  - "View History" button appears next to selected worker (navigates to worker/[id].tsx)

  Use LargeTapButton from components/ui/ for all buttons.
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit`.
  Verify Q.or() used for multi-field search.
  Verify Q.sanitizeLikeString() used for special character escaping.
  Verify quick-add creates record with isIncomplete: true.
  Verify minHeight: 56 on search input.
  </verify>
  <done>WorkerSearchPicker searches workers by name/company/role with accent normalization, shows inline quick-add when no results found, and allows viewing selected worker's history.</done>
</task>

<task type="auto">
  <name>Task 2: Create worker induction form, quick-add modal, and profile view</name>
  <files>mobile/app/worker/new.tsx, mobile/app/worker/[id].tsx, mobile/app/worker/quick-add.tsx</files>
  <action>
  **new.tsx (Full Worker Induction Form):**
  - Screen title: "Add Worker - Site Induction"
  - Sections (collapsible for speed):
    1. Basic Info (required): Full name, Company, Role/Trade, CSCS card number
    2. Emergency Contact: Name, Phone number, Relationship
    3. Health Info: Allergies (free text), Current medications (free text), Pre-existing conditions (free text), Blood type (picker: A+, A-, B+, B-, AB+, AB-, O+, O-, Unknown)
    4. Certifications: CSCS expiry date (date picker), additional certs (add multiple: cert type + expiry)
  - All inputs: minHeight 56, fontSize 18
  - Use react-hook-form for form state management
  - Auto-save on field change via WatermelonDB update (debounced 500ms per research Pattern 1)
  - "Save & Complete" button creates full worker record, sets isIncomplete: false
  - Worker record fields must align with WatermelonDB Worker model from Phase 1 (01-03)
  - Use BottomSheetPicker for blood type and certification type selection

  **[id].tsx (Worker Profile + Treatment History):**
  - Screen shows worker profile info at top (name, company, role, certifications with expiry status)
  - Certification status: use StatusBadge green/amber/red based on expiry (green: >30 days, amber: <30 days, red: expired)
  - Treatment History section: FlatList of all treatments for this worker, sorted by date descending
  - Each treatment row: date, injury type, outcome, tap to view full treatment
  - Query: database.get('treatments').query(Q.where('worker_id', workerId)) sorted by created_at desc
  - "Edit Profile" button navigates back to edit mode
  - This screen must be reachable in 2 taps from anywhere (WORK-04) -- route: /worker/[id]

  **quick-add.tsx (Minimal Quick-Add Screen):**
  - Minimal modal/screen with just: Name (required), Company (required), Role (optional)
  - Pre-fills name from search query if navigated from WorkerSearchPicker
  - Creates worker with isIncomplete: true
  - Returns worker ID to caller
  - Large "Add Worker" button (56pt, primary variant)
  - Used when WorkerSearchPicker's inline quick-add needs more space
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit`.
  Verify new.tsx has all WORK-02 fields: name, company, role, emergency contact, allergies, medications, pre-existing conditions, blood type, CSCS card number + expiry.
  Verify [id].tsx queries treatments by worker_id.
  Verify [id].tsx shows certification expiry with StatusBadge.
  Verify quick-add.tsx creates record with isIncomplete: true.
  </verify>
  <done>Full induction form captures all WORK-02 health screening fields with auto-save. Profile view shows worker info + treatment history with certification expiry status. Quick-add captures minimal fields for unblocking treatment flow.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd mobile && npx tsc --noEmit`
- Worker search uses Q.or() for simultaneous multi-field search
- Induction form has all WORK-02 required fields
- Profile view shows treatment history (WORK-03)
- Profile reachable in 2 taps (WORK-04): Home -> Workers list -> Worker profile
- Certification expiry uses green/amber/red StatusBadge (WORK-05)
</verification>

<success_criteria>
- WorkerSearchPicker: search by name/company/role, inline quick-add, accent-safe
- Full induction: all WORK-02 fields, auto-save, GDPR-compliant (WORK-06 via existing encryption)
- Profile: treatment history list, certification status badges
- Quick-add: name + company only, isIncomplete flag for follow-up
- All tap targets 56pt minimum
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-core/02-03-SUMMARY.md`
</output>
