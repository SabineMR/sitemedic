---
phase: 02-mobile-core
plan: 06
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - mobile/app/safety/near-miss.tsx
  - mobile/components/safety/NearMissQuickCapture.tsx
  - mobile/app/(tabs)/safety.tsx
autonomous: true

must_haves:
  truths:
    - "Medic can capture near-miss with photo in under 45 seconds"
    - "Near-miss accessible from home screen in ONE tap"
    - "GPS coordinates auto-attached to near-miss report"
    - "Near-miss captures category, photo, description, and severity"
  artifacts:
    - path: "mobile/app/safety/near-miss.tsx"
      provides: "Near-miss capture workflow screen"
      min_lines: 80
    - path: "mobile/components/safety/NearMissQuickCapture.tsx"
      provides: "Quick-capture near-miss component"
      min_lines: 40
    - path: "mobile/app/(tabs)/safety.tsx"
      provides: "Safety tab with near-miss list and daily checks"
      min_lines: 60
  key_links:
    - from: "mobile/app/safety/near-miss.tsx"
      to: "mobile/services/taxonomy/near-miss-categories.ts"
      via: "Import NEAR_MISS_CATEGORIES for pick list"
      pattern: "NEAR_MISS_CATEGORIES"
    - from: "mobile/app/safety/near-miss.tsx"
      to: "expo-location"
      via: "getCurrentPositionAsync for GPS coordinates"
      pattern: "getCurrentPositionAsync"
    - from: "mobile/app/safety/near-miss.tsx"
      to: "mobile/services/photo-processor.ts"
      via: "Photo capture for near-miss evidence"
      pattern: "captureAndCompressPhotos|takePhotoAndCompress"
---

<objective>
Build the near-miss capture workflow optimized for speed (<45 seconds) with photo-first design, category selection, severity potential, and automatic GPS tagging.

Purpose: Near-miss reports are time-sensitive -- the hazard exists NOW and needs documenting before conditions change. Photo-first design lets the medic capture evidence immediately, then add details. GPS auto-tagging eliminates manual location entry (NEAR-01 through NEAR-07).
Output: Near-miss capture screen, quick-capture component, safety tab with near-miss list.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-core/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build near-miss capture workflow with photo-first design</name>
  <files>mobile/app/safety/near-miss.tsx, mobile/components/safety/NearMissQuickCapture.tsx</files>
  <action>
  **NearMissQuickCapture.tsx (Photo-First Capture Component):**
  - Designed for speed: photo FIRST, details SECOND
  - On mount: immediately request location permission and start getting GPS coordinates in background
  - Two large buttons (56pt): "Take Photo" (camera) and "Choose Photo" (gallery)
  - After photo captured, show photo preview and expand detail form below
  - Compact enough to be embedded in near-miss.tsx

  **near-miss.tsx (Near-Miss Capture Screen):**
  Screen optimized for <45 second completion (NEAR-01).

  Flow (designed for speed):
  1. Photo capture (NearMissQuickCapture) -- first thing on screen, biggest visual element
  2. Category selection: NEAR_MISS_CATEGORIES shown as 2-column grid of large buttons (56pt), each with icon and label. No bottom sheet -- buttons visible immediately for speed. (NEAR-02)
  3. Description: TextInput (multiline, 80px min height, placeholder "Describe what happened...") (NEAR-04)
     - Defer voice-to-text to Phase 3 per research open question #1
  4. Severity potential ("What COULD have happened"): 3 large buttons side-by-side (NEAR-05):
     - Minor (green) -- "Could have caused minor injury"
     - Major (amber) -- "Could have caused serious injury"
     - Fatal (red) -- "Could have caused death"
  5. GPS: Auto-captured on screen mount via expo-location getCurrentPositionAsync() (NEAR-07)
     - Request permission: Location.requestForegroundPermissionsAsync()
     - Use accuracy: Location.Accuracy.Balanced (fast, not ultra-precise)
     - Store latitude + longitude on NearMiss record
     - Show "Location captured" or "Location unavailable" indicator
     - Do NOT block form submission if GPS fails (construction sites may have poor GPS)

  On mount:
  - Create NearMiss record in WatermelonDB immediately
  - Wire useAutoSave for all fields
  - Start GPS capture in background

  "Report Near-Miss" button at bottom (56pt, danger variant red) marks as status='complete'.
  "Save Draft" link for incomplete reports.

  Store up to 4 photos (NEAR-03) via PhotoCapture component.
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit`.
  Verify near-miss.tsx imports NEAR_MISS_CATEGORIES from taxonomy.
  Verify expo-location getCurrentPositionAsync is called on mount.
  Verify severity has 3 options: Minor, Major, Fatal.
  Verify photos supported (up to 4 via PhotoCapture).
  Verify auto-save is wired.
  </verify>
  <done>Near-miss capture: photo-first flow, 13 hazard categories as visible grid buttons, 3-level severity picker, free-text description, auto GPS tagging, auto-save. Designed for <45 second completion.</done>
</task>

<task type="auto">
  <name>Task 2: Create safety tab with near-miss list view</name>
  <files>mobile/app/(tabs)/safety.tsx</files>
  <action>
  Create the Safety tab that shows both near-misses and daily checks (combined safety view).

  **Layout:**
  - Screen title: "Safety"
  - Segmented control at top: "Near-Misses" | "Daily Checks" tabs (56pt height, large text)
  - Default to "Near-Misses" segment

  **Near-Misses segment:**
  - "Report Near-Miss" button at top (56pt, danger variant, full width) -- navigates to safety/near-miss.tsx (NEAR-06: accessible in ONE tap from this tab)
  - FlatList of near-miss records sorted by created_at desc
  - Each list item shows:
    - Category label + icon
    - Date + time
    - Severity as StatusBadge (green=minor, amber=major, red=fatal)
    - Photo thumbnail (small preview)
    - Status: "Draft" or "Complete"
    - Tap navigates to near-miss detail/edit view
  - Empty state: "No near-misses reported" with report button

  **Daily Checks segment:**
  - Placeholder for now: "Daily Safety Checks" header
  - "Start Today's Check" button (56pt, primary)
  - List of recent daily checks with completion status
  - Will be fully implemented in Plan 07 (daily-check.tsx)
  - Show today's date and whether checklist is complete/incomplete

  **Data loading:**
  - Near-misses: database.get('near_misses').query(Q.sortBy('created_at', Q.desc))
  - Reactive loading with withObservables or equivalent

  All elements 56pt minimum tap targets.
  </action>
  <verify>
  Run `cd mobile && npx tsc --noEmit`.
  Verify segmented control has "Near-Misses" and "Daily Checks" options.
  Verify "Report Near-Miss" button navigates to safety/near-miss.tsx.
  Verify near-miss list items show category, severity badge, date, photo preview.
  Verify near-miss list sorted by created_at desc.
  </verify>
  <done>Safety tab with segmented control showing near-miss list and daily checks placeholder. Near-miss report button accessible in ONE tap from tab (NEAR-06). List shows category, severity, date, photo for each near-miss.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `cd mobile && npx tsc --noEmit`
- Near-miss capture supports photo-first workflow
- GPS auto-captured without blocking form
- Category selection from 13 construction hazard types
- Severity: Minor/Major/Fatal with traffic-light colors
- Near-miss accessible in ONE tap from safety tab (NEAR-06)
</verification>

<success_criteria>
- NEAR-01: Near-miss capture in <45 seconds (photo + category + description + severity)
- NEAR-02: Category from 13 construction hazard types (visible grid, not hidden in picker)
- NEAR-03: Up to 4 photos with compression
- NEAR-04: Free text description (voice-to-text deferred)
- NEAR-05: Severity potential with 3 levels (Minor/Major/Fatal)
- NEAR-06: Accessible from safety tab in ONE tap
- NEAR-07: GPS auto-attached on capture
- All tap targets 56pt minimum
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-core/02-06-SUMMARY.md`
</output>
