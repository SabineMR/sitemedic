---
phase: 02-mobile-core
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/components/forms/WorkerSearchPicker.tsx
  - mobile/app/worker/[id].tsx
  - mobile/app/worker/new.tsx
  - mobile/app/worker/quick-add.tsx
  - mobile/app/safety/daily-check.tsx
  - mobile/app/safety/near-miss.tsx
  - mobile/app/treatment/[id].tsx
  - mobile/app/treatment/new.tsx
  - mobile/app/treatment/templates.tsx
  - mobile/app/(tabs)/treatments.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "App works 100% offline with no network required"
    - "All imports resolve correctly at runtime (no broken import paths)"
    - "Database initializes successfully on app start"
  artifacts:
    - path: "mobile/components/forms/WorkerSearchPicker.tsx"
      provides: "Worker search with correct import path to watermelon.ts"
      contains: "from.*src/lib/watermelon"
    - path: "mobile/app/_layout.tsx"
      provides: "Root layout with correct database initialization import"
      contains: "initDatabase"
  key_links:
    - from: "mobile/components/forms/WorkerSearchPicker.tsx"
      to: "src/lib/watermelon.ts"
      via: "relative import path"
      pattern: "from.*\\.\\./.*src/lib/watermelon"
    - from: "mobile/app/_layout.tsx"
      to: "src/lib/watermelon.ts"
      via: "relative import path"
      pattern: "from.*\\.\\./.*src/lib/watermelon"
---

<objective>
Audit and fix all WatermelonDB import paths in the mobile app to ensure they resolve correctly to `src/lib/watermelon.ts` at the project root. Then verify offline functionality.

Purpose: Close the UNCERTAIN verification gap -- "App works 100% offline with no network required." The import path `../../src/lib/watermelon` from various file depths may not resolve correctly depending on file location. If paths are broken, the app will crash on startup (database won't initialize). This is a foundational concern that affects every feature in Phase 2.

Output: All import paths verified and corrected. Offline capability confirmed via human checkpoint.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mobile-core/02-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix WatermelonDB import paths</name>
  <files>
    mobile/components/forms/WorkerSearchPicker.tsx
    mobile/app/worker/[id].tsx
    mobile/app/worker/new.tsx
    mobile/app/worker/quick-add.tsx
    mobile/app/safety/daily-check.tsx
    mobile/app/safety/near-miss.tsx
    mobile/app/treatment/[id].tsx
    mobile/app/treatment/new.tsx
    mobile/app/treatment/templates.tsx
    mobile/app/(tabs)/treatments.tsx
    mobile/app/_layout.tsx
  </files>
  <action>
    The WatermelonDB `getDatabase` and `initDatabase` functions live at the project root: `src/lib/watermelon.ts`. All imports in `mobile/` must resolve to this file.

    **Step 1: Verify each import path resolves correctly.**

    For each file that imports from `src/lib/watermelon`, count the directory levels from the file to the project root and verify the relative path has the correct number of `../` segments:

    | File Location | Levels to Root | Correct Import |
    |---|---|---|
    | `mobile/app/_layout.tsx` | 2 (app -> mobile -> root) | `../../src/lib/watermelon` |
    | `mobile/app/treatment/new.tsx` | 3 (treatment -> app -> mobile -> root) | `../../../src/lib/watermelon` |
    | `mobile/app/treatment/[id].tsx` | 3 | `../../../src/lib/watermelon` |
    | `mobile/app/treatment/templates.tsx` | 3 | `../../../src/lib/watermelon` |
    | `mobile/app/worker/[id].tsx` | 3 | `../../../src/lib/watermelon` |
    | `mobile/app/worker/new.tsx` | 3 | `../../../src/lib/watermelon` |
    | `mobile/app/worker/quick-add.tsx` | 3 | `../../../src/lib/watermelon` |
    | `mobile/app/safety/daily-check.tsx` | 3 | `../../../src/lib/watermelon` |
    | `mobile/app/safety/near-miss.tsx` | 3 (if it imports getDatabase) | `../../../src/lib/watermelon` |
    | `mobile/app/(tabs)/treatments.tsx` | 3 ((tabs) -> app -> mobile -> root) | `../../../src/lib/watermelon` |
    | `mobile/components/forms/WorkerSearchPicker.tsx` | 3 (forms -> components -> mobile -> root) | `../../../src/lib/watermelon` |

    **Step 2: Fix incorrect paths.**

    Current known issues (based on code review):
    - `mobile/components/forms/WorkerSearchPicker.tsx` uses `../../src/lib/watermelon` (2 levels) but needs 3 levels: `../../../src/lib/watermelon`
    - `mobile/app/treatment/templates.tsx` uses `../../src/lib/watermelon` (2 levels) but needs 3 levels: `../../../src/lib/watermelon`
    - `mobile/app/treatment/new.tsx` uses `../../src/lib/watermelon` -- verify if this is 2 or 3 levels needed from `mobile/app/treatment/`
    - `mobile/app/treatment/[id].tsx` same check
    - `mobile/app/(tabs)/treatments.tsx` uses `../../src/lib/watermelon` -- verify if 2 or 3 levels needed from `mobile/app/(tabs)/`

    For EACH file: read the current import, compute the correct relative path from that file's location to the project root's `src/lib/watermelon.ts`, and fix if wrong.

    **IMPORTANT:** Do NOT change imports from `@nozbe/watermelondb` or `@nozbe/watermelondb/react` or `@nozbe/watermelondb/hooks` -- these are npm packages and resolve correctly. Only fix relative imports to `src/lib/watermelon`.

    **Step 3: Also check imports to other project-root files.**

    Similarly audit imports to:
    - `src/database/models/Treatment.ts`
    - `src/database/models/Worker.ts`
    - `src/database/models/NearMiss.ts`
    - `src/database/models/SafetyCheck.ts`
    - `src/contexts/AuthContext.ts`
    - `src/contexts/SyncContext.ts`

    Apply the same relative path logic. Fix any that have incorrect depth.

    **Step 4: Verify no duplicate or conflicting import patterns exist.**

    Run grep to confirm all imports to `src/lib/watermelon` use consistent, correct paths after fixes.
  </action>
  <verify>
    After fixes, run:
    - `grep -rn "from.*src/lib/watermelon" mobile/` -- all paths should have correct number of `../` for their depth
    - `grep -rn "from.*src/database" mobile/` -- same verification for model imports
    - `grep -rn "from.*src/contexts" mobile/` -- same verification for context imports
    - Verify `src/lib/watermelon.ts` exists at the project root: `ls -la src/lib/watermelon.ts`
    - No import should point to `mobile/src/lib/watermelon` (which doesn't exist)
  </verify>
  <done>
    - All relative imports to project root `src/` directory use correct depth (`../` count matches actual directory traversal)
    - Import from `mobile/app/_layout.tsx` (2 levels) is `../../src/lib/watermelon`
    - Imports from `mobile/app/treatment/*.tsx` (3 levels) are `../../../src/lib/watermelon`
    - Import from `mobile/components/forms/WorkerSearchPicker.tsx` (3 levels) is `../../../src/lib/watermelon`
    - grep confirms no broken paths remain
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Audited and fixed all WatermelonDB import paths across 10+ files in the mobile app. All relative imports now point to the correct project root location for `src/lib/watermelon.ts`, database models, and context providers.
  </what-built>
  <how-to-verify>
    **Offline Test (Airplane Mode):**
    1. Build and run the app on iOS Simulator or device
    2. Enable Airplane Mode on the device/simulator BEFORE opening the app
    3. Open the app -- it should load without errors (white loading screen then home dashboard)
    4. Navigate to "New Treatment" -- the form should open without crash
    5. Select a worker (if any exist in local DB) or add a new worker via quick-add
    6. Fill in treatment fields and confirm auto-save indicator appears after 10 seconds
    7. Navigate to "Daily Safety Check" -- checklist should render all 10 items
    8. Navigate to "Report Near-Miss" -- form should open
    9. Go back to Home -- dashboard should show stats (may be zeros, that's OK)
    10. Verify NO network error popups or crash screens appear throughout

    **Expected result:** App works entirely offline. All screens load. All forms accept input. Data saves to local WatermelonDB. Sync status shows "Offline" (not an error).
  </how-to-verify>
  <resume-signal>Type "approved" if app works in airplane mode, or describe any crashes/errors</resume-signal>
</task>

</tasks>

<verification>
- All import paths audited and corrected (grep confirms consistent patterns)
- No imports point to non-existent `mobile/src/lib/` path
- App boots successfully with database initialization in airplane mode
- All forms render and accept input offline
- UX-03 (offline-first) requirement satisfied
- Success criteria #8 ("App works 100% offline") verified by human test
</verification>

<success_criteria>
1. All relative imports to `src/lib/watermelon.ts` resolve correctly from their file locations
2. App starts and renders home dashboard in airplane mode without errors
3. Treatment, near-miss, and daily check forms all open and save data offline
4. No runtime import resolution errors in any screen
</success_criteria>

<output>
After completion, create `.planning/phases/02-mobile-core/02-10-SUMMARY.md`
</output>
