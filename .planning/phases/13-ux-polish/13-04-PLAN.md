---
phase: 13-ux-polish
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - supabase/migrations/120_riddor_status_history.sql
  - web/app/(dashboard)/riddor/[id]/page.tsx
  - web/lib/queries/riddor.ts
autonomous: true

must_haves:
  truths:
    - "RIDDOR draft auto-saves every 30 seconds (silent, no toast) — draft survives page refresh"
    - "Auto-save does NOT fire on initial page load (hasInitialized ref guard)"
    - "RIDDOR detail page shows audit trail: 'Status changed: draft -> submitted by Kai Jensen at 14:32'"
    - "RIDDOR detail page shows photo gallery grid when treatment has photos"
    - "riddor_status_history table exists with trigger that auto-logs status changes"
  artifacts:
    - path: "supabase/migrations/120_riddor_status_history.sql"
      provides: "riddor_status_history table + trigger on riddor_incidents status changes"
      contains: "riddor_status_history"
    - path: "web/app/(dashboard)/riddor/[id]/page.tsx"
      provides: "Auto-save timer, audit trail section, photo gallery section"
      contains: "autoSaveTimer"
    - path: "web/lib/queries/riddor.ts"
      provides: "Updated fetchRIDDORIncident to include status history and photo_uris"
      contains: "riddor_status_history"
  key_links:
    - from: "web/app/(dashboard)/riddor/[id]/page.tsx"
      to: "supabase riddor_incidents table"
      via: "30-second debounced update call for auto-save"
      pattern: "setTimeout.*30000|autoSaveTimer"
    - from: "web/app/(dashboard)/riddor/[id]/page.tsx"
      to: "web/lib/queries/riddor.ts"
      via: "fetchRIDDORIncident returns status_history and photo_uris"
      pattern: "fetchRIDDORIncident"
    - from: "supabase/migrations/120_riddor_status_history.sql"
      to: "riddor_incidents table"
      via: "AFTER UPDATE trigger logs status changes"
      pattern: "trg_riddor_status_history"
---

<objective>
Complete the RIDDOR incident workflow with auto-save, audit trail, and photo gallery.

Purpose: RIDDOR drafts currently have no auto-save (data loss risk on page refresh). There is no status change history (audit/compliance gap). Treatment photos are stored but not displayed on the incident detail page. This plan adds all three.
Output: A migration for status history tracking, and an enhanced RIDDOR detail page with auto-save, audit trail timeline, and photo gallery.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ux-polish/13-RESEARCH.md

Key existing files:
@web/app/(dashboard)/riddor/[id]/page.tsx — Current RIDDOR detail page (no auto-save, no audit trail, no photos)
@web/lib/queries/riddor.ts — fetchRIDDORIncident() joins treatments (*), workers (*), organizations (*)
@web/app/(dashboard)/treatments/[id]/page.tsx — Photo gallery pattern using Supabase Storage

DB context:
- riddor_incidents: has status (draft/submitted/confirmed), no status history table
- treatments: has photo_uris JSONB array, storage bucket: treatment-photos
- fetchRIDDORIncident already joins `treatments (*)` which includes photo_uris

Patterns:
- Auto-save: useRef for timer (NOT useState — avoids re-renders), hasInitialized ref to skip initial load
- Photos: supabase.storage.from('treatment-photos').getPublicUrl(path) — established in /treatments/[id]
- Audit trail: query riddor_status_history joined by incident_id, join profiles for actor name
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create riddor_status_history migration and update query</name>
  <files>
    supabase/migrations/120_riddor_status_history.sql
    web/lib/queries/riddor.ts
  </files>
  <action>
    **Create `supabase/migrations/120_riddor_status_history.sql`:**

    ```sql
    -- Phase 13: RIDDOR status change audit trail
    -- Tracks every status transition on riddor_incidents for compliance

    CREATE TABLE riddor_status_history (
      id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      incident_id  UUID NOT NULL REFERENCES riddor_incidents(id) ON DELETE CASCADE,
      from_status  TEXT,          -- NULL for initial creation
      to_status    TEXT NOT NULL,
      changed_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      changed_by   UUID REFERENCES auth.users(id),
      actor_name   TEXT           -- Denormalized for display without join
    );

    CREATE INDEX idx_riddor_status_history_incident
      ON riddor_status_history(incident_id, changed_at DESC);

    -- Trigger: auto-insert history row when status changes
    CREATE OR REPLACE FUNCTION log_riddor_status_change()
    RETURNS TRIGGER AS $$
    DECLARE
      v_actor_name TEXT;
    BEGIN
      IF OLD.status IS DISTINCT FROM NEW.status THEN
        -- Try to get actor name from profiles
        SELECT CONCAT(first_name, ' ', last_name) INTO v_actor_name
        FROM profiles WHERE id = auth.uid();

        INSERT INTO riddor_status_history (incident_id, from_status, to_status, changed_by, actor_name)
        VALUES (NEW.id, OLD.status, NEW.status, auth.uid(), v_actor_name);
      END IF;
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql SECURITY DEFINER;

    CREATE TRIGGER trg_riddor_status_history
      AFTER UPDATE ON riddor_incidents
      FOR EACH ROW EXECUTE FUNCTION log_riddor_status_change();

    -- RLS: org users can view their org's status history
    ALTER TABLE riddor_status_history ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Org users can view their incidents status history"
      ON riddor_status_history FOR SELECT
      USING (
        incident_id IN (
          SELECT id FROM riddor_incidents WHERE org_id IN (
            SELECT org_id FROM profiles WHERE id = auth.uid()
          )
        )
      );
    ```

    **Modify `web/lib/queries/riddor.ts`:**

    1. Add `StatusHistoryEntry` interface:
       ```typescript
       export interface StatusHistoryEntry {
         id: string;
         from_status: string | null;
         to_status: string;
         changed_at: string;
         changed_by: string | null;
         actor_name: string | null;
       }
       ```

    2. Add `photo_uris` to the `treatments` type in `RIDDORIncident` interface (it's returned by `treatments (*)` but not typed):
       ```typescript
       treatments: {
         // ... existing fields ...
         photo_uris: string[] | null;  // ADD THIS
       };
       ```

    3. Add `status_history` to `RIDDORIncident` interface:
       ```typescript
       status_history?: StatusHistoryEntry[];
       ```

    4. Create a new function `fetchRIDDORStatusHistory`:
       ```typescript
       export async function fetchRIDDORStatusHistory(incidentId: string): Promise<StatusHistoryEntry[]> {
         const { data, error } = await supabase
           .from('riddor_status_history')
           .select('id, from_status, to_status, changed_at, changed_by, actor_name')
           .eq('incident_id', incidentId)
           .order('changed_at', { ascending: false });

         if (error) {
           console.error('Error fetching status history:', error);
           return [];
         }
         return (data || []) as StatusHistoryEntry[];
       }
       ```

    5. Create a helper function `updateRIDDORDraft` for auto-save:
       ```typescript
       export async function updateRIDDORDraft(
         incidentId: string,
         updates: { category?: string; override_reason?: string }
       ): Promise<boolean> {
         const { error } = await supabase
           .from('riddor_incidents')
           .update({ ...updates, updated_at: new Date().toISOString() })
           .eq('id', incidentId)
           .eq('status', 'draft');  // Only auto-save drafts

         if (error) {
           console.error('Auto-save failed:', error);
           return false;
         }
         return true;
       }
       ```
  </action>
  <verify>
    - `ls supabase/migrations/120_riddor_status_history.sql` confirms file exists
    - `grep "riddor_status_history" supabase/migrations/120_riddor_status_history.sql` shows table creation
    - `grep "trg_riddor_status_history" supabase/migrations/120_riddor_status_history.sql` shows trigger
    - `grep "StatusHistoryEntry" web/lib/queries/riddor.ts` shows new interface
    - `grep "fetchRIDDORStatusHistory" web/lib/queries/riddor.ts` shows new function
    - `grep "updateRIDDORDraft" web/lib/queries/riddor.ts` shows auto-save function
    - `grep "photo_uris" web/lib/queries/riddor.ts` shows photo_uris in treatments type
  </verify>
  <done>
    Migration 120 creates riddor_status_history table with AFTER UPDATE trigger. Query file exports StatusHistoryEntry type, fetchRIDDORStatusHistory(), and updateRIDDORDraft() functions. photo_uris typed in RIDDORIncident.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auto-save, audit trail, and photo gallery to RIDDOR detail page</name>
  <files>web/app/(dashboard)/riddor/[id]/page.tsx</files>
  <action>
    Modify `web/app/(dashboard)/riddor/[id]/page.tsx`:

    **1. Add imports:**
    ```typescript
    import { useRef, useEffect, useCallback } from 'react';
    import { fetchRIDDORStatusHistory, updateRIDDORDraft, type StatusHistoryEntry } from '@/lib/queries/riddor';
    import { createClient } from '@/lib/supabase/client';
    import Image from 'next/image';
    import { Clock, Camera } from 'lucide-react';
    ```

    **2. Add auto-save logic (30-second debounce, silent):**
    Inside the component, after existing state:

    ```typescript
    // Auto-save state — track draft fields the user might edit
    const [draftCategory, setDraftCategory] = useState<string | null>(null);
    const [draftOverrideReason, setDraftOverrideReason] = useState<string | null>(null);

    // Auto-save refs
    const autoSaveTimer = useRef<NodeJS.Timeout | null>(null);
    const hasInitialized = useRef(false);

    // Initialize draft state from fetched data (once)
    useEffect(() => {
      if (incident && !hasInitialized.current) {
        setDraftCategory(incident.category);
        setDraftOverrideReason(incident.override_reason);
        hasInitialized.current = true;
      }
    }, [incident]);

    // Auto-save effect: 30-second debounce on draft field changes
    useEffect(() => {
      if (!hasInitialized.current || !incident || incident.status !== 'draft') return;

      if (autoSaveTimer.current) clearTimeout(autoSaveTimer.current);

      autoSaveTimer.current = setTimeout(async () => {
        await updateRIDDORDraft(incidentId, {
          category: draftCategory ?? undefined,
          override_reason: draftOverrideReason ?? undefined,
        });
      }, 30000);

      return () => {
        if (autoSaveTimer.current) clearTimeout(autoSaveTimer.current);
      };
    }, [draftCategory, draftOverrideReason, incidentId, incident]);

    // Save immediately on unmount (if draft)
    useEffect(() => {
      return () => {
        if (hasInitialized.current && autoSaveTimer.current) {
          clearTimeout(autoSaveTimer.current);
          // Fire-and-forget save on unmount
          updateRIDDORDraft(incidentId, {
            category: draftCategory ?? undefined,
            override_reason: draftOverrideReason ?? undefined,
          });
        }
      };
    }, []);  // eslint-disable-line react-hooks/exhaustive-deps
    ```

    **3. Fetch status history:**
    ```typescript
    const { data: statusHistory } = useQuery({
      queryKey: ['riddor-status-history', incidentId],
      queryFn: () => fetchRIDDORStatusHistory(incidentId),
      refetchInterval: 60000,
    });
    ```

    **4. Build photo URLs from treatment.photo_uris:**
    ```typescript
    const supabaseClient = createClient();
    const photoUrls = (incident?.treatments?.photo_uris || []).map((path: string) =>
      supabaseClient.storage.from('treatment-photos').getPublicUrl(path).data.publicUrl
    );
    ```

    **5. Add Audit Trail section (after existing cards, before F2508 section):**
    ```jsx
    {/* Status Audit Trail */}
    {statusHistory && statusHistory.length > 0 && (
      <Card className="md:col-span-2">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Clock className="h-5 w-5" />
            Status History
          </CardTitle>
          <CardDescription>Audit trail of all status changes</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {statusHistory.map((entry: StatusHistoryEntry) => (
              <div key={entry.id} className="flex items-start gap-3 text-sm">
                <div className="w-2 h-2 rounded-full bg-blue-500 mt-1.5 flex-shrink-0" />
                <div>
                  <p>
                    Status changed: <span className="font-medium">{entry.from_status || 'new'}</span>
                    {' → '}
                    <span className="font-medium">{entry.to_status}</span>
                    {entry.actor_name && (
                      <span className="text-muted-foreground"> by {entry.actor_name}</span>
                    )}
                  </p>
                  <p className="text-xs text-muted-foreground">
                    {new Date(entry.changed_at).toLocaleDateString('en-GB', {
                      day: '2-digit',
                      month: 'long',
                      year: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                    })}
                  </p>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    )}
    ```

    **6. Add Photo Gallery section (after audit trail, before F2508 section):**
    ```jsx
    {/* Evidence Photos */}
    {photoUrls.length > 0 && (
      <Card className="md:col-span-2">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Camera className="h-5 w-5" />
            Evidence Photos ({photoUrls.length})
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {photoUrls.map((url: string, i: number) => (
              <a key={i} href={url} target="_blank" rel="noopener noreferrer">
                <div className="relative aspect-square overflow-hidden rounded-lg border hover:opacity-80 transition">
                  <Image
                    src={url}
                    alt={`Evidence photo ${i + 1}`}
                    fill
                    className="object-cover"
                    sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
                  />
                </div>
              </a>
            ))}
          </div>
        </CardContent>
      </Card>
    )}
    ```

    **7. Replace the "Loading incident details..." text (line 59) with a skeleton:**
    Import Skeleton from `@/components/ui/skeleton` and replace with a skeleton layout matching the page structure (header + 2 cards + treatment card shape).

    PITFALLS TO AVOID:
    - Do NOT use useState for the autoSaveTimer — use useRef
    - Do NOT show toast on auto-save — it must be silent
    - Do NOT let auto-save fire on initial render — hasInitialized ref guards this
    - Do NOT auto-save if status is not 'draft'
  </action>
  <verify>
    - `grep "autoSaveTimer" web/app/(dashboard)/riddor/[id]/page.tsx` shows timer ref
    - `grep "hasInitialized" web/app/(dashboard)/riddor/[id]/page.tsx` shows guard ref
    - `grep "30000" web/app/(dashboard)/riddor/[id]/page.tsx` shows 30-second interval
    - `grep "Status changed" web/app/(dashboard)/riddor/[id]/page.tsx` shows audit trail text
    - `grep "Evidence Photos" web/app/(dashboard)/riddor/[id]/page.tsx` shows photo gallery
    - `grep "treatment-photos" web/app/(dashboard)/riddor/[id]/page.tsx` shows storage bucket
    - `grep "fetchRIDDORStatusHistory" web/app/(dashboard)/riddor/[id]/page.tsx` shows history query
    - `grep "updateRIDDORDraft" web/app/(dashboard)/riddor/[id]/page.tsx` shows auto-save call
    - No `toast` in auto-save path: `grep -A5 "30000" web/app/(dashboard)/riddor/[id]/page.tsx` should NOT contain "toast"
    - `pnpm build` completes without errors
  </verify>
  <done>
    RIDDOR detail page has: (1) 30-second auto-save for draft incidents (silent, no toast, skips initial load), (2) status audit trail timeline showing "Status changed: draft -> submitted by Kai Jensen at 14:32", (3) photo gallery grid from treatment.photo_uris via Supabase Storage. Build passes.
  </done>
</task>

</tasks>

<verification>
- Migration 120 creates riddor_status_history table with trigger
- Auto-save fires every 30 seconds for draft incidents (not on initial load, not for submitted/confirmed)
- Auto-save is silent (no toast notifications)
- Status history displays formatted timeline with actor name and timestamp
- Photo gallery renders treatment photos from Supabase Storage
- Loading state replaced with skeleton
- `pnpm build` passes
</verification>

<success_criteria>
1. `riddor_status_history` table created via migration 120 with AFTER UPDATE trigger
2. RIDDOR draft auto-saves every 30 seconds (survives page refresh)
3. Auto-save does NOT fire on initial page load (hasInitialized guard)
4. Audit trail shows "Status changed: draft -> submitted by Kai Jensen at 14:32" format
5. Photo gallery renders evidence photos from treatment.photo_uris
6. `pnpm build` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-ux-polish/13-04-SUMMARY.md`
</output>
