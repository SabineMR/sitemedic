---
phase: 13-ux-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/119_geofence_schema_fix.sql
  - web/app/admin/geofences/page.tsx
  - web/components/admin/GeofenceMapPicker.tsx
autonomous: true

must_haves:
  truths:
    - "Geofence 'Add' page has an interactive Leaflet map ‚Äî click to place centre marker"
    - "Circle overlay on map visually shows the radius boundary"
    - "Slider or number input adjusts radius and circle updates in real-time"
    - "Saving a geofence persists correct column names (center_latitude, center_longitude, radius_meters) to DB"
    - "Existing geofences display correct lat/lng/radius from the actual DB columns"
    - "Geofence list shows skeleton rows while loading (replaces spinner)"
  artifacts:
    - path: "supabase/migrations/119_geofence_schema_fix.sql"
      provides: "Adds site_name column and makes booking_id nullable for org-level geofences"
      contains: "site_name"
    - path: "web/components/admin/GeofenceMapPicker.tsx"
      provides: "Leaflet map with click-to-place marker and resizable circle"
      contains: "MapContainer"
    - path: "web/app/admin/geofences/page.tsx"
      provides: "Updated geofence form using correct DB column names and map picker"
      contains: "center_latitude"
  key_links:
    - from: "web/app/admin/geofences/page.tsx"
      to: "web/components/admin/GeofenceMapPicker.tsx"
      via: "dynamic import with ssr:false"
      pattern: "dynamic.*GeofenceMapPicker.*ssr.*false"
    - from: "web/app/admin/geofences/page.tsx"
      to: "supabase geofences table"
      via: "supabase.from('geofences').insert/update using center_latitude, center_longitude, radius_meters"
      pattern: "center_latitude.*center_longitude.*radius_meters"
---

<objective>
Fix the geofence schema mismatch and replace manual lat/lng text inputs with an interactive Leaflet map picker.

Purpose: The geofences page currently uses wrong column names (`lat`, `lng`, `radius_metres`, `site_name`) that don't exist in the DB. The actual columns are `center_latitude`, `center_longitude`, `radius_meters`, and there's no `site_name` column. This plan fixes the schema, adds the missing `site_name` column, and replaces the text inputs with a click-to-place map.
Output: Migration fixing the schema, a new `GeofenceMapPicker` component, and an updated geofences page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ux-polish/13-RESEARCH.md

Key existing files:
@web/app/admin/geofences/page.tsx ‚Äî Current page with wrong column names (lat, lng, radius_metres, site_name)
@web/components/admin/MedicTrackingMap.tsx ‚Äî Existing Leaflet usage pattern (dynamic import, ssr:false)
@web/components/ui/skeleton.tsx ‚Äî For replacing the spinner in loading state

DB schema (from migration 006 + 026):
- geofences: id, booking_id (NOT NULL), org_id, center_latitude, center_longitude, radius_meters, require_consecutive_pings, is_active, created_by, notes, created_at, updated_at
- booking_id is currently NOT NULL ‚Äî needs to be nullable for org-level geofences
- site_name column does NOT exist ‚Äî needs to be added

Decisions:
- D-05.5-04-003: Dynamic import with ssr:false for Leaflet (mandatory)
- All Leaflet components MUST use `import 'leaflet/dist/leaflet.css'`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration to fix geofence schema</name>
  <files>supabase/migrations/119_geofence_schema_fix.sql</files>
  <action>
    Create `supabase/migrations/119_geofence_schema_fix.sql` with:

    1. Add `site_name TEXT` column to geofences table
    2. Make `booking_id` nullable (currently NOT NULL) ‚Äî org-level geofences don't need a booking
    3. Add a comment explaining why booking_id is now nullable

    ```sql
    -- Phase 13: Fix geofence schema for org-level geofences
    -- The geofences page manages org-level boundaries (filtered by org_id),
    -- but booking_id was NOT NULL. Making it nullable allows org-level geofences
    -- that aren't tied to a specific booking.

    ALTER TABLE geofences ALTER COLUMN booking_id DROP NOT NULL;
    ALTER TABLE geofences ADD COLUMN IF NOT EXISTS site_name TEXT;

    COMMENT ON COLUMN geofences.booking_id IS 'Optional booking reference. NULL for org-level geofences.';
    COMMENT ON COLUMN geofences.site_name IS 'Human-readable site name for display in admin UI.';
    ```

    Do NOT modify any other tables. Do NOT add RLS policies (existing policies cover this table).
  </action>
  <verify>
    - File exists: `ls supabase/migrations/119_geofence_schema_fix.sql`
    - Contains ALTER: `grep "ALTER TABLE geofences" supabase/migrations/119_geofence_schema_fix.sql`
    - Contains site_name: `grep "site_name" supabase/migrations/119_geofence_schema_fix.sql`
  </verify>
  <done>
    Migration 119 exists. It makes booking_id nullable and adds site_name TEXT column to geofences table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GeofenceMapPicker component and fix geofences page</name>
  <files>
    web/components/admin/GeofenceMapPicker.tsx
    web/app/admin/geofences/page.tsx
  </files>
  <action>
    **Create `web/components/admin/GeofenceMapPicker.tsx`:**

    A client component that renders a Leaflet map with:
    - `import { MapContainer, TileLayer, Marker, Circle, useMapEvents } from 'react-leaflet'`
    - `import L from 'leaflet'`
    - `import 'leaflet/dist/leaflet.css'` (CRITICAL: must be in component, not page)
    - Props: `{ lat: number | null, lng: number | null, radiusMeters: number, onChange: (lat: number, lng: number, radius: number) => void }`
    - Default center: `[51.5074, -0.1278]` (London) when lat/lng are null
    - Inner `ClickHandler` component using `useMapEvents({ click(e) { onPlace(e.latlng.lat, e.latlng.lng) } })` ‚Äî must be inside MapContainer
    - When lat+lng are set: render a `Marker` at position and a `Circle` with the given radius
    - Marker icon: use `L.divIcon({ className: '', html: '<div style="font-size:20px">üìç</div>', iconSize: [20, 20] })` to avoid missing default icon issue
    - Circle styling: `{ color: '#3B82F6', fillColor: '#3B82F6', fillOpacity: 0.15 }`
    - Map height: `300px`, width: `100%`, rounded corners with `className="rounded-xl overflow-hidden"`
    - Below map: a range slider `<input type="range" min={50} max={5000}>` for radius
    - Helper text: "Click map to place centre. Drag slider to resize ({radiusMeters}m)"

    **Modify `web/app/admin/geofences/page.tsx`:**

    1. Fix the Geofence interface to use correct column names:
       - `site_name: string` (keep ‚Äî migration 119 adds this column)
       - `lat: number` -> `center_latitude: number`
       - `lng: number` -> `center_longitude: number`
       - `radius_metres: number` -> `radius_meters: number`

    2. Fix form state to use correct column names:
       ```
       const [form, setForm] = useState({
         site_name: '',
         center_latitude: null as number | null,
         center_longitude: null as number | null,
         radius_meters: String(200),
       });
       ```

    3. Add dynamic import for GeofenceMapPicker:
       ```
       import dynamic from 'next/dynamic';
       const GeofenceMapPicker = dynamic(
         () => import('@/components/admin/GeofenceMapPicker'),
         { ssr: false, loading: () => <div className="h-[300px] bg-gray-900 rounded-xl animate-pulse flex items-center justify-center"><span className="text-gray-500 text-sm">Loading map...</span></div> }
       );
       ```

    4. Replace lat/lng number inputs (lines 185-216) with the GeofenceMapPicker component:
       ```jsx
       <div className="md:col-span-2">
         <label className="text-gray-400 text-sm font-medium block mb-1">Location & Radius</label>
         <GeofenceMapPicker
           lat={form.center_latitude}
           lng={form.center_longitude}
           radiusMeters={parseInt(form.radius_meters, 10) || 200}
           onChange={(lat, lng, radius) => setForm(p => ({
             ...p,
             center_latitude: lat,
             center_longitude: lng,
             radius_meters: String(radius),
           }))}
         />
       </div>
       ```
       Keep the site_name text input and a separate radius number input (in addition to the slider).

    5. Fix handleSave to use correct column names in insert/update:
       - `{ site_name: form.site_name, center_latitude: lat, center_longitude: lng, radius_meters: radius }`
       - Validation: check `form.center_latitude !== null && form.center_longitude !== null` instead of `isNaN(lat)` / `isNaN(lng)`

    6. Fix startEdit to read from correct column names:
       - `g.center_latitude`, `g.center_longitude`, `g.radius_meters`

    7. Fix geofence list display to use correct column names:
       - `g.center_latitude.toFixed(6)`, `g.center_longitude.toFixed(6)`, `g.radius_meters`

    8. Replace the loading spinner (line 241: `div.w-8.h-8.border-4.animate-spin`) with Skeleton rows:
       - Import Skeleton from `@/components/ui/skeleton`
       - Render 4 skeleton rows matching the geofence list item shape

    9. Fix the `fetchGeofences` query `.order('site_name')` ‚Äî this is correct since migration 119 adds the column. But also add `.order('created_at')` as a fallback sort (some geofences may not have site_name yet).

    10. Also update the `resetForm` to reset radius_metres to `String(defaultRadius)` (keep existing logic but with `radius_meters` key).
  </action>
  <verify>
    - `grep "center_latitude" web/app/admin/geofences/page.tsx` shows correct column name usage
    - `grep -c "lat:" web/app/admin/geofences/page.tsx` returns 0 (no more bare `lat:` keys in DB operations)
    - `grep "MapContainer" web/components/admin/GeofenceMapPicker.tsx` shows Leaflet usage
    - `grep "ssr: false" web/app/admin/geofences/page.tsx` shows dynamic import
    - `grep "leaflet/dist/leaflet.css" web/components/admin/GeofenceMapPicker.tsx` shows CSS import
    - `grep "Skeleton" web/app/admin/geofences/page.tsx` shows skeleton usage in loading state
    - `pnpm build` completes without errors
  </verify>
  <done>
    Geofences page uses correct DB column names (center_latitude, center_longitude, radius_meters). Map picker allows click-to-place + slider resize. Loading state uses skeletons instead of spinner. Build passes.
  </done>
</task>

</tasks>

<verification>
- Migration 119 adds site_name and makes booking_id nullable
- Geofences page uses only `center_latitude`, `center_longitude`, `radius_meters` in DB operations (no more `lat`, `lng`, `radius_metres`)
- GeofenceMapPicker renders Leaflet map with click-to-place and circle overlay
- GeofenceMapPicker uses dynamic import with ssr:false (Leaflet SSR guard)
- Loading state uses Skeleton component instead of spinner
- `pnpm build` passes
</verification>

<success_criteria>
1. Migration `119_geofence_schema_fix.sql` exists with site_name column and nullable booking_id
2. `GeofenceMapPicker.tsx` renders Leaflet map with click-to-place marker and resizable circle
3. Geofences page form uses map picker instead of lat/lng number inputs
4. All DB operations use correct column names (center_latitude, center_longitude, radius_meters)
5. Geofence list loading shows skeleton rows (not spinner)
6. `pnpm build` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/13-ux-polish/13-02-SUMMARY.md`
</output>
