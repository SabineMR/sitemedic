---
phase: 11-org-settings
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - web/app/api/admin/settings/route.ts
  - web/app/admin/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view current org settings values on the settings page"
    - "Admin can edit base rate, geofence radius, urgency premiums, admin email, net30 eligible, credit limit"
    - "Admin sees validation errors for invalid values (base rate <= 0, radius outside 50-5000)"
    - "Admin sees success toast after saving changes"
    - "Settings page loads org settings from database (not hardcoded)"
  artifacts:
    - path: "web/app/api/admin/settings/route.ts"
      provides: "GET and PUT endpoints for org_settings CRUD"
      exports: ["GET", "PUT"]
    - path: "web/app/admin/settings/page.tsx"
      provides: "Business Configuration section with form fields and save logic"
      contains: "Business Configuration"
  key_links:
    - from: "web/app/admin/settings/page.tsx"
      to: "/api/admin/settings"
      via: "fetch on mount (GET) and save button (PUT)"
      pattern: "fetch.*api/admin/settings"
    - from: "web/app/api/admin/settings/route.ts"
      to: "org_settings"
      via: "Supabase query"
      pattern: "from\\('org_settings'\\)"
---

<objective>
Create the admin settings API route and extend the settings page with a "Business Configuration" section that reads from and writes to the `org_settings` table.

Purpose: Gives admins a UI to manage business configuration values that were previously hardcoded. This is the admin-facing half of Phase 11 (the consumer-wiring is Plan 11-03).

Output: New API route at `/api/admin/settings` (GET + PUT) and an extended settings page with live form for all org_settings columns.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-org-settings/11-RESEARCH.md

Key references:
@web/app/admin/settings/page.tsx (current state — extend this file)
@web/app/api/bookings/create/route.ts (requireOrgId + createClient pattern)
@web/contexts/org-context.tsx (orgId export, NOT org)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET + PUT API route for org settings</name>
  <files>web/app/api/admin/settings/route.ts</files>
  <action>
Create `web/app/api/admin/settings/route.ts` with GET and PUT handlers.

**GET handler:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { requireOrgId } from '@/lib/organizations/org-resolver';

export const dynamic = 'force-dynamic';

export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient();
    const orgId = await requireOrgId();

    const { data, error } = await supabase
      .from('org_settings')
      .select('*')
      .eq('org_id', orgId)
      .single();

    if (error || !data) {
      return NextResponse.json({ error: 'Settings not found' }, { status: 404 });
    }
    return NextResponse.json(data);
  } catch {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
}
```

**PUT handler — validate then update:**
- Parse JSON body
- Validate:
  - `base_rate` must be a number > 0
  - `geofence_default_radius` must be an integer between 50 and 5000
  - `urgency_premiums` must be an array of non-negative numbers with at least one element
  - `admin_email` if provided must contain `@`
  - `credit_limit` must be a number >= 0
- On validation failure: return 400 with specific error message
- On success: update `org_settings` row where `org_id = orgId`, set `updated_at` to `new Date().toISOString()`
- Return updated row as JSON

**Important patterns:**
- Use `createClient` from `@/lib/supabase/server` (NOT `@supabase/supabase-js`)
- Use `requireOrgId` from `@/lib/organizations/org-resolver`
- Add `export const dynamic = 'force-dynamic';` at top
- Wrap in try/catch for auth errors

**Do NOT:**
- Create a DELETE handler (settings rows are seeded by migration, not user-created)
- Create a POST handler (settings rows already exist from migration seed)
- Accept `org_id` in the request body (always use `requireOrgId()`)
  </action>
  <verify>
1. File exists at `web/app/api/admin/settings/route.ts`
2. grep confirms: `export async function GET`, `export async function PUT`, `requireOrgId`, `from('org_settings')`, `base_rate`, `geofence_default_radius`, `urgency_premiums`
3. grep confirms validation: `> 0`, `50`, `5000`, `Array.isArray`
  </verify>
  <done>
API route exists at `/api/admin/settings` with:
- GET returns org_settings row for authenticated user's org
- PUT validates all fields and updates org_settings row
- Validation rejects: base_rate <= 0, radius outside 50-5000, empty urgency premiums array, credit_limit < 0
- Uses requireOrgId() and createClient from server module
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend settings page with Business Configuration section</name>
  <files>web/app/admin/settings/page.tsx</files>
  <action>
Rewrite `web/app/admin/settings/page.tsx` to add a "Business Configuration" section that fetches from and saves to the API route.

**Critical bug fix first:** Change line 14 from `const { org } = useOrg()` to `const { orgId, orgName } = useOrg()`. Update all references:
- Line 44: `org?.name` -> `orgName ?? ''`
- Line 56: `org?.id` -> `orgId ?? '---'`

**Add these imports:**
- `useState, useEffect` from 'react'
- `Loader2` from 'lucide-react' (for loading spinner)
- `Sliders` from 'lucide-react' (for Business Config section icon)
- `toast` from 'sonner'

**Add state management at top of component:**
```typescript
const [settings, setSettings] = useState<{
  base_rate: number;
  geofence_default_radius: number;
  urgency_premiums: number[];
  admin_email: string;
  net30_eligible: boolean;
  credit_limit: number;
} | null>(null);
const [settingsLoading, setSettingsLoading] = useState(true);
const [saving, setSaving] = useState(false);
// For urgency premiums, store as comma-separated string for editing
const [urgencyInput, setUrgencyInput] = useState('');
```

**Fetch settings on mount:**
```typescript
useEffect(() => {
  async function loadSettings() {
    try {
      const res = await fetch('/api/admin/settings');
      if (res.ok) {
        const data = await res.json();
        setSettings(data);
        setUrgencyInput((data.urgency_premiums || []).join(', '));
      }
    } catch {
      toast.error('Failed to load settings');
    } finally {
      setSettingsLoading(false);
    }
  }
  loadSettings();
}, []);
```

**Save handler:**
```typescript
async function handleSaveSettings() {
  if (!settings) return;
  // Parse urgency premiums from comma-separated input
  const premiums = urgencyInput.split(',').map(s => Number(s.trim())).filter(n => !isNaN(n) && n >= 0);
  if (premiums.length === 0) {
    toast.error('At least one urgency premium tier is required');
    return;
  }
  if (settings.base_rate <= 0) {
    toast.error('Base rate must be greater than 0');
    return;
  }
  if (settings.geofence_default_radius < 50 || settings.geofence_default_radius > 5000) {
    toast.error('Geofence radius must be between 50 and 5000 metres');
    return;
  }

  setSaving(true);
  try {
    const res = await fetch('/api/admin/settings', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...settings, urgency_premiums: premiums }),
    });
    if (res.ok) {
      const updated = await res.json();
      setSettings(updated);
      toast.success('Settings saved');
    } else {
      const err = await res.json();
      toast.error(err.error || 'Failed to save settings');
    }
  } catch {
    toast.error('Failed to save settings');
  } finally {
    setSaving(false);
  }
}
```

**New "Business Configuration" section** — insert AFTER the Organisation Profile section (before Notifications). Include:

1. **Base Rate** — number input, label "Base Rate (GBP/hr)", min=1, step=0.50, helper text "Hourly rate charged to clients. Current default: GBP 42/hr"
2. **Geofence Default Radius** — number input, label "Default Geofence Radius (metres)", min=50, max=5000, helper text "Pre-filled when adding a new geofence. Range: 50-5000m"
3. **Urgency Premiums** — text input, label "Urgency Premium Tiers (%)", value is `urgencyInput`, helper text "Comma-separated percentage values. E.g. 0, 20, 50, 75"
4. **Admin Email** — email input, label "Admin Notification Email", placeholder "admin@yourcompany.co.uk", helper text "Receives contact form and quote submission notifications"
5. **Net 30 Eligible** — toggle (checkbox styled as toggle matching the Notifications section pattern), label "Net 30 Payment Terms Available"
6. **Credit Limit** — number input, label "Default Credit Limit (GBP)", min=0, step=100, helper text "Maximum outstanding balance for Net 30 clients"
7. **Save button** — same gradient style as existing "Save Changes" button, shows "Saving..." with Loader2 spinner when `saving` is true

Use the same card styling as other sections: `bg-gray-800/50 backdrop-blur-xl rounded-xl border border-gray-700/50 shadow-2xl p-6 space-y-5`

Use same input styling as the existing contact details inputs.

If `settingsLoading` is true, show a spinner inside the Business Configuration card instead of the form fields.

**Preserve ALL existing sections** (Organisation Profile, Notifications, Contact Details, Billing, Security). Only add the new Business Configuration section and fix the `org` destructuring bug.

**Do NOT:**
- Remove or modify existing sections beyond the orgId bug fix
- Use TanStack Query (this is a simple fetch-on-mount, no polling needed)
- Import `createClient` from supabase/client (use fetch to the API route instead — keeps validation server-side)
  </action>
  <verify>
1. grep confirms: `const { orgId, orgName } = useOrg()` (bug fix applied)
2. grep confirms: `Business Configuration` section heading exists
3. grep confirms: `base_rate`, `geofence_default_radius`, `urgency_premiums`, `admin_email`, `net30_eligible`, `credit_limit` all referenced in form
4. grep confirms: `fetch('/api/admin/settings')` for both GET and PUT
5. grep confirms: `toast.success('Settings saved')` and `toast.error` calls
6. grep confirms: all 5 original sections still exist (Organisation Profile, Notifications, Contact Details, Billing & Subscription, Security)
  </verify>
  <done>
Settings page at `/admin/settings` now has:
- Bug fix: uses `orgId` and `orgName` from `useOrg()` (not broken `org`)
- New "Business Configuration" section with 6 editable fields matching org_settings columns
- Fetches settings from `/api/admin/settings` on mount
- Saves via PUT with client-side + server-side validation
- Toast feedback on save success/error
- Loading spinner while settings are fetching
- All 5 existing sections preserved unchanged
  </done>
</task>

</tasks>

<pitfalls>
1. **`org` vs `orgId` bug**: The existing settings page uses `const { org } = useOrg()` which gives `undefined`. MUST fix to `const { orgId, orgName } = useOrg()` and update `org?.name` to `orgName`, `org?.id` to `orgId`.
2. **Urgency premiums input**: Store as comma-separated string in state for editing convenience. Parse to `number[]` on save. The Supabase client auto-deserializes JSONB to JS array, so no manual JSON.parse is needed on fetch.
3. **Keep existing sections**: Do NOT remove or refactor the Notifications, Contact Details, Billing, or Security sections. Only ADD the Business Configuration section and fix the org destructuring.
4. **API route directory**: The `web/app/api/admin/` directory exists but only contains `territories/`. The new `settings/route.ts` file goes in a new `settings/` subdirectory.
5. **sonner import**: The `toast` import from `sonner` is already used in `geofences/page.tsx` and other admin pages, confirming it is available in the project.
</pitfalls>

<verification>
- Settings page renders without errors
- Business Configuration section shows all 6 fields with correct labels and helper text
- GET `/api/admin/settings` returns org_settings row (200)
- PUT `/api/admin/settings` with valid data returns updated row (200)
- PUT `/api/admin/settings` with `base_rate: 0` returns 400 error
- PUT `/api/admin/settings` with `geofence_default_radius: 10` returns 400 error
- Organisation Profile section still shows org name and org ID correctly (bug fix verified)
</verification>

<success_criteria>
Admin can navigate to `/admin/settings`, see a "Business Configuration" section pre-filled with current database values, edit any field, click Save, and see a success toast. Invalid values (base_rate <= 0, radius outside 50-5000) are rejected with error messages.
</success_criteria>

<output>
After completion, create `.planning/phases/11-org-settings/11-02-SUMMARY.md`
</output>
