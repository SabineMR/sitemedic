---
phase: 11-org-settings
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - web/components/booking/booking-form.tsx
  - web/lib/booking/pricing.ts
  - web/app/api/bookings/create/route.ts
  - web/app/api/bookings/create-payment-intent/route.ts
  - web/app/admin/geofences/page.tsx
  - web/app/api/contact/submit/route.ts
  - web/app/api/quotes/submit/route.ts
autonomous: true

must_haves:
  truths:
    - "Booking form uses base_rate from org_settings (not hardcoded 42)"
    - "Geofence 'Add' form pre-fills radius from org_settings.geofence_default_radius (not hardcoded 200)"
    - "Booking creation API validates urgency premiums against org_settings array (not hardcoded [0,20,50,75])"
    - "Payment intent API validates urgency premiums against org_settings array (not hardcoded [0,20,50,75])"
    - "Contact and quote submission emails use org_settings.admin_email when available"
    - "Geofences page loads correctly (org?.id bug fixed to orgId)"
  artifacts:
    - path: "web/components/booking/booking-form.tsx"
      provides: "Booking form using dynamic base_rate from org_settings"
      contains: "org_settings"
    - path: "web/app/api/bookings/create/route.ts"
      provides: "Server-side urgency premium validation from org_settings"
      contains: "org_settings"
    - path: "web/app/api/bookings/create-payment-intent/route.ts"
      provides: "Server-side urgency premium validation from org_settings"
      contains: "org_settings"
    - path: "web/app/admin/geofences/page.tsx"
      provides: "Dynamic default radius from org_settings + orgId bug fix"
      contains: "org_settings"
    - path: "web/app/api/contact/submit/route.ts"
      provides: "Admin email from org_settings with env var fallback"
      contains: "org_settings"
    - path: "web/app/api/quotes/submit/route.ts"
      provides: "Admin email from org_settings with env var fallback"
      contains: "org_settings"
  key_links:
    - from: "web/components/booking/booking-form.tsx"
      to: "org_settings"
      via: "Supabase client query on mount"
      pattern: "from\\('org_settings'\\).*select.*base_rate"
    - from: "web/app/api/bookings/create/route.ts"
      to: "org_settings"
      via: "Supabase query for urgency_premiums"
      pattern: "from\\('org_settings'\\).*urgency_premiums"
    - from: "web/app/admin/geofences/page.tsx"
      to: "org_settings"
      via: "Supabase client query for geofence_default_radius"
      pattern: "from\\('org_settings'\\).*geofence_default_radius"
---

<objective>
Wire all 7 consumer files to read business configuration from the `org_settings` table instead of using hardcoded values. Remove hardcoded `baseRate: 42`, `DEFAULT_RADIUS = 200`, `validUrgencyPremiums = [0, 20, 50, 75]`, and `admin@sitemedic.co.uk` fallback from all in-scope files.

Purpose: Completes Phase 11 by making every consumer of business configuration actually read from the database. After this plan, changing a value in `/admin/settings` immediately affects bookings, geofences, and email notifications.

Output: 7 files updated to read from `org_settings`, with graceful fallbacks to current hardcoded defaults if the settings row is missing.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-org-settings/11-RESEARCH.md

Key source files (current state):
@web/components/booking/booking-form.tsx (line 84: baseRate: 42)
@web/lib/booking/pricing.ts (line 73: baseRate = 42)
@web/app/api/bookings/create/route.ts (line 111: validUrgencyPremiums = [0, 20, 50, 75])
@web/app/api/bookings/create-payment-intent/route.ts (line 74: validUrgencyPremiums = [0, 20, 50, 75])
@web/app/admin/geofences/page.tsx (line 27: DEFAULT_RADIUS = 200; line 30: org?.id bug)
@web/app/api/contact/submit/route.ts (line 66: admin@sitemedic.co.uk)
@web/app/api/quotes/submit/route.ts (line 90: admin@sitemedic.co.uk)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire booking form and pricing to read base_rate from org_settings</name>
  <files>web/components/booking/booking-form.tsx, web/lib/booking/pricing.ts</files>
  <action>
**File 1: `web/components/booking/booking-form.tsx`**

This is a `'use client'` component. Add a Supabase client query to fetch `base_rate` from `org_settings` on mount.

1. Add import: `import { createClient } from '@/lib/supabase/client';`
2. Add state: `const [baseRate, setBaseRate] = useState<number>(42);` (42 as fallback until loaded)
3. Add useEffect to fetch base_rate on mount:
```typescript
useEffect(() => {
  async function loadBaseRate() {
    const supabase = createClient();
    const { data } = await supabase
      .from('org_settings')
      .select('base_rate')
      .single();
    if (data?.base_rate) {
      setBaseRate(Number(data.base_rate));
    }
  }
  loadBaseRate();
}, []);
```
4. Change line 84 from `baseRate: 42,` to `baseRate: baseRate,` (or just `baseRate,` using shorthand)
5. Add `baseRate` to the useEffect dependency array for the pricing recalculation (the one on line ~92 with `[formData.shiftDate, formData.shiftHours]` — add `baseRate` so pricing recalculates when the org rate loads)
6. Add a comment: `// Base rate loaded from org_settings; falls back to 42 until loaded`

**File 2: `web/lib/booking/pricing.ts`**

Minimal change — keep the `baseRate = 42` default parameter in `calculateBookingPrice()` as a safe fallback. Add a comment explaining:
```typescript
baseRate = 42, // Fallback default; callers should pass org_settings.base_rate
```

**Do NOT modify `getUrgencyPremium()` in pricing.ts** — this is a display-only function and stays hardcoded for Phase 11 (documented as known limitation in research).

**Do NOT:**
- Import `useOrg` in booking-form.tsx (the Supabase client query with RLS handles org filtering automatically — `org_settings` has RLS using `get_user_org_id()`)
- Use `fetch('/api/admin/settings')` (direct Supabase client is simpler for a single field read)
- Remove the `calculateBookingPrice` import or change its signature
  </action>
  <verify>
1. grep `web/components/booking/booking-form.tsx` for `org_settings` confirms Supabase query exists
2. grep `web/components/booking/booking-form.tsx` confirms no remaining `baseRate: 42` literal (should be `baseRate,` or `baseRate: baseRate`)
3. grep `web/lib/booking/pricing.ts` confirms `baseRate = 42` still exists as default parameter (intentional fallback)
  </verify>
  <done>
Booking form fetches base_rate from org_settings on mount and uses it for pricing calculation. Pricing.ts retains 42 as a fallback default parameter. If admin changes base rate to 45, new bookings will calculate at 45/hr.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire API routes, geofences, and email routes to read from org_settings</name>
  <files>web/app/api/bookings/create/route.ts, web/app/api/bookings/create-payment-intent/route.ts, web/app/admin/geofences/page.tsx, web/app/api/contact/submit/route.ts, web/app/api/quotes/submit/route.ts</files>
  <action>
**File 1: `web/app/api/bookings/create/route.ts`**

Replace the hardcoded urgency premium validation (around line 111):

Before:
```typescript
const validUrgencyPremiums = [0, 20, 50, 75];
```

After:
```typescript
// Fetch org settings for dynamic validation
const { data: orgSettings } = await supabase
  .from('org_settings')
  .select('urgency_premiums')
  .eq('org_id', orgId)
  .single();

const validUrgencyPremiums: number[] = orgSettings?.urgency_premiums ?? [0, 20, 50, 75];
```

The rest of the validation logic (`if (!validUrgencyPremiums.includes(...)`) stays the same. Add the query BEFORE the validation check. The `supabase` client and `orgId` are already available earlier in the function.

---

**File 2: `web/app/api/bookings/create-payment-intent/route.ts`**

IDENTICAL change as File 1. Replace the hardcoded validation (around line 74):

Before:
```typescript
const validUrgencyPremiums = [0, 20, 50, 75];
```

After:
```typescript
// Fetch org settings for dynamic validation
const { data: orgSettings } = await supabase
  .from('org_settings')
  .select('urgency_premiums')
  .eq('org_id', orgId)
  .single();

const validUrgencyPremiums: number[] = orgSettings?.urgency_premiums ?? [0, 20, 50, 75];
```

The `supabase` client and `orgId` are already available — `requireOrgId()` is called at the top of the POST handler and `createClient()` is already imported.

---

**File 3: `web/app/admin/geofences/page.tsx`**

Two changes:

**Bug fix (CRITICAL):** Line 30 — change `const { org } = useOrg();` to `const { orgId } = useOrg();`

Then update ALL references to `org?.id` and `org.id` throughout the file:
- Line 44: `if (!org?.id) return;` -> `if (!orgId) return;`
- Line 49: `.eq('org_id', org.id)` -> `.eq('org_id', orgId)`
- Line 62: `}, [org?.id]);` -> `}, [orgId]);`
- Line 82: `if (!org?.id) return;` -> `if (!orgId) return;`
- Line 110: `org_id: org.id,` -> `org_id: orgId,`

**Dynamic radius:** Replace the hardcoded `const DEFAULT_RADIUS = 200;` (line 27) with state:

1. Add state: `const [defaultRadius, setDefaultRadius] = useState(200);`
2. Remove the `const DEFAULT_RADIUS = 200;` line
3. Add useEffect to fetch default radius:
```typescript
useEffect(() => {
  async function loadDefaultRadius() {
    const supabase = createClient();
    const { data } = await supabase
      .from('org_settings')
      .select('geofence_default_radius')
      .single();
    if (data?.geofence_default_radius) {
      setDefaultRadius(data.geofence_default_radius);
    }
  }
  loadDefaultRadius();
}, []);
```
4. Replace `DEFAULT_RADIUS` usages:
   - Line 40: `radius_metres: String(DEFAULT_RADIUS)` -> `radius_metres: String(defaultRadius)`
   - Line 65 (resetForm): `radius_metres: String(DEFAULT_RADIUS)` -> `radius_metres: String(defaultRadius)`

---

**File 4: `web/app/api/contact/submit/route.ts`**

This route uses a service-role client and `ASG_ORG_ID` env var (public form, no user auth). Replace the admin email lookup (around line 66):

Before:
```typescript
const adminEmail = process.env.ADMIN_EMAIL || 'admin@sitemedic.co.uk';
```

After:
```typescript
// Try org_settings for admin email, fall back to env var, then hardcoded default
let adminEmail = process.env.ADMIN_EMAIL || 'admin@sitemedic.co.uk';
if (orgId) {
  const { data: orgSettings } = await supabase
    .from('org_settings')
    .select('admin_email')
    .eq('org_id', orgId)
    .single();
  if (orgSettings?.admin_email) {
    adminEmail = orgSettings.admin_email;
  }
}
```

The `supabase` (service-role client) and `orgId` (`process.env.ASG_ORG_ID`) are already available earlier in the function. Service-role client bypasses RLS, so it can read any org_settings row.

---

**File 5: `web/app/api/quotes/submit/route.ts`**

IDENTICAL pattern as File 4. Replace the admin email lookup (around line 90):

Before:
```typescript
const adminEmail = process.env.ADMIN_EMAIL || 'admin@sitemedic.co.uk';
```

After:
```typescript
// Try org_settings for admin email, fall back to env var, then hardcoded default
let adminEmail = process.env.ADMIN_EMAIL || 'admin@sitemedic.co.uk';
if (orgId) {
  const { data: orgSettings } = await supabase
    .from('org_settings')
    .select('admin_email')
    .eq('org_id', orgId)
    .single();
  if (orgSettings?.admin_email) {
    adminEmail = orgSettings.admin_email;
  }
}
```

Verify `orgId` is already defined earlier in the function (it should be from `process.env.ASG_ORG_ID`). The `supabase` service-role client is also already available.

---

**Do NOT:**
- Modify `supabase/functions/calculate-pricing/index.ts` (Edge Function, out of scope — pure calc, no DB)
- Modify `supabase/functions/cash-flow-monitor/index.ts` or `friday-payout/index.ts` (Edge Functions, out of scope)
- Modify `getUrgencyPremium()` in `pricing.ts` (display-only, stays hardcoded for Phase 11)
- Remove fallback defaults from any file (always fall back gracefully if org_settings query returns null)
  </action>
  <verify>
1. grep `web/app/api/bookings/create/route.ts` for `org_settings` — confirms dynamic urgency premium fetch
2. grep `web/app/api/bookings/create-payment-intent/route.ts` for `org_settings` — confirms dynamic urgency premium fetch
3. grep `web/app/admin/geofences/page.tsx` for `orgId` — confirms bug fix (no more `org?.id` or `org.id`)
4. grep `web/app/admin/geofences/page.tsx` for `org_settings` — confirms dynamic radius fetch
5. grep `web/app/admin/geofences/page.tsx` confirms no remaining `DEFAULT_RADIUS` constant
6. grep `web/app/api/contact/submit/route.ts` for `org_settings` — confirms admin email lookup
7. grep `web/app/api/quotes/submit/route.ts` for `org_settings` — confirms admin email lookup
8. Run `pnpm build` to confirm TypeScript compilation succeeds with no type errors
  </verify>
  <done>
All 5 consumer files wired to org_settings:
- Both booking API routes validate urgency premiums from org_settings (not hardcoded)
- Geofences page uses dynamic default radius + orgId bug fixed
- Contact and quotes submit routes read admin_email from org_settings
- All files retain graceful fallbacks to current hardcoded values
  </done>
</task>

</tasks>

<pitfalls>
1. **Both urgency premium routes**: `create/route.ts` AND `create-payment-intent/route.ts` must BOTH be updated. Missing the second one (discovered during research, not in CONTEXT.md) would cause payment intent creation to reject valid custom premiums.
2. **`org?.id` bug in geofences**: The page currently uses `const { org } = useOrg()` which gives `undefined`. Every instance of `org?.id` and `org.id` must be changed to `orgId`. There are 5 occurrences (lines 44, 49, 62, 82, 110).
3. **Service-role client in contact/quotes routes**: These routes use `getServiceRoleClient()` which bypasses RLS. The org_settings query will work because service-role ignores RLS policies. Always filter by `org_id` explicitly.
4. **JSONB auto-deserialization**: Supabase client returns JSONB as JavaScript arrays automatically. Do NOT call `JSON.parse()` on `urgency_premiums`. TypeScript type: `number[]`.
5. **Fallback defaults everywhere**: Every org_settings read must have a fallback (`?? [0, 20, 50, 75]`, `?? 200`, `?? 42`). If the migration seed is somehow missing, the app must not crash.
6. **`getUrgencyPremium()` stays hardcoded**: The display-only urgency function in pricing.ts is NOT changed in Phase 11. The validation (server-side) uses org_settings. Document this divergence as a known limitation.
7. **booking-form.tsx Supabase client**: Use `createClient` from `@/lib/supabase/client` (client-side), NOT `@/lib/supabase/server`. RLS on org_settings handles org filtering — no need for explicit `orgId` filter.
</pitfalls>

<verification>
- `pnpm build` succeeds with no TypeScript errors across all 7 modified files
- No remaining hardcoded `baseRate: 42` in booking-form.tsx (should be dynamic `baseRate` state)
- No remaining `const DEFAULT_RADIUS = 200` in geofences/page.tsx (should be dynamic state)
- No remaining `const validUrgencyPremiums = [0, 20, 50, 75]` in either booking API route (should query org_settings)
- Geofences page has zero instances of `org?.id` or `org.id` (all replaced with `orgId`)
- Contact and quotes routes query org_settings for admin_email before falling back to env var
</verification>

<success_criteria>
After this plan:
1. Admin changes base rate from 42 to 45 in settings -> new booking form shows pricing at 45/hr
2. Admin changes geofence radius to 300 in settings -> new geofence form pre-fills 300m
3. Admin adds custom urgency premium (e.g. 30%) -> booking creation API accepts 30% as valid
4. Admin sets admin email -> contact/quote form notifications go to that email
5. Geofences page actually loads data (org?.id bug fixed)
</success_criteria>

<output>
After completion, create `.planning/phases/11-org-settings/11-03-SUMMARY.md`
</output>
