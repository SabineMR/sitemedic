---
phase: 11-org-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/118_org_settings.sql
autonomous: true

must_haves:
  truths:
    - "org_settings table exists with correct columns and constraints"
    - "Every existing organisation has a settings row seeded with current hardcoded defaults"
    - "RLS policies allow org users to read their own settings and platform admins to manage all"
    - "CHECK constraints enforce base_rate > 0 and radius between 50-5000"
  artifacts:
    - path: "supabase/migrations/118_org_settings.sql"
      provides: "org_settings table, indexes, RLS, seed data"
      contains: "CREATE TABLE org_settings"
  key_links:
    - from: "org_settings.org_id"
      to: "organizations.id"
      via: "FOREIGN KEY with ON DELETE CASCADE"
      pattern: "REFERENCES organizations\\(id\\) ON DELETE CASCADE"
---

<objective>
Create the `org_settings` database table that stores per-organisation business configuration values, replacing hardcoded defaults scattered across the codebase.

Purpose: This migration is the foundation for Plans 11-02 (admin UI) and 11-03 (consumer wiring). Without the table and seed data, no other plan in this phase can function.

Output: `supabase/migrations/118_org_settings.sql` with table, constraints, indexes, RLS policies, column comments, and seed data for all existing organisations.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-org-settings/11-RESEARCH.md

Key references for migration pattern:
@supabase/migrations/117_lead_capture_tables.sql
@supabase/migrations/115_referral_and_per_medic_rates.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 118_org_settings.sql</name>
  <files>supabase/migrations/118_org_settings.sql</files>
  <action>
Create `supabase/migrations/118_org_settings.sql` following the established migration pattern from migrations 115-117.

**Table definition:**
```sql
CREATE TABLE org_settings (
  id                      UUID        PRIMARY KEY DEFAULT uuid_generate_v4(),
  org_id                  UUID        NOT NULL UNIQUE REFERENCES organizations(id) ON DELETE CASCADE,
  base_rate               DECIMAL(10,2) NOT NULL DEFAULT 42.00
                          CHECK (base_rate > 0),
  geofence_default_radius INTEGER     NOT NULL DEFAULT 200
                          CHECK (geofence_default_radius BETWEEN 50 AND 5000),
  urgency_premiums        JSONB       NOT NULL DEFAULT '[0, 20, 50, 75]'::jsonb,
  admin_email             TEXT,
  net30_eligible          BOOLEAN     NOT NULL DEFAULT TRUE,
  credit_limit            DECIMAL(10,2) NOT NULL DEFAULT 5000.00
                          CHECK (credit_limit >= 0),
  created_at              TIMESTAMPTZ DEFAULT NOW(),
  updated_at              TIMESTAMPTZ DEFAULT NOW()
);
```

**Include in order:**
1. Header comment block: `-- 118: Organisation Settings` with purpose and date
2. `CREATE TABLE` with all columns, constraints, and defaults as shown above
3. `COMMENT ON TABLE` and `COMMENT ON COLUMN` for every column (describe what each setting controls and its unit/format)
4. Index: `CREATE INDEX idx_org_settings_org ON org_settings (org_id);`
5. Seed existing organisations:
   ```sql
   INSERT INTO org_settings (org_id, base_rate, geofence_default_radius, urgency_premiums, admin_email, net30_eligible, credit_limit)
   SELECT id, 42.00, 200, '[0, 20, 50, 75]'::jsonb, NULL, TRUE, 5000.00
   FROM organizations
   ON CONFLICT (org_id) DO NOTHING;
   ```
6. Enable RLS: `ALTER TABLE org_settings ENABLE ROW LEVEL SECURITY;`
7. Four RLS policies:
   - `org_users_select`: `FOR SELECT USING (org_id = get_user_org_id())`
   - `org_users_update`: `FOR UPDATE USING (org_id = get_user_org_id()) WITH CHECK (org_id = get_user_org_id())`
   - `platform_admins_select`: `FOR SELECT USING (is_platform_admin())`
   - `platform_admins_all`: `FOR ALL USING (is_platform_admin()) WITH CHECK (is_platform_admin())`
8. Summary comment block at the bottom listing what was created

**Do NOT:**
- Add an `updated_at` trigger (not used in recent migrations; `updated_at` is set manually in the API route)
- Add INSERT/DELETE policies for org users (only platform admins can create/delete settings rows)
- Use `gen_random_uuid()` (use `uuid_generate_v4()` to match migrations 115-117)
  </action>
  <verify>
1. File exists at `supabase/migrations/118_org_settings.sql`
2. grep confirms: `CREATE TABLE org_settings`, `UNIQUE`, `CHECK (base_rate > 0)`, `CHECK (geofence_default_radius BETWEEN 50 AND 5000)`, `CHECK (credit_limit >= 0)`, `ENABLE ROW LEVEL SECURITY`, `get_user_org_id()`, `is_platform_admin()`, `ON CONFLICT (org_id) DO NOTHING`
3. grep confirms: `COMMENT ON TABLE`, `COMMENT ON COLUMN` for all 8 data columns
  </verify>
  <done>
Migration file 118_org_settings.sql exists with:
- org_settings table with all 8 configurable columns plus id/org_id/timestamps
- UNIQUE constraint on org_id (one row per org)
- CHECK constraints on base_rate (> 0), geofence_default_radius (50-5000), credit_limit (>= 0)
- JSONB default for urgency_premiums
- Seed INSERT for all existing organisations with current hardcoded defaults
- RLS: org users can SELECT and UPDATE their own row; platform admins have full access
- Column comments documenting each setting's purpose
  </done>
</task>

</tasks>

<pitfalls>
1. **uuid_generate_v4 not gen_random_uuid**: Recent migrations (115-117) use `uuid_generate_v4()`. Stay consistent.
2. **Seed existing orgs**: Without the `INSERT ... SELECT FROM organizations ON CONFLICT DO NOTHING`, existing orgs will have no settings row and API calls will return null.
3. **JSONB literal syntax**: Use `'[0, 20, 50, 75]'::jsonb` not `'[0,20,50,75]'` (explicit cast).
4. **No INSERT policy for org users**: Org users should not create settings rows â€” only platform admins. The seed handles initial creation.
5. **No moddatetime trigger**: The codebase manages `updated_at` in application code, not via database triggers.
</pitfalls>

<verification>
- `supabase/migrations/118_org_settings.sql` exists and is syntactically valid SQL
- All columns from requirements present: base_rate, geofence_default_radius, urgency_premiums, admin_email, net30_eligible, credit_limit
- Seed INSERT uses exact current hardcoded values: 42.00, 200, [0,20,50,75], NULL admin_email, TRUE net30, 5000.00 credit
- RLS uses established functions: `get_user_org_id()`, `is_platform_admin()`
</verification>

<success_criteria>
Migration 118_org_settings.sql is complete, follows codebase conventions, seeds existing orgs with current defaults, and enables RLS with correct policies. Plans 11-02 and 11-03 can proceed assuming this table exists.
</success_criteria>

<output>
After completion, create `.planning/phases/11-org-settings/11-01-SUMMARY.md`
</output>
