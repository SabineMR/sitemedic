---
phase: 43-real-time-push-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/PushTokenService.ts
  - src/contexts/NotificationContext.tsx
  - app/(tabs)/_layout.tsx
  - app.json
autonomous: true
user_setup:
  - service: expo-push
    why: "iOS push notifications require an Expo project ID for token registration"
    env_vars:
      - name: EXPO_PUBLIC_PROJECT_ID
        source: "Expo dashboard (expo.dev) -> Project Settings -> Project ID (UUID format)"
    dashboard_config:
      - task: "Create or link EAS project for push credentials"
        location: "Run `npx eas init` or visit expo.dev -> Projects -> SiteMedic"

must_haves:
  truths:
    - "iOS app requests push notification permission when user first opens Messages tab"
    - "Device push token is registered in profiles.push_token column in Supabase"
    - "Token is only updated if changed or older than 7 days (no unnecessary writes)"
    - "Tapping a push notification navigates to the relevant conversation"
    - "Foreground notifications show an in-app toast (not a native banner that covers content)"
  artifacts:
    - path: "src/services/PushTokenService.ts"
      provides: "Token registration, permission request, token change listener"
      min_lines: 60
    - path: "src/contexts/NotificationContext.tsx"
      provides: "Notification listeners for foreground, background tap, deep linking"
      min_lines: 50
  key_links:
    - from: "src/services/PushTokenService.ts"
      to: "profiles.push_token"
      via: "Supabase update on token registration"
      pattern: "supabase.*profiles.*update.*push_token"
    - from: "src/contexts/NotificationContext.tsx"
      to: "app/messages/[conversationId]"
      via: "Deep link navigation on notification tap"
      pattern: "router\\.push.*messages"
---

<objective>
Set up iOS push notification infrastructure: permission requests, device token registration in Supabase, notification handlers for foreground/background, and deep linking when a notification is tapped.

Purpose: This plan prepares the iOS app to receive push notifications. Plan 43-03 creates the server-side Edge Function that actually sends them. Without token registration (this plan), the Edge Function has no tokens to send to.

Output: PushTokenService for token management, NotificationContext for notification handling, and app.json configuration for push notifications.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-real-time-push-notifications/43-RESEARCH.md
@.planning/phases/43-real-time-push-notifications/43-CONTEXT.md

Key existing files to reference:
@app.json (already has expo-notifications plugin configured)
@src/contexts/SyncContext.tsx (integration point for token registration on auth)
@src/services/MessageSync.ts (existing service pattern to follow)
@app/(tabs)/_layout.tsx (tab layout where Messages tab lives)
@supabase/migrations/060_emergency_alerts.sql (profiles.push_token column already exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: PushTokenService and permission flow</name>
  <files>
    src/services/PushTokenService.ts
    app.json
  </files>
  <action>
    Create `src/services/PushTokenService.ts` as a singleton service for push token management:

    1. **`registerPushToken()` method:**
       - Check current permission status via `Notifications.getPermissionsAsync()`
       - If permission is 'undetermined', request it via `Notifications.requestPermissionsAsync({ ios: { allowAlert: true, allowBadge: true, allowSound: true } })`
       - If permission is 'denied', return null (do NOT re-prompt -- iOS only shows once)
       - Get Expo push token: `Notifications.getExpoPushTokenAsync({ projectId: Constants.expoConfig?.extra?.eas?.projectId || process.env.EXPO_PUBLIC_PROJECT_ID })`
       - Compare token against stored value in `profiles.push_token` via Supabase query
       - Only update if: token has changed OR `push_token_updated_at` is null OR older than 7 days
       - Update with: `supabase.from('profiles').update({ push_token: newToken, push_token_updated_at: new Date().toISOString() }).eq('id', userId)`
       - Return the token string on success, null on failure
       - Log all outcomes: `[PushToken] Registered: ExponentPushToken[xxx...]`, `[PushToken] Skipped (unchanged)`, `[PushToken] Permission denied`

    2. **`clearPushToken()` method:**
       - Called on logout: sets `profiles.push_token` to null and `push_token_updated_at` to null
       - Prevents push delivery to a logged-out device

    3. **`getPermissionStatus()` method:**
       - Returns current permission status ('granted' | 'denied' | 'undetermined')
       - Used by UI to show "Enable notifications" banner when denied

    4. **`setupTokenChangeListener()` method:**
       - Uses `Notifications.addPushTokenListener()` to detect rare token changes
       - Calls `registerPushToken()` on change
       - Returns cleanup function

    5. **app.json updates:** The expo-notifications plugin is already configured. No changes needed unless the `eas` projectId needs to be added. Add the following to `app.json` under `expo`:
       ```json
       "extra": {
         "eas": {
           "projectId": "${EXPO_PUBLIC_PROJECT_ID}"
         }
       }
       ```
       If `extra.eas.projectId` is already present, skip this step.

    6. **Notification category setup:** Configure default notification behavior:
       ```typescript
       Notifications.setNotificationHandler({
         handleNotification: async () => ({
           shouldShowAlert: false, // We handle foreground notifications ourselves (in-app toast)
           shouldPlaySound: true,
           shouldSetBadge: true,
         }),
       });
       ```
       This goes at module level in PushTokenService (or in NotificationContext). Setting `shouldShowAlert: false` prevents the native banner from covering the app when a notification arrives while the app is in foreground -- we'll show a custom in-app toast instead.

    Follow the same singleton export pattern as `src/services/MessageSync.ts` (class with static methods or instantiated singleton).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - PushTokenService.ts exports `registerPushToken`, `clearPushToken`, `getPermissionStatus`, `setupTokenChangeListener`
    - Grep for `requestPermissionsAsync` in PushTokenService.ts -- confirms permission request
    - Grep for `getExpoPushTokenAsync` in PushTokenService.ts -- confirms token retrieval
    - Grep for `push_token` in PushTokenService.ts -- confirms Supabase update
    - Grep for `push_token_updated_at` in PushTokenService.ts -- confirms 7-day staleness check
  </verify>
  <done>
    PushTokenService handles the full token lifecycle: permission request, token retrieval, conditional Supabase update (only if changed or stale), token change listener, and logout cleanup. Token stored in existing profiles.push_token column.
  </done>
</task>

<task type="auto">
  <name>Task 2: NotificationContext with handlers and deep linking</name>
  <files>
    src/contexts/NotificationContext.tsx
    app/(tabs)/_layout.tsx
  </files>
  <action>
    Create `src/contexts/NotificationContext.tsx` -- a React Context provider that manages notification lifecycle:

    1. **Provider setup:**
       - Wrap the app root (in the tabs layout or app root layout) with `<NotificationProvider>`
       - On mount (when user is authenticated):
         a. Call `PushTokenService.registerPushToken()` -- but ONLY trigger the permission prompt when the user navigates to the Messages tab for the first time (NOT on app launch). Use a flag in AsyncStorage (`push_permission_prompted`) to track whether we've already asked.
         b. Set up `PushTokenService.setupTokenChangeListener()` with cleanup on unmount

    2. **Foreground notification handler:**
       - Use `Notifications.addNotificationReceivedListener()` to handle notifications arriving while app is open
       - When a message notification arrives in foreground:
         a. Do NOT show the native banner (already configured via `shouldShowAlert: false`)
         b. If the user is currently viewing the SAME conversation that the notification is for (`data.conversationId` matches current route), ignore it (they're already looking at the messages)
         c. If the user is on a DIFFERENT screen, show an in-app toast/banner at the top: "[Sender name] sent you a message" with a "View" button that navigates to the conversation
         d. Use a simple custom component (View with Animated opacity, auto-dismiss after 4 seconds) -- not a third-party toast library
       - Return cleanup function

    3. **Background notification tap handler:**
       - Use `Notifications.addNotificationResponseReceivedListener()` to handle taps on notifications from the notification tray
       - Extract `conversationId` from `response.notification.request.content.data.conversationId`
       - Navigate to `messages/${conversationId}` using Expo Router's `router.push()`
       - Handle edge case: if conversationId is missing, navigate to the messages tab instead

    4. **App badge management:**
       - On foreground: when app comes to foreground (AppState change to 'active'), recalculate unread count from WatermelonDB and set badge via `Notifications.setBadgeCountAsync(count)`
       - On mark-as-read: when user opens a conversation, decrement badge count
       - Expose `updateBadgeCount()` function via context for use by mark-as-read logic

    5. **Permission status tracking:**
       - Expose `permissionStatus` ('granted' | 'denied' | 'undetermined') via context
       - When 'denied', messaging screens can show a subtle banner: "Notifications are off. Enable in Settings." with a link to `Linking.openSettings()`

    6. **Integration in `app/(tabs)/_layout.tsx`:**
       - Wrap the tab navigator content with `<NotificationProvider>` (or add it to the root app layout)
       - When the Messages tab is focused for the first time AND `push_permission_prompted` is not set in AsyncStorage: call `PushTokenService.registerPushToken()` which triggers the native permission dialog
       - Set `push_permission_prompted = true` in AsyncStorage after the first prompt attempt

    The in-app toast for foreground notifications should be a lightweight component -- a simple `Animated.View` with absolute positioning at the top, background #3B82F6 (blue), white text, auto-dismiss. No third-party libraries.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - NotificationContext.tsx exports `NotificationProvider` and `useNotifications` hook
    - Grep for `addNotificationReceivedListener` in NotificationContext.tsx -- confirms foreground handler
    - Grep for `addNotificationResponseReceivedListener` in NotificationContext.tsx -- confirms tap handler
    - Grep for `router.push` in NotificationContext.tsx -- confirms deep linking navigation
    - Grep for `setBadgeCountAsync` in NotificationContext.tsx -- confirms badge management
    - Grep for `NotificationProvider` in `app/(tabs)/_layout.tsx` -- confirms integration
  </verify>
  <done>
    NotificationContext manages the full notification lifecycle: foreground in-app toast (not native banner), background tap deep-links to conversation, permission prompting on first Messages tab visit, and app badge count management. Provider integrated in tab layout.
  </done>
</task>

</tasks>

<verification>
1. PushTokenService registers tokens in existing profiles.push_token column (grep confirms Supabase update)
2. Permission is requested on first Messages tab visit, not on app launch (AsyncStorage flag check)
3. Foreground notifications show custom in-app toast, not native banner (shouldShowAlert: false)
4. Tapping a background notification navigates to the correct conversation (router.push with conversationId)
5. App badge count updates on foreground + mark-as-read events
6. Token is only written to database if changed or older than 7 days
7. TypeScript compilation passes
</verification>

<success_criteria>
- Push token registered in profiles.push_token on permission grant
- Permission prompt only fires once (on first Messages tab visit)
- Notification tap navigates to correct conversation via Expo Router
- In-app toast for foreground notifications (not native banner)
- Badge count reflects total unread messages
- Token cleanup on logout (set to null)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-real-time-push-notifications/43-02-SUMMARY.md`
</output>
