---
phase: 30-subscription-management-feature-gating
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - web/app/admin/settings/page.tsx
  - web/app/api/admin/branding/route.ts
autonomous: true

must_haves:
  truths:
    - "Starter-tier org admin visiting settings page sees upgrade prompt instead of branding editor"
    - "Growth/Enterprise org admin visiting settings page sees full branding editor"
    - "Starter-tier org calling PUT /api/admin/branding receives 403 Forbidden"
    - "Growth/Enterprise org calling PUT /api/admin/branding succeeds as before"
  artifacts:
    - path: "web/app/admin/settings/page.tsx"
      provides: "Settings page with TierGate wrapping branding section"
      contains: "TierGate"
    - path: "web/app/api/admin/branding/route.ts"
      provides: "Branding API with requireTier enforcement"
      contains: "requireTier"
  key_links:
    - from: "web/app/admin/settings/page.tsx"
      to: "web/components/billing/tier-gate.tsx"
      via: "TierGate component import"
      pattern: "import.*TierGate.*tier-gate"
    - from: "web/app/api/admin/branding/route.ts"
      to: "web/lib/billing/require-tier.ts"
      via: "requireTier() call"
      pattern: "requireTier\\('white_label'\\)"
---

<objective>
Wire TierGate and requireTier() into the branding feature -- the primary Growth-gated feature that already exists in the codebase. This enforces GATE-02 (white-label branding gated to Growth+), GATE-03 (dual UI+API enforcement), and GATE-04 (contextual upgrade prompts).

Purpose: Demonstrates the complete gating pattern -- UI and API enforced simultaneously from the same FEATURE_GATES source of truth.

Output: Modified admin settings page with TierGate around branding section; modified branding API route with requireTier() enforcement.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-subscription-management-feature-gating/30-RESEARCH.md
@.planning/phases/30-subscription-management-feature-gating/30-01-SUMMARY.md

@web/app/admin/settings/page.tsx
@web/app/api/admin/branding/route.ts
@web/lib/billing/feature-gates.ts
@web/components/billing/tier-gate.tsx
@web/lib/billing/require-tier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap branding section with TierGate on settings page</name>
  <files>web/app/admin/settings/page.tsx</files>
  <action>
Modify `web/app/admin/settings/page.tsx`:

1. Add imports at top:
   - `import { TierGate } from '@/components/billing/tier-gate'`
   - `import { type SubscriptionTier } from '@/lib/billing/feature-gates'`

2. The page already fetches `subscriptionTier` state via `/api/admin/subscription` (line ~153-163). This is available as the `subscriptionTier` state variable (string | null).

3. Find the Branding section (the `<section>` block starting around line 464 with the Palette icon header). Wrap the INNER content of this section (the `<div className="bg-gray-800/50...">` block containing the branding form) with:
   ```tsx
   <TierGate feature="white_label" tier={subscriptionTier as SubscriptionTier | null} upgradeMessage="Upgrade to the Growth plan to customise your portal branding, logo, and colours.">
     {/* existing branding form content */}
   </TierGate>
   ```

4. Keep the section header (h2 with Palette icon + "Branding" text) OUTSIDE the TierGate so the section heading is always visible. Only the form content inside the card is gated.

5. Do NOT change any other sections on the page. Only the branding section content is wrapped.

Important: The `subscriptionTier` state is a `string | null`. Cast it to `SubscriptionTier | null` when passing to TierGate. This is safe because the API returns valid tier values from the DB.
  </action>
  <verify>
Run `pnpm tsc --noEmit` from the web directory. Verify no type errors.
  </verify>
  <done>Branding section on settings page is wrapped in TierGate. Starter-tier orgs see upgrade prompt. Growth+ orgs see full editor. Section heading always visible.</done>
</task>

<task type="auto">
  <name>Task 2: Add requireTier() to branding API route</name>
  <files>web/app/api/admin/branding/route.ts</files>
  <action>
Modify `web/app/api/admin/branding/route.ts`:

1. Add import: `import { requireTier } from '@/lib/billing/require-tier'`

2. In the GET handler, add requireTier check at the top of the try block, AFTER the existing `requireOrgId()` call (which is inside `createClient()` flow):
   ```typescript
   try {
     const supabase = await createClient();
     const orgId = await requireOrgId();

     // Enforce Growth+ tier for branding access
     try {
       await requireTier('white_label');
     } catch (err) {
       if (err instanceof Error && err.message === 'TIER_INSUFFICIENT') {
         return NextResponse.json(
           { error: 'This feature requires the Growth plan or higher' },
           { status: 403 }
         );
       }
       throw err; // Re-throw non-tier errors
     }

     // ... rest of existing GET handler unchanged
   ```

3. In the PUT handler, add the SAME requireTier pattern at the top of the try block, AFTER `requireOrgId()`:
   ```typescript
   try {
     const supabase = await createClient();
     const orgId = await requireOrgId();

     // Enforce Growth+ tier for branding changes
     try {
       await requireTier('white_label');
     } catch (err) {
       if (err instanceof Error && err.message === 'TIER_INSUFFICIENT') {
         return NextResponse.json(
           { error: 'This feature requires the Growth plan or higher' },
           { status: 403 }
         );
       }
       throw err;
     }

     // ... rest of existing PUT handler unchanged
   ```

4. Keep all existing validation, update logic, and error handling unchanged. The requireTier check is purely additive.
  </action>
  <verify>
Run `pnpm tsc --noEmit` from the web directory. Verify no type errors. The branding API route now returns 403 for Starter-tier orgs.
  </verify>
  <done>Both GET and PUT /api/admin/branding enforce Growth+ tier via requireTier('white_label'). Starter orgs get 403. Growth/Enterprise orgs proceed as normal.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes in the web workspace
- Settings page imports TierGate and wraps branding section
- Branding API route calls requireTier('white_label') in both GET and PUT handlers
- Starter org making direct API call to branding endpoint gets 403
- Growth/Enterprise org sees branding form and can save changes
- No changes to any other section on the settings page
</verification>

<success_criteria>
- GATE-02 satisfied: white_label feature gated to Growth/Enterprise at both UI and API
- GATE-03 satisfied: dual enforcement from shared FEATURE_GATES source
- GATE-04 satisfied: Starter org sees contextual "Upgrade to Growth" prompt in branding section
- No regressions to other settings page sections
</success_criteria>

<output>
After completion, create `.planning/phases/30-subscription-management-feature-gating/30-02-SUMMARY.md`
</output>
