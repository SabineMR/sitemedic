---
phase: 30-subscription-management-feature-gating
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/platform/subscriptions/page.tsx
  - web/app/platform/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Platform admin can navigate to Subscriptions page from sidebar"
    - "Subscriptions page shows all org subscriptions with tier, status, and MRR contribution"
    - "Aggregate MRR summary shows total and per-tier breakdown"
    - "MRR is calculated from local database, not Stripe API"
  artifacts:
    - path: "web/app/platform/subscriptions/page.tsx"
      provides: "Platform admin MRR dashboard"
      min_lines: 80
    - path: "web/app/platform/layout.tsx"
      provides: "Updated sidebar with Subscriptions nav item"
      contains: "Subscriptions"
  key_links:
    - from: "web/app/platform/subscriptions/page.tsx"
      to: "supabase.from('organizations')"
      via: "Direct DB query for subscription data"
      pattern: "from\\('organizations'\\)"
    - from: "web/app/platform/layout.tsx"
      to: "/platform/subscriptions"
      via: "Nav link"
      pattern: "href.*platform/subscriptions"
---

<objective>
Create the platform admin MRR dashboard at /platform/subscriptions showing all org subscriptions with a summary MRR card. This satisfies SUB-06.

Purpose: Gives Sabine visibility into subscription revenue without logging into Stripe Dashboard. All data from local DB -- fast, no rate limits, no API key exposure.

Output: New subscriptions page + sidebar nav item
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-subscription-management-feature-gating/30-RESEARCH.md

@web/app/platform/layout.tsx
@web/app/platform/organizations/page.tsx
@web/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create platform admin subscriptions/MRR dashboard</name>
  <files>web/app/platform/subscriptions/page.tsx</files>
  <action>
Create `web/app/platform/subscriptions/page.tsx`:

- 'use client' directive
- Import `createClient` from `@/lib/supabase/client`
- Import icons from lucide-react: `TrendingUp`, `Building2`, `CreditCard`, `AlertTriangle`, `Loader2`, `Search`
- Import `Skeleton` from `@/components/ui/skeleton` for loading state
- Import `useEffect`, `useState` from react

Define types:
```typescript
interface OrgSubscription {
  id: string;
  name: string;
  slug: string | null;
  subscription_tier: string | null;
  subscription_status: string | null;
  stripe_customer_id: string | null;
  created_at: string;
}

interface MrrSummary {
  total: number;
  starter: { count: number; mrr: number };
  growth: { count: number; mrr: number };
  enterprise: { count: number; mrr: number };
  atRisk: number;    // past_due count
  churned: number;   // cancelled count
}
```

Define price constants:
```typescript
const TIER_MONTHLY_PRICE: Record<string, number> = {
  starter: 149,
  growth: 299,
  enterprise: 599,
};
```

Component logic:
1. Fetch all organizations with `supabase.from('organizations').select('id, name, slug, subscription_tier, subscription_status, stripe_customer_id, created_at').order('created_at', { ascending: false })`
2. Calculate MRR summary from the data:
   - Count orgs per tier where subscription_status is 'active' OR null (legacy orgs that are paying)
   - Exclude orgs where subscription_status === 'cancelled' from MRR
   - Include 'past_due' orgs in MRR (still active during dunning)
   - MRR per tier = count * TIER_MONTHLY_PRICE[tier]
   - Total MRR = sum of all tier MRRs
   - atRisk = count where status === 'past_due'
   - churned = count where status === 'cancelled'
3. Add search filter for org name (client-side filtering)

Page layout (follow platform admin styling from organizations page):
1. Header with TrendingUp icon + "Subscriptions" title + "Monthly Recurring Revenue overview" subtitle
2. MRR summary cards row (4 cards):
   - Total MRR: large number formatted as GBP (e.g., "GBP 1,345/mo"), green accent
   - Active Orgs: count of non-cancelled orgs
   - At Risk: count of past_due orgs, yellow accent (or "0" with green if none)
   - Churned: count of cancelled orgs, red accent (or "0" with green if none)
3. Per-tier breakdown row (3 cards):
   - Starter: count + MRR contribution, gray accent
   - Growth: count + MRR contribution, blue accent
   - Enterprise: count + MRR contribution, purple accent
4. Search bar for filtering the table below
5. Organizations table with columns:
   - Organisation Name
   - Tier (use TIER_BADGE_STYLES from organizations page pattern -- starter=gray, growth=blue, enterprise=purple)
   - Status (active=green badge, past_due=yellow badge, cancelled=red badge, null="Legacy" gray badge)
   - MRR Contribution (price or "GBP 0" if cancelled)
   - Joined (formatted date)
6. Show Skeleton loading state while data loads

Styling: Use the purple gradient theme consistent with platform admin pages (from-purple-900 via-purple-900 to-indigo-900 backgrounds, purple-700/50 borders).

Note: Do NOT call Stripe API for any data. Everything comes from the organizations table.

Note on legacy orgs: Orgs with NULL subscription_tier should be counted as 'starter' for MRR purposes. Orgs with NULL subscription_status should be treated as active.
  </action>
  <verify>
Run `pnpm tsc --noEmit` from the web directory. Verify no type errors.
  </verify>
  <done>Platform admin subscriptions page shows all org subscriptions with MRR summary, per-tier breakdown, filterable table. All data from local DB.</done>
</task>

<task type="auto">
  <name>Task 2: Add Subscriptions nav item to platform sidebar</name>
  <files>web/app/platform/layout.tsx</files>
  <action>
Modify `web/app/platform/layout.tsx`:

1. Add `CreditCard` to the lucide-react import (it may already be there; if not, add it).

2. In the `navItems` array (around line 99), add a new item BETWEEN "Organizations" and "Revenue":
   ```typescript
   {
     name: 'Subscriptions',
     href: '/platform/subscriptions',
     icon: <CreditCard className="w-5 h-5" />,
   },
   ```

   The final nav order should be:
   - Dashboard
   - Organizations
   - Subscriptions  <-- NEW
   - Revenue
   - Profit Split
   - Analytics
   - Users
   - Settings

3. No other changes to the layout file.
  </action>
  <verify>
Run `pnpm tsc --noEmit` from the web directory. Verify no type errors.
  </verify>
  <done>Platform admin sidebar has "Subscriptions" nav item between "Organizations" and "Revenue", linking to /platform/subscriptions.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes in the web workspace
- `/platform/subscriptions` page exists and loads
- Sidebar shows "Subscriptions" nav item with CreditCard icon
- MRR calculation uses local DB only (no Stripe API calls)
- Legacy orgs (NULL tier/status) handled correctly
- Cancelled orgs excluded from MRR, shown as churned
- past_due orgs included in MRR but flagged as at-risk
</verification>

<success_criteria>
- SUB-06 satisfied: Platform admin subscriptions dashboard shows all org subscriptions with MRR
- MRR calculated as sum of (count_per_tier * price_per_tier) from organizations table
- Dashboard shows total MRR, per-tier breakdown, at-risk count, churned count
- No Stripe API calls -- all data from local database
- Consistent with platform admin visual design patterns
</success_criteria>

<output>
After completion, create `.planning/phases/30-subscription-management-feature-gating/30-04-SUMMARY.md`
</output>
