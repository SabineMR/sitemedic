---
phase: 30-subscription-management-feature-gating
plan: 05
type: execute
wave: 2
depends_on: ["30-03"]
files_modified:
  - web/lib/supabase/middleware.ts
  - web/app/suspended/page.tsx
autonomous: true

must_haves:
  truths:
    - "Org with cancelled subscription is redirected to /suspended page"
    - "Org with active or past_due subscription can access dashboard normally"
    - "Legacy org with NULL subscription_status can access dashboard normally"
    - "Suspended page shows reactivation path via Stripe Customer Portal"
    - "Suspended page does not cause redirect loop"
    - "Data is preserved -- suspension message explicitly states this"
  artifacts:
    - path: "web/lib/supabase/middleware.ts"
      provides: "Middleware with subscription suspension check"
      contains: "subscription_status"
    - path: "web/app/suspended/page.tsx"
      provides: "Suspension screen with reactivation path"
      contains: "Subscription Inactive"
  key_links:
    - from: "web/lib/supabase/middleware.ts"
      to: "organizations.subscription_status"
      via: "Extended onboarding query"
      pattern: "subscription_status"
    - from: "web/app/suspended/page.tsx"
      to: "/api/billing/portal"
      via: "Reactivation button POST"
      pattern: "api/billing/portal"
---

<objective>
Add subscription suspension flow -- middleware redirects cancelled orgs to /suspended, where they see a clear message with data preservation assurance and a reactivation path via Stripe Customer Portal. This satisfies SUB-07.

Purpose: Graceful degradation when a subscription is cancelled. No data loss, clear path back. The middleware check piggybacks on the existing onboarding query (zero extra DB calls).

Output: Modified middleware with suspension check + new /suspended page
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-subscription-management-feature-gating/30-RESEARCH.md
@.planning/phases/30-subscription-management-feature-gating/30-03-SUMMARY.md

@web/lib/supabase/middleware.ts
@web/app/api/billing/portal/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add suspension check to middleware</name>
  <files>web/lib/supabase/middleware.ts</files>
  <action>
Modify `web/lib/supabase/middleware.ts`:

1. Find the onboarding check block (around line 227-261). It already queries `organizations` for `onboarding_completed`:
   ```typescript
   const { data: orgStatus } = await supabase
     .from('organizations')
     .select('onboarding_completed')
     .eq('id', orgId)
     .single();
   ```

   Extend this SELECT to include `subscription_status`:
   ```typescript
   const { data: orgStatus } = await supabase
     .from('organizations')
     .select('onboarding_completed, subscription_status')
     .eq('id', orgId)
     .single();
   ```

   This is a critical optimization -- ONE query, TWO checks. No extra DB call.

2. After the existing onboarding redirect logic (after the `if (onboardingCompleted && isOnboardingRoute)` block, around line 258), add the suspension check:

   ```typescript
   // Suspension check: redirect cancelled orgs to /suspended
   // Only 'cancelled' triggers suspension (NULL passes, 'past_due' passes for dunning)
   // Legacy orgs (NULL subscription_status) are NOT suspended
   if (orgStatus?.subscription_status === 'cancelled') {
     const isSuspendedRoute = request.nextUrl.pathname.startsWith('/suspended');
     if (!isSuspendedRoute) {
       const url = request.nextUrl.clone();
       url.pathname = '/suspended';
       return NextResponse.redirect(url);
     }
   }
   ```

3. This check must be INSIDE the existing `if (isDashboardRoute || isOnboardingRoute)` block (because that's where the org query runs), but AFTER the onboarding redirect logic.

CRITICAL anti-patterns to avoid:
- Do NOT check `subscription_status !== 'active'` -- that would block legacy orgs with NULL status
- Do NOT add a separate DB query for subscription_status -- extend the existing query
- Do NOT forget to check `!isSuspendedRoute` -- that would cause a redirect loop
- Do NOT add /suspended to the publicRoutes array -- the user needs to be authenticated to see their org info

The final flow order inside the `if (isDashboardRoute || isOnboardingRoute)` block:
1. Query org for onboarding_completed AND subscription_status (single query)
2. Onboarding check (redirect to /onboarding if not completed)
3. Onboarding-completed check (redirect away from /onboarding if completed)
4. Suspension check (redirect to /suspended if cancelled) <-- NEW
  </action>
  <verify>
Run `pnpm tsc --noEmit` from the web directory. Verify no type errors in middleware.
  </verify>
  <done>Middleware redirects cancelled orgs to /suspended. Active, past_due, and NULL status orgs pass through normally. No extra DB query -- extends existing onboarding query. No redirect loop for /suspended route.</done>
</task>

<task type="auto">
  <name>Task 2: Create /suspended page with reactivation path</name>
  <files>web/app/suspended/page.tsx</files>
  <action>
Create `web/app/suspended/page.tsx`:

- 'use client' directive (needs onClick handler for reactivation)
- Import `useState` from react
- Import `AlertTriangle`, `ShieldOff`, `ArrowRight`, `Loader2`, `Mail`, `LogOut` from lucide-react
- Import `createClient` from `@/lib/supabase/client`
- Import `useRouter` from `next/navigation`
- Import `toast` from `sonner`
- Import `useOrg` from `@/contexts/org-context`

Component logic:
1. Get `orgName` from `useOrg()` for displaying the org name
2. State: `reactivating` (boolean, for loading state on reactivation button)
3. Handler `handleReactivate()`:
   - Set reactivating to true
   - POST to `/api/billing/portal`
   - If successful, redirect to `data.url` (Stripe Customer Portal)
   - If 400 (no stripe_customer_id), show toast error: "No billing account found. Please contact support."
   - Finally set reactivating to false
4. Handler `handleLogout()`:
   - Create supabase client
   - Call `supabase.auth.signOut()`
   - Router push to '/login'

Page layout:
- Full-screen centered layout with dark gradient background (from-gray-900 via-gray-900 to-gray-800)
- Main card (max-w-lg mx-auto, bg-gray-800/50, rounded-2xl, border, shadow):
  - ShieldOff icon (large, red-400, centered)
  - Heading: "Subscription Inactive" (text-2xl font-bold text-white)
  - Org name: "{orgName}" (text-gray-400)
  - Description paragraph: "Your subscription has been cancelled. Your data is safe and fully preserved -- nothing has been deleted."
  - Data preservation callout box (bg-green-900/20 border border-green-700/30 rounded-xl p-4):
    - Green check icon + "Your data is safe"
    - "All your bookings, treatment logs, medic records, and reports are preserved and will be available when you reactivate."
  - Reactivation button (full width, purple gradient, ArrowRight icon):
    - Text: "Reactivate Subscription" (or "Opening Billing Portal..." when loading with Loader2 spinner)
    - Calls handleReactivate()
  - Divider line
  - Secondary actions row (flex justify-between):
    - "Contact Support" mailto link (support@sitemedic.co.uk) with Mail icon
    - "Log Out" button with LogOut icon, calls handleLogout()

Styling: Dark theme consistent with admin pages. Red accent for the alert state, green for the data preservation message. Purple for the reactivation CTA.

Important: This page must be accessible to authenticated users whose subscription is cancelled. It is NOT in publicRoutes (user must be logged in). The middleware allows /suspended through its suspension check via the `isSuspendedRoute` guard.
  </action>
  <verify>
Run `pnpm tsc --noEmit` from the web directory. Verify no type errors.
  </verify>
  <done>/suspended page shows "Subscription Inactive" screen with org name, data preservation assurance, Stripe Customer Portal reactivation button, contact support link, and logout option.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes in the web workspace
- Middleware SELECT query includes `subscription_status` alongside `onboarding_completed`
- Only `subscription_status === 'cancelled'` triggers redirect to /suspended
- NULL and 'past_due' statuses pass through (no suspension)
- /suspended page renders without redirect loop
- Reactivation button calls POST /api/billing/portal (from 30-03)
- Data preservation message is clearly visible
- Logout option available on suspended page
</verification>

<success_criteria>
- SUB-07 satisfied: Graceful subscription suspension with data preserved
- Cancelled org sees "Subscription Inactive" screen with reactivation via Stripe Customer Portal
- Active/past_due/NULL orgs are NOT affected (no regressions)
- Zero extra DB queries -- piggybacks on existing onboarding query
- No redirect loop -- /suspended is allowed through for cancelled orgs
- Reactivation path: button -> Stripe Portal -> user resubscribes -> webhook fires -> status updated -> middleware allows through
</success_criteria>

<output>
After completion, create `.planning/phases/30-subscription-management-feature-gating/30-05-SUMMARY.md`
</output>
