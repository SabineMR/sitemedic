---
phase: 30-subscription-management-feature-gating
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/api/billing/portal/route.ts
  - web/app/admin/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can click Manage Billing button and be redirected to Stripe Customer Portal"
    - "Legacy orgs without stripe_customer_id see friendly message instead of broken portal link"
    - "Portal session return_url points back to /admin/settings"
  artifacts:
    - path: "web/app/api/billing/portal/route.ts"
      provides: "POST endpoint creating Stripe Customer Portal session"
      exports: ["POST"]
    - path: "web/app/admin/settings/page.tsx"
      provides: "Billing section with Manage Billing button"
      contains: "Manage Billing"
  key_links:
    - from: "web/app/api/billing/portal/route.ts"
      to: "web/lib/stripe/server.ts"
      via: "stripe SDK import"
      pattern: "import.*stripe.*stripe/server"
    - from: "web/app/api/billing/portal/route.ts"
      to: "stripe.billingPortal.sessions.create"
      via: "Stripe Customer Portal API"
      pattern: "billingPortal\\.sessions\\.create"
    - from: "web/app/admin/settings/page.tsx"
      to: "/api/billing/portal"
      via: "fetch POST on button click"
      pattern: "fetch.*api/billing/portal"
---

<objective>
Create the Stripe Customer Portal integration so org admins can self-manage their subscription -- upgrade plan, update payment method, view invoices, cancel. This satisfies SUB-05.

Purpose: Eliminates manual billing support. One API call creates a Stripe-hosted session. No PCI compliance burden. No custom billing UI.

Output: New portal API route + updated billing section on settings page with "Manage Billing" button.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-subscription-management-feature-gating/30-RESEARCH.md

@web/lib/stripe/server.ts
@web/lib/organizations/org-resolver.ts
@web/lib/supabase/server.ts
@web/app/admin/settings/page.tsx
@web/app/api/admin/subscription/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe Customer Portal API route</name>
  <files>web/app/api/billing/portal/route.ts</files>
  <action>
Create `web/app/api/billing/portal/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { stripe } from '@/lib/stripe/server';
import { requireOrgId } from '@/lib/organizations/org-resolver';
import { createClient } from '@/lib/supabase/server';

export const dynamic = 'force-dynamic';

export async function POST(request: NextRequest) {
  try {
    const orgId = await requireOrgId();
    const supabase = await createClient();

    const { data: org } = await supabase
      .from('organizations')
      .select('stripe_customer_id')
      .eq('id', orgId)
      .single();

    if (!org?.stripe_customer_id) {
      return NextResponse.json(
        { error: 'No billing account found. Please contact support.' },
        { status: 400 }
      );
    }

    const origin =
      request.headers.get('origin') ||
      process.env.NEXT_PUBLIC_SITE_URL ||
      'http://localhost:30500';

    const session = await stripe.billingPortal.sessions.create({
      customer: org.stripe_customer_id,
      return_url: `${origin}/admin/settings`,
    });

    return NextResponse.json({ url: session.url });
  } catch {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
}
```

Key design decisions:
- POST method only (creates a session, side-effect)
- Checks for stripe_customer_id before calling Stripe API (handles legacy orgs)
- return_url set to /admin/settings (where user clicked "Manage Billing")
- Origin from request header with fallback to env var and localhost:30500
- `force-dynamic` to prevent caching
  </action>
  <verify>
Run `pnpm tsc --noEmit` from the web directory. Verify the route file compiles.
  </verify>
  <done>POST /api/billing/portal creates a Stripe Customer Portal session and returns { url } for client-side redirect. Returns 400 for legacy orgs without stripe_customer_id.</done>
</task>

<task type="auto">
  <name>Task 2: Add Manage Billing button to settings page</name>
  <files>web/app/admin/settings/page.tsx</files>
  <action>
Modify the Billing & Subscription section (starting around line 1213) of `web/app/admin/settings/page.tsx`:

1. Add state for portal loading at the top of the component with other state declarations:
   ```typescript
   const [portalLoading, setPortalLoading] = useState(false);
   ```

2. Add a handler function (near the other handler functions):
   ```typescript
   async function handleManageBilling() {
     setPortalLoading(true);
     try {
       const res = await fetch('/api/billing/portal', { method: 'POST' });
       if (!res.ok) {
         const data = await res.json().catch(() => ({ error: 'Failed to open billing portal' }));
         toast.error(data.error ?? 'Failed to open billing portal');
         return;
       }
       const data = await res.json();
       if (data.url) {
         window.location.href = data.url;
       }
     } catch {
       toast.error('Failed to open billing portal');
     } finally {
       setPortalLoading(false);
     }
   }
   ```

3. In the Billing & Subscription section, replace the existing placeholder text at the bottom (the `<p>` with "To upgrade or manage billing, contact support...") with a "Manage Billing" button:

   Replace lines ~1270-1275 (the `<p className="text-xs text-gray-500">To upgrade or manage billing...`) with:
   ```tsx
   {/* Show Manage Billing button only if org has a Stripe customer */}
   <div className="flex items-center justify-between pt-2 border-t border-gray-700/50">
     <p className="text-xs text-gray-500">
       Manage your plan, payment methods, and invoices via Stripe.
     </p>
     <button
       onClick={handleManageBilling}
       disabled={portalLoading || !subscriptionTier}
       className="px-5 py-2.5 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 disabled:opacity-60 disabled:cursor-not-allowed text-white rounded-lg font-medium text-sm transition-all duration-200 hover:scale-105 active:scale-95 flex items-center gap-2"
     >
       {portalLoading ? (
         <>
           <Loader2 className="w-4 h-4 animate-spin" />
           Opening...
         </>
       ) : (
         <>
           <CreditCard className="w-4 h-4" />
           Manage Billing
         </>
       )}
     </button>
   </div>
   ```

4. Keep all existing billing section content (plan display, tier comparison grid). Only replace the "contact support" text with the button.

Note: CreditCard and Loader2 icons are already imported at the top of the file.
  </action>
  <verify>
Run `pnpm tsc --noEmit` from the web directory. Verify no type errors in the modified settings page.
  </verify>
  <done>Billing section has "Manage Billing" button that calls POST /api/billing/portal and redirects to Stripe Customer Portal. Legacy orgs without Stripe customer see error toast.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes in the web workspace
- `web/app/api/billing/portal/route.ts` exists with POST handler
- Settings page billing section has "Manage Billing" button
- Button calls POST /api/billing/portal and redirects to Stripe portal URL
- Legacy orgs (no stripe_customer_id) get a friendly error message, not a crash
</verification>

<success_criteria>
- SUB-05 satisfied: Org admin can access Stripe Customer Portal from billing settings
- Portal session created server-side via Stripe SDK (no API key exposure)
- return_url correctly points back to /admin/settings
- No custom billing management UI built -- Stripe handles everything
</success_criteria>

<output>
After completion, create `.planning/phases/30-subscription-management-feature-gating/30-03-SUMMARY.md`
</output>
