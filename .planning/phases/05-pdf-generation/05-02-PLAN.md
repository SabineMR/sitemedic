---
phase: 05-pdf-generation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - supabase/migrations/015_safety_reports_storage.sql
  - supabase/functions/generate-weekly-report/index.tsx
  - supabase/functions/generate-weekly-report/storage.ts
  - supabase/functions/generate-weekly-report/email.ts
autonomous: true
user_setup:
  - service: resend
    why: "Transactional email delivery for weekly PDF reports"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Create Resend account and verify sending domain"
        location: "https://resend.com/signup -> Domains -> Add Domain -> sitemedic.co.uk"

must_haves:
  truths:
    - "Generated PDF is uploaded to Supabase Storage private bucket"
    - "Signed URL is generated for secure time-limited PDF access (7 days)"
    - "Weekly report metadata is stored in database for tracking"
    - "Site manager receives email with PDF attachment and download link when report is generated"
  artifacts:
    - path: "supabase/migrations/015_safety_reports_storage.sql"
      provides: "Storage bucket for safety reports and weekly_reports tracking table"
      contains: "safety-reports"
    - path: "supabase/functions/generate-weekly-report/storage.ts"
      provides: "PDF upload to Supabase Storage and signed URL generation"
      exports: ["uploadReportPDF", "generateSignedUrl"]
    - path: "supabase/functions/generate-weekly-report/email.ts"
      provides: "Email delivery via Resend API with PDF attachment"
      exports: ["sendReportEmail"]
  key_links:
    - from: "supabase/functions/generate-weekly-report/index.tsx"
      to: "supabase/functions/generate-weekly-report/storage.ts"
      via: "Handler uploads PDF buffer to storage after generation"
      pattern: "uploadReportPDF"
    - from: "supabase/functions/generate-weekly-report/index.tsx"
      to: "supabase/functions/generate-weekly-report/email.ts"
      via: "Handler sends email notification after storage upload"
      pattern: "sendReportEmail"
    - from: "supabase/migrations/015_safety_reports_storage.sql"
      to: "supabase/functions/generate-weekly-report/storage.ts"
      via: "Storage bucket 'safety-reports' created by migration, used by storage.ts"
      pattern: "safety-reports"
---

<objective>
Add PDF storage in Supabase Storage with signed URLs, email delivery via Resend API, and a database table to track generated reports. Update the Edge Function handler to upload PDFs, generate signed URLs, store report metadata, and send email notifications.

Purpose: Completes the delivery pipeline -- PDFs are stored securely (PDF-06), accessible via signed URLs (PDF-05), and automatically emailed to site managers (NOTIF-01). The weekly_reports table provides an audit trail of all generated reports.

Output: Updated Edge Function that generates PDF, uploads to storage, records metadata, and sends email. Database migration for storage bucket and tracking table.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-pdf-generation/05-RESEARCH.md
@.planning/phases/05-pdf-generation/05-01-SUMMARY.md

# Existing storage migration pattern
@supabase/migrations/014_storage_buckets.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage migration, storage utility, and email utility</name>
  <files>
    supabase/migrations/015_safety_reports_storage.sql
    supabase/functions/generate-weekly-report/storage.ts
    supabase/functions/generate-weekly-report/email.ts
  </files>
  <action>
1. `supabase/migrations/015_safety_reports_storage.sql`:
   - Create private storage bucket `safety-reports` for PDF files:
     ```sql
     INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
     VALUES (
       'safety-reports',
       'safety-reports',
       false,
       20971520,  -- 20MB limit (PDFs should be well under this)
       ARRAY['application/pdf']::text[]
     )
     ON CONFLICT (id) DO NOTHING;
     ```
   - RLS policies for safety-reports bucket:
     - Authenticated users can read (SELECT) reports in their org folder
     - Service role can insert (for Edge Function uploads)
     ```sql
     CREATE POLICY "Authenticated users can read safety reports"
       ON storage.objects FOR SELECT
       TO authenticated
       USING (bucket_id = 'safety-reports');

     CREATE POLICY "Service role can upload safety reports"
       ON storage.objects FOR INSERT
       TO service_role
       WITH CHECK (bucket_id = 'safety-reports');
     ```
   - Create `weekly_reports` tracking table:
     ```sql
     CREATE TABLE weekly_reports (
       id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
       org_id UUID NOT NULL REFERENCES organizations(id),
       week_ending DATE NOT NULL,
       storage_path TEXT NOT NULL,           -- Path in safety-reports bucket
       signed_url TEXT,                      -- Time-limited download URL
       signed_url_expires_at TIMESTAMPTZ,    -- When the signed URL expires
       file_size_bytes INTEGER,              -- PDF file size for monitoring
       generation_time_ms INTEGER,           -- Generation time for performance tracking
       trigger_type TEXT CHECK (trigger_type IN ('cron', 'manual')) DEFAULT 'cron',
       email_sent BOOLEAN DEFAULT FALSE,
       email_sent_to TEXT,                   -- Site manager email
       created_at TIMESTAMPTZ DEFAULT NOW(),
       UNIQUE(org_id, week_ending)           -- One report per org per week
     );
     ```
   - Indexes on weekly_reports:
     ```sql
     CREATE INDEX idx_weekly_reports_org_id ON weekly_reports(org_id);
     CREATE INDEX idx_weekly_reports_week_ending ON weekly_reports(week_ending);
     ```
   - RLS policy for weekly_reports: Authenticated users in same org can read
   - Enable RLS on weekly_reports

2. `storage.ts` - PDF upload and signed URL generation:
   - Import `createClient` from `@supabase/supabase-js` (Deno npm specifier)
   - `uploadReportPDF(supabase: SupabaseClient, pdfBuffer: Uint8Array, orgId: string, weekEnding: string): Promise<{ storagePath: string, signedUrl: string, expiresAt: Date }>`
     - Storage path format: `reports/{orgId}/weekly-report-{weekEnding}.pdf`
     - Upload using `supabase.storage.from('safety-reports').upload(storagePath, pdfBuffer, { contentType: 'application/pdf', upsert: true })`
     - Use `upsert: true` so re-generating a report replaces the old one
     - Generate signed URL valid for 7 days (604800 seconds): `supabase.storage.from('safety-reports').createSignedUrl(storagePath, 604800)`
     - Calculate expiration date: `new Date(Date.now() + 604800 * 1000)`
     - Return storagePath, signedUrl, and expiresAt
     - Error handling: throw descriptive error on upload or URL generation failure

   - `saveReportMetadata(supabase: SupabaseClient, metadata: { orgId, weekEnding, storagePath, signedUrl, signedUrlExpiresAt, fileSizeBytes, generationTimeMs, triggerType }): Promise<string>`
     - Upsert into `weekly_reports` table (unique on org_id + week_ending)
     - Return report id

3. `email.ts` - Email delivery via Resend API:
   - `sendReportEmail(params: { resendApiKey: string, to: string, recipientName: string, weekEnding: string, signedUrl: string, pdfBuffer: Uint8Array, complianceStatus: string, treatmentCount: number, nearMissCount: number, projectName: string }): Promise<{ success: boolean, messageId?: string }>`
   - Use Resend API via fetch (no npm package needed):
     ```typescript
     const response = await fetch('https://api.resend.com/emails', {
       method: 'POST',
       headers: {
         'Authorization': `Bearer ${params.resendApiKey}`,
         'Content-Type': 'application/json',
       },
       body: JSON.stringify({
         from: 'SiteMedic Reports <reports@sitemedic.co.uk>',
         to: [params.to],
         subject: `Weekly Safety Report - Week Ending ${params.weekEnding}`,
         html: buildEmailHtml(params),
         attachments: [{
           filename: `weekly-safety-report-${params.weekEnding}.pdf`,
           content: bufferToBase64(params.pdfBuffer),
           content_type: 'application/pdf',
         }],
       }),
     });
     ```
   - `buildEmailHtml(params)`: Professional HTML email template with:
     - SiteMedic header
     - Greeting: "Hello {recipientName},"
     - Summary: "Your weekly safety report for the week ending {weekEnding} is ready."
     - Quick stats: Compliance status, treatment count, near-miss count
     - Download link: "Download the full report" linking to signedUrl (valid 7 days)
     - Footer: "This report was automatically generated by SiteMedic."
   - `bufferToBase64(buffer: Uint8Array): string`: Convert Uint8Array to base64 string for email attachment
   - Handle Resend API errors: Check response.ok, parse error body, return { success: false } with logged error
   - IMPORTANT: If RESEND_API_KEY is not set, log warning and skip email (don't fail the entire generation)
  </action>
  <verify>
- `supabase/migrations/015_safety_reports_storage.sql` creates bucket, RLS policies, and weekly_reports table
- `storage.ts` exports uploadReportPDF and saveReportMetadata
- `email.ts` exports sendReportEmail
- Email template is professional HTML with stats summary and download link
- Resend API key missing gracefully skips email without crashing
  </verify>
  <done>
Storage migration creates safety-reports bucket and weekly_reports tracking table. Storage utility uploads PDFs and generates 7-day signed URLs. Email utility sends professional notification via Resend API with PDF attachment and download link.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Edge Function handler to upload, store metadata, and send email</name>
  <files>
    supabase/functions/generate-weekly-report/index.tsx
  </files>
  <action>
1. Update the handler in `index.tsx` to complete the full pipeline:
   - After generating PDF buffer (existing from Plan 01), add these steps:

   a. **Upload to storage:**
      ```typescript
      const { storagePath, signedUrl, expiresAt } = await uploadReportPDF(
        supabase, pdfBuffer, orgId, weekEnding
      );
      ```

   b. **Save report metadata:**
      ```typescript
      const reportId = await saveReportMetadata(supabase, {
        orgId,
        weekEnding,
        storagePath,
        signedUrl,
        signedUrlExpiresAt: expiresAt,
        fileSizeBytes: pdfBuffer.length,
        generationTimeMs: Date.now() - startTime,
        triggerType: body.trigger || 'manual',
      });
      ```

   c. **Send email notification (if email available):**
      - Fetch site manager email from profiles table (role = 'manager' in org) OR use a configurable recipient
      - For MVP: Look for any profile with role 'manager' in the org, fall back to medic's email
      ```typescript
      const resendApiKey = Deno.env.get('RESEND_API_KEY');
      if (resendApiKey) {
        const { data: manager } = await supabase
          .from('profiles')
          .select('email, full_name')
          .eq('role', 'manager')
          .limit(1)
          .maybeSingle();

        if (manager?.email) {
          await sendReportEmail({
            resendApiKey,
            to: manager.email,
            recipientName: manager.full_name || 'Site Manager',
            weekEnding,
            signedUrl,
            pdfBuffer,
            complianceStatus: reportData.complianceScore.status,
            treatmentCount: reportData.weeklyStats.treatmentCount,
            nearMissCount: reportData.weeklyStats.nearMissCount,
            projectName: reportData.projectName,
          });
        }
      }
      ```

   d. **Update response to return metadata instead of raw PDF:**
      - For `trigger: 'cron'`: Return JSON with success status and report metadata
      - For `trigger: 'manual'` or no trigger: Return the PDF buffer directly (for on-demand download)
      ```typescript
      if (body.trigger === 'cron') {
        return new Response(JSON.stringify({
          success: true,
          reportId,
          weekEnding,
          signedUrl,
          generationTimeMs: Date.now() - startTime,
        }), {
          status: 200,
          headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        });
      } else {
        // Return PDF directly for manual/on-demand requests
        return new Response(pdfBuffer, {
          status: 200,
          headers: {
            ...corsHeaders,
            'Content-Type': 'application/pdf',
            'Content-Disposition': `attachment; filename="weekly-report-${weekEnding}.pdf"`,
          },
        });
      }
      ```

2. **Add GET endpoint for downloading existing reports:**
   - Handle GET requests with `?week_ending=YYYY-MM-DD` query parameter
   - Look up existing report in `weekly_reports` table
   - If found and signed URL not expired, redirect to signed URL
   - If found but signed URL expired, regenerate signed URL and update record
   - If not found, return 404

3. **Improve org_id resolution:**
   - Extract user JWT from Authorization header
   - Get user's org_id from profiles table
   - Pass org_id to all queries and storage operations
   - For service_role (cron trigger): Query all orgs and generate report for each
     - Loop through all organizations
     - Generate one report per org
     - Log results for each
  </action>
  <verify>
- index.tsx handles POST (generate) and GET (download) requests
- POST with trigger=cron: generates PDF, uploads to storage, saves metadata, sends email, returns JSON
- POST with trigger=manual: generates PDF, uploads to storage, saves metadata, sends email, returns PDF buffer
- GET with week_ending: looks up existing report and returns signed URL
- Cron trigger generates reports for all organizations
- Performance logging shows generation time in milliseconds
  </verify>
  <done>
Edge Function handler completes the full pipeline: generate PDF -> upload to storage -> save metadata -> send email -> return response. Supports both cron (automated Friday) and manual (on-demand) triggers. GET endpoint enables downloading existing reports via signed URLs.
  </done>
</task>

</tasks>

<verification>
1. Migration file creates safety-reports bucket and weekly_reports table
2. Storage utility uploads PDF and generates 7-day signed URLs
3. Email utility sends via Resend API with PDF attachment
4. Handler wires all components: generate -> upload -> save -> email -> respond
5. GET endpoint retrieves existing reports
6. Missing RESEND_API_KEY gracefully degrades (no email, PDF still generated and stored)
</verification>

<success_criteria>
- PDF stored in Supabase Storage private bucket (PDF-06)
- Signed URL generated for 7-day secure access (PDF-05, PDF-06)
- Report metadata tracked in weekly_reports table
- Email notification sent with PDF attachment (NOTIF-01, PDF-05)
- Email includes compliance summary and download link
- Generation time logged for performance monitoring (PDF-03)
- Cron trigger generates reports for all organizations
</success_criteria>

<output>
After completion, create `.planning/phases/05-pdf-generation/05-02-SUMMARY.md`
</output>
