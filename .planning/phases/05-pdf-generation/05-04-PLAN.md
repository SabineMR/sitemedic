---
phase: 05-pdf-generation
plan: 04
type: execute
wave: 4
depends_on: ["05-02", "05-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Weekly safety report auto-generates every Friday with treatments, near-misses, certifications, compliance score, open actions"
    - "PDF generation completes in under 10 seconds"
    - "PDF includes company branding (logo placeholder, colors)"
    - "Site manager can download PDF or receive via email"
    - "PDF stored in Supabase Storage with signed URL for secure access"
    - "Site manager receives email notification when weekly PDF is ready"
    - "PDF is audit-ready for HSE inspectors"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete Phase 5 PDF Generation by building the web dashboard, testing on-demand report generation, inspecting the PDF output for professional formatting, and confirming the reports page displays correctly.

Purpose: Human verification ensures the PDF is actually audit-ready for HSE inspectors -- automated builds pass but document formatting, data accuracy, and professional appearance require visual confirmation.

Output: Verified PDF generation pipeline ready for production use.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-pdf-generation/05-01-SUMMARY.md
@.planning/phases/05-pdf-generation/05-02-SUMMARY.md
@.planning/phases/05-pdf-generation/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build verification and Edge Function structure check</name>
  <files></files>
  <action>
1. Run full web dashboard build: `cd web && pnpm build`
2. Fix any TypeScript errors or build failures
3. Verify Edge Function file structure exists:
   - `supabase/functions/generate-weekly-report/index.tsx` (main handler)
   - `supabase/functions/generate-weekly-report/queries.ts` (data fetching)
   - `supabase/functions/generate-weekly-report/storage.ts` (PDF upload)
   - `supabase/functions/generate-weekly-report/email.ts` (Resend delivery)
   - `supabase/functions/generate-weekly-report/components/ReportDocument.tsx` (main PDF)
   - `supabase/functions/generate-weekly-report/components/Header.tsx`
   - `supabase/functions/generate-weekly-report/components/ComplianceSummary.tsx`
   - `supabase/functions/generate-weekly-report/components/TreatmentTable.tsx`
   - `supabase/functions/generate-weekly-report/components/NearMissTable.tsx`
   - `supabase/functions/generate-weekly-report/components/SafetyChecksSection.tsx`
   - `supabase/functions/generate-weekly-report/components/Footer.tsx`
   - `supabase/functions/generate-weekly-report/styles.ts`
   - `supabase/functions/generate-weekly-report/types.ts`
4. Verify migration files exist:
   - `supabase/migrations/015_safety_reports_storage.sql` (bucket + table)
   - `supabase/migrations/016_weekly_report_cron.sql` (pg_cron job)
5. Verify dashboard reports page route exists: `web/app/(dashboard)/reports/page.tsx`
6. Start dev server: `cd web && pnpm dev` (port 30500)
7. Verify all routes accessible:
   - http://localhost:30500/ (overview)
   - http://localhost:30500/reports (new reports page)
   - http://localhost:30500/treatments
   - http://localhost:30500/near-misses
   - http://localhost:30500/workers
  </action>
  <verify>
- `pnpm build` completes without errors
- All 13 Edge Function files exist
- Both migration files exist
- Dev server starts on port 30500
- Reports page route is accessible
  </verify>
  <done>Build passes, all Phase 5 files exist, dev server runs, reports page accessible.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 5 PDF Generation with:
1. Supabase Edge Function (generate-weekly-report) using @react-pdf/renderer
2. Professional PDF document with 6 sections:
   - Header with SiteMedic branding and report metadata
   - Compliance summary with traffic-light indicator and weekly stats
   - Treatment log table (date, worker, injury type, severity, outcome, RIDDOR)
   - Near-miss incidents table (date, category, severity, description, corrective action)
   - Daily safety checks summary (completion rate, daily breakdown)
   - Footer with page numbers and confidentiality notice
3. Supabase Storage private bucket (safety-reports) for PDF storage
4. Signed URLs for secure 7-day download access
5. Resend email delivery with PDF attachment (requires API key setup)
6. pg_cron job for automated Friday 5 PM UTC generation
7. Dashboard Reports page with:
   - Report history list with download links
   - On-demand "Generate Report" button
   - Report metadata (size, generation time, trigger type, email status)
   - 60-second polling for new reports
8. Sidebar navigation updated with "Reports" link
  </what-built>
  <how-to-verify>
1. Open http://localhost:30500 in browser
2. Navigate to "Reports" in sidebar
3. Verify reports page displays:
   - "Weekly Safety Reports" heading
   - "Generate Report" button
   - Empty state message (if no reports generated yet)
4. Review Edge Function code structure:
   - Check `supabase/functions/generate-weekly-report/components/` has all 6 sections
   - Review ReportDocument.tsx composes all sections
   - Review queries.ts fetches from correct tables
5. Review PDF styling:
   - Check styles.ts for professional formatting (navy branding, alternating rows, proper fonts)
   - Verify treatment table has severity color coding
   - Verify RIDDOR column highlights in red
6. Review migration files:
   - 015: safety-reports bucket, weekly_reports table, RLS policies
   - 016: pg_cron job with vault secret references
7. Review email template in email.ts:
   - Professional HTML with stats summary
   - Download link included
   - Graceful handling of missing API key
8. Confirm sidebar shows Reports link with FileText icon
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 5, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All Phase 5 success criteria verified:
1. Weekly auto-generation scheduled every Friday at 5 PM UTC (PDF-01)
2. PDF includes: project name, week ending, medic name, compliance score, treatments, near-misses, certifications, RIDDOR, open actions (PDF-02)
3. PDF generation targets under 10 seconds via optimized queries and limited row counts (PDF-03)
4. PDF includes company branding colors and layout (PDF-04)
5. Site manager can download PDF from reports page or receive via email (PDF-05)
6. PDF stored in Supabase Storage private bucket with signed URLs (PDF-06)
7. PDF uses professional HSE-audit-ready formatting (PDF-07)
8. Email notification sent when report is generated (NOTIF-01)
</verification>

<success_criteria>
- Human has verified all 8 requirements (PDF-01 through PDF-07, NOTIF-01)
- No blocking issues found
- PDF generation pipeline is ready for production deployment
</success_criteria>

<output>
After completion, create `.planning/phases/05-pdf-generation/05-04-SUMMARY.md`
</output>
