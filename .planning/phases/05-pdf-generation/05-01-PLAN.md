---
phase: 05-pdf-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/generate-weekly-report/index.tsx
  - supabase/functions/generate-weekly-report/queries.ts
  - supabase/functions/generate-weekly-report/components/ReportDocument.tsx
  - supabase/functions/generate-weekly-report/components/Header.tsx
  - supabase/functions/generate-weekly-report/components/ComplianceSummary.tsx
  - supabase/functions/generate-weekly-report/components/TreatmentTable.tsx
  - supabase/functions/generate-weekly-report/components/NearMissTable.tsx
  - supabase/functions/generate-weekly-report/components/SafetyChecksSection.tsx
  - supabase/functions/generate-weekly-report/components/Footer.tsx
  - supabase/functions/generate-weekly-report/styles.ts
  - supabase/functions/generate-weekly-report/types.ts
autonomous: true

must_haves:
  truths:
    - "Edge Function generates a PDF buffer from weekly report data"
    - "PDF contains all required sections: project name, week ending date, medic name, compliance score, treatment summary, near-miss summary, daily checks, RIDDOR status"
    - "PDF uses professional HSE-audit-ready formatting with company branding placeholder"
    - "Data queries fetch treatments, near-misses, safety checks, and compliance data for a given week"
  artifacts:
    - path: "supabase/functions/generate-weekly-report/index.tsx"
      provides: "Edge Function handler that generates weekly report PDF"
      min_lines: 30
    - path: "supabase/functions/generate-weekly-report/queries.ts"
      provides: "Supabase queries for weekly report data"
      exports: ["fetchWeeklyReportData"]
    - path: "supabase/functions/generate-weekly-report/components/ReportDocument.tsx"
      provides: "Main React-PDF document component composing all sections"
    - path: "supabase/functions/generate-weekly-report/types.ts"
      provides: "TypeScript types for report data"
  key_links:
    - from: "supabase/functions/generate-weekly-report/index.tsx"
      to: "supabase/functions/generate-weekly-report/queries.ts"
      via: "Handler calls fetchWeeklyReportData to get report data"
      pattern: "fetchWeeklyReportData"
    - from: "supabase/functions/generate-weekly-report/index.tsx"
      to: "supabase/functions/generate-weekly-report/components/ReportDocument.tsx"
      via: "Handler passes data to ReportDocument and renders to PDF stream"
      pattern: "renderToStream.*ReportDocument"
---

<objective>
Create the Supabase Edge Function for weekly safety report PDF generation using @react-pdf/renderer. Build the React-PDF document components with professional HSE-audit-ready formatting and the data query layer that fetches treatments, near-misses, safety checks, and compliance data for a given week.

Purpose: This is the core of Phase 5 -- the PDF document structure and data aggregation that powers both automated Friday generation and on-demand downloads. The PDF must be audit-ready for HSE inspectors, principal contractors, and insurers.

Output: A working Edge Function that accepts a week_ending date and returns a PDF buffer containing the complete weekly safety report.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-pdf-generation/05-RESEARCH.md
@.planning/phases/05-pdf-generation/05-CONTEXT.md
@.planning/phases/04-web-dashboard/04-02-SUMMARY.md

# Database schema reference
@supabase/migrations/00003_health_data_tables.sql
@supabase/migrations/00001_organizations.sql

# Existing compliance logic to mirror
@web/lib/queries/compliance.ts

# Existing Edge Function pattern
@supabase/functions/calculate-pricing/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create types, styles, data queries, and report PDF components</name>
  <files>
    supabase/functions/generate-weekly-report/types.ts
    supabase/functions/generate-weekly-report/styles.ts
    supabase/functions/generate-weekly-report/queries.ts
    supabase/functions/generate-weekly-report/components/Header.tsx
    supabase/functions/generate-weekly-report/components/ComplianceSummary.tsx
    supabase/functions/generate-weekly-report/components/TreatmentTable.tsx
    supabase/functions/generate-weekly-report/components/NearMissTable.tsx
    supabase/functions/generate-weekly-report/components/SafetyChecksSection.tsx
    supabase/functions/generate-weekly-report/components/Footer.tsx
    supabase/functions/generate-weekly-report/components/ReportDocument.tsx
  </files>
  <action>
1. `types.ts` - TypeScript interfaces for report data:
   - `WeeklyReportData`: Top-level data object containing all report sections
     - `projectName: string` (organization name)
     - `weekEnding: string` (formatted date e.g., "14 February 2026")
     - `medicName: string`
     - `generatedAt: string` (ISO timestamp)
     - `complianceScore: { status: 'red' | 'amber' | 'green', dailyCheckDone: boolean, overdueFollowups: number, expiredCerts: number, riddorDeadlines: number }`
     - `treatments: TreatmentRow[]` (date, workerName, injuryType, bodyPart, severity, outcome, isRiddor)
     - `nearMisses: NearMissRow[]` (date, category, severity, description, correctiveAction)
     - `safetyChecks: SafetyCheckRow[]` (date, overallStatus, passCount, failCount, totalItems)
     - `weeklyStats: { treatmentCount: number, nearMissCount: number, workersOnSite: number, dailyChecksCompleted: number, dailyChecksRequired: number }`
   - `TreatmentRow`, `NearMissRow`, `SafetyCheckRow` - Row types for tables

2. `styles.ts` - React-PDF StyleSheet:
   - Professional HSE report styling with Helvetica font family
   - Brand colors: primary #003366 (dark navy), accent #2563EB (blue), backgrounds #F8FAFC
   - Page: A4 portrait, 30pt padding on all sides
   - Header: flex row with logo area (left) and report title/details (right), 2pt navy bottom border
   - Section titles: 14pt bold navy with 1pt bottom border, 8pt bottom margin
   - Tables: 1pt border #CCCCCC, header row with #F0F4F8 background, 10pt font, 6-8pt cell padding
   - Alternating row colors: white and #F8FAFC for readability
   - Footer: absolute positioned bottom, 10pt gray text, centered
   - Compliance traffic light: colored circles (inline View with borderRadius)
   - Severity badges: colored text (green for minor/low, amber for moderate/medium, red for major/high/critical)
   - RIDDOR flag: red bold text "YES" for reportable incidents

3. `queries.ts` - Supabase data fetching:
   - `fetchWeeklyReportData(supabase: SupabaseClient, weekEnding: string): Promise<WeeklyReportData>`
   - Calculate weekStart as 7 days before weekEnding
   - Fetch all data in parallel using Promise.all:
     a. Organization name: `supabase.from('organizations').select('name').single()` (for project name)
     b. Medic profile: `supabase.from('profiles').select('full_name').limit(1).single()` (single medic per org for MVP)
     c. Treatments: `supabase.from('treatments').select('created_at, injury_type, body_part, severity, outcome, is_riddor_reportable, worker_id').gte('created_at', weekStart).lte('created_at', weekEnd).is('deleted_at', null).order('created_at', { ascending: false })`
     d. Worker names: For each unique worker_id from treatments, fetch from workers table (batch lookup)
     e. Near-misses: `supabase.from('near_misses').select('created_at, category, severity, description, corrective_action').gte('created_at', weekStart).lte('created_at', weekEnd).is('deleted_at', null).order('created_at', { ascending: false })`
     f. Safety checks: `supabase.from('safety_checks').select('check_date, overall_status, items').gte('check_date', weekStartDate).lte('check_date', weekEndDate).is('deleted_at', null).order('check_date', { ascending: true })`
     g. Compliance data: Mirror logic from `web/lib/queries/compliance.ts` (dailyCheckDone, overdueFollowups, expiredCerts=0, riddorDeadlines)
   - Map worker_id to worker names (first_name + last_name) in treatment rows
   - Parse safety_checks items JSONB to count pass/fail per check
   - Format dates as UK format "dd MMM yyyy" (e.g., "14 Feb 2026") -- manual formatting, no date-fns in Deno Edge Function
   - Compute weeklyStats from fetched data counts
   - IMPORTANT: Limit treatments and near-misses to 50 rows max per Research Pitfall 2 (performance). If more exist, include count note "...and X more"

4. `components/Header.tsx` - Report header:
   - Logo placeholder: Text "SiteMedic" in 24pt bold navy (actual logo from Supabase Storage will be added in Plan 02 when storage is wired)
   - Report title: "Weekly Safety Report" in 20pt bold navy
   - Subtitle line 1: "Week Ending: {weekEnding}"
   - Subtitle line 2: "Medic: {medicName}"
   - Subtitle line 3: "Project: {projectName}"
   - Subtitle line 4: "Generated: {generatedAt formatted}"
   - 2pt navy bottom border separating header from content

5. `components/ComplianceSummary.tsx` - Compliance score section:
   - Section title: "Compliance Summary"
   - Traffic light indicator: Colored circle (View with borderRadius 50%) - green/amber/red with label
   - Breakdown items as bullet list:
     - "Daily Safety Check: {Completed/Not Completed}" with green check or red X icon (text symbols)
     - "Overdue Follow-ups: {count}" (only if > 0)
     - "Expired Certifications: {count}" (only if > 0, hard-coded 0 for Phase 7)
     - "RIDDOR Deadlines: {count}" (only if > 0)
   - Weekly stats summary: 4-cell grid showing treatment count, near-miss count, workers on site, daily checks completed/required

6. `components/TreatmentTable.tsx` - Treatment log table:
   - Section title: "Treatment Log ({count})"
   - If no treatments: "No treatments recorded this week."
   - Table columns: Date, Worker, Injury Type, Body Part, Severity, Outcome, RIDDOR
   - Header row with light background
   - Alternating row colors
   - Severity column: colored text based on level
   - RIDDOR column: red "YES" or gray "-"
   - If treatments truncated (>50): Note at bottom "Showing first 50 of {total} treatments"
   - Use wrap prop on View rows to handle page breaks properly

7. `components/NearMissTable.tsx` - Near-miss incidents table:
   - Section title: "Near-Miss Incidents ({count})"
   - If no near-misses: "No near-miss incidents recorded this week."
   - Table columns: Date, Category, Severity, Description, Corrective Action
   - Same styling pattern as TreatmentTable
   - Description column: wider (flex: 2) to accommodate longer text, text truncated to 100 chars with "..."
   - Corrective action column: wider (flex: 2), "None recorded" if empty

8. `components/SafetyChecksSection.tsx` - Daily safety checks:
   - Section title: "Daily Safety Checks"
   - Summary line: "{completed}/{required} checks completed this week"
   - Completion rate: percentage with color (green >=80%, amber 50-79%, red <50%)
   - Simple table: Date | Status | Pass | Fail | Items
   - Status column: "Pass" in green, "Fail" in red, "Partial" in amber

9. `components/Footer.tsx` - Page footer:
   - Fixed position at bottom of every page using `fixed` prop
   - Left text: "Generated by SiteMedic"
   - Center text: Page X of Y (using render prop for dynamic page numbers)
   - Right text: "Confidential - {projectName}"
   - 1pt gray top border
   - Gray 9pt text

10. `components/ReportDocument.tsx` - Main document component:
    - Accepts `WeeklyReportData` as props
    - Renders `<Document>` with `<Page size="A4">` containing:
      - `<Header />` (report header with branding)
      - `<ComplianceSummary />` (traffic light + weekly stats)
      - `<TreatmentTable />` (treatment log)
      - `<NearMissTable />` (near-miss incidents)
      - `<SafetyChecksSection />` (daily checks summary)
      - `<Footer />` (page numbers, generation date)
    - Multi-page support: sections that overflow automatically create new pages
    - IMPORTANT: Import from 'npm:@react-pdf/renderer@4.3.2' (Deno npm specifier for Edge Functions)
  </action>
  <verify>
- All files exist in supabase/functions/generate-weekly-report/
- TypeScript types are consistent across queries and components
- Components import from 'npm:@react-pdf/renderer@4.3.2' (Deno npm specifier)
- ReportDocument composes all section components
- queries.ts fetches from correct Supabase tables (treatments, near_misses, safety_checks, organizations, profiles, workers)
  </verify>
  <done>
Complete React-PDF document with 6 sections (header, compliance, treatments, near-misses, safety checks, footer) and data query layer that fetches all weekly report data from Supabase in parallel. Types, styles, and components are self-contained in the Edge Function directory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Edge Function handler that generates PDF buffer</name>
  <files>
    supabase/functions/generate-weekly-report/index.tsx
  </files>
  <action>
1. Create the Edge Function handler (`index.tsx` with .tsx extension for JSX support):
   - Use `Deno.serve()` pattern (current Supabase Edge Function pattern, NOT the deprecated `serve()` from std/http)
   - Accept POST request with JSON body:
     ```typescript
     interface GenerateReportRequest {
       week_ending?: string;  // ISO date string, defaults to current week's Friday
       trigger?: 'cron' | 'manual';  // Source of the request
     }
     ```
   - Authentication: Verify Authorization header contains valid service_role key or user JWT
     - For cron trigger: Service role key (from pg_cron via Vault)
     - For manual trigger: User JWT (from dashboard)
   - Create Supabase client with `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` from env
   - Calculate week_ending: If not provided, calculate the most recent Friday (or today if Friday)
   - Call `fetchWeeklyReportData(supabase, weekEnding)` to get all report data
   - Import React-PDF: `import { renderToBuffer } from 'npm:@react-pdf/renderer@4.3.2'`
   - Render PDF: `const pdfBuffer = await renderToBuffer(<ReportDocument data={reportData} />)`
   - IMPORTANT: Use `renderToBuffer` (returns Uint8Array) instead of `renderToStream` for simpler handling in Deno
   - Return the PDF buffer in response for now (storage upload will be added in Plan 02):
     ```typescript
     return new Response(pdfBuffer, {
       status: 200,
       headers: {
         'Content-Type': 'application/pdf',
         'Content-Disposition': `attachment; filename="weekly-report-${weekEnding}.pdf"`,
       },
     });
     ```
   - Error handling: Wrap in try/catch, return JSON error response with status 500 on failure
   - Add CORS headers for dashboard access:
     ```typescript
     const corsHeaders = {
       'Access-Control-Allow-Origin': '*',
       'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
     };
     ```
   - Handle OPTIONS preflight request
   - Log generation time for performance monitoring: `console.log(\`PDF generated in ${Date.now() - start}ms\`)`
  </action>
  <verify>
- `supabase/functions/generate-weekly-report/index.tsx` exists
- Handler uses `Deno.serve()` pattern
- Imports use Deno npm specifiers (`npm:@react-pdf/renderer@4.3.2`)
- CORS headers are included
- Error handling wraps the generation flow
- Response returns PDF with correct Content-Type header
  </verify>
  <done>
Edge Function handler accepts POST with optional week_ending, fetches report data, generates PDF via @react-pdf/renderer renderToBuffer, and returns the PDF buffer as a downloadable response. Includes CORS, error handling, and performance logging.
  </done>
</task>

</tasks>

<verification>
1. All files exist in `supabase/functions/generate-weekly-report/` directory
2. TypeScript compiles conceptually (no runtime test in Edge Function without deployment)
3. ReportDocument.tsx imports all 6 section components
4. queries.ts uses correct Supabase table names and column names per migration 00003
5. styles.ts defines professional HSE-appropriate formatting
6. index.tsx wires queries -> ReportDocument -> renderToBuffer -> Response
7. All imports use Deno npm specifiers for Edge Function compatibility
</verification>

<success_criteria>
- Edge Function generates PDF buffer from weekly report data (PDF-01)
- PDF includes all required fields per PDF-02: project name, week ending, medic name, compliance score, treatment summary, near-miss summary, certification status, RIDDOR status
- PDF uses professional formatting suitable for HSE auditors (PDF-07)
- Company branding placeholder ready for logo integration (PDF-04)
- Data queries are parallelized for performance (<10 second generation target per PDF-03)
</success_criteria>

<output>
After completion, create `.planning/phases/05-pdf-generation/05-01-SUMMARY.md`
</output>
