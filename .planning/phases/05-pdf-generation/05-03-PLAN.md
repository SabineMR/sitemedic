---
phase: 05-pdf-generation
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - supabase/migrations/016_weekly_report_cron.sql
  - web/app/(dashboard)/reports/page.tsx
  - web/components/dashboard/reports-list.tsx
  - web/lib/queries/reports.ts
autonomous: true

must_haves:
  truths:
    - "pg_cron job runs every Friday at 5 PM UTC to trigger weekly report generation"
    - "Site manager can view a list of generated weekly reports on the dashboard"
    - "Site manager can download any previously generated report via signed URL"
    - "Site manager can trigger on-demand report generation from the dashboard"
  artifacts:
    - path: "supabase/migrations/016_weekly_report_cron.sql"
      provides: "pg_cron scheduled job for weekly Friday report generation"
      contains: "cron.schedule"
    - path: "web/app/(dashboard)/reports/page.tsx"
      provides: "Reports page in dashboard with report list and on-demand generation"
    - path: "web/components/dashboard/reports-list.tsx"
      provides: "Report list component with download links and generate button"
    - path: "web/lib/queries/reports.ts"
      provides: "Data fetching hooks for weekly reports"
      exports: ["fetchReports", "useReports"]
  key_links:
    - from: "web/components/dashboard/reports-list.tsx"
      to: "web/lib/queries/reports.ts"
      via: "Reports list component uses useReports hook for data and polling"
      pattern: "useReports"
    - from: "web/components/dashboard/reports-list.tsx"
      to: "supabase/functions/generate-weekly-report"
      via: "Generate button calls Edge Function via Supabase client"
      pattern: "functions.invoke.*generate-weekly-report"
    - from: "supabase/migrations/016_weekly_report_cron.sql"
      to: "supabase/functions/generate-weekly-report"
      via: "pg_cron invokes Edge Function every Friday at 5 PM UTC"
      pattern: "generate-weekly-report"
---

<objective>
Set up the pg_cron scheduled job for automated Friday report generation and build the dashboard reports page where site managers can view, download, and on-demand generate weekly safety reports.

Purpose: Automated Friday generation fulfills PDF-01 (weekly auto-generation). The dashboard reports page provides the download UI (PDF-05) and on-demand generation capability for ad-hoc needs. Together, these complete the user-facing delivery of PDF reports.

Output: pg_cron migration for Friday scheduling, and a dashboard Reports page with report history, download links, and a generate button.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-pdf-generation/05-RESEARCH.md
@.planning/phases/05-pdf-generation/05-01-SUMMARY.md
@.planning/phases/05-pdf-generation/05-02-SUMMARY.md
@.planning/phases/04-web-dashboard/04-01-SUMMARY.md

# Dashboard layout for adding Reports nav item
@web/app/(dashboard)/layout.tsx

# Existing query patterns
@web/lib/queries/compliance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pg_cron migration for Friday scheduling</name>
  <files>
    supabase/migrations/016_weekly_report_cron.sql
  </files>
  <action>
1. Create migration `016_weekly_report_cron.sql`:
   - Enable pg_cron and pg_net extensions if not already enabled:
     ```sql
     CREATE EXTENSION IF NOT EXISTS pg_cron;
     CREATE EXTENSION IF NOT EXISTS pg_net;
     ```
   - Schedule weekly report generation every Friday at 5 PM UTC (end of UK working day, allows for all Friday data to be captured):
     ```sql
     SELECT cron.schedule(
       'generate-weekly-safety-report',
       '0 17 * * 5',  -- Every Friday at 17:00 UTC
       $$
       SELECT net.http_post(
         url := (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'project_url')
                || '/functions/v1/generate-weekly-report',
         headers := jsonb_build_object(
           'Content-Type', 'application/json',
           'Authorization', 'Bearer ' || (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'service_role_key')
         ),
         body := jsonb_build_object(
           'trigger', 'cron',
           'week_ending', CURRENT_DATE::text
         )
       ) AS request_id;
       $$
     );
     ```
   - Add a comment explaining the job:
     ```sql
     COMMENT ON SCHEMA cron IS 'Weekly safety report generation - every Friday at 5 PM UTC. Invokes generate-weekly-report Edge Function.';
     ```
   - Include helpful monitoring query as comment:
     ```sql
     -- Monitor job execution:
     -- SELECT * FROM cron.job_run_details WHERE job_name = 'generate-weekly-safety-report' ORDER BY start_time DESC LIMIT 10;
     --
     -- Unschedule if needed:
     -- SELECT cron.unschedule('generate-weekly-safety-report');
     ```
   - IMPORTANT: The Vault secrets (project_url, service_role_key) must be configured in Supabase Dashboard. This is a user setup item tracked in Plan 02 frontmatter. The migration creates the job assuming secrets exist.
  </action>
  <verify>
- Migration file exists at `supabase/migrations/016_weekly_report_cron.sql`
- Contains `cron.schedule` with correct cron expression `0 17 * * 5`
- References vault.decrypted_secrets for project_url and service_role_key
- Includes monitoring queries as comments
  </verify>
  <done>
pg_cron job scheduled to run every Friday at 5 PM UTC, invoking the generate-weekly-report Edge Function with trigger=cron. Uses Supabase Vault for secure secret access. Monitoring queries included as comments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build dashboard reports page with download and on-demand generation</name>
  <files>
    web/lib/queries/reports.ts
    web/components/dashboard/reports-list.tsx
    web/app/(dashboard)/reports/page.tsx
    web/app/(dashboard)/layout.tsx
  </files>
  <action>
1. `web/lib/queries/reports.ts` - Data fetching for reports:
   - 'use client' directive (for TanStack Query hooks)
   - Types:
     ```typescript
     export interface WeeklyReport {
       id: string;
       week_ending: string;
       storage_path: string;
       signed_url: string | null;
       signed_url_expires_at: string | null;
       file_size_bytes: number | null;
       generation_time_ms: number | null;
       trigger_type: 'cron' | 'manual';
       email_sent: boolean;
       created_at: string;
     }
     ```
   - `fetchReports(supabase: SupabaseClient): Promise<WeeklyReport[]>`
     - Query weekly_reports table ordered by week_ending DESC, limit 52 (1 year of weekly reports)
     - Return array of WeeklyReport objects
   - `useReports(initialData?: WeeklyReport[])` - TanStack Query hook:
     - queryKey: ['weekly-reports']
     - refetchInterval: 60_000 (60-second polling to pick up newly generated reports)
   - `generateReport(supabase: SupabaseClient, weekEnding?: string): Promise<Blob>`
     - Call Edge Function: `supabase.functions.invoke('generate-weekly-report', { body: { trigger: 'manual', week_ending: weekEnding } })`
     - Return the PDF blob from response
   - `getDownloadUrl(supabase: SupabaseClient, storagePath: string): Promise<string>`
     - If signed URL exists and not expired, return it
     - Otherwise, regenerate: `supabase.storage.from('safety-reports').createSignedUrl(storagePath, 604800)`
     - Return new signed URL

2. `web/components/dashboard/reports-list.tsx` - Reports list component ('use client'):
   - Props: `initialData: WeeklyReport[]`
   - Uses `useReports(initialData)` for data with polling
   - State: `isGenerating: boolean` for loading state during on-demand generation
   - Layout:
     - Header row: "Weekly Safety Reports" title + "Generate Report" button (right-aligned)
     - Generate button: Blue primary button with FileDown icon, disabled while generating, shows spinner
     - On click: Call `generateReport()`, on success trigger a browser download of the returned PDF blob AND refetch the reports list
   - Report list as a Card-based list (not DataTable - simpler for this use case):
     - Each report card shows:
       - Week ending date (formatted UK: "Week Ending 14 Feb 2026")
       - Generated date/time (formatted relative: "Generated 2 days ago" or exact if >7 days)
       - File size (formatted: "1.2 MB")
       - Generation time (formatted: "Generated in 3.4s")
       - Trigger badge: "Auto" (green) for cron, "Manual" (blue) for manual
       - Email status: "Email sent" with check icon or "No email" with dash
       - Download button: Blue outline button with Download icon
         - On click: Get download URL, open in new tab (browser handles PDF download)
         - If signed URL expired, regenerate first
     - Empty state: "No reports generated yet. Click 'Generate Report' to create your first weekly safety report."
   - Use shadcn/ui components: Card, Button, Badge
   - Use Lucide icons: FileDown, Download, Mail, Clock, CheckCircle2

3. `web/app/(dashboard)/reports/page.tsx` - Reports page (server component):
   - Fetch initial reports data server-side using `createClient` from server utils
   - Pass to ReportsList client component
   - Page header: "Reports" / "Weekly safety reports for HSE audits"
   - Import and call `fetchReports(supabase)` for initial data

4. Update `web/app/(dashboard)/layout.tsx`:
   - Add "Reports" navigation item to the sidebar
   - Use FileText icon from Lucide
   - Position after existing nav items (Overview, Treatments, Near-Misses, Workers)
   - Link to `/reports`
   - IMPORTANT: Read the existing layout first to understand the nav structure, then add the Reports item in the correct pattern
  </action>
  <verify>
- `web/lib/queries/reports.ts` exports fetchReports, useReports, generateReport, getDownloadUrl
- `web/components/dashboard/reports-list.tsx` renders report cards with download buttons
- `web/app/(dashboard)/reports/page.tsx` renders the reports page
- Reports nav item appears in sidebar layout
- `cd web && pnpm build` compiles without errors
  </verify>
  <done>
Dashboard reports page displays generated weekly reports with download links, on-demand generation button, and 60-second polling for new reports. Sidebar navigation includes "Reports" link. pg_cron migration schedules automated Friday generation.
  </done>
</task>

</tasks>

<verification>
1. pg_cron migration schedules job for Friday 5 PM UTC
2. Dashboard has "Reports" nav item in sidebar
3. Reports page lists generated reports with metadata
4. Download buttons provide access to PDFs via signed URLs
5. "Generate Report" button triggers on-demand PDF generation
6. `cd web && pnpm build` passes
7. Reports list polls every 60 seconds for new reports
</verification>

<success_criteria>
- Weekly auto-generation scheduled every Friday (PDF-01)
- Site manager can view report history on dashboard
- Site manager can download PDF via signed URL (PDF-05)
- Site manager can generate report on-demand (PDF-05)
- Reports page shows report metadata (size, generation time, trigger type, email status)
- pg_cron uses Vault secrets for secure Edge Function invocation
</success_criteria>

<output>
After completion, create `.planning/phases/05-pdf-generation/05-03-SUMMARY.md`
</output>
