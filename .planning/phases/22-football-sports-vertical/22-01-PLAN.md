---
phase: 22-football-sports-vertical
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - app/treatment/new.tsx
autonomous: true

must_haves:
  truths:
    - "When orgVertical is 'sporting_events', the treatment form shows a Patient Type selector (Player / Spectator) before any vertical-specific fields"
    - "Selecting Player shows: Squad Number (optional), Phase of Play, Contact/Non-Contact, HIA Outcome, FA Severity — and hides all spectator fields"
    - "Selecting Spectator shows: Stand Location, Stand Row/Seat (optional), Referral Outcome, Safeguarding Flag, Safeguarding Notes (conditional), Alcohol Involvement — and hides all player fields"
    - "Attempting to complete treatment when isFootball and footballPatientType === null triggers Alert: 'Please select patient type: Player or Spectator'"
    - "On handleCompleteTreatment, vertical_extra_fields JSON is built from the selected patient type's fields and included in the enqueueSyncItem payload as vertical_extra_fields"
    - "HIA Outcome field is only required when hia_performed is true; if hia_performed is false the hia_outcome value is excluded from the payload"
  artifacts:
    - path: "app/treatment/new.tsx"
      provides: "Football dual-patient-type form section"
      contains: "isFootball"
  key_links:
    - from: "app/treatment/new.tsx"
      to: "enqueueSyncItem payload"
      via: "vertical_extra_fields key in sync object"
      pattern: "vertical_extra_fields"
---

<objective>
Add football-specific dual patient type form to the treatment logging screen. When a medic is on the sporting_events vertical, they must choose Player or Spectator before recording clinical details. Each path shows different fields and writes a distinct JSONB structure to vertical_extra_fields, which the fa-incident-generator uses for PDF routing in Plan 22-03.

Purpose: Satisfies FOOT-01 (patient type selector), FOOT-02 (player fields), FOOT-03 (spectator fields). This is the data-entry foundation that Plans 22-03 and 22-04 depend on.

Output: Modified app/treatment/new.tsx with all football UI, validation, and sync payload wiring.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-football-sports-vertical/22-RESEARCH.md
@app/treatment/new.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add football state variables and patient type selector UI</name>
  <files>app/treatment/new.tsx</files>
  <action>
    Add the following state variables directly after the existing `const [certValidationError, ...]` line (around line 76):

    ```typescript
    // Football (sporting_events) vertical state
    const isFootball = orgVertical === 'sporting_events';
    const [footballPatientType, setFootballPatientType] = useState<'player' | 'spectator' | null>(null);

    // Player-specific field states
    const [squadNumber, setSquadNumber] = useState<string>('');
    const [phaseOfPlay, setPhaseOfPlay] = useState<string>('');
    const [contactType, setContactType] = useState<string>('');
    const [hiaPerformed, setHiaPerformed] = useState<boolean>(false);
    const [hiaOutcome, setHiaOutcome] = useState<string>('');
    const [faSeverity, setFaSeverity] = useState<string>('');

    // Spectator-specific field states
    const [standLocation, setStandLocation] = useState<string>('');
    const [standRowSeat, setStandRowSeat] = useState<string>('');
    const [referralOutcome, setReferralOutcome] = useState<string>('');
    const [safeguardingFlag, setSafeguardingFlag] = useState<boolean>(false);
    const [safeguardingNotes, setSafeguardingNotes] = useState<string>('');
    const [alcoholInvolvement, setAlcoholInvolvement] = useState<boolean>(false);
    ```

    Then, in the JSX return, insert the football patient type selector as the FIRST section inside the ScrollView, immediately before the existing `{/* Section 1: Patient / Worker / Attendee Selection */}` block:

    ```tsx
    {/* Football: Patient Type Selector */}
    {isFootball && (
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Patient Type *</Text>
        <Text style={styles.fieldLabel}>Select who you are treating</Text>
        <View style={styles.patientTypeRow}>
          <Pressable
            style={[
              styles.patientTypeButton,
              footballPatientType === 'player' && styles.patientTypeButtonSelected,
            ]}
            onPress={() => setFootballPatientType('player')}
          >
            <Text style={[
              styles.patientTypeText,
              footballPatientType === 'player' && styles.patientTypeTextSelected,
            ]}>
              Player
            </Text>
          </Pressable>
          <Pressable
            style={[
              styles.patientTypeButton,
              footballPatientType === 'spectator' && styles.patientTypeButtonSelected,
            ]}
            onPress={() => setFootballPatientType('spectator')}
          >
            <Text style={[
              styles.patientTypeText,
              footballPatientType === 'spectator' && styles.patientTypeTextSelected,
            ]}>
              Spectator
            </Text>
          </Pressable>
        </View>
      </View>
    )}
    ```

    Add these styles to the StyleSheet (after the existing `certErrorText` style):

    ```typescript
    patientTypeRow: {
      flexDirection: 'row',
      gap: 12,
      marginTop: 8,
    },
    patientTypeButton: {
      flex: 1,
      borderWidth: 2,
      borderColor: '#D1D5DB',
      borderRadius: 8,
      paddingVertical: 16,
      alignItems: 'center',
      backgroundColor: '#FFFFFF',
    },
    patientTypeButtonSelected: {
      borderColor: '#2563EB',
      backgroundColor: '#EFF6FF',
    },
    patientTypeText: {
      fontSize: 16,
      fontWeight: '600',
      color: '#6B7280',
    },
    patientTypeTextSelected: {
      color: '#2563EB',
    },
    ```
  </action>
  <verify>No TypeScript errors: run `pnpm tsc --noEmit` from project root. Confirm `isFootball` is derived correctly and state variables are declared.</verify>
  <done>State variables declared, patient type selector renders when orgVertical === 'sporting_events', two Pressable buttons toggle footballPatientType between 'player' and 'spectator', selected state is visually distinguished via border/background colour.</done>
</task>

<task type="auto">
  <name>Task 2: Add player fields, spectator fields, validation, and sync payload wiring</name>
  <files>app/treatment/new.tsx</files>
  <action>
    Insert the conditional Player fields section immediately AFTER the existing `{/* Section 1: Patient... */}` block (after the closing `</View>` of that section):

    ```tsx
    {/* Football: Player-specific fields */}
    {isFootball && footballPatientType === 'player' && (
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Player Information</Text>

        <Text style={styles.fieldLabel}>Squad Number (optional)</Text>
        <TextInput
          style={styles.input}
          placeholder="e.g. 9"
          value={squadNumber}
          onChangeText={setSquadNumber}
          keyboardType="numeric"
          maxLength={3}
        />

        <Text style={styles.fieldLabel}>Phase of Play *</Text>
        <View style={styles.chipRow}>
          {(['In play', 'Set piece', 'Warm-up', 'Half-time', 'Training', 'Post-match'] as const).map((phase) => {
            const val = phase.toLowerCase().replace(/[- ]/g, '_').replace(/'/g, '');
            const isSelected = phaseOfPlay === val;
            return (
              <Pressable
                key={val}
                style={[styles.chip, isSelected && styles.chipSelected]}
                onPress={() => setPhaseOfPlay(val)}
              >
                <Text style={[styles.chipText, isSelected && styles.chipTextSelected]}>{phase}</Text>
              </Pressable>
            );
          })}
        </View>

        <Text style={styles.fieldLabel}>Contact Type *</Text>
        <View style={styles.chipRow}>
          {[{ label: 'Contact', val: 'contact' }, { label: 'Non-contact', val: 'non_contact' }].map(({ label, val }) => {
            const isSelected = contactType === val;
            return (
              <Pressable
                key={val}
                style={[styles.chip, isSelected && styles.chipSelected]}
                onPress={() => setContactType(val)}
              >
                <Text style={[styles.chipText, isSelected && styles.chipTextSelected]}>{label}</Text>
              </Pressable>
            );
          })}
        </View>

        <Text style={styles.fieldLabel}>Head Injury Assessment (HIA)</Text>
        <View style={styles.chipRow}>
          <Pressable
            style={[styles.chip, !hiaPerformed && styles.chipSelected]}
            onPress={() => { setHiaPerformed(false); setHiaOutcome(''); }}
          >
            <Text style={[styles.chipText, !hiaPerformed && styles.chipTextSelected]}>No HIA</Text>
          </Pressable>
          <Pressable
            style={[styles.chip, hiaPerformed && styles.chipSelected]}
            onPress={() => setHiaPerformed(true)}
          >
            <Text style={[styles.chipText, hiaPerformed && styles.chipTextSelected]}>HIA Conducted</Text>
          </Pressable>
        </View>

        {hiaPerformed && (
          <>
            <Text style={styles.fieldLabel}>HIA Outcome *</Text>
            <View style={styles.chipRow}>
              {[
                { label: 'Cleared to return', val: 'hia_assessed_returned' },
                { label: 'Concussion confirmed — removed', val: 'hia_concussion_confirmed' },
                { label: 'Referred to hospital', val: 'hia_hospital_referred' },
              ].map(({ label, val }) => {
                const isSelected = hiaOutcome === val;
                return (
                  <Pressable
                    key={val}
                    style={[styles.chip, isSelected && styles.chipSelected]}
                    onPress={() => setHiaOutcome(val)}
                  >
                    <Text style={[styles.chipText, isSelected && styles.chipTextSelected]}>{label}</Text>
                  </Pressable>
                );
              })}
            </View>
          </>
        )}

        <Text style={styles.fieldLabel}>FA Severity Classification *</Text>
        <View style={styles.chipRow}>
          {[
            { label: 'Medical attention only', val: 'medical_attention' },
            { label: 'Minor (1–7 days)', val: 'minor' },
            { label: 'Moderate (8–28 days)', val: 'moderate' },
            { label: 'Severe (29–89 days)', val: 'severe' },
            { label: 'Major (90+ days)', val: 'major' },
          ].map(({ label, val }) => {
            const isSelected = faSeverity === val;
            return (
              <Pressable
                key={val}
                style={[styles.chip, isSelected && styles.chipSelected]}
                onPress={() => setFaSeverity(val)}
              >
                <Text style={[styles.chipText, isSelected && styles.chipTextSelected]}>{label}</Text>
              </Pressable>
            );
          })}
        </View>
      </View>
    )}

    {/* Football: Spectator-specific fields */}
    {isFootball && footballPatientType === 'spectator' && (
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Spectator Information</Text>

        <Text style={styles.fieldLabel}>Stand / Location *</Text>
        <View style={styles.chipRow}>
          {['North Stand', 'South Stand', 'East Stand', 'West Stand', 'Concourse', 'Car Park', 'Other'].map((loc) => {
            const isSelected = standLocation === loc;
            return (
              <Pressable
                key={loc}
                style={[styles.chip, isSelected && styles.chipSelected]}
                onPress={() => setStandLocation(loc)}
              >
                <Text style={[styles.chipText, isSelected && styles.chipTextSelected]}>{loc}</Text>
              </Pressable>
            );
          })}
        </View>

        <Text style={styles.fieldLabel}>Row / Seat (optional)</Text>
        <TextInput
          style={styles.input}
          placeholder="e.g. Row G, Seat 14"
          value={standRowSeat}
          onChangeText={setStandRowSeat}
        />

        <Text style={styles.fieldLabel}>Referral Outcome *</Text>
        <View style={styles.chipRow}>
          {[
            { label: 'Treated on site', val: 'treated_on_site' },
            { label: 'Referred to hospital', val: 'referred_to_hospital' },
            { label: 'Ambulance conveyed', val: 'ambulance_conveyed' },
            { label: 'Self-discharged', val: 'self_discharged' },
          ].map(({ label, val }) => {
            const isSelected = referralOutcome === val;
            return (
              <Pressable
                key={val}
                style={[styles.chip, isSelected && styles.chipSelected]}
                onPress={() => setReferralOutcome(val)}
              >
                <Text style={[styles.chipText, isSelected && styles.chipTextSelected]}>{label}</Text>
              </Pressable>
            );
          })}
        </View>

        <View style={styles.toggleRow}>
          <Text style={styles.fieldLabel}>Safeguarding Concern</Text>
          <Pressable
            style={[styles.toggleButton, safeguardingFlag && styles.toggleButtonOn]}
            onPress={() => { setSafeguardingFlag((v) => !v); if (safeguardingFlag) setSafeguardingNotes(''); }}
          >
            <Text style={styles.toggleText}>{safeguardingFlag ? 'Yes' : 'No'}</Text>
          </Pressable>
        </View>

        {safeguardingFlag && (
          <>
            <Text style={styles.fieldLabel}>Safeguarding Notes</Text>
            <TextInput
              style={styles.textArea}
              placeholder="Describe the safeguarding concern..."
              value={safeguardingNotes}
              onChangeText={setSafeguardingNotes}
              multiline
              numberOfLines={3}
              textAlignVertical="top"
            />
          </>
        )}

        <View style={styles.toggleRow}>
          <Text style={styles.fieldLabel}>Alcohol Involvement</Text>
          <Pressable
            style={[styles.toggleButton, alcoholInvolvement && styles.toggleButtonOn]}
            onPress={() => setAlcoholInvolvement((v) => !v)}
          >
            <Text style={styles.toggleText}>{alcoholInvolvement ? 'Yes' : 'No'}</Text>
          </Pressable>
        </View>
      </View>
    )}
    ```

    Add missing styles for chips and toggles to StyleSheet:

    ```typescript
    input: {
      borderWidth: 1,
      borderColor: '#D1D5DB',
      borderRadius: 8,
      paddingHorizontal: 12,
      paddingVertical: 10,
      fontSize: 16,
      color: '#1F2937',
      backgroundColor: '#FFFFFF',
      marginBottom: 8,
    },
    chipRow: {
      flexDirection: 'row',
      flexWrap: 'wrap',
      gap: 8,
      marginBottom: 12,
    },
    chip: {
      borderWidth: 1,
      borderColor: '#D1D5DB',
      borderRadius: 20,
      paddingHorizontal: 12,
      paddingVertical: 6,
      backgroundColor: '#FFFFFF',
    },
    chipSelected: {
      borderColor: '#2563EB',
      backgroundColor: '#EFF6FF',
    },
    chipText: {
      fontSize: 14,
      color: '#6B7280',
    },
    chipTextSelected: {
      color: '#2563EB',
      fontWeight: '600',
    },
    toggleRow: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: 12,
    },
    toggleButton: {
      borderWidth: 1,
      borderColor: '#D1D5DB',
      borderRadius: 16,
      paddingHorizontal: 16,
      paddingVertical: 6,
      backgroundColor: '#FFFFFF',
    },
    toggleButtonOn: {
      borderColor: '#DC2626',
      backgroundColor: '#FEF2F2',
    },
    toggleText: {
      fontSize: 14,
      fontWeight: '600',
      color: '#374151',
    },
    ```

    In `handleCompleteTreatment`, add football patient type validation IMMEDIATELY after the existing `if (!signatureUri)` guard block (before the `try {` block), at approximately line 301:

    ```typescript
    // Football vertical: patient type required
    if (isFootball && !footballPatientType) {
      Alert.alert('Missing Information', 'Please select patient type: Player or Spectator');
      return;
    }
    // Football player: required fields
    if (isFootball && footballPatientType === 'player') {
      if (!phaseOfPlay) { Alert.alert('Missing Information', 'Please select Phase of Play'); return; }
      if (!contactType) { Alert.alert('Missing Information', 'Please select Contact or Non-contact'); return; }
      if (hiaPerformed && !hiaOutcome) { Alert.alert('Missing Information', 'Please select HIA Outcome'); return; }
      if (!faSeverity) { Alert.alert('Missing Information', 'Please select FA Severity Classification'); return; }
    }
    // Football spectator: required fields
    if (isFootball && footballPatientType === 'spectator') {
      if (!standLocation) { Alert.alert('Missing Information', 'Please select Stand / Location'); return; }
      if (!referralOutcome) { Alert.alert('Missing Information', 'Please select Referral Outcome'); return; }
    }
    ```

    Inside `handleCompleteTreatment`, within the `try { if (treatment) { ... } }` block, build the vertical_extra_fields object and add it to the `treatment.update()` call and the `enqueueSyncItem` payload:

    ```typescript
    // Build vertical_extra_fields for football
    let verticalExtraFields: Record<string, unknown> | null = null;
    if (isFootball && footballPatientType === 'player') {
      verticalExtraFields = {
        patient_type: 'player',
        squad_number: squadNumber || null,
        phase_of_play: phaseOfPlay,
        contact_type: contactType,
        hia_performed: hiaPerformed,
        hia_outcome: hiaPerformed ? hiaOutcome : null,
        fa_severity: faSeverity,
      };
    } else if (isFootball && footballPatientType === 'spectator') {
      verticalExtraFields = {
        patient_type: 'spectator',
        stand_location: standLocation,
        stand_row_seat: standRowSeat || null,
        referral_outcome: referralOutcome,
        safeguarding_flag: safeguardingFlag,
        safeguarding_notes: safeguardingFlag ? safeguardingNotes : null,
        alcohol_involvement: alcoholInvolvement,
      };
    }
    ```

    In `treatment.update((t) => { ... })`, add after the existing `t.lastModifiedAt = Date.now();` line:
    ```typescript
    t.verticalExtraFields = verticalExtraFields ? JSON.stringify(verticalExtraFields) : undefined;
    ```

    In the `enqueueSyncItem` payload object, add after the existing `booking_id` line:
    ```typescript
    vertical_extra_fields: verticalExtraFields ?? null,
    ```
  </action>
  <verify>
    Run `pnpm tsc --noEmit` — zero TypeScript errors.

    Run the following grep to confirm the isFootball guard is positioned BEFORE the try block — the line numbers for `isFootball` validation must be LOWER than the line number for `try {`:
    ```
    grep -n 'isFootball\|try {' app/treatment/new.tsx
    ```
    Assert: all `isFootball` guard lines appear before the first `try {` line in `handleCompleteTreatment`.

    Confirm `vertical_extra_fields` wiring:
    ```
    grep -n "vertical_extra_fields" app/treatment/new.tsx
    ```
    Must return at least 3 matches (build block, treatment.update, enqueueSyncItem payload).
  </verify>
  <done>Player form path: phaseOfPlay, contactType, hiaPerformed/hiaOutcome (conditional), faSeverity captured and written to vertical_extra_fields. Spectator form path: standLocation, standRowSeat, referralOutcome, safeguardingFlag/Notes, alcoholInvolvement captured and written. Validation blocks form completion if required football fields are missing. isFootball guards are provably before the try block (grep confirms line order). Sync payload includes vertical_extra_fields key.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` from repo root exits 0
- `grep -n "isFootball" app/treatment/new.tsx` returns at least 6 matches (declaration, selector, player section, spectator section, validation, payload)
- `grep -n "vertical_extra_fields" app/treatment/new.tsx` returns at least 3 matches (treatment.update, enqueueSyncItem payload, and the build block)
- `grep -n "footballPatientType" app/treatment/new.tsx` returns state declaration, setter calls, and conditional render checks
- `grep -n 'isFootball\|try {' app/treatment/new.tsx` — isFootball guard line numbers are lower than the try { line number in handleCompleteTreatment (confirms guard is outside/before the try block)
</verification>

<success_criteria>
When orgVertical is 'sporting_events': Patient Type selector appears at top of form. Selecting Player shows football player fields; selecting Spectator shows spectator fields. Non-football verticals see no change. Attempting to complete a football treatment without selecting patient type shows an Alert. The isFootball validation guard provably appears before the try block (grep line number check). vertical_extra_fields is included in the sync payload with all required fields per patient type.
</success_criteria>

<output>
After completion, create `.planning/phases/22-football-sports-vertical/22-01-SUMMARY.md`
</output>
