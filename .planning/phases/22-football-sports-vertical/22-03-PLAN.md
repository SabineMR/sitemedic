---
phase: 22-football-sports-vertical
plan: "03"
type: execute
wave: 2
depends_on:
  - "22-01"
  - "22-02"
files_modified:
  - supabase/functions/fa-incident-generator/index.ts
  - supabase/functions/fa-incident-generator/types.ts
  - supabase/functions/fa-incident-generator/FAPlayerDocument.tsx
  - supabase/functions/fa-incident-generator/FASpectatorDocument.tsx
  - supabase/functions/fa-incident-generator/fa-player-mapping.ts
  - supabase/functions/fa-incident-generator/fa-spectator-mapping.ts
  - supabase/migrations/125_fa_incident_storage.sql
autonomous: true

must_haves:
  truths:
    - "Calling fa-incident-generator with a player treatment ID returns HTTP 200 and a signed URL pointing to a PDF named FA-Player-*.pdf in the fa-incident-reports bucket"
    - "Calling fa-incident-generator with a spectator treatment ID returns HTTP 200 and a signed URL pointing to a PDF named SGSA-Spectator-*.pdf in the fa-incident-reports bucket"
    - "Calling fa-incident-generator with a treatment that has no patient_type in vertical_extra_fields returns HTTP 400"
    - "Calling fa-incident-generator with event_vertical other than 'sporting_events' returns HTTP 400"
    - "The fa-incident-reports Supabase Storage bucket exists (created by migration 125)"
  artifacts:
    - path: "supabase/functions/fa-incident-generator/index.ts"
      provides: "Full FA/SGSA PDF routing — no longer a 501 stub"
      contains: "renderToBuffer"
    - path: "supabase/functions/fa-incident-generator/FAPlayerDocument.tsx"
      provides: "FA Match Day Injury Form PDF component"
      exports: ["FAPlayerDocument"]
    - path: "supabase/functions/fa-incident-generator/FASpectatorDocument.tsx"
      provides: "SGSA Medical Incident Report PDF component"
      exports: ["FASpectatorDocument"]
    - path: "supabase/functions/fa-incident-generator/fa-player-mapping.ts"
      provides: "Maps treatment + vertical_extra_fields to FA player PDF data"
      exports: ["mapTreatmentToFAPlayer"]
    - path: "supabase/functions/fa-incident-generator/fa-spectator-mapping.ts"
      provides: "Maps treatment + vertical_extra_fields to SGSA spectator PDF data"
      exports: ["mapTreatmentToSGSASpectator"]
    - path: "supabase/migrations/125_fa_incident_storage.sql"
      provides: "fa-incident-reports storage bucket + RLS policy"
      contains: "fa-incident-reports"
  key_links:
    - from: "supabase/functions/fa-incident-generator/index.ts"
      to: "supabase.storage.from('fa-incident-reports')"
      via: "upload + createSignedUrl calls"
      pattern: "fa-incident-reports"
    - from: "supabase/functions/fa-incident-generator/index.ts"
      to: "FAPlayerDocument or FASpectatorDocument"
      via: "patient_type routing — if/else on extraFields.patient_type"
      pattern: "patient_type"
    - from: "web/lib/pdf/incident-report-dispatcher.ts"
      to: "fa-incident-generator"
      via: "FUNCTION_BY_VERTICAL['sporting_events']"
      pattern: "fa-incident-generator"
---

<objective>
Replace the 501 stub in fa-incident-generator with a full implementation that produces two PDF formats routed by patient_type: FA Match Day Injury Form for players and SGSA Medical Incident Report for spectators. Create the fa-incident-reports storage bucket migration. The incident-report-dispatcher already routes sporting_events here — no dispatcher changes needed.

Purpose: Satisfies FOOT-07. Depends on Plan 22-01 for the vertical_extra_fields field definitions.

Output: 7 files: expanded index.ts, expanded types.ts, two PDF Document components, two field mapping files, and one SQL migration.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-football-sports-vertical/22-RESEARCH.md
@supabase/functions/fa-incident-generator/index.ts
@supabase/functions/fa-incident-generator/types.ts
@supabase/functions/riddor-f2508-generator/index.ts
@supabase/functions/riddor-f2508-generator/F2508Document.tsx
@supabase/functions/riddor-f2508-generator/f2508-mapping.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage migration, expand types, and create mapping files</name>
  <files>
    supabase/migrations/125_fa_incident_storage.sql
    supabase/functions/fa-incident-generator/types.ts
    supabase/functions/fa-incident-generator/fa-player-mapping.ts
    supabase/functions/fa-incident-generator/fa-spectator-mapping.ts
  </files>
  <action>
    Create `supabase/migrations/125_fa_incident_storage.sql`:

    ```sql
    -- Migration 125: FA Incident Reports storage bucket
    -- Phase 22: Football / Sports Vertical
    -- Creates the fa-incident-reports bucket for FA Match Day and SGSA PDF storage.

    -- Create bucket (idempotent)
    INSERT INTO storage.buckets (id, name, public)
    VALUES ('fa-incident-reports', 'fa-incident-reports', false)
    ON CONFLICT (id) DO NOTHING;

    -- RLS: org members can read their own org's reports
    CREATE POLICY "Org members can read fa incident reports"
    ON storage.objects FOR SELECT
    USING (
      bucket_id = 'fa-incident-reports'
      AND auth.role() = 'authenticated'
    );

    -- RLS: service role can insert (Edge Function uses service role key)
    CREATE POLICY "Service role can insert fa incident reports"
    ON storage.objects FOR INSERT
    WITH CHECK (
      bucket_id = 'fa-incident-reports'
    );
    ```

    Replace `supabase/functions/fa-incident-generator/types.ts` with the expanded version:

    ```typescript
    /**
     * FA Incident Generator — Types
     * Phase 22: Football / Sports Vertical
     */

    /** Request body for fa-incident-generator invocations */
    export interface FAIncidentRequest {
      /** Treatment ID (from treatments table) — used as primary lookup key */
      incident_id: string;
      /** Must be 'sporting_events'; validated before fetch */
      event_vertical: 'sporting_events';
    }

    /** Player-specific fields from vertical_extra_fields JSONB */
    export interface FootballPlayerFields {
      patient_type: 'player';
      squad_number?: string | null;
      phase_of_play: string;
      contact_type: 'contact' | 'non_contact';
      hia_performed: boolean;
      hia_outcome?: string | null;
      fa_severity: string;
    }

    /** Spectator-specific fields from vertical_extra_fields JSONB */
    export interface FootballSpectatorFields {
      patient_type: 'spectator';
      stand_location: string;
      stand_row_seat?: string | null;
      referral_outcome: string;
      safeguarding_flag: boolean;
      safeguarding_notes?: string | null;
      alcohol_involvement: boolean;
    }

    export type FootballExtraFields = FootballPlayerFields | FootballSpectatorFields;

    /** Normalised data passed to FA Player PDF Document */
    export interface FAPlayerPDFData {
      referenceNumber: string;
      incidentDate: string;
      clubName: string;
      playerName: string;
      squadNumber?: string;
      injuryType: string;
      bodyPart: string;
      phaseOfPlay: string;
      contactType: string;
      hiaPerformed: boolean;
      hiaOutcome?: string;
      faSeverity: string;
      treatmentGiven: string;
      outcome: string;
      medicName: string;
      generatedAt: string;
    }

    /** Normalised data passed to SGSA Spectator PDF Document */
    export interface SGSASpectatorPDFData {
      referenceNumber: string;
      incidentDate: string;
      venueName: string;
      standLocation: string;
      standRowSeat?: string;
      injuryType: string;
      treatmentGiven: string;
      referralOutcome: string;
      safeguardingFlag: boolean;
      safeguardingNotes?: string;
      alcoholInvolvement: boolean;
      medicName: string;
      generatedAt: string;
    }
    ```

    Create `supabase/functions/fa-incident-generator/fa-player-mapping.ts`:

    ```typescript
    /**
     * Map treatment record + vertical_extra_fields to FA Match Day Injury Form data.
     * Phase 22: Football / Sports Vertical
     */

    import type { FAPlayerPDFData, FootballPlayerFields } from './types.ts';

    const PHASE_OF_PLAY_LABELS: Record<string, string> = {
      in_play:    'In Play',
      set_piece:  'Set Piece',
      warm_up:    'Warm-up',
      half_time:  'Half-time',
      training:   'Training',
      post_match: 'Post-match',
    };

    const CONTACT_LABELS: Record<string, string> = {
      contact:     'Contact',
      non_contact: 'Non-contact',
    };

    const HIA_OUTCOME_LABELS: Record<string, string> = {
      hia_assessed_returned:   'Assessed — Cleared to Return',
      hia_concussion_confirmed:'Concussion Confirmed — Permanently Removed',
      hia_hospital_referred:   'Referred to Hospital',
    };

    const FA_SEVERITY_LABELS: Record<string, string> = {
      medical_attention: 'Medical Attention Only (returned same day)',
      minor:   'Minor (1–7 days absence)',
      moderate:'Moderate (8–28 days absence)',
      severe:  'Severe (29–89 days absence)',
      major:   'Major (90+ days absence)',
    };

    export function mapTreatmentToFAPlayer(
      treatment: Record<string, unknown>,
      extras: FootballPlayerFields,
    ): FAPlayerPDFData {
      const worker = treatment.workers as Record<string, unknown> | null;
      const org = treatment.organizations as Record<string, unknown> | null;
      const treatmentTypes = Array.isArray(treatment.treatment_types) ? treatment.treatment_types : [];

      return {
        referenceNumber: String(treatment.reference_number ?? ''),
        incidentDate: treatment.created_at
          ? new Date(String(treatment.created_at)).toLocaleDateString('en-GB')
          : '',
        clubName: String(org?.company_name ?? 'Unknown Club'),
        playerName: worker
          ? `${worker.first_name ?? ''} ${worker.last_name ?? ''}`.trim()
          : 'Unknown',
        squadNumber: extras.squad_number ?? undefined,
        injuryType: String(treatment.injury_type ?? ''),
        bodyPart: String(treatment.body_part ?? ''),
        phaseOfPlay: PHASE_OF_PLAY_LABELS[extras.phase_of_play] ?? extras.phase_of_play,
        contactType: CONTACT_LABELS[extras.contact_type] ?? extras.contact_type,
        hiaPerformed: extras.hia_performed,
        hiaOutcome: extras.hia_outcome
          ? HIA_OUTCOME_LABELS[extras.hia_outcome] ?? extras.hia_outcome
          : undefined,
        faSeverity: FA_SEVERITY_LABELS[extras.fa_severity] ?? extras.fa_severity,
        treatmentGiven: treatmentTypes.join(', ') || String(treatment.treatment_notes ?? ''),
        outcome: String(treatment.outcome ?? ''),
        medicName: String(treatment.medic_id ?? 'Medic'),
        generatedAt: new Date().toISOString(),
      };
    }
    ```

    Create `supabase/functions/fa-incident-generator/fa-spectator-mapping.ts`:

    ```typescript
    /**
     * Map treatment record + vertical_extra_fields to SGSA Medical Incident Report data.
     * Phase 22: Football / Sports Vertical
     */

    import type { SGSASpectatorPDFData, FootballSpectatorFields } from './types.ts';

    const REFERRAL_LABELS: Record<string, string> = {
      treated_on_site:     'Treated on Site — No Referral',
      referred_to_hospital:'Referred to Hospital',
      ambulance_conveyed:  'Ambulance Conveyed',
      self_discharged:     'Self-Discharged',
    };

    export function mapTreatmentToSGSASpectator(
      treatment: Record<string, unknown>,
      extras: FootballSpectatorFields,
    ): SGSASpectatorPDFData {
      const org = treatment.organizations as Record<string, unknown> | null;
      const treatmentTypes = Array.isArray(treatment.treatment_types) ? treatment.treatment_types : [];

      return {
        referenceNumber: String(treatment.reference_number ?? ''),
        incidentDate: treatment.created_at
          ? new Date(String(treatment.created_at)).toLocaleDateString('en-GB')
          : '',
        venueName: String(org?.company_name ?? 'Unknown Venue'),
        standLocation: extras.stand_location,
        standRowSeat: extras.stand_row_seat ?? undefined,
        injuryType: String(treatment.injury_type ?? ''),
        treatmentGiven: treatmentTypes.join(', ') || String(treatment.treatment_notes ?? ''),
        referralOutcome: REFERRAL_LABELS[extras.referral_outcome] ?? extras.referral_outcome,
        safeguardingFlag: extras.safeguarding_flag,
        safeguardingNotes: extras.safeguarding_notes ?? undefined,
        alcoholInvolvement: extras.alcohol_involvement,
        medicName: String(treatment.medic_id ?? 'Medic'),
        generatedAt: new Date().toISOString(),
      };
    }
    ```
  </action>
  <verify>
    `ls supabase/migrations/125_fa_incident_storage.sql` — file exists.
    `grep -n "fa-incident-reports" supabase/migrations/125_fa_incident_storage.sql` — at least 2 matches (bucket name + policy).
    `grep -n "FAPlayerPDFData\|SGSASpectatorPDFData\|FootballPlayerFields" supabase/functions/fa-incident-generator/types.ts` — all 3 types present.
    `grep -n "mapTreatmentToFAPlayer" supabase/functions/fa-incident-generator/fa-player-mapping.ts` — export present.
    `grep -n "mapTreatmentToSGSASpectator" supabase/functions/fa-incident-generator/fa-spectator-mapping.ts` — export present.
  </verify>
  <done>SQL migration for fa-incident-reports bucket exists. Types.ts has full FAPlayerPDFData, SGSASpectatorPDFData, FootballPlayerFields, FootballSpectatorFields, and FAIncidentRequest interfaces. Mapping files export mapTreatmentToFAPlayer and mapTreatmentToSGSASpectator with label lookups.</done>
</task>

<task type="auto">
  <name>Task 2a: Create FAPlayerDocument.tsx and verify fa-player-mapping import</name>
  <files>
    supabase/functions/fa-incident-generator/FAPlayerDocument.tsx
  </files>
  <action>
    Read `supabase/functions/riddor-f2508-generator/F2508Document.tsx` first to confirm the exact import syntax for `npm:@react-pdf/renderer@4.3.2` and `npm:react@18.3.1` in Deno Edge Functions. Use identical import patterns.

    Create `supabase/functions/fa-incident-generator/FAPlayerDocument.tsx`:

    ```tsx
    /**
     * FA Match Day Injury Form PDF Component
     * Phase 22: Football / Sports Vertical — FOOT-07
     *
     * Renders the FA-aligned match day injury report for player incidents.
     * Field categories are based on FA/FIFA injury surveillance consensus statement data categories.
     */

    import React from 'npm:react@18.3.1';
    import {
      Document,
      Page,
      Text,
      View,
      StyleSheet,
    } from 'npm:@react-pdf/renderer@4.3.2';
    import type { FAPlayerPDFData } from './types.ts';

    const styles = StyleSheet.create({
      page: { padding: 40, fontFamily: 'Helvetica', fontSize: 10, color: '#1F2937' },
      header: { marginBottom: 20, borderBottomWidth: 1, borderBottomColor: '#D1D5DB', paddingBottom: 12 },
      headerTitle: { fontSize: 16, fontWeight: 'bold', color: '#1E3A5F', marginBottom: 4 },
      headerSubtitle: { fontSize: 10, color: '#6B7280' },
      section: { marginBottom: 14 },
      sectionTitle: { fontSize: 11, fontWeight: 'bold', color: '#1E3A5F', marginBottom: 6, borderBottomWidth: 0.5, borderBottomColor: '#E5E7EB', paddingBottom: 3 },
      row: { flexDirection: 'row', marginBottom: 4 },
      label: { width: '40%', color: '#6B7280', fontWeight: 'bold' },
      value: { width: '60%', color: '#1F2937' },
      warningBox: { backgroundColor: '#FEF3C7', border: 1, borderColor: '#F59E0B', padding: 8, marginBottom: 12, borderRadius: 4 },
      warningText: { fontSize: 9, color: '#92400E' },
      footer: { position: 'absolute', bottom: 30, left: 40, right: 40, borderTopWidth: 0.5, borderTopColor: '#D1D5DB', paddingTop: 6 },
      footerText: { fontSize: 8, color: '#9CA3AF', textAlign: 'center' },
    });

    function Row({ label, value }: { label: string; value: string | undefined }) {
      return (
        <View style={styles.row}>
          <Text style={styles.label}>{label}:</Text>
          <Text style={styles.value}>{value || '—'}</Text>
        </View>
      );
    }

    interface Props {
      data: FAPlayerPDFData;
      generatedAt: string;
    }

    export function FAPlayerDocument({ data, generatedAt }: Props) {
      return (
        <Document title={`FA Match Day Injury Report — ${data.referenceNumber}`} author="SiteMedic">
          <Page size="A4" style={styles.page}>
            {/* Header */}
            <View style={styles.header}>
              <Text style={styles.headerTitle}>FA Match Day Injury Report</Text>
              <Text style={styles.headerSubtitle}>
                Reference: {data.referenceNumber} | Date: {data.incidentDate} | Club: {data.clubName}
              </Text>
            </View>

            {/* Player Details */}
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Player Details</Text>
              <Row label="Player Name" value={data.playerName} />
              <Row label="Squad Number" value={data.squadNumber} />
              <Row label="Club" value={data.clubName} />
            </View>

            {/* Injury Classification */}
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Injury Classification</Text>
              <Row label="Injury Type" value={data.injuryType} />
              <Row label="Body Part" value={data.bodyPart} />
              <Row label="Phase of Play" value={data.phaseOfPlay} />
              <Row label="Mechanism" value={data.contactType} />
              <Row label="FA Severity" value={data.faSeverity} />
            </View>

            {/* Head Injury Assessment */}
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Head Injury Assessment (HIA)</Text>
              <Row label="HIA Conducted" value={data.hiaPerformed ? 'Yes' : 'No'} />
              {data.hiaPerformed && <Row label="HIA Outcome" value={data.hiaOutcome} />}
              {data.hiaOutcome?.includes('Concussion') && (
                <View style={styles.warningBox}>
                  <Text style={styles.warningText}>
                    FA Concussion Protocol: Player must not return to play on the same day.
                    Follow-up assessment required before return to training.
                  </Text>
                </View>
              )}
            </View>

            {/* Treatment and Outcome */}
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Treatment and Outcome</Text>
              <Row label="Treatment Given" value={data.treatmentGiven} />
              <Row label="Outcome" value={data.outcome} />
              <Row label="Treating Medic" value={data.medicName} />
            </View>

            {/* Footer */}
            <View style={styles.footer}>
              <Text style={styles.footerText}>
                Generated by SiteMedic | {generatedAt} | FA-aligned match day injury report
              </Text>
              <Text style={styles.footerText}>
                This report is for clinical and FA governance purposes. Retain as part of player medical records.
              </Text>
            </View>
          </Page>
        </Document>
      );
    }
    ```
  </action>
  <verify>
    `ls supabase/functions/fa-incident-generator/FAPlayerDocument.tsx` — file exists.
    `grep -n "export function FAPlayerDocument" supabase/functions/fa-incident-generator/FAPlayerDocument.tsx` — export present.
    `grep -n "FAPlayerPDFData" supabase/functions/fa-incident-generator/FAPlayerDocument.tsx` — type import present.
    `grep -n "npm:@react-pdf/renderer\|npm:react" supabase/functions/fa-incident-generator/FAPlayerDocument.tsx` — Deno npm: import syntax used (not bare imports).
  </verify>
  <done>FAPlayerDocument.tsx exists and exports FAPlayerDocument. Uses Deno npm: import syntax matching F2508Document.tsx pattern. Renders: player details, injury classification, HIA section with concussion warning, treatment and outcome, footer.</done>
</task>

<task type="auto">
  <name>Task 2b: Create FASpectatorDocument.tsx</name>
  <files>
    supabase/functions/fa-incident-generator/FASpectatorDocument.tsx
  </files>
  <action>
    Create `supabase/functions/fa-incident-generator/FASpectatorDocument.tsx`:

    ```tsx
    /**
     * SGSA Medical Incident Report PDF Component
     * Phase 22: Football / Sports Vertical — FOOT-07
     *
     * Renders the SGSA-aligned medical incident report for spectator incidents.
     * Field categories based on SGSA Medical Incident Report Form (February 2024).
     */

    import React from 'npm:react@18.3.1';
    import {
      Document,
      Page,
      Text,
      View,
      StyleSheet,
    } from 'npm:@react-pdf/renderer@4.3.2';
    import type { SGSASpectatorPDFData } from './types.ts';

    const styles = StyleSheet.create({
      page: { padding: 40, fontFamily: 'Helvetica', fontSize: 10, color: '#1F2937' },
      header: { marginBottom: 20, borderBottomWidth: 1, borderBottomColor: '#D1D5DB', paddingBottom: 12 },
      headerTitle: { fontSize: 16, fontWeight: 'bold', color: '#1E3A5F', marginBottom: 4 },
      headerSubtitle: { fontSize: 10, color: '#6B7280' },
      section: { marginBottom: 14 },
      sectionTitle: { fontSize: 11, fontWeight: 'bold', color: '#1E3A5F', marginBottom: 6, borderBottomWidth: 0.5, borderBottomColor: '#E5E7EB', paddingBottom: 3 },
      row: { flexDirection: 'row', marginBottom: 4 },
      label: { width: '40%', color: '#6B7280', fontWeight: 'bold' },
      value: { width: '60%', color: '#1F2937' },
      safeguardingBox: { backgroundColor: '#FEF2F2', border: 1, borderColor: '#DC2626', padding: 8, marginBottom: 8, borderRadius: 4 },
      safeguardingTitle: { fontSize: 10, fontWeight: 'bold', color: '#DC2626', marginBottom: 3 },
      safeguardingText: { fontSize: 9, color: '#7F1D1D' },
      footer: { position: 'absolute', bottom: 30, left: 40, right: 40, borderTopWidth: 0.5, borderTopColor: '#D1D5DB', paddingTop: 6 },
      footerText: { fontSize: 8, color: '#9CA3AF', textAlign: 'center' },
    });

    function Row({ label, value }: { label: string; value: string | undefined }) {
      return (
        <View style={styles.row}>
          <Text style={styles.label}>{label}:</Text>
          <Text style={styles.value}>{value || '—'}</Text>
        </View>
      );
    }

    interface Props {
      data: SGSASpectatorPDFData;
      generatedAt: string;
    }

    export function FASpectatorDocument({ data, generatedAt }: Props) {
      return (
        <Document title={`SGSA Medical Incident Report — ${data.referenceNumber}`} author="SiteMedic">
          <Page size="A4" style={styles.page}>
            {/* Header */}
            <View style={styles.header}>
              <Text style={styles.headerTitle}>SGSA Medical Incident Report</Text>
              <Text style={styles.headerSubtitle}>
                Reference: {data.referenceNumber} | Date: {data.incidentDate} | Venue: {data.venueName}
              </Text>
            </View>

            {/* Location */}
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Incident Location</Text>
              <Row label="Stand / Area" value={data.standLocation} />
              <Row label="Row / Seat" value={data.standRowSeat} />
            </View>

            {/* Clinical Details */}
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Clinical Details</Text>
              <Row label="Injury / Illness" value={data.injuryType} />
              <Row label="Treatment Given" value={data.treatmentGiven} />
              <Row label="Referral Outcome" value={data.referralOutcome} />
              <Row label="Alcohol Factor" value={data.alcoholInvolvement ? 'Yes' : 'No'} />
            </View>

            {/* Safeguarding */}
            {data.safeguardingFlag && (
              <View style={styles.section}>
                <Text style={styles.sectionTitle}>Safeguarding</Text>
                <View style={styles.safeguardingBox}>
                  <Text style={styles.safeguardingTitle}>Safeguarding Concern Identified</Text>
                  <Text style={styles.safeguardingText}>
                    {data.safeguardingNotes || 'See incident record for details.'}
                  </Text>
                  <Text style={styles.safeguardingText}>
                    Refer to designated safeguarding lead. Do not disclose to third parties.
                  </Text>
                </View>
              </View>
            )}

            {/* Medic */}
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Treating Medic</Text>
              <Row label="Medic" value={data.medicName} />
            </View>

            {/* Footer */}
            <View style={styles.footer}>
              <Text style={styles.footerText}>
                Generated by SiteMedic | {generatedAt} | SGSA-aligned Medical Incident Report
              </Text>
              <Text style={styles.footerText}>
                Retain as part of ground medical records. Report to ground Safety Officer if required by venue licence conditions.
              </Text>
            </View>
          </Page>
        </Document>
      );
    }
    ```
  </action>
  <verify>
    `ls supabase/functions/fa-incident-generator/FASpectatorDocument.tsx` — file exists.
    `grep -n "export function FASpectatorDocument" supabase/functions/fa-incident-generator/FASpectatorDocument.tsx` — export present.
    `grep -n "SGSASpectatorPDFData" supabase/functions/fa-incident-generator/FASpectatorDocument.tsx` — type import present.
    `grep -n "npm:@react-pdf/renderer\|npm:react" supabase/functions/fa-incident-generator/FASpectatorDocument.tsx` — Deno npm: import syntax used.
  </verify>
  <done>FASpectatorDocument.tsx exists and exports FASpectatorDocument. Uses Deno npm: import syntax. Renders: location, clinical details, safeguarding warning box (conditional), medic, footer.</done>
</task>

<task type="auto">
  <name>Task 3: Replace the 501 stub in index.ts and wire both Document components</name>
  <files>
    supabase/functions/fa-incident-generator/index.ts
  </files>
  <action>
    Replace the entire contents of `supabase/functions/fa-incident-generator/index.ts` with:

    ```typescript
    /**
     * FA Incident Generator Edge Function
     * Phase 22: Football / Sports Vertical — FOOT-07
     *
     * Generates FA Match Day Injury Form PDF for player incidents
     * or SGSA Medical Incident Report PDF for spectator incidents.
     * Routes by patient_type in vertical_extra_fields JSONB.
     *
     * Replaces the Phase 18 501 stub.
     */

    import { createClient } from 'npm:@supabase/supabase-js@2';
    import { renderToBuffer } from 'npm:@react-pdf/renderer@4.3.2';
    import React from 'npm:react@18.3.1';
    import { FAPlayerDocument } from './FAPlayerDocument.tsx';
    import { FASpectatorDocument } from './FASpectatorDocument.tsx';
    import { mapTreatmentToFAPlayer } from './fa-player-mapping.ts';
    import { mapTreatmentToSGSASpectator } from './fa-spectator-mapping.ts';
    import type { FAIncidentRequest, FootballExtraFields, FootballPlayerFields, FootballSpectatorFields } from './types.ts';

    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    };

    Deno.serve(async (req: Request) => {
      if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders });
      }

      try {
        const body = await req.json() as Partial<FAIncidentRequest>;

        if (!body.incident_id) {
          return new Response(
            JSON.stringify({ error: 'incident_id is required' }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        if (body.event_vertical !== 'sporting_events') {
          return new Response(
            JSON.stringify({
              error: `fa-incident-generator only handles the sporting_events vertical. Got: ${body.event_vertical ?? 'none'}`,
            }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        const supabase = createClient(
          Deno.env.get('SUPABASE_URL')!,
          Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!,
        );

        // Fetch treatment with worker and org joins
        // incident_id IS the treatment ID for football incidents (no riddor_incidents entry)
        const { data: treatment, error: fetchError } = await supabase
          .from('treatments')
          .select(`
            id,
            reference_number,
            injury_type,
            body_part,
            severity,
            mechanism_of_injury,
            treatment_types,
            treatment_notes,
            outcome,
            created_at,
            event_vertical,
            vertical_extra_fields,
            medic_id,
            workers(first_name, last_name, role, company),
            organizations(company_name, site_address)
          `)
          .eq('id', body.incident_id)
          .single();

        if (fetchError || !treatment) {
          return new Response(
            JSON.stringify({ error: 'Treatment not found', detail: fetchError?.message }),
            { status: 404, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        // vertical_extra_fields is returned as a parsed object by Supabase (JSONB column)
        // Do NOT JSON.parse() — it is already a JS object
        const extraFields = treatment.vertical_extra_fields as FootballExtraFields | null;
        const patientType = extraFields?.patient_type;

        if (!patientType) {
          return new Response(
            JSON.stringify({ error: 'vertical_extra_fields.patient_type is required for football incidents' }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        const generatedAt = new Date().toISOString();
        let pdfBuffer: ArrayBuffer;
        let fileName: string;

        if (patientType === 'player') {
          const data = mapTreatmentToFAPlayer(
            treatment as unknown as Record<string, unknown>,
            extraFields as FootballPlayerFields,
          );
          pdfBuffer = await renderToBuffer(
            React.createElement(FAPlayerDocument, { data, generatedAt })
          );
          fileName = `${body.incident_id}/FA-Player-${Date.now()}.pdf`;
        } else {
          const data = mapTreatmentToSGSASpectator(
            treatment as unknown as Record<string, unknown>,
            extraFields as FootballSpectatorFields,
          );
          pdfBuffer = await renderToBuffer(
            React.createElement(FASpectatorDocument, { data, generatedAt })
          );
          fileName = `${body.incident_id}/SGSA-Spectator-${Date.now()}.pdf`;
        }

        // Upload PDF to fa-incident-reports storage bucket
        const { error: uploadError } = await supabase.storage
          .from('fa-incident-reports')
          .upload(fileName, pdfBuffer, {
            contentType: 'application/pdf',
            upsert: false,
          });

        if (uploadError) {
          console.error('FA incident PDF upload error:', uploadError);
          return new Response(
            JSON.stringify({ error: 'PDF upload failed', detail: uploadError.message }),
            { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        // Return 7-day signed URL
        const { data: signedUrlData, error: signedUrlError } = await supabase.storage
          .from('fa-incident-reports')
          .createSignedUrl(fileName, 604800);

        if (signedUrlError || !signedUrlData?.signedUrl) {
          return new Response(
            JSON.stringify({ error: 'Failed to create signed URL', detail: signedUrlError?.message }),
            { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        return new Response(
          JSON.stringify({
            success: true,
            patient_type: patientType,
            signed_url: signedUrlData.signedUrl,
            file_name: fileName,
          }),
          { status: 200, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        );
      } catch (error) {
        console.error('FA incident generator error:', error);
        return new Response(
          JSON.stringify({ error: error instanceof Error ? error.message : String(error) }),
          { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        );
      }
    });
    ```
  </action>
  <verify>
    `grep -n "501\|Not Implemented" supabase/functions/fa-incident-generator/index.ts` — must return ZERO matches (stub is gone).
    `grep -n "renderToBuffer" supabase/functions/fa-incident-generator/index.ts` — must return at least 2 matches.
    `grep -n "FAPlayerDocument\|FASpectatorDocument" supabase/functions/fa-incident-generator/index.ts` — both imports present.
    `grep -n "fa-incident-reports" supabase/functions/fa-incident-generator/index.ts` — appears in upload and createSignedUrl calls.
    `ls supabase/functions/fa-incident-generator/` — shows index.ts, types.ts, FAPlayerDocument.tsx, FASpectatorDocument.tsx, fa-player-mapping.ts, fa-spectator-mapping.ts.
  </verify>
  <done>The 501 stub is replaced with a full implementation. FAPlayerDocument and FASpectatorDocument are imported and used. PDF routing by patient_type is implemented. Upload to fa-incident-reports bucket and signed URL creation are wired. All 6 function files exist.</done>
</task>

</tasks>

<verification>
- `grep -n "501\|Not Implemented" supabase/functions/fa-incident-generator/index.ts` — zero matches
- `ls supabase/functions/fa-incident-generator/` — all 6 files present (index.ts, types.ts, FAPlayerDocument.tsx, FASpectatorDocument.tsx, fa-player-mapping.ts, fa-spectator-mapping.ts)
- `grep -n "fa-incident-reports" supabase/migrations/125_fa_incident_storage.sql` — bucket name present
- `grep -c "patient_type" supabase/functions/fa-incident-generator/index.ts` — at least 3 occurrences (check, branch, and response)
- `grep -n "sporting_events.*fa-incident-generator" web/lib/pdf/incident-report-dispatcher.ts` — must return 1 match (confirms dispatcher wiring was already in place from prior phase and has not been broken)
</verification>

<success_criteria>
fa-incident-generator no longer returns 501. It fetches the treatment, reads patient_type from vertical_extra_fields, routes to FAPlayerDocument or FASpectatorDocument, uploads the PDF to fa-incident-reports bucket, and returns a 7-day signed URL. Missing patient_type or wrong vertical returns 400. Storage bucket migration SQL is ready to apply. incident-report-dispatcher.ts routes sporting_events to fa-incident-generator (pre-existing wiring confirmed by grep).
</success_criteria>

<output>
After completion, create `.planning/phases/22-football-sports-vertical/22-03-SUMMARY.md`
</output>
