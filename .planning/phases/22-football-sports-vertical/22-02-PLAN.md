---
phase: 22-football-sports-vertical
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/riddor-detector/index.ts
autonomous: true

must_haves:
  truths:
    - "A treatment with event_vertical: 'sporting_events' never produces a RIDDOR flag — the detector returns { detected: false } before any RIDDOR logic runs"
    - "The NON_RIDDOR_VERTICALS array in riddor-detector/index.ts contains 'sporting_events'"
    - "The F2508 generator returns HTTP 400 for any request where event_vertical is 'sporting_events'"
    - "A Jest test asserts that calling the RIDDOR detector with vertical 'sporting_events' returns { detected: false }"
  artifacts:
    - path: "supabase/functions/riddor-detector/index.ts"
      provides: "RIDDOR gate with sporting_events in NON_RIDDOR_VERTICALS"
      contains: "sporting_events"
    - path: "supabase/functions/riddor-f2508-generator/index.ts"
      provides: "400 guard for sporting_events vertical"
      contains: "sporting_events"
  key_links:
    - from: "supabase/functions/riddor-detector/index.ts"
      to: "NON_RIDDOR_VERTICALS"
      via: "early return before detectRIDDOR()"
      pattern: "NON_RIDDOR_VERTICALS"
---

<objective>
Verify and harden the RIDDOR gate for the football (sporting_events) vertical. The Phase 18 gate is already in place — this plan reads the actual source files, confirms the gate is correct, adds a comment documenting the FOOT-04 requirement, and writes a test proving a sporting_events treatment never triggers RIDDOR.

Purpose: Satisfies FOOT-04. No new gate logic is needed — Phase 18 built it. This plan locks in the guarantee with a test and explicit documentation so future phases cannot accidentally remove the gate.

Output: Verified riddor-detector/index.ts (gate confirmed, FOOT-04 comment added), new test file proving the gate, and F2508 guard confirmed.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-football-sports-vertical/22-RESEARCH.md
@supabase/functions/riddor-detector/index.ts
@supabase/functions/riddor-f2508-generator/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and document the RIDDOR gate in riddor-detector/index.ts</name>
  <files>supabase/functions/riddor-detector/index.ts</files>
  <action>
    Read the full contents of `supabase/functions/riddor-detector/index.ts`.

    Locate the `NON_RIDDOR_VERTICALS` constant (confirmed at line ~75 from research). Verify that:
    1. `'sporting_events'` is present in the array
    2. The early-return logic fires BEFORE `detectRIDDOR()` is called
    3. The return value is `{ detected: false }` (with a reason string)

    If all three are confirmed: add a comment on the `'sporting_events'` entry in the array:
    ```typescript
    'sporting_events',  // FOOT-04: players are not workers under RIDDOR; spectator incidents are also non-RIDDOR
    ```

    If `'sporting_events'` is NOT present (unlikely per research but verify): add it to the array with the comment above, in the position alongside other non-RIDDOR sports/events verticals.

    Do NOT change any logic, variable names, or other array entries. Comment only.
  </action>
  <verify>
    `grep -n "sporting_events" supabase/functions/riddor-detector/index.ts` — must return at least one match showing it in the NON_RIDDOR_VERTICALS array.
    `grep -n "NON_RIDDOR_VERTICALS" supabase/functions/riddor-detector/index.ts` — must return the array definition and the guard check.
  </verify>
  <done>'sporting_events' is confirmed in NON_RIDDOR_VERTICALS array. FOOT-04 comment is present on the entry. No logic changes were made — this is a read-verify-annotate task.</done>
</task>

<task type="auto">
  <name>Task 2: Write RIDDOR gate test and confirm F2508 guard</name>
  <files>
    supabase/functions/riddor-detector/riddor-detector.test.ts
    supabase/functions/riddor-f2508-generator/index.ts
  </files>
  <action>
    First, read `supabase/functions/riddor-f2508-generator/index.ts`. Locate the guard that returns 400 for non-RIDDOR verticals (confirmed at lines 103–110 from research). Verify it covers `sporting_events`. Add a comment if the guard exists but has no FOOT-04 reference:
    ```typescript
    // FOOT-04: football treatments never reach F2508 generation
    ```
    Do not change logic.

    Then, check whether a test file exists at `supabase/functions/riddor-detector/riddor-detector.test.ts`. If it does NOT exist, create it. If it DOES exist, add the football test case to the existing describe block.

    Create (or add to) the test file:

    ```typescript
    /**
     * RIDDOR Detector — Vertical Gate Tests
     * Covers FOOT-04: sporting_events must never produce RIDDOR flags
     */

    // Note: This is a unit test for the NON_RIDDOR_VERTICALS guard logic.
    // The full detector requires Deno + Supabase; these tests cover the guard array directly.

    import { NON_RIDDOR_VERTICALS } from './index.ts';

    describe('RIDDOR detector vertical gate', () => {
      describe('FOOT-04: Football / sporting_events vertical', () => {
        it('includes sporting_events in NON_RIDDOR_VERTICALS', () => {
          expect(NON_RIDDOR_VERTICALS).toContain('sporting_events');
        });

        it('does NOT include construction in NON_RIDDOR_VERTICALS (regression: construction is RIDDOR-applicable)', () => {
          expect(NON_RIDDOR_VERTICALS).not.toContain('construction');
        });

        it('does NOT include tv_film in NON_RIDDOR_VERTICALS (regression: tv_film is RIDDOR-applicable)', () => {
          expect(NON_RIDDOR_VERTICALS).not.toContain('tv_film');
        });
      });
    });
    ```

    IMPORTANT: For the test to work, `NON_RIDDOR_VERTICALS` must be exported from `index.ts`. Read `supabase/functions/riddor-detector/index.ts` and check if it is exported. If it is declared as `const NON_RIDDOR_VERTICALS = [...]` without `export`, add `export` to the declaration:
    ```typescript
    export const NON_RIDDOR_VERTICALS = [...]
    ```
    This is the only change permitted to `index.ts` beyond the comment in Task 1.

    If the project uses Jest with a Deno-compatible test runner (check `package.json` for the test script and jest config), write the import using the appropriate syntax for the project's test setup. If the project has no existing test file pattern for Deno Edge Functions, write the test as a pure Node/Jest module test that imports only the exported constant (not the full Deno.serve handler).

    Check for the project test runner: `cat package.json | grep -A2 '"test"'` and `ls supabase/functions/*/**.test.*` to see if there is a pattern.
  </action>
  <verify>
    If test runner is Jest: `pnpm test supabase/functions/riddor-detector/riddor-detector.test.ts` — all 3 tests pass.
    If no test runner is configured for Edge Functions: verify the test file is syntactically valid TypeScript by running `pnpm tsc --noEmit` from the project root (the test file import may need adjustment based on actual tsconfig paths).
    `grep -n "sporting_events" supabase/functions/riddor-f2508-generator/index.ts` — shows the guard returning 400 for sporting_events.
  </verify>
  <done>Test file exists with 3 test cases covering sporting_events in NON_RIDDOR_VERTICALS and regression cases for construction and tv_film. NON_RIDDOR_VERTICALS is exported from riddor-detector/index.ts. F2508 generator guard confirmed and annotated with FOOT-04 comment.</done>
</task>

</tasks>

<verification>
- `grep -n "sporting_events" supabase/functions/riddor-detector/index.ts` — at least 1 match in NON_RIDDOR_VERTICALS array
- `grep -n "export.*NON_RIDDOR_VERTICALS" supabase/functions/riddor-detector/index.ts` — export present
- `grep -n "FOOT-04" supabase/functions/riddor-detector/index.ts` — comment present
- `grep -n "sporting_events" supabase/functions/riddor-f2508-generator/index.ts` — at least 1 match in the 400 guard
- Test file at `supabase/functions/riddor-detector/riddor-detector.test.ts` exists and has 3 test cases
</verification>

<success_criteria>
The RIDDOR gate for sporting_events is confirmed present in NON_RIDDOR_VERTICALS. The gate is documented with a FOOT-04 comment. The F2508 guard is annotated. A test file asserts the gate is in place and that construction/tv_film are NOT inadvertently gated. No RIDDOR logic was added or modified — this plan is verification + annotation only.
</success_criteria>

<output>
After completion, create `.planning/phases/22-football-sports-vertical/22-02-SUMMARY.md`
</output>
