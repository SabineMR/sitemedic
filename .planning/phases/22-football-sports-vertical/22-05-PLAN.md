---
phase: 22-football-sports-vertical
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - web/lib/queries/fa-incidents.ts
  - web/components/dashboard/FAIncidentReportCard.tsx
  - web/app/(dashboard)/treatments/[id]/page.tsx
  - web/lib/pdf/incident-report-dispatcher.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "An admin visiting a sporting_events treatment detail page sees an FA / SGSA Match Day Report download card"
    - "Clicking Generate in the card calls fa-incident-generator and opens the generated PDF in a new tab"
    - "The festivals card and the sporting_events card are both rendered on their respective treatment pages; neither appears on the other's page"
    - "The stale comment in incident-report-dispatcher.ts no longer claims fa-incident-generator returns 501"
  artifacts:
    - path: "web/lib/queries/fa-incidents.ts"
      provides: "generateFAIncidentPDF() — calls fa-incident-generator Edge Function"
      exports: ["generateFAIncidentPDF"]
    - path: "web/components/dashboard/FAIncidentReportCard.tsx"
      provides: "FA / SGSA Match Day Report download card component"
      exports: ["FAIncidentReportCard"]
    - path: "web/app/(dashboard)/treatments/[id]/page.tsx"
      provides: "Treatment detail page with FAIncidentReportCard rendered for sporting_events"
      contains: "treatment.event_vertical === 'sporting_events'"
  key_links:
    - from: "web/components/dashboard/FAIncidentReportCard.tsx"
      to: "web/lib/queries/fa-incidents.ts"
      via: "import { generateFAIncidentPDF }"
      pattern: "generateFAIncidentPDF"
    - from: "web/app/(dashboard)/treatments/[id]/page.tsx"
      to: "web/components/dashboard/FAIncidentReportCard.tsx"
      via: "import { FAIncidentReportCard }"
      pattern: "FAIncidentReportCard"
    - from: "web/lib/queries/fa-incidents.ts"
      to: "fa-incident-generator Edge Function"
      via: "fetch to /functions/v1/fa-incident-generator"
      pattern: "fa-incident-generator"
---

<objective>
Close gap: Truth 5 FAILED — admin PDF download UI for sporting_events treatments is missing.

Purpose: Admins need a one-click download card on sporting_events treatment detail pages that calls the fa-incident-generator Edge Function (fully implemented in Phase 22 plans 01-04) and opens the returned signed URL in a new tab. Without this card the Edge Function is unreachable from the web UI.

Output:
- web/lib/queries/fa-incidents.ts (query function, mirrors event-incidents.ts)
- web/components/dashboard/FAIncidentReportCard.tsx (card component, mirrors EventIncidentReportCard.tsx)
- web/app/(dashboard)/treatments/[id]/page.tsx (new conditional block + import)
- web/lib/pdf/incident-report-dispatcher.ts (stale comment removed)
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@web/lib/queries/event-incidents.ts
@web/components/dashboard/EventIncidentReportCard.tsx
@web/app/(dashboard)/treatments/[id]/page.tsx
@web/lib/pdf/incident-report-dispatcher.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fa-incidents query function</name>
  <files>web/lib/queries/fa-incidents.ts</files>
  <action>
Create this file from scratch, mirroring web/lib/queries/event-incidents.ts exactly except:
- JSDoc header: "FA Incident Queries / Phase 22: Football Sports Vertical — Plan 05 / Generates the FA / SGSA Match Day Report PDF via the fa-incident-generator Edge Function."
- Function name: `generateFAIncidentPDF` (not `generateEventIncidentPDF`)
- Edge Function URL path: `/functions/v1/fa-incident-generator` (not `event-incident-report-generator`)
- Request body: `{ incident_id: treatmentId, event_vertical: 'sporting_events' }` (not 'festivals')
- Return type: `Promise<{ success: boolean; patient_type: 'player' | 'spectator'; signed_url: string; file_name: string }>`
- Error message: `'Failed to generate FA / SGSA Match Day Report'`

Full file content:
```typescript
/**
 * FA Incident Queries
 * Phase 22: Football Sports Vertical - Plan 05
 *
 * Generates the FA / SGSA Match Day Report PDF via the
 * fa-incident-generator Edge Function.
 */

import { createClient } from '@/lib/supabase/client';

/**
 * Generate FA / SGSA Match Day Report PDF for a sporting_events treatment
 *
 * Calls the fa-incident-generator Edge Function and returns a signed URL
 * to the generated PDF in Supabase Storage.
 *
 * @param treatmentId - The treatment UUID to generate the report for
 * @returns Object with success flag, patient_type, signed URL, and file name
 */
export async function generateFAIncidentPDF(treatmentId: string): Promise<{
  success: boolean;
  patient_type: 'player' | 'spectator';
  signed_url: string;
  file_name: string;
}> {
  const supabase = createClient();
  const { data: { session } } = await supabase.auth.getSession();

  const response = await fetch(
    `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/fa-incident-generator`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session?.access_token || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`,
      },
      body: JSON.stringify({ incident_id: treatmentId, event_vertical: 'sporting_events' }),
    }
  );

  if (!response.ok) {
    throw new Error('Failed to generate FA / SGSA Match Day Report');
  }

  return response.json();
}
```
  </action>
  <verify>File exists and TypeScript compiles: `cd /Users/sabineresoagli/GitHub/sitemedic/web && pnpm tsc --noEmit 2>&1 | grep fa-incidents`</verify>
  <done>web/lib/queries/fa-incidents.ts exists, exports `generateFAIncidentPDF`, no TypeScript errors for this file</done>
</task>

<task type="auto">
  <name>Task 2: Create FAIncidentReportCard component and wire treatment detail page</name>
  <files>
    web/components/dashboard/FAIncidentReportCard.tsx
    web/app/(dashboard)/treatments/[id]/page.tsx
    web/lib/pdf/incident-report-dispatcher.ts
  </files>
  <action>
**Step A — Create web/components/dashboard/FAIncidentReportCard.tsx**

Mirror EventIncidentReportCard.tsx exactly, with these differences:
- JSDoc comment references Phase 22, Football Sports Vertical
- Import `generateFAIncidentPDF` from `@/lib/queries/fa-incidents`
- Interface: `FAIncidentReportCardProps`
- Export: `FAIncidentReportCard`
- `mutationFn`: calls `generateFAIncidentPDF(treatmentId)`
- `onError` alert: `'Failed to generate FA / SGSA Match Day Report. Please try again.'`
- CardTitle: `FA / SGSA Match Day Report`
- CardDescription: `Pre-filled match day incident report for football medical teams — FA Injury Report for player injuries, SGSA Medical Incident Report for spectator injuries`
- Button label (non-pending): `Generate FA / SGSA Match Day Report`
- Footer note (p.text-xs): `Click to generate a pre-filled match day report. The correct form (FA or SGSA) is selected automatically based on patient type. Review all information before sharing with the club or venue safety officer.`

Full file content:
```tsx
'use client';

/**
 * FAIncidentReportCard
 * Phase 22: Football Sports Vertical - Plan 05
 *
 * FA / SGSA Match Day Report download card for the sporting_events vertical.
 * Shown on the treatment detail page when event_vertical === 'sporting_events'.
 */

import { useMutation } from '@tanstack/react-query';
import { FileText } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { generateFAIncidentPDF } from '@/lib/queries/fa-incidents';

interface FAIncidentReportCardProps {
  treatmentId: string;
}

export function FAIncidentReportCard({ treatmentId }: FAIncidentReportCardProps) {
  const generateMutation = useMutation({
    mutationFn: () => generateFAIncidentPDF(treatmentId),
    onSuccess: (data) => {
      if (data.signed_url) {
        window.open(data.signed_url, '_blank');
      }
    },
    onError: () => {
      alert('Failed to generate FA / SGSA Match Day Report. Please try again.');
    },
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle>FA / SGSA Match Day Report</CardTitle>
        <CardDescription>
          Pre-filled match day incident report for football medical teams &mdash; FA Injury Report for player injuries, SGSA Medical Incident Report for spectator injuries
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="flex items-center gap-4">
          <Button
            onClick={() => generateMutation.mutate()}
            disabled={generateMutation.isPending}
          >
            {generateMutation.isPending ? (
              <>Generating PDF...</>
            ) : (
              <>
                <FileText className="mr-2 h-4 w-4" />
                Generate FA / SGSA Match Day Report
              </>
            )}
          </Button>
        </div>
        <p className="text-xs text-muted-foreground mt-4">
          Click to generate a pre-filled match day report. The correct form (FA or SGSA) is selected automatically based on patient type.
          Review all information before sharing with the club or venue safety officer.
        </p>
      </CardContent>
    </Card>
  );
}
```

**Step B — Update web/app/(dashboard)/treatments/[id]/page.tsx**

1. Add import on line 19 (after the existing EventIncidentReportCard import on line 18):
```tsx
import { FAIncidentReportCard } from '@/components/dashboard/FAIncidentReportCard';
```

2. After the existing festivals block at lines 227-230:
```tsx
      {/* Purple Guide — Event Incident Report (festivals only) */}
      {treatment.event_vertical === 'festivals' && (
        <EventIncidentReportCard treatmentId={treatment.id} />
      )}
```
Add immediately after (before the `{/* Photos */}` comment at line 232):
```tsx
      {/* FA / SGSA Match Day Report (sporting_events only) */}
      {treatment.event_vertical === 'sporting_events' && (
        <FAIncidentReportCard treatmentId={treatment.id} />
      )}
```

**Step C — Fix stale comment in web/lib/pdf/incident-report-dispatcher.ts**

Line 15 currently reads:
```
 *   → fa-incident-generator (Phase 22+, currently returns 501)
```
Change it to:
```
 *   → fa-incident-generator (Phase 22, fully implemented)
```

Also update the jsdoc on the `generateIncidentReportPDF` function (lines 42-46). Replace:
```
 * Non-RIDDOR verticals currently return a 501 (Phase 19+).
```
with:
```
 * Event verticals call event-incident-report-generator (Phase 20).
 * Sporting events vertical calls fa-incident-generator (Phase 22).
```
  </action>
  <verify>
1. TypeScript build passes: `cd /Users/sabineresoagli/GitHub/sitemedic/web && pnpm tsc --noEmit 2>&1 | head -20`
2. FAIncidentReportCard file exists: `ls /Users/sabineresoagli/GitHub/sitemedic/web/components/dashboard/FAIncidentReportCard.tsx`
3. Treatment page contains sporting_events branch: `grep -n "sporting_events" /Users/sabineresoagli/GitHub/sitemedic/web/app/\(dashboard\)/treatments/\[id\]/page.tsx`
4. Stale "501" comment gone: `grep -n "501" /Users/sabineresoagli/GitHub/sitemedic/web/lib/pdf/incident-report-dispatcher.ts`
  </verify>
  <done>
- FAIncidentReportCard.tsx exists and exports FAIncidentReportCard
- treatments/[id]/page.tsx imports FAIncidentReportCard and renders it when event_vertical === 'sporting_events'
- incident-report-dispatcher.ts no longer contains "currently returns 501" for fa-incident-generator
- `pnpm tsc --noEmit` exits 0
  </done>
</task>

</tasks>

<verification>
Run the TypeScript compiler across the entire web package:
```bash
cd /Users/sabineresoagli/GitHub/sitemedic/web && pnpm tsc --noEmit
```

Spot-check the wiring:
```bash
grep -n "FAIncidentReportCard\|sporting_events" /Users/sabineresoagli/GitHub/sitemedic/web/app/\(dashboard\)/treatments/\[id\]/page.tsx
grep -n "fa-incident-generator" /Users/sabineresoagli/GitHub/sitemedic/web/lib/queries/fa-incidents.ts
grep -n "sporting_events" /Users/sabineresoagli/GitHub/sitemedic/web/lib/queries/fa-incidents.ts
grep -c "501" /Users/sabineresoagli/GitHub/sitemedic/web/lib/pdf/incident-report-dispatcher.ts
```

Expected: `grep -c "501"` returns `0`.
</verification>

<success_criteria>
- `web/lib/queries/fa-incidents.ts` exists and exports `generateFAIncidentPDF`, which POSTs to `fa-incident-generator` with `event_vertical: 'sporting_events'`
- `web/components/dashboard/FAIncidentReportCard.tsx` exists and exports `FAIncidentReportCard`, consuming `generateFAIncidentPDF`
- `web/app/(dashboard)/treatments/[id]/page.tsx` imports `FAIncidentReportCard` and renders it inside `{treatment.event_vertical === 'sporting_events' && ...}`
- `web/lib/pdf/incident-report-dispatcher.ts` no longer contains "currently returns 501" for fa-incident-generator
- `pnpm tsc --noEmit` passes with 0 errors
- Gap Truth 5 satisfied: an admin visiting a sporting_events treatment sees the FA / SGSA Match Day Report card and can click to generate and open the PDF
</success_criteria>

<output>
After completion, create `.planning/phases/22-football-sports-vertical/22-05-SUMMARY.md` following the summary template.
</output>
