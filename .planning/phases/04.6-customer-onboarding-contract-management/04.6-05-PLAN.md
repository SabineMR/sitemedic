---
phase: 04.6-customer-onboarding-contract-management
plan: 05
type: execute
wave: 3
depends_on: ["04.6-03", "04.6-04"]
files_modified:
  - web/app/api/contracts/send/route.ts
  - web/app/api/contracts/webhooks/route.ts
  - web/components/contracts/send-contract-dialog.tsx
  - supabase/functions/send-contract-email/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can send service agreement via portal during phone call (enter email, click send, get shareable link)"
    - "Client receives email with link to view and sign agreement"
    - "Agreement shows signature status updates in real-time (Sent, Viewed, Signed)"
  artifacts:
    - path: "web/app/api/contracts/send/route.ts"
      provides: "API endpoint to send contract to client via email"
      exports: ["POST"]
    - path: "web/components/contracts/send-contract-dialog.tsx"
      provides: "Dialog for entering client email and sending contract"
      contains: "SendContractDialog"
    - path: "supabase/functions/send-contract-email/index.ts"
      provides: "Edge Function for sending contract email via Resend"
      contains: "Resend"
  key_links:
    - from: "web/app/api/contracts/send/route.ts"
      to: "supabase/functions/send-contract-email"
      via: "calls Edge Function to send email"
      pattern: "send-contract-email"
    - from: "web/app/api/contracts/webhooks/route.ts"
      to: "contracts table"
      via: "updates contract status on email events"
      pattern: "email.opened.*viewed"
---

<objective>
Create the contract sending workflow with email delivery via Resend, shareable link generation, and email tracking via webhooks.

Purpose: During a phone call, the admin reviews the draft contract, clicks "Send", enters the client's email (pre-filled from booking data), and the client receives a professional email with a link to view and sign the agreement. Resend webhooks track when the email is opened (updating status to "viewed"). The admin also gets a copyable shareable link for immediate use during the phone call.

Output: Send API route, Resend email Edge Function, send dialog component, webhook handler for email tracking.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@web/lib/contracts/types.ts
@web/lib/contracts/workflow.ts
@supabase/functions/generate-weekly-report/index.tsx
@.planning/phases/05-pdf-generation/05-02-SUMMARY.md
@.planning/phases/04.6-customer-onboarding-contract-management/04.6-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create send contract dialog and API route</name>
  <files>
    web/components/contracts/send-contract-dialog.tsx
    web/app/api/contracts/send/route.ts
  </files>
  <action>
**web/components/contracts/send-contract-dialog.tsx** — 'use client' component:
- Props: `{ contract: Contract; onSent: () => void; trigger: React.ReactNode }`
- Use shadcn Dialog component (import from @/components/ui/dialog)
- Dialog content:
  - Title: "Send Service Agreement"
  - Pre-filled email input (from contract.client.contact_email via relation, editable)
  - Optional CC email input
  - Optional personal message textarea (included in email body)
  - Preview section showing:
    - Contract number
    - Client company name
    - Total amount and payment terms
    - "The client will receive an email with a link to view and sign this agreement."
  - Shareable link display: `{NEXT_PUBLIC_APP_URL}/contracts/{contract.shareable_token}/sign`
    - Copy button (navigator.clipboard.writeText) with "Copied!" feedback
  - "Send Agreement" button (primary) and "Cancel" button
- On send:
  - POST to /api/contracts/send with { contractId, recipientEmail, ccEmail?, personalMessage? }
  - Show loading state
  - On success: close dialog, call onSent(), show success state
  - On error: show error message
- Validation: contract must be in 'draft' status to send (show error if not)

**web/app/api/contracts/send/route.ts** — POST endpoint:
- Accept: { contractId, recipientEmail, ccEmail?, personalMessage? }
- Validate: contract exists, status is 'draft' or 'amended' (can re-send amended contracts)
- Validate transition: canTransition(contract.status, 'sent')
- Mark internal review complete if not already: update internal_review_completed_at = now()
- Call send-contract-email Edge Function with:
  - recipientEmail, ccEmail, personalMessage
  - contractId, contractNumber (derived from contract)
  - signingUrl: `${NEXT_PUBLIC_APP_URL}/contracts/${contract.shareable_token}/sign`
  - clientName (from contract -> client -> contact_name)
  - companyName (from contract -> client -> company_name)
  - totalAmount and paymentTerms for email summary
- Update contract status to 'sent', set sent_at = now()
- Insert contract_event: event_type='email_sent', event_data={ recipientEmail, ccEmail, sentBy: user.id }
- Return { success: true, shareableLink }

Use Supabase server client for database operations and Edge Function invocation:
```typescript
const { data, error } = await supabase.functions.invoke('send-contract-email', {
  body: { ... }
});
```
  </action>
  <verify>
Run: `ls web/components/contracts/send-contract-dialog.tsx` confirms file exists.
Run: `ls web/app/api/contracts/send/` confirms API route exists.
Run: `grep "Dialog" web/components/contracts/send-contract-dialog.tsx` confirms shadcn Dialog usage.
  </verify>
  <done>
SendContractDialog shows email input with copy-to-clipboard shareable link. API route validates contract status, calls Edge Function for email delivery, updates status to 'sent', and logs event.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Resend email Edge Function and webhook handler</name>
  <files>
    supabase/functions/send-contract-email/index.ts
    web/app/api/contracts/webhooks/route.ts
  </files>
  <action>
**supabase/functions/send-contract-email/index.ts** — Deno Edge Function:
Follow the email pattern from Phase 5 (Resend integration per 05-02-SUMMARY.md).

```typescript
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

Deno.serve(async (req) => {
  // CORS headers (same as other Edge Functions)
  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders });

  const {
    recipientEmail, ccEmail, personalMessage,
    contractId, contractNumber,
    signingUrl, clientName, companyName,
    totalAmount, paymentTerms
  } = await req.json();

  const RESEND_API_KEY = Deno.env.get('RESEND_API_KEY');

  // Graceful degradation if Resend not configured (same pattern as weekly report)
  if (!RESEND_API_KEY) {
    return new Response(JSON.stringify({
      success: false,
      error: 'RESEND_API_KEY not configured. Contract created but email not sent.'
    }), { status: 200, headers: corsHeaders });
  }

  // Send email via Resend API
  const emailResponse = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${RESEND_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      from: 'SiteMedic <contracts@sitemedic.co.uk>',
      to: [recipientEmail],
      cc: ccEmail ? [ccEmail] : undefined,
      subject: `Service Agreement ${contractNumber} - SiteMedic`,
      html: buildEmailHTML({ clientName, companyName, contractNumber, totalAmount, paymentTerms, signingUrl, personalMessage }),
      tags: [{ name: 'contractId', value: contractId }],
    }),
  });

  // ... error handling
});

function buildEmailHTML(data) {
  // Professional HTML email template:
  // - SiteMedic branding header
  // - "Dear {clientName},"
  // - Personal message (if provided)
  // - "Please review and sign the attached service agreement:"
  // - Contract summary card: number, company, total, payment terms
  // - CTA button: "View & Sign Agreement" linking to signingUrl
  // - "This link is unique to your agreement. Do not share it."
  // - Footer: SiteMedic Ltd, contact info
  // Use inline CSS for email compatibility
}
```

**web/app/api/contracts/webhooks/route.ts** — Resend webhook handler:
Follow Research Pattern 5 (Resend Webhooks for Email Tracking).

```typescript
export async function POST(req: Request) {
  const payload = await req.json();
  const { type, data } = payload;

  // Resend sends: email.sent, email.delivered, email.opened, email.clicked, email.bounced

  // Extract contractId from tags
  const contractIdTag = data.tags?.find((t: any) => t.name === 'contractId');
  if (!contractIdTag) return new Response('No contract tag', { status: 200 });
  const contractId = contractIdTag.value;

  const supabase = createClient(/* service role */);

  // Update contract status based on event type
  if (type === 'email.opened') {
    // Only update to 'viewed' if currently 'sent' (don't regress from 'signed')
    const { data: contract } = await supabase
      .from('contracts')
      .select('status')
      .eq('id', contractId)
      .single();

    if (contract?.status === 'sent') {
      await supabase.from('contracts')
        .update({ status: 'viewed', viewed_at: new Date().toISOString() })
        .eq('id', contractId);
    }
  }

  // Log ALL events in audit trail (even if status doesn't change)
  await supabase.from('contract_events').insert({
    contract_id: contractId,
    event_type: type, // email.sent, email.delivered, email.opened, email.clicked, email.bounced
    event_data: data,
    created_at: new Date().toISOString(),
  });

  return new Response('OK', { status: 200 });
}
```

Important: Webhook handler should be idempotent (same event processed multiple times safely). Use upsert or check-before-update pattern.
  </action>
  <verify>
Run: `ls supabase/functions/send-contract-email/` confirms Edge Function directory.
Run: `ls web/app/api/contracts/webhooks/` confirms webhook route.
Run: `grep "Resend" supabase/functions/send-contract-email/index.ts` confirms Resend integration.
Run: `grep "email.opened" web/app/api/contracts/webhooks/route.ts` confirms webhook handling.
  </verify>
  <done>
Resend Edge Function sends professional HTML email with signing link. Webhook handler updates contract status on email events (opened -> viewed) and logs all events in audit trail. Graceful degradation when RESEND_API_KEY not configured.
  </done>
</task>

</tasks>

<verification>
1. Send dialog shows pre-filled email with copy-to-clipboard shareable link
2. API route transitions contract from draft to sent
3. Edge Function sends email via Resend with professional template
4. Webhook handler processes email.opened events and updates contract to 'viewed'
5. All events logged in contract_events audit trail
6. Graceful degradation when Resend not configured
</verification>

<success_criteria>
- Admin clicks "Send", client receives email with signing link within seconds
- Email includes contract summary (number, company, total, terms) and CTA button
- Shareable link is copyable for phone call use
- Email open tracking updates contract status automatically
- All email events logged for audit compliance
</success_criteria>

<output>
After completion, create `.planning/phases/04.6-customer-onboarding-contract-management/04.6-05-SUMMARY.md`
</output>
