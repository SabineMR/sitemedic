---
phase: 04.6-customer-onboarding-contract-management
plan: 05
subsystem: email-delivery
tags: [resend, email, webhooks, contract-sending]

# Dependency graph
requires:
  - phase: 04.6-03
    provides: Contract signing flow and signature capture
  - phase: 04.6-04
    provides: Contract creation interface with payment terms
  - phase: 05-02
    provides: Resend email integration pattern
provides:
  - Send contract dialog with copyable shareable link
  - Email delivery via Resend API with professional HTML template
  - Webhook handler for email tracking (opened -> viewed)
  - Contract status transitions via email events
  - Audit trail for all email events
affects: [04.6-06, contract-workflow, client-onboarding]

# Tech tracking
tech-stack:
  added: []
  patterns: [resend-webhooks, email-tracking, shareable-links]

key-files:
  created:
    - web/components/contracts/send-contract-dialog.tsx
    - web/app/api/contracts/send/route.ts
    - supabase/functions/send-contract-email/index.ts
    - web/app/api/contracts/webhooks/route.ts
  modified: []

key-decisions:
  - "D-04.6-05-001: Send dialog shows copyable shareable link for phone call use"
  - "D-04.6-05-002: Personal message rendered with visual highlight in email"
  - "D-04.6-05-003: email.opened webhook only updates status if currently 'sent' (no regression)"
  - "D-04.6-05-004: All email events logged in contract_events regardless of status change"
  - "D-04.6-05-005: Email template uses inline CSS for maximum client compatibility"
  - "D-04.6-05-006: Security notice warns clients not to share unique signing link"
  - "D-04.6-05-007: Webhook handler returns 200 OK even on processing errors (prevents Resend retries)"

patterns-established:
  - "Contract email template: Header with branding, summary card, CTA button, security notice"
  - "Shareable link pattern: Copy-to-clipboard with visual feedback (Check icon on success)"
  - "Graceful degradation: RESEND_API_KEY missing returns HTTP 502 with shareableLink for manual sharing"
  - "Webhook idempotency: Status updates check current status before transitioning"

# Metrics
duration: 4min
completed: 2026-02-16
---

# Phase 4.6 Plan 5: Email Delivery System Summary

**Email delivery with Resend API, shareable link generation, and webhook tracking for contract status updates**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-16T19:24:17Z
- **Completed:** 2026-02-16T19:27:57Z
- **Tasks:** 2
- **Files created:** 4

## Accomplishments

- Send contract dialog with pre-filled email, CC, and personal message fields
- Contract summary preview showing number, client, total, and payment terms
- Copyable shareable link with visual feedback for phone call use
- Professional HTML email template with contract summary card and CTA button
- Email tracking via Resend webhooks updating contract status on open
- Full audit trail logging all email events (sent, delivered, opened, clicked, bounced)
- Graceful degradation when RESEND_API_KEY not configured

## Task Commits

Each task was committed atomically:

1. **Task 1: Create send contract dialog and API route** - `dccac8c` (feat)
2. **Task 2: Create Resend email Edge Function and webhook handler** - `ec6f49b` (feat)

## Files Created/Modified

- `web/components/contracts/send-contract-dialog.tsx` - Send dialog with email inputs, contract preview, and shareable link
- `web/app/api/contracts/send/route.ts` - API route validates contract, calls Edge Function, updates status to 'sent'
- `supabase/functions/send-contract-email/index.ts` - Edge Function sends email via Resend with professional HTML template
- `web/app/api/contracts/webhooks/route.ts` - Webhook handler processes Resend events and updates contract status

## Decisions Made

**D-04.6-05-001: Send dialog shows copyable shareable link for phone call use**
- Rationale: Admin can immediately share link during phone call without waiting for email delivery
- Implementation: Shareable link displayed with copy button showing Check icon on success

**D-04.6-05-002: Personal message rendered with visual highlight in email**
- Rationale: Personal message stands out from template content, feels more human
- Implementation: Blue left border and light gray background for personal message section

**D-04.6-05-003: email.opened webhook only updates status if currently 'sent' (no regression)**
- Rationale: Opening email after signing shouldn't regress status from 'signed' to 'viewed'
- Implementation: Check current status before transition, only update if status === 'sent'

**D-04.6-05-004: All email events logged in contract_events regardless of status change**
- Rationale: Full audit trail for compliance even when status doesn't change
- Implementation: Insert event after status update logic, not conditional on status change

**D-04.6-05-005: Email template uses inline CSS for maximum client compatibility**
- Rationale: Email clients strip `<style>` tags and external CSS; inline styles most reliable
- Implementation: All styles as style attributes on HTML elements

**D-04.6-05-006: Security notice warns clients not to share unique signing link**
- Rationale: Prevent unauthorized parties from accessing and signing contract
- Implementation: Yellow alert box with lock icon above footer

**D-04.6-05-007: Webhook handler returns 200 OK even on processing errors (prevents Resend retries)**
- Rationale: Processing errors are logged but shouldn't trigger Resend retry mechanism
- Implementation: Catch block returns 200 status with error message in response body

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

**Resend API configuration required for email delivery.** Follow these steps:

1. **Create Resend account:**
   - Sign up at https://resend.com/signup
   - Verify sending domain: sitemedic.co.uk

2. **Generate API key:**
   - Go to Resend Dashboard → API Keys
   - Create API Key with send permission
   - Copy key

3. **Add to Supabase secrets:**
   ```bash
   # Via Supabase Dashboard: Project Settings → Edge Functions → Secrets
   RESEND_API_KEY=re_xxxxxxxxxxxxx
   ```

4. **Configure webhook endpoint:**
   - Go to Resend Dashboard → Webhooks
   - Add endpoint: `https://your-domain.com/api/contracts/webhooks`
   - Subscribe to events: `email.sent`, `email.delivered`, `email.opened`, `email.clicked`, `email.bounced`
   - Copy webhook secret (for future signature verification)

5. **Verification:**
   - Create contract in admin dashboard
   - Click "Send Agreement"
   - Verify email received with PDF link
   - Open email and verify contract status updates to 'viewed'
   - Check contract_events table for logged events

**Note:** If RESEND_API_KEY not configured, send API returns HTTP 502 with shareable link. Admin can still copy link for manual sharing during phone call.

## Technical Notes

**Email Template Design:**
- Professional branding with SiteMedic header in navy blue (#003366)
- Contract summary card with key details (number, company, total, terms)
- Prominent CTA button in blue (#2563EB) for signing link
- Security notice in yellow alert box warns about unique link
- Footer with company info and copyright

**Webhook Event Flow:**
1. Resend sends webhook POST to `/api/contracts/webhooks`
2. Extract contractId from tags array
3. Check event type (email.sent, email.delivered, email.opened, etc.)
4. Update contract status if email.opened and currently 'sent'
5. Log event in contract_events table for audit trail
6. Return 200 OK to acknowledge receipt

**Shareable Link Pattern:**
- Format: `{NEXT_PUBLIC_APP_URL}/contracts/{shareable_token}/sign`
- Token generated via crypto.randomUUID() during contract creation
- Link shown in send dialog for immediate phone call use
- Copy-to-clipboard with visual feedback (Check icon for 2 seconds)

## Next Phase Readiness

**Ready for Phase 4.6 Plan 6 (integration with dashboard):**
- Send contract dialog complete and ready for integration
- Email delivery pipeline functional
- Webhook tracking operational
- Status transitions working correctly

**Next steps:**
- Integrate SendContractDialog into contract dashboard page
- Add "Send" button to contract list and detail views
- Display email tracking events in contract timeline
- Add resend capability for bounced emails

---
*Phase: 04.6-customer-onboarding-contract-management*
*Completed: 2026-02-16*
