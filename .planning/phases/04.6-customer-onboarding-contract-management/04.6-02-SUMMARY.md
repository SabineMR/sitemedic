---
phase: 04.6-customer-onboarding-contract-management
plan: 02
subsystem: api
tags: [react-pdf, deno, edge-functions, pdf-generation, contracts, typescript]

# Dependency graph
requires:
  - phase: 04.6-01
    provides: "Database schema (contracts, contract_templates, contract_versions), web TypeScript types, payment schedule logic"
  - phase: 05-01
    provides: "@react-pdf/renderer 4.3.2 pattern with renderToBuffer in Deno Edge Functions"
provides:
  - "Edge Function for generating contract PDFs with auto-filled booking data"
  - "React-PDF components for contract documents (header, parties, pricing, payment schedule, terms, signatures)"
  - "Two-mode operation: database lookup by contractId or preview mode with direct data"
affects: [04.6-03-contract-signing-flow, 04.6-04-contract-dashboard, contract-management]

# Tech tracking
tech-stack:
  added: []
  patterns: ["Contract PDF generation following generate-weekly-report pattern", "Two-mode Edge Function (database vs preview)", "UK date/currency formatting in PDFs"]

key-files:
  created:
    - "supabase/functions/generate-contract-pdf/index.tsx"
    - "supabase/functions/generate-contract-pdf/components/ServiceTerms.tsx"
    - "supabase/functions/generate-contract-pdf/components/PaymentSchedule.tsx"
    - "supabase/functions/generate-contract-pdf/components/SignatureBlock.tsx"
  modified: []

key-decisions:
  - "Contract number format SA-{YYYY}-{NNN} using UUID-derived sequential number"
  - "Two-mode operation: contractId fetches from database, previewData for pre-save rendering"
  - "Payment schedule descriptions hardcoded for all 5 term types"
  - "UK date formatting: long (16 February 2026) for headers, short (16 Feb 2026) for tables"
  - "Digital signature disclaimer cites UK Electronic Communications Act 2000"

patterns-established:
  - "React-PDF sub-components pattern: ContractDocument imports ServiceTerms, PaymentSchedule, SignatureBlock"
  - "Currency formatting: toLocaleString('en-GB') for GBP with 2 decimal places"
  - "SiteMedic brand colors: #003366 (dark navy primary), #2563EB (blue accent)"

# Metrics
duration: 6min
completed: 2026-02-16
---

# Phase 04.6 Plan 02: Contract PDF Generation Summary

**Edge Function generates contract PDFs with auto-filled booking data, pricing breakdowns, payment schedules for all 5 term types, and signature capture using React-PDF**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-16T18:58:08Z
- **Completed:** 2026-02-16T19:04:02Z
- **Tasks:** 2 (Task 1 files already existed from 04.6-01)
- **Files modified:** 4 new files

## Accomplishments
- Edge Function with two-mode operation: database lookup by contractId or preview with direct data
- React-PDF sub-components for modular contract sections (terms, payment schedule, signatures)
- Payment schedule table supports all 5 term types (full_prepay, split_50_50, split_50_net30, full_net30, custom)
- Signature block shows signed state (signature image + details) or unsigned placeholder
- UK date/currency formatting throughout for compliance and readability

## Task Commits

Each task was committed atomically:

1. **Task 1: Types, styles, and ContractDocument** - (files already existed from 04.6-01, no commit needed)
2. **Task 2: Sub-components (ServiceTerms, PaymentSchedule, SignatureBlock)** - `ae2be21` (feat)
3. **Task 3: Edge Function handler** - `dda3495` (feat)

**Note:** Task 1 files (types.ts, styles.ts, ContractDocument.tsx) were already created in plan 04.6-01 commit 902528d. This plan added the remaining sub-components and Edge Function handler.

## Files Created/Modified
- `supabase/functions/generate-contract-pdf/index.tsx` - Edge Function handler with database lookup and preview modes, CORS, error handling
- `supabase/functions/generate-contract-pdf/components/ServiceTerms.tsx` - Renders numbered clauses, general terms, cancellation policy
- `supabase/functions/generate-contract-pdf/components/PaymentSchedule.tsx` - Payment milestone table for all 5 term types with total row
- `supabase/functions/generate-contract-pdf/components/SignatureBlock.tsx` - Dual-column provider/client signatures with signed/unsigned states

## Decisions Made

**D-04.6-02-001: Contract number format SA-{YYYY}-{NNN}**
- Uses last 3 characters of UUID converted to hex-based sequential number
- Zero-padded to 3 digits for professional appearance
- Simple approach avoids database counter complexity

**D-04.6-02-002: Two-mode Edge Function operation**
- Mode 1 (contractId): Fetch contract with relations (booking, client, template, signature) from database
- Mode 2 (previewData): Accept full ContractPDFData for preview before saving
- Enables both production contract generation and pre-save preview in UI

**D-04.6-02-003: Payment schedule descriptions hardcoded in Edge Function**
- Each payment term type has predefined description text
- Custom terms use contract.custom_terms_description from database
- Avoids storing redundant text in database for standard terms

**D-04.6-02-004: UK date formatting patterns**
- Long format (16 February 2026) for document headers and signature sections
- Short format (16 Feb 2026) for tables and booking details
- Matches UK business document conventions

**D-04.6-02-005: Digital signature legal disclaimer**
- Cites UK Electronic Communications Act 2000 for legal validity
- Includes "timestamp and IP address" for audit trail transparency
- Only shown when signature is present

## Deviations from Plan

None - plan executed exactly as written. Task 1 files (types.ts, styles.ts, ContractDocument.tsx) already existed from plan 04.6-01, so this plan focused on Tasks 2 and 3 as specified.

## Issues Encountered

**Task 1 files already existed:** Plan 04.6-01 created types.ts, styles.ts, and ContractDocument.tsx as part of its scope. This plan (04.6-02) was intended to create those files plus sub-components and Edge Function handler. Recognized the overlap, verified files matched requirements, and proceeded with Tasks 2-3 only.

## User Setup Required

**Edge Function deployment required.** To use the contract PDF generation:

1. Deploy Edge Function:
   ```bash
   supabase functions deploy generate-contract-pdf
   ```

2. Verify deployment:
   ```bash
   curl -X POST https://[project-ref].supabase.co/functions/v1/generate-contract-pdf \
     -H "Authorization: Bearer [anon-key]" \
     -H "Content-Type: application/json" \
     -d '{"contractId": "[test-contract-id]"}'
   ```

3. Edge Function requires:
   - `SUPABASE_URL` (auto-provided)
   - `SUPABASE_SERVICE_ROLE_KEY` (auto-provided)

**No external services required** - all dependencies internal to Supabase.

## Next Phase Readiness

**Ready for Phase 04.6-03 (Contract Signing Flow):**
- PDF generation Edge Function complete and tested
- Signature block supports both signed and unsigned states
- Preview mode enables UI to show contract before client signs
- Database lookup mode generates final signed PDFs for storage

**Ready for Phase 04.6-04 (Contract Dashboard):**
- Edge Function can be called from admin dashboard for contract downloads
- contractId parameter enables direct PDF retrieval by contract ID
- Content-Disposition header triggers browser download with proper filename

**Potential enhancement for later:**
- Logo image from Supabase Storage (currently text placeholder "SiteMedic")
- Email delivery integration (follow generate-weekly-report pattern with Resend)

---
*Phase: 04.6-customer-onboarding-contract-management*
*Completed: 2026-02-16*
