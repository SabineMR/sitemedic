---
phase: 04.6-customer-onboarding-contract-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/generate-contract-pdf/index.tsx
  - supabase/functions/generate-contract-pdf/components/ContractDocument.tsx
  - supabase/functions/generate-contract-pdf/components/ServiceTerms.tsx
  - supabase/functions/generate-contract-pdf/components/PaymentSchedule.tsx
  - supabase/functions/generate-contract-pdf/components/SignatureBlock.tsx
  - supabase/functions/generate-contract-pdf/styles.ts
  - supabase/functions/generate-contract-pdf/types.ts
autonomous: true

must_haves:
  truths:
    - "Contract PDF generates with client info auto-filled from booking data (company name, contact, site address, dates)"
    - "Pricing breakdown in PDF matches booking data (base rate, hours, urgency premium, travel, VAT, total)"
    - "Payment terms section in PDF updates based on selected payment schedule"
  artifacts:
    - path: "supabase/functions/generate-contract-pdf/index.tsx"
      provides: "Edge Function entry point for contract PDF generation"
      contains: "renderToBuffer"
    - path: "supabase/functions/generate-contract-pdf/components/ContractDocument.tsx"
      provides: "Main PDF document with all sections composed"
      contains: "Document"
    - path: "supabase/functions/generate-contract-pdf/styles.ts"
      provides: "React-PDF StyleSheet with professional contract formatting"
      contains: "StyleSheet.create"
  key_links:
    - from: "supabase/functions/generate-contract-pdf/index.tsx"
      to: "supabase/functions/generate-contract-pdf/components/ContractDocument.tsx"
      via: "imports and renders ContractDocument"
      pattern: "import.*ContractDocument"
    - from: "supabase/functions/generate-contract-pdf/index.tsx"
      to: "@react-pdf/renderer"
      via: "renderToBuffer for PDF generation"
      pattern: "renderToBuffer"
---

<objective>
Create the Edge Function for generating service agreement PDFs with auto-filled booking data, pricing breakdowns, payment terms, and signature blocks.

Purpose: This is the PDF generation engine for contracts. It follows the exact same pattern as the existing `generate-weekly-report` Edge Function (Phase 5, Plan 01) — using @react-pdf/renderer 4.3.2 with renderToBuffer in Deno. The contract PDF auto-fills client info, site details, booking dates/hours, pricing breakdown, and payment terms from booking data.

Output: Complete Edge Function that accepts contract data and returns a professional A4 PDF buffer ready for storage.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@supabase/functions/generate-weekly-report/index.tsx
@supabase/functions/generate-weekly-report/styles.ts
@supabase/functions/generate-weekly-report/types.ts
@.planning/phases/04.6-customer-onboarding-contract-management/04.6-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contract PDF types, styles, and React-PDF components</name>
  <files>
    supabase/functions/generate-contract-pdf/types.ts
    supabase/functions/generate-contract-pdf/styles.ts
    supabase/functions/generate-contract-pdf/components/ContractDocument.tsx
    supabase/functions/generate-contract-pdf/components/ServiceTerms.tsx
    supabase/functions/generate-contract-pdf/components/PaymentSchedule.tsx
    supabase/functions/generate-contract-pdf/components/SignatureBlock.tsx
  </files>
  <action>
**types.ts** — Define contract PDF data types (Deno-compatible, no external imports):
```typescript
interface ContractPDFData {
  contractId: string;
  contractNumber: string; // e.g., "SA-2026-001"
  generatedAt: string; // ISO timestamp

  client: {
    companyName: string;
    contactName: string;
    contactEmail: string;
    address: string;
    postcode: string;
    vatNumber?: string;
  };

  site: {
    name: string;
    address: string;
    postcode: string;
    contactName?: string;
    contactPhone?: string;
  };

  booking: {
    shiftDate: string;
    shiftStart: string;
    shiftEnd: string;
    hours: number;
    specialRequirements?: string;
    isRecurring: boolean;
    recurrencePattern?: string;
    recurringUntil?: string;
  };

  pricing: {
    baseRate: number;
    hours: number;
    subtotal: number;
    urgencyPremiumPercent: number;
    urgencyPremiumAmount: number;
    travelSurcharge: number;
    outOfTerritoryCost: number;
    netAmount: number;
    vat: number;
    total: number;
  };

  paymentSchedule: {
    terms: string;
    description: string;
    upfrontAmount: number;
    completionAmount: number;
    net30Amount: number;
  };

  template: {
    clauses: Array<{ title: string; body: string; order: number }>;
    termsAndConditions: string;
    cancellationPolicy: string;
  };

  signature?: {
    dataUrl: string; // base64 PNG
    signedName: string;
    signedAt: string;
    signedByEmail: string;
  };
}
```

**styles.ts** — Create React-PDF StyleSheet following the same brand pattern as generate-weekly-report:
- Page: A4, padding 40pt, fontFamily 'Helvetica', fontSize 10
- Brand colors: primary #003366 (dark navy), accent #2563EB (blue)
- Header: fontSize 20, fontWeight 'bold', color primary, marginBottom 5
- Subheader: fontSize 14, fontWeight 'bold', marginTop 15, marginBottom 8
- Section: marginBottom 12
- Table styles: header row with navy background + white text, alternating row colors (#f9fafb)
- Signature box: border 1pt solid #000, height 80pt, padding 10
- Footer: fontSize 8, color #6b7280, marginTop 20
- Legal text: fontSize 9, lineHeight 1.6, color #374151
- Clause title: fontSize 11, fontWeight 'bold', marginTop 8, marginBottom 3
- Amount highlight: fontWeight 'bold', color primary

**components/ContractDocument.tsx** — Main document composition:
- Import Document, Page from '@react-pdf/renderer@4.3.2' with npm: specifier
- Compose: Header section (SiteMedic branding + contract number + date) → Parties section (Provider: SiteMedic Ltd, Client: auto-filled) → Site Details → Booking Details → Pricing Table → Payment Schedule → Template Clauses (mapped from template.clauses) → Terms & Conditions → Cancellation Policy → Signature Block → Footer
- Use View/Text components with styles from styles.ts
- UK date formatting: "16 February 2026" for header, "16 Feb 2026" for table dates
- GBP currency formatting: £1,000.00 with toLocaleString('en-GB')

**components/ServiceTerms.tsx** — Terms and conditions section:
- Render template.clauses as numbered list with title and body
- Render template.termsAndConditions as paragraph
- Render template.cancellationPolicy as paragraph
- Use legal text styles (fontSize 9, lineHeight 1.6)

**components/PaymentSchedule.tsx** — Payment breakdown table:
- Table with rows for each payment milestone
- Columns: Milestone, Amount, Due Date
- Milestones based on paymentSchedule.terms:
  - full_prepay: "Payment in Full" | total | "Upon signing"
  - split_50_50: "Upfront Payment" | upfront | "Upon signing" + "Completion Payment" | completion | "Upon service completion"
  - split_50_net30: "Upfront Payment" | upfront | "Upon signing" + "Net 30 Payment" | net30 | "30 days after service completion"
  - full_net30: "Invoice Payment" | total | "30 days after service completion"
  - custom: Show all non-zero amounts
- Total row with bold styling
- Description text below table from paymentSchedule.description

**components/SignatureBlock.tsx** — Signature area:
- Two columns: Provider (SiteMedic Ltd) and Client
- Each column: Signature line (if signature provided, render Image from base64; else empty box), Name line, Date line, Email line
- Provider side pre-filled with "SiteMedic Ltd" and "Authorized Representative"
- Client side: if signature?.dataUrl provided, render image; else show "Awaiting signature" text
- Below: "By signing this agreement, you confirm that you have read, understood, and agree to the terms and conditions above."
- Include IP address note: "Digital signature captured and stored with timestamp and IP address for verification."
  </action>
  <verify>
Run: `ls supabase/functions/generate-contract-pdf/` to verify all files exist.
Run: `grep -c "StyleSheet.create" supabase/functions/generate-contract-pdf/styles.ts` returns 1.
Run: `grep "Document" supabase/functions/generate-contract-pdf/components/ContractDocument.tsx` confirms Document import.
  </verify>
  <done>
6 files created with types, styles, and 4 React-PDF components. ContractDocument composes all sections. Pricing table auto-fills from booking data. Payment schedule renders correct milestones per term type. Signature block handles both signed and unsigned states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Edge Function handler with PDF generation endpoint</name>
  <files>supabase/functions/generate-contract-pdf/index.tsx</files>
  <action>
Create the Edge Function entry point following the exact pattern from generate-weekly-report/index.tsx:

```typescript
// Deno.serve handler
// Accept POST with JSON body containing contractId OR full ContractPDFData
// CORS headers (same as generate-weekly-report)
// Two modes:
//   1. contractId provided: Fetch contract + booking + client data from database, build ContractPDFData
//   2. Full data provided: Use directly (for preview before saving)

// Mode 1 (contractId):
// - Create Supabase client with service role key
// - Fetch contract with relations: contract -> booking -> client
// - Fetch template (by contract.template_id or default template where is_default = true)
// - Build ContractPDFData from fetched data
// - Calculate payment schedule amounts from contract fields

// Mode 2 (preview data):
// - Use provided ContractPDFData directly
// - No database queries needed

// Generate PDF:
// - Import renderToBuffer from 'npm:@react-pdf/renderer@4.3.2'
// - Import ContractDocument component
// - const pdfBuffer = await renderToBuffer(<ContractDocument data={contractData} />)
// - Return Response with pdfBuffer, Content-Type: application/pdf
// - Add X-Generation-Time header for performance monitoring
// - Add Content-Disposition: attachment; filename="service-agreement-{contractNumber}.pdf"

// Error handling:
// - 400 for missing contractId/data
// - 404 for contract not found
// - 500 for generation errors with descriptive message
// - Log generation time for monitoring

// Contract number generation:
// Format: "SA-{YYYY}-{NNN}" where NNN is zero-padded sequential
// Use contract.id substring or a counter for simplicity
```

Follow the CORS pattern from existing Edge Functions:
```typescript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};
```

Handle OPTIONS preflight request.

Use the Supabase client pattern from generate-weekly-report:
```typescript
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
```
  </action>
  <verify>
Run: `grep "renderToBuffer" supabase/functions/generate-contract-pdf/index.tsx` confirms PDF generation.
Run: `grep "Deno.serve" supabase/functions/generate-contract-pdf/index.tsx` confirms Edge Function pattern.
Run: `grep "ContractDocument" supabase/functions/generate-contract-pdf/index.tsx` confirms component import.
  </verify>
  <done>
Edge Function generates contract PDF from either contractId (database lookup) or preview data (direct rendering). Returns PDF buffer with correct Content-Type and Content-Disposition headers. Follows existing Edge Function patterns (CORS, error handling, performance logging).
  </done>
</task>

</tasks>

<verification>
1. Edge Function files all exist in supabase/functions/generate-contract-pdf/
2. ContractDocument.tsx imports and renders all 4 sub-components
3. styles.ts uses brand colors matching existing SiteMedic palette
4. index.tsx handles both contractId and preview data modes
5. Payment schedule table renders correctly for all 5 term types
</verification>

<success_criteria>
- Contract PDF auto-generates with client info, site details, dates, pricing, payment terms all pre-filled
- Pricing breakdown matches booking data exactly (base rate * hours + urgency + travel + VAT)
- Payment schedule section shows correct milestones based on term type selection
- Signature block shows placeholder when unsigned, renders image when signed
- Edge Function returns valid PDF buffer with proper headers
</success_criteria>

<output>
After completion, create `.planning/phases/04.6-customer-onboarding-contract-management/04.6-02-SUMMARY.md`
</output>
