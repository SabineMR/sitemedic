---
phase: 04.6-customer-onboarding-contract-management
plan: 04
subsystem: contracts
tags: [contracts, payment-terms, admin-ui, pdf-generation, typescript, react, nextjs]

requires:
  - 04.6-01  # Payment schedules calculations
  - 04.6-02  # Contract PDF generation Edge Function

provides:
  - Payment terms selector with live GBP amount preview
  - Contract preview component matching PDF layout
  - Admin contract creation workflow
  - API endpoint for creating contracts with PDF generation

affects:
  - 04.6-05  # Contract signing flow (uses shareable_token from this plan)
  - 04.6-06  # Contract email delivery (sends contracts created here)

tech-stack:
  added:
    - shadcn/ui radio-group  # Payment terms selection UI
  patterns:
    - Client eligibility filtering (prepay vs net_30 clients)
    - Custom payment validation (amounts must sum to total)
    - Multi-step form with live preview
    - Async PDF generation (background Edge Function call)

key-files:
  created:
    - web/components/contracts/payment-terms-select.tsx  # Payment terms radio selector
    - web/components/contracts/contract-preview.tsx      # HTML preview of contract PDF
    - web/components/contracts/create-contract-form.tsx  # Multi-step contract creation form
    - web/app/(dashboard)/contracts/create/page.tsx      # Dashboard page for contract creation
    - web/app/api/contracts/create/route.ts              # API endpoint for creating contracts
    - web/components/ui/radio-group.tsx                  # shadcn radio-group component
  modified:
    - web/package.json  # Added shadcn dependencies
    - web/pnpm-lock.yaml

decisions:
  - D-04.6-04-001: Payment terms selector shows live GBP amounts for each option (upfront, completion, net30) calculated using calculatePaymentSchedule function
  - D-04.6-04-002: Prepay clients filtered to full_prepay and split_50_50 options only (no Net 30 terms without upgrade)
  - D-04.6-04-003: Custom payment terms validate that upfront + completion + net30 equals booking total (with 1 penny tolerance for rounding)
  - D-04.6-04-004: Contract preview uses HTML with draft watermark styled via CSS transform rotate(-45deg)
  - D-04.6-04-005: Dashboard page filters bookings without existing contracts by checking contracts table where status != 'terminated'
  - D-04.6-04-006: API route generates shareable_token using crypto.randomUUID() for public client signing links
  - D-04.6-04-007: PDF generation called asynchronously via Edge Function (doesn't block contract creation, admin can regenerate if fails)
  - D-04.6-04-008: Contract events logged with event_type='version_created' and actor_ip from x-forwarded-for header
  - D-04.6-04-009: Supabase query result transformed to handle nested clients relation returned as array (take first element)

duration: 13 minutes
completed: 2026-02-16
---

# Phase 4.6 Plan 04: Contract Creation Interface Summary

**One-liner:** Admin creates contracts from bookings with live payment term previews and async PDF generation

## What Was Built

### Payment Terms Selector Component
- **File:** `web/components/contracts/payment-terms-select.tsx`
- Radio group with 5 payment options (full_prepay, split_50_50, split_50_net30, full_net30, custom)
- Live GBP amount breakdown for each option showing upfront/completion/net30 amounts
- Client eligibility filtering (prepay clients see only 2 options, net_30 clients see all 5)
- Custom payment terms with 3 number inputs and validation
- Amber info box for prepay clients explaining Net 30 upgrade requirement

### Contract Preview Component
- **File:** `web/components/contracts/contract-preview.tsx`
- HTML preview matching PDF layout with draft watermark
- All contract sections: parties, site details, booking details, pricing table, payment schedule, clauses, terms, signatures
- Skeleton loading state for async data fetching
- UK date formatting (16 February 2026 for headers, 16 Feb 2026 for tables)
- Digital signature disclaimer citing UK Electronic Communications Act 2000

### Contract Creation Form
- **File:** `web/components/contracts/create-contract-form.tsx`
- 4-step workflow:
  1. Select booking (dropdown with client, site, date, total)
  2. Select template (dropdown with default template pre-selected)
  3. Configure payment terms (PaymentTermsSelect with live preview)
  4. Preview contract (ContractPreview with all data assembled)
- Auto-fills all fields from selected booking (client info, site details, pricing breakdown)
- Shows client payment status badge (prepay/net_30)
- Validates form completion before enabling "Create Draft" button
- Error handling with Alert component

### Dashboard Page
- **File:** `web/app/(dashboard)/contracts/create/page.tsx`
- Server component fetching eligible bookings and active templates
- Queries bookings in 'pending' or 'confirmed' status without existing contracts
- Transforms Supabase nested relation data (clients array → single client object)
- Breadcrumb navigation (Dashboard > Contracts > Create)
- Empty states for no bookings or no templates
- Links to /bookings or /contracts/templates for setup

### API Route
- **File:** `web/app/api/contracts/create/route.ts`
- POST /api/contracts/create endpoint
- Validates authentication, required fields, and payment amounts
- Checks booking doesn't already have contract (conflict prevention)
- Validates payment amounts sum to booking total (1 penny tolerance)
- Creates contract record with status='draft'
- Creates contract_versions record with version=1 and storage path
- Generates shareable_token for public client signing link
- Calls generate-contract-pdf Edge Function asynchronously (background)
- Logs contract_event with event_type='version_created'
- Returns { success: true, contract: { id, shareable_token, status } }

## Technical Decisions

### Client Eligibility Filtering
**Decision:** Prepay clients can only select full_prepay or split_50_50 payment terms. Net 30 options require client upgrade.

**Rationale:**
- Payment terms are client-level financial status, not booking-level preference
- Prevents admins from accidentally offering Net 30 to prepay-only clients
- Clear amber info box explains upgrade path

**Implementation:**
```typescript
const availableOptions = getPaymentTermsOptions(clientPaymentTerms);
// Returns ['full_prepay', 'split_50_50', 'custom'] for prepay clients
// Returns all 5 options for net_30 clients
```

### Custom Payment Validation
**Decision:** Custom payment amounts must sum to booking total with 1 penny tolerance for rounding differences.

**Rationale:**
- Prevents data entry errors (typos, missing digits)
- 1 penny tolerance handles floating point rounding (e.g., 1000/3 = 333.33 * 3 = 999.99)
- Validation runs client-side (instant feedback) and server-side (security)

**Implementation:**
```typescript
const totalPayments = upfrontAmount + completionAmount + net30Amount;
if (Math.abs(totalPayments - expectedTotal) > 0.01) {
  throw new Error('Payment amounts must sum to total');
}
```

### Async PDF Generation
**Decision:** Call generate-contract-pdf Edge Function asynchronously after contract creation, don't block on result.

**Rationale:**
- PDF generation can take 2-5 seconds (database queries, @react-pdf/renderer rendering)
- Faster admin UX (contract created immediately, PDF generates in background)
- Admin can regenerate PDF later if Edge Function fails
- Edge Function logs errors to contract_events table for debugging

**Trade-offs:**
- Admin doesn't see immediate PDF generation failure
- Requires separate UI to check PDF status and trigger regeneration

**Implementation:**
```typescript
fetch(`${supabaseUrl}/functions/v1/generate-contract-pdf`, {
  method: 'POST',
  body: JSON.stringify({ contractId: contract.id }),
}).catch((error) => {
  console.error('PDF generation failed:', error);
  // Don't fail the request - admin can regenerate later
});
```

### Supabase Nested Relation Transform
**Decision:** Transform Supabase query results to convert nested `clients` array to single `client` object.

**Rationale:**
- Supabase PostgREST returns one-to-many relations as arrays (even for inner joins)
- TypeScript interface expects single client object (BookingWithClient.client: {...})
- Transformation happens server-side before passing to client component

**Implementation:**
```typescript
const availableBookings = (bookingsData || [])
  .map((booking: any) => ({
    ...booking,
    client: Array.isArray(booking.clients) ? booking.clients[0] : booking.clients,
  }))
  .filter((booking: any) => booking.client);
```

## Deviations from Plan

None - plan executed exactly as written.

## Integration Points

### Depends On
- **04.6-01:** Uses `calculatePaymentSchedule()`, `PAYMENT_TERMS_OPTIONS`, `getPaymentTermsOptions()`, `formatGBP()` from payment-schedules.ts
- **04.6-02:** Calls `generate-contract-pdf` Edge Function with `{ contractId }` payload

### Provides To
- **04.6-05:** Contract signing flow uses `shareable_token` from contracts table to look up contract
- **04.6-06:** Email delivery fetches contracts with status='draft' to send to clients

### Database Schema
- Inserts into `contracts` table (status='draft', payment_terms, amounts, shareable_token)
- Inserts into `contract_versions` table (version=1, storage_path, generated_by)
- Inserts into `contract_events` table (event_type='version_created', actor_id, actor_ip)
- Updates `contracts.current_version_id` after version creation

## Testing Notes

### Manual Testing Checklist
1. Navigate to /contracts/create as authenticated admin
2. Select booking from dropdown (verify client payment status badge)
3. Select template (verify default template pre-selected)
4. Change payment terms (verify live GBP amounts update)
5. Select custom payment terms (verify validation error if amounts don't sum to total)
6. Preview contract (verify all sections populated correctly)
7. Create draft contract (verify success redirect to /contracts?success=created)
8. Check database: contract, contract_version, contract_event records created
9. Check Supabase Storage: contracts/{contractId}/v1.pdf exists (after Edge Function completes)
10. Prepay client: verify only 2 payment options shown (no Net 30)
11. Net 30 client: verify all 5 payment options shown

### Edge Cases Handled
- No eligible bookings: Empty state with link to /bookings
- No templates: Empty state with link to /contracts/templates
- Booking already has contract: API returns 409 Conflict error
- Payment amounts don't sum: Client-side validation + API 400 error
- Edge Function fails: Doesn't block contract creation, admin can regenerate
- Supabase query returns clients as array: Server-side transformation to single object

## Next Phase Readiness

### For Plan 04.6-05 (Contract Signing Flow)
- ✅ Shareable token generated and stored in contracts.shareable_token
- ✅ Contract status initialized to 'draft'
- ✅ Client signature fields (client_signed_name, client_signature_data) ready in contract_versions table
- ⚠️  Need to build public signing page at /contracts/[id]/sign using shareable_token

### For Plan 04.6-06 (Contract Email Delivery)
- ✅ Contracts created with status='draft' ready to be sent
- ✅ Contract events table ready for email tracking (email_sent, email_opened, email_clicked)
- ⚠️  Need to configure email service (Resend API key, email templates)
- ⚠️  Need to build email trigger logic (manual send button, auto-send on draft creation)

### Open Questions
- **PDF regeneration:** Should admin be able to manually regenerate PDFs if Edge Function fails? (Answer: Yes, Plan 04.6-06 will add regenerate button)
- **Contract versioning:** When contract is amended, how does versioning work? (Answer: Plan 04.6-03 already handles this with contract_versions.previous_version_id)
- **Payment collection:** When should Stripe payment be initiated? (Answer: Upon contract signing, Plan 04.6-05)

## Performance Notes

- Build time: ~60 seconds (TypeScript type checking for 5 new files)
- Contract creation API: <500ms (3 database inserts + Edge Function call)
- Edge Function call: Async, doesn't block response
- Dashboard page load: <1 second (2 Supabase queries with indexes)

## Commits

- `8ae5c26`: feat(04.6-04): create payment terms selector and contract preview components
- `ba58b12`: feat(04.6-04): create contract creation form, dashboard page, and API route

---

**Status:** ✅ Complete
**Next Plan:** 04.6-05 (Contract Signing Flow)
