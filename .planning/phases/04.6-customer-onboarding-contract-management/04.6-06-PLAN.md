---
phase: 04.6-customer-onboarding-contract-management
plan: 06
type: execute
wave: 3
depends_on: ["04.6-04"]
files_modified:
  - web/app/(dashboard)/contracts/page.tsx
  - web/app/(dashboard)/contracts/[id]/page.tsx
  - web/app/(dashboard)/contracts/templates/page.tsx
  - web/components/contracts/contracts-table.tsx
  - web/components/contracts/contract-detail.tsx
  - web/components/contracts/template-manager.tsx
  - web/lib/contracts/queries.ts
autonomous: true

must_haves:
  truths:
    - "Agreement shows signature status in admin dashboard (Draft, Sent, Viewed, Signed, Completed)"
    - "Admin can manage agreement templates (edit clauses, add custom terms, version control)"
    - "Admin can view contract details with version history and audit trail"
  artifacts:
    - path: "web/app/(dashboard)/contracts/page.tsx"
      provides: "Admin contracts list page with status filters"
      contains: "ContractsTable"
    - path: "web/app/(dashboard)/contracts/[id]/page.tsx"
      provides: "Admin contract detail page with actions and history"
      contains: "ContractDetail"
    - path: "web/app/(dashboard)/contracts/templates/page.tsx"
      provides: "Admin template management page"
      contains: "TemplateManager"
  key_links:
    - from: "web/app/(dashboard)/contracts/page.tsx"
      to: "web/lib/contracts/queries.ts"
      via: "fetches contracts list with filters"
      pattern: "getContracts"
    - from: "web/components/contracts/contracts-table.tsx"
      to: "web/components/contracts/contract-status-badge.tsx"
      via: "renders status badges in table rows"
      pattern: "ContractStatusBadge"
---

<objective>
Create the admin contract management dashboard with contracts list, detail view, and template management.

Purpose: Admin needs visibility into all contracts — their status (Draft/Sent/Viewed/Signed/Completed), payment terms, and actions available. The contracts list page provides filters and search. The detail page shows full contract info, version history, audit trail, and actions (send, terminate, amend). Template management allows editing default clauses and creating custom templates.

Output: Contracts list page, contract detail page, template management page, data queries, table and detail components.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@web/lib/contracts/types.ts
@web/lib/contracts/workflow.ts
@web/components/contracts/contract-status-badge.tsx
@web/components/contracts/send-contract-dialog.tsx
@.planning/phases/05.5-admin-operations/05.5-01-SUMMARY.md
@.planning/phases/04.6-customer-onboarding-contract-management/04.6-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contracts data queries and list page with table</name>
  <files>
    web/lib/contracts/queries.ts
    web/components/contracts/contracts-table.tsx
    web/app/(dashboard)/contracts/page.tsx
  </files>
  <action>
**web/lib/contracts/queries.ts** — Server-side data queries:
- `getContracts(filters?: { status?: ContractStatus; clientId?: string; search?: string })`:
  - Query contracts table with joins: booking (for site details), client (for company name), contract_versions (for latest version)
  - Apply optional filters: status, clientId, search (by company name, contract number, site name)
  - Order by: created_at DESC
  - Return Contract[] with relations
- `getContractById(contractId: string)`:
  - Query single contract with all relations: booking, client, template, all versions, all events
  - Return ContractWithRelations
- `getContractTemplates()`:
  - Query contract_templates ordered by is_default DESC, name ASC
  - Return ContractTemplate[]
- `getContractStats()`:
  - Count by status: { draft: N, sent: N, viewed: N, signed: N, completed: N, active: N }
  - For dashboard summary cards
- Use Supabase server client (createClient from @/lib/supabase/server)

**web/components/contracts/contracts-table.tsx** — 'use client' component:
- Props: `{ contracts: ContractWithRelations[]; onRefresh: () => void }`
- Use existing DataTable pattern from admin pages (Phase 5.5)
- Columns:
  1. Contract # (formatted, clickable -> detail page)
  2. Client (company name)
  3. Site (from booking)
  4. Total (GBP formatted)
  5. Payment Terms (label from PAYMENT_TERMS_OPTIONS)
  6. Status (ContractStatusBadge component)
  7. Created (UK date format)
  8. Actions (dropdown: View, Send, Copy Link, Terminate)
- Filters:
  - Status filter: Select dropdown with all status options + "All"
  - Search: Text input with 300ms debounce (search company name, site name)
- Sort by: created_at (default), status, total
- Row click navigates to /contracts/[id] detail page
- "Create Agreement" button in header linking to /contracts/create
- Status summary cards above table: count per status (like booking management page)

**web/app/(dashboard)/contracts/page.tsx** — Server component:
- Page title: "Service Agreements"
- Fetch contracts using getContracts() and getContractStats()
- Render ContractsTable with data
- Add to dashboard navigation (sidebar link: "Contracts" or "Agreements")
- TanStack Query with 60-second polling for near-real-time status updates
- Note: Need to add navigation link in dashboard layout sidebar. Check existing layout and add link to /contracts.
  </action>
  <verify>
Run: `ls "web/app/(dashboard)/contracts/"` to verify page exists.
Run: `ls web/lib/contracts/queries.ts` confirms queries file.
Run: `grep "ContractStatusBadge" web/components/contracts/contracts-table.tsx` confirms badge usage.
Run: `cd /Users/sabineresoagli/GitHub/sitemedic/web && pnpm build 2>&1 | tail -10` to verify build.
  </verify>
  <done>
Contracts list page shows all contracts with status badges, filters, search. Status summary cards show count per status. Table uses existing DataTable patterns. Navigation link added to dashboard sidebar.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create contract detail page and template management</name>
  <files>
    web/components/contracts/contract-detail.tsx
    web/app/(dashboard)/contracts/[id]/page.tsx
    web/components/contracts/template-manager.tsx
    web/app/(dashboard)/contracts/templates/page.tsx
  </files>
  <action>
**web/components/contracts/contract-detail.tsx** — 'use client' component:
- Props: `{ contract: ContractWithRelations }`
- Layout: Two columns on desktop (detail left, sidebar right)
- Left column:
  - Contract header: number, status badge, created date
  - Client section: company, contact, email, payment terms
  - Booking section: site, date, hours, pricing table
  - Payment Schedule: milestones with amounts and paid/unpaid status
  - Actions bar:
    - "Send to Client" (if draft): opens SendContractDialog
    - "Download PDF": link to signed URL from latest contract_version storage_path
    - "Copy Signing Link": clipboard copy of shareable URL
    - "Terminate": confirm dialog, sets status to terminated with reason
    - "Create Amendment": creates new version, sets status to amended (links to create page with pre-filled data)
- Right sidebar:
  - Status Timeline: Vertical timeline of contract_events ordered by created_at DESC
    - Each event: icon, label (status_change, email_sent, email_opened, signature_captured), timestamp
    - Color-coded by event type
  - Version History: List of contract_versions
    - Each: "Version {N}" + generated_at + changes description + download link
    - Signed versions show signature indicator
  - Signature section (if signed):
    - Display signature image (from contract_version.client_signature_data base64)
    - Signed by: name, email
    - Signed at: timestamp
    - IP address (for audit)

**web/app/(dashboard)/contracts/[id]/page.tsx** — Server component:
- Route params: { id } (contract UUID)
- Fetch contract using getContractById(id)
- If not found: redirect to /contracts or show 404
- Render ContractDetail component
- Page title: "Agreement {contractNumber}"
- Breadcrumb: Dashboard > Contracts > {contractNumber}

**web/components/contracts/template-manager.tsx** — 'use client' component:
- Props: `{ templates: ContractTemplate[] }`
- List of templates as cards:
  - Template name, description, version number, status (active/archived), is_default badge
  - "Edit" button -> expands inline editor
  - "Archive" button -> sets status to 'archived'
  - "Set as Default" button -> sets is_default to true (unsets others)
- Inline editor for each template:
  - Name input
  - Description textarea
  - Clauses editor: Ordered list of { title, body } fields
    - Add clause button
    - Remove clause button
    - Reorder (up/down buttons)
  - Terms and Conditions textarea
  - Cancellation Policy textarea
  - "Save" button -> POST to /api/contracts/templates with template data
    - On save: increment version, keep old data as implicit version history
  - "Cancel" button -> collapse editor
- "Create New Template" button at top
- API route for template CRUD: Create inline route at web/app/api/contracts/templates/route.ts
  - GET: fetch all templates
  - POST: create new template
  - PUT: update existing template (body includes template id)
  - DELETE: archive template (soft delete)

**web/app/(dashboard)/contracts/templates/page.tsx** — Server component:
- Fetch templates using getContractTemplates()
- Render TemplateManager component
- Page title: "Agreement Templates"
- Breadcrumb: Dashboard > Contracts > Templates
- "Create Template" and "Back to Contracts" links
  </action>
  <verify>
Run: `ls "web/app/(dashboard)/contracts/[id]/"` to verify detail page exists.
Run: `ls "web/app/(dashboard)/contracts/templates/"` to verify templates page.
Run: `ls web/app/api/contracts/templates/` to verify API route.
Run: `cd /Users/sabineresoagli/GitHub/sitemedic/web && pnpm build 2>&1 | tail -10` to verify build.
  </verify>
  <done>
Contract detail page shows full info, status timeline, version history, signature display, and action buttons. Template manager allows CRUD on contract templates with clause editing. All pages follow existing dashboard patterns.
  </done>
</task>

</tasks>

<verification>
1. Contracts list page shows all contracts with status badges and filters
2. Contract detail page shows full info with timeline, versions, and actions
3. Template manager allows create, edit, archive, set default
4. Navigation links added to dashboard sidebar
5. 60-second polling for near-real-time updates
6. Build passes with no TypeScript errors
</verification>

<success_criteria>
- Admin can see all contracts at a glance with status (Draft/Sent/Viewed/Signed/Completed)
- Admin can click into contract for full detail with audit trail and version history
- Admin can manage templates (create, edit clauses, set default, archive)
- Contract actions (Send, Download, Copy Link, Terminate) work from detail page
- Status timeline shows chronological event history
</success_criteria>

<output>
After completion, create `.planning/phases/04.6-customer-onboarding-contract-management/04.6-06-SUMMARY.md`
</output>
