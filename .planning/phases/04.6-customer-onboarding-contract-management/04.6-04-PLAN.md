---
phase: 04.6-customer-onboarding-contract-management
plan: 04
type: execute
wave: 2
depends_on: ["04.6-01"]
files_modified:
  - web/components/contracts/payment-terms-select.tsx
  - web/components/contracts/contract-preview.tsx
  - web/components/contracts/create-contract-form.tsx
  - web/app/(dashboard)/contracts/create/page.tsx
  - web/app/api/contracts/create/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can select payment terms per booking from 5 options (full prepay, split 50/50, split 50/Net30, full Net30, custom)"
    - "Payment terms in agreement update based on selection with correct GBP amounts"
    - "Admin can create contract from booking with all fields auto-filled"
  artifacts:
    - path: "web/components/contracts/payment-terms-select.tsx"
      provides: "Payment terms radio selector with live amount preview"
      contains: "PaymentTermsSelect"
    - path: "web/components/contracts/create-contract-form.tsx"
      provides: "Contract creation form with booking selection and payment terms"
      contains: "CreateContractForm"
    - path: "web/app/api/contracts/create/route.ts"
      provides: "API endpoint to create contract record in database"
      exports: ["POST"]
  key_links:
    - from: "web/components/contracts/create-contract-form.tsx"
      to: "web/lib/contracts/payment-schedules.ts"
      via: "imports calculatePaymentSchedule for live preview"
      pattern: "import.*calculatePaymentSchedule"
    - from: "web/app/api/contracts/create/route.ts"
      to: "supabase/functions/generate-contract-pdf"
      via: "calls Edge Function to generate initial PDF"
      pattern: "generate-contract-pdf"
---

<objective>
Create the admin-facing contract creation UI with booking selection, payment terms selector, contract preview, and API endpoint for persisting contracts.

Purpose: This is the admin's workflow for generating contracts. During or after a phone call with a client, the admin selects a booking, chooses payment terms, previews the contract, and creates it (status: draft). The payment terms selector shows real-time amount breakdowns for each option, and filters options based on client eligibility (prepay clients can't select Net 30 terms).

Output: Payment terms selector component, contract creation form, preview component, dashboard page at /contracts/create, and API route for creating contracts.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@web/lib/contracts/types.ts
@web/lib/contracts/workflow.ts
@web/lib/contracts/payment-schedules.ts
@.planning/phases/04.6-customer-onboarding-contract-management/04.6-RESEARCH.md
@.planning/phases/04.5-marketing-booking/04.5-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment terms selector and contract preview components</name>
  <files>
    web/components/contracts/payment-terms-select.tsx
    web/components/contracts/contract-preview.tsx
  </files>
  <action>
**web/components/contracts/payment-terms-select.tsx** — 'use client' component:
Follow the pattern from Research Example 3 (payment-terms-select.tsx).
- Props: `{ total: number; clientPaymentTerms: 'prepay' | 'net_30'; onSelect: (terms: PaymentTerms, schedule: PaymentSchedule) => void; initialTerms?: PaymentTerms }`
- Import PAYMENT_TERMS_OPTIONS and calculatePaymentSchedule from '@/lib/contracts/payment-schedules'
- Use shadcn RadioGroup with RadioGroupItem for each option
- Filter available options based on clientPaymentTerms:
  - 'prepay' clients: only full_prepay and split_50_50 (no Net 30 options)
  - 'net_30' clients: all 5 options
- Each option card shows:
  - Radio button + label (description from PAYMENT_TERMS_OPTIONS)
  - Below label: live breakdown showing GBP amounts (e.g., "Upfront: £500.00", "On Completion: £500.00")
  - Use calculatePaymentSchedule(total, terms) for each option's amounts
- When 'custom' selected, show 3 number inputs: upfrontAmount, completionAmount, net30Amount
  - Validate custom amounts sum to total (show error if not)
- Amber info box for prepay clients: "This client is on prepay terms. Net 30 options require upgrading to Net 30 status."
- Call onSelect whenever selection changes with the PaymentTerms value and computed PaymentSchedule

**web/components/contracts/contract-preview.tsx** — 'use client' component:
- Props: `{ contractData: Partial<ContractData>; isLoading?: boolean }`
- Render a simplified preview of what the PDF will look like in HTML:
  - Header: "SERVICE AGREEMENT PREVIEW" with draft watermark styling
  - Parties: Provider and Client sections
  - Site Details section
  - Booking Details section
  - Pricing Table (HTML table matching PDF layout)
  - Payment Schedule section with milestone table
  - Signature block placeholder
- Use Tailwind prose-like styling with border, padding, max-w-3xl
- Show skeleton loading state when isLoading is true
- "Draft Preview" watermark text diagonally across the preview (using CSS transform or opacity)
  </action>
  <verify>
Run: `ls web/components/contracts/` to verify files exist.
Run: `grep "calculatePaymentSchedule" web/components/contracts/payment-terms-select.tsx` confirms import.
Run: `grep "RadioGroup" web/components/contracts/payment-terms-select.tsx` confirms shadcn usage.
  </verify>
  <done>
PaymentTermsSelect shows 5 options with live GBP amounts, filters by client eligibility, and validates custom terms. ContractPreview renders draft preview matching PDF layout with all sections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create contract creation form, dashboard page, and API route</name>
  <files>
    web/components/contracts/create-contract-form.tsx
    web/app/(dashboard)/contracts/create/page.tsx
    web/app/api/contracts/create/route.ts
  </files>
  <action>
**web/components/contracts/create-contract-form.tsx** — 'use client' component:
- Props: `{ bookings: BookingWithClient[]; templates: ContractTemplate[] }`
  - BookingWithClient = booking joined with client data
- State: selectedBookingId, selectedTemplateId, selectedPaymentTerms, paymentSchedule, isCreating, error, previewData
- Step 1 — Select Booking:
  - Dropdown/select of bookings that don't have an existing contract (filter out bookings with status != 'pending' or 'confirmed')
  - When booking selected, auto-fill client info, site details, pricing breakdown
  - Show client payment_terms status (prepay/net_30) badge
- Step 2 — Select Template:
  - Dropdown of active templates (from contract_templates where status='active')
  - Default to template where is_default=true
- Step 3 — Select Payment Terms:
  - Render PaymentTermsSelect component with booking total and client payment_terms
  - Live update paymentSchedule state
- Step 4 — Preview:
  - Render ContractPreview component with all assembled data
  - "Create Draft" button (primary, disabled until all steps complete)
- On "Create Draft" click:
  - POST to /api/contracts/create with { bookingId, templateId, paymentTerms, paymentSchedule, customTermsDescription? }
  - On success: redirect to /contracts (admin contracts list) with success toast/message
  - On error: show error message

**web/app/(dashboard)/contracts/create/page.tsx** — Server component:
- Fetch pending/confirmed bookings without existing contracts:
  ```sql
  SELECT b.*, c.company_name, c.contact_name, c.payment_terms, c.billing_address
  FROM bookings b
  JOIN clients c ON b.client_id = c.id
  WHERE b.status IN ('pending', 'confirmed')
  AND b.id NOT IN (SELECT booking_id FROM contracts WHERE status != 'terminated')
  ORDER BY b.shift_date ASC
  ```
- Fetch active contract templates: `SELECT * FROM contract_templates WHERE status = 'active' ORDER BY is_default DESC, name ASC`
- Render CreateContractForm with fetched data
- Page title: "Create Service Agreement"
- Breadcrumb: Dashboard > Contracts > Create

**web/app/api/contracts/create/route.ts** — POST endpoint:
- Accept: { bookingId, templateId, paymentTerms, customTermsDescription?, upfrontAmount?, completionAmount?, net30Amount? }
- Validate required fields
- Fetch booking with client data to verify it exists
- Calculate payment schedule amounts (use calculatePaymentSchedule or custom amounts)
- Generate shareable_token: crypto.randomUUID()
- Insert into contracts table:
  - booking_id, client_id (from booking), template_id, status='draft', payment_terms
  - upfront_amount, completion_amount, net30_amount from schedule
  - custom_terms_description (if custom)
  - requires_signature_before_booking = true (default)
  - shareable_token
  - created_by = authenticated user ID
- Insert into contract_versions table:
  - contract_id, version=1, storage_path='contracts/{contractId}/v1.pdf'
  - generated_at=now(), generated_by=authenticated user
- Update contracts.current_version_id to the new version ID
- Call generate-contract-pdf Edge Function to generate initial PDF
- Upload PDF to Supabase Storage at contracts/{contractId}/v1.pdf
- Insert contract_event: event_type='version_created', event_data={ version: 1 }
- Return { success: true, contract: { id, shareable_token, status } }
  </action>
  <verify>
Run: `ls "web/app/(dashboard)/contracts/create/"` to verify page exists.
Run: `ls web/app/api/contracts/create/` to verify API route exists.
Run: `cd /Users/sabineresoagli/GitHub/sitemedic/web && pnpm build 2>&1 | tail -10` to verify build succeeds.
  </verify>
  <done>
Admin can select booking, choose template, configure payment terms with live preview, and create draft contract. API route creates database records, generates PDF via Edge Function, and stores in Supabase Storage. Contract receives unique shareable_token for client signing link.
  </done>
</task>

</tasks>

<verification>
1. PaymentTermsSelect renders 5 options with correct GBP amounts
2. Prepay clients only see full_prepay and split_50_50 options
3. ContractPreview shows all contract sections matching PDF layout
4. Create form auto-fills all fields from selected booking
5. API route creates contract, version, event, generates PDF, uploads to Storage
6. Build passes with no TypeScript errors
</verification>

<success_criteria>
- Admin creates contract from booking in <2 minutes (select booking, pick terms, create)
- Payment terms show correct amounts for each option type
- Net 30 options hidden for prepay clients
- Draft contract created with PDF in Storage and shareable token generated
- Contract record in database with correct payment schedule amounts
</success_criteria>

<output>
After completion, create `.planning/phases/04.6-customer-onboarding-contract-management/04.6-04-SUMMARY.md`
</output>
