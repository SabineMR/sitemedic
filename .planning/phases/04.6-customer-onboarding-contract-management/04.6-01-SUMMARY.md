---
phase: 04.6-customer-onboarding-contract-management
plan: 01
subsystem: database, contracts
tags: postgres, typescript, state-machine, payment-schedules, contract-lifecycle

# Dependency graph
requires:
  - phase: 02-mobile-core
    provides: bookings and clients tables from 002_business_operations.sql
provides:
  - Database schema for contract management (4 tables + storage bucket)
  - TypeScript types for contracts, versions, events, payment schedules
  - Contract state machine with transition validation
  - Payment schedule calculation for all 5 term types
affects: [04.6-02, 04.6-03, 04.6-04, contract-management, pdf-generation, booking-flow]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Contract state machine (9 states with validated transitions)
    - Payment schedule calculator (5 term types: full_prepay, split_50_50, split_50_net30, full_net30, custom)

key-files:
  created:
    - supabase/migrations/017_contract_management.sql
    - web/lib/contracts/types.ts
    - web/lib/contracts/workflow.ts
    - web/lib/contracts/payment-schedules.ts
  modified: []

key-decisions:
  - "Contract lifecycle follows 9-state machine: draft -> sent -> viewed -> signed -> completed -> active -> fulfilled (with amended and terminated as alternative terminal states)"
  - "Payment terms support 5 types with Net 30 eligibility check based on client payment_terms field"
  - "Contract versions are immutable PDFs stored in dedicated storage bucket with 10MB limit"
  - "All contract events logged to contract_events table for audit trail"

patterns-established:
  - "State machine pattern: VALID_TRANSITIONS record with canTransition() validator"
  - "Payment calculation: calculatePaymentSchedule() with GBP formatting and custom term validation"
  - "Audit logging: contract_events table with flexible JSONB event_data payload"

# Metrics
duration: 2min
completed: 2026-02-16
---

# Phase 4.6 Plan 01: Contract Management Foundation Summary

**Database schema with 4 tables (templates, contracts, versions, events), state machine for 9-state lifecycle transitions, and payment schedule calculator for 5 term types with GBP formatting**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-16T18:57:05Z
- **Completed:** 2026-02-16T18:59:54Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Created contract management database schema (4 tables + storage bucket) with proper FKs and indexes
- Implemented TypeScript types mirroring database schema with helper interfaces for PDF generation
- Built contract state machine validating transitions across 9 lifecycle states
- Created payment schedule calculator supporting all 5 payment term types with Net 30 eligibility checks

## Task Commits

Each task was committed atomically:

1. **Task 1: Create database migration for contract management tables** - `7e8b7a1` (feat)
   - Created migration 017 with contract_templates, contracts, contract_versions, contract_events tables
   - Added storage bucket 'contracts' with PDF-only mime type and RLS policies
   - Implemented update triggers for updated_at timestamps

2. **Task 2: Create TypeScript types, state machine, and payment schedule logic** - `902528d` (feat)
   - Created types.ts with 9 interfaces mirroring database schema
   - Implemented workflow.ts with VALID_TRANSITIONS record and canTransition() validator
   - Built payment-schedules.ts with calculatePaymentSchedule() for all 5 term types

## Files Created/Modified

**Created:**
- `supabase/migrations/017_contract_management.sql` - Database schema for contract lifecycle management
- `web/lib/contracts/types.ts` - TypeScript interfaces for contracts, versions, events, payment schedules
- `web/lib/contracts/workflow.ts` - State machine with transition validation and status metadata
- `web/lib/contracts/payment-schedules.ts` - Payment schedule calculator with GBP formatting

## Decisions Made

1. **Contract lifecycle uses 9-state machine**
   - Rationale: Provides granular tracking of client interaction (sent -> viewed -> signed) while supporting amendments and termination at any point

2. **Payment terms support 5 types with Net 30 eligibility**
   - Rationale: Flexible payment options (full_prepay, split_50_50, split_50_net30, full_net30, custom) with client-level eligibility check based on payment_terms field

3. **Contract versions are immutable with signature capture**
   - Rationale: Legal requirement for audit trail - each version stored as PDF with optional signature data and IP address tracking

4. **Storage bucket 'contracts' enforces PDF-only with 10MB limit**
   - Rationale: Security (restrict to application/pdf mime type) and performance (prevent large file uploads)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed successfully with TypeScript compilation passing.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for next plans:**
- Database schema deployed and ready for contract CRUD operations
- TypeScript types exported and available for UI components
- State machine ready for workflow enforcement
- Payment schedule calculator ready for booking integration

**Next steps (04.6-02):**
- Implement contract API endpoints (create, read, update, transition)
- Add contract generation from booking data
- Build shareable signing link functionality

**No blockers or concerns.**

---
*Phase: 04.6-customer-onboarding-contract-management*
*Completed: 2026-02-16*
