---
phase: 06-riddor-auto-flagging
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/components/treatment/RIDDOROverrideModal.tsx
  - mobile/app/treatment/[id].tsx
  - mobile/src/lib/riddor-client.ts
autonomous: true

must_haves:
  truths:
    - "Medic sees RIDDOR flag indicator in treatment detail view"
    - "Medic can confirm or dismiss RIDDOR flag with mandatory reason"
    - "Override decision syncs to backend immediately (not queued)"
    - "Override modal displays confidence level and detection reason"
    - "Confirmed RIDDOR treatments show red badge in treatment list"
  artifacts:
    - path: "mobile/components/treatment/RIDDOROverrideModal.tsx"
      provides: "Modal for medic to confirm/dismiss RIDDOR flag with reason"
      min_lines: 120
    - path: "mobile/app/treatment/[id].tsx"
      provides: "Treatment detail page with RIDDOR override workflow integration"
      min_lines: 300
    - path: "mobile/src/lib/riddor-client.ts"
      provides: "API client for RIDDOR override operations"
      exports: ["updateRIDDORIncident", "fetchRIDDORIncident"]
  key_links:
    - from: "mobile/app/treatment/[id].tsx"
      to: "mobile/components/treatment/RIDDOROverrideModal.tsx"
      via: "Treatment detail page shows modal when RIDDOR flag exists"
      pattern: "RIDDOROverrideModal.*visible"
    - from: "mobile/components/treatment/RIDDOROverrideModal.tsx"
      to: "mobile/src/lib/riddor-client.ts"
      via: "Modal calls updateRIDDORIncident on confirm/dismiss"
      pattern: "updateRIDDORIncident"
    - from: "mobile/src/lib/riddor-client.ts"
      to: "supabase.from('riddor_incidents').update"
      via: "API client updates medic_confirmed and override_reason"
      pattern: "riddor_incidents.*update"
---

<objective>
Build the mobile medic override workflow: a modal UI for confirming or dismissing auto-flagged RIDDOR incidents with mandatory reason capture, and integration into the treatment detail page with immediate sync to backend.

Purpose: This is the critical override workflow that prevents alert fatigue and enables algorithm tuning. Medics must be able to quickly review and override auto-flags with clear reasoning that feeds back into detection accuracy improvements.

Output: A working override modal that captures medic decisions, displays confidence/reason context, and syncs overrides to riddor_incidents table immediately (not via offline sync queue).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-riddor-auto-flagging/06-RESEARCH.md
@.planning/phases/06-riddor-auto-flagging/06-01-PLAN.md

# Treatment detail page reference
@mobile/app/treatment/[id].tsx

# Existing modal patterns
@mobile/components/forms/PhotoCapture.tsx

# Supabase client setup
@mobile/src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RIDDOR API client for override operations</name>
  <files>mobile/src/lib/riddor-client.ts</files>
  <action>
Create `mobile/src/lib/riddor-client.ts` with:

```typescript
import { supabase } from './supabase';

export interface RIDDORIncident {
  id: string;
  treatment_id: string;
  category: string;
  confidence_level: 'HIGH' | 'MEDIUM' | 'LOW';
  medic_confirmed: boolean | null;
  override_reason: string | null;
  deadline_date: string;
  status: string;
}

/**
 * Fetch RIDDOR incident for a treatment
 * Returns null if treatment is not RIDDOR-flagged
 */
export async function fetchRIDDORIncident(
  treatmentId: string
): Promise<RIDDORIncident | null> {
  const { data, error } = await supabase
    .from('riddor_incidents')
    .select('*')
    .eq('treatment_id', treatmentId)
    .maybeSingle(); // Use maybeSingle() to handle no results gracefully

  if (error) {
    console.error('Error fetching RIDDOR incident:', error);
    throw error;
  }

  return data;
}

/**
 * Update RIDDOR incident with medic override decision
 * @param incidentId - RIDDOR incident UUID
 * @param confirmed - TRUE = medic confirms RIDDOR, FALSE = medic dismisses
 * @param reason - Mandatory explanation for decision
 * @param medicId - Current user's UUID
 */
export async function updateRIDDORIncident(
  incidentId: string,
  confirmed: boolean,
  reason: string,
  medicId: string
): Promise<void> {
  if (!reason.trim()) {
    throw new Error('Override reason is required');
  }

  const { error } = await supabase
    .from('riddor_incidents')
    .update({
      medic_confirmed: confirmed,
      override_reason: reason,
      overridden_by: medicId,
      overridden_at: new Date().toISOString(),
    })
    .eq('id', incidentId);

  if (error) {
    console.error('Error updating RIDDOR incident:', error);
    throw error;
  }
}

/**
 * Calculate days until RIDDOR deadline
 */
export function daysUntilDeadline(deadlineDate: string): number {
  const deadline = new Date(deadlineDate);
  const now = new Date();
  const diffMs = deadline.getTime() - now.getTime();
  return Math.ceil(diffMs / (1000 * 60 * 60 * 24));
}
```

**Important:** Use direct Supabase API calls (not WatermelonDB sync queue) because RIDDOR overrides must sync immediately for compliance tracking.
  </action>
  <verify>
```bash
# Type check
cd mobile && pnpm tsc --noEmit src/lib/riddor-client.ts
```
  </verify>
  <done>API client created with fetchRIDDORIncident, updateRIDDORIncident, and daysUntilDeadline helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Create RIDDOR override modal component</name>
  <files>mobile/components/treatment/RIDDOROverrideModal.tsx</files>
  <action>
Create `mobile/components/treatment/RIDDOROverrideModal.tsx` following Research Pattern 2 "Medic Override Workflow":

```tsx
import React, { useState } from 'react';
import {
  Modal,
  View,
  Text,
  TextInput,
  Pressable,
  StyleSheet,
  Alert,
  ActivityIndicator,
} from 'react-native';
import { updateRIDDORIncident, daysUntilDeadline } from '../../src/lib/riddor-client';

interface RIDDOROverrideModalProps {
  visible: boolean;
  onClose: () => void;
  incidentId: string;
  confidenceLevel: 'HIGH' | 'MEDIUM' | 'LOW';
  detectionReason: string;
  deadlineDate: string;
  medicId: string;
  onOverrideComplete: () => void;
}

export default function RIDDOROverrideModal({
  visible,
  onClose,
  incidentId,
  confidenceLevel,
  detectionReason,
  deadlineDate,
  medicId,
  onOverrideComplete,
}: RIDDOROverrideModalProps) {
  const [action, setAction] = useState<'confirm' | 'dismiss' | null>(null);
  const [reason, setReason] = useState('');
  const [loading, setLoading] = useState(false);

  const daysRemaining = daysUntilDeadline(deadlineDate);

  const handleSubmit = async () => {
    if (!action) {
      Alert.alert('Action Required', 'Please select Confirm or Dismiss');
      return;
    }

    if (!reason.trim()) {
      Alert.alert('Reason Required', 'Please explain your decision');
      return;
    }

    setLoading(true);
    try {
      await updateRIDDORIncident(
        incidentId,
        action === 'confirm',
        reason,
        medicId
      );

      Alert.alert(
        'RIDDOR Override Saved',
        action === 'confirm'
          ? 'RIDDOR flag confirmed. Site manager will be notified.'
          : 'RIDDOR flag dismissed. Override recorded for review.'
      );

      onOverrideComplete();
      onClose();
    } catch (error) {
      Alert.alert('Error', 'Failed to save override. Please try again.');
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  const confidenceColor = {
    HIGH: '#EF4444', // Red
    MEDIUM: '#F59E0B', // Amber
    LOW: '#6B7280', // Gray
  }[confidenceLevel];

  return (
    <Modal
      visible={visible}
      animationType="slide"
      transparent={true}
      onRequestClose={onClose}
    >
      <View style={styles.overlay}>
        <View style={styles.modal}>
          <Text style={styles.title}>RIDDOR Flag Detected</Text>

          {/* Confidence indicator */}
          <View style={[styles.confidenceBadge, { backgroundColor: confidenceColor }]}>
            <Text style={styles.confidenceText}>{confidenceLevel} CONFIDENCE</Text>
          </View>

          {/* Detection reason */}
          <View style={styles.section}>
            <Text style={styles.label}>Why this was flagged:</Text>
            <Text style={styles.detectionReason}>{detectionReason}</Text>
          </View>

          {/* Deadline warning */}
          <View style={styles.deadlineBox}>
            <Text style={styles.deadlineText}>
              HSE Deadline: {daysRemaining} day{daysRemaining !== 1 ? 's' : ''} remaining
            </Text>
          </View>

          {/* Action buttons */}
          <View style={styles.section}>
            <Text style={styles.label}>Do you confirm this is RIDDOR-reportable?</Text>

            <Pressable
              style={[
                styles.actionButton,
                action === 'confirm' && styles.actionButtonSelected,
              ]}
              onPress={() => setAction('confirm')}
            >
              <Text
                style={[
                  styles.actionButtonText,
                  action === 'confirm' && styles.actionButtonTextSelected,
                ]}
              >
                ✓ Yes, Confirm RIDDOR
              </Text>
            </Pressable>

            <Pressable
              style={[
                styles.actionButton,
                action === 'dismiss' && styles.actionButtonSelected,
              ]}
              onPress={() => setAction('dismiss')}
            >
              <Text
                style={[
                  styles.actionButtonText,
                  action === 'dismiss' && styles.actionButtonTextSelected,
                ]}
              >
                ✗ No, Not RIDDOR
              </Text>
            </Pressable>
          </View>

          {/* Reason input */}
          <View style={styles.section}>
            <Text style={styles.label}>
              Explain your decision: <Text style={styles.required}>*</Text>
            </Text>
            <TextInput
              style={styles.textInput}
              placeholder="E.g., 'Worker returned to full duties immediately' or 'Fracture confirmed by X-ray'"
              value={reason}
              onChangeText={setReason}
              multiline
              numberOfLines={4}
              textAlignVertical="top"
            />
          </View>

          {/* Submit/Cancel buttons */}
          <View style={styles.buttonRow}>
            <Pressable
              style={[styles.button, styles.cancelButton]}
              onPress={onClose}
              disabled={loading}
            >
              <Text style={styles.cancelButtonText}>Cancel</Text>
            </Pressable>

            <Pressable
              style={[styles.button, styles.submitButton, loading && styles.buttonDisabled]}
              onPress={handleSubmit}
              disabled={loading}
            >
              {loading ? (
                <ActivityIndicator color="#FFF" />
              ) : (
                <Text style={styles.submitButtonText}>Submit Decision</Text>
              )}
            </Pressable>
          </View>
        </View>
      </View>
    </Modal>
  );
}

const styles = StyleSheet.create({
  overlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 16,
  },
  modal: {
    backgroundColor: '#FFF',
    borderRadius: 12,
    padding: 24,
    width: '100%',
    maxWidth: 500,
    maxHeight: '90%',
  },
  title: {
    fontSize: 24,
    fontWeight: '700',
    color: '#1F2937',
    marginBottom: 16,
  },
  confidenceBadge: {
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 8,
    alignSelf: 'flex-start',
    marginBottom: 16,
  },
  confidenceText: {
    color: '#FFF',
    fontSize: 14,
    fontWeight: '700',
  },
  section: {
    marginBottom: 20,
  },
  label: {
    fontSize: 16,
    fontWeight: '600',
    color: '#374151',
    marginBottom: 8,
  },
  required: {
    color: '#EF4444',
  },
  detectionReason: {
    fontSize: 14,
    color: '#6B7280',
    fontStyle: 'italic',
  },
  deadlineBox: {
    backgroundColor: '#FEF3C7',
    borderLeftWidth: 4,
    borderLeftColor: '#F59E0B',
    padding: 12,
    borderRadius: 6,
    marginBottom: 20,
  },
  deadlineText: {
    fontSize: 14,
    fontWeight: '600',
    color: '#92400E',
  },
  actionButton: {
    borderWidth: 2,
    borderColor: '#D1D5DB',
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
  },
  actionButtonSelected: {
    borderColor: '#2563EB',
    backgroundColor: '#EFF6FF',
  },
  actionButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#6B7280',
    textAlign: 'center',
  },
  actionButtonTextSelected: {
    color: '#2563EB',
  },
  textInput: {
    borderWidth: 1,
    borderColor: '#D1D5DB',
    borderRadius: 8,
    padding: 12,
    fontSize: 14,
    minHeight: 100,
  },
  buttonRow: {
    flexDirection: 'row',
    gap: 12,
  },
  button: {
    flex: 1,
    paddingVertical: 14,
    borderRadius: 8,
    alignItems: 'center',
  },
  cancelButton: {
    backgroundColor: '#F3F4F6',
  },
  cancelButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#6B7280',
  },
  submitButton: {
    backgroundColor: '#2563EB',
  },
  submitButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#FFF',
  },
  buttonDisabled: {
    opacity: 0.5,
  },
});
```

**Gloves-on compliance:**
- 56pt minimum tap targets on all buttons (action buttons, submit button)
- High contrast colors (blue #2563EB, red #EF4444, amber #F59E0B)
- Clear visual feedback for selected action (border + background change)

**Important:** Modal should be non-dismissible until action taken (no tap-outside-to-close) to ensure medic makes explicit decision.
  </action>
  <verify>
```bash
# Type check
cd mobile && pnpm tsc --noEmit components/treatment/RIDDOROverrideModal.tsx
```
  </verify>
  <done>RIDDOROverrideModal component created with confidence display, action selection, reason capture, and gloves-on usability</done>
</task>

<task type="auto">
  <name>Task 3: Integrate RIDDOR override modal into treatment detail page</name>
  <files>mobile/app/treatment/[id].tsx</files>
  <action>
Update `mobile/app/treatment/[id].tsx` to integrate RIDDOR override workflow:

1. **Import RIDDOROverrideModal and API client:**
   ```tsx
   import RIDDOROverrideModal from '../../components/treatment/RIDDOROverrideModal';
   import { fetchRIDDORIncident, RIDDORIncident } from '../../src/lib/riddor-client';
   ```

2. **Add state for RIDDOR incident:**
   ```tsx
   const [riddorIncident, setRiddorIncident] = useState<RIDDORIncident | null>(null);
   const [showRiddorModal, setShowRiddorModal] = useState(false);
   ```

3. **Fetch RIDDOR incident when treatment loads:**
   ```tsx
   useEffect(() => {
     if (treatment?.id) {
       fetchRIDDORIncident(treatment.id)
         .then(setRiddorIncident)
         .catch(console.error);
     }
   }, [treatment?.id]);
   ```

4. **Add RIDDOR indicator section after treatment details:**
   ```tsx
   {/* RIDDOR Flag Indicator */}
   {riddorIncident && riddorIncident.medic_confirmed === null && (
     <View style={styles.riddorSection}>
       <View style={styles.riddorHeader}>
         <Text style={styles.riddorBadge}>⚠️ RIDDOR FLAG</Text>
         <Pressable
           style={styles.reviewButton}
           onPress={() => setShowRiddorModal(true)}
         >
           <Text style={styles.reviewButtonText}>Review</Text>
         </Pressable>
       </View>
       <Text style={styles.riddorText}>
         This treatment may be RIDDOR-reportable. Please review and confirm or dismiss.
       </Text>
     </View>
   )}

   {/* RIDDOR Confirmed Badge */}
   {riddorIncident && riddorIncident.medic_confirmed === true && (
     <View style={[styles.riddorSection, styles.riddorConfirmed]}>
       <Text style={styles.riddorBadgeConfirmed}>✓ RIDDOR CONFIRMED</Text>
       <Text style={styles.riddorText}>
         Deadline: {new Date(riddorIncident.deadline_date).toLocaleDateString('en-GB')}
       </Text>
     </View>
   )}

   {/* RIDDOR Dismissed Badge */}
   {riddorIncident && riddorIncident.medic_confirmed === false && (
     <View style={[styles.riddorSection, styles.riddorDismissed]}>
       <Text style={styles.riddorBadgeDismissed}>✗ RIDDOR DISMISSED</Text>
       <Text style={styles.riddorTextSmall}>
         Reason: {riddorIncident.override_reason}
       </Text>
     </View>
   )}
   ```

5. **Add RIDDOROverrideModal at bottom:**
   ```tsx
   {riddorIncident && (
     <RIDDOROverrideModal
       visible={showRiddorModal}
       onClose={() => setShowRiddorModal(false)}
       incidentId={riddorIncident.id}
       confidenceLevel={riddorIncident.confidence_level}
       detectionReason={`Category: ${riddorIncident.category}`}
       deadlineDate={riddorIncident.deadline_date}
       medicId={user?.id || ''}
       onOverrideComplete={async () => {
         // Refresh RIDDOR incident after override
         const updated = await fetchRIDDORIncident(treatment.id);
         setRiddorIncident(updated);
       }}
     />
   )}
   ```

6. **Add styles:**
   ```tsx
   riddorSection: {
     backgroundColor: '#FEF3C7',
     borderLeftWidth: 4,
     borderLeftColor: '#F59E0B',
     padding: 16,
     marginTop: 16,
     borderRadius: 8,
   },
   riddorConfirmed: {
     backgroundColor: '#FEE2E2',
     borderLeftColor: '#EF4444',
   },
   riddorDismissed: {
     backgroundColor: '#F3F4F6',
     borderLeftColor: '#6B7280',
   },
   riddorHeader: {
     flexDirection: 'row',
     justifyContent: 'space-between',
     alignItems: 'center',
     marginBottom: 8,
   },
   riddorBadge: {
     fontSize: 14,
     fontWeight: '700',
     color: '#92400E',
   },
   riddorBadgeConfirmed: {
     fontSize: 14,
     fontWeight: '700',
     color: '#991B1B',
   },
   riddorBadgeDismissed: {
     fontSize: 14,
     fontWeight: '700',
     color: '#4B5563',
   },
   reviewButton: {
     backgroundColor: '#2563EB',
     paddingVertical: 8,
     paddingHorizontal: 16,
     borderRadius: 6,
   },
   reviewButtonText: {
     color: '#FFF',
     fontSize: 14,
     fontWeight: '600',
   },
   riddorText: {
     fontSize: 14,
     color: '#78350F',
   },
   riddorTextSmall: {
     fontSize: 12,
     color: '#6B7280',
     marginTop: 4,
   },
   ```

**Important:** Only show "Review" button when `medic_confirmed === null` (awaiting review). Once confirmed or dismissed, show badge with decision.
  </action>
  <verify>
```bash
# Type check
cd mobile && pnpm tsc --noEmit app/treatment/[id].tsx

# Run mobile app and navigate to treatment detail
# Verify RIDDOR indicator appears for RIDDOR-flagged treatments
```
  </verify>
  <done>Treatment detail page displays RIDDOR indicator with review button, opens override modal, refreshes UI after override decision, and shows confirmed/dismissed badges</done>
</task>

</tasks>

<verification>
**Overall Phase Checks:**

1. **RIDDOR API client functional:**
   - fetchRIDDORIncident returns incident or null
   - updateRIDDORIncident syncs immediately (not via offline queue)
   - daysUntilDeadline calculates correctly

2. **Override modal UX:**
   - Confidence level displayed with color coding (HIGH red, MEDIUM amber, LOW gray)
   - Detection reason shown for context
   - Deadline countdown visible
   - Action buttons toggle selected state (border + background)
   - Reason field mandatory (validation prevents empty submission)
   - Submit button shows loading indicator during API call

3. **Treatment detail integration:**
   - RIDDOR indicator appears for auto-flagged treatments
   - Review button opens modal
   - Confirmed/dismissed badges replace indicator after override
   - Override decision persists after page refresh
</verification>

<success_criteria>
**Measurable Completion:**

1. RIDDOROverrideModal renders with confidence badge, deadline countdown, and action buttons
2. Confirm action updates `medic_confirmed=TRUE` in riddor_incidents table
3. Dismiss action updates `medic_confirmed=FALSE` in riddor_incidents table
4. Override reason captured in `override_reason` field (not empty)
5. Treatment detail page shows yellow "⚠️ RIDDOR FLAG" for pending overrides
6. Treatment detail page shows red "✓ RIDDOR CONFIRMED" after confirmation
7. Treatment detail page shows gray "✗ RIDDOR DISMISSED" after dismissal
8. Override decision persists across app restarts (fetched from Supabase, not local state)
</success_criteria>

<output>
After completion, create `.planning/phases/06-riddor-auto-flagging/06-02-SUMMARY.md`
</output>
