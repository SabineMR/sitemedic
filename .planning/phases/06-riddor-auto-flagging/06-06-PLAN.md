---
phase: 06-riddor-auto-flagging
plan: 06
type: execute
wave: 3
depends_on: [06-02, 06-04]
files_modified:
  - web/app/(dashboard)/riddor/analytics/page.tsx
  - web/lib/queries/riddor-analytics.ts
  - web/components/riddor/OverridePatternChart.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view override rate by confidence level (HIGH/MEDIUM/LOW)"
    - "Admin can see most common override reasons for dismissed flags"
    - "Admin can view override rate trend over time (last 30 days)"
    - "Dashboard shows alert when override rate exceeds 80% threshold"
    - "Analytics page shows total auto-flags, confirmed, dismissed, pending counts"
  artifacts:
    - path: "web/app/(dashboard)/riddor/analytics/page.tsx"
      provides: "RIDDOR analytics dashboard with override patterns"
      min_lines: 200
    - path: "web/lib/queries/riddor-analytics.ts"
      provides: "Queries for override statistics and pattern analysis"
      exports: ["fetchOverrideStats", "fetchOverrideReasons"]
    - path: "web/components/riddor/OverridePatternChart.tsx"
      provides: "Bar chart showing override rates by confidence level"
  key_links:
    - from: "web/app/(dashboard)/riddor/analytics/page.tsx"
      to: "web/lib/queries/riddor-analytics.ts"
      via: "Page fetches override statistics and reasons"
      pattern: "fetchOverrideStats"
    - from: "web/components/riddor/OverridePatternChart.tsx"
      to: "recharts"
      via: "Renders bar chart with override rate by confidence level"
      pattern: "BarChart.*recharts"
---

<objective>
Build the RIDDOR analytics dashboard for tracking override patterns, confidence level accuracy, and algorithm tuning recommendations. This enables continuous improvement of the detection algorithm by surfacing false positive patterns.

Purpose: This is the feedback loop for detection accuracy -- showing which confidence levels have high override rates (indicating false positives) and which override reasons are most common (indicating where detection rules need refinement).

Output: A working analytics dashboard showing override rates, common dismissal reasons, and alerts when override rates exceed 80% threshold (indicating algorithm needs review per Research guidance).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-riddor-auto-flagging/06-RESEARCH.md
@.planning/phases/06-riddor-auto-flagging/06-01-PLAN.md
@.planning/phases/06-riddor-auto-flagging/06-02-PLAN.md
@.planning/phases/06-riddor-auto-flagging/06-04-PLAN.md

# Existing analytics patterns
@web/app/(dashboard)/page.tsx

# Chart library reference
@web/app/(dashboard)/admin/revenue/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RIDDOR analytics queries</name>
  <files>web/lib/queries/riddor-analytics.ts</files>
  <action>
Create `web/lib/queries/riddor-analytics.ts`:

```typescript
import { supabase } from '@/lib/supabase/client';

export interface OverrideStats {
  totalAutoFlags: number;
  confirmed: number;
  dismissed: number;
  pending: number;
  overrideRate: number; // dismissed / (confirmed + dismissed) * 100
  highConfidenceOverrideRate: number;
  mediumConfidenceOverrideRate: number;
  lowConfidenceOverrideRate: number;
}

export interface OverrideReason {
  reason: string;
  count: number;
  percentage: number;
}

export interface ConfidenceLevelStats {
  confidenceLevel: 'HIGH' | 'MEDIUM' | 'LOW';
  totalFlags: number;
  confirmed: number;
  dismissed: number;
  pending: number;
  overrideRate: number; // dismissed / (confirmed + dismissed) * 100
}

/**
 * Fetch overall override statistics for org
 */
export async function fetchOverrideStats(orgId: string): Promise<OverrideStats> {
  const { data: incidents, error } = await supabase
    .from('riddor_incidents')
    .select('confidence_level, medic_confirmed')
    .eq('org_id', orgId)
    .eq('auto_flagged', true);

  if (error) throw error;

  if (!incidents || incidents.length === 0) {
    return {
      totalAutoFlags: 0,
      confirmed: 0,
      dismissed: 0,
      pending: 0,
      overrideRate: 0,
      highConfidenceOverrideRate: 0,
      mediumConfidenceOverrideRate: 0,
      lowConfidenceOverrideRate: 0,
    };
  }

  const totalAutoFlags = incidents.length;
  const confirmed = incidents.filter((i) => i.medic_confirmed === true).length;
  const dismissed = incidents.filter((i) => i.medic_confirmed === false).length;
  const pending = incidents.filter((i) => i.medic_confirmed === null).length;

  const overrideRate =
    confirmed + dismissed > 0 ? (dismissed / (confirmed + dismissed)) * 100 : 0;

  // Calculate override rate by confidence level
  const highConfidence = incidents.filter((i) => i.confidence_level === 'HIGH');
  const highDismissed = highConfidence.filter((i) => i.medic_confirmed === false).length;
  const highReviewed = highConfidence.filter((i) => i.medic_confirmed !== null).length;
  const highConfidenceOverrideRate =
    highReviewed > 0 ? (highDismissed / highReviewed) * 100 : 0;

  const mediumConfidence = incidents.filter((i) => i.confidence_level === 'MEDIUM');
  const mediumDismissed = mediumConfidence.filter((i) => i.medic_confirmed === false).length;
  const mediumReviewed = mediumConfidence.filter((i) => i.medic_confirmed !== null).length;
  const mediumConfidenceOverrideRate =
    mediumReviewed > 0 ? (mediumDismissed / mediumReviewed) * 100 : 0;

  const lowConfidence = incidents.filter((i) => i.confidence_level === 'LOW');
  const lowDismissed = lowConfidence.filter((i) => i.medic_confirmed === false).length;
  const lowReviewed = lowConfidence.filter((i) => i.medic_confirmed !== null).length;
  const lowConfidenceOverrideRate = lowReviewed > 0 ? (lowDismissed / lowReviewed) * 100 : 0;

  return {
    totalAutoFlags,
    confirmed,
    dismissed,
    pending,
    overrideRate: Math.round(overrideRate),
    highConfidenceOverrideRate: Math.round(highConfidenceOverrideRate),
    mediumConfidenceOverrideRate: Math.round(mediumConfidenceOverrideRate),
    lowConfidenceOverrideRate: Math.round(lowConfidenceOverrideRate),
  };
}

/**
 * Fetch confidence level breakdown
 */
export async function fetchConfidenceLevelStats(
  orgId: string
): Promise<ConfidenceLevelStats[]> {
  const { data: incidents, error } = await supabase
    .from('riddor_incidents')
    .select('confidence_level, medic_confirmed')
    .eq('org_id', orgId)
    .eq('auto_flagged', true);

  if (error) throw error;

  if (!incidents || incidents.length === 0) return [];

  const levels: ('HIGH' | 'MEDIUM' | 'LOW')[] = ['HIGH', 'MEDIUM', 'LOW'];

  return levels.map((level) => {
    const levelIncidents = incidents.filter((i) => i.confidence_level === level);
    const totalFlags = levelIncidents.length;
    const confirmed = levelIncidents.filter((i) => i.medic_confirmed === true).length;
    const dismissed = levelIncidents.filter((i) => i.medic_confirmed === false).length;
    const pending = levelIncidents.filter((i) => i.medic_confirmed === null).length;
    const reviewed = confirmed + dismissed;
    const overrideRate = reviewed > 0 ? (dismissed / reviewed) * 100 : 0;

    return {
      confidenceLevel: level,
      totalFlags,
      confirmed,
      dismissed,
      pending,
      overrideRate: Math.round(overrideRate),
    };
  });
}

/**
 * Fetch most common override reasons (dismissed flags only)
 */
export async function fetchOverrideReasons(orgId: string): Promise<OverrideReason[]> {
  const { data: incidents, error } = await supabase
    .from('riddor_incidents')
    .select('override_reason')
    .eq('org_id', orgId)
    .eq('medic_confirmed', false)
    .not('override_reason', 'is', null);

  if (error) throw error;

  if (!incidents || incidents.length === 0) return [];

  // Count occurrences of each reason
  const reasonCounts = incidents.reduce((acc, incident) => {
    const reason = incident.override_reason.trim();
    acc[reason] = (acc[reason] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  const total = incidents.length;

  // Sort by count descending
  return Object.entries(reasonCounts)
    .map(([reason, count]) => ({
      reason,
      count,
      percentage: Math.round((count / total) * 100),
    }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 10); // Top 10 reasons
}
```

**Important:** Override rate calculation uses `dismissed / (confirmed + dismissed)` to exclude pending reviews from denominator (only count reviewed incidents).
  </action>
  <verify>
```bash
# Type check
cd web && pnpm tsc --noEmit lib/queries/riddor-analytics.ts
```
  </verify>
  <done>RIDDOR analytics queries created with override rate calculation, confidence level breakdown, and top override reasons</done>
</task>

<task type="auto">
  <name>Task 2: Create override pattern chart component</name>
  <files>web/components/riddor/OverridePatternChart.tsx</files>
  <action>
Create `web/components/riddor/OverridePatternChart.tsx`:

```tsx
'use client';

import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import type { ConfidenceLevelStats } from '@/lib/queries/riddor-analytics';

interface OverridePatternChartProps {
  data: ConfidenceLevelStats[];
}

export function OverridePatternChart({ data }: OverridePatternChartProps) {
  const chartData = data.map((stat) => ({
    confidenceLevel: stat.confidenceLevel,
    'Confirmed (%)': stat.totalFlags > 0
      ? Math.round((stat.confirmed / stat.totalFlags) * 100)
      : 0,
    'Dismissed (%)': stat.totalFlags > 0
      ? Math.round((stat.dismissed / stat.totalFlags) * 100)
      : 0,
    'Pending (%)': stat.totalFlags > 0
      ? Math.round((stat.pending / stat.totalFlags) * 100)
      : 0,
    totalFlags: stat.totalFlags,
  }));

  return (
    <ResponsiveContainer width="100%" height={300}>
      <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="confidenceLevel" />
        <YAxis label={{ value: 'Percentage (%)', angle: -90, position: 'insideLeft' }} />
        <Tooltip
          formatter={(value: number, name: string, props: any) => [
            `${value}% (${Math.round((value / 100) * props.payload.totalFlags)} incidents)`,
            name,
          ]}
        />
        <Legend />
        <Bar dataKey="Confirmed (%)" fill="#10B981" stackId="a" />
        <Bar dataKey="Dismissed (%)" fill="#EF4444" stackId="a" />
        <Bar dataKey="Pending (%)" fill="#F59E0B" stackId="a" />
      </BarChart>
    </ResponsiveContainer>
  );
}
```

**Chart design:**
- Stacked bar chart showing confirmed/dismissed/pending breakdown by confidence level
- Green = confirmed (correct detection)
- Red = dismissed (false positive / override)
- Yellow = pending (awaiting medic review)
- Tooltip shows percentage and absolute count
  </action>
  <verify>
```bash
# Type check
cd web && pnpm tsc --noEmit components/riddor/OverridePatternChart.tsx
```
  </verify>
  <done>OverridePatternChart component created with stacked bar visualization of override patterns by confidence level</done>
</task>

<task type="auto">
  <name>Task 3: Create RIDDOR analytics dashboard page</name>
  <files>web/app/(dashboard)/riddor/analytics/page.tsx</files>
  <action>
Create `web/app/(dashboard)/riddor/analytics/page.tsx`:

```tsx
'use client';

import { useQuery } from '@tanstack/react-query';
import { useSession } from '@/lib/supabase/client';
import {
  fetchOverrideStats,
  fetchConfidenceLevelStats,
  fetchOverrideReasons,
} from '@/lib/queries/riddor-analytics';
import { OverridePatternChart } from '@/components/riddor/OverridePatternChart';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import Link from 'next/link';
import { Button } from '@/components/ui/button';

export default function RIDDORAnalyticsPage() {
  const session = useSession();

  const { data: stats } = useQuery({
    queryKey: ['riddor-override-stats', session?.user.org_id],
    queryFn: () => fetchOverrideStats(session!.user.org_id),
    enabled: !!session?.user.org_id,
    refetchInterval: 300000, // 5 minutes
  });

  const { data: confidenceStats = [] } = useQuery({
    queryKey: ['riddor-confidence-stats', session?.user.org_id],
    queryFn: () => fetchConfidenceLevelStats(session!.user.org_id),
    enabled: !!session?.user.org_id,
    refetchInterval: 300000,
  });

  const { data: topReasons = [] } = useQuery({
    queryKey: ['riddor-override-reasons', session?.user.org_id],
    queryFn: () => fetchOverrideReasons(session!.user.org_id),
    enabled: !!session?.user.org_id,
    refetchInterval: 300000,
  });

  const highOverrideAlert = stats && stats.overrideRate >= 80;

  return (
    <div className="container mx-auto p-6">
      <div className="mb-6 flex items-start justify-between">
        <div>
          <h1 className="text-3xl font-bold mb-2">RIDDOR Analytics</h1>
          <p className="text-gray-600">
            Track auto-detection accuracy and override patterns for algorithm tuning
          </p>
        </div>
        <Link href="/riddor">
          <Button variant="outline">← Back to RIDDOR List</Button>
        </Link>
      </div>

      {/* High override rate alert */}
      {highOverrideAlert && (
        <Card className="p-6 mb-6 bg-red-50 border-red-200">
          <div className="flex items-start gap-4">
            <div className="text-4xl">⚠️</div>
            <div className="flex-1">
              <h3 className="text-lg font-semibold text-red-900 mb-2">
                High Override Rate Detected
              </h3>
              <p className="text-red-800 mb-3">
                The current override rate is <strong>{stats.overrideRate}%</strong>, exceeding the
                80% threshold. This indicates the detection algorithm may need review and tuning.
              </p>
              <p className="text-sm text-red-700">
                <strong>Recommendation:</strong> Review the most common override reasons below and
                adjust detection rules in{' '}
                <code className="bg-red-100 px-1 py-0.5 rounded">
                  supabase/functions/riddor-detector/detection-rules.ts
                </code>
              </p>
            </div>
          </div>
        </Card>
      )}

      {/* Summary cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <Card className="p-6">
          <div className="text-sm text-gray-600 mb-1">Total Auto-Flags</div>
          <div className="text-3xl font-bold">{stats?.totalAutoFlags || 0}</div>
        </Card>

        <Card className="p-6">
          <div className="text-sm text-gray-600 mb-1">Confirmed</div>
          <div className="text-3xl font-bold text-green-600">{stats?.confirmed || 0}</div>
          <div className="text-xs text-gray-500 mt-1">
            {stats && stats.totalAutoFlags > 0
              ? Math.round((stats.confirmed / stats.totalAutoFlags) * 100)
              : 0}
            % of total
          </div>
        </Card>

        <Card className="p-6">
          <div className="text-sm text-gray-600 mb-1">Dismissed</div>
          <div className="text-3xl font-bold text-red-600">{stats?.dismissed || 0}</div>
          <div className="text-xs text-gray-500 mt-1">
            {stats && stats.totalAutoFlags > 0
              ? Math.round((stats.dismissed / stats.totalAutoFlags) * 100)
              : 0}
            % of total
          </div>
        </Card>

        <Card className="p-6">
          <div className="text-sm text-gray-600 mb-1">Pending Review</div>
          <div className="text-3xl font-bold text-yellow-600">{stats?.pending || 0}</div>
          <div className="text-xs text-gray-500 mt-1">
            {stats && stats.totalAutoFlags > 0
              ? Math.round((stats.pending / stats.totalAutoFlags) * 100)
              : 0}
            % of total
          </div>
        </Card>
      </div>

      {/* Override rate by confidence level */}
      <Card className="p-6 mb-6">
        <h2 className="text-xl font-semibold mb-4">Override Rate by Confidence Level</h2>
        <p className="text-sm text-gray-600 mb-6">
          Higher override rates indicate false positives. Target: &lt;50% override rate for HIGH confidence.
        </p>
        <OverridePatternChart data={confidenceStats} />

        <div className="grid grid-cols-3 gap-4 mt-6">
          {confidenceStats.map((stat) => (
            <div key={stat.confidenceLevel} className="text-center">
              <div className="text-sm font-medium mb-1">{stat.confidenceLevel}</div>
              <div
                className={`text-2xl font-bold ${
                  stat.overrideRate >= 80
                    ? 'text-red-600'
                    : stat.overrideRate >= 50
                    ? 'text-yellow-600'
                    : 'text-green-600'
                }`}
              >
                {stat.overrideRate}%
              </div>
              <div className="text-xs text-gray-500">override rate</div>
              <div className="text-xs text-gray-400 mt-1">
                {stat.dismissed} of {stat.confirmed + stat.dismissed} reviewed
              </div>
            </div>
          ))}
        </div>
      </Card>

      {/* Top override reasons */}
      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-4">Top Override Reasons (Dismissed Flags)</h2>
        <p className="text-sm text-gray-600 mb-4">
          Common reasons medics give for dismissing RIDDOR flags. Use this to identify detection
          rule improvements.
        </p>

        {topReasons.length === 0 ? (
          <p className="text-gray-500 italic">No dismissed flags yet</p>
        ) : (
          <div className="space-y-3">
            {topReasons.map((reason, index) => (
              <div
                key={index}
                className="flex items-center justify-between p-3 bg-gray-50 rounded"
              >
                <div className="flex-1">
                  <span className="font-medium text-gray-900">{reason.reason}</span>
                </div>
                <div className="flex items-center gap-3">
                  <Badge variant="outline">{reason.count} occurrences</Badge>
                  <div className="text-sm text-gray-600 w-12 text-right">
                    {reason.percentage}%
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </Card>
    </div>
  );
}
```

**Design notes:**
- Alert banner if overall override rate ≥80% (Research threshold for algorithm review)
- Summary cards: total flags, confirmed, dismissed, pending
- Stacked bar chart showing override patterns by confidence level
- Override rate percentages color-coded (green <50%, yellow 50-79%, red ≥80%)
- Top 10 override reasons with occurrence count and percentage
- 5-minute polling (less frequent than real-time dashboard, analytics is slower-moving data)
  </action>
  <verify>
```bash
# Type check
cd web && pnpm tsc --noEmit app/(dashboard)/riddor/analytics/page.tsx

# Run dev server and navigate to /riddor/analytics
pnpm dev
```
  </verify>
  <done>RIDDOR analytics page created with override rate tracking, confidence level breakdown, and top override reasons for algorithm tuning</done>
</task>

</tasks>

<verification>
**Overall Phase Checks:**

1. **Analytics queries functional:**
   - fetchOverrideStats returns total flags, confirmed, dismissed, pending, override rates
   - fetchConfidenceLevelStats breaks down by HIGH/MEDIUM/LOW confidence
   - fetchOverrideReasons returns top 10 dismissal reasons sorted by count

2. **Analytics dashboard complete:**
   - Summary cards show total flags, confirmed, dismissed, pending
   - Override rate by confidence level displayed in stacked bar chart
   - High override rate alert visible when ≥80%
   - Top override reasons listed with occurrence counts

3. **Visual design:**
   - Color-coded override rates (green <50%, yellow 50-79%, red ≥80%)
   - Stacked bar chart uses green/red/yellow for confirmed/dismissed/pending
   - Alert banner prominent at top when threshold exceeded
</verification>

<success_criteria>
**Measurable Completion:**

1. `/riddor/analytics` page displays summary cards with total auto-flags, confirmed, dismissed, pending counts
2. Stacked bar chart shows confirmed/dismissed/pending breakdown by confidence level (HIGH/MEDIUM/LOW)
3. Override rate percentages displayed below chart (e.g., "HIGH: 25% override rate")
4. Alert banner appears when overall override rate ≥80%
5. Top 10 override reasons listed with occurrence count and percentage
6. Override rate calculation excludes pending reviews (uses only confirmed + dismissed as denominator)
7. Analytics page polls every 5 minutes (refetchInterval: 300000)
8. Back button navigates to /riddor list page
</success_criteria>

<output>
After completion, create `.planning/phases/06-riddor-auto-flagging/06-06-SUMMARY.md`
</output>
