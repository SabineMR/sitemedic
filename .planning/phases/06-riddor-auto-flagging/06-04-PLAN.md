---
phase: 06-riddor-auto-flagging
plan: 04
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - web/app/(dashboard)/riddor/page.tsx
  - web/app/(dashboard)/riddor/[id]/page.tsx
  - web/lib/queries/riddor.ts
  - web/components/riddor/RIDDORStatusBadge.tsx
  - web/components/riddor/DeadlineCountdown.tsx
autonomous: true

must_haves:
  truths:
    - "Site manager can view list of all RIDDOR-flagged incidents with deadline countdown"
    - "Site manager can filter RIDDOR incidents by status (draft/submitted/confirmed)"
    - "Site manager can click into RIDDOR incident for full detail view"
    - "RIDDOR detail page shows treatment data, worker info, F2508 download link"
    - "Dashboard updates via 60-second polling for near-real-time data"
  artifacts:
    - path: "web/app/(dashboard)/riddor/page.tsx"
      provides: "RIDDOR incidents list page with filters and deadline countdown"
      min_lines: 150
    - path: "web/app/(dashboard)/riddor/[id]/page.tsx"
      provides: "RIDDOR incident detail page with F2508 generation and download"
      min_lines: 200
    - path: "web/lib/queries/riddor.ts"
      provides: "Supabase queries for RIDDOR incidents with treatment/worker joins"
      exports: ["fetchRIDDORIncidents", "fetchRIDDORIncident"]
    - path: "web/components/riddor/RIDDORStatusBadge.tsx"
      provides: "Status badge component (draft/submitted/confirmed)"
    - path: "web/components/riddor/DeadlineCountdown.tsx"
      provides: "Countdown component showing days until HSE deadline"
  key_links:
    - from: "web/app/(dashboard)/riddor/page.tsx"
      to: "web/lib/queries/riddor.ts"
      via: "Page fetches RIDDOR incidents with TanStack Query"
      pattern: "useQuery.*fetchRIDDORIncidents"
    - from: "web/app/(dashboard)/riddor/[id]/page.tsx"
      to: "supabase/functions/riddor-f2508-generator"
      via: "Detail page triggers F2508 generation and downloads PDF"
      pattern: "fetch.*riddor-f2508-generator"
    - from: "web/components/riddor/DeadlineCountdown.tsx"
      to: "deadline_date"
      via: "Calculates days remaining from deadline_date field"
      pattern: "deadline_date"
---

<objective>
Build the web dashboard RIDDOR pages: a list view with deadline countdown and status filters, plus a detail page with F2508 download and treatment context. Site managers need visibility into RIDDOR compliance status and easy access to pre-filled F2508 forms for HSE submission.

Purpose: This is the site manager's compliance command center -- showing all RIDDOR-flagged incidents, deadline urgency, and one-click F2508 generation. The dashboard turns RIDDOR compliance from reactive (missed deadlines) to proactive (visible countdown).

Output: Working RIDDOR list and detail pages with real-time updates, status tracking, and F2508 PDF generation integration.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-riddor-auto-flagging/06-RESEARCH.md
@.planning/phases/06-riddor-auto-flagging/06-01-PLAN.md
@.planning/phases/06-riddor-auto-flagging/06-03-PLAN.md

# Existing dashboard patterns
@web/app/(dashboard)/treatments/page.tsx
@web/app/(dashboard)/near-misses/page.tsx
@web/lib/queries/treatments.ts

# Component patterns
@web/components/ui/badge.tsx
@web/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RIDDOR queries and shared components</name>
  <files>
    web/lib/queries/riddor.ts
    web/components/riddor/RIDDORStatusBadge.tsx
    web/components/riddor/DeadlineCountdown.tsx
  </files>
  <action>
1. **web/lib/queries/riddor.ts** - Supabase queries:
   ```typescript
   import { supabase } from '@/lib/supabase/client';

   export interface RIDDORIncident {
     id: string;
     treatment_id: string;
     worker_id: string;
     org_id: string;
     category: string;
     confidence_level: 'HIGH' | 'MEDIUM' | 'LOW';
     auto_flagged: boolean;
     medic_confirmed: boolean | null;
     override_reason: string | null;
     deadline_date: string;
     status: 'draft' | 'submitted' | 'confirmed';
     f2508_pdf_path: string | null;
     submitted_at: string | null;
     detected_at: string;
     created_at: string;
     updated_at: string;
     treatments: {
       id: string;
       injury_type: string;
       body_part: string;
       severity: string;
       mechanism_of_injury: string;
       outcome: string;
       created_at: string;
     };
     workers: {
       id: string;
       first_name: string;
       last_name: string;
       company: string;
       role: string;
     };
   }

   export async function fetchRIDDORIncidents(
     orgId: string,
     status?: 'draft' | 'submitted' | 'confirmed'
   ): Promise<RIDDORIncident[]> {
     let query = supabase
       .from('riddor_incidents')
       .select(`
         *,
         treatments (*),
         workers (*)
       `)
       .eq('org_id', orgId)
       .order('deadline_date', { ascending: true });

     if (status) {
       query = query.eq('status', status);
     }

     const { data, error } = await query;

     if (error) throw error;
     return data || [];
   }

   export async function fetchRIDDORIncident(
     incidentId: string
   ): Promise<RIDDORIncident | null> {
     const { data, error } = await supabase
       .from('riddor_incidents')
       .select(`
         *,
         treatments (*),
         workers (*),
         orgs:organizations (*)
       `)
       .eq('id', incidentId)
       .single();

     if (error) throw error;
     return data;
   }

   export function calculateDaysUntilDeadline(deadlineDate: string): number {
     const deadline = new Date(deadlineDate);
     const now = new Date();
     const diffMs = deadline.getTime() - now.getTime();
     return Math.ceil(diffMs / (1000 * 60 * 60 * 24));
   }
   ```

2. **web/components/riddor/RIDDORStatusBadge.tsx** - Status badge:
   ```tsx
   import { Badge } from '@/components/ui/badge';

   interface RIDDORStatusBadgeProps {
     status: 'draft' | 'submitted' | 'confirmed';
   }

   export function RIDDORStatusBadge({ status }: RIDDORStatusBadgeProps) {
     const variants = {
       draft: { text: 'Draft', className: 'bg-yellow-100 text-yellow-800' },
       submitted: { text: 'Submitted', className: 'bg-blue-100 text-blue-800' },
       confirmed: { text: 'Confirmed', className: 'bg-green-100 text-green-800' },
     };

     const variant = variants[status];

     return (
       <Badge className={variant.className}>
         {variant.text}
       </Badge>
     );
   }
   ```

3. **web/components/riddor/DeadlineCountdown.tsx** - Deadline countdown:
   ```tsx
   import { Badge } from '@/components/ui/badge';
   import { calculateDaysUntilDeadline } from '@/lib/queries/riddor';

   interface DeadlineCountdownProps {
     deadlineDate: string;
   }

   export function DeadlineCountdown({ deadlineDate }: DeadlineCountdownProps) {
     const daysRemaining = calculateDaysUntilDeadline(deadlineDate);

     let className = 'bg-green-100 text-green-800';
     let urgency = '';

     if (daysRemaining <= 0) {
       className = 'bg-red-600 text-white font-bold';
       urgency = 'OVERDUE';
     } else if (daysRemaining <= 3) {
       className = 'bg-red-100 text-red-800 font-semibold';
       urgency = 'URGENT';
     } else if (daysRemaining <= 7) {
       className = 'bg-yellow-100 text-yellow-800';
       urgency = 'DUE SOON';
     }

     return (
       <Badge className={className}>
         {urgency && `${urgency}: `}
         {daysRemaining <= 0
           ? `${Math.abs(daysRemaining)} day${Math.abs(daysRemaining) !== 1 ? 's' : ''} overdue`
           : `${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} remaining`}
       </Badge>
     );
   }
   ```

**Color coding:**
- Green: >7 days remaining (safe)
- Yellow: 4-7 days remaining (due soon)
- Red: 1-3 days remaining (urgent)
- Dark red + bold: 0 or negative days (overdue)
  </action>
  <verify>
```bash
# Type check
cd web && pnpm tsc --noEmit lib/queries/riddor.ts components/riddor/*.tsx
```
  </verify>
  <done>RIDDOR queries, status badge, and deadline countdown components created with color-coded urgency indicators</done>
</task>

<task type="auto">
  <name>Task 2: Create RIDDOR incidents list page</name>
  <files>web/app/(dashboard)/riddor/page.tsx</files>
  <action>
Create `web/app/(dashboard)/riddor/page.tsx`:

```tsx
'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { useSession } from '@/lib/supabase/client';
import { fetchRIDDORIncidents } from '@/lib/queries/riddor';
import { RIDDORStatusBadge } from '@/components/riddor/RIDDORStatusBadge';
import { DeadlineCountdown } from '@/components/riddor/DeadlineCountdown';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Card } from '@/components/ui/card';
import Link from 'next/link';

export default function RIDDORPage() {
  const session = useSession();
  const [statusFilter, setStatusFilter] = useState<'all' | 'draft' | 'submitted' | 'confirmed'>('all');

  const { data: incidents = [], isLoading } = useQuery({
    queryKey: ['riddor-incidents', session?.user.org_id, statusFilter],
    queryFn: () =>
      fetchRIDDORIncidents(
        session!.user.org_id,
        statusFilter === 'all' ? undefined : statusFilter
      ),
    enabled: !!session?.user.org_id,
    refetchInterval: 60000, // 60-second polling (DASH-09)
  });

  return (
    <div className="container mx-auto p-6">
      <div className="mb-6">
        <h1 className="text-3xl font-bold mb-2">RIDDOR Incidents</h1>
        <p className="text-gray-600">
          Monitor RIDDOR-reportable incidents with deadline tracking and HSE F2508 generation
        </p>
      </div>

      {/* Status filter */}
      <div className="mb-6 flex items-center gap-4">
        <label htmlFor="status-filter" className="text-sm font-medium">
          Filter by status:
        </label>
        <Select value={statusFilter} onValueChange={setStatusFilter}>
          <SelectTrigger className="w-48">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Statuses</SelectItem>
            <SelectItem value="draft">Draft</SelectItem>
            <SelectItem value="submitted">Submitted</SelectItem>
            <SelectItem value="confirmed">Confirmed</SelectItem>
          </SelectContent>
        </Select>

        <div className="ml-auto text-sm text-gray-600">
          {incidents.length} incident{incidents.length !== 1 ? 's' : ''}
        </div>
      </div>

      {/* Incidents list */}
      {isLoading ? (
        <div className="text-center py-12">Loading RIDDOR incidents...</div>
      ) : incidents.length === 0 ? (
        <Card className="p-8 text-center">
          <p className="text-gray-600">
            {statusFilter === 'all'
              ? 'No RIDDOR incidents detected yet.'
              : `No ${statusFilter} RIDDOR incidents.`}
          </p>
        </Card>
      ) : (
        <div className="space-y-4">
          {incidents.map((incident) => (
            <Card key={incident.id} className="p-6 hover:shadow-lg transition-shadow">
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-2">
                    <h3 className="text-lg font-semibold">
                      {incident.workers.first_name} {incident.workers.last_name}
                    </h3>
                    <RIDDORStatusBadge status={incident.status} />
                    <DeadlineCountdown deadlineDate={incident.deadline_date} />
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-3">
                    <div>
                      <span className="text-gray-600">Injury:</span>{' '}
                      <span className="font-medium">{incident.treatments.injury_type}</span>
                    </div>
                    <div>
                      <span className="text-gray-600">Body Part:</span>{' '}
                      <span className="font-medium">{incident.treatments.body_part || 'N/A'}</span>
                    </div>
                    <div>
                      <span className="text-gray-600">Category:</span>{' '}
                      <span className="font-medium capitalize">{incident.category.replace('_', ' ')}</span>
                    </div>
                    <div>
                      <span className="text-gray-600">Confidence:</span>{' '}
                      <span className={`font-medium ${
                        incident.confidence_level === 'HIGH'
                          ? 'text-red-600'
                          : incident.confidence_level === 'MEDIUM'
                          ? 'text-yellow-600'
                          : 'text-gray-600'
                      }`}>
                        {incident.confidence_level}
                      </span>
                    </div>
                  </div>

                  <div className="text-sm text-gray-600">
                    <span className="font-medium">Company:</span> {incident.workers.company} ({incident.workers.role})
                  </div>

                  {incident.medic_confirmed !== null && (
                    <div className="mt-2 text-sm">
                      <span
                        className={`font-medium ${
                          incident.medic_confirmed ? 'text-red-600' : 'text-gray-600'
                        }`}
                      >
                        {incident.medic_confirmed ? '✓ Medic Confirmed' : '✗ Medic Dismissed'}
                      </span>
                      {incident.override_reason && (
                        <span className="text-gray-600 ml-2">
                          — {incident.override_reason}
                        </span>
                      )}
                    </div>
                  )}
                </div>

                <div>
                  <Link href={`/riddor/${incident.id}`}>
                    <Button variant="outline">View Details</Button>
                  </Link>
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}
```

**Design notes:**
- Card layout (not table) for better mobile responsiveness
- Status and deadline badges prominent at top
- Grid layout for incident metadata (injury, body part, category, confidence)
- Medic override status displayed if present
- 60-second polling for near-real-time updates (matches DASH-09)
  </action>
  <verify>
```bash
# Type check
cd web && pnpm tsc --noEmit app/(dashboard)/riddor/page.tsx

# Run dev server and navigate to /riddor
pnpm dev
```
  </verify>
  <done>RIDDOR list page created with status filter, deadline countdown, and card-based layout</done>
</task>

<task type="auto">
  <name>Task 3: Create RIDDOR incident detail page with F2508 generation</name>
  <files>web/app/(dashboard)/riddor/[id]/page.tsx</files>
  <action>
Create `web/app/(dashboard)/riddor/[id]/page.tsx`:

```tsx
'use client';

import { useState } from 'react';
import { useParams } from 'next/navigation';
import { useQuery } from '@tanstack/react-query';
import { fetchRIDDORIncident } from '@/lib/queries/riddor';
import { RIDDORStatusBadge } from '@/components/riddor/RIDDORStatusBadge';
import { DeadlineCountdown } from '@/components/riddor/DeadlineCountdown';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import Link from 'next/link';

export default function RIDDORDetailPage() {
  const { id } = useParams();
  const [generating, setGenerating] = useState(false);

  const { data: incident, isLoading } = useQuery({
    queryKey: ['riddor-incident', id],
    queryFn: () => fetchRIDDORIncident(id as string),
    enabled: !!id,
    refetchInterval: 60000, // 60-second polling
  });

  const handleGenerateF2508 = async () => {
    setGenerating(true);
    try {
      const response = await fetch('/api/supabase/functions/riddor-f2508-generator', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ riddor_incident_id: id }),
      });

      const result = await response.json();

      if (result.signed_url) {
        // Open PDF in new tab
        window.open(result.signed_url, '_blank');
      } else {
        alert('Failed to generate F2508 PDF');
      }
    } catch (error) {
      console.error('F2508 generation error:', error);
      alert('Failed to generate F2508 PDF');
    } finally {
      setGenerating(false);
    }
  };

  if (isLoading) {
    return <div className="container mx-auto p-6">Loading RIDDOR incident...</div>;
  }

  if (!incident) {
    return (
      <div className="container mx-auto p-6">
        <Card className="p-8 text-center">
          <p className="text-gray-600">RIDDOR incident not found.</p>
          <Link href="/riddor">
            <Button variant="outline" className="mt-4">Back to RIDDOR List</Button>
          </Link>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6">
      {/* Header */}
      <div className="mb-6 flex items-start justify-between">
        <div>
          <Link href="/riddor">
            <Button variant="ghost" className="mb-2">← Back to RIDDOR List</Button>
          </Link>
          <h1 className="text-3xl font-bold">
            RIDDOR Incident: {incident.workers.first_name} {incident.workers.last_name}
          </h1>
        </div>
        <div className="flex gap-3">
          <RIDDORStatusBadge status={incident.status} />
          <DeadlineCountdown deadlineDate={incident.deadline_date} />
        </div>
      </div>

      {/* F2508 Generation */}
      <Card className="p-6 mb-6 bg-blue-50 border-blue-200">
        <h2 className="text-xl font-semibold mb-2">HSE F2508 Report</h2>
        <p className="text-gray-700 mb-4">
          Generate a pre-filled F2508 form for HSE submission. This form contains all incident
          details from the treatment log.
        </p>
        <Button
          onClick={handleGenerateF2508}
          disabled={generating}
          className="bg-blue-600 hover:bg-blue-700"
        >
          {generating ? 'Generating PDF...' : 'Download F2508 PDF'}
        </Button>
        {incident.f2508_pdf_path && (
          <p className="text-sm text-gray-600 mt-2">
            Last generated: {new Date(incident.updated_at).toLocaleString('en-GB')}
          </p>
        )}
      </Card>

      {/* Incident Details */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Detection Info */}
        <Card className="p-6">
          <h2 className="text-xl font-semibold mb-4">Detection Information</h2>
          <dl className="space-y-3">
            <div>
              <dt className="text-sm text-gray-600">Category</dt>
              <dd className="font-medium capitalize">{incident.category.replace('_', ' ')}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Confidence Level</dt>
              <dd className={`font-semibold ${
                incident.confidence_level === 'HIGH'
                  ? 'text-red-600'
                  : incident.confidence_level === 'MEDIUM'
                  ? 'text-yellow-600'
                  : 'text-gray-600'
              }`}>
                {incident.confidence_level}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Auto-flagged</dt>
              <dd>{incident.auto_flagged ? 'Yes' : 'No'}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Detected At</dt>
              <dd>{new Date(incident.detected_at).toLocaleString('en-GB')}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">HSE Deadline</dt>
              <dd className="font-semibold">
                {new Date(incident.deadline_date).toLocaleDateString('en-GB')}
              </dd>
            </div>
          </dl>
        </Card>

        {/* Medic Override */}
        <Card className="p-6">
          <h2 className="text-xl font-semibold mb-4">Medic Review</h2>
          {incident.medic_confirmed === null ? (
            <p className="text-yellow-700 bg-yellow-50 p-4 rounded">
              ⚠️ Awaiting medic review
            </p>
          ) : (
            <dl className="space-y-3">
              <div>
                <dt className="text-sm text-gray-600">Decision</dt>
                <dd className={`font-semibold ${
                  incident.medic_confirmed ? 'text-red-600' : 'text-gray-600'
                }`}>
                  {incident.medic_confirmed ? '✓ Confirmed RIDDOR' : '✗ Dismissed RIDDOR'}
                </dd>
              </div>
              <div>
                <dt className="text-sm text-gray-600">Reason</dt>
                <dd>{incident.override_reason || 'No reason provided'}</dd>
              </div>
            </dl>
          )}
        </Card>

        {/* Treatment Details */}
        <Card className="p-6">
          <h2 className="text-xl font-semibold mb-4">Treatment Details</h2>
          <dl className="space-y-3">
            <div>
              <dt className="text-sm text-gray-600">Injury Type</dt>
              <dd className="font-medium">{incident.treatments.injury_type}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Body Part</dt>
              <dd>{incident.treatments.body_part || 'Not specified'}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Severity</dt>
              <dd className="capitalize">{incident.treatments.severity}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Mechanism</dt>
              <dd>{incident.treatments.mechanism_of_injury || 'Not specified'}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Outcome</dt>
              <dd className="capitalize">{incident.treatments.outcome?.replace('_', ' ') || 'Not specified'}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Incident Date</dt>
              <dd>{new Date(incident.treatments.created_at).toLocaleString('en-GB')}</dd>
            </div>
          </dl>

          <Link href={`/treatments/${incident.treatment_id}`}>
            <Button variant="outline" className="mt-4 w-full">View Full Treatment Log</Button>
          </Link>
        </Card>

        {/* Worker Details */}
        <Card className="p-6">
          <h2 className="text-xl font-semibold mb-4">Worker Details</h2>
          <dl className="space-y-3">
            <div>
              <dt className="text-sm text-gray-600">Name</dt>
              <dd className="font-medium">
                {incident.workers.first_name} {incident.workers.last_name}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Company</dt>
              <dd>{incident.workers.company}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-600">Role</dt>
              <dd>{incident.workers.role}</dd>
            </div>
          </dl>

          <Link href={`/workers/${incident.worker_id}`}>
            <Button variant="outline" className="mt-4 w-full">View Worker Profile</Button>
          </Link>
        </Card>
      </div>
    </div>
  );
}
```

**Important notes:**
1. **F2508 generation:** Calls Edge Function via Next.js API proxy, opens PDF in new tab
2. **Responsive grid:** 2-column on desktop, single column on mobile
3. **Cross-links:** Links to full treatment log and worker profile for context
4. **Visual hierarchy:** F2508 download prominent at top (primary action)
  </action>
  <verify>
```bash
# Type check
cd web && pnpm tsc --noEmit app/(dashboard)/riddor/[id]/page.tsx

# Run dev server and navigate to /riddor/[test-id]
pnpm dev
```
  </verify>
  <done>RIDDOR detail page created with F2508 generation, treatment/worker details, and medic override display</done>
</task>

</tasks>

<verification>
**Overall Phase Checks:**

1. **RIDDOR list page functional:**
   - Displays all RIDDOR incidents with deadline countdown
   - Status filter works (all/draft/submitted/confirmed)
   - Card layout responsive on mobile
   - 60-second polling for updates

2. **RIDDOR detail page complete:**
   - F2508 generation button triggers Edge Function
   - Generated PDF opens in new tab
   - Treatment and worker details displayed
   - Medic override status shown

3. **Navigation:**
   - Links from list to detail work
   - Links from detail to treatment log and worker profile work
   - Back button returns to list
</verification>

<success_criteria>
**Measurable Completion:**

1. `/riddor` page displays list of RIDDOR incidents with deadline countdown
2. Status filter updates list (draft/submitted/confirmed)
3. Clicking "View Details" navigates to `/riddor/[id]`
4. Detail page "Download F2508 PDF" button triggers Edge Function and opens PDF
5. Deadline countdown shows color-coded urgency (green >7 days, yellow 4-7 days, red 1-3 days, dark red overdue)
6. Status badge displays correct status (draft/submitted/confirmed)
7. TanStack Query refetches every 60 seconds (polling interval)
8. Page responsive on mobile (cards stack vertically)
</success_criteria>

<output>
After completion, create `.planning/phases/06-riddor-auto-flagging/06-04-SUMMARY.md`
</output>
