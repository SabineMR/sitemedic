---
phase: 06-riddor-auto-flagging
plan: 05
type: execute
wave: 3
depends_on: [06-01, 06-04]
files_modified:
  - supabase/migrations/020_riddor_deadline_cron.sql
  - supabase/functions/riddor-deadline-checker/index.ts
  - supabase/functions/riddor-deadline-checker/email-templates.ts
autonomous: true

must_haves:
  truths:
    - "Cron job runs daily at 9:00 AM UTC checking RIDDOR deadlines"
    - "Site manager receives email 3 days before RIDDOR deadline"
    - "Email contains incident summary, worker name, deadline date, and dashboard link"
    - "Email template uses professional HSE compliance formatting"
    - "Emails sent once per deadline milestone (not repeated daily)"
  artifacts:
    - path: "supabase/migrations/020_riddor_deadline_cron.sql"
      provides: "pg_cron job scheduled daily for deadline checking"
      contains: "cron.schedule"
    - path: "supabase/functions/riddor-deadline-checker/index.ts"
      provides: "Edge Function that checks deadlines and triggers emails"
      min_lines: 80
    - path: "supabase/functions/riddor-deadline-checker/email-templates.ts"
      provides: "Email templates for deadline reminders"
      exports: ["sendDeadlineEmail"]
  key_links:
    - from: "supabase/migrations/020_riddor_deadline_cron.sql"
      to: "supabase/functions/riddor-deadline-checker/index.ts"
      via: "Cron job invokes Edge Function daily via net.http_post"
      pattern: "net\\.http_post.*riddor-deadline-checker"
    - from: "supabase/functions/riddor-deadline-checker/index.ts"
      to: "supabase/functions/riddor-deadline-checker/email-templates.ts"
      via: "Handler calls sendDeadlineEmail for each incident approaching deadline"
      pattern: "sendDeadlineEmail"
    - from: "supabase/functions/riddor-deadline-checker/email-templates.ts"
      to: "Resend API"
      via: "Sends deadline reminder emails via Resend"
      pattern: "resend\\.emails\\.send"
---

<objective>
Create the RIDDOR deadline tracking system: a daily cron job that checks approaching deadlines and sends email notifications to site managers 3 days before the HSE submission deadline, ensuring no RIDDOR incidents are missed.

Purpose: This is the proactive compliance safety net -- automatically alerting site managers when RIDDOR deadlines approach, preventing the legal/financial consequences of missed HSE reporting deadlines (prosecution, fines, loss of principal contractor contracts).

Output: A working cron job and email notification system that sends deadline reminders 3 days before RIDDOR submission deadlines, with professional email formatting and direct dashboard links.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-riddor-auto-flagging/06-RESEARCH.md
@.planning/phases/06-riddor-auto-flagging/06-01-PLAN.md
@.planning/phases/06-riddor-auto-flagging/06-04-PLAN.md

# Existing cron pattern
@supabase/migrations/016_weekly_report_cron.sql

# Existing email pattern
@supabase/functions/generate-weekly-report/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RIDDOR deadline checker Edge Function with email templates</name>
  <files>
    supabase/functions/riddor-deadline-checker/email-templates.ts
    supabase/functions/riddor-deadline-checker/index.ts
  </files>
  <action>
1. **email-templates.ts** - Email templates:
   ```typescript
   import { Resend } from 'https://esm.sh/resend@1.0.0';

   const resend = new Resend(Deno.env.get('RESEND_API_KEY'));

   interface DeadlineEmailData {
     incidentId: string;
     workerName: string;
     workerCompany: string;
     injuryType: string;
     bodyPart: string;
     incidentDate: string;
     deadlineDate: string;
     daysRemaining: number;
     dashboardUrl: string;
     siteManagerEmail: string;
     siteManagerName: string;
     orgName: string;
   }

   export async function sendDeadlineEmail(data: DeadlineEmailData): Promise<void> {
     const urgencyLabel = data.daysRemaining === 1 ? 'URGENT' : 'Important';

     const { error } = await resend.emails.send({
       from: 'SiteMedic <notifications@sitemedic.app>',
       to: data.siteManagerEmail,
       subject: `${urgencyLabel}: RIDDOR Deadline in ${data.daysRemaining} day${data.daysRemaining > 1 ? 's' : ''}`,
       html: `
         <!DOCTYPE html>
         <html>
         <head>
           <style>
             body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
             .container { max-width: 600px; margin: 0 auto; padding: 20px; }
             .header { background: #003366; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
             .content { background: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; }
             .incident-box { background: white; padding: 16px; border-left: 4px solid #dc3545; margin: 16px 0; }
             .detail-row { margin: 8px 0; }
             .label { font-weight: bold; color: #6c757d; }
             .cta-button {
               display: inline-block;
               background: #003366;
               color: white !important;
               padding: 12px 24px;
               text-decoration: none;
               border-radius: 6px;
               font-weight: bold;
               margin: 16px 0;
             }
             .footer { background: #f1f3f5; padding: 16px; text-align: center; font-size: 12px; color: #6c757d; }
             .urgent { color: #dc3545; font-weight: bold; }
           </style>
         </head>
         <body>
           <div class="container">
             <div class="header">
               <h1 style="margin: 0;">⚠️ RIDDOR Report Deadline Approaching</h1>
             </div>

             <div class="content">
               <p>Hello ${data.siteManagerName},</p>

               <p>
                 A RIDDOR-reportable incident at <strong>${data.orgName}</strong> is approaching its
                 HSE submission deadline. <span class="urgent">Action required within ${data.daysRemaining} day${data.daysRemaining > 1 ? 's' : ''}.</span>
               </p>

               <div class="incident-box">
                 <h3 style="margin-top: 0; color: #dc3545;">Incident Summary</h3>

                 <div class="detail-row">
                   <span class="label">Worker:</span> ${data.workerName} (${data.workerCompany})
                 </div>

                 <div class="detail-row">
                   <span class="label">Injury:</span> ${data.injuryType}${data.bodyPart ? ` (${data.bodyPart})` : ''}
                 </div>

                 <div class="detail-row">
                   <span class="label">Incident Date:</span> ${data.incidentDate}
                 </div>

                 <div class="detail-row">
                   <span class="label">HSE Deadline:</span> <strong class="urgent">${data.deadlineDate}</strong>
                 </div>

                 <div class="detail-row">
                   <span class="label">Days Remaining:</span> <strong class="urgent">${data.daysRemaining}</strong>
                 </div>
               </div>

               <p>
                 <strong>Next Steps:</strong>
               </p>
               <ol>
                 <li>Review the incident details in your dashboard</li>
                 <li>Download the pre-filled HSE F2508 form</li>
                 <li>Submit the F2508 to HSE via their online reporting system</li>
               </ol>

               <a href="${data.dashboardUrl}" class="cta-button">
                 Review Incident & Download F2508
               </a>

               <p style="font-size: 14px; color: #6c757d; margin-top: 24px;">
                 <strong>Important:</strong> RIDDOR reports must be submitted to HSE within the legal deadline.
                 Failure to report can result in prosecution under the Health and Safety at Work Act 1974.
               </p>
             </div>

             <div class="footer">
               <p>
                 This is an automated reminder from SiteMedic.<br />
                 Learn more about RIDDOR at <a href="https://www.hse.gov.uk/riddor/">hse.gov.uk/riddor</a>
               </p>
             </div>
           </div>
         </body>
         </html>
       `,
     });

     if (error) {
       console.error('Resend email error:', error);
       throw error;
     }
   }
   ```

2. **index.ts** - Deadline checker Edge Function:
   ```typescript
   import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
   import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
   import { sendDeadlineEmail } from './email-templates.ts';

   serve(async (req: Request) => {
     try {
       const supabase = createClient(
         Deno.env.get('SUPABASE_URL')!,
         Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
       );

       const now = new Date();
       const threeDaysFromNow = new Date(now);
       threeDaysFromNow.setDate(now.getDate() + 3);

       // Find RIDDOR incidents with deadlines exactly 3 days away
       // Use date comparison to avoid sending multiple emails
       const { data: incidents, error } = await supabase
         .from('riddor_incidents')
         .select(`
           *,
           treatments (*),
           workers (*),
           orgs:organizations (*)
         `)
         .eq('status', 'draft') // Only draft (not yet submitted)
         .eq('medic_confirmed', true) // Only medic-confirmed incidents
         .eq('deadline_date', threeDaysFromNow.toISOString().split('T')[0]); // Exact date match

       if (error) {
         console.error('Database query error:', error);
         return new Response(
           JSON.stringify({ error: error.message }),
           { status: 500 }
         );
       }

       if (!incidents || incidents.length === 0) {
         return new Response(
           JSON.stringify({ message: 'No deadlines approaching today' }),
           { status: 200 }
         );
       }

       // Send email for each incident
       const emailResults = await Promise.allSettled(
         incidents.map(async (incident) => {
           // Fetch site manager email from organization profiles
           const { data: siteManager } = await supabase
             .from('profiles')
             .select('email, first_name, last_name')
             .eq('org_id', incident.org_id)
             .eq('role', 'site_manager')
             .single();

           if (!siteManager) {
             console.warn(`No site manager found for org ${incident.org_id}`);
             return;
           }

           const dashboardUrl = `https://app.sitemedic.com/riddor/${incident.id}`;

           await sendDeadlineEmail({
             incidentId: incident.id,
             workerName: `${incident.workers.first_name} ${incident.workers.last_name}`,
             workerCompany: incident.workers.company,
             injuryType: incident.treatments.injury_type,
             bodyPart: incident.treatments.body_part || '',
             incidentDate: new Date(incident.treatments.created_at).toLocaleDateString('en-GB'),
             deadlineDate: new Date(incident.deadline_date).toLocaleDateString('en-GB'),
             daysRemaining: 3,
             dashboardUrl,
             siteManagerEmail: siteManager.email,
             siteManagerName: `${siteManager.first_name} ${siteManager.last_name}`,
             orgName: incident.orgs.company_name,
           });
         })
       );

       const successful = emailResults.filter((r) => r.status === 'fulfilled').length;
       const failed = emailResults.filter((r) => r.status === 'rejected').length;

       return new Response(
         JSON.stringify({
           success: true,
           incidents_checked: incidents.length,
           emails_sent: successful,
           emails_failed: failed,
         }),
         { headers: { 'Content-Type': 'application/json' } }
       );
     } catch (error) {
       console.error('Deadline checker error:', error);
       return new Response(
         JSON.stringify({ error: error.message }),
         { status: 500 }
       );
     }
   });
   ```

**Important notes:**
1. **Exact date match:** Uses `deadline_date = threeDaysFromNow` to send emails once per milestone (not daily)
2. **Only medic-confirmed:** Only emails for incidents where medic has confirmed RIDDOR (not false positives)
3. **Draft status only:** Only emails for incidents not yet submitted to HSE
4. **Promise.allSettled:** Continues sending emails even if one fails
  </action>
  <verify>
```bash
# Deploy Edge Function
pnpm supabase functions deploy riddor-deadline-checker

# Test manually (simulate 3-day deadline)
curl -X POST https://[project-ref].supabase.co/functions/v1/riddor-deadline-checker \
  -H "Authorization: Bearer [service-role-key]"
```
  </verify>
  <done>Edge Function deployed with email templates, sends deadline reminders 3 days before HSE deadline to site managers</done>
</task>

<task type="auto">
  <name>Task 2: Create pg_cron job for daily deadline checking</name>
  <files>supabase/migrations/020_riddor_deadline_cron.sql</files>
  <action>
Create `supabase/migrations/020_riddor_deadline_cron.sql`:

```sql
-- 020_riddor_deadline_cron.sql
-- Schedule daily RIDDOR deadline checker at 9:00 AM UTC

-- Enable pg_cron extension (if not already enabled)
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Grant usage to postgres (required for cron jobs)
GRANT USAGE ON SCHEMA cron TO postgres;

-- Drop existing job if it exists (for migration idempotency)
SELECT cron.unschedule('riddor-deadline-checker');

-- Schedule RIDDOR deadline checker to run daily at 9:00 AM UTC
SELECT cron.schedule(
  'riddor-deadline-checker',
  '0 9 * * *', -- Daily at 9:00 AM UTC
  $$
  SELECT net.http_post(
    url := 'https://[PROJECT_REF].supabase.co/functions/v1/riddor-deadline-checker',
    headers := jsonb_build_object(
      'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key')
    ),
    body := '{}'::jsonb
  ) as request_id;
  $$
);

-- Comment for clarity
COMMENT ON EXTENSION pg_cron IS 'Daily RIDDOR deadline checker scheduled at 9:00 AM UTC to send 3-day deadline reminder emails to site managers';

-- Verify cron job created
SELECT * FROM cron.job WHERE jobname = 'riddor-deadline-checker';
```

**Important notes:**
1. **Placeholder replacement:** Replace `[PROJECT_REF]` with actual Supabase project reference before deploying
2. **Service role key:** Uses Vault secret `app.settings.service_role_key` (set in Supabase Dashboard)
3. **9:00 AM UTC:** Runs at start of UK working day (9 AM GMT / 10 AM BST)
4. **Idempotent:** Unschedules existing job before creating to allow re-running migration

**Configuration required before deployment:**
1. Set Vault secret in Supabase Dashboard:
   - Key: `app.settings.service_role_key`
   - Value: Service role key from project settings
2. Update `[PROJECT_REF]` in migration with actual project reference ID
  </action>
  <verify>
```bash
# Deploy migration
pnpm supabase db push

# Verify cron job scheduled
pnpm supabase db sql --query "SELECT * FROM cron.job WHERE jobname = 'riddor-deadline-checker'"

# Check cron job history after 24 hours
pnpm supabase db sql --query "SELECT * FROM cron.job_run_details WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'riddor-deadline-checker') ORDER BY start_time DESC LIMIT 5"
```
  </verify>
  <done>Cron job scheduled to run daily at 9:00 AM UTC, invoking riddor-deadline-checker Edge Function</done>
</task>

</tasks>

<verification>
**Overall Phase Checks:**

1. **Cron job scheduled:**
   - Job exists in `cron.job` table with correct schedule (0 9 * * *)
   - Job invokes riddor-deadline-checker Edge Function via net.http_post
   - Vault secret configured for service role authentication

2. **Email functionality:**
   - Edge Function sends emails via Resend API
   - Email template includes incident summary, deadline, and dashboard link
   - Emails only sent for incidents 3 days before deadline (not repeated daily)
   - Emails only sent for draft, medic-confirmed incidents

3. **Email content:**
   - Subject line shows urgency and days remaining
   - Body includes worker name, company, injury details
   - CTA button links to dashboard incident detail page
   - Footer includes HSE RIDDOR guidance link
</verification>

<success_criteria>
**Measurable Completion:**

1. Cron job visible in `SELECT * FROM cron.job WHERE jobname = 'riddor-deadline-checker'`
2. Cron job invocation logged in `cron.job_run_details` after 24 hours
3. Site manager receives email when RIDDOR deadline is exactly 3 days away
4. Email subject: "Important: RIDDOR Deadline in 3 days"
5. Email body contains incident summary (worker name, injury, deadline date)
6. Email CTA button links to https://app.sitemedic.com/riddor/{incident_id}
7. Edge Function returns `{"success":true,"emails_sent":N}` when incidents found
8. Edge Function returns `{"message":"No deadlines approaching today"}` when no incidents
</success_criteria>

<output>
After completion, create `.planning/phases/06-riddor-auto-flagging/06-05-SUMMARY.md`
</output>
