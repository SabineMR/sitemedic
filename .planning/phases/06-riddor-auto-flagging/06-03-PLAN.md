---
phase: 06-riddor-auto-flagging
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - supabase/functions/riddor-f2508-generator/index.ts
  - supabase/functions/riddor-f2508-generator/f2508-mapping.ts
  - supabase/functions/riddor-f2508-generator/types.ts
  - supabase/functions/riddor-f2508-generator/f2508-template.pdf
autonomous: true

must_haves:
  truths:
    - "Edge Function generates HSE F2508 PDF pre-filled with treatment data"
    - "F2508 sections populated: organisation, incident, injured person, injury, accident description"
    - "PDF stored in Supabase Storage with signed URL for download"
    - "Site manager can download F2508 from dashboard for HSE submission"
    - "F2508 generation completes in <10 seconds"
  artifacts:
    - path: "supabase/functions/riddor-f2508-generator/index.ts"
      provides: "Edge Function that generates pre-filled F2508 PDF"
      min_lines: 80
    - path: "supabase/functions/riddor-f2508-generator/f2508-mapping.ts"
      provides: "Maps treatment data to F2508 form fields"
      exports: ["mapTreatmentToF2508"]
    - path: "supabase/functions/riddor-f2508-generator/f2508-template.pdf"
      provides: "HSE F2508 blank PDF form (downloaded from HSE website)"
  key_links:
    - from: "supabase/functions/riddor-f2508-generator/index.ts"
      to: "supabase/functions/riddor-f2508-generator/f2508-mapping.ts"
      via: "Handler calls mapTreatmentToF2508 to get field values"
      pattern: "mapTreatmentToF2508"
    - from: "supabase/functions/riddor-f2508-generator/index.ts"
      to: "pdf-lib"
      via: "Loads F2508 template and fills form fields"
      pattern: "PDFDocument\\.load"
    - from: "supabase/functions/riddor-f2508-generator/index.ts"
      to: "supabase.storage.from('riddor-reports').upload"
      via: "Stores generated PDF in Supabase Storage"
      pattern: "storage.*riddor-reports.*upload"
---

<objective>
Create the HSE F2508 PDF generation Edge Function that pre-fills the official RIDDOR report form with treatment log data, stores it in Supabase Storage, and provides signed URLs for site manager download and HSE submission.

Purpose: This automates the most time-consuming part of RIDDOR compliance -- manually transcribing incident data into HSE F2508 form. Pre-filled PDFs reduce data entry errors and ensure consistent reporting format for HSE audits.

Output: A working Edge Function that accepts a riddor_incident_id, fetches treatment/worker/org data, fills F2508 PDF form fields using pdf-lib, and stores the result in Supabase Storage with a signed download URL.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-riddor-auto-flagging/06-RESEARCH.md
@.planning/phases/06-riddor-auto-flagging/06-01-PLAN.md

# Existing PDF generation pattern
@supabase/functions/generate-weekly-report/index.tsx

# Storage bucket reference
@supabase/migrations/015_safety_reports_storage.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download HSE F2508 template and create storage bucket migration</name>
  <files>
    supabase/migrations/019_riddor_reports_storage.sql
    supabase/functions/riddor-f2508-generator/f2508-template.pdf
  </files>
  <action>
1. **Download HSE F2508 blank PDF:**
   - Visit https://www.hse.gov.uk/riddor/report.htm
   - Download the official F2508 PDF form (or equivalent current HSE RIDDOR online form PDF)
   - Save to `supabase/functions/riddor-f2508-generator/f2508-template.pdf`

   **Note:** If HSE no longer provides a fillable PDF, use the online form structure to create a custom PDF template matching F2508 sections. Research indicates F2508 is the standard injury/dangerous occurrence report form.

2. **Create storage bucket migration:**
   ```sql
   -- 019_riddor_reports_storage.sql
   -- Create Supabase Storage bucket for RIDDOR F2508 PDFs

   INSERT INTO storage.buckets (id, name, public)
   VALUES ('riddor-reports', 'riddor-reports', false);

   -- RLS policies for riddor-reports bucket
   CREATE POLICY "Medics and managers can view RIDDOR reports for their org"
   ON storage.objects FOR SELECT
   USING (
     bucket_id = 'riddor-reports' AND
     EXISTS (
       SELECT 1 FROM riddor_incidents ri
       JOIN profiles p ON p.org_id = ri.org_id
       WHERE ri.id::text = (storage.foldername(name))[1]
       AND p.id = auth.uid()
     )
   );

   CREATE POLICY "Service role can insert RIDDOR reports"
   ON storage.objects FOR INSERT
   WITH CHECK (
     bucket_id = 'riddor-reports' AND
     auth.role() = 'service_role'
   );

   COMMENT ON POLICY "Medics and managers can view RIDDOR reports for their org" ON storage.objects
   IS 'Allows authenticated users to download F2508 PDFs for incidents in their organization';
   ```

3. **Deploy migration:**
   ```bash
   pnpm supabase db push
   ```

**Important:** F2508 template PDF must be committed to git so Edge Function can read it from filesystem. If HSE PDF is not fillable (no form fields), Plan 03 will need to pivot to @react-pdf/renderer custom template instead of pdf-lib form filling.
  </action>
  <verify>
```bash
# Check F2508 template exists
ls -lh supabase/functions/riddor-f2508-generator/f2508-template.pdf

# Verify storage bucket created
pnpm supabase db sql --query "SELECT * FROM storage.buckets WHERE id = 'riddor-reports'"
```
  </verify>
  <done>F2508 template PDF downloaded, storage bucket created with RLS policies for org-scoped access</done>
</task>

<task type="auto">
  <name>Task 2: Create F2508 field mapping and types</name>
  <files>
    supabase/functions/riddor-f2508-generator/types.ts
    supabase/functions/riddor-f2508-generator/f2508-mapping.ts
  </files>
  <action>
1. **types.ts** - TypeScript interfaces:
   ```typescript
   export interface F2508Data {
     // Section 1: About the organisation
     organisationName: string;
     organisationAddress: string;
     organisationPostcode: string;
     organisationPhone: string;

     // Section 2: About the incident
     incidentDate: string;
     incidentTime: string;
     incidentLocation: string;

     // Section 3: About the injured person
     injuredPersonName: string;
     injuredPersonJobTitle: string;
     injuredPersonEmployer: string;

     // Section 4: About the injury
     injuryType: string;
     injuryDetail: string;
     bodyPartAffected: string;

     // Section 5: About the kind of accident
     accidentType: string;

     // Section 6: Describing what happened
     incidentDescription: string;
   }

   export interface RIDDORIncidentData {
     id: string;
     category: string;
     treatments: {
       id: string;
       injury_type: string;
       body_part: string;
       severity: string;
       mechanism_of_injury: string;
       treatment_types: string[];
       outcome: string;
       created_at: string;
     };
     workers: {
       first_name: string;
       last_name: string;
       role: string;
       company: string;
     };
     orgs: {
       company_name: string;
       site_address: string;
       postcode: string;
       phone: string;
     };
   }
   ```

2. **f2508-mapping.ts** - Field mapping logic:
   ```typescript
   import { F2508Data, RIDDORIncidentData } from './types.ts';

   /**
    * Map RIDDOR incident data to F2508 form fields
    * Field names are placeholders - must inspect actual F2508 PDF to get correct names
    */
   export function mapTreatmentToF2508(incident: RIDDORIncidentData): F2508Data {
     const { treatments, workers, orgs } = incident;

     return {
       // Section 1: About the organisation
       organisationName: orgs.company_name,
       organisationAddress: orgs.site_address,
       organisationPostcode: orgs.postcode,
       organisationPhone: orgs.phone || 'Not provided',

       // Section 2: About the incident
       incidentDate: new Date(treatments.created_at).toLocaleDateString('en-GB'),
       incidentTime: new Date(treatments.created_at).toLocaleTimeString('en-GB', {
         hour: '2-digit',
         minute: '2-digit',
       }),
       incidentLocation: orgs.site_address,

       // Section 3: About the injured person
       injuredPersonName: `${workers.first_name} ${workers.last_name}`,
       injuredPersonJobTitle: workers.role,
       injuredPersonEmployer: workers.company,

       // Section 4: About the injury
       injuryType:
         incident.category === 'specified_injury'
           ? 'Specified Injury'
           : 'Over-7-day injury',
       injuryDetail: treatments.injury_type,
       bodyPartAffected: treatments.body_part || 'Not specified',

       // Section 5: About the kind of accident
       accidentType: treatments.mechanism_of_injury || 'Not specified',

       // Section 6: Describing what happened
       incidentDescription: `${treatments.mechanism_of_injury || 'Mechanism not recorded'}\n\nTreatment provided: ${
         treatments.treatment_types.join(', ') || 'None recorded'
       }\n\nOutcome: ${treatments.outcome || 'Not specified'}\n\nSeverity: ${treatments.severity}`,
     };
   }
   ```

**Important:** F2508 field names in this mapping are **placeholders**. Task 3 will inspect the actual F2508 PDF form fields and update the mapping with correct names.
  </action>
  <verify>
```bash
# Type check
cd supabase/functions/riddor-f2508-generator && deno check types.ts f2508-mapping.ts
```
  </verify>
  <done>F2508Data type and mapTreatmentToF2508 function created with placeholder field names (to be updated after F2508 PDF inspection)</done>
</task>

<task type="auto">
  <name>Task 3: Create F2508 PDF generation Edge Function</name>
  <files>supabase/functions/riddor-f2508-generator/index.ts</files>
  <action>
Create `supabase/functions/riddor-f2508-generator/index.ts`:

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import { PDFDocument } from 'https://esm.sh/pdf-lib@1.17.1';
import { mapTreatmentToF2508 } from './f2508-mapping.ts';
import type { RIDDORIncidentData } from './types.ts';

serve(async (req: Request) => {
  try {
    const { riddor_incident_id } = await req.json();

    if (!riddor_incident_id) {
      return new Response(
        JSON.stringify({ error: 'riddor_incident_id is required' }),
        { status: 400 }
      );
    }

    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    );

    // Fetch RIDDOR incident with treatment, worker, and org data
    const { data: incident, error: fetchError } = await supabase
      .from('riddor_incidents')
      .select(`
        *,
        treatments (*),
        workers (*),
        orgs:organizations (*)
      `)
      .eq('id', riddor_incident_id)
      .single();

    if (fetchError || !incident) {
      return new Response(
        JSON.stringify({ error: 'RIDDOR incident not found' }),
        { status: 404 }
      );
    }

    // Map treatment data to F2508 fields
    const f2508Data = mapTreatmentToF2508(incident as RIDDORIncidentData);

    // Load F2508 template PDF
    const templatePath = './f2508-template.pdf';
    const templateBytes = await Deno.readFile(templatePath);
    const pdfDoc = await PDFDocument.load(templateBytes);
    const form = pdfDoc.getForm();

    // IMPORTANT: Inspect F2508 PDF to get actual field names
    // Uncomment below to log available fields for debugging:
    // const fields = form.getFields();
    // console.log('Available F2508 fields:', fields.map(f => f.getName()));

    // Fill form fields (field names are placeholders - update after inspection)
    try {
      // Section 1: Organisation
      form.getTextField('OrganisationName')?.setText(f2508Data.organisationName);
      form.getTextField('OrganisationAddress')?.setText(f2508Data.organisationAddress);
      form.getTextField('OrganisationPostcode')?.setText(f2508Data.organisationPostcode);
      form.getTextField('OrganisationPhone')?.setText(f2508Data.organisationPhone);

      // Section 2: Incident
      form.getTextField('IncidentDate')?.setText(f2508Data.incidentDate);
      form.getTextField('IncidentTime')?.setText(f2508Data.incidentTime);
      form.getTextField('IncidentLocation')?.setText(f2508Data.incidentLocation);

      // Section 3: Injured person
      form.getTextField('InjuredPersonName')?.setText(f2508Data.injuredPersonName);
      form.getTextField('InjuredPersonJobTitle')?.setText(f2508Data.injuredPersonJobTitle);
      form.getTextField('InjuredPersonEmployer')?.setText(f2508Data.injuredPersonEmployer);

      // Section 4: Injury
      form.getTextField('InjuryType')?.setText(f2508Data.injuryType);
      form.getTextField('InjuryDetail')?.setText(f2508Data.injuryDetail);
      form.getTextField('BodyPartAffected')?.setText(f2508Data.bodyPartAffected);

      // Section 5: Accident type
      form.getTextField('AccidentType')?.setText(f2508Data.accidentType);

      // Section 6: Description
      form.getTextField('IncidentDescription')?.setText(f2508Data.incidentDescription);
    } catch (fieldError) {
      console.error('Error filling form fields:', fieldError);
      // Continue anyway - some fields may not exist in template
    }

    // Flatten form (make read-only) and save
    form.flatten();
    const pdfBytes = await pdfDoc.save();

    // Upload to Supabase Storage
    const fileName = `${riddor_incident_id}/F2508-${Date.now()}.pdf`;
    const { error: uploadError } = await supabase.storage
      .from('riddor-reports')
      .upload(fileName, pdfBytes, {
        contentType: 'application/pdf',
        upsert: false,
      });

    if (uploadError) {
      console.error('Storage upload error:', uploadError);
      return new Response(
        JSON.stringify({ error: 'Failed to store PDF' }),
        { status: 500 }
      );
    }

    // Update riddor_incidents with PDF path
    await supabase
      .from('riddor_incidents')
      .update({ f2508_pdf_path: fileName })
      .eq('id', riddor_incident_id);

    // Generate signed URL (7-day expiry)
    const { data: signedUrlData } = await supabase.storage
      .from('riddor-reports')
      .createSignedUrl(fileName, 604800); // 7 days in seconds

    return new Response(
      JSON.stringify({
        success: true,
        pdf_path: fileName,
        signed_url: signedUrlData?.signedUrl,
      }),
      { headers: { 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    console.error('F2508 generation error:', error);
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500 }
    );
  }
});
```

**Important notes:**
1. **Field name discovery:** After deploying, call Edge Function with test incident_id and log `form.getFields()` to discover actual F2508 field names. Update f2508-mapping.ts accordingly.
2. **Graceful degradation:** Wrapped field filling in try/catch so missing fields don't crash PDF generation.
3. **Storage path format:** `{incident_id}/F2508-{timestamp}.pdf` allows multiple F2508 versions per incident.
4. **Signed URL expiry:** 7 days matches weekly report pattern from Phase 5.
  </action>
  <verify>
```bash
# Deploy Edge Function
pnpm supabase functions deploy riddor-f2508-generator

# Test with sample RIDDOR incident
curl -X POST https://[project-ref].supabase.co/functions/v1/riddor-f2508-generator \
  -H "Authorization: Bearer [service-role-key]" \
  -H "Content-Type: application/json" \
  -d '{"riddor_incident_id":"[test-uuid]"}'

# Verify PDF stored in bucket
pnpm supabase storage ls riddor-reports
```
  </verify>
  <done>Edge Function deployed, generates F2508 PDF from treatment data, uploads to storage, and returns signed URL for download</done>
</task>

</tasks>

<verification>
**Overall Phase Checks:**

1. **F2508 template available:**
   - F2508 blank PDF exists at `supabase/functions/riddor-f2508-generator/f2508-template.pdf`
   - Template is fillable (has form fields) OR we're using @react-pdf/renderer custom template

2. **PDF generation functional:**
   - Edge Function loads template, fills fields, and saves
   - Generated PDF is valid (opens without errors)
   - Form fields populated with treatment data (not blank)

3. **Storage integration:**
   - PDF uploaded to `riddor-reports` bucket
   - Signed URL generated and returned
   - RLS policies allow org members to download
   - f2508_pdf_path updated in riddor_incidents table

4. **Performance:**
   - Generation completes in <10 seconds (PDF-01 requirement)
   - No memory issues with pdf-lib loading/saving
</verification>

<success_criteria>
**Measurable Completion:**

1. F2508 template PDF exists and is readable by Deno
2. Edge Function returns `{"success":true,"pdf_path":"...","signed_url":"..."}` for valid incident
3. Generated PDF viewable in browser via signed URL
4. F2508 sections populated: organisation name, incident date, injured person name, injury type visible in PDF
5. Multiple generations for same incident create separate files (timestamp in filename)
6. Generation completes in <10 seconds (measured with time command)
7. Storage bucket shows PDF files under `{incident_id}/` folder structure
</success_criteria>

<output>
After completion, create `.planning/phases/06-riddor-auto-flagging/06-03-SUMMARY.md`
</output>
