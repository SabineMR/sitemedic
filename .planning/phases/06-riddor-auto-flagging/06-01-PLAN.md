---
phase: 06-riddor-auto-flagging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/018_riddor_incidents.sql
  - supabase/functions/riddor-detector/index.ts
  - supabase/functions/riddor-detector/detection-rules.ts
  - supabase/functions/riddor-detector/confidence-scoring.ts
  - supabase/functions/riddor-detector/types.ts
autonomous: true

must_haves:
  truths:
    - "Treatment completion triggers RIDDOR detection algorithm automatically"
    - "RIDDOR incidents are created with confidence level (HIGH/MEDIUM/LOW) and deadline date"
    - "Detection algorithm matches injury_type + body_part against HSE specified injury criteria"
    - "Fractures exclude fingers, thumbs, and toes (HSE exception)"
    - "RIDDOR incidents track auto-flagged vs medic-confirmed status"
  artifacts:
    - path: "supabase/migrations/018_riddor_incidents.sql"
      provides: "riddor_incidents table with confidence, status, deadline, override tracking"
      contains: "CREATE TABLE riddor_incidents"
    - path: "supabase/functions/riddor-detector/index.ts"
      provides: "Edge Function that detects RIDDOR incidents on treatment completion"
      min_lines: 50
    - path: "supabase/functions/riddor-detector/detection-rules.ts"
      provides: "Rule-based detection algorithm matching HSE criteria"
      exports: ["detectRIDDOR"]
    - path: "supabase/functions/riddor-detector/confidence-scoring.ts"
      provides: "Confidence level calculation logic"
      exports: ["calculateConfidence"]
  key_links:
    - from: "supabase/functions/riddor-detector/index.ts"
      to: "supabase/functions/riddor-detector/detection-rules.ts"
      via: "Handler calls detectRIDDOR with treatment data"
      pattern: "detectRIDDOR"
    - from: "supabase/functions/riddor-detector/detection-rules.ts"
      to: "supabase/functions/riddor-detector/confidence-scoring.ts"
      via: "Detection result passed to calculateConfidence"
      pattern: "calculateConfidence"
    - from: "supabase/functions/riddor-detector/index.ts"
      to: "supabase.from('riddor_incidents').insert"
      via: "Creates RIDDOR incident record if criteria matched"
      pattern: "riddor_incidents.*insert"
---

<objective>
Create the RIDDOR detection infrastructure: database schema for tracking RIDDOR incidents with confidence levels and deadlines, plus the Edge Function that automatically evaluates treatments against HSE RIDDOR criteria using a rule-based algorithm.

Purpose: This is the foundation of Phase 6 -- automatic compliance detection that reduces missed reports by flagging RIDDOR-reportable incidents at point of care. The detection algorithm must be transparent, auditable, and tunable based on medic override patterns.

Output: A working RIDDOR detection system that auto-flags treatments matching specified injury criteria and creates riddor_incidents records with confidence levels and calculated deadlines.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-riddor-auto-flagging/06-RESEARCH.md

# Treatment schema reference
@supabase/migrations/00003_health_data_tables.sql
@src/database/schema.ts

# Existing Edge Function pattern
@supabase/functions/generate-weekly-report/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RIDDOR incidents database schema with tracking fields</name>
  <files>supabase/migrations/018_riddor_incidents.sql</files>
  <action>
Create migration file `018_riddor_incidents.sql` with:

1. **riddor_incidents table:**
   - `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - `treatment_id` UUID NOT NULL REFERENCES treatments(id) (the flagged treatment)
   - `worker_id` UUID NOT NULL REFERENCES workers(id) (denormalized for quick queries)
   - `org_id` UUID NOT NULL REFERENCES organizations(id) (multi-tenant)
   - `category` TEXT CHECK IN ('specified_injury', 'over_7_day', 'occupational_disease', 'dangerous_occurrence')
   - `confidence_level` TEXT CHECK IN ('HIGH', 'MEDIUM', 'LOW')
   - `auto_flagged` BOOLEAN DEFAULT TRUE (auto-detected vs manually created)
   - `medic_confirmed` BOOLEAN DEFAULT NULL (NULL = awaiting review, TRUE = confirmed, FALSE = dismissed)
   - `override_reason` TEXT (mandatory when medic confirms or dismisses)
   - `overridden_by` UUID REFERENCES profiles(id) (which medic made the decision)
   - `overridden_at` TIMESTAMPTZ
   - `deadline_date` DATE NOT NULL (10 days for specified_injury, 15 days for over_7_day)
   - `status` TEXT CHECK IN ('draft', 'submitted', 'confirmed') DEFAULT 'draft'
   - `f2508_pdf_path` TEXT (Supabase Storage path to generated F2508)
   - `submitted_at` TIMESTAMPTZ
   - `submitted_by` UUID REFERENCES profiles(id)
   - `detected_at` TIMESTAMPTZ DEFAULT NOW()
   - `created_at` TIMESTAMPTZ DEFAULT NOW()
   - `updated_at` TIMESTAMPTZ DEFAULT NOW()

2. **Indexes:**
   - `idx_riddor_incidents_org_id` ON org_id
   - `idx_riddor_incidents_treatment_id` ON treatment_id (unique to prevent duplicates)
   - `idx_riddor_incidents_deadline` ON deadline_date WHERE status = 'draft'
   - `idx_riddor_incidents_medic_confirmed` ON medic_confirmed WHERE medic_confirmed IS NULL

3. **updated_at trigger:**
   ```sql
   CREATE TRIGGER set_riddor_incidents_updated_at
     BEFORE UPDATE ON riddor_incidents
     FOR EACH ROW
     EXECUTE FUNCTION update_updated_at_column();
   ```

4. **RLS policies:**
   - Medics can view/update incidents for their org
   - Site managers can view incidents for their org
   - Service role can insert (Edge Function detection)

5. **Comment:**
   ```sql
   COMMENT ON TABLE riddor_incidents IS 'RIDDOR-reportable incidents with auto-detection confidence, medic override tracking, and deadline management';
   ```

**Important:** Use DATE type for deadline_date (not TIMESTAMPTZ) since RIDDOR deadlines are calendar days, not hours.
  </action>
  <verify>
```bash
# Deploy migration
pnpm supabase db push

# Verify table exists with correct schema
pnpm supabase db pull --schema public --table riddor_incidents
```
  </verify>
  <done>Migration deployed, riddor_incidents table exists with confidence, status, deadline, and override tracking fields</done>
</task>

<task type="auto">
  <name>Task 2: Create RIDDOR detection Edge Function with rule-based algorithm</name>
  <files>
    supabase/functions/riddor-detector/types.ts
    supabase/functions/riddor-detector/detection-rules.ts
    supabase/functions/riddor-detector/confidence-scoring.ts
    supabase/functions/riddor-detector/index.ts
  </files>
  <action>
1. **types.ts** - TypeScript interfaces:
   ```typescript
   export interface RIDDORDetection {
     is_riddor: boolean;
     category: 'specified_injury' | 'over_7_day' | 'occupational_disease' | 'dangerous_occurrence' | null;
     reason: string;
     criteria_matched: string[];
   }

   export type ConfidenceLevel = 'HIGH' | 'MEDIUM' | 'LOW';

   export interface TreatmentInput {
     injury_type: string;
     body_part: string;
     severity: string;
     treatment_types: string[];
     outcome: string;
   }
   ```

2. **detection-rules.ts** - Rule-based detection algorithm:
   Follow Research Code Example "RIDDOR Detection Rules" exactly:
   - Check fracture + body_part (exclude hand_finger, hand_thumb, foot_toe)
   - Check amputation (all reportable)
   - Check head_eye + major severity for vision loss
   - Check crush + head/torso
   - Check burn + major/critical severity
   - Check over-7-day from outcome parsing (e.g., "off work 10 days")

   Export `detectRIDDOR(treatment: TreatmentInput): RIDDORDetection`

   **Important:** Use exact string matching against taxonomy values from `src/data/taxonomy.ts`. Do NOT use fuzzy matching or ML initially.

3. **confidence-scoring.ts** - Confidence calculation:
   Follow Research Code Example "Confidence Level Calculation":
   - HIGH: Multiple criteria matched OR unambiguous injury (amputation, fracture)
   - MEDIUM: Single specified_injury criterion
   - LOW: Inferred from severity/outcome

   Export `calculateConfidence(detection: RIDDORDetection): ConfidenceLevel`

4. **index.ts** - Edge Function handler:
   ```typescript
   import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
   import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
   import { detectRIDDOR } from './detection-rules.ts';
   import { calculateConfidence } from './confidence-scoring.ts';

   serve(async (req: Request) => {
     const { treatment_id } = await req.json();
     const supabase = createClient(
       Deno.env.get('SUPABASE_URL')!,
       Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
     );

     // Fetch treatment
     const { data: treatment, error } = await supabase
       .from('treatments')
       .select('*')
       .eq('id', treatment_id)
       .single();

     if (error || !treatment) {
       return new Response(JSON.stringify({ error: 'Treatment not found' }), { status: 404 });
     }

     // Run detection
     const detection = detectRIDDOR({
       injury_type: treatment.injury_type,
       body_part: treatment.body_part,
       severity: treatment.severity,
       treatment_types: treatment.treatment_types || [],
       outcome: treatment.outcome || '',
     });

     if (detection.is_riddor) {
       const confidence = calculateConfidence(detection);

       // Calculate deadline (10 days for specified_injury, 15 days for over_7_day)
       const deadlineDays = detection.category === 'specified_injury' ? 10 : 15;
       const deadline = new Date(treatment.created_at);
       deadline.setDate(deadline.getDate() + deadlineDays);

       // Create RIDDOR incident (ignore if duplicate - treatment_id unique index)
       const { error: insertError } = await supabase
         .from('riddor_incidents')
         .insert({
           treatment_id: treatment.id,
           worker_id: treatment.worker_id,
           org_id: treatment.org_id,
           category: detection.category,
           confidence_level: confidence,
           auto_flagged: true,
           medic_confirmed: null,
           deadline_date: deadline.toISOString().split('T')[0], // DATE format YYYY-MM-DD
           status: 'draft',
           detected_at: new Date().toISOString(),
         });

       // Ignore duplicate errors (23505 = unique violation)
       if (insertError && !insertError.message.includes('23505')) {
         return new Response(JSON.stringify({ error: insertError.message }), { status: 500 });
       }
     }

     return new Response(
       JSON.stringify({
         detected: detection.is_riddor,
         category: detection.category,
         reason: detection.reason,
       }),
       { headers: { 'Content-Type': 'application/json' } }
     );
   });
   ```

**Important:** Edge Function should be idempotent - calling it multiple times with same treatment_id should not create duplicate RIDDOR incidents (use unique index on treatment_id).
  </action>
  <verify>
```bash
# Deploy Edge Function
pnpm supabase functions deploy riddor-detector

# Test with sample treatment (fracture, not finger)
curl -X POST https://[project-ref].supabase.co/functions/v1/riddor-detector \
  -H "Authorization: Bearer [anon-key]" \
  -H "Content-Type: application/json" \
  -d '{"treatment_id":"[test-uuid]"}'

# Verify RIDDOR incident created
pnpm supabase db sql --query "SELECT * FROM riddor_incidents WHERE treatment_id = '[test-uuid]'"
```
  </verify>
  <done>Edge Function deployed, detection algorithm correctly flags specified injuries (excluding finger/thumb/toe fractures), creates riddor_incidents with confidence levels and deadline dates</done>
</task>

</tasks>

<verification>
**Overall Phase Checks:**

1. **Database schema complete:**
   - riddor_incidents table exists with all tracking fields
   - Indexes created for performance (org_id, treatment_id, deadline_date)
   - RLS policies allow medics and managers to query their org's incidents

2. **Detection algorithm accurate:**
   - Fracture detection excludes fingers, thumbs, toes (HSE exception)
   - All amputations flagged as HIGH confidence
   - Over-7-day detection parses outcome field correctly
   - Confidence scoring uses multi-signal approach (not single field)

3. **Integration ready:**
   - Edge Function callable from mobile app treatment completion flow
   - Idempotent (duplicate calls don't create multiple incidents)
   - Deadline calculation matches HSE requirements (10 or 15 days)
</verification>

<success_criteria>
**Measurable Completion:**

1. `supabase/migrations/018_riddor_incidents.sql` deployed successfully
2. `riddor_incidents` table queryable with `SELECT * FROM riddor_incidents LIMIT 1`
3. Edge Function returns `{"detected":true,"category":"specified_injury"}` for fracture test
4. Edge Function returns `{"detected":false}` for finger fracture test (excluded)
5. RIDDOR incident created with correct deadline_date (created_at + 10 days for specified_injury)
6. Confidence level matches expectation (HIGH for fracture, MEDIUM for single criterion)
7. Duplicate detection calls ignored (no PostgreSQL 23505 error surfaced to caller)
</success_criteria>

<output>
After completion, create `.planning/phases/06-riddor-auto-flagging/06-01-SUMMARY.md`
</output>
