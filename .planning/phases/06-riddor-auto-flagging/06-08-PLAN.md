---
phase: 06-riddor-auto-flagging
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/(dashboard)/riddor/page.tsx
  - web/app/(dashboard)/riddor/analytics/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "RIDDOR list page fetches incidents using authenticated user's org_id from useOrg() hook"
    - "RIDDOR analytics page fetches stats and reasons using authenticated user's org_id from useOrg() hook"
    - "No hardcoded org_id values remain in RIDDOR dashboard files"
    - "Pages show loading state while org context loads"
    - "Pages handle missing org_id gracefully (show message, not crash)"
  artifacts:
    - path: "web/app/(dashboard)/riddor/page.tsx"
      provides: "RIDDOR list page with dynamic org_id from auth context"
      contains: "useOrg"
    - path: "web/app/(dashboard)/riddor/analytics/page.tsx"
      provides: "RIDDOR analytics page with dynamic org_id from auth context"
      contains: "useOrg"
  key_links:
    - from: "web/app/(dashboard)/riddor/page.tsx"
      to: "web/contexts/org-context.tsx"
      via: "useOrg() hook import"
      pattern: "import.*useOrg.*from.*org-context"
    - from: "web/app/(dashboard)/riddor/analytics/page.tsx"
      to: "web/contexts/org-context.tsx"
      via: "useOrg() hook import"
      pattern: "import.*useOrg.*from.*org-context"
---

<objective>
Replace hardcoded demo org_id with dynamic auth context in RIDDOR dashboard pages.

Purpose: The RIDDOR list page and analytics page both use a hardcoded `orgId = '10000000-0000-0000-0000-000000000001'` instead of the authenticated user's organization. This means in production, these pages would either show the wrong org's data or no data at all. The fix uses the existing `useOrg()` hook from `@/contexts/org-context` (already mounted via `OrgProvider` in `web/app/layout.tsx`) to get the real org_id from the user's JWT app_metadata.

Output: Two modified React client components with proper auth context integration.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-riddor-auto-flagging/06-VERIFICATION.md

# Key reference files
@web/contexts/org-context.tsx
@web/app/(dashboard)/riddor/page.tsx
@web/app/(dashboard)/riddor/analytics/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded org_id in RIDDOR list page</name>
  <files>web/app/(dashboard)/riddor/page.tsx</files>
  <action>
    Modify `web/app/(dashboard)/riddor/page.tsx` to use the `useOrg()` hook instead of hardcoded org_id:

    1. Add import: `import { useOrg } from '@/contexts/org-context';`

    2. Inside the `RIDDORPage` component, add at the top:
       ```tsx
       const { orgId, loading: orgLoading } = useOrg();
       ```

    3. Replace the hardcoded orgId in the useQuery queryFn (line 27):
       - BEFORE: `const orgId = '10000000-0000-0000-0000-000000000001';`
       - AFTER: Remove this line entirely. The orgId now comes from useOrg() above.

    4. Update the useQuery to be dependent on orgId:
       - Add `orgId` to the queryKey: `queryKey: ['riddor-incidents', orgId, statusFilter]`
       - Add `enabled: !!orgId` to prevent query from running before org context loads
       - The queryFn should use the `orgId` variable from useOrg() directly (it's already in scope)

    5. Add loading/error handling before the main return:
       ```tsx
       if (orgLoading) {
         return <div className="text-center py-8 text-muted-foreground">Loading...</div>;
       }

       if (!orgId) {
         return <div className="text-center py-8 text-muted-foreground">No organization assigned</div>;
       }
       ```

    6. Remove the "For demo" comment that was on line 26.

    Keep everything else in the component exactly the same (stats cards, filters, incident list rendering).
  </action>
  <verify>
    1. No hardcoded org_id: `grep -c '10000000' web/app/\(dashboard\)/riddor/page.tsx` returns 0
    2. Uses useOrg: `grep 'useOrg' web/app/\(dashboard\)/riddor/page.tsx`
    3. Has enabled guard: `grep 'enabled.*orgId' web/app/\(dashboard\)/riddor/page.tsx`
    4. TypeScript compiles: `cd web && npx tsc --noEmit web/app/\(dashboard\)/riddor/page.tsx 2>&1 | head -5` (or check build)
  </verify>
  <done>RIDDOR list page fetches incidents using the authenticated user's org_id from useOrg() hook, with proper loading state and enabled guard.</done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded org_id in RIDDOR analytics page</name>
  <files>web/app/(dashboard)/riddor/analytics/page.tsx</files>
  <action>
    Modify `web/app/(dashboard)/riddor/analytics/page.tsx` to use the `useOrg()` hook instead of hardcoded org_id:

    1. Add import: `import { useOrg } from '@/contexts/org-context';`

    2. Inside the `RIDDORAnalyticsPage` component, add at the top:
       ```tsx
       const { orgId, loading: orgLoading } = useOrg();
       ```

    3. Replace BOTH hardcoded orgId values:
       - Line 24: `const orgId = '10000000-0000-0000-0000-000000000001';` -> REMOVE (use orgId from useOrg())
       - Line 34: `const orgId = '10000000-0000-0000-0000-000000000001';` -> REMOVE (use orgId from useOrg())

    4. Update both useQuery hooks:
       - Stats query: Add `orgId` to queryKey `['riddor-override-stats', orgId]`, add `enabled: !!orgId`
       - Reasons query: Add `orgId` to queryKey `['riddor-override-reasons', orgId]`, add `enabled: !!orgId`
       - Both queryFn functions should use the `orgId` from useOrg() directly (it's in scope)

    5. Add loading/error handling before the main return:
       ```tsx
       if (orgLoading) {
         return <div className="text-center py-8 text-muted-foreground">Loading...</div>;
       }

       if (!orgId) {
         return <div className="text-center py-8 text-muted-foreground">No organization assigned</div>;
       }
       ```

    6. Remove the "For demo" comments that were on lines 23 and 33.

    Keep everything else in the component exactly the same (chart rendering, alert threshold, reason display).
  </action>
  <verify>
    1. No hardcoded org_id: `grep -c '10000000' web/app/\(dashboard\)/riddor/analytics/page.tsx` returns 0
    2. Uses useOrg: `grep 'useOrg' web/app/\(dashboard\)/riddor/analytics/page.tsx`
    3. Both queries have enabled guard: `grep -c 'enabled.*orgId' web/app/\(dashboard\)/riddor/analytics/page.tsx` returns 2
    4. No remaining hardcoded UUIDs in RIDDOR pages: `grep -r '10000000' web/app/\(dashboard\)/riddor/` returns empty
  </verify>
  <done>RIDDOR analytics page fetches override stats and reasons using authenticated user's org_id from useOrg() hook, with proper loading state and enabled guards on both queries. Zero hardcoded org_id values remain in any RIDDOR dashboard file.</done>
</task>

</tasks>

<verification>
1. Zero occurrences of '10000000' in RIDDOR dashboard directory: `grep -r '10000000' web/app/(dashboard)/riddor/`
2. Both modified files import useOrg from org-context
3. All TanStack Query hooks have `enabled: !!orgId` guard to prevent queries with null org
4. Both pages handle loading and missing-org states gracefully
5. Build passes: `cd web && pnpm build` (or at minimum TypeScript check)
</verification>

<success_criteria>
All RIDDOR dashboard pages use dynamic org_id from auth context. No hardcoded demo values remain. Pages gracefully handle loading states and missing organization assignments.
</success_criteria>

<output>
After completion, create `.planning/phases/06-riddor-auto-flagging/06-08-SUMMARY.md`
</output>
