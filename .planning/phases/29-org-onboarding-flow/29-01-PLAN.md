---
phase: 29-org-onboarding-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/api/billing/checkout/route.ts
  - web/app/api/billing/checkout-status/route.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/billing/checkout with a valid tier and org details creates a Stripe Checkout Session and returns the session URL"
    - "The Checkout Session metadata includes org_id so the billing webhook can write subscription data"
    - "The org is created with onboarding_completed=false before the Checkout redirect"
    - "An org_branding row is INSERTed for the new org (no auto-trigger exists)"
    - "GET /api/billing/checkout-status returns the org subscription state for post-payment polling"
  artifacts:
    - path: "web/app/api/billing/checkout/route.ts"
      provides: "Stripe Checkout Session creation with org + branding provisioning"
      exports: ["POST"]
    - path: "web/app/api/billing/checkout-status/route.ts"
      provides: "Subscription status polling endpoint for post-payment redirect"
      exports: ["GET"]
  key_links:
    - from: "web/app/api/billing/checkout/route.ts"
      to: "web/lib/stripe/server.ts"
      via: "stripe.checkout.sessions.create()"
      pattern: "stripe\\.checkout\\.sessions\\.create"
    - from: "web/app/api/billing/checkout/route.ts"
      to: "organizations table"
      via: "supabase service-role insert"
      pattern: "from\\('organizations'\\)\\.insert"
    - from: "web/app/api/billing/checkout/route.ts"
      to: "org_branding table"
      via: "supabase service-role insert"
      pattern: "from\\('org_branding'\\)\\.insert"
    - from: "web/app/api/stripe/billing-webhooks/route.ts"
      to: "organizations table"
      via: "metadata.org_id from Checkout Session"
      pattern: "session\\.metadata\\?\\.org_id"
---

<objective>
Create the Stripe Checkout API route that provisions a new org, creates the org_branding row, creates a Stripe Customer, and returns a Checkout Session URL. Also create a checkout-status endpoint for post-payment polling.

Purpose: This is the foundation of the onboarding flow. The billing webhook (already built in Phase 25) expects `metadata.org_id` on the Checkout Session — so the org MUST exist before Stripe Checkout is initiated. This plan creates the backend routes that the signup page (29-02) will call.

Output: Two API route handlers — one for creating Checkout Sessions, one for polling checkout/subscription status.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@web/app/api/stripe/billing-webhooks/route.ts
@web/lib/stripe/server.ts
@web/lib/billing/feature-gates.ts
@web/app/setup/organization/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe Checkout route with org provisioning</name>
  <files>web/app/api/billing/checkout/route.ts</files>
  <action>
Create POST handler at `web/app/api/billing/checkout/route.ts` that:

1. **Auth check:** Get the authenticated user via Supabase server client (createClient from `@/lib/supabase/server`). Return 401 if not authenticated.

2. **Parse request body:** Extract `{ tier, orgName, contactEmail, contactPhone, address, postcode }` from JSON body. Validate that `tier` is one of `'starter' | 'growth' | 'enterprise'` and `orgName` + `contactEmail` are non-empty. Return 400 on validation failure.

3. **Map tier to Stripe Price ID:** Use env vars `STRIPE_PRICE_STARTER`, `STRIPE_PRICE_GROWTH`, `STRIPE_PRICE_ENTERPRISE`. These are comma-separated (multiple currencies) — take the FIRST price ID (GBP monthly). Return 500 if env var missing.

4. **Create organization via service-role client:** Use same pattern as billing webhook — create a service-role Supabase client with `SUPABASE_SERVICE_ROLE_KEY`. Insert into `organizations` table:
   - `name: orgName.trim()`
   - `contact_email: contactEmail.trim()`
   - `contact_phone: contactPhone?.trim() || null`
   - `address: address?.trim() || null`
   - `postcode: postcode?.trim() || null`
   - `created_by: user.id`
   - `status: 'active'` (existing column from migration 027)
   - `onboarding_completed: false` (existing column — this means "pending activation")
   Return 500 if insert fails.

5. **Create org_branding row:** INSERT into `org_branding` table with `org_id` = new org ID and `company_name` = orgName. This is MANDATORY — Phase 24-05 documented that new orgs do NOT auto-get org_branding rows.

6. **Create org_membership:** INSERT into `org_memberships` with `org_id` = new org ID, `user_id` = user.id, `role: 'org_admin'`.

7. **Update user app_metadata:** Call Supabase Admin auth API to set `app_metadata.org_id` on the user so middleware can associate them with the org. Use the service-role client: `supabase.auth.admin.updateUserById(user.id, { app_metadata: { org_id: org.id, role: 'org_admin' } })`.

8. **Create Stripe Customer:** `stripe.customers.create({ email: contactEmail, name: orgName, metadata: { org_id: org.id } })`.

9. **Create Checkout Session:** `stripe.checkout.sessions.create({...})` with:
   - `customer: customer.id`
   - `mode: 'subscription'`
   - `line_items: [{ price: priceId, quantity: 1 }]`
   - `metadata: { org_id: org.id }` — CRITICAL for billing webhook
   - `success_url: \`${origin}/onboarding?session_id={CHECKOUT_SESSION_ID}\``
   - `cancel_url: \`${origin}/signup?cancelled=true\``
   - Get `origin` from `request.headers.get('origin')` or `request.headers.get('referer')` or fall back to `process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:30500'`

10. **Return response:** `{ url: session.url, orgId: org.id }`

Set `export const dynamic = 'force-dynamic';` and `export const runtime = 'nodejs';`.

IMPORTANT: Do NOT create any database migrations. Use existing columns `status` and `onboarding_completed` on the organizations table.
  </action>
  <verify>
Run `pnpm build` in the web directory — no TypeScript errors on the new route. Verify the file exists and imports stripe from `@/lib/stripe/server`.
  </verify>
  <done>POST /api/billing/checkout accepts tier + org details, creates org + org_branding + membership + Stripe Customer + Checkout Session, returns session URL with org_id in metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Create checkout status polling endpoint</name>
  <files>web/app/api/billing/checkout-status/route.ts</files>
  <action>
Create GET handler at `web/app/api/billing/checkout-status/route.ts` that:

1. **Auth check:** Get authenticated user. Return 401 if not authenticated.

2. **Get org_id:** Read `user.app_metadata.org_id`. Return 404 if no org_id.

3. **Fetch org subscription state:** Query organizations table via service-role client for the user's org_id. Select `subscription_status, subscription_tier, stripe_customer_id, onboarding_completed`.

4. **Return status:** `{ subscriptionStatus, subscriptionTier, stripeCustomerId, onboardingCompleted, isPending }` where `isPending = !onboardingCompleted`.

This endpoint is used by the post-payment onboarding page (29-03) to poll for webhook completion — the Checkout Session redirects the user back before the webhook has fired, so the client polls this endpoint until `subscriptionStatus` transitions from null to 'active'.

Set `export const dynamic = 'force-dynamic';`.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. The file exports a GET handler.
  </verify>
  <done>GET /api/billing/checkout-status returns the org's subscription state and onboarding status for the authenticated user.</done>
</task>

</tasks>

<verification>
1. `pnpm build` in the web directory completes without TypeScript errors
2. Both route files exist with correct exports (POST for checkout, GET for checkout-status)
3. The checkout route creates org with `onboarding_completed: false` (NOT a new column — this exists from migration 027)
4. The checkout route INSERTs org_branding row explicitly
5. Checkout Session metadata includes `org_id` matching the billing webhook's expected `session.metadata?.org_id`
6. No new database migrations created
</verification>

<success_criteria>
- POST /api/billing/checkout creates a complete org provisioning chain (org + branding + membership + Stripe Customer + Checkout Session)
- GET /api/billing/checkout-status returns subscription polling data
- Both routes build without errors
- No database schema changes
</success_criteria>

<output>
After completion, create `.planning/phases/29-org-onboarding-flow/29-01-SUMMARY.md`
</output>
