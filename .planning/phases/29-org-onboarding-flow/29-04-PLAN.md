---
phase: 29-org-onboarding-flow
plan: 04
type: execute
wave: 3
depends_on: ["29-03", "29-05"]
files_modified:
  - web/app/platform/organizations/page.tsx
  - web/app/api/platform/organizations/activate/route.ts
autonomous: false

must_haves:
  truths:
    - "Platform admin sees a 'Pending Activation' section at the top of the organizations page showing orgs with onboarding_completed=false and subscription_status IS NOT NULL"
    - "Each pending org shows: company name, plan tier, signup timestamp, and Stripe dashboard link"
    - "Clicking 'Activate' on a pending org: assigns a slug (for Growth/Enterprise), sets onboarding_completed=true, and sends the welcome email"
    - "After activation, the org disappears from the pending queue and appears in the active organizations list"
    - "Starter-tier orgs do not get a subdomain slug assigned during activation"
  artifacts:
    - path: "web/app/platform/organizations/page.tsx"
      provides: "Updated platform organizations page with pending activation queue"
    - path: "web/app/api/platform/organizations/activate/route.ts"
      provides: "Activation API endpoint for platform admin"
      exports: ["POST"]
  key_links:
    - from: "web/app/platform/organizations/page.tsx"
      to: "web/app/api/platform/organizations/activate/route.ts"
      via: "fetch POST /api/platform/organizations/activate"
      pattern: "fetch.*api/platform/organizations/activate"
    - from: "web/app/api/platform/organizations/activate/route.ts"
      to: "web/lib/email/send-welcome.ts"
      via: "sendWelcomeEmail() call"
      pattern: "sendWelcomeEmail"
    - from: "web/app/api/platform/organizations/activate/route.ts"
      to: "organizations table"
      via: "update onboarding_completed and slug"
      pattern: "from\\('organizations'\\)\\.update"
---

<objective>
Add a pending activation queue to the platform admin organizations page and create the activation API route that approves new orgs, assigns subdomains, and triggers the welcome email.

Purpose: Platform admin (Sabine) needs to review each new signup before the org goes live. This is the "human in the loop" step that ensures quality control over who uses the platform. The activation route ties together slug assignment, welcome email, and the onboarding_completed flag.

Output: Updated organizations page with activation queue and a new activation API route.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@web/app/platform/organizations/page.tsx
@web/lib/email/send-welcome.ts
@.planning/phases/29-org-onboarding-flow/29-03-SUMMARY.md
@.planning/phases/29-org-onboarding-flow/29-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activation API route</name>
  <files>web/app/api/platform/organizations/activate/route.ts</files>
  <action>
Create POST handler at `web/app/api/platform/organizations/activate/route.ts`:

1. **Auth check:** Get authenticated user via Supabase server client. Check `user.app_metadata.role === 'platform_admin'`. Return 403 if not platform admin.

2. **Parse request body:** Extract `{ orgId, slug }` from JSON body. `orgId` is required. `slug` is optional (only needed for Growth/Enterprise).

3. **Create service-role Supabase client** (same pattern as billing webhook).

4. **Fetch the org:** `supabase.from('organizations').select('id, name, contact_email, subscription_tier, subscription_status, onboarding_completed, created_by').eq('id', orgId).single()`. Return 404 if not found.

5. **Validate:** Return 400 if `onboarding_completed` is already `true` ("Organization is already activated").

6. **Slug assignment for Growth/Enterprise:**
   - If `subscription_tier` is `'growth'` or `'enterprise'`:
     - `slug` must be provided in the request body. Return 400 if missing with message "Slug is required for Growth/Enterprise orgs".
     - Validate slug format: lowercase alphanumeric + hyphens only, 3-30 chars: `/^[a-z0-9][a-z0-9-]{1,28}[a-z0-9]$/`. Return 400 if invalid.
     - Check uniqueness: `supabase.from('organizations').select('id').eq('slug', slug).maybeSingle()`. Return 409 if slug already taken.
     - Update org: `supabase.from('organizations').update({ slug, onboarding_completed: true }).eq('id', orgId)`.
   - If `subscription_tier` is `'starter'`:
     - No slug assignment. Update org: `supabase.from('organizations').update({ onboarding_completed: true }).eq('id', orgId)`.

7. **Get org admin info:** Fetch the org creator's profile for the welcome email: `supabase.from('profiles').select('full_name').eq('id', org.created_by).single()`. Also get the user's email from `supabase.auth.admin.getUserById(org.created_by)`.

8. **Get branding:** Fetch org_branding for company name: `supabase.from('org_branding').select('company_name').eq('org_id', orgId).single()`.

9. **Send welcome email:** Call `sendWelcomeEmail({ orgId, orgAdminEmail: userEmail, orgAdminName: profile.full_name || 'there', slug: slug || undefined, planName: tierDisplayName })` where `tierDisplayName` maps `'starter'` -> `'Starter'`, `'growth'` -> `'Growth'`, `'enterprise'` -> `'Enterprise'`.

10. **Return success:** `{ success: true, slug: slug || null, welcomeEmailSent: true }`.

Set `export const dynamic = 'force-dynamic';`.

Import `sendWelcomeEmail` from `@/lib/email/send-welcome`.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. The route file exists with POST export.
  </verify>
  <done>POST /api/platform/organizations/activate validates platform admin, assigns slug for Growth+, sets onboarding_completed=true, sends welcome email.</done>
</task>

<task type="auto">
  <name>Task 2: Add pending activation queue to organizations page</name>
  <files>web/app/platform/organizations/page.tsx</files>
  <action>
Update `web/app/platform/organizations/page.tsx` to add a pending activation section above the existing organizations grid.

**New data fetching:**

Add a second useEffect (or extend the existing one) to fetch pending orgs. These are orgs with `onboarding_completed = false` AND `subscription_status IS NOT NULL` (they've paid but aren't activated yet):

```typescript
const { data: pendingOrgs } = await supabase
  .from('organizations')
  .select(`
    id, name, slug, created_at, subscription_tier, subscription_status, stripe_customer_id,
    org_branding ( company_name )
  `)
  .eq('onboarding_completed', false)
  .not('subscription_status', 'is', null)
  .order('created_at', { ascending: false });
```

**Add to Organization interface:**
```typescript
subscription_tier?: string;
subscription_status?: string;
stripe_customer_id?: string;
onboarding_completed?: boolean;
company_name?: string; // from org_branding join
```

**Pending Activation Section (rendered above the search bar):**

If `pendingOrgs.length > 0`, show:

```
┌─────────────────────────────────────────────────┐
│ ⚠️  Pending Activation ({count})                 │
│                                                   │
│ ┌─────────────────────────────────────────────┐  │
│ │ Company Name          Plan: Growth          │  │
│ │ Signed up: 18 Feb 2026                      │  │
│ │ [Stripe ↗] [Slug input____] [Activate ✓]   │  │
│ └─────────────────────────────────────────────┘  │
│                                                   │
│ ┌─────────────────────────────────────────────┐  │
│ │ Another Company       Plan: Starter         │  │
│ │ Signed up: 18 Feb 2026                      │  │
│ │ [Stripe ↗]            [Activate ✓]          │  │
│ └─────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

Each pending org card shows:
- **Company name** (from org_branding join, fallback to org.name)
- **Plan tier badge** (colour-coded: starter=gray, growth=blue, enterprise=purple)
- **Signup date** (formatted: "18 February 2026")
- **Stripe Dashboard link** (if stripe_customer_id exists): `https://dashboard.stripe.com/test/customers/${stripe_customer_id}` — opens in new tab
- **Slug input** (only for Growth/Enterprise tiers): text input for subdomain slug, pre-populated with slugified company name (lowercase, replace spaces/special chars with hyphens)
- **Activate button:** Calls POST `/api/platform/organizations/activate` with `{ orgId, slug }`. Shows spinner while loading. On success, remove from pending list and refresh the active orgs list. Use `toast.success('Organization activated!')` from sonner.

**Styling for pending section:**
- Yellow/amber accent: `bg-amber-900/20 border border-amber-700/50 rounded-2xl p-6`
- Section heading: `text-amber-300` with AlertTriangle icon from lucide-react
- Card inside: `bg-amber-800/20 border border-amber-700/30 rounded-xl p-4`
- Activate button: `bg-green-600 hover:bg-green-700 text-white rounded-lg px-4 py-2`

**Badge display for existing org cards:**

Update the existing org cards in the grid to show the subscription tier badge alongside the "Active" badge. Map tier to display:
- starter: gray badge
- growth: blue badge
- enterprise: purple badge
- null: no badge (legacy)

This requires updating the data fetch for active orgs to include `subscription_tier`. Since the RPC `get_platform_organizations()` already returns `status` from orgs, update the Organization interface and the data mapping to include tier. Fetch tier separately or adjust the query:

```typescript
// After the RPC call, enrich with subscription data
const { data: subsData } = await supabase
  .from('organizations')
  .select('id, subscription_tier')
  .in('id', orgs.map((o: any) => o.id));
```

Merge `subscription_tier` into the orgs array by matching on id.

Import `toast` from `sonner`, `AlertTriangle` from `lucide-react`.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. The organizations page renders the pending section when pending orgs exist. Verify the Activate button calls the correct API endpoint.
  </verify>
  <done>Platform admin organizations page shows pending activation queue with company name, plan, signup date, Stripe link, slug input (Growth/Enterprise), and Activate button. Active orgs show tier badges.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete org onboarding flow: signup -> checkout -> onboarding wizard -> platform admin activation -> welcome email</what-built>
  <how-to-verify>
1. Start the dev server: `pnpm dev` (port 30500)
2. Visit http://localhost:30500/signup — verify 3 plan cards render with correct pricing
3. Select a plan and fill in the form — verify magic link is sent
4. After auth, verify the checkout API is called and org + org_branding rows are created
5. (Stripe test mode) Complete checkout — verify redirect to /onboarding
6. Visit /onboarding — verify payment status polling works
7. Visit /onboarding/branding — verify logo upload, colour picker, company name form
8. Log in as platform admin — visit /platform/organizations
9. Verify pending activation queue shows the new org
10. Click Activate (with slug for Growth/Enterprise) — verify org is activated
11. Check email (or dev console) for welcome email
12. Verify the org admin can now access /admin (redirected from /onboarding)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm build` completes without TypeScript errors
2. Pending activation queue shows orgs with onboarding_completed=false and active subscription
3. Activate button sets onboarding_completed=true, assigns slug (Growth+), sends welcome email
4. Org disappears from pending queue after activation
5. Existing org cards show tier badges
6. No database schema changes
</verification>

<success_criteria>
- Platform admin can see and activate pending orgs
- Slug assignment enforced for Growth/Enterprise, skipped for Starter
- Welcome email sent on activation
- Full end-to-end flow works: signup -> payment -> onboarding -> activation -> dashboard access
</success_criteria>

<output>
After completion, create `.planning/phases/29-org-onboarding-flow/29-04-SUMMARY.md`
</output>
