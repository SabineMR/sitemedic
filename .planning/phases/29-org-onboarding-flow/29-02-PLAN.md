---
phase: 29-org-onboarding-flow
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - web/app/(auth)/signup/page.tsx
autonomous: true

must_haves:
  truths:
    - "Visiting /signup shows a plan selector with 3 tiers (Starter, Growth, Enterprise) and their monthly prices"
    - "User can fill in account details (name, email) and org details (company name, contact email, phone, address, postcode)"
    - "Submitting the form sends a magic link, and after authentication, calls the checkout API to create a Stripe Checkout Session"
    - "User is redirected to Stripe Checkout hosted page after successful org creation"
    - "The ?cancelled=true query param shows a cancellation message when user returns from Stripe without paying"
  artifacts:
    - path: "web/app/(auth)/signup/page.tsx"
      provides: "Unified signup page with plan selection and org details"
  key_links:
    - from: "web/app/(auth)/signup/page.tsx"
      to: "web/app/api/billing/checkout/route.ts"
      via: "fetch POST /api/billing/checkout"
      pattern: "fetch.*api/billing/checkout"
    - from: "web/app/(auth)/signup/page.tsx"
      to: "Stripe Checkout"
      via: "window.location.href = session.url"
      pattern: "window\\.location\\.(href|assign)"
---

<objective>
Replace the existing signup page with a unified onboarding flow that includes plan selection, account creation, org details collection, and Stripe Checkout redirect.

Purpose: The current signup page only creates an auth account with magic link. The new page guides a prospective medic business through selecting a plan, entering their details, authenticating via magic link, and being redirected to Stripe Checkout — all in a single cohesive flow.

Output: Updated signup page at `web/app/(auth)/signup/page.tsx`.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@web/app/(auth)/signup/page.tsx
@web/app/setup/organization/page.tsx
@.planning/phases/29-org-onboarding-flow/29-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild signup page with plan selection and checkout flow</name>
  <files>web/app/(auth)/signup/page.tsx</files>
  <action>
Replace the existing `web/app/(auth)/signup/page.tsx` with a multi-step signup flow. Keep it as a single 'use client' component with internal step state.

**Step state machine:** `'plan' | 'details' | 'email-sent' | 'creating-org'`

**Step 1: Plan Selection ('plan')**

Show 3 plan cards side-by-side (responsive: stack on mobile, 3-col on lg):

| Plan | Price | Key Features |
|------|-------|-------------|
| Starter | £149/mo | Dashboard, Treatment Logs, Worker Registry, Weekly Reports, Compliance, Basic Analytics |
| Growth | £299/mo | Everything in Starter + White-Label Branding, Subdomain, Advanced Analytics |
| Enterprise | £599/mo | Everything in Growth + Custom Domain, API Access, Priority Support |

Each card is a button. Clicking sets `selectedTier` state and advances to 'details'.
Growth card should have a "Most Popular" badge.

Use the existing Card, CardContent, CardHeader, CardTitle components from `@/components/ui/card`.
Use the existing Button component from `@/components/ui/button`.
Use CheckCircle2 from lucide-react for feature list check marks.

**Step 2: Account + Org Details ('details')**

Combined form with two sections:

**Your Account:**
- Full Name (required) — maps to `fullName` state
- Email (required) — maps to `email` state

**Your Organisation:**
- Organisation Name (required) — maps to `orgName` state
- Contact Email (required, pre-filled from account email) — maps to `contactEmail` state
- Contact Phone (optional)
- Business Address (optional)
- Postcode (optional)

Use Input from `@/components/ui/input`.

**Submit handler:**
1. Store org details in component state (NOT localStorage — React state is sufficient since the flow continues in the same session)
2. Call `supabase.auth.signInWithOtp({ email, options: { data: { full_name: fullName, pending_tier: selectedTier, pending_org_name: orgName, pending_contact_email: contactEmail, pending_contact_phone: contactPhone, pending_address: address, pending_postcode: postcode }, emailRedirectTo: \`${window.location.origin}/auth/callback?next=/signup?step=creating-org\` } })`
3. Advance to 'email-sent' step

**Step 3: Email Sent ('email-sent')**

Same UI as the current signup's emailSent state — "Check your email" with the green CheckCircle2 icon. Include "Send another link" button that goes back to 'details'.

**Step 4: Creating Org ('creating-org')**

This step is entered when the user returns from the magic link (via `?step=creating-org` query param). On mount:

1. Check if user is authenticated: `const { data: { user } } = await supabase.auth.getUser()`
2. Read pending signup data from `user.user_metadata` (stored via signInWithOtp data option): `pending_tier`, `pending_org_name`, `pending_contact_email`, etc.
3. If user already has `app_metadata.org_id` — they've already completed signup. Redirect to `/onboarding`.
4. POST to `/api/billing/checkout` with `{ tier: pending_tier, orgName: pending_org_name, contactEmail: pending_contact_email, contactPhone: pending_contact_phone, address: pending_address, postcode: pending_postcode }`.
5. On success: redirect to `response.url` (Stripe Checkout hosted page).
6. On error: show error message with "Try Again" button.

Show a spinner with "Setting up your organisation..." text during this step.

**Query param handling:**
- On component mount, check `searchParams` for:
  - `?step=creating-org` — jump to step 4
  - `?cancelled=true` — show a blue info banner: "Payment was cancelled. You can try again below." and show plan selection

**Styling:** Match the existing dark theme from `setup/organization/page.tsx` — dark gradient background (`bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800`), white text, rounded-2xl cards. Use `bg-gray-800/50 border border-gray-700/50` for card containers.

**Back navigation:** Each step (except plan) has a "Back" button to return to the previous step. Show the selected plan name in steps 2+.

Keep all existing imports from the current file that are still needed. Remove unused ones.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. Visit /signup in dev server and verify the plan selection step renders with 3 cards.
  </verify>
  <done>Signup page shows plan selector, collects account + org details, sends magic link with pending data in metadata, and on return calls checkout API to redirect to Stripe Checkout.</done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without TypeScript errors
2. /signup renders plan cards with correct pricing (£149, £299, £599)
3. The form collects both account details and org details
4. Magic link OTP stores pending org data in user_metadata
5. Returning from magic link with ?step=creating-org auto-calls checkout API
6. ?cancelled=true shows cancellation banner
7. No database schema changes
</verification>

<success_criteria>
- Complete signup flow: plan selection -> details form -> magic link -> auth callback -> checkout API -> Stripe redirect
- Visual consistency with existing dark theme (gray-900 gradient)
- Error handling at each step
</success_criteria>

<output>
After completion, create `.planning/phases/29-org-onboarding-flow/29-02-SUMMARY.md`
</output>
