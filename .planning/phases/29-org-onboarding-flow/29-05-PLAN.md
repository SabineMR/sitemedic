---
phase: 29-org-onboarding-flow
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - web/lib/email/templates/welcome-email.tsx
  - web/lib/email/send-welcome.ts
autonomous: true

must_haves:
  truths:
    - "Welcome email template renders with org branding (company name, logo, primary colour) when available"
    - "Welcome email template falls back to SiteMedic defaults when no branding configured"
    - "Welcome email includes login URL with subdomain for Growth/Enterprise orgs"
    - "Welcome email includes the plan name and a getting-started guide section"
    - "sendWelcomeEmail() function fetches org branding from database before sending"
  artifacts:
    - path: "web/lib/email/templates/welcome-email.tsx"
      provides: "React Email welcome email template"
      exports: ["default (WelcomeEmail component)"]
    - path: "web/lib/email/send-welcome.ts"
      provides: "Welcome email sender function"
      exports: ["sendWelcomeEmail"]
  key_links:
    - from: "web/lib/email/send-welcome.ts"
      to: "web/lib/email/resend.ts"
      via: "resend.emails.send()"
      pattern: "resend\\.emails\\.send"
    - from: "web/lib/email/send-welcome.ts"
      to: "web/lib/email/templates/welcome-email.tsx"
      via: "render(WelcomeEmail(...))"
      pattern: "render.*WelcomeEmail"
---

<objective>
Create the welcome email template and sender function that platform admin triggers on org activation.

Purpose: When platform admin activates a new org, the org admin receives a welcome email with their login URL, plan details, and a getting-started guide. This plan creates the email infrastructure independently of the activation route (29-04) that calls it.

Output: A React Email template and a sender function following the existing Resend pattern.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@web/lib/email/resend.ts
@web/lib/email/send-booking-received.ts
@web/lib/email/templates/booking-received-email.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create welcome email template</name>
  <files>web/lib/email/templates/welcome-email.tsx</files>
  <action>
Create `web/lib/email/templates/welcome-email.tsx` following the exact pattern of `booking-received-email.tsx`:

**Interface WelcomeEmailProps:**
```typescript
interface WelcomeEmailProps {
  orgAdmin: {
    name: string;           // e.g. "Jane Smith"
  };
  org: {
    companyName: string;    // e.g. "Apex Safety Solutions"
    planName: string;       // e.g. "Growth"
    loginUrl: string;       // e.g. "https://apex.sitemedic.co.uk/login"
  };
  branding?: {
    primaryColour?: string; // hex colour for accent, fallback to #2563eb (blue-600)
    logoUrl?: string;       // optional org logo URL
  };
}
```

**Template structure:**
1. **Header:** "Welcome to SiteMedic" heading. If `branding.logoUrl` provided, show an `<Img>` (from @react-email/components) with the org logo above the heading.

2. **Greeting:** "Hi {orgAdmin.name},"

3. **Welcome text:** "Your {org.companyName} account on SiteMedic is now active! You're on the **{org.planName}** plan."

4. **Details box** (styled like booking-received-email's detailsBox):
   - **Plan:** {org.planName}
   - **Login URL:** {org.loginUrl}

5. **Getting Started Guide section** with 3 numbered steps:
   - "1. Set up your branding — Upload your logo and choose your brand colour in Settings"
   - "2. Invite your team — Add medics and admins from the Users page"
   - "3. Create your first booking — Start managing site safety from the Dashboard"

6. **CTA Button:** "Log In to Your Dashboard" linking to `org.loginUrl`. Use `branding.primaryColour || '#2563eb'` as button background colour.

7. **Footer:** "Powered by SiteMedic — UK paramedic staffing with built-in compliance"

**Styling:** Copy the inline style objects from `booking-received-email.tsx` (main, container, heading, text, detailsBox, detailLabel, detailValue, button, hr, footer). Adjust the button background to use `branding?.primaryColour || '#2563eb'`.

Import from `@react-email/components`: Body, Button, Container, Head, Heading, Hr, Html, Img, Text, Section.

Export as default function component.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. The template file exists and exports a default React component.
  </verify>
  <done>Welcome email template renders with org branding when available, falls back to SiteMedic defaults, and includes plan name, login URL, and getting-started guide.</done>
</task>

<task type="auto">
  <name>Task 2: Create welcome email sender function</name>
  <files>web/lib/email/send-welcome.ts</files>
  <action>
Create `web/lib/email/send-welcome.ts` following the exact pattern of `send-booking-received.ts`:

**Function signature:**
```typescript
export async function sendWelcomeEmail(params: {
  orgId: string;
  orgAdminEmail: string;
  orgAdminName: string;
  slug?: string;         // subdomain slug for Growth/Enterprise
  planName: string;      // "Starter" | "Growth" | "Enterprise"
}): Promise<void>
```

**Implementation:**
1. Create service-role Supabase client (same pattern as billing webhook — use `createClient` from `@supabase/supabase-js` with `SUPABASE_SERVICE_ROLE_KEY`). Do NOT use `createClient` from `@/lib/supabase/server` — this is a service function called from API routes, not from a request context.

2. Fetch org_branding for the org: `supabase.from('org_branding').select('company_name, primary_colour_hex, logo_path').eq('org_id', orgId).single()`.

3. Build login URL:
   - If `slug` is provided: `https://${slug}.${process.env.NEXT_PUBLIC_ROOT_DOMAIN || 'sitemedic.co.uk'}/login`
   - Otherwise: `${process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:30500'}/login`

4. Build logo URL if logo_path exists: `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/org-logos/${branding.logo_path}`

5. Render the email: `const emailHtml = await render(WelcomeEmail({ orgAdmin: { name }, org: { companyName, planName, loginUrl }, branding: { primaryColour, logoUrl } }))`.

6. Send via Resend: `resend.emails.send({ from: 'SiteMedic <welcome@sitemedic.co.uk>', to: orgAdminEmail, subject: 'Welcome to SiteMedic — Your Account is Active', html: emailHtml })`.

7. Log errors but don't throw (fire-and-forget pattern, same as send-booking-received).

Import `render` from `@react-email/components`, `resend` from `@/lib/email/resend`, and the template.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. The file exports `sendWelcomeEmail`.
  </verify>
  <done>sendWelcomeEmail() fetches org branding, builds login URL with subdomain support, renders welcome email template, and sends via Resend.</done>
</task>

</tasks>

<verification>
1. `pnpm build` in the web directory completes without TypeScript errors
2. Welcome email template renders valid HTML with all sections (greeting, plan info, getting-started guide, CTA button)
3. sendWelcomeEmail() follows the same fire-and-forget pattern as send-booking-received.ts
4. No database schema changes
</verification>

<success_criteria>
- Welcome email template is a React Email component with branding support and SiteMedic fallback
- Sender function fetches branding, constructs login URL with subdomain, renders template, sends via Resend
- Both files build without errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-org-onboarding-flow/29-05-SUMMARY.md`
</output>
