---
phase: 29-org-onboarding-flow
plan: 03
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - web/app/onboarding/page.tsx
  - web/app/onboarding/layout.tsx
  - web/app/onboarding/branding/page.tsx
  - web/lib/supabase/middleware.ts
autonomous: true

must_haves:
  truths:
    - "After Stripe Checkout success, user lands on /onboarding showing payment confirmed + pending activation message"
    - "User can navigate to /onboarding/branding to upload logo, pick colour, and set company name before platform admin activation"
    - "Middleware allows authenticated users with onboarding_completed=false to access /onboarding routes"
    - "Middleware redirects users with onboarding_completed=false AWAY from /admin and /dashboard to /onboarding"
    - "Users with onboarding_completed=true are redirected from /onboarding to /admin"
  artifacts:
    - path: "web/app/onboarding/page.tsx"
      provides: "Post-payment success page with pending activation status"
    - path: "web/app/onboarding/layout.tsx"
      provides: "Minimal onboarding layout wrapper"
    - path: "web/app/onboarding/branding/page.tsx"
      provides: "Branding setup wizard step (logo, colour, company name)"
    - path: "web/lib/supabase/middleware.ts"
      provides: "Updated middleware with onboarding route handling"
  key_links:
    - from: "web/app/onboarding/page.tsx"
      to: "web/app/api/billing/checkout-status/route.ts"
      via: "fetch GET /api/billing/checkout-status for polling"
      pattern: "fetch.*api/billing/checkout-status"
    - from: "web/app/onboarding/branding/page.tsx"
      to: "org_branding table"
      via: "supabase client update"
      pattern: "from\\('org_branding'\\)\\.update"
    - from: "web/lib/supabase/middleware.ts"
      to: "organizations table"
      via: "onboarding_completed check"
      pattern: "onboarding_completed"
---

<objective>
Create the post-payment onboarding wizard (success page + branding setup) and update middleware to route pending-activation orgs to the onboarding flow.

Purpose: After Stripe Checkout, the user needs a clear "payment received, pending activation" message and the ability to pre-configure their branding while waiting for platform admin approval. The middleware must prevent pending orgs from accessing the main dashboard while allowing onboarding pages.

Output: Onboarding route group with success page and branding step, plus middleware updates.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@web/lib/supabase/middleware.ts
@web/app/setup/organization/page.tsx
@.planning/phases/29-org-onboarding-flow/29-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding layout and success page</name>
  <files>web/app/onboarding/layout.tsx, web/app/onboarding/page.tsx</files>
  <action>
**Layout (`web/app/onboarding/layout.tsx`):**

Create a minimal layout wrapper. 'use client' component.

- Full-screen dark gradient background matching signup: `bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800`
- Centered content column with max-w-2xl
- SiteMedic logo/text at top (small, like a nav header)
- Children rendered below
- No sidebar — this is a wizard flow, not a dashboard

```tsx
export default function OnboardingLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800">
      <header className="p-6">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
            <span className="text-white font-bold text-sm">SM</span>
          </div>
          <span className="text-white font-semibold">SiteMedic</span>
        </div>
      </header>
      <main className="max-w-2xl mx-auto px-6 pb-12">
        {children}
      </main>
    </div>
  );
}
```

**Success Page (`web/app/onboarding/page.tsx`):**

'use client' component with the following sections:

1. **Payment Status Section:**
   - On mount, call `GET /api/billing/checkout-status` to check subscription state
   - If `subscriptionStatus === 'active'` and `onboardingCompleted === false`: Show green checkmark + "Payment Confirmed" heading + "Your {planName} subscription is active. Your account is pending activation by our team."
   - If `subscriptionStatus` is null (webhook hasn't fired yet): Show spinner + "Processing your payment..." + poll every 3 seconds (useEffect with setInterval, clear on unmount or when status arrives)
   - If `onboardingCompleted === true`: Redirect to `/admin`

2. **What Happens Next section:**
   - "Our team will review your account and activate it within 24 hours."
   - "Once activated, you'll receive a welcome email with your login details."

3. **While You Wait section:**
   - "Set up your branding" card — Link to `/onboarding/branding`
   - Describes: "Upload your logo, choose your brand colour, and set your company name. Your branding will be ready when your account is activated."
   - Use a card with an icon (Palette from lucide-react) and an arrow icon

4. **Activation SLA note:**
   - Small text at bottom: "Most accounts are activated within a few hours during UK business hours (Mon-Fri 9am-5pm)."

Use Card, CardContent from `@/components/ui/card`. Use CheckCircle2, Clock, Palette, ArrowRight from lucide-react.

**State management:** Use `useState` for subscriptionStatus and loading. Use `useEffect` for initial fetch and polling interval.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. Both files exist.
  </verify>
  <done>Onboarding layout provides minimal wizard chrome. Success page polls for payment confirmation and shows pending activation status with link to branding setup.</done>
</task>

<task type="auto">
  <name>Task 2: Create branding setup wizard page</name>
  <files>web/app/onboarding/branding/page.tsx</files>
  <action>
Create `web/app/onboarding/branding/page.tsx` as a 'use client' component.

**Form fields:**
1. **Company Name** — text input, pre-populated from org_branding.company_name (fetched on mount)
2. **Primary Colour** — hex colour input with a visual colour picker (`<input type="color">`) next to a text input showing the hex value. Default to '#2563eb' if not set. Validate with `/^#[0-9a-fA-F]{6}$/` regex (same XSS defence as BrandingProvider from Phase 27-01).
3. **Tagline** — optional text input for org tagline
4. **Logo Upload** — file input accepting image/png, image/jpeg, image/svg+xml. Max 2MB. On file select, show preview. Upload to Supabase Storage bucket `org-logos` at path `{org_id}/logo.{ext}`.

**Data flow:**
1. On mount: fetch current org_branding via Supabase client: `supabase.from('org_branding').select('*').eq('org_id', orgId).single()`. Get orgId from auth user's `app_metadata.org_id`.
2. On save:
   - If logo file selected, upload to `org-logos/{orgId}/logo.{file.name.split('.').pop()}` via Supabase Storage. Get the file path back.
   - Update `org_branding` row: `supabase.from('org_branding').update({ company_name, primary_colour_hex, tagline, logo_path }).eq('org_id', orgId)`.
3. On success: show toast ("Branding saved!") and show a "Back to Dashboard" link back to `/onboarding`.

**UI layout:**
- Section heading: "Set Up Your Branding"
- Description: "Customise how your portal looks to your team. You can change these settings later from your admin panel."
- Form in a dark card (`bg-gray-800/50 border border-gray-700/50 rounded-2xl p-6`)
- Colour preview: small circle swatch next to the colour picker showing current colour
- Logo preview: if logo exists or file selected, show thumbnail (rounded, max 120px)
- Save button: full-width, blue gradient, disabled while saving

Use `toast` from `sonner` for success/error messages.
Use the Supabase client from `@/lib/supabase/client`.

**Important:** The org_branding row already exists (created by 29-01 checkout route). This page only UPDATEs, never INSERTs.
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. The branding page exists and handles logo upload + colour picker + company name update.
  </verify>
  <done>Branding setup page allows org admin to upload logo, pick primary colour, set company name and tagline while in pending activation state. Data persists to org_branding table.</done>
</task>

<task type="auto">
  <name>Task 3: Update middleware for onboarding routing</name>
  <files>web/lib/supabase/middleware.ts</files>
  <action>
Update `web/lib/supabase/middleware.ts` to handle onboarding routing for pending-activation orgs.

**Changes to make (add after the existing org setup redirect logic, around line 210-219):**

After the existing check for `!orgId && !isSetupRoute` (which redirects to /setup/organization), add a NEW check:

```typescript
// Onboarding routing: orgs with onboarding_completed=false go to /onboarding
if (orgId) {
  const isOnboardingRoute = request.nextUrl.pathname.startsWith('/onboarding');
  const isDashboardRoute = request.nextUrl.pathname.startsWith('/admin') ||
                           request.nextUrl.pathname.startsWith('/dashboard') ||
                           request.nextUrl.pathname.startsWith('/medic');

  // Fetch onboarding status (only for dashboard or onboarding routes to avoid unnecessary DB calls)
  if (isDashboardRoute || isOnboardingRoute) {
    // Use the existing supabase client (user's session) to check their org
    const { data: orgStatus } = await supabase
      .from('organizations')
      .select('onboarding_completed')
      .eq('id', orgId)
      .single();

    const onboardingCompleted = orgStatus?.onboarding_completed ?? true; // Legacy orgs (null) = completed

    if (!onboardingCompleted && !isOnboardingRoute) {
      // Org hasn't completed onboarding — redirect to onboarding wizard
      const url = request.nextUrl.clone();
      url.pathname = '/onboarding';
      return NextResponse.redirect(url);
    }

    if (onboardingCompleted && isOnboardingRoute) {
      // Org already completed onboarding — redirect to admin
      const url = request.nextUrl.clone();
      url.pathname = '/admin';
      return NextResponse.redirect(url);
    }
  }
}
```

**Also add `/onboarding` to the publicRoutes array** — wait, no. Onboarding requires auth. Instead, ensure `isSetupRoute` check also covers onboarding. Add:

```typescript
const isSetupRoute = request.nextUrl.pathname.startsWith('/setup/') ||
                     request.nextUrl.pathname.startsWith('/onboarding');
```

This ensures users WITH org_id can access /onboarding (the existing `!orgId && !isSetupRoute` check won't redirect them to /setup/organization).

**CRITICAL:** Legacy orgs (created before this feature) have `onboarding_completed = true` (set in migration 027 backfill) OR `onboarding_completed = null`. Treat null as true (completed) to avoid breaking existing users. Use `?? true` fallback.

**Performance note:** This adds one DB query per dashboard/onboarding request. Since middleware already makes a DB call for subdomain resolution (org+branding lookup), this is acceptable. The query is lightweight (single row by primary key).
  </action>
  <verify>
Run `pnpm build` — no TypeScript errors. Verify the middleware file still exports `updateSession` and the new onboarding logic is present.
  </verify>
  <done>Middleware redirects pending-activation orgs to /onboarding and redirects completed orgs away from /onboarding to /admin. Legacy orgs (null onboarding_completed) are treated as completed.</done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without TypeScript errors
2. /onboarding renders success page with payment status polling
3. /onboarding/branding renders branding form with logo upload, colour picker, company name
4. Middleware redirects onboarding_completed=false orgs to /onboarding
5. Middleware redirects onboarding_completed=true orgs from /onboarding to /admin
6. Legacy orgs (null) are not affected
7. No database schema changes
</verification>

<success_criteria>
- Post-payment onboarding flow: success page -> optional branding setup -> wait for activation
- Middleware prevents access to dashboard until activation
- Branding data persists to org_branding table
- Legacy orgs unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/29-org-onboarding-flow/29-03-SUMMARY.md`
</output>
