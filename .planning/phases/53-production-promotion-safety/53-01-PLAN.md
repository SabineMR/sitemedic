# 53-01 Plan — Migration Preflight and Promotion Safety Baseline

## Objective

Establish a safe, repeatable production promotion workflow for integrity-related schema and app changes, with preflight checks and post-deploy smoke verification.

## Requirements Coverage IDs

- `OPS-01` — Production migration apply workflow includes deterministic preflight checks.
- `OPS-02` — Promotion is blocked on schema/app compatibility failures.
- `OPS-03` — Post-deploy smoke confirms integrity-critical behavior is healthy.

## Must-Have Truths

1. Operators can run one documented workflow and understand pass/fail at each stage.
2. Migrations are checked for naming/order/apply safety before promotion starts.
3. Promotion flow fails closed when compatibility checks fail.
4. Smoke verification confirms core integrity endpoints and workflows respond as expected.

## Task Breakdown

- [ ] **Task 1: Build migration preflight script and checks**
  - Add script to validate migration ordering, naming, and pending state before apply.
  - Detect non-standard migration names and surface actionable output.
  - Target files: `scripts/ops/migration-preflight.ts` (or existing scripts dir), docs references.

- [ ] **Task 2: Add promotion guard checks**
  - Add promotion command/script that chains:
    - preflight,
    - app typecheck/lint gates,
    - deployment readiness flags.
  - Target files: `scripts/ops/promote-integrity-release.ts`, package scripts.

- [ ] **Task 3: Add integrity smoke verifier and runbook**
  - Add post-promotion smoke script for key APIs:
    - integrity overview,
    - event integrity score read,
    - case queue list endpoint.
  - Write operator runbook with expected outputs and recovery steps.
  - Target files: `scripts/ops/integrity-smoke.ts`, `.planning/phases/53-production-promotion-safety/53-01-RUNBOOK.md`.

## Verification Strategy

- Script checks:
  - run migration preflight in dry mode and confirm no false positives.
  - run promotion guard script locally with expected pass/fail behavior.
- App health checks:
  - `pnpm --dir web exec tsc --noEmit`
  - `pnpm --dir web lint`
  - `pnpm --dir web-marketplace exec tsc --noEmit`
  - `pnpm --dir web-marketplace lint`
- Smoke checks:
  - run integrity smoke script and validate success summary.

## Risks + Mitigations

- **Risk:** False assurance from partial smoke coverage.
  - **Mitigation:** include all critical integrity surfaces (scores, cases, holds, overview).
- **Risk:** Operators bypass scripts and run manual commands.
  - **Mitigation:** runbook and CI references point to one canonical promotion command.
- **Risk:** Migration naming inconsistencies (e.g., legacy suffix files) break automation.
  - **Mitigation:** preflight tolerates known legacy exceptions but blocks new violations.

## Suggested Commit Slices

1. `feat(53-01): add migration preflight checks`
2. `feat(53-01): add promotion guard workflow`
3. `docs(53-01): add integrity smoke verifier and runbook`
