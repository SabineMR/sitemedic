---
phase: 34-quote-submission-comparison
plan: 03
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - web/app/api/marketplace/quotes/[id]/update/route.ts
  - web/app/api/marketplace/quotes/[id]/withdraw/route.ts
  - web/app/api/marketplace/quotes/my-quotes/route.ts
  - web/app/api/marketplace/events/[id]/extend-deadline/route.ts
  - web/app/marketplace/my-quotes/page.tsx
  - web/components/marketplace/quote-management/MyQuoteCard.tsx
  - web/components/marketplace/quote-management/EditQuoteDialog.tsx
autonomous: true

must_haves:
  truths:
    - "A company can edit a submitted quote in place and the client sees a 'revised' badge"
    - "A company can withdraw a submitted quote at any time before the event is awarded"
    - "Quote deadline prevents new quotes after expiry, but client can extend deadline once"
    - "Company can see all their submitted quotes across events in a management view"
  artifacts:
    - path: "web/app/api/marketplace/quotes/[id]/update/route.ts"
      provides: "PATCH endpoint for editing quotes in place"
      exports: ["PATCH"]
    - path: "web/app/api/marketplace/quotes/[id]/withdraw/route.ts"
      provides: "POST endpoint for withdrawing a quote"
      exports: ["POST"]
    - path: "web/app/api/marketplace/quotes/my-quotes/route.ts"
      provides: "GET endpoint for company's own quotes"
      exports: ["GET"]
    - path: "web/app/api/marketplace/events/[id]/extend-deadline/route.ts"
      provides: "POST endpoint for extending quote deadline"
      exports: ["POST"]
    - path: "web/app/marketplace/my-quotes/page.tsx"
      provides: "Company quote management page"
      min_lines: 40
    - path: "web/components/marketplace/quote-management/MyQuoteCard.tsx"
      provides: "Quote card with edit/withdraw actions"
      min_lines: 30
  key_links:
    - from: "web/app/api/marketplace/quotes/[id]/update/route.ts"
      to: "supabase.from('marketplace_quotes')"
      via: "Supabase update with status='revised'"
      pattern: "status.*revised"
    - from: "web/app/api/marketplace/quotes/[id]/withdraw/route.ts"
      to: "supabase.from('marketplace_quotes')"
      via: "Supabase update with status='withdrawn'"
      pattern: "status.*withdrawn"
    - from: "web/app/api/marketplace/events/[id]/extend-deadline/route.ts"
      to: "supabase.from('marketplace_events')"
      via: "Supabase update quote_deadline"
      pattern: "quote_deadline"
    - from: "web/app/marketplace/my-quotes/page.tsx"
      to: "/api/marketplace/quotes/my-quotes"
      via: "fetch or React Query hook"
      pattern: "my-quotes"
---

<objective>
Build the quote management functionality: companies can edit submitted quotes in place (triggering a "revised" badge), withdraw quotes before award, and view all their quotes in a management dashboard. Clients can extend the quote deadline once if they want more quotes.

Purpose: Without edit/withdraw/deadline management, the quote lifecycle is incomplete. Companies need to adjust quotes based on new information, withdraw if unavailable, and clients need deadline flexibility.
Output: Quote update/withdraw API routes, deadline extension API, company quote management page with edit dialog and withdraw action.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-quote-submission-comparison/34-CONTEXT.md
@.planning/phases/34-quote-submission-comparison/34-RESEARCH.md
@.planning/phases/34-quote-submission-comparison/34-01-SUMMARY.md

Key existing files:
@web/lib/marketplace/quote-types.ts (created in 34-01)
@web/lib/marketplace/quote-schemas.ts (created in 34-01)
@web/stores/useQuoteFormStore.ts (created in 34-01)
@web/lib/queries/marketplace/quotes.ts (created in 34-01)
@web/app/api/marketplace/quotes/[id]/route.ts (created in 34-01 — GET single quote)
@web/app/api/marketplace/events/[id]/route.ts (existing — has PUT for event update)
@web/lib/marketplace/minimum-rates.ts (created in 34-01)
@web/app/marketplace/events/[id]/page.tsx (event detail page)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Quote update, withdraw, and deadline extension API routes</name>
  <files>
    web/app/api/marketplace/quotes/[id]/update/route.ts
    web/app/api/marketplace/quotes/[id]/withdraw/route.ts
    web/app/api/marketplace/quotes/my-quotes/route.ts
    web/app/api/marketplace/events/[id]/extend-deadline/route.ts
  </files>
  <action>
    **Quote update route (quotes/[id]/update/route.ts) — PATCH:**
    - Authenticate user
    - Fetch the quote by ID, verify current user is admin_user_id of the quote's company
    - Verify quote status is 'submitted' or 'revised' (cannot edit drafts via this endpoint — use save-draft; cannot edit withdrawn quotes)
    - Verify the event status is NOT 'awarded' or 'cancelled' (cannot edit after award)
    - Parse body with quoteSubmissionSchema.safeParse() (full validation — edit must produce a valid quote)
    - Run validateAgainstMinimumRates() — if violations, return 400 (same enforcement as submit)
    - Update the quote row: set all pricing/staffing/cover_letter fields, set status='revised', set last_revised_at=NOW()
    - Return { success: true, quoteId }

    **Quote withdraw route (quotes/[id]/withdraw/route.ts) — POST:**
    - Authenticate user
    - Fetch the quote by ID, verify current user is admin_user_id of the quote's company
    - Verify quote status is 'submitted' or 'revised' (cannot withdraw a draft — just delete it; cannot withdraw already withdrawn)
    - Verify event status is NOT 'awarded' (cannot withdraw after award per CONTEXT)
    - Update quote: set status='withdrawn', set withdrawn_at=NOW()
    - The quote_count trigger from migration 146 will auto-decrement the event's quote_count
    - Return { success: true }

    **My quotes route (quotes/my-quotes/route.ts) — GET:**
    - Authenticate user
    - Find the user's marketplace_companies row (WHERE admin_user_id = user.id)
    - If no company found, return empty array
    - Query marketplace_quotes WHERE company_id = company.id
    - JOIN marketplace_events to get event_name, event_type, event_status, quote_deadline
    - Support query params: status filter (all/draft/submitted/revised/withdrawn), page, limit
    - Order by created_at DESC
    - Return { quotes[], total, page, limit }

    **Extend deadline route (events/[id]/extend-deadline/route.ts) — POST:**
    - Authenticate user
    - Fetch the event, verify current user is posted_by (only event poster can extend)
    - Verify event status is 'open'
    - Check if deadline has already been extended: add a column check. Two approaches:
      Option A (simpler): Add a `deadline_extended` boolean column to marketplace_events in migration 146. BUT migration 146 is for quotes. Instead, just check if quote_deadline has been updated more than once by storing the original_deadline. SIMPLEST: add body param `new_deadline` and track extension via a `deadline_extensions_count` field. For Phase 34, just add a `deadline_extended` boolean to the events table in a small inline migration at the top of 146 (ALTER TABLE), or handle it purely in API logic.
      RECOMMENDED: Keep it simple. Add a `deadline_extended BOOLEAN DEFAULT FALSE` column to marketplace_events via ALTER TABLE in migration 146. API checks: if deadline_extended is true, return 400 "Deadline can only be extended once". If false, update quote_deadline and set deadline_extended = true.
    - Body: { new_deadline: string (ISO date) } — must be in the future, must be after current deadline
    - Update marketplace_events: set quote_deadline = new_deadline, deadline_extended = true
    - Return { success: true }

    NOTE: Migration 146 should include the ALTER TABLE for deadline_extended. Add to Task 1 of Plan 34-01 or handle here. Since 34-01 creates migration 146, add this ALTER TABLE to that migration file. The executor for 34-01 will include it. If 34-01 is already complete when this plan runs, create a small adjustment: add `ALTER TABLE marketplace_events ADD COLUMN IF NOT EXISTS deadline_extended BOOLEAN DEFAULT FALSE;` at the top of the update route file as a comment noting it needs to be in migration 146, OR create a tiny migration 146b. SIMPLEST: just include the ALTER TABLE in migration 146 (update 34-01 action to include it). Since this plan depends on 34-01 and runs after, check if the column exists. If not, add it via a small migration or inline SQL.

    PRAGMATIC APPROACH: Add the column via the event extend-deadline route itself using a raw SQL statement as a safety net, but primarily document that migration 146 should include `ALTER TABLE marketplace_events ADD COLUMN IF NOT EXISTS deadline_extended BOOLEAN DEFAULT FALSE;`. The executor should add this to migration 146 before the quotes table creation.
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - quotes/[id]/update/route.ts exports PATCH with validation, status='revised', last_revised_at set
    - quotes/[id]/withdraw/route.ts exports POST with status='withdrawn', withdrawn_at set
    - quotes/my-quotes/route.ts exports GET returning quotes with event details
    - events/[id]/extend-deadline/route.ts exports POST with one-time extension enforcement
    - All routes check auth and ownership
  </verify>
  <done>
    Companies can edit submitted quotes (PATCH sets status to 'revised' with timestamp), withdraw quotes (POST sets status to 'withdrawn'), and view all their quotes via my-quotes endpoint. Clients can extend the quote deadline once via extend-deadline endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Company quote management page with edit dialog and withdraw action</name>
  <files>
    web/app/marketplace/my-quotes/page.tsx
    web/components/marketplace/quote-management/MyQuoteCard.tsx
    web/components/marketplace/quote-management/EditQuoteDialog.tsx
  </files>
  <action>
    **My Quotes page (my-quotes/page.tsx):**
    - Route: /marketplace/my-quotes
    - Client component (use React Query to fetch from /api/marketplace/quotes/my-quotes)
    - Header: "My Quotes" with total count
    - Status filter tabs: All, Drafts, Submitted, Revised, Withdrawn
    - List of MyQuoteCard components
    - Loading state: skeleton cards
    - Empty state: "You haven't submitted any quotes yet." with link to Browse Events
    - Breadcrumb: Marketplace / My Quotes

    **MyQuoteCard.tsx:**
    - Card displaying one quote with:
      - Event name (linked to event detail page) and event type badge
      - Quote status badge: Draft (gray), Submitted (green), Revised (amber with "Revised" text + time since revision), Withdrawn (red)
      - Total price (bold, GBP formatted)
      - Staffing plan summary (e.g. "2x Paramedic, 1x EMT" or "3 named medics")
      - Submitted date and time
      - Quote deadline countdown for the event
    - Action buttons (conditional on status):
      - Draft: "Continue Editing" (links to /marketplace/events/[eventId]/quote with draft loaded) + "Delete Draft" (API call to delete)
      - Submitted/Revised: "Edit Quote" (opens EditQuoteDialog) + "Withdraw" (confirmation dialog, then calls withdraw API)
      - Withdrawn: no actions, just status display
    - "Revised" badge shows "Revised {timeAgo}" using last_revised_at timestamp (e.g. "Revised 2h ago")

    **EditQuoteDialog.tsx:**
    - Dialog/modal for editing a submitted quote in place
    - Loads the existing quote data into form fields (same layout as QuoteSubmissionForm but in a dialog)
    - Sections: Pricing breakdown (4 categories + custom lines), Staffing plan (toggle mode + entries), Cover letter
    - On save: calls PATCH /api/marketplace/quotes/[id]/update with full payload
    - Validates with quoteSubmissionSchema and validateAgainstMinimumRates before submitting
    - On success: close dialog, invalidate React Query cache (['marketplace-quotes']), show toast "Quote updated"
    - On minimum rate violation: show error message listing violations, prevent save

    NOTE: The EditQuoteDialog reuses the same form structure as QuoteSubmissionForm but does NOT use the Zustand store (to avoid state conflicts with the create flow). Instead, use local useState for the dialog's form state, initialized from the existing quote data.

    **Withdraw confirmation:**
    - When user clicks "Withdraw" on a MyQuoteCard, show a confirmation dialog:
      "Are you sure you want to withdraw your quote for [event name]? This cannot be undone."
    - On confirm: call POST /api/marketplace/quotes/[id]/withdraw
    - On success: invalidate cache, show toast "Quote withdrawn"
    - Update the card to show "Withdrawn" status

    **Deadline extension (integrated into event detail page):**
    - Add a small "Extend Deadline" button on the event detail page (/marketplace/events/[id]/page.tsx) visible only to the event poster
    - Only show if event.status === 'open' AND event.deadline_extended !== true AND deadline is approaching (or has passed)
    - On click: open a date picker dialog to select new deadline (must be after current deadline)
    - Calls POST /api/marketplace/events/[id]/extend-deadline
    - On success: refresh event data, show toast "Deadline extended"
    - Button hidden after one extension (deadline_extended = true)
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - my-quotes/page.tsx route renders with status filter tabs and quote cards
    - MyQuoteCard shows status badges, prices, staffing summary, and correct action buttons per status
    - EditQuoteDialog opens with existing data, validates, and saves via PATCH
    - Withdraw flow shows confirmation and calls the withdraw API
    - Event detail page has "Extend Deadline" button for poster (hidden after use)
    - `pnpm build` completes without errors
  </verify>
  <done>
    Companies can manage all their quotes from /marketplace/my-quotes: view status, edit submitted quotes in place (triggering "revised" badge with timestamp), withdraw quotes with confirmation, and continue editing drafts. Clients can extend the quote deadline once from the event detail page. Quote list refreshes after each action.
  </done>
</task>

</tasks>

<verification>
- Edit: PATCH updates quote with status='revised' and last_revised_at timestamp
- Withdraw: POST sets status='withdrawn', event quote_count decrements automatically
- My Quotes: company sees all their quotes with status filtering
- Revised badge: shows "Revised {timeAgo}" using last_revised_at
- Deadline: client can extend once, button disappears after extension
- Guards: cannot edit/withdraw after event is awarded, minimum rates enforced on edit
- Build: `pnpm tsc --noEmit` and `pnpm build` pass
</verification>

<success_criteria>
1. Company can edit a submitted quote — status changes to 'revised' with timestamp
2. Client sees "Revised" badge with time delta on edited quotes
3. Company can withdraw a quote — status changes to 'withdrawn', event quote_count decrements
4. Company can view all their quotes at /marketplace/my-quotes with status filtering
5. Client can extend quote deadline once from event detail page
6. All edit/withdraw actions blocked after event is awarded
7. Minimum rate enforcement applies to edits (same as initial submission)
</success_criteria>

<output>
After completion, create `.planning/phases/34-quote-submission-comparison/34-03-SUMMARY.md`
</output>
