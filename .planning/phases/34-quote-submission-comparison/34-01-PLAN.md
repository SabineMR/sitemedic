---
phase: 34-quote-submission-comparison
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/146_marketplace_quotes.sql
  - web/lib/marketplace/quote-types.ts
  - web/lib/marketplace/quote-schemas.ts
  - web/lib/marketplace/minimum-rates.ts
  - web/stores/useQuoteFormStore.ts
  - web/app/api/marketplace/quotes/submit/route.ts
  - web/app/api/marketplace/quotes/save-draft/route.ts
  - web/app/api/marketplace/quotes/list/route.ts
  - web/app/api/marketplace/quotes/[id]/route.ts
  - web/components/marketplace/quote-submission/QuoteSubmissionForm.tsx
  - web/components/marketplace/quote-submission/PricingBreakdownSection.tsx
  - web/components/marketplace/quote-submission/StaffingPlanSection.tsx
  - web/components/marketplace/quote-submission/CoverLetterSection.tsx
  - web/app/marketplace/events/[id]/quote/page.tsx
  - web/app/marketplace/events/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "A verified company can submit a quote with total price, itemised breakdown, cover letter, staffing plan, and availability confirmation"
    - "A company can save a partial quote as draft and return later to complete it"
    - "Minimum rate guideline ranges are displayed per qualification level and quotes below minimum are blocked from submission"
    - "Quote data is persisted in the database with correct RLS (company manages own, event poster views, admin sees all)"
  artifacts:
    - path: "supabase/migrations/146_marketplace_quotes.sql"
      provides: "marketplace_quotes table with RLS, indexes, status enum"
      contains: "CREATE TABLE marketplace_quotes"
    - path: "web/lib/marketplace/quote-types.ts"
      provides: "Quote TypeScript interfaces and enums"
      exports: ["MarketplaceQuote", "QuoteStatus", "QuoteLineItem", "StaffingPlanItem"]
    - path: "web/lib/marketplace/quote-schemas.ts"
      provides: "Zod validation for quote submission"
      exports: ["quoteSubmissionSchema", "pricingSchema", "staffingPlanSchema"]
    - path: "web/lib/marketplace/minimum-rates.ts"
      provides: "Guideline rate enforcement per qualification"
      exports: ["MINIMUM_RATES_PER_HOUR", "validateAgainstMinimumRates"]
    - path: "web/stores/useQuoteFormStore.ts"
      provides: "Zustand form state for quote creation"
      exports: ["useQuoteFormStore"]
    - path: "web/app/api/marketplace/quotes/submit/route.ts"
      provides: "POST endpoint for quote submission"
      exports: ["POST"]
    - path: "web/app/api/marketplace/quotes/save-draft/route.ts"
      provides: "POST endpoint for draft saving"
      exports: ["POST"]
    - path: "web/app/api/marketplace/quotes/list/route.ts"
      provides: "GET endpoint for listing quotes by event"
      exports: ["GET"]
    - path: "web/app/api/marketplace/quotes/[id]/route.ts"
      provides: "GET single quote detail"
      exports: ["GET"]
    - path: "web/app/marketplace/events/[id]/quote/page.tsx"
      provides: "Quote submission page for companies"
      min_lines: 30
  key_links:
    - from: "web/stores/useQuoteFormStore.ts"
      to: "/api/marketplace/quotes/submit"
      via: "fetch in submitQuote action"
      pattern: "fetch.*api/marketplace/quotes/submit"
    - from: "web/components/marketplace/quote-submission/QuoteSubmissionForm.tsx"
      to: "web/stores/useQuoteFormStore.ts"
      via: "Zustand hook"
      pattern: "useQuoteFormStore"
    - from: "web/app/api/marketplace/quotes/submit/route.ts"
      to: "supabase.from('marketplace_quotes')"
      via: "Supabase insert"
      pattern: "from\\('marketplace_quotes'\\)"
    - from: "web/lib/marketplace/minimum-rates.ts"
      to: "web/components/marketplace/quote-submission/PricingBreakdownSection.tsx"
      via: "import for rate display and validation"
      pattern: "validateAgainstMinimumRates"
---

<objective>
Create the database schema, TypeScript types, Zod validation, Zustand store, API routes, and quote submission form for marketplace companies to submit detailed, itemised quotes on open events.

Purpose: This is the foundation plan for Phase 34. Without the quotes table, types, and submission form, no other quote functionality (comparison, management) can exist.
Output: Migration 146, quote types/schemas/rates, Zustand store, 4 API routes, and a multi-section quote submission form accessible from the event detail page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-quote-submission-comparison/34-CONTEXT.md
@.planning/phases/34-quote-submission-comparison/34-RESEARCH.md

Key existing files:
@web/lib/marketplace/event-types.ts (event types — quote types follow same pattern)
@web/lib/marketplace/event-schemas.ts (Zod pattern for marketplace forms)
@web/stores/useEventPostingStore.ts (Zustand store pattern for marketplace wizards)
@web/app/api/marketplace/events/route.ts (API route pattern — auth, Zod validation, Supabase insert)
@web/lib/marketplace/types.ts (MarketplaceCompany interface — needed for company verification check)
@web/app/marketplace/events/[id]/page.tsx (event detail page — has disabled "Submit a Quote" button to wire up)
@web/lib/queries/marketplace/events.ts (React Query hook pattern)
@supabase/migrations/145_marketplace_events.sql (latest migration — next is 146)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration, TypeScript types, Zod schemas, and minimum rate enforcement</name>
  <files>
    supabase/migrations/146_marketplace_quotes.sql
    web/lib/marketplace/quote-types.ts
    web/lib/marketplace/quote-schemas.ts
    web/lib/marketplace/minimum-rates.ts
  </files>
  <action>
    **Migration 146 (146_marketplace_quotes.sql):**
    Create the `marketplace_quotes` table following the schema from RESEARCH.md:
    - `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - `event_id` UUID NOT NULL REFERENCES marketplace_events(id) ON DELETE CASCADE
    - `company_id` UUID NOT NULL REFERENCES marketplace_companies(id) ON DELETE CASCADE
    - `total_price` DECIMAL(10,2) NOT NULL
    - `pricing_breakdown` JSONB NOT NULL (structure: { staff_cost, equipment_cost, transport_cost, consumables_cost, custom_line_items[] })
    - `staffing_plan` JSONB NOT NULL (structure: { type: 'named_medics'|'headcount_and_quals', named_medics[], headcount_plans[] })
    - `cover_letter` TEXT (nullable)
    - `availability_confirmed` BOOLEAN NOT NULL DEFAULT FALSE
    - `status` TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'revised', 'withdrawn'))
    - `submitted_at` TIMESTAMPTZ (nullable — set on first submission, not on draft creation)
    - `last_revised_at` TIMESTAMPTZ (nullable)
    - `withdrawn_at` TIMESTAMPTZ (nullable)
    - `created_at` TIMESTAMPTZ DEFAULT NOW()
    - `updated_at` TIMESTAMPTZ DEFAULT NOW()

    RLS policies (3 policies, matching events pattern):
    1. `company_manage_own_quotes` FOR ALL — USING (company_id IN (SELECT id FROM marketplace_companies WHERE admin_user_id = auth.uid()))
    2. `event_poster_view_quotes` FOR SELECT — USING (EXISTS (SELECT 1 FROM marketplace_events WHERE id = marketplace_quotes.event_id AND posted_by = auth.uid()) AND status != 'draft')
    3. `platform_admin_all_quotes` FOR ALL — USING (is_platform_admin())

    IMPORTANT: Event poster can only see non-draft quotes (status != 'draft'). Drafts are private to the company.

    Indexes: event_id, company_id, status, submitted_at DESC.

    Add trigger: `updated_at` auto-update trigger (same pattern as marketplace_events).

    Also add a trigger or function to increment `marketplace_events.quote_count` when a quote status changes to 'submitted' (and decrement on 'withdrawn'). Use a trigger function:
    ```sql
    CREATE OR REPLACE FUNCTION update_event_quote_count()
    RETURNS TRIGGER AS $$
    BEGIN
      IF TG_OP = 'INSERT' OR (TG_OP = 'UPDATE' AND OLD.status != NEW.status) THEN
        UPDATE marketplace_events SET
          quote_count = (SELECT COUNT(*) FROM marketplace_quotes WHERE event_id = NEW.event_id AND status IN ('submitted', 'revised')),
          has_quotes = EXISTS(SELECT 1 FROM marketplace_quotes WHERE event_id = NEW.event_id AND status IN ('submitted', 'revised'))
        WHERE id = NEW.event_id;
      END IF;
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql SECURITY DEFINER;
    ```

    **TypeScript types (quote-types.ts):**
    Create interfaces mirroring the SQL schema (same pattern as event-types.ts):
    - `QuoteStatus` type union: 'draft' | 'submitted' | 'revised' | 'withdrawn'
    - `StaffingPlanType` type union: 'named_medics' | 'headcount_and_quals'
    - `QuoteLineItem` interface: { id: string, label: string, quantity: number, unitPrice: number, notes?: string }
    - `PricingBreakdown` interface: { staff_cost: number, equipment_cost: number, transport_cost: number, consumables_cost: number, custom_line_items: QuoteLineItem[] }
    - `StaffingPlanItem` interface: { medic_id: string, name: string, qualification: StaffingRole, notes?: string }
    - `HeadcountPlan` interface: { role: StaffingRole, quantity: number }
    - `StaffingPlan` interface: { type: StaffingPlanType, named_medics?: StaffingPlanItem[], headcount_plans?: HeadcountPlan[] }
    - `MarketplaceQuote` interface: all database columns
    - `MarketplaceQuoteWithCompany` interface: extends MarketplaceQuote with company_name, company_rating, company_review_count, company_verification_status
    - `QUOTE_STATUS_LABELS` record map

    Import `StaffingRole` from event-types.ts for reuse.

    **Zod schemas (quote-schemas.ts):**
    Follow the exact schemas from RESEARCH.md Pattern 5:
    - `customLineItemSchema`, `pricingSchema` (with refine for total > 0), `namedMedicSchema`, `headcountPlanSchema`, `staffingPlanSchema` (discriminated union), `quoteSubmissionSchema`
    - Export `QuoteSubmission` inferred type

    **Minimum rates (minimum-rates.ts):**
    Follow RESEARCH.md Pattern 6:
    - `MINIMUM_RATES_PER_HOUR` record: paramedic=45, emt=28, first_aider=18, nurse=40, doctor=75, other=15
    - `getMinimumRateForRole(role)` function
    - `validateAgainstMinimumRates(totalPrice, staffingPlan, eventDurationHours)` function
    - Returns `{ isValid, violations[] }` — violations include role, minimumRate, quotedRate
    - IMPORTANT: The CONTEXT says "block quotes below minimum" — so this returns isValid=false which the form uses to prevent submission. The API route should ALSO validate and reject (return 400) if below minimum. This is hard enforcement per CONTEXT, not soft logging per RESEARCH.md recommendation.
  </action>
  <verify>
    - File `supabase/migrations/146_marketplace_quotes.sql` exists with CREATE TABLE, 3 RLS policies, 4 indexes, updated_at trigger, quote_count trigger
    - File `web/lib/marketplace/quote-types.ts` exports MarketplaceQuote, QuoteLineItem, StaffingPlanItem, QUOTE_STATUS_LABELS
    - File `web/lib/marketplace/quote-schemas.ts` exports quoteSubmissionSchema with .safeParse() working
    - File `web/lib/marketplace/minimum-rates.ts` exports MINIMUM_RATES_PER_HOUR, validateAgainstMinimumRates
    - `pnpm tsc --noEmit` passes (or at minimum the new files have no TypeScript errors)
  </verify>
  <done>
    Migration 146 creates marketplace_quotes with RLS, indexes, and triggers. TypeScript types mirror SQL schema. Zod schemas validate quote submission data. Minimum rate enforcement function exists and returns violations for below-guideline quotes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Zustand store, API routes, and quote submission form with draft saving</name>
  <files>
    web/stores/useQuoteFormStore.ts
    web/app/api/marketplace/quotes/submit/route.ts
    web/app/api/marketplace/quotes/save-draft/route.ts
    web/app/api/marketplace/quotes/list/route.ts
    web/app/api/marketplace/quotes/[id]/route.ts
    web/lib/queries/marketplace/quotes.ts
    web/components/marketplace/quote-submission/QuoteSubmissionForm.tsx
    web/components/marketplace/quote-submission/PricingBreakdownSection.tsx
    web/components/marketplace/quote-submission/StaffingPlanSection.tsx
    web/components/marketplace/quote-submission/CoverLetterSection.tsx
    web/app/marketplace/events/[id]/quote/page.tsx
    web/app/marketplace/events/[id]/page.tsx
  </files>
  <action>
    **Zustand store (useQuoteFormStore.ts):**
    Follow the pattern from RESEARCH.md Pattern 1 and match the existing useEventPostingStore pattern. Key state:
    - eventId, status, draftId
    - staffCost, equipmentCost, transportCost, consumablesCost, customLineItems[]
    - staffingPlanType ('named_medics' | 'headcount_and_quals'), namedMedics[], headcountPlans[]
    - coverLetter, availabilityConfirmed
    - isSubmitting, error
    - Actions: setEventId, updatePricing, addCustomLineItem, removeCustomLineItem, updateCustomLineItem, setStaffingPlanType, addNamedMedic, removeNamedMedic, addHeadcountPlan, removeHeadcountPlan, setCoverLetter, setAvailabilityConfirmed, submitQuote (calls POST /api/marketplace/quotes/submit), saveDraft (calls POST or PATCH save-draft), loadDraft, reset, setError
    - `submitQuote` should call POST /api/marketplace/quotes/submit with full payload, set status to 'submitted'
    - `saveDraft` should call POST /api/marketplace/quotes/save-draft (or PATCH if draftId exists), set draftId

    **API Routes:**

    1. `quotes/submit/route.ts` (POST):
       - Authenticate user with supabase.auth.getUser()
       - Verify user is admin_user_id of a verified marketplace_companies row (can_submit_quotes = true)
       - Parse body with quoteSubmissionSchema.safeParse()
       - Run validateAgainstMinimumRates() — if violations, return 400 with violations array. CONTEXT says "block" so this is a hard reject.
       - Calculate total_price from pricing_breakdown (sum of categories + custom line items)
       - Insert into marketplace_quotes with status='submitted', submitted_at=NOW()
       - Return { success: true, quoteId }

    2. `quotes/save-draft/route.ts` (POST):
       - Same auth + company verification
       - Looser validation (allow partial data — no quoteSubmissionSchema, just basic event_id check)
       - Insert with status='draft', no submitted_at
       - If body includes `draft_id`, PATCH the existing draft instead of inserting
       - Return { success: true, draftId }

    3. `quotes/list/route.ts` (GET):
       - Authenticate user
       - Required query param: `eventId`
       - Query marketplace_quotes WHERE event_id = eventId AND status IN ('submitted', 'revised')
       - JOIN marketplace_companies to get company_name, company_rating (placeholder 0 for now — Phase 36 adds ratings), company_review_count (0)
       - Support query params: sortBy (best_value, price_low, price_high, rating, recent), filterQualification, filterPriceMin, filterPriceMax, filterMinRating, page, limit
       - For best_value sort, return all quotes and let client sort (or sort server-side by total_price ASC as fallback)
       - Return { quotes[], total, page, limit }

    4. `quotes/[id]/route.ts` (GET):
       - Authenticate user
       - Fetch single quote with company details
       - RLS ensures only company owner, event poster, or admin can see it
       - Return full quote object

    **React Query hooks (queries/marketplace/quotes.ts):**
    Follow the pattern from events.ts:
    - `useQuoteList(filters: QuoteListFilterParams)` — queryKey ['marketplace-quotes', filters]
    - `useQuoteDetail(quoteId)` — queryKey ['marketplace-quote', quoteId]
    - `useMyQuotes(companyId)` — for company to see their submitted quotes

    **Form components:**

    1. `QuoteSubmissionForm.tsx` — Top-level client component:
       - Load event details (useMarketplaceEvent) to show event summary at top
       - Initialize store with eventId
       - Auto-save draft with 2-second debounce using useEffect + setTimeout (NOT setInterval — debounce on state change)
       - Sections: PricingBreakdownSection, StaffingPlanSection, CoverLetterSection
       - Availability confirmation checkbox
       - Validate with Zod on submit, check minimum rates, show rate warning if violations
       - Submit button (disabled if isSubmitting or !availabilityConfirmed)
       - Save as Draft button
       - Show "Draft saved" indicator when auto-save fires
       - On successful submit, redirect to event detail page or success view

    2. `PricingBreakdownSection.tsx`:
       - 4 fixed number inputs: Staff Cost, Equipment Cost, Transport Cost, Consumables Cost (GBP, 2 decimal places)
       - Dynamic custom line items list with add/remove: label (text), quantity (number), unit price (number), notes (optional text)
       - Running total displayed at bottom (sum of all categories + custom items)
       - Display guideline rates per qualification level from minimum-rates.ts — show as info box above the pricing fields
       - If staffing plan has roles defined, show per-role minimum rates inline
       - Highlight in red if total falls below minimum for the staffing configuration

    3. `StaffingPlanSection.tsx`:
       - Toggle between "Named medics" and "Headcount + qualifications" (radio group or tabs)
       - Named medics mode: dynamic list, each row has name (text input — future Phase 37 will add roster picker), qualification (select from StaffingRole), notes (optional)
       - Headcount mode: dynamic list, each row has role (select from StaffingRole), quantity (number input)
       - At least one entry required for either mode

    4. `CoverLetterSection.tsx`:
       - Textarea for free-form pitch (max 5000 chars)
       - Character count indicator
       - Optional — not required for submission

    **Quote page (events/[id]/quote/page.tsx):**
    - Route: /marketplace/events/[eventId]/quote
    - Load event details, verify event is open and quote deadline not passed
    - Check if user has an existing draft for this event (load it into store if so)
    - Render QuoteSubmissionForm
    - If event is not open or deadline passed, show message and link back

    **Update event detail page (events/[id]/page.tsx):**
    - Replace the disabled "Submit a Quote" button with an active Link to `/marketplace/events/${eventId}/quote`
    - Only show the button if event.status === 'open' and deadline has not passed
    - Remove the "Phase 34" placeholder text
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - File `web/stores/useQuoteFormStore.ts` exists with submitQuote and saveDraft actions
    - File `web/app/api/marketplace/quotes/submit/route.ts` exports POST function
    - File `web/app/api/marketplace/quotes/save-draft/route.ts` exports POST function
    - File `web/app/api/marketplace/quotes/list/route.ts` exports GET function
    - File `web/app/api/marketplace/quotes/[id]/route.ts` exports GET function
    - File `web/app/marketplace/events/[id]/quote/page.tsx` renders QuoteSubmissionForm
    - File `web/app/marketplace/events/[id]/page.tsx` has active "Submit a Quote" link (no longer disabled)
    - `pnpm build` completes without errors (or at minimum no new errors introduced)
  </verify>
  <done>
    Companies can navigate from event detail to quote submission page, fill in itemised pricing (with custom line items), staffing plan (named medics or headcount), cover letter, confirm availability, save as draft, and submit. Minimum rates are enforced at both form and API level. Drafts auto-save with 2s debounce. API routes support submit, save-draft, list, and single quote detail.
  </done>
</task>

</tasks>

<verification>
- Database: migration 146 creates marketplace_quotes table with correct columns, RLS policies, and triggers
- Types: quote-types.ts exports all interfaces matching SQL schema
- Validation: quote-schemas.ts validates pricing > 0, staffing plan non-empty, availability confirmed
- Minimum rates: minimum-rates.ts correctly identifies below-guideline quotes
- Store: useQuoteFormStore manages full form state with submit and draft-save actions
- API: 4 routes handle submit, save-draft, list, and detail with auth + company verification
- UI: Quote submission form has pricing, staffing, cover letter sections with dynamic fields
- Integration: Event detail page links to quote form; form auto-saves drafts
- Build: `pnpm tsc --noEmit` and `pnpm build` pass
</verification>

<success_criteria>
1. A verified company user can navigate from event detail to /marketplace/events/[id]/quote
2. The form shows 4 fixed pricing categories + custom line items with running total
3. Staffing plan supports both named medics and headcount modes
4. Guideline rates are displayed and quotes below minimum are blocked
5. Draft auto-saves every 2 seconds on change
6. Submit creates a quote with status='submitted' in the database
7. Event detail page quote count increments after submission
</success_criteria>

<output>
After completion, create `.planning/phases/34-quote-submission-comparison/34-01-SUMMARY.md`
</output>
