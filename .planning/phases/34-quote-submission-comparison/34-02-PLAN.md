---
phase: 34-quote-submission-comparison
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - web/lib/marketplace/quote-scoring.ts
  - web/lib/anonymization/quote-anonymizer.ts
  - web/components/marketplace/quote-comparison/QuoteListView.tsx
  - web/components/marketplace/quote-comparison/QuoteRankRow.tsx
  - web/components/marketplace/quote-comparison/QuoteDetailModal.tsx
  - web/components/marketplace/quote-comparison/SortFilterBar.tsx
  - web/app/marketplace/events/[id]/quotes/page.tsx
  - web/app/marketplace/companies/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Client sees all received quotes in a ranked list sorted by best value (price + rating)"
    - "Client can sort quotes by price, rating, or response time and filter by qualification level"
    - "No contact details (phone, email, full names) are visible before award and deposit"
    - "Client can view full company profile (certifications, star rating, experience, insurance/compliance, written reviews) after a company has submitted a quote"
  artifacts:
    - path: "web/lib/marketplace/quote-scoring.ts"
      provides: "Best-value ranking algorithm"
      exports: ["calculateBestValueScore", "rankQuotesByBestValue"]
    - path: "web/lib/anonymization/quote-anonymizer.ts"
      provides: "Contact detail masking utility"
      exports: ["anonymiseQuoteForDisplay", "canViewContactDetails", "maskName"]
    - path: "web/components/marketplace/quote-comparison/QuoteListView.tsx"
      provides: "Ranked quote list with sort and filter"
      min_lines: 60
    - path: "web/components/marketplace/quote-comparison/QuoteRankRow.tsx"
      provides: "Single expandable quote row in ranked list"
      min_lines: 40
    - path: "web/components/marketplace/quote-comparison/SortFilterBar.tsx"
      provides: "Sort and filter controls for quote list"
      min_lines: 30
    - path: "web/app/marketplace/events/[id]/quotes/page.tsx"
      provides: "Client-facing quotes page for an event"
      min_lines: 20
    - path: "web/app/marketplace/companies/[id]/page.tsx"
      provides: "Company profile page (anonymised before award)"
      min_lines: 40
  key_links:
    - from: "web/components/marketplace/quote-comparison/QuoteListView.tsx"
      to: "web/lib/marketplace/quote-scoring.ts"
      via: "import rankQuotesByBestValue"
      pattern: "rankQuotesByBestValue"
    - from: "web/components/marketplace/quote-comparison/QuoteRankRow.tsx"
      to: "web/lib/anonymization/quote-anonymizer.ts"
      via: "import anonymiseQuoteForDisplay"
      pattern: "anonymiseQuoteForDisplay"
    - from: "web/components/marketplace/quote-comparison/QuoteListView.tsx"
      to: "/api/marketplace/quotes/list"
      via: "useQuoteList React Query hook"
      pattern: "useQuoteList"
    - from: "web/app/marketplace/events/[id]/quotes/page.tsx"
      to: "web/components/marketplace/quote-comparison/QuoteListView.tsx"
      via: "component import"
      pattern: "QuoteListView"
---

<objective>
Build the client-facing quote browsing and comparison interface. Clients see a ranked list of submitted quotes sorted by best value (60% price / 40% rating), with sort/filter options, expandable detail rows, anonymised contact details, and company profile pages accessible only for companies that have submitted a quote.

Purpose: This is the client's primary decision-making interface. Without ranked comparison and anonymisation, clients cannot evaluate quotes and the marketplace cannot function.
Output: Best-value scoring algorithm, anonymisation utility, ranked quote list with sort/filter, expandable quote rows, company profile page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-quote-submission-comparison/34-CONTEXT.md
@.planning/phases/34-quote-submission-comparison/34-RESEARCH.md
@.planning/phases/34-quote-submission-comparison/34-01-SUMMARY.md

Key existing files:
@web/lib/marketplace/quote-types.ts (created in 34-01)
@web/lib/queries/marketplace/quotes.ts (created in 34-01)
@web/lib/marketplace/event-types.ts (EventStatus, StaffingRole types)
@web/lib/marketplace/types.ts (MarketplaceCompany interface)
@web/app/marketplace/events/[id]/page.tsx (event detail page)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Best-value scoring algorithm and anonymisation utility</name>
  <files>
    web/lib/marketplace/quote-scoring.ts
    web/lib/anonymization/quote-anonymizer.ts
  </files>
  <action>
    **Best-value scoring (quote-scoring.ts):**
    Implement the algorithm from RESEARCH.md Pattern 2. This is the core business logic for quote ranking.

    `calculateBestValueScore(quote, allQuotes)`:
    - Input: single quote { total_price, company_rating (0-5), company_review_count }, array of all quotes for price range
    - Edge case: single quote returns 100
    - Edge case: all quotes same price, priceScore = 50
    - Normalize price to 0-100: `(maxPrice - quotePrice) / (maxPrice - minPrice) * 100` (lower price = higher score)
    - Rating to 0-100: `(company_rating / 5) * 100`
    - Blend: `(priceScore * 0.6) + (ratingScore * 0.4)` — 60% price, 40% rating
    - Return Math.round(bestValueScore)

    `rankQuotesByBestValue(quotes)`:
    - Maps each quote to include bestValueScore
    - Sorts descending by score
    - **Tiebreaker**: when scores are equal, sort by submitted_at DESC (most recent first), then by company_rating DESC
    - Return sorted array with bestValueScore attached

    **Anonymisation utility (quote-anonymizer.ts):**
    Implement from RESEARCH.md Pattern 4, with the CONTEXT rules:

    `maskName(fullName)`:
    - "James Smith" -> "James S."
    - Single name stays unchanged
    - Empty string returns empty string

    `anonymiseQuoteForDisplay(quote, eventStatus, isDepositPaid, isAuthor)`:
    - If isAuthor: return quote unchanged (company always sees their own full details)
    - If eventStatus === 'awarded' AND isDepositPaid: return quote unchanged (contact details revealed)
    - Otherwise: mask company_phone, company_email, company_address (set to undefined), mask medic names using maskName()
    - company_name stays VISIBLE before award (per CONTEXT)
    - Return the masked quote object

    `canViewContactDetails(eventStatus, isDepositPaid, currentUserId, eventPosterId, quoteCompanyAdminId)`:
    - Returns boolean
    - True if: currentUserId === quoteCompanyAdminId (always sees own details)
    - True if: eventStatus === 'awarded' AND isDepositPaid AND currentUserId === eventPosterId
    - False otherwise

    IMPORTANT: The CONTEXT says contact details hidden "until award AND deposit". So both conditions must be true. This is stricter than just checking eventStatus === 'awarded'.
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - quote-scoring.ts exports calculateBestValueScore and rankQuotesByBestValue
    - quote-anonymizer.ts exports anonymiseQuoteForDisplay, canViewContactDetails, maskName
    - Edge cases handled: single quote (score=100), same price (priceScore=50), empty name
  </verify>
  <done>
    Best-value algorithm normalizes price and rating to 0-100 scale, blends 60/40, handles edge cases, and sorts with tiebreakers. Anonymisation utility masks contact details based on event status + deposit status, with company name always visible and medic names shown as "First L." format.
  </done>
</task>

<task type="auto">
  <name>Task 2: Quote list view, expandable rows, sort/filter bar, and company profile page</name>
  <files>
    web/components/marketplace/quote-comparison/QuoteListView.tsx
    web/components/marketplace/quote-comparison/QuoteRankRow.tsx
    web/components/marketplace/quote-comparison/QuoteDetailModal.tsx
    web/components/marketplace/quote-comparison/SortFilterBar.tsx
    web/app/marketplace/events/[id]/quotes/page.tsx
    web/app/marketplace/companies/[id]/page.tsx
    web/app/marketplace/events/[id]/page.tsx
  </files>
  <action>
    **SortFilterBar.tsx:**
    - Sort dropdown with options: "Best Value" (default), "Lowest Price", "Highest Price", "Highest Rating", "Most Recent"
    - Filter controls: Qualification level (select from StaffingRole — 'Any', 'Paramedic', 'EMT', etc.), Price range (min/max number inputs), Minimum star rating (1-5 select)
    - Compact row layout — sort on left, filters on right (collapsible on mobile)
    - Calls onSortChange and onFilterChange props

    **QuoteRankRow.tsx:**
    - Expandable row component (Checkatrade/Bark pattern — click to expand details)
    - Collapsed state shows: rank number (#1, #2...), company name, star rating with count, total price (bold), qualification summary (e.g. "2x Paramedic, 1x EMT"), response time (e.g. "Responded in 2h"), and "Revised" badge if status === 'revised'
    - Expanded state reveals: full pricing breakdown table (staff/equipment/transport/consumables + custom lines), staffing plan details, cover letter text (truncated with "Read more"), and "View Company Profile" link
    - Apply anonymiseQuoteForDisplay() to mask contact details
    - Use shadcn/ui components: Badge, Button, Card
    - Show best-value score as a small indicator (e.g. "92% match" or just the numeric score)

    **QuoteDetailModal.tsx (optional — or inline expansion):**
    - If implementing as modal instead of inline expansion: shows full quote details + full company profile
    - Company profile section: company name, certifications & qualifications list, star rating with review count, number of past events completed, insurance/compliance status badges (green check / red X)
    - Written reviews section (placeholder — Phase 36 adds actual reviews)
    - "View Full Profile" button links to /marketplace/companies/[companyId]
    - Contact details section: shows "Contact details available after award and deposit" message if not revealed, or full contact info if conditions met

    **QuoteListView.tsx:**
    - Top-level component for the quote browsing page
    - Uses useQuoteList hook from quotes.ts (created in 34-01) to fetch quotes for the event
    - Applies rankQuotesByBestValue() when sortMode === 'best_value' (client-side sorting)
    - For other sort modes, pass sortBy to the API and use server-side sort order
    - Renders SortFilterBar + list of QuoteRankRow components
    - Loading state: skeleton rows (5 placeholder rows)
    - Empty state: "No quotes received yet. Check back soon." with appropriate styling
    - Shows total count: "{N} quotes received"
    - Handles filter state changes and re-fetches with updated params

    **Quotes page (events/[id]/quotes/page.tsx):**
    - Route: /marketplace/events/[eventId]/quotes
    - Client-only page — the event poster's view of all quotes
    - Load event details to show event name in header
    - Verify current user is the event poster (if not, show "Access denied" message)
    - Render QuoteListView with eventId
    - Breadcrumb: Browse Events / Event Name / Quotes

    **Company profile page (companies/[id]/page.tsx):**
    - Route: /marketplace/companies/[companyId]
    - Show company information from marketplace_companies table
    - Sections: Company Overview (name, description, coverage areas), Certifications & Qualifications, Star Rating & Reviews (placeholder for Phase 36), Past Events Completed (count placeholder), Insurance & Compliance Status (badges for each document type), Written Reviews (placeholder)
    - Contact details section: if canViewContactDetails() returns false, show "Contact details available after award and deposit paid" banner. If true, show phone, email, address.
    - Access control: this page should only be accessible if the company has submitted a quote on one of the viewer's events. Check this server-side or show a generic "Profile not available" message if no quote relationship exists.

    **Update event detail page (events/[id]/page.tsx):**
    - Add a "View Quotes ({quote_count})" link/button that navigates to /marketplace/events/[id]/quotes
    - Only visible to the event poster (posted_by === current user)
    - Show alongside the existing "Submit a Quote" button area
  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - QuoteListView renders with sort/filter controls and quote rows
    - QuoteRankRow shows collapsed (company name, price, rating) and expands to show full breakdown
    - SortFilterBar has 5 sort options and 3 filter types
    - events/[id]/quotes/page.tsx route exists and renders QuoteListView
    - companies/[id]/page.tsx route exists and shows company profile
    - Event detail page has "View Quotes" link for event poster
    - `pnpm build` completes without errors
  </verify>
  <done>
    Clients can navigate to /marketplace/events/[id]/quotes to see a ranked list of received quotes sorted by best value. They can re-sort by price/rating/recent and filter by qualification/price/rating. Each quote row expands to show full pricing breakdown, staffing plan, and cover letter. Company profiles are viewable with certifications, ratings, and compliance status. Contact details remain hidden until award + deposit.
  </done>
</task>

</tasks>

<verification>
- Scoring: best-value algorithm produces correct rankings (lower price + higher rating = higher score)
- Anonymisation: contact details hidden before award; company name visible; medic names masked as "First L."
- List: quotes displayed in ranked order with all sort/filter options working
- Row: expandable detail shows pricing breakdown, staffing plan, cover letter, company link
- Profile: company page shows certs, rating, compliance, reviews placeholder
- Privacy: no phone/email/full names visible unless event awarded AND deposit paid
- Build: `pnpm tsc --noEmit` and `pnpm build` pass
</verification>

<success_criteria>
1. Quote list page renders ranked quotes with best-value sort as default
2. Sort by price (low/high), rating, and most recent all work
3. Filter by qualification, price range, and minimum rating all work
4. Quote rows expand to show full pricing breakdown and staffing plan
5. Company names visible but phone/email/full names hidden before award
6. Company profile page accessible from expanded quote row
7. Event poster can navigate from event detail to quotes list
</success_criteria>

<output>
After completion, create `.planning/phases/34-quote-submission-comparison/34-02-SUMMARY.md`
</output>
