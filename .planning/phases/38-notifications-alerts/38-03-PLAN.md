---
phase: 38-notifications-alerts
plan: 03
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - web/lib/marketplace/event-fan-out.ts
  - web-marketplace/lib/marketplace/event-fan-out.ts
  - web-marketplace/app/api/marketplace/events/route.ts
  - web-marketplace/app/api/marketplace/quotes/submit/route.ts
  - web-marketplace/app/api/marketplace/quotes/[id]/award/route.ts
  - web/app/api/stripe/webhooks/route.ts
  - web/app/api/marketplace/events/[id]/ratings/route.ts
  - web/app/api/marketplace/messages/send/route.ts
  - web/app/api/marketplace/disputes/route.ts
  - web/app/api/marketplace/disputes/[id]/resolve/route.ts
  - web/app/api/marketplace/events/[id]/cancel/route.ts
  - web/app/api/cron/rating-nudges/route.ts
autonomous: true

must_haves:
  truths:
    - "When a new event is posted (status='open'), all verified companies get a dashboard notification (never filtered by radius)"
    - "When a new event is posted, companies with email_new_events=true (default) receive email alerts — filtered by event_alert_radius_miles if set (Haversine distance check against event location_coordinates)"
    - "Urgent/high-value events (<7 days away OR >2000 GBP budget) trigger SMS to companies with sms_new_events=true AND sms_phone_number set — also filtered by radius"
    - "When a company submits a quote, the event poster gets a 'quote_received' dashboard notification + email"
    - "When a client awards a quote, the winner gets 'quote_awarded' notification and losers get 'quote_rejected' notifications"
    - "Payment events (deposit success, remainder failure) create appropriate dashboard notifications"
    - "Rating submissions, messages, disputes, and dispute resolutions all create dashboard notifications"
    - "All notification triggers are fire-and-forget (never block the primary API response)"
  artifacts:
    - path: "web/lib/marketplace/event-fan-out.ts"
      provides: "Fan-out logic for new event notifications to matching companies"
      exports: ["fanOutNewEventNotifications"]
    - path: "web-marketplace/app/api/marketplace/events/route.ts"
      provides: "Event posting route with fan-out trigger"
      contains: "fanOutNewEventNotifications"
    - path: "web-marketplace/app/api/marketplace/quotes/submit/route.ts"
      provides: "Quote submission with quote_received notification"
      contains: "createNotification"
  key_links:
    - from: "web-marketplace/app/api/marketplace/events/route.ts"
      to: "web/lib/marketplace/event-fan-out.ts"
      via: "fire-and-forget call after event insert succeeds"
      pattern: "fanOutNewEventNotifications"
    - from: "web/lib/marketplace/event-fan-out.ts"
      to: "web/lib/marketplace/create-notification.ts"
      via: "createBulkNotifications for dashboard feed"
      pattern: "createNotification|createBulkNotifications"
    - from: "web/lib/marketplace/event-fan-out.ts"
      to: "web/lib/marketplace/sms.ts"
      via: "sendSMS for urgent/high-value events"
      pattern: "sendSMS"
---

<objective>
Wire notification triggers into all existing marketplace API routes so that every marketplace action generates appropriate dashboard notifications, emails, and SMS alerts.

Purpose: Without triggers, no notifications are ever created. This plan connects the notification system (Plan 01) to the existing marketplace workflows. The event fan-out (new event -> notify all companies) is the most complex piece, implementing NOTIF-01/02/03. The action triggers (quote, award, payment, rating, message, dispute) implement NOTIF-04.

Output: Event fan-out utility module plus notification triggers in 10+ existing API routes.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-notifications-alerts/38-RESEARCH.md
@.planning/phases/38-notifications-alerts/38-01-SUMMARY.md

# Trigger points (existing routes to modify)
@web-marketplace/app/api/marketplace/events/route.ts — POST handler for new events
@web-marketplace/app/api/marketplace/quotes/submit/route.ts — quote submission
@web-marketplace/app/api/marketplace/quotes/[id]/award/route.ts — quote award
@web/app/api/stripe/webhooks/route.ts — payment webhook (deposit success, remainder)
@web/app/api/marketplace/events/[id]/ratings/route.ts — rating submission
@web/app/api/marketplace/messages/send/route.ts — marketplace message send
@web/app/api/marketplace/disputes/route.ts — dispute filing
@web/app/api/marketplace/disputes/[id]/resolve/route.ts — dispute resolution
@web/app/api/marketplace/events/[id]/cancel/route.ts — event cancellation
@web/app/api/cron/rating-nudges/route.ts — rating nudge cron

# Utilities from Plan 01
@web/lib/marketplace/create-notification.ts — createNotification, createBulkNotifications
@web/lib/marketplace/sms.ts — sendSMS
@web/lib/marketplace/notification-types.ts — NOTIFICATION_TYPES
@web/lib/marketplace/notifications.ts — existing email notification functions (continue using these)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Event fan-out module and event posting trigger</name>
  <files>
    web/lib/marketplace/event-fan-out.ts
    web-marketplace/lib/marketplace/event-fan-out.ts
    web-marketplace/app/api/marketplace/events/route.ts
  </files>
  <action>
    Create web/lib/marketplace/event-fan-out.ts:
    - Import createNotification from './create-notification'
    - Import sendSMS from './sms'
    - Import { resend } from '@/lib/email/resend' (for email alerts)
    - Import NOTIFICATION_TYPES from './notification-types'

    Export async function fanOutNewEventNotifications(params: {
      supabase: SupabaseClient (service-role client),
      event: { id: string; event_name: string; event_type: string; budget_max: number | null; posted_by: string; location_coordinates: { lat: number; lng: number } | null },
      firstEventDate: Date | null,
    }): Promise<void>

    Implementation:
    1. Fetch all verified companies: supabase.from('marketplace_companies')
       .select('id, company_name, company_email, admin_user_id')
       .eq('verification_status', 'verified')
       .eq('can_browse_events', true)
       - Exclude the event poster's own company (if they have one)
    2. If no companies, return early
    3. Determine urgency:
       - isUrgent = firstEventDate && (firstEventDate.getTime() - Date.now()) < 7 * 24 * 60 * 60 * 1000
       - isHighValue = (event.budget_max ?? 0) > 2000
       - triggerSMS = isUrgent || isHighValue
    4. Fetch notification preferences for all company admin_user_ids:
       supabase.from('marketplace_notification_preferences')
       .select('user_id, email_new_events, sms_new_events, sms_phone_number, event_alert_radius_miles')
       .in('user_id', adminUserIds)
    5. Add a private helper function for Haversine distance calculation (no external dependency needed):
       ```
       function haversineDistanceMiles(lat1: number, lng1: number, lat2: number, lng2: number): number {
         const R = 3959; // Earth radius in miles
         const dLat = (lat2 - lat1) * Math.PI / 180;
         const dLng = (lng2 - lng1) * Math.PI / 180;
         const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) ** 2;
         return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
       }
       ```
    6. To apply the radius check, the fan-out also needs company location. Fetch each company's location from marketplace_companies.location_coordinates (if the column exists) or from the company's postcode geocode. If company location is not available, skip the radius check for that company (no filtering = show all events).

    7. Fan out with individual try/catch per company (one failure does NOT block others):
       For each company:
       - RADIUS CHECK (for email/SMS only — dashboard notifications are NEVER filtered by radius):
         If prefs?.event_alert_radius_miles is set AND event.location_coordinates is not null:
           - Get company location (from marketplace_companies.location_coordinates or company address geocode)
           - If company location is available, calculate distance using haversineDistanceMiles()
           - If distance > prefs.event_alert_radius_miles, set skipEmailSMS = true
           - If company location is NOT available, set skipEmailSMS = false (no filtering fallback)
         Else: skipEmailSMS = false (no radius set or no event location = no filtering)
       a. Always create dashboard notification (NEVER filtered by radius): createNotification({
            userId: company.admin_user_id,
            type: 'new_event',
            title: `New event: ${event.event_name}`,
            body: `A new ${event.event_type} event has been posted on the marketplace.`,
            link: `/marketplace/events/${event.id}`,
            metadata: { event_id: event.id, event_type: event.event_type }
          })
       b. Email if opted in AND NOT filtered by radius (prefs?.email_new_events !== false — default is true, AND skipEmailSMS is false):
          - Send via resend.emails.send with event summary email (event name, type, date, budget range — NO client contact details)
          - Same FROM_ADDRESS pattern as notifications.ts
          - Include "View Event" CTA button linking to /marketplace/events/{id}
       c. SMS if triggerSMS AND prefs?.sms_new_events === true AND prefs?.sms_phone_number exists AND skipEmailSMS is false:
          - SMS body: "SiteMedic: New [urgent/high-value] event posted: {event_name} ({event_type}). View on SiteMedic."
          - Track daily SMS cap: query count of 'new_event' type notifications for this user in last 24h. If >= 5, skip SMS.
          - Call sendSMS({ to: prefs.sms_phone_number, body })

    IMPORTANT: The entire fanOutNewEventNotifications call must be fire-and-forget from the event POST handler.
    Use `void fanOutNewEventNotifications(...)` (no await) so it does not delay the API response.

    Modify web-marketplace/app/api/marketplace/events/route.ts:
    - CROSS-APP IMPORT DECISION: web-marketplace has its own @/* path alias pointing to web-marketplace/* (NOT web/*). It CANNOT import from web/lib/ directly. Since event-fan-out.ts lives in web/lib/ and is only called from the events POST handler, the CHOSEN APPROACH is:
      - Create a thin inline helper directly in the events route file (or a local web-marketplace/lib/marketplace/event-fan-out.ts) that performs the fan-out using the service-role Supabase client already available in the route.
      - Alternatively, since the events route already has a service-role supabase client, the simplest approach is to import the fan-out function by adding a relative path import: `import { fanOutNewEventNotifications } from '../../../../web/lib/marketplace/event-fan-out'` — BUT this breaks module resolution. Instead, MOVE event-fan-out.ts to a location accessible by BOTH apps, OR duplicate the fan-out call inline in the events route.
      - FINAL DECISION: Keep event-fan-out.ts in web/lib/marketplace/ and create a THIN WRAPPER at web-marketplace/lib/marketplace/event-fan-out.ts that re-implements the same logic inline. This is acceptable because:
        1. The fan-out is the ONLY cross-app notification function (all other triggers in Task 2 are in web/ routes)
        2. The logic is self-contained (~50 lines)
        3. It avoids complex monorepo path aliasing
    - After successful event INSERT (when status is 'open', not 'draft'):
      - Fetch the first event date from the event_days that were just inserted
      - Call void fanOutNewEventNotifications({ supabase, event: insertedEvent, firstEventDate })
    - This is fire-and-forget — do NOT await it. The POST should return 201 immediately.
  </action>
  <verify>
    - web/lib/marketplace/event-fan-out.ts exports fanOutNewEventNotifications
    - grep for "fanOutNewEventNotifications" in web-marketplace/app/api/marketplace/events/route.ts
    - grep for "void fanOutNewEventNotifications" (fire-and-forget, not awaited)
    - grep for "sms_new_events" in event-fan-out.ts (SMS preference check exists)
    - grep for "email_new_events" in event-fan-out.ts (email preference check exists)
    - grep for ">= 5" or "daily" in event-fan-out.ts (SMS daily cap exists)
    - grep for "haversine" or "Haversine" in event-fan-out.ts (radius filtering exists)
    - grep for "event_alert_radius_miles" in event-fan-out.ts (radius preference is checked and APPLIED, not just fetched)
  </verify>
  <done>
    New event posting triggers fan-out notifications to all verified companies.
    Dashboard notifications always created (never filtered by radius). Emails and SMS filtered by radius when prefs.event_alert_radius_miles is set and event has location coordinates (Haversine distance check).
    Emails sent if opted in and within radius. SMS sent for urgent/high-value events if opted in, within radius, with daily cap of 5.
    Fan-out is fire-and-forget and does not delay the event creation response.
  </done>
</task>

<task type="auto">
  <name>Task 2: Marketplace action notification triggers in existing API routes</name>
  <files>
    web-marketplace/app/api/marketplace/quotes/submit/route.ts
    web-marketplace/app/api/marketplace/quotes/[id]/award/route.ts
    web/app/api/stripe/webhooks/route.ts
    web/app/api/marketplace/events/[id]/ratings/route.ts
    web/app/api/marketplace/messages/send/route.ts
    web/app/api/marketplace/disputes/route.ts
    web/app/api/marketplace/disputes/[id]/resolve/route.ts
    web/app/api/marketplace/events/[id]/cancel/route.ts
    web/app/api/cron/rating-nudges/route.ts
  </files>
  <action>
    For EACH route below, add a notification trigger AFTER the primary action succeeds. Each trigger must be wrapped in its own try/catch (fire-and-forget pattern from notifications.ts). Import createNotification from '@/lib/marketplace/create-notification' (or equivalent path for web-marketplace).

    1. Quote submission (web-marketplace/app/api/marketplace/quotes/submit/route.ts):
       After successful quote INSERT:
       - Fetch the event's posted_by user_id
       - createNotification({ userId: posted_by, type: 'quote_received', title: 'New quote received', body: `A company has submitted a quote for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, quote_id } })

    2. Quote award (web-marketplace/app/api/marketplace/quotes/[id]/award/route.ts):
       After successful award:
       - Winner: createNotification({ userId: winner.admin_user_id, type: 'quote_awarded', title: 'Your quote has been awarded!', body: `Congratulations! Your quote for ${event_name} was selected.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, quote_id } })
       - Losers (all other submitted quotes for this event): For each losing company,
         createNotification({ userId: loser.admin_user_id, type: 'quote_rejected', title: 'Quote update', body: `Another provider was selected for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, quote_id: loser_quote_id } })
       NOTE: The existing email notifications (sendAwardNotification, sendRejectionNotification) already exist. Add DASHBOARD notifications alongside them. Do NOT duplicate emails.

    3. Payment webhook (web/app/api/stripe/webhooks/route.ts):
       After marketplace deposit succeeds:
       - To company: createNotification({ userId: company.admin_user_id, type: 'payment_received', title: 'Deposit received', body: `Deposit payment confirmed for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, payment_intent_id } })
       - To client: createNotification({ userId: client_user_id, type: 'payment_received', title: 'Deposit confirmed', body: `Your deposit for ${event_name} has been processed.`, link: `/marketplace/events/${event_id}`, metadata: { event_id } })
       After remainder payment fails:
       - To client: createNotification({ userId: client_user_id, type: 'payment_failed', title: 'Payment failed', body: `We were unable to charge your card for ${event_name}. Please update your payment method.`, link: `/marketplace/payments`, metadata: { event_id } })

    4. Rating submission (web/app/api/marketplace/events/[id]/ratings/route.ts):
       After successful rating INSERT:
       - createNotification({ userId: rated_user_id, type: 'rating_received', title: 'New rating received', body: `You received a new rating for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, rating_id } })

    5. Marketplace message (web/app/api/marketplace/messages/send/route.ts):
       After successful message INSERT:
       - createNotification({ userId: recipient_user_id, type: 'message_received', title: `New message from ${sender_name}`, body: `${message_preview.substring(0, 100)}...`, link: `/marketplace/messages?conversation=${conversation_id}`, metadata: { conversation_id, event_id } })
       NOTE: The existing email notification (sendMarketplaceMessageNotification) already fires here. Add DASHBOARD notification alongside it. Do NOT duplicate emails.

    6. Dispute filed (web/app/api/marketplace/disputes/route.ts):
       After successful dispute INSERT:
       - createNotification({ userId: other_party_user_id, type: 'dispute_filed', title: 'Dispute filed', body: `A dispute has been filed for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, dispute_id } })
       NOTE: sendDisputeFiledNotification email already fires. Add dashboard notification alongside.

    7. Dispute resolved (web/app/api/marketplace/disputes/[id]/resolve/route.ts):
       After successful resolution:
       - For BOTH parties: createNotification({ userId, type: 'dispute_resolved', title: 'Dispute resolved', body: `The dispute for ${event_name} has been resolved.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, dispute_id, resolution_type } })
       NOTE: sendDisputeResolvedNotification email already fires. Add dashboard notification alongside.

    8. Event cancellation (web/app/api/marketplace/events/[id]/cancel/route.ts):
       After successful cancellation:
       - For all companies with quotes on this event: createNotification({ userId: company.admin_user_id, type: 'event_cancelled', title: 'Event cancelled', body: `${event_name} has been cancelled.`, link: `/marketplace/events/${event_id}`, metadata: { event_id } })

    9. Rating nudge cron (web/app/api/cron/rating-nudges/route.ts):
       When sending rating nudge emails:
       - Also create dashboard notification: createNotification({ userId, type: 'rating_nudge', title: 'Rate your experience', body: `How was your experience with ${event_name}?`, link: `/marketplace/events/${event_id}`, metadata: { event_id } })

    CROSS-APP IMPORT RESOLUTION:
    Routes in web-marketplace/ (quotes/submit and quotes/[id]/award) CANNOT import from web/lib/ because web-marketplace has its own @/* alias pointing to web-marketplace/*.
    CHOSEN APPROACH: For the two web-marketplace routes that need createNotification (quotes/submit and quotes/[id]/award), inline the Supabase INSERT logic directly — it is only ~5 lines:
    ```
    try {
      await supabase.from('user_notifications').insert({
        user_id: targetUserId, type: 'quote_received', title: '...', body: '...', link: '...', metadata: { ... }
      });
    } catch (err) {
      console.error('[Notifications] Failed:', err);
    }
    ```
    The supabase client in these routes is already a service-role client, so the INSERT will be allowed by RLS.
    Do NOT create a shared package or complex import setup — the inline approach is simpler and these are the only two web-marketplace routes needing notification writes.
  </action>
  <verify>
    - grep for "createNotification" in each modified route file
    - grep for "quote_received" in quotes/submit/route.ts
    - grep for "quote_awarded" and "quote_rejected" in quotes/[id]/award/route.ts
    - grep for "payment_received" or "payment_failed" in stripe/webhooks/route.ts
    - grep for "rating_received" in events/[id]/ratings/route.ts
    - grep for "message_received" in messages/send/route.ts
    - grep for "dispute_filed" in disputes/route.ts
    - grep for "dispute_resolved" in disputes/[id]/resolve/route.ts
    - grep for "event_cancelled" in events/[id]/cancel/route.ts
    - grep for "rating_nudge" in cron/rating-nudges/route.ts
    - Verify each trigger is in its own try/catch block (fire-and-forget)
  </verify>
  <done>
    All 12 notification types have triggers wired into the appropriate API routes.
    Every trigger is fire-and-forget with individual try/catch.
    Dashboard notifications created for all marketplace actions.
    Existing email notifications preserved (not duplicated).
  </done>
</task>

</tasks>

<verification>
- New event posting creates dashboard notifications for all verified companies
- New event posting sends email to companies with email_new_events enabled (default)
- Urgent/high-value events trigger SMS to opted-in companies (with daily cap of 5)
- Quote submission creates dashboard notification for event poster
- Award creates dashboard notifications for winner and losers
- Payment events create dashboard notifications for relevant parties
- Rating, message, dispute, cancellation all create dashboard notifications
- Rating nudge cron creates dashboard notifications alongside emails
- All triggers are fire-and-forget (wrapped in try/catch, never blocking primary response)
- No client contact details in event alert emails (NOTIF-02 requirement)
</verification>

<success_criteria>
- All 12 notification types from the CHECK constraint in migration 159 have at least one trigger point
- Event fan-out runs asynchronously (void call, not awaited)
- SMS daily cap of 5 enforced for event alerts
- Existing email notification functions preserved and working alongside new dashboard notifications
</success_criteria>

<output>
After completion, create `.planning/phases/38-notifications-alerts/38-03-SUMMARY.md`
</output>
