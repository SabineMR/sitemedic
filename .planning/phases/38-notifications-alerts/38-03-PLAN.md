---
phase: 38-notifications-alerts
plan: 03
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - web/lib/marketplace/event-fan-out.ts
  - web-marketplace/app/api/marketplace/events/route.ts
  - web-marketplace/app/api/marketplace/quotes/submit/route.ts
  - web-marketplace/app/api/marketplace/quotes/[id]/award/route.ts
  - web/app/api/stripe/webhooks/route.ts
  - web/app/api/marketplace/events/[id]/ratings/route.ts
  - web/app/api/marketplace/messages/send/route.ts
  - web/app/api/marketplace/disputes/route.ts
  - web/app/api/marketplace/disputes/[id]/resolve/route.ts
  - web/app/api/marketplace/events/[id]/cancel/route.ts
  - web/app/api/cron/rating-nudges/route.ts
autonomous: true

must_haves:
  truths:
    - "When a new event is posted (status='open'), all verified companies get a dashboard notification"
    - "When a new event is posted, companies with email_new_events=true (default) receive email alerts with event summary (no client contact details)"
    - "Urgent/high-value events (<7 days away OR >2000 GBP budget) trigger SMS to companies with sms_new_events=true AND sms_phone_number set"
    - "When a company submits a quote, the event poster gets a 'quote_received' dashboard notification + email"
    - "When a client awards a quote, the winner gets 'quote_awarded' notification and losers get 'quote_rejected' notifications"
    - "Payment events (deposit success, remainder failure) create appropriate dashboard notifications"
    - "Rating submissions, messages, disputes, and dispute resolutions all create dashboard notifications"
    - "All notification triggers are fire-and-forget (never block the primary API response)"
  artifacts:
    - path: "web/lib/marketplace/event-fan-out.ts"
      provides: "Fan-out logic for new event notifications to matching companies"
      exports: ["fanOutNewEventNotifications"]
    - path: "web-marketplace/app/api/marketplace/events/route.ts"
      provides: "Event posting route with fan-out trigger"
      contains: "fanOutNewEventNotifications"
    - path: "web-marketplace/app/api/marketplace/quotes/submit/route.ts"
      provides: "Quote submission with quote_received notification"
      contains: "createNotification"
  key_links:
    - from: "web-marketplace/app/api/marketplace/events/route.ts"
      to: "web/lib/marketplace/event-fan-out.ts"
      via: "fire-and-forget call after event insert succeeds"
      pattern: "fanOutNewEventNotifications"
    - from: "web/lib/marketplace/event-fan-out.ts"
      to: "web/lib/marketplace/create-notification.ts"
      via: "createBulkNotifications for dashboard feed"
      pattern: "createNotification|createBulkNotifications"
    - from: "web/lib/marketplace/event-fan-out.ts"
      to: "web/lib/marketplace/sms.ts"
      via: "sendSMS for urgent/high-value events"
      pattern: "sendSMS"
---

<objective>
Wire notification triggers into all existing marketplace API routes so that every marketplace action generates appropriate dashboard notifications, emails, and SMS alerts.

Purpose: Without triggers, no notifications are ever created. This plan connects the notification system (Plan 01) to the existing marketplace workflows. The event fan-out (new event -> notify all companies) is the most complex piece, implementing NOTIF-01/02/03. The action triggers (quote, award, payment, rating, message, dispute) implement NOTIF-04.

Output: Event fan-out utility module plus notification triggers in 10+ existing API routes.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-notifications-alerts/38-RESEARCH.md
@.planning/phases/38-notifications-alerts/38-01-SUMMARY.md

# Trigger points (existing routes to modify)
@web-marketplace/app/api/marketplace/events/route.ts — POST handler for new events
@web-marketplace/app/api/marketplace/quotes/submit/route.ts — quote submission
@web-marketplace/app/api/marketplace/quotes/[id]/award/route.ts — quote award
@web/app/api/stripe/webhooks/route.ts — payment webhook (deposit success, remainder)
@web/app/api/marketplace/events/[id]/ratings/route.ts — rating submission
@web/app/api/marketplace/messages/send/route.ts — marketplace message send
@web/app/api/marketplace/disputes/route.ts — dispute filing
@web/app/api/marketplace/disputes/[id]/resolve/route.ts — dispute resolution
@web/app/api/marketplace/events/[id]/cancel/route.ts — event cancellation
@web/app/api/cron/rating-nudges/route.ts — rating nudge cron

# Utilities from Plan 01
@web/lib/marketplace/create-notification.ts — createNotification, createBulkNotifications
@web/lib/marketplace/sms.ts — sendSMS
@web/lib/marketplace/notification-types.ts — NOTIFICATION_TYPES
@web/lib/marketplace/notifications.ts — existing email notification functions (continue using these)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Event fan-out module and event posting trigger</name>
  <files>
    web/lib/marketplace/event-fan-out.ts
    web-marketplace/app/api/marketplace/events/route.ts
  </files>
  <action>
    Create web/lib/marketplace/event-fan-out.ts:
    - Import createNotification from './create-notification'
    - Import sendSMS from './sms'
    - Import { resend } from '@/lib/email/resend' (for email alerts)
    - Import NOTIFICATION_TYPES from './notification-types'

    Export async function fanOutNewEventNotifications(params: {
      supabase: SupabaseClient (service-role client),
      event: { id: string; event_name: string; event_type: string; budget_max: number | null; posted_by: string },
      firstEventDate: Date | null,
    }): Promise<void>

    Implementation:
    1. Fetch all verified companies: supabase.from('marketplace_companies')
       .select('id, company_name, company_email, admin_user_id')
       .eq('verification_status', 'verified')
       .eq('can_browse_events', true)
       - Exclude the event poster's own company (if they have one)
    2. If no companies, return early
    3. Determine urgency:
       - isUrgent = firstEventDate && (firstEventDate.getTime() - Date.now()) < 7 * 24 * 60 * 60 * 1000
       - isHighValue = (event.budget_max ?? 0) > 2000
       - triggerSMS = isUrgent || isHighValue
    4. Fetch notification preferences for all company admin_user_ids:
       supabase.from('marketplace_notification_preferences')
       .select('user_id, email_new_events, sms_new_events, sms_phone_number, event_alert_radius_miles')
       .in('user_id', adminUserIds)
    5. Fan out with individual try/catch per company (one failure does NOT block others):
       For each company:
       a. Always create dashboard notification: createNotification({
            userId: company.admin_user_id,
            type: 'new_event',
            title: `New event: ${event.event_name}`,
            body: `A new ${event.event_type} event has been posted on the marketplace.`,
            link: `/marketplace/events/${event.id}`,
            metadata: { event_id: event.id, event_type: event.event_type }
          })
       b. Email if opted in (prefs?.email_new_events !== false — default is true):
          - Send via resend.emails.send with event summary email (event name, type, date, budget range — NO client contact details)
          - Same FROM_ADDRESS pattern as notifications.ts
          - Include "View Event" CTA button linking to /marketplace/events/{id}
       c. SMS if triggerSMS AND prefs?.sms_new_events === true AND prefs?.sms_phone_number exists:
          - SMS body: "SiteMedic: New [urgent/high-value] event posted: {event_name} ({event_type}). View on SiteMedic."
          - Track daily SMS cap: query count of 'new_event' type notifications for this user in last 24h. If >= 5, skip SMS.
          - Call sendSMS({ to: prefs.sms_phone_number, body })

    IMPORTANT: The entire fanOutNewEventNotifications call must be fire-and-forget from the event POST handler.
    Use `void fanOutNewEventNotifications(...)` (no await) so it does not delay the API response.

    Modify web-marketplace/app/api/marketplace/events/route.ts:
    - Import fanOutNewEventNotifications from the utility (may need path alias adjustment for web-marketplace imports)
    - After successful event INSERT (when status is 'open', not 'draft'):
      - Fetch the first event date from the event_days that were just inserted
      - Call void fanOutNewEventNotifications({ supabase, event: insertedEvent, firstEventDate })
    - This is fire-and-forget — do NOT await it. The POST should return 201 immediately.

    NOTE: Since web-marketplace is a separate Next.js app, the import path needs to reference shared lib correctly. Check how web-marketplace currently imports from shared code. If it uses its own lib/, create a thin wrapper that calls the shared module, or duplicate the fire-and-forget pattern inline. Follow whatever import pattern the codebase already uses for cross-app sharing.
  </action>
  <verify>
    - web/lib/marketplace/event-fan-out.ts exports fanOutNewEventNotifications
    - grep for "fanOutNewEventNotifications" in web-marketplace/app/api/marketplace/events/route.ts
    - grep for "void fanOutNewEventNotifications" (fire-and-forget, not awaited)
    - grep for "sms_new_events" in event-fan-out.ts (SMS preference check exists)
    - grep for "email_new_events" in event-fan-out.ts (email preference check exists)
    - grep for ">= 5" or "daily" in event-fan-out.ts (SMS daily cap exists)
  </verify>
  <done>
    New event posting triggers fan-out notifications to all verified companies.
    Dashboard notifications always created. Emails sent if opted in. SMS sent for urgent/high-value events if opted in with daily cap of 5.
    Fan-out is fire-and-forget and does not delay the event creation response.
  </done>
</task>

<task type="auto">
  <name>Task 2: Marketplace action notification triggers in existing API routes</name>
  <files>
    web-marketplace/app/api/marketplace/quotes/submit/route.ts
    web-marketplace/app/api/marketplace/quotes/[id]/award/route.ts
    web/app/api/stripe/webhooks/route.ts
    web/app/api/marketplace/events/[id]/ratings/route.ts
    web/app/api/marketplace/messages/send/route.ts
    web/app/api/marketplace/disputes/route.ts
    web/app/api/marketplace/disputes/[id]/resolve/route.ts
    web/app/api/marketplace/events/[id]/cancel/route.ts
    web/app/api/cron/rating-nudges/route.ts
  </files>
  <action>
    For EACH route below, add a notification trigger AFTER the primary action succeeds. Each trigger must be wrapped in its own try/catch (fire-and-forget pattern from notifications.ts). Import createNotification from '@/lib/marketplace/create-notification' (or equivalent path for web-marketplace).

    1. Quote submission (web-marketplace/app/api/marketplace/quotes/submit/route.ts):
       After successful quote INSERT:
       - Fetch the event's posted_by user_id
       - createNotification({ userId: posted_by, type: 'quote_received', title: 'New quote received', body: `A company has submitted a quote for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, quote_id } })

    2. Quote award (web-marketplace/app/api/marketplace/quotes/[id]/award/route.ts):
       After successful award:
       - Winner: createNotification({ userId: winner.admin_user_id, type: 'quote_awarded', title: 'Your quote has been awarded!', body: `Congratulations! Your quote for ${event_name} was selected.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, quote_id } })
       - Losers (all other submitted quotes for this event): For each losing company,
         createNotification({ userId: loser.admin_user_id, type: 'quote_rejected', title: 'Quote update', body: `Another provider was selected for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, quote_id: loser_quote_id } })
       NOTE: The existing email notifications (sendAwardNotification, sendRejectionNotification) already exist. Add DASHBOARD notifications alongside them. Do NOT duplicate emails.

    3. Payment webhook (web/app/api/stripe/webhooks/route.ts):
       After marketplace deposit succeeds:
       - To company: createNotification({ userId: company.admin_user_id, type: 'payment_received', title: 'Deposit received', body: `Deposit payment confirmed for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, payment_intent_id } })
       - To client: createNotification({ userId: client_user_id, type: 'payment_received', title: 'Deposit confirmed', body: `Your deposit for ${event_name} has been processed.`, link: `/marketplace/events/${event_id}`, metadata: { event_id } })
       After remainder payment fails:
       - To client: createNotification({ userId: client_user_id, type: 'payment_failed', title: 'Payment failed', body: `We were unable to charge your card for ${event_name}. Please update your payment method.`, link: `/marketplace/payments`, metadata: { event_id } })

    4. Rating submission (web/app/api/marketplace/events/[id]/ratings/route.ts):
       After successful rating INSERT:
       - createNotification({ userId: rated_user_id, type: 'rating_received', title: 'New rating received', body: `You received a new rating for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, rating_id } })

    5. Marketplace message (web/app/api/marketplace/messages/send/route.ts):
       After successful message INSERT:
       - createNotification({ userId: recipient_user_id, type: 'message_received', title: `New message from ${sender_name}`, body: `${message_preview.substring(0, 100)}...`, link: `/marketplace/messages?conversation=${conversation_id}`, metadata: { conversation_id, event_id } })
       NOTE: The existing email notification (sendMarketplaceMessageNotification) already fires here. Add DASHBOARD notification alongside it. Do NOT duplicate emails.

    6. Dispute filed (web/app/api/marketplace/disputes/route.ts):
       After successful dispute INSERT:
       - createNotification({ userId: other_party_user_id, type: 'dispute_filed', title: 'Dispute filed', body: `A dispute has been filed for ${event_name}.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, dispute_id } })
       NOTE: sendDisputeFiledNotification email already fires. Add dashboard notification alongside.

    7. Dispute resolved (web/app/api/marketplace/disputes/[id]/resolve/route.ts):
       After successful resolution:
       - For BOTH parties: createNotification({ userId, type: 'dispute_resolved', title: 'Dispute resolved', body: `The dispute for ${event_name} has been resolved.`, link: `/marketplace/events/${event_id}`, metadata: { event_id, dispute_id, resolution_type } })
       NOTE: sendDisputeResolvedNotification email already fires. Add dashboard notification alongside.

    8. Event cancellation (web/app/api/marketplace/events/[id]/cancel/route.ts):
       After successful cancellation:
       - For all companies with quotes on this event: createNotification({ userId: company.admin_user_id, type: 'event_cancelled', title: 'Event cancelled', body: `${event_name} has been cancelled.`, link: `/marketplace/events/${event_id}`, metadata: { event_id } })

    9. Rating nudge cron (web/app/api/cron/rating-nudges/route.ts):
       When sending rating nudge emails:
       - Also create dashboard notification: createNotification({ userId, type: 'rating_nudge', title: 'Rate your experience', body: `How was your experience with ${event_name}?`, link: `/marketplace/events/${event_id}`, metadata: { event_id } })

    IMPORTANT CROSS-APP NOTE:
    Routes in web-marketplace/ need access to createNotification. Check how web-marketplace imports shared code:
    - If it has its own @/lib alias, the utility may need to be duplicated or the function called via a shared internal API
    - The simplest approach: create a thin wrapper in web-marketplace/lib/marketplace/create-notification.ts that imports from the shared module, or inline the Supabase INSERT logic directly (it's only 5 lines)
    - Follow whatever pattern the codebase already uses for cross-app code sharing
  </action>
  <verify>
    - grep for "createNotification" in each modified route file
    - grep for "quote_received" in quotes/submit/route.ts
    - grep for "quote_awarded" and "quote_rejected" in quotes/[id]/award/route.ts
    - grep for "payment_received" or "payment_failed" in stripe/webhooks/route.ts
    - grep for "rating_received" in events/[id]/ratings/route.ts
    - grep for "message_received" in messages/send/route.ts
    - grep for "dispute_filed" in disputes/route.ts
    - grep for "dispute_resolved" in disputes/[id]/resolve/route.ts
    - grep for "event_cancelled" in events/[id]/cancel/route.ts
    - grep for "rating_nudge" in cron/rating-nudges/route.ts
    - Verify each trigger is in its own try/catch block (fire-and-forget)
  </verify>
  <done>
    All 12 notification types have triggers wired into the appropriate API routes.
    Every trigger is fire-and-forget with individual try/catch.
    Dashboard notifications created for all marketplace actions.
    Existing email notifications preserved (not duplicated).
  </done>
</task>

</tasks>

<verification>
- New event posting creates dashboard notifications for all verified companies
- New event posting sends email to companies with email_new_events enabled (default)
- Urgent/high-value events trigger SMS to opted-in companies (with daily cap of 5)
- Quote submission creates dashboard notification for event poster
- Award creates dashboard notifications for winner and losers
- Payment events create dashboard notifications for relevant parties
- Rating, message, dispute, cancellation all create dashboard notifications
- Rating nudge cron creates dashboard notifications alongside emails
- All triggers are fire-and-forget (wrapped in try/catch, never blocking primary response)
- No client contact details in event alert emails (NOTIF-02 requirement)
</verification>

<success_criteria>
- All 12 notification types from the CHECK constraint in migration 159 have at least one trigger point
- Event fan-out runs asynchronously (void call, not awaited)
- SMS daily cap of 5 enforced for event alerts
- Existing email notification functions preserved and working alongside new dashboard notifications
</success_criteria>

<output>
After completion, create `.planning/phases/38-notifications-alerts/38-03-SUMMARY.md`
</output>
