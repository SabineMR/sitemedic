---
phase: 38-notifications-alerts
plan: 02
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - web/lib/queries/notifications.hooks.ts
  - web/components/dashboard/NotificationBell.tsx
  - web/app/(dashboard)/dashboard/notifications/page.tsx
  - web/app/(dashboard)/layout.tsx
  - web/app/api/marketplace/notifications/route.ts
  - web/app/api/marketplace/notifications/mark-read/route.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard header shows a bell icon with unread notification count badge"
    - "Clicking the bell icon opens a dropdown showing the 5 most recent notifications"
    - "Each notification in the dropdown shows title, body preview, timestamp, and read/unread indicator"
    - "Clicking 'View all' in the dropdown navigates to /dashboard/notifications full page"
    - "The full notifications page shows all notifications with pagination, mark-as-read, and mark-all-as-read"
    - "New notifications appear in the bell dropdown in real-time without page refresh (Supabase Realtime)"
    - "Marking a notification as read updates the bell badge count in real-time"
  artifacts:
    - path: "web/lib/queries/notifications.hooks.ts"
      provides: "TanStack Query hooks + Supabase Realtime subscription for notifications"
      exports: ["useNotifications", "useUnreadCount", "useRealtimeNotifications"]
    - path: "web/components/dashboard/NotificationBell.tsx"
      provides: "Bell icon with dropdown and unread badge"
      contains: "Bell"
    - path: "web/app/(dashboard)/dashboard/notifications/page.tsx"
      provides: "Full notification history page"
      contains: "Notifications"
    - path: "web/app/api/marketplace/notifications/route.ts"
      provides: "GET endpoint for fetching notifications with pagination"
      exports: ["GET"]
    - path: "web/app/api/marketplace/notifications/mark-read/route.ts"
      provides: "PATCH endpoint for marking notifications as read"
      exports: ["PATCH"]
  key_links:
    - from: "web/components/dashboard/NotificationBell.tsx"
      to: "web/lib/queries/notifications.hooks.ts"
      via: "useNotifications + useRealtimeNotifications hooks"
      pattern: "useNotifications|useRealtimeNotifications"
    - from: "web/app/(dashboard)/layout.tsx"
      to: "web/components/dashboard/NotificationBell.tsx"
      via: "Component import in header next to UnreadBadge"
      pattern: "NotificationBell"
    - from: "web/lib/queries/notifications.hooks.ts"
      to: "user_notifications"
      via: "Supabase Realtime postgres_changes subscription"
      pattern: "postgres_changes.*user_notifications"
---

<objective>
Build the dashboard notification feed UI: bell icon dropdown in the header, full notifications page, and Realtime hooks for live updates.

Purpose: This is how users discover and read their notifications. The bell icon provides quick-glance access in the header (alongside the existing UnreadBadge for messages), and the full page provides history with mark-as-read functionality. Realtime ensures the feed updates live without page refresh.

Output: NotificationBell component, notifications page, Realtime hooks, two API routes (GET notifications, PATCH mark-read).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-notifications-alerts/38-RESEARCH.md
@.planning/phases/38-notifications-alerts/38-01-SUMMARY.md

# Patterns to follow
@web/components/dashboard/UnreadBadge.tsx — bell icon pattern in dashboard header
@web/lib/queries/comms.hooks.ts — Realtime subscription pattern (useRealtimeMessages)
@web/app/(dashboard)/layout.tsx — dashboard header where NotificationBell must be added
@web/lib/marketplace/notification-types.ts — UserNotification type (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notification API routes and TanStack Query + Realtime hooks</name>
  <files>
    web/app/api/marketplace/notifications/route.ts
    web/app/api/marketplace/notifications/mark-read/route.ts
    web/lib/queries/notifications.hooks.ts
  </files>
  <action>
    Create GET /api/marketplace/notifications/route.ts:
    - Auth check (getUser, return 401 if not authenticated)
    - Accept query params: limit (default 50, max 100), offset (default 0), unread_only (boolean, default false)
    - Query supabase.from('user_notifications').select('*').eq('user_id', user.id).order('created_at', { ascending: false })
    - If unread_only, add .eq('is_read', false)
    - Guard the range call: if (limit > 0) apply .range(offset, offset + limit - 1). If limit is 0 or negative, skip the range call entirely (this prevents invalid .range(0, -1) calls).
    - Also query unread count: supabase.from('user_notifications').select('id', { count: 'exact', head: true }).eq('user_id', user.id).eq('is_read', false)
    - Return { notifications, unread_count, total_count }

    Create PATCH /api/marketplace/notifications/mark-read/route.ts:
    - Auth check
    - Accept JSON body: { notification_ids?: string[], mark_all?: boolean }
    - If mark_all is true: update all user's unread notifications to is_read=true, read_at=now()
    - If notification_ids provided: update those specific notifications (validate they belong to the user via user_id check)
    - Return { success: true, updated_count }

    Create web/lib/queries/notifications.hooks.ts:
    - 'use client' directive
    - Import useEffect, useState from 'react'
    - Import useQuery, useQueryClient, useMutation from '@tanstack/react-query'
    - Import createClient from '@/lib/supabase/client'
    - Import supabase as realtimeSupabase from '@/lib/supabase' (same pattern as comms.hooks.ts)
    - Import type RealtimeChannel from '@supabase/supabase-js'

    Export function useNotifications(limit = 50):
    - useQuery with queryKey: ['notifications', limit]
    - queryFn: fetch('/api/marketplace/notifications?limit=' + limit) then parse JSON
    - Return { data, isLoading, error }

    Export function useUnreadCount():
    - useQuery with queryKey: ['notification-unread-count']
    - queryFn: fetch('/api/marketplace/notifications?unread_only=true&limit=1') then return unread_count from response
    - NOTE: Use limit=1 (NOT limit=0) because limit=0 would cause .range(0, -1) which is invalid. We only need the unread_count from the response, not the notification data, but limit=1 is the minimum valid value.
    - staleTime: 30_000 (30 seconds)

    Export function useRealtimeNotifications(userId: string | null):
    - Follow EXACT pattern from useRealtimeMessages in comms.hooks.ts
    - Create channel: realtimeSupabase.channel(`notifications:user_${userId}`)
    - Listen for postgres_changes INSERT on user_notifications filtered by user_id=eq.${userId}
    - On INSERT: invalidate queryKeys ['notifications'] and ['notification-unread-count']
    - Listen for postgres_changes UPDATE on user_notifications filtered by user_id=eq.${userId}
    - On UPDATE: invalidate queryKeys ['notifications'] and ['notification-unread-count'] (for mark-as-read updates)
    - Return { isConnected }
    - Cleanup: removeChannel on unmount

    Export function useMarkNotificationsRead():
    - useMutation wrapping fetch('/api/marketplace/notifications/mark-read', { method: 'PATCH', body })
    - onSuccess: invalidate ['notifications'] and ['notification-unread-count'] queries
  </action>
  <verify>
    - Both API route files exist and export the correct HTTP methods
    - notifications.hooks.ts exports useNotifications, useUnreadCount, useRealtimeNotifications, useMarkNotificationsRead
    - grep for "postgres_changes" in notifications.hooks.ts (Realtime subscription exists)
    - grep for "invalidateQueries" in notifications.hooks.ts (cache invalidation wired)
  </verify>
  <done>
    API routes serve notifications with pagination and mark-as-read functionality.
    Hooks provide reactive data access with Realtime subscription for live updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: NotificationBell component, notifications page, and layout integration</name>
  <files>
    web/components/dashboard/NotificationBell.tsx
    web/app/(dashboard)/dashboard/notifications/page.tsx
    web/app/(dashboard)/layout.tsx
  </files>
  <action>
    Create web/components/dashboard/NotificationBell.tsx:
    - 'use client' directive
    - Import Bell from lucide-react
    - Import Popover, PopoverTrigger, PopoverContent from '@/components/ui/popover'
    - Import Button from '@/components/ui/button'
    - Import Link from 'next/link'
    - Import useNotifications, useUnreadCount, useRealtimeNotifications, useMarkNotificationsRead from hooks
    - Import formatDistanceToNow from 'date-fns'
    - Import type UserNotification from '@/lib/marketplace/notification-types'

    Props: { userId: string }

    Component:
    - Call useRealtimeNotifications(userId) to establish live subscription
    - Call useNotifications(5) for the dropdown preview (last 5)
    - Call useUnreadCount() for the badge number
    - Call useMarkNotificationsRead() for marking items read

    Render:
    - Popover with PopoverTrigger:
      - Bell icon button (relative positioning for badge)
      - If unreadCount > 0, show badge (same style as UnreadBadge: absolute -top-0.5 -right-0.5 red circle with count, max "99+")
    - PopoverContent (w-80, aligned to end):
      - Header: "Notifications" title + mark-all-as-read button (if any unread)
      - List of notifications (max 5):
        - Each item: title (font-medium), body (text-sm text-muted-foreground, truncated to 1 line), timestamp (text-xs text-muted-foreground, formatDistanceToNow)
        - Unread indicator: blue dot (bg-blue-500 rounded-full) on the left
        - Clickable: if notification has link, wrap in Link component
        - On click: mark as read via mutation
      - Empty state: "No notifications yet" centered text
      - Footer: "View all notifications" link to /dashboard/notifications (text-center, text-sm, text-primary)

    Create web/app/(dashboard)/dashboard/notifications/page.tsx:
    - Page title: "Notifications"
    - Use useNotifications(50) for the full list
    - Use useMarkNotificationsRead() for mark-as-read and mark-all-as-read
    - Header section: h1 "Notifications" + "Mark all as read" button (if any unread)
    - Notification list:
      - Each item: Card component with:
        - Left: blue dot if unread
        - Center: title (font-medium), body (text-sm), link (if exists, as "View" link)
        - Right: timestamp (formatDistanceToNow) + "Mark as read" button if unread
      - Click on card: mark as read + navigate to link if exists
    - Empty state: "You're all caught up! No notifications." with icon
    - Load more button at bottom (increment offset by 50)

    Modify web/app/(dashboard)/layout.tsx:
    - Import NotificationBell from '@/components/dashboard/NotificationBell'
    - In the header section (next to existing UnreadBadge), add NotificationBell:
      - Pass userId={user.id}
      - Place it BEFORE the UnreadBadge (bell icon for notifications, then message icon for messages)
    - The header should now show: [spacer] [NotificationBell] [UnreadBadge]
  </action>
  <verify>
    - NotificationBell.tsx is a 'use client' component
    - /dashboard/notifications/page.tsx exists
    - grep for "NotificationBell" in layout.tsx (component is imported and used)
    - grep for "Bell" in NotificationBell.tsx (lucide-react Bell icon)
    - grep for "formatDistanceToNow" in NotificationBell.tsx (timestamps formatted)
    - The layout header renders both NotificationBell and UnreadBadge
  </verify>
  <done>
    Dashboard header shows notification bell with real-time unread count badge.
    Clicking bell opens dropdown with last 5 notifications.
    Full notifications page at /dashboard/notifications shows complete history with mark-as-read.
    Realtime subscription keeps both bell badge and notification lists updated live.
  </done>
</task>

</tasks>

<verification>
- Bell icon visible in dashboard header with unread badge
- Dropdown shows last 5 notifications with timestamps and read/unread indicators
- Full notifications page loads at /dashboard/notifications
- Realtime: inserting a row into user_notifications causes the bell badge to update without refresh
- Mark-as-read updates the badge count and removes the unread indicator
- Mark-all-as-read clears all unread indicators and resets badge to zero
</verification>

<success_criteria>
- NotificationBell component renders in dashboard header alongside UnreadBadge
- Notifications page shows full history with pagination
- Realtime subscription delivers live updates (INSERT and UPDATE events)
- Mark-as-read API correctly updates notifications and invalidates caches
</success_criteria>

<output>
After completion, create `.planning/phases/38-notifications-alerts/38-02-SUMMARY.md`
</output>
