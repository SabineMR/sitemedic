---
phase: 38-notifications-alerts
plan: 04
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - web/app/api/marketplace/notification-preferences/route.ts
  - web/app/(dashboard)/dashboard/marketplace/settings/notifications/page.tsx
  - web/components/dashboard/NotificationPreferencesForm.tsx
autonomous: true

must_haves:
  truths:
    - "Users can view their current notification preferences in a channel x category matrix UI"
    - "Users can toggle email on/off per notification category (events, quotes, awards, payments, ratings, messages, disputes)"
    - "Users can toggle SMS on/off per applicable category (events, quotes, awards, payments) — SMS defaults are all OFF"
    - "Users can enter an SMS phone number in E.164 format (+447xxxxxxxxx) with validation"
    - "SMS opt-in requires explicit checkbox and records sms_opted_in_at timestamp (PECR compliance)"
    - "Users can set an event alert radius in miles (NULL = all UK, no filtering)"
    - "Preferences auto-create with sensible defaults on first GET if no row exists (upsert pattern)"
    - "Dashboard channel column is always on (greyed out, not toggleable) — dashboard notifications cannot be disabled"
  artifacts:
    - path: "web/app/api/marketplace/notification-preferences/route.ts"
      provides: "GET and PUT endpoints for notification preferences"
      exports: ["GET", "PUT"]
    - path: "web/app/(dashboard)/dashboard/marketplace/settings/notifications/page.tsx"
      provides: "Notification preferences settings page with channel x category matrix"
      contains: "Notification Preferences"
    - path: "web/components/dashboard/NotificationPreferencesForm.tsx"
      provides: "Channel x category matrix form component"
      contains: "NotificationPreferencesForm"
  key_links:
    - from: "web/components/dashboard/NotificationPreferencesForm.tsx"
      to: "web/app/api/marketplace/notification-preferences/route.ts"
      via: "fetch GET on mount, fetch PUT on save"
      pattern: "notification-preferences"
    - from: "web/app/api/marketplace/notification-preferences/route.ts"
      to: "marketplace_notification_preferences"
      via: "Supabase upsert"
      pattern: "marketplace_notification_preferences"
---

<objective>
Build the notification preferences UI and API so users can configure which channels (dashboard, email, SMS) they receive for each notification category.

Purpose: This implements NOTIF-05 — medics/companies can configure notification preferences. The channel x category matrix matches the GitHub/Slack/LinkedIn settings pattern. SMS opt-in with PECR compliance is critical for UK healthcare platform requirements. The preference values are read by the event fan-out (Plan 03) to determine which channels to use for each user.

Output: Preferences API route (GET/PUT with upsert), preferences page, and matrix form component.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-notifications-alerts/38-RESEARCH.md
@.planning/phases/38-notifications-alerts/38-01-SUMMARY.md

# Pattern references
@web/lib/marketplace/notification-types.ts — NOTIFICATION_CATEGORIES, NotificationPreferences type
@supabase/migrations/160_marketplace_notification_preferences.sql — table schema
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notification preferences API route</name>
  <files>
    web/app/api/marketplace/notification-preferences/route.ts
  </files>
  <action>
    Create GET and PUT handlers at web/app/api/marketplace/notification-preferences/route.ts:

    GET handler:
    - Auth check (getUser, return 401 if not authenticated)
    - Query supabase.from('marketplace_notification_preferences').select('*').eq('user_id', user.id).single()
    - If no row exists (PGRST116 error code), auto-create defaults via upsert:
      supabase.from('marketplace_notification_preferences').upsert({
        user_id: user.id,
        email_new_events: true, email_quotes: true, email_awards: true,
        email_payments: true, email_ratings: true, email_messages: true, email_disputes: true,
        sms_new_events: false, sms_quotes: false, sms_awards: false, sms_payments: false,
        event_alert_radius_miles: null, sms_phone_number: null, sms_opted_in_at: null
      }, { onConflict: 'user_id' }).select().single()
    - Return the preferences object

    PUT handler:
    - Auth check
    - Parse JSON body
    - Validate with Zod schema:
      z.object({
        email_new_events: z.boolean().optional(),
        email_quotes: z.boolean().optional(),
        email_awards: z.boolean().optional(),
        email_payments: z.boolean().optional(),
        email_ratings: z.boolean().optional(),
        email_messages: z.boolean().optional(),
        email_disputes: z.boolean().optional(),
        sms_new_events: z.boolean().optional(),
        sms_quotes: z.boolean().optional(),
        sms_awards: z.boolean().optional(),
        sms_payments: z.boolean().optional(),
        event_alert_radius_miles: z.number().int().min(1).max(500).nullable().optional(),
        sms_phone_number: z.string().regex(/^\+447\d{9}$/, 'UK mobile number must be in +447xxxxxxxxx format').nullable().optional(),
      })
    - Special SMS opt-in logic:
      - If any sms_* field is being set to true AND current sms_opted_in_at is null:
        Set sms_opted_in_at = new Date().toISOString() (record opt-in timestamp)
      - If ALL sms_* fields are false: clear sms_opted_in_at to null (opt-out)
    - Upsert to marketplace_notification_preferences (user_id = user.id)
    - Return updated preferences
  </action>
  <verify>
    - Route file exists and exports GET and PUT functions
    - grep for "upsert" in route file (auto-create on first GET)
    - grep for "sms_opted_in_at" in route file (PECR audit trail)
    - grep for "+447" in route file (E.164 validation)
    - grep for "PGRST116" in route file (handles missing row)
  </verify>
  <done>
    GET returns current preferences (auto-creating defaults for first-time users).
    PUT validates and saves preferences with Zod validation.
    SMS opt-in timestamp recorded on first SMS enable (PECR compliance).
    Phone number validated as UK mobile E.164 format.
  </done>
</task>

<task type="auto">
  <name>Task 2: Notification preferences page and matrix form component</name>
  <files>
    web/components/dashboard/NotificationPreferencesForm.tsx
    web/app/(dashboard)/dashboard/marketplace/settings/notifications/page.tsx
  </files>
  <action>
    Create web/components/dashboard/NotificationPreferencesForm.tsx:
    - 'use client' directive
    - Import Switch from '@/components/ui/switch'
    - Import Card, CardContent, CardDescription, CardHeader, CardTitle from '@/components/ui/card'
    - Import Button from '@/components/ui/button'
    - Import Input from '@/components/ui/input'
    - Import Label from '@/components/ui/label'
    - Import { toast } from 'sonner'
    - Import useState, useEffect from 'react'
    - Import Bell, Mail, Smartphone from 'lucide-react'

    Channel x Category Matrix Layout:
    - Table/grid with:
      - Column headers: Dashboard (Bell icon), Email (Mail icon), SMS (Smartphone icon)
      - Row groups by category (from NOTIFICATION_CATEGORIES):
        - Events: "New events", "Event cancellations"
        - Quotes: "Quote received", "Quote awarded/rejected"
        - Payments: "Payment confirmations", "Payment failures"
        - Ratings: "New ratings", "Rating reminders"
        - Messages: "New messages"
        - Disputes: "Dispute updates"
      - Dashboard column: All switches are ON and disabled (greyed out) with tooltip "Dashboard notifications cannot be disabled"
      - Email column: Toggle switches for each category, mapping to email_* preferences
      - SMS column: Toggle switches for applicable categories (events, quotes, awards, payments only — no SMS for ratings/messages/disputes per schema)
        - SMS switches disabled if sms_phone_number is not set (with helper text "Add phone number to enable SMS")

    SMS Opt-In Section (below the matrix):
    - Card with title "SMS Notifications"
    - Description: "SMS alerts are opt-in only. You'll only receive SMS for urgent or time-sensitive notifications."
    - Phone number input with label "UK Mobile Number" and placeholder "+447xxxxxxxxx"
    - Validation: real-time regex check for +447 followed by 9 digits, show error if invalid
    - Explicit opt-in checkbox: "I consent to receiving SMS notifications from SiteMedic"
      - When checked AND phone number is valid, SMS toggle switches become enabled
      - When unchecked, all SMS toggles set to false and disabled

    Event Alert Radius Section (below SMS):
    - Card with title "Event Alert Radius"
    - Description: "Set a maximum distance for event alerts. Leave empty to see all UK events."
    - Input with type="number", min=1, max=500, step=1
    - Label: "Radius (miles)"
    - Helper text: "Events beyond this radius won't trigger email or SMS alerts. Dashboard notifications show all events."

    Save button:
    - Calls PUT /api/marketplace/notification-preferences with the full preferences object
    - Show toast on success: "Notification preferences saved"
    - Show toast on error: "Failed to save preferences"
    - Disabled while saving (loading state)

    On mount:
    - Fetch GET /api/marketplace/notification-preferences
    - Populate all form fields from response
    - Show loading skeleton while fetching

    Create web/app/(dashboard)/dashboard/marketplace/settings/notifications/page.tsx:
    - Page title: "Notification Preferences"
    - Breadcrumb or back link: "Marketplace Settings > Notification Preferences"
    - Render NotificationPreferencesForm as the main content
    - Include description text: "Choose how you want to be notified about marketplace activity. Dashboard notifications are always on."
  </action>
  <verify>
    - NotificationPreferencesForm.tsx exists and is a 'use client' component
    - Notifications page exists at the correct path
    - grep for "Switch" in NotificationPreferencesForm.tsx (toggle switches used)
    - grep for "Dashboard" or "Bell" in NotificationPreferencesForm.tsx (dashboard column exists)
    - grep for "consent" or "opt-in" in NotificationPreferencesForm.tsx (PECR opt-in checkbox exists)
    - grep for "+447" in NotificationPreferencesForm.tsx (phone validation)
    - grep for "event_alert_radius_miles" in NotificationPreferencesForm.tsx (radius input exists)
    - grep for "notification-preferences" in NotificationPreferencesForm.tsx (API calls wired)
  </verify>
  <done>
    Channel x category matrix UI renders with Dashboard/Email/SMS columns.
    Dashboard column is always on (greyed out, non-toggleable).
    Email toggles default to on, SMS toggles default to off.
    SMS requires explicit opt-in with phone number and consent checkbox (PECR compliant).
    Event alert radius is configurable (NULL = all UK).
    Preferences save successfully via PUT API and show toast confirmation.
  </done>
</task>

</tasks>

<verification>
- Preferences page loads at /dashboard/marketplace/settings/notifications
- Channel x category matrix displays correctly with Dashboard/Email/SMS columns
- Dashboard column switches are visually on but disabled
- Email toggles work and save correctly
- SMS toggles are disabled until phone number entered and consent checkbox checked
- Phone number validates E.164 format (+447xxxxxxxxx)
- Event alert radius accepts integer values 1-500 or empty (null)
- First-time users see sensible defaults (email on, SMS off)
- Save shows success toast, errors show error toast
</verification>

<success_criteria>
- Preferences API auto-creates defaults for first-time users
- Matrix UI matches GitHub/Slack notification settings pattern
- SMS opt-in is explicit (checkbox + phone number) with PECR audit trail
- All preferences persist across page refreshes
- Preferences are consumed by event fan-out (Plan 03) for channel selection
</success_criteria>

<output>
After completion, create `.planning/phases/38-notifications-alerts/38-04-SUMMARY.md`
</output>
