---
phase: 38-notifications-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/159_user_notifications.sql
  - supabase/migrations/160_marketplace_notification_preferences.sql
  - web/lib/marketplace/sms.ts
  - web/lib/marketplace/notification-types.ts
  - web/lib/marketplace/create-notification.ts
  - web/.env.example
autonomous: true
user_setup:
  - service: twilio
    why: "SMS delivery for urgent/high-value event alerts"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers -> Buy a Number (UK +44)"
    dashboard_config:
      - task: "Purchase a UK phone number"
        location: "Twilio Console -> Phone Numbers -> Buy a Number"

must_haves:
  truths:
    - "user_notifications table exists with user_id-scoped RLS and Realtime enabled"
    - "marketplace_notification_preferences table exists with SMS opt-in defaults (all FALSE)"
    - "sendSMS utility gracefully falls back to console.log when Twilio env vars are missing"
    - "createNotification utility writes to user_notifications in fire-and-forget pattern"
    - "Notification types are defined as a shared TypeScript enum/constant for consistency"
  artifacts:
    - path: "supabase/migrations/159_user_notifications.sql"
      provides: "user_notifications table with RLS + Realtime publication"
      contains: "CREATE TABLE user_notifications"
    - path: "supabase/migrations/160_marketplace_notification_preferences.sql"
      provides: "marketplace_notification_preferences table with PECR-compliant SMS defaults"
      contains: "CREATE TABLE marketplace_notification_preferences"
    - path: "web/lib/marketplace/sms.ts"
      provides: "Twilio SMS wrapper with dev-mode fallback"
      exports: ["sendSMS"]
    - path: "web/lib/marketplace/notification-types.ts"
      provides: "Shared notification type constants and TypeScript interfaces"
      exports: ["NotificationType", "NotificationCategory"]
    - path: "web/lib/marketplace/create-notification.ts"
      provides: "Fire-and-forget notification creator for API routes"
      exports: ["createNotification"]
  key_links:
    - from: "web/lib/marketplace/create-notification.ts"
      to: "user_notifications"
      via: "Supabase service-role INSERT"
      pattern: "supabase\\.from\\('user_notifications'\\)\\.insert"
    - from: "web/lib/marketplace/sms.ts"
      to: "Twilio API"
      via: "client.messages.create"
      pattern: "client\\.messages\\.create"
---

<objective>
Create the database foundation and utility modules for Phase 38's notification system.

Purpose: All other notification plans depend on these tables and utilities existing. The user_notifications table powers the dashboard feed (Plan 02), the marketplace_notification_preferences table powers the preferences UI (Plan 04), and the SMS/create-notification utilities are called by the trigger-wiring plan (Plan 03).

Output: Two SQL migrations, three TypeScript utility modules, updated .env.example with Twilio vars.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-notifications-alerts/38-RESEARCH.md

# Existing patterns to follow
@web/lib/marketplace/notifications.ts — fire-and-forget email pattern and Resend usage
@web/lib/email/resend.ts — shared Resend client with dev-mode fallback
@web/lib/queries/comms.hooks.ts — Realtime subscription pattern (useRealtimeMessages)
@supabase/migrations/153_marketplace_messaging.sql — user_id-scoped marketplace table with RLS
@supabase/migrations/157_message_polish.sql — REPLICA IDENTITY FULL for Realtime UPDATE events
@web/.env.example — existing env vars documentation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migrations for notifications and preferences</name>
  <files>
    supabase/migrations/159_user_notifications.sql
    supabase/migrations/160_marketplace_notification_preferences.sql
  </files>
  <action>
    Create migration 159_user_notifications.sql:
    - CREATE TABLE user_notifications with columns:
      - id UUID PK DEFAULT gen_random_uuid()
      - user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
      - type TEXT NOT NULL with CHECK constraint for: 'new_event', 'quote_received', 'quote_awarded', 'quote_rejected', 'payment_received', 'payment_failed', 'rating_received', 'message_received', 'dispute_filed', 'dispute_resolved', 'event_cancelled', 'rating_nudge'
      - title TEXT NOT NULL
      - body TEXT NOT NULL
      - link TEXT (nullable — deep link into the app)
      - metadata JSONB DEFAULT '{}'::jsonb
      - is_read BOOLEAN NOT NULL DEFAULT FALSE
      - read_at TIMESTAMPTZ
      - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    - Indexes:
      - idx_user_notifications_user_id_created ON (user_id, created_at DESC)
      - idx_user_notifications_unread ON (user_id, is_read) WHERE is_read = FALSE
    - RLS policies:
      - user_sees_own_notifications: SELECT WHERE user_id = auth.uid()
      - user_updates_own_notifications: UPDATE WHERE user_id = auth.uid()
      - service_role_insert_notifications: INSERT WITH CHECK (true) — service role writes from API routes
    - Enable Supabase Realtime: ALTER PUBLICATION supabase_realtime ADD TABLE user_notifications
    - Add REPLICA IDENTITY FULL for Realtime UPDATE events (needed for mark-as-read live updates)

    Create migration 160_marketplace_notification_preferences.sql:
    - CREATE TABLE marketplace_notification_preferences with columns:
      - user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE
      - Email preference booleans (all DEFAULT TRUE): email_new_events, email_quotes, email_awards, email_payments, email_ratings, email_messages, email_disputes
      - SMS preference booleans (all DEFAULT FALSE for PECR compliance): sms_new_events, sms_quotes, sms_awards, sms_payments
      - event_alert_radius_miles INT (nullable — NULL = all UK, no radius filtering)
      - sms_phone_number TEXT (nullable — E.164 format, separate from company_phone)
      - sms_opted_in_at TIMESTAMPTZ (nullable — PECR audit trail)
      - updated_at TIMESTAMPTZ DEFAULT NOW()
    - RLS policy: user_manages_own_prefs FOR ALL USING (user_id = auth.uid())

    IMPORTANT: Do NOT modify the database directly. Only create the migration SQL files. The user applies migrations separately.
  </action>
  <verify>
    - Both migration files exist and have valid SQL syntax
    - grep for "ALTER PUBLICATION supabase_realtime" in 159 file
    - grep for "REPLICA IDENTITY FULL" in 159 file
    - grep for "DEFAULT FALSE" for all sms_ columns in 160 file
    - grep for "sms_opted_in_at" in 160 file (PECR audit trail)
  </verify>
  <done>
    Migration 159 creates user_notifications with user_id RLS, Realtime enabled, and REPLICA IDENTITY FULL.
    Migration 160 creates marketplace_notification_preferences with SMS defaults all FALSE (PECR compliant).
  </done>
</task>

<task type="auto">
  <name>Task 2: Twilio SMS module, notification types, and create-notification utility</name>
  <files>
    web/lib/marketplace/sms.ts
    web/lib/marketplace/notification-types.ts
    web/lib/marketplace/create-notification.ts
    web/.env.example
  </files>
  <action>
    Create web/lib/marketplace/sms.ts:
    - Import twilio from 'twilio' (pnpm add twilio first)
    - Read TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, TWILIO_PHONE_NUMBER from process.env
    - If env vars missing, set client to null (graceful fallback)
    - Export async function sendSMS({ to: string, body: string }): Promise<{ success: boolean; sid?: string; error?: string }>
    - If client is null or fromNumber is missing, console.log with [SMS DEV MODE] prefix and return { success: true, sid: 'dev-mode-mock-sid' }
    - Otherwise call client.messages.create({ body, from: fromNumber, to }) — wrap in try/catch
    - Log success with [SMS] prefix, return { success: true, sid: message.sid }
    - On error, console.error with [SMS] prefix, return { success: false, error: message }
    - Follow the EXACT same fire-and-forget pattern as web/lib/email/resend.ts

    Create web/lib/marketplace/notification-types.ts:
    - Export const NOTIFICATION_TYPES as const object mapping type keys to their string values (matching the CHECK constraint in migration 159)
    - Export type NotificationType = typeof NOTIFICATION_TYPES[keyof typeof NOTIFICATION_TYPES]
    - Export const NOTIFICATION_CATEGORIES grouping types into categories for the preferences UI:
      - 'events': ['new_event', 'event_cancelled']
      - 'quotes': ['quote_received', 'quote_awarded', 'quote_rejected']
      - 'payments': ['payment_received', 'payment_failed']
      - 'ratings': ['rating_received', 'rating_nudge']
      - 'messages': ['message_received']
      - 'disputes': ['dispute_filed', 'dispute_resolved']
    - Export type NotificationCategory = keyof typeof NOTIFICATION_CATEGORIES
    - Export interface UserNotification matching the user_notifications table schema (id, user_id, type, title, body, link, metadata, is_read, read_at, created_at)
    - Export interface NotificationPreferences matching marketplace_notification_preferences table

    Create web/lib/marketplace/create-notification.ts:
    - IMPORTANT: Use the SERVICE-ROLE client pattern (same as web/lib/email/send-welcome.ts), NOT the anon-key cookie-scoped client from '@/lib/supabase/server'. The RLS policy 'service_role_insert_notifications' only grants INSERT to service-role. The fan-out in Plan 03 inserts rows for OTHER users (not the calling user), which the anon-key client would be denied by RLS.
    - Import { createClient } from '@supabase/supabase-js'
    - Create a service-role Supabase client inside the function:
      ```
      const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
      const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
      if (!supabaseUrl || !serviceKey) {
        console.error('[Notifications] Supabase service role env vars not configured');
        return;
      }
      const supabase = createClient(supabaseUrl, serviceKey, {
        auth: { autoRefreshToken: false, persistSession: false },
      });
      ```
    - Export interface CreateNotificationParams { userId: string; type: NotificationType; title: string; body: string; link?: string; metadata?: Record<string, unknown> }
    - Export async function createNotification(params: CreateNotificationParams): Promise<void>
    - Inside: try/catch wrapping supabase.from('user_notifications').insert({ user_id, type, title, body, link: link ?? null, metadata: metadata ?? {} })
    - On error: console.error with [Notifications] prefix — NEVER throw (fire-and-forget)
    - Export async function createBulkNotifications(notifications: CreateNotificationParams[]): Promise<void>
    - Inside: try/catch wrapping supabase.from('user_notifications').insert(mapped array)
    - On error: console.error with [Notifications] prefix — NEVER throw

    Update web/.env.example:
    - Add Twilio env vars section:
      # Twilio SMS (Phase 38: Notifications & Alerts)
      TWILIO_ACCOUNT_SID=
      TWILIO_AUTH_TOKEN=
      TWILIO_PHONE_NUMBER=

    Install twilio package:
    - Run: pnpm add twilio (in web/ directory)
  </action>
  <verify>
    - pnpm add twilio completes without error
    - web/lib/marketplace/sms.ts exports sendSMS function
    - web/lib/marketplace/notification-types.ts exports NOTIFICATION_TYPES, NOTIFICATION_CATEGORIES, UserNotification, NotificationPreferences
    - web/lib/marketplace/create-notification.ts exports createNotification, createBulkNotifications
    - grep for "SUPABASE_SERVICE_ROLE_KEY" in create-notification.ts (service-role client, NOT anon-key)
    - grep for "dev-mode-mock-sid" in sms.ts (dev fallback exists)
    - grep for "TWILIO" in web/.env.example
    - npx tsc --noEmit in web/ directory passes (or at least no errors in new files)
  </verify>
  <done>
    sendSMS works with dev-mode fallback when Twilio env vars are missing.
    createNotification writes to user_notifications table in fire-and-forget pattern.
    All notification types are defined as a shared constant with TypeScript type safety.
    Twilio env vars documented in .env.example.
  </done>
</task>

</tasks>

<verification>
- Migration 159 creates user_notifications with all required columns, indexes, RLS, Realtime, and REPLICA IDENTITY FULL
- Migration 160 creates marketplace_notification_preferences with SMS defaults all FALSE
- sendSMS has dev-mode fallback (console.log when no TWILIO_* env vars)
- createNotification is fire-and-forget (never throws, always catches errors)
- NOTIFICATION_TYPES matches the CHECK constraint in migration 159
- twilio package installed in web/package.json
</verification>

<success_criteria>
- Both migration files exist with valid SQL
- Three TypeScript utility modules exist and compile without errors
- Twilio env vars added to .env.example
- Dev-mode SMS fallback works without Twilio credentials
</success_criteria>

<output>
After completion, create `.planning/phases/38-notifications-alerts/38-01-SUMMARY.md`
</output>
