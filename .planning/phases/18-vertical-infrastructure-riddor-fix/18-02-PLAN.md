---
phase: 18-vertical-infrastructure-riddor-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/riddor-detector/index.ts
  - supabase/functions/riddor-f2508-generator/index.ts
  - supabase/functions/event-incident-report-generator/index.ts
  - supabase/functions/event-incident-report-generator/types.ts
  - supabase/functions/motorsport-incident-generator/index.ts
  - supabase/functions/motorsport-incident-generator/types.ts
  - supabase/functions/fa-incident-generator/index.ts
  - supabase/functions/fa-incident-generator/types.ts
  - web/lib/pdf/incident-report-dispatcher.ts
autonomous: true

must_haves:
  truths:
    - "A treatment for a festivals, motorsport, sporting_events, fairs_shows, or private_events org returns detected: false from the RIDDOR detector without creating a riddor_incidents row"
    - "Calling the F2508 generator for a treatment whose event_vertical is a non-RIDDOR vertical returns HTTP 400"
    - "Three new Edge Function directories exist: event-incident-report-generator, motorsport-incident-generator, fa-incident-generator — each with index.ts and types.ts"
    - "web/lib/pdf/incident-report-dispatcher.ts exists and routes to the correct function name based on vertical"
  artifacts:
    - path: "supabase/functions/riddor-detector/index.ts"
      provides: "Vertical gate — early return for non-RIDDOR verticals"
      contains: "NON_RIDDOR_VERTICALS"
    - path: "supabase/functions/riddor-f2508-generator/index.ts"
      provides: "F2508 vertical validation returning 400 for non-RIDDOR verticals"
      contains: "NON_RIDDOR_VERTICALS"
    - path: "supabase/functions/event-incident-report-generator/index.ts"
      provides: "Stub Edge Function for festival/event incidents"
      contains: "Deno.serve"
    - path: "supabase/functions/motorsport-incident-generator/index.ts"
      provides: "Stub Edge Function for motorsport incidents"
      contains: "Deno.serve"
    - path: "supabase/functions/fa-incident-generator/index.ts"
      provides: "Stub Edge Function for sporting events (FA framework)"
      contains: "Deno.serve"
    - path: "web/lib/pdf/incident-report-dispatcher.ts"
      provides: "Dispatcher routing vertical to correct Edge Function"
      contains: "generateIncidentReportPDF"
  key_links:
    - from: "supabase/functions/riddor-detector/index.ts"
      to: "supabase/functions/riddor-detector/detection-rules.ts"
      via: "vertical gate placed BEFORE detectRIDDOR() call on line 75"
      pattern: "NON_RIDDOR_VERTICALS.*includes"
    - from: "web/lib/pdf/incident-report-dispatcher.ts"
      to: "supabase/functions/event-incident-report-generator"
      via: "supabase.functions.invoke('event-incident-report-generator')"
      pattern: "functions\\.invoke"
---

<objective>
Gate the RIDDOR detector and F2508 generator so they return early for non-RIDDOR verticals. Scaffold three new vertical-specific Edge Functions. Create the incident-report-dispatcher routing utility.

Purpose: This is the highest regulatory risk in Phase 18. The RIDDOR trigger (migration 033) fires on every treatment INSERT where injury_type IS NOT NULL — it currently runs for festivals and motorsport orgs, creating false RIDDOR incidents that would require HSE notification. This fix is purely additive: a vertical check inserted before the existing detectRIDDOR() call. No existing logic is removed or altered.

Output: Updated riddor-detector/index.ts (vertical gate), updated riddor-f2508-generator/index.ts (vertical validation), three new Edge Function scaffold directories, web/lib/pdf/incident-report-dispatcher.ts.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-vertical-infrastructure-riddor-fix/18-RESEARCH.md
@supabase/functions/riddor-detector/index.ts
@supabase/functions/riddor-f2508-generator/index.ts
@services/taxonomy/vertical-compliance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Insert vertical gate into riddor-detector and add F2508 vertical validation</name>
  <files>supabase/functions/riddor-detector/index.ts, supabase/functions/riddor-f2508-generator/index.ts</files>
  <action>
    In `supabase/functions/riddor-detector/index.ts`:

    The current file uses `serve` from deno.land/std (line 14). Insert the vertical gate AFTER the treatment fetch (lines 61-72) and BEFORE the `detectRIDDOR()` call (line 75). Exact insertion point: after the closing brace of the `if (fetchError || !treatment)` block (line 72), before the comment `// Run RIDDOR detection algorithm` (line 74).

    Insert this block:

    ```typescript
    // Vertical gate — RIDDOR only applies to specific workplace verticals.
    // Non-RIDDOR verticals: festivals, motorsport, sporting_events, fairs_shows, private_events.
    // Source: services/taxonomy/vertical-compliance.ts (riddorApplies: false)
    // NOTE: Cannot import from services/ in Deno — use hardcoded constant.
    const NON_RIDDOR_VERTICALS = ['festivals', 'motorsport', 'sporting_events', 'fairs_shows', 'private_events'];

    // Resolve effective vertical: prefer booking-level event_vertical on treatment,
    // fall back to org primary vertical from org_settings.
    let effectiveVertical: string | null = treatment.event_vertical ?? null;

    if (!effectiveVertical) {
      const { data: orgSettings } = await supabase
        .from('org_settings')
        .select('industry_verticals')
        .eq('org_id', treatment.org_id)
        .single();
      effectiveVertical = orgSettings?.industry_verticals?.[0] ?? 'general';
    }

    if (NON_RIDDOR_VERTICALS.includes(effectiveVertical)) {
      return new Response(
        JSON.stringify({
          detected: false,
          category: null,
          reason: `RIDDOR does not apply to vertical: ${effectiveVertical}`,
        }),
        { headers: { 'Content-Type': 'application/json', ...corsHeaders } }
      );
    }
    // End vertical gate — proceed with RIDDOR detection below.
    ```

    Do NOT modify anything else in this file. The `detectRIDDOR()` call, confidence scoring, incident creation, and error handling are untouched.

    ---

    In `supabase/functions/riddor-f2508-generator/index.ts`:

    Read the file first to confirm line positions. The file uses `Deno.serve` (line 27). After the treatment/incident fetch (wherever the treatment record is loaded), add this validation block before the call to `mapTreatmentToF2508`:

    ```typescript
    // Validate vertical — F2508 only applies to RIDDOR verticals.
    const NON_RIDDOR_VERTICALS = ['festivals', 'motorsport', 'sporting_events', 'fairs_shows', 'private_events'];
    if (treatment.event_vertical && NON_RIDDOR_VERTICALS.includes(treatment.event_vertical)) {
      return new Response(
        JSON.stringify({ error: `F2508 does not apply to vertical: ${treatment.event_vertical}` }),
        { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
      );
    }
    ```

    Read the complete file first to find exactly where the treatment is fetched and where `mapTreatmentToF2508` is called, then insert the validation between them.
  </action>
  <verify>
    `grep -n "NON_RIDDOR_VERTICALS" supabase/functions/riddor-detector/index.ts` — expect 1 match.
    `grep -n "NON_RIDDOR_VERTICALS" supabase/functions/riddor-f2508-generator/index.ts` — expect 1 match.
    `grep -n "effectiveVertical" supabase/functions/riddor-detector/index.ts` — expect multiple matches (declaration + if-check + org_settings fetch + includes check).
    `grep -c "detectRIDDOR" supabase/functions/riddor-detector/index.ts` — must still be 1 (unchanged call).
  </verify>
  <done>riddor-detector has the vertical gate before detectRIDDOR(); gate returns detected:false for non-RIDDOR verticals. F2508 generator returns 400 if treatment.event_vertical is non-RIDDOR. All existing logic is preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold three new vertical Edge Functions and create incident-report-dispatcher</name>
  <files>
    supabase/functions/event-incident-report-generator/index.ts,
    supabase/functions/event-incident-report-generator/types.ts,
    supabase/functions/motorsport-incident-generator/index.ts,
    supabase/functions/motorsport-incident-generator/types.ts,
    supabase/functions/fa-incident-generator/index.ts,
    supabase/functions/fa-incident-generator/types.ts,
    web/lib/pdf/incident-report-dispatcher.ts
  </files>
  <action>
    Create three new Edge Function scaffolds. Each follows the exact pattern of `supabase/functions/riddor-f2508-generator/` (Deno.serve, npm: imports, corsHeaders). Phase 18 scope is stubs only — full PDF components are Phase 19+.

    Create `supabase/functions/event-incident-report-generator/types.ts`:
    ```typescript
    // Types for Event Incident Report generator
    // Covers verticals: festivals, fairs_shows, private_events (Purple Guide framework)

    export interface EventIncidentData {
      incident_id: string;
      org_id: string;
      event_name?: string;
      event_vertical: string;
      incident_date: string;
      patient_name?: string;
      description?: string;
      outcome?: string;
    }
    ```

    Create `supabase/functions/event-incident-report-generator/index.ts`:
    ```typescript
    /**
     * Event Incident Report Generator — Edge Function
     * Phase 18: Scaffold (Phase 19 adds full PDF output)
     *
     * Covers: festivals, fairs_shows, private_events (Purple Guide framework)
     * Returns: 501 Not Implemented until Phase 19 completes PDF component.
     */

    import { createClient } from 'npm:@supabase/supabase-js@2';
    import type { EventIncidentData } from './types.ts';

    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    };

    const APPLICABLE_VERTICALS = ['festivals', 'fairs_shows', 'private_events'];

    Deno.serve(async (req: Request) => {
      if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders });
      }

      try {
        const body = await req.json();

        if (!body.incident_id) {
          return new Response(
            JSON.stringify({ error: 'incident_id is required' }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        // Validate vertical applicability (guard against mis-routing)
        if (body.event_vertical && !APPLICABLE_VERTICALS.includes(body.event_vertical)) {
          return new Response(
            JSON.stringify({ error: `Vertical ${body.event_vertical} is not handled by this generator` }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        // Phase 19+ will implement full Purple Guide PDF generation here.
        return new Response(
          JSON.stringify({ error: 'Event incident PDF generation not yet implemented (Phase 19)' }),
          { status: 501, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        );
      } catch (error) {
        return new Response(
          JSON.stringify({ error: error.message }),
          { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        );
      }
    });
    ```

    Create `supabase/functions/motorsport-incident-generator/types.ts`:
    ```typescript
    // Types for Motorsport Incident Report generator
    // Covers vertical: motorsport (Motorsport UK framework)

    export interface MotorsportIncidentData {
      incident_id: string;
      org_id: string;
      event_vertical: 'motorsport';
      incident_date: string;
      patient_name?: string;
      vehicle_type?: string;
      circuit_location?: string;
      description?: string;
      outcome?: string;
    }
    ```

    Create `supabase/functions/motorsport-incident-generator/index.ts`:
    ```typescript
    /**
     * Motorsport Incident Report Generator — Edge Function
     * Phase 18: Scaffold (Phase 19 adds full PDF output)
     *
     * Covers: motorsport (Motorsport UK framework)
     */

    import { createClient } from 'npm:@supabase/supabase-js@2';
    import type { MotorsportIncidentData } from './types.ts';

    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    };

    Deno.serve(async (req: Request) => {
      if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders });
      }

      try {
        const body = await req.json();

        if (!body.incident_id) {
          return new Response(
            JSON.stringify({ error: 'incident_id is required' }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        if (body.event_vertical && body.event_vertical !== 'motorsport') {
          return new Response(
            JSON.stringify({ error: `Vertical ${body.event_vertical} is not handled by this generator` }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        // Phase 19+ will implement full Motorsport UK PDF generation here.
        return new Response(
          JSON.stringify({ error: 'Motorsport incident PDF generation not yet implemented (Phase 19)' }),
          { status: 501, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        );
      } catch (error) {
        return new Response(
          JSON.stringify({ error: error.message }),
          { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        );
      }
    });
    ```

    Create `supabase/functions/fa-incident-generator/types.ts`:
    ```typescript
    // Types for FA Incident Report generator
    // Covers vertical: sporting_events (FA incident framework)

    export interface FAIncidentData {
      incident_id: string;
      org_id: string;
      event_vertical: 'sporting_events';
      incident_date: string;
      patient_name?: string;
      sport_type?: string;
      description?: string;
      outcome?: string;
    }
    ```

    Create `supabase/functions/fa-incident-generator/index.ts`:
    ```typescript
    /**
     * FA Incident Report Generator — Edge Function
     * Phase 18: Scaffold (Phase 19 adds full PDF output)
     *
     * Covers: sporting_events (FA incident framework)
     */

    import { createClient } from 'npm:@supabase/supabase-js@2';
    import type { FAIncidentData } from './types.ts';

    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    };

    Deno.serve(async (req: Request) => {
      if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders });
      }

      try {
        const body = await req.json();

        if (!body.incident_id) {
          return new Response(
            JSON.stringify({ error: 'incident_id is required' }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        if (body.event_vertical && body.event_vertical !== 'sporting_events') {
          return new Response(
            JSON.stringify({ error: `Vertical ${body.event_vertical} is not handled by this generator` }),
            { status: 400, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
          );
        }

        // Phase 19+ will implement full FA incident PDF generation here.
        return new Response(
          JSON.stringify({ error: 'FA incident PDF generation not yet implemented (Phase 19)' }),
          { status: 501, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        );
      } catch (error) {
        return new Response(
          JSON.stringify({ error: error.message }),
          { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
        );
      }
    });
    ```

    Create directory `web/lib/pdf/` then create `web/lib/pdf/incident-report-dispatcher.ts`:
    ```typescript
    /**
     * Incident Report Dispatcher
     * Phase 18: Routes to the correct PDF generator Edge Function based on vertical.
     *
     * Vertical → framework → Edge Function mapping (from services/taxonomy/vertical-compliance.ts):
     *   construction, tv_film, corporate, education, outdoor_adventure → RIDDOR → riddor-f2508-generator
     *   festivals, fairs_shows, private_events → purple_guide/event_incident → event-incident-report-generator
     *   motorsport → motorsport_uk → motorsport-incident-generator
     *   sporting_events → fa_incident → fa-incident-generator
     */

    import { createClient } from '@/lib/supabase/client';

    // Maps primary compliance framework to the Edge Function that generates that framework's PDF.
    // Must stay in sync with services/taxonomy/vertical-compliance.ts primaryFramework values.
    const FUNCTION_BY_VERTICAL: Record<string, string> = {
      construction:      'riddor-f2508-generator',
      tv_film:           'riddor-f2508-generator',
      corporate:         'riddor-f2508-generator',
      education:         'riddor-f2508-generator',
      outdoor_adventure: 'riddor-f2508-generator',
      festivals:         'event-incident-report-generator',
      fairs_shows:       'event-incident-report-generator',
      private_events:    'event-incident-report-generator',
      motorsport:        'motorsport-incident-generator',
      sporting_events:   'fa-incident-generator',
    };

    export interface DispatchResult {
      signedUrl?: string;
      error?: string;
    }

    /**
     * Generate an incident report PDF for the given incident and vertical.
     * Routes to the appropriate Edge Function based on the effective vertical.
     *
     * @param incidentId - UUID of the RIDDOR incident or treatment record
     * @param vertical - The effective vertical (booking-level or org default)
     * @returns signed URL for the generated PDF, or throws on error
     */
    export async function generateIncidentReportPDF(
      incidentId: string,
      vertical: string
    ): Promise<DispatchResult> {
      const functionName = FUNCTION_BY_VERTICAL[vertical];

      if (!functionName) {
        return { error: `No PDF generator configured for vertical: ${vertical}` };
      }

      const supabase = createClient();
      const { data, error } = await supabase.functions.invoke(functionName, {
        body: {
          incident_id: incidentId,
          event_vertical: vertical,
        },
      });

      if (error) {
        return { error: error.message };
      }

      return data as DispatchResult;
    }
    ```

    Note: `web/lib/pdf/` directory does not yet exist — create it by creating the file at that path. The `createClient` import path `@/lib/supabase/client` matches the pattern used throughout the web app (confirmed in web/contexts/org-context.tsx).
  </action>
  <verify>
    `ls supabase/functions/event-incident-report-generator/` — shows index.ts and types.ts.
    `ls supabase/functions/motorsport-incident-generator/` — shows index.ts and types.ts.
    `ls supabase/functions/fa-incident-generator/` — shows index.ts and types.ts.
    `ls web/lib/pdf/incident-report-dispatcher.ts` — file exists.
    `grep -n "Deno.serve" supabase/functions/event-incident-report-generator/index.ts` — 1 match.
    `grep "generateIncidentReportPDF" web/lib/pdf/incident-report-dispatcher.ts` — 1 match.
    `pnpm tsc --noEmit` — zero TypeScript errors (dispatcher uses valid imports).
  </verify>
  <done>Three new Edge Function scaffolds exist with correct Deno.serve structure, vertical validation, and 501 stubs. web/lib/pdf/incident-report-dispatcher.ts exports generateIncidentReportPDF() with correct routing table. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Detector gate: `grep -c "NON_RIDDOR_VERTICALS" supabase/functions/riddor-detector/index.ts` → 1
2. F2508 gate: `grep -c "NON_RIDDOR_VERTICALS" supabase/functions/riddor-f2508-generator/index.ts` → 1
3. Existing detectRIDDOR call preserved: `grep -c "detectRIDDOR" supabase/functions/riddor-detector/index.ts` → 1
4. Edge functions: `ls supabase/functions/ | grep -E "(event-incident|motorsport-incident|fa-incident)"` → 3 matches
5. Dispatcher: `cat web/lib/pdf/incident-report-dispatcher.ts | grep "generateIncidentReportPDF"` → exported function exists
6. TypeScript: `pnpm tsc --noEmit` → zero errors
</verification>

<success_criteria>
- riddor-detector returns `{ detected: false }` for treatments from festivals/motorsport/sporting_events/fairs_shows/private_events orgs, without creating a riddor_incidents row
- F2508 generator returns HTTP 400 if treatment.event_vertical is in the non-RIDDOR list
- Three scaffold Edge Function directories exist with Deno.serve stubs and vertical validation
- incident-report-dispatcher.ts routes all 10 verticals to correct function names
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/18-vertical-infrastructure-riddor-fix/18-02-SUMMARY.md`
</output>
