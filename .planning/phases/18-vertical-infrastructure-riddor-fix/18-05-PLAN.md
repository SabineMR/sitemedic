---
phase: 18-vertical-infrastructure-riddor-fix
plan: 05
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - web/app/api/bookings/create/route.ts
  - web/app/api/bookings/create-payment-intent/route.ts
autonomous: true

must_haves:
  truths:
    - "When a client completes a booking with an event type selected, the booking's event_vertical column in Supabase is set to that value"
    - "The BookingRequest interface accepts an optional eventVertical field"
    - "The admin org settings vertical selector already works end-to-end — no code changes needed for VERT-05"
  artifacts:
    - path: "web/app/api/bookings/create/route.ts"
      provides: "Net-30 booking creation API with event_vertical persistence"
      contains: "eventVertical"
    - path: "web/app/api/bookings/create-payment-intent/route.ts"
      provides: "Prepay booking creation API with event_vertical persistence"
      contains: "eventVertical"
  key_links:
    - from: "web/components/booking/shift-config.tsx"
      to: "web/app/api/bookings/create/route.ts"
      via: "eventVertical in BookingRequest body → event_vertical in Supabase insert"
      pattern: "eventVertical.*body\\.eventVertical"
    - from: "web/components/booking/shift-config.tsx"
      to: "web/app/api/bookings/create-payment-intent/route.ts"
      via: "eventVertical in BookingRequest body → event_vertical in Supabase insert"
      pattern: "eventVertical.*body\\.eventVertical"
---

<objective>
Fix the one gap preventing VERT-06 (client booking vertical) from being complete: add eventVertical to the BookingRequest interface and wire it into the Supabase insert in BOTH booking creation API routes (Net-30 and prepay).

Purpose: The booking form UI already captures eventVertical in ShiftConfig (confirmed in research — web/components/booking/shift-config.tsx lines 90, 94-101). The payment flow carries it through sessionStorage. The gap is purely at the API layer: both BookingRequest interfaces have no eventVertical field and both Supabase inserts omit event_vertical. The bookings.event_vertical column already exists (migration 123_booking_briefs.sql). This plan closes the gap with targeted two-line changes in each file.

Note on VERT-05: The admin vertical selector (web/app/admin/settings/page.tsx) is ALREADY COMPLETE — toggleVertical() and handleSaveVerticals() are fully implemented. No code changes are required for VERT-05. This plan verifies it works but does not rebuild it.

Output: Updated web/app/api/bookings/create/route.ts and web/app/api/bookings/create-payment-intent/route.ts — both with eventVertical in BookingRequest and Supabase insert.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-vertical-infrastructure-riddor-fix/18-RESEARCH.md
@web/app/api/bookings/create/route.ts
@web/app/api/bookings/create-payment-intent/route.ts
@web/components/booking/shift-config.tsx
@supabase/migrations/123_booking_briefs.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add eventVertical to BookingRequest and wire it into the Supabase insert in both booking creation routes</name>
  <files>web/app/api/bookings/create/route.ts, web/app/api/bookings/create-payment-intent/route.ts</files>
  <action>
    Read both files in full before making any changes.

    ---

    **File 1: `web/app/api/bookings/create/route.ts` (Net-30 path)**

    Make two targeted changes:

    **Change 1: Add eventVertical to the BookingRequest interface.**
    The interface currently ends at line 50 with `medicPayout: number;` inside the `pricing` object. Add `eventVertical` as an optional field at the top level of the interface, before the `pricing` object:

    ```typescript
    interface BookingRequest {
      shiftDate: string;
      shiftStartTime: string;
      shiftEndTime: string;
      shiftHours: number;
      siteName: string;
      siteAddress: string;
      sitePostcode: string;
      what3wordsAddress?: string;
      siteContactName: string;
      siteContactPhone: string;
      confinedSpaceRequired: boolean;
      traumaSpecialistRequired: boolean;
      specialNotes: string;
      isRecurring: boolean;
      recurrencePattern: 'weekly' | 'biweekly' | null;
      recurringWeeks: number;
      clientId: string;
      eventVertical?: string;  // ← ADD THIS LINE
      pricing: {
        baseRate: number;
        shiftHours: number;
        hourlyTotal: number;
        urgencyPremiumPercent: number;
        urgencyAmount: number;
        travelSurcharge: number;
        subtotal: number;
        vat: number;
        total: number;
        platformFee: number;
        medicPayout: number;
      };
    }
    ```

    **Change 2: Add event_vertical to the Supabase insert.**
    In the `.insert({...})` call (lines 129-158), add `event_vertical` after `medic_payout`:

    ```typescript
    medic_payout: body.pricing.medicPayout,
    event_vertical: body.eventVertical ?? null,  // ← ADD THIS LINE
    ```

    Do NOT modify any other logic — the credit limit check, urgency premium validation, email notification, and response shape are all unchanged.

    ---

    **File 2: `web/app/api/bookings/create-payment-intent/route.ts` (prepay path)**

    Read the full file to identify:
    - The local `BookingRequest` interface (it has its own copy — not shared with the Net-30 route)
    - The Supabase `.insert({...})` block

    Make two targeted changes matching the same pattern:

    **Change 1:** Add `eventVertical?: string;` as an optional top-level field in the local `BookingRequest` interface, before the `pricing` object.

    **Change 2:** Add `event_vertical: body.eventVertical ?? null,` to the Supabase `.insert({...})` block, after the last pricing-related field (`medic_payout` or equivalent).

    Do NOT modify any other logic — payment intent creation, Stripe calls, and all other existing behavior are untouched.

    ---

    The `bookings.event_vertical` column already exists (confirmed from migration 123_booking_briefs.sql — it has `event_vertical TEXT`). The value is optional on the client side so `?? null` is the correct default for both files.
  </action>
  <verify>
    `grep -n "eventVertical" web/app/api/bookings/create/route.ts` — expect 2 matches: interface field and insert line.
    `grep -n "event_vertical" web/app/api/bookings/create/route.ts` — expect 1 match (the Supabase insert line).
    `grep -n "eventVertical" web/app/api/bookings/create-payment-intent/route.ts` — expect 2 matches: interface field and insert line.
    `grep -n "event_vertical" web/app/api/bookings/create-payment-intent/route.ts` — expect 1 match (the Supabase insert line).
    `pnpm tsc --noEmit` from web directory or project root — zero TypeScript errors.
  </verify>
  <done>Both BookingRequest interfaces have eventVertical?: string. Both Supabase inserts include event_vertical: body.eventVertical ?? null. TypeScript compiles cleanly. A booking created via either path (Net-30 or prepay) with an eventVertical in the request body will now persist that value to bookings.event_vertical.</done>
</task>

<task type="checkpoint:verify">
  <name>Task 2: Verify admin vertical selector (VERT-05) and confirm booking form vertical UI (VERT-06)</name>
  <files></files>
  <action>
    This is a verification-only task. No code changes.

    **VERT-05 verification (admin vertical settings):**
    Read `web/app/admin/settings/page.tsx` and confirm:
    - `toggleVertical()` function exists and modifies the `selectedVerticals` array
    - `handleSaveVerticals()` function exists and PUTs to `/api/admin/settings`
    - A grid of vertical selector cards is rendered in the JSX

    If any of these are missing, note it in the summary — but based on research, all three are present at lines 162-197. No code changes expected.

    **VERT-06 verification (client booking form):**
    Read `web/components/booking/shift-config.tsx` and confirm:
    - `eventVertical` is captured from `formData.eventVertical`
    - A vertical `<select>` or equivalent UI element exists
    - `handleVerticalChange` (or equivalent) calls `onChange` with `eventVertical`

    Read `web/components/booking/booking-form.tsx` and confirm:
    - `formData.eventVertical` is initialized (from prefillData or org default)
    - The value is passed through to the API call or carried in sessionStorage to the payment step

    Document any gaps found in the summary. Based on research, the only gap was in the API (fixed by Task 1). If additional gaps are found in the form components, document them as items for the summary — do NOT make unplanned code changes.
  </action>
  <verify>
    `grep -n "toggleVertical" web/app/admin/settings/page.tsx` — expect at least 1 match.
    `grep -n "handleSaveVerticals" web/app/admin/settings/page.tsx` — expect at least 1 match.
    `grep -n "eventVertical" web/components/booking/shift-config.tsx` — expect at least 2 matches.
    `grep -n "eventVertical" web/components/booking/booking-form.tsx` — expect at least 1 match.
  </verify>
  <done>Admin vertical selector confirmed working (VERT-05 complete — no changes needed). Booking form vertical capture confirmed working end-to-end with API fix from Task 1 (VERT-06 complete). Any additional gaps documented in SUMMARY.md.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Net-30 API interface: `grep "eventVertical" web/app/api/bookings/create/route.ts` → 2 matches
2. Net-30 API insert: `grep "event_vertical" web/app/api/bookings/create/route.ts` → 1 match
3. Prepay API interface: `grep "eventVertical" web/app/api/bookings/create-payment-intent/route.ts` → 2 matches
4. Prepay API insert: `grep "event_vertical" web/app/api/bookings/create-payment-intent/route.ts` → 1 match
5. Admin vertical selector: `grep "toggleVertical" web/app/admin/settings/page.tsx` → 1+ matches
6. Booking form: `grep "eventVertical" web/components/booking/shift-config.tsx` → 2+ matches
7. TypeScript: `pnpm tsc --noEmit` → zero errors
</verification>

<success_criteria>
- web/app/api/bookings/create/route.ts BookingRequest interface has eventVertical?: string
- web/app/api/bookings/create/route.ts Supabase insert includes event_vertical: body.eventVertical ?? null
- web/app/api/bookings/create-payment-intent/route.ts BookingRequest interface has eventVertical?: string
- web/app/api/bookings/create-payment-intent/route.ts Supabase insert includes event_vertical: body.eventVertical ?? null
- bookings.event_vertical is populated when a client selects an event type during booking creation via either path
- VERT-05 admin vertical selector confirmed working (already existed — no changes required)
- VERT-06 client booking vertical flow is confirmed end-to-end: UI captures → API persists → column populated
- pnpm tsc --noEmit passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-vertical-infrastructure-riddor-fix/18-05-SUMMARY.md`
</output>
