---
phase: 18-vertical-infrastructure-riddor-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/database/schema.ts
  - src/database/migrations.ts
  - src/database/models/Treatment.ts
  - src/database/models/NearMiss.ts
  - supabase/migrations/124_vertical_schema_v4.sql
autonomous: true

must_haves:
  truths:
    - "WatermelonDB schema is at version 4 — schema.ts version field reads 4"
    - "The treatments table in WatermelonDB has event_vertical, vertical_extra_fields, and booking_id columns"
    - "The near_misses table in WatermelonDB has gps_lat and gps_lng columns"
    - "Treatment model exposes eventVertical, verticalExtraFields, and bookingId TypeScript fields"
    - "NearMiss model exposes gpsLat and gpsLng TypeScript fields"
    - "A Supabase SQL migration exists that adds event_vertical and vertical_extra_fields to the treatments table and gps_lat and gps_lng to near_misses"
  artifacts:
    - path: "src/database/schema.ts"
      provides: "WatermelonDB app schema version 4"
      contains: "version: 4"
    - path: "src/database/migrations.ts"
      provides: "WatermelonDB migration from v3 to v4"
      contains: "toVersion: 4"
    - path: "src/database/models/Treatment.ts"
      provides: "Treatment model with vertical fields"
      contains: "event_vertical"
    - path: "src/database/models/NearMiss.ts"
      provides: "NearMiss model with GPS fields"
      contains: "gps_lat"
    - path: "supabase/migrations/124_vertical_schema_v4.sql"
      provides: "Supabase SQL migration for vertical columns"
      contains: "ADD COLUMN IF NOT EXISTS event_vertical"
  key_links:
    - from: "src/database/schema.ts"
      to: "src/database/migrations.ts"
      via: "schema version matches highest toVersion"
      pattern: "version: 4"
    - from: "src/database/models/Treatment.ts"
      to: "src/database/schema.ts"
      via: "@field decorator names match schema column names"
      pattern: "@field\\('event_vertical'\\)"
---

<objective>
Add WatermelonDB schema v4: all columns needed by subsequent Phase 18 plans (event_vertical, vertical_extra_fields, booking_id on treatments; gps_lat, gps_lng on near_misses) plus matching Supabase SQL migration.

Purpose: Every subsequent plan in Phase 18 reads or writes these columns. No other plan can safely run until this schema is in place. The schema and SQL migration must land together — the Supabase column must exist before the RIDDOR detector tries to read treatment.event_vertical.

Output: Updated schema.ts (v4), migrations.ts (toVersion: 4 step), Treatment.ts (3 new fields), NearMiss.ts (2 new fields), supabase/migrations/124_vertical_schema_v4.sql.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-vertical-infrastructure-riddor-fix/18-RESEARCH.md
@src/database/schema.ts
@src/database/migrations.ts
@src/database/models/Treatment.ts
@src/database/models/NearMiss.ts
@supabase/migrations/00003_health_data_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bump WatermelonDB schema to v4 and add migration step</name>
  <files>src/database/schema.ts, src/database/migrations.ts</files>
  <action>
    In `src/database/schema.ts`:
    - Change `version: 3` to `version: 4` on line 8.
    - In the `treatments` tableSchema, add these three columns after the existing `last_modified_at` column:
      ```
      { name: 'event_vertical', type: 'string', isOptional: true },
      { name: 'vertical_extra_fields', type: 'string', isOptional: true }, // JSON string — parse at read time
      { name: 'booking_id', type: 'string', isOptional: true },
      ```
    - In the `near_misses` tableSchema, add these two columns after `last_modified_at`:
      ```
      { name: 'gps_lat', type: 'number', isOptional: true },
      { name: 'gps_lng', type: 'number', isOptional: true },
      ```

    In `src/database/migrations.ts`:
    - Add a new migration object after the existing `toVersion: 3` block:
      ```typescript
      {
        toVersion: 4,
        steps: [
          addColumns({
            table: 'treatments',
            columns: [
              { name: 'event_vertical', type: 'string', isOptional: true },
              { name: 'vertical_extra_fields', type: 'string', isOptional: true },
              { name: 'booking_id', type: 'string', isOptional: true },
            ],
          }),
          addColumns({
            table: 'near_misses',
            columns: [
              { name: 'gps_lat', type: 'number', isOptional: true },
              { name: 'gps_lng', type: 'number', isOptional: true },
            ],
          }),
        ],
      },
      ```

    Critical: `isOptional: true` is required for ALL new columns — missing this breaks existing device installs. The existing v2 migration uses `isOptional: false` on `is_incomplete` as a special case (boolean with default); all new string/number columns must be optional.

    Do NOT rename or remove any existing columns.
  </action>
  <verify>
    Run `pnpm tsc --noEmit` from the project root. Zero TypeScript errors expected.
    Manually confirm: `grep -n "version:" src/database/schema.ts` returns `version: 4`.
    Manually confirm: `grep -c "toVersion: 4" src/database/migrations.ts` returns `1`.
  </verify>
  <done>schema.ts shows version 4; migrations.ts has a toVersion: 4 block with addColumns for both treatments and near_misses; TypeScript compilation succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Update Treatment and NearMiss models with new field decorators</name>
  <files>src/database/models/Treatment.ts, src/database/models/NearMiss.ts</files>
  <action>
    In `src/database/models/Treatment.ts`:
    - The existing import line already imports `field`, `text`, `json` — no import change needed.
    - After the existing `@field('last_modified_at') lastModifiedAt!: number` line (line 50), add:
      ```typescript
      @field('event_vertical') eventVertical?: string
      @text('vertical_extra_fields') verticalExtraFields?: string  // raw JSON; parse with JSON.parse() at call site
      @field('booking_id') bookingId?: string
      ```
    - Use `@text` for `vertical_extra_fields` (same as `mechanismOfInjury` on line 40) because it may be a long JSON string. Use `@field` for the others.

    In `src/database/models/NearMiss.ts`:
    - After the existing `@field('last_modified_at') lastModifiedAt!: number` line (line 28), add:
      ```typescript
      @field('gps_lat') gpsLat?: number
      @field('gps_lng') gpsLng?: number
      ```
    - No import changes needed — `field` is already imported.

    All new model properties must be typed with `?` (optional) to match the `isOptional: true` schema columns. Mandatory (`!`) on optional columns causes runtime errors when reading records created before this migration.
  </action>
  <verify>
    Run `pnpm tsc --noEmit` from project root. Zero errors.
    Confirm: `grep "eventVertical" src/database/models/Treatment.ts` returns the new field.
    Confirm: `grep "gpsLat" src/database/models/NearMiss.ts` returns the new field.
  </verify>
  <done>Treatment model has eventVertical, verticalExtraFields, bookingId as optional TypeScript properties with matching @field/@text decorators. NearMiss model has gpsLat, gpsLng as optional number properties. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 3: Write Supabase SQL migration 124 — vertical columns on server tables</name>
  <files>supabase/migrations/124_vertical_schema_v4.sql</files>
  <action>
    Create `supabase/migrations/124_vertical_schema_v4.sql` with this content:

    ```sql
    -- Migration 124: Vertical infrastructure schema v4
    -- Phase 18: Vertical Infrastructure & RIDDOR Fix
    --
    -- Adds vertical-awareness columns to Supabase treatments and near_misses tables.
    -- All columns use ADD COLUMN IF NOT EXISTS to be safe against partial re-runs.
    -- The WatermelonDB schema v4 mirrors these columns locally on device.

    -- Treatments: vertical context + booking linkage
    ALTER TABLE treatments
      ADD COLUMN IF NOT EXISTS event_vertical TEXT,
      ADD COLUMN IF NOT EXISTS vertical_extra_fields JSONB,
      ADD COLUMN IF NOT EXISTS booking_id UUID REFERENCES bookings(id) ON DELETE SET NULL;

    -- Near misses: GPS coordinates captured at report time
    ALTER TABLE near_misses
      ADD COLUMN IF NOT EXISTS gps_lat DOUBLE PRECISION,
      ADD COLUMN IF NOT EXISTS gps_lng DOUBLE PRECISION;

    -- Compliance score history table (required by Phase 18 roadmap, used in Phase 19+)
    -- Created here so later phases can INSERT without a blocking migration dependency.
    CREATE TABLE IF NOT EXISTS compliance_score_history (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      org_id UUID NOT NULL REFERENCES org_settings(org_id) ON DELETE CASCADE,
      vertical TEXT NOT NULL,
      score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
      period_start DATE NOT NULL,
      period_end DATE NOT NULL,
      calculated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      details JSONB
    );

    CREATE INDEX IF NOT EXISTS compliance_score_history_org_id_idx ON compliance_score_history (org_id);
    CREATE INDEX IF NOT EXISTS compliance_score_history_vertical_idx ON compliance_score_history (vertical);

    -- RLS: compliance_score_history is org-scoped (same pattern as other tables)
    ALTER TABLE compliance_score_history ENABLE ROW LEVEL SECURITY;

    CREATE POLICY IF NOT EXISTS "org_members_can_read_compliance_scores"
      ON compliance_score_history FOR SELECT
      USING (
        org_id IN (
          SELECT org_id FROM profiles WHERE id = auth.uid()
        )
      );
    ```

    Notes:
    - `booking_id` uses UUID type (bookings.id is UUID) with ON DELETE SET NULL so deleting a booking does not orphan the treatment.
    - `vertical_extra_fields` uses JSONB on Supabase side (richer than TEXT for querying) while WatermelonDB stores it as TEXT (JSON string) — consistent with the existing `treatment_types` pattern (JSON in WatermelonDB, JSONB in Supabase).
    - `compliance_score_history` RLS policy uses `CREATE POLICY IF NOT EXISTS` (Postgres 9.5+) which is safe; if the policy already exists it is silently skipped.
    - Do NOT add a NOT NULL constraint to any new column — all values will be NULL until the app syncs them.
  </action>
  <verify>
    File exists at `supabase/migrations/124_vertical_schema_v4.sql`.
    Run `grep -c "ADD COLUMN IF NOT EXISTS" supabase/migrations/124_vertical_schema_v4.sql` — expect 5 (event_vertical, vertical_extra_fields, booking_id, gps_lat, gps_lng).
    Run `grep "CREATE TABLE IF NOT EXISTS compliance_score_history" supabase/migrations/124_vertical_schema_v4.sql` — expect 1 match.
  </verify>
  <done>SQL migration file exists with ALTER TABLE for treatments (3 columns) and near_misses (2 columns), plus compliance_score_history table creation with RLS. All columns are nullable with IF NOT EXISTS guards.</done>
</task>

</tasks>

<verification>
After all three tasks complete:

1. TypeScript: `pnpm tsc --noEmit` exits with code 0, no errors.
2. Schema version: `grep "version:" src/database/schema.ts` → `version: 4`
3. Migration coverage: `grep -c "toVersion:" src/database/migrations.ts` → `3` (v2, v3, v4)
4. Treatment model: `grep -E "(eventVertical|verticalExtraFields|bookingId)" src/database/models/Treatment.ts` → 3 matches
5. NearMiss model: `grep -E "(gpsLat|gpsLng)" src/database/models/NearMiss.ts` → 2 matches
6. SQL file: `ls supabase/migrations/124_vertical_schema_v4.sql` → file present
</verification>

<success_criteria>
- WatermelonDB schema version is 4 in schema.ts
- migrations.ts has a toVersion: 4 step covering treatments (3 columns) and near_misses (2 columns)
- Treatment model has eventVertical, verticalExtraFields, bookingId as optional properties
- NearMiss model has gpsLat, gpsLng as optional number properties
- supabase/migrations/124_vertical_schema_v4.sql exists with ADD COLUMN IF NOT EXISTS for all 5 columns
- compliance_score_history table defined in SQL migration
- pnpm tsc --noEmit passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-vertical-infrastructure-riddor-fix/18-01-SUMMARY.md`
</output>
