---
phase: 18-vertical-infrastructure-riddor-fix
plan: 04
type: execute
wave: 3
depends_on: ["18-03"]
files_modified:
  - app/treatment/new.tsx
autonomous: true

must_haves:
  truths:
    - "Opening new.tsx no longer triggers a Supabase network call to fetch the org vertical — it reads from OrgContext instead"
    - "When new.tsx is opened with route params booking_id and event_vertical, the form uses the booking's vertical rather than the org default"
    - "When new.tsx is opened without route params, the form uses primaryVertical from OrgContext"
    - "The enqueueSyncItem call includes event_vertical and booking_id in its payload so the Supabase RIDDOR detector can read them"
  artifacts:
    - path: "app/treatment/new.tsx"
      provides: "Treatment form with OrgContext vertical and booking override"
      contains: "useOrg"
  key_links:
    - from: "app/treatment/new.tsx"
      to: "src/contexts/OrgContext.tsx"
      via: "useOrg() hook — reads primaryVertical"
      pattern: "useOrg"
    - from: "app/treatment/new.tsx"
      to: "expo-router useLocalSearchParams"
      via: "params.event_vertical takes precedence over primaryVertical"
      pattern: "useLocalSearchParams"
    - from: "app/treatment/new.tsx"
      to: "supabase treatments table"
      via: "enqueueSyncItem payload includes event_vertical and booking_id"
      pattern: "event_vertical.*treatment\\.eventVertical"
---

<objective>
Refactor the treatment form (new.tsx) to remove the per-mount Supabase vertical fetch and replace it with useOrg() from OrgContext. Add useLocalSearchParams to accept booking_id and event_vertical route params, with the booking override taking precedence over the org default. Update the sync payload to include event_vertical and booking_id.

Purpose: This wires together the infrastructure built in 18-01 (new Treatment model fields) and 18-03 (OrgContext). After this plan, treatments created from a booking will carry the booking's vertical all the way to Supabase — enabling the RIDDOR detector to use the correct gate.

Output: Refactored app/treatment/new.tsx (single file).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-vertical-infrastructure-riddor-fix/18-RESEARCH.md
@.planning/phases/18-vertical-infrastructure-riddor-fix/18-03-SUMMARY.md
@app/treatment/new.tsx
@src/contexts/OrgContext.tsx
@app/treatment/[id].tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace fetchOrgVertical with useOrg and add booking route param support</name>
  <files>app/treatment/new.tsx</files>
  <action>
    Read the full `app/treatment/new.tsx` before making changes to understand all usages of `orgVertical` and `fetchOrgVertical`.

    Make the following targeted changes:

    **1. Add imports (at the top of the file):**
    After the existing expo-router import (look for `import { router } from 'expo-router'` or similar), add:
    ```typescript
    import { useLocalSearchParams } from 'expo-router';
    import { useOrg } from '../../src/contexts/OrgContext';
    ```
    The `useLocalSearchParams` may already be partially imported — check and extend the existing import rather than duplicating it.

    **2. Remove the orgVertical useState declaration.**
    Find and delete the line: `const [orgVertical, setOrgVertical] = useState<string>('general');` (or similar). It will be replaced by the hook call below.

    **3. Remove the fetchOrgVertical function (lines 93-113).**
    Delete the entire `fetchOrgVertical` function definition:
    ```typescript
    const fetchOrgVertical = async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        const orgId = user.app_metadata?.org_id;
        if (!orgId) return;
        const { data } = await supabase
          .from('org_settings')
          .select('industry_verticals')
          .eq('org_id', orgId)
          .single();
        if (data?.industry_verticals && Array.isArray(data.industry_verticals) && data.industry_verticals.length > 0) {
          setOrgVertical(data.industry_verticals[0] as string);
        }
      } catch {
        // Non-critical — fall back to general presets
      }
    };
    ```

    **4. Remove the fetchOrgVertical() call from the useEffect.**
    Find the useEffect that calls `fetchOrgVertical()` (around line 85). Delete the `fetchOrgVertical();` line from it. If that useEffect has no other content after removal, delete the entire useEffect block. If it has other content, keep the rest.

    **5. Add hook calls at the top of the component function body** (after the existing useState declarations, before the useEffect blocks):
    ```typescript
    // Booking vertical override (VERT-04)
    const params = useLocalSearchParams<{ booking_id?: string; event_vertical?: string }>();
    const { primaryVertical } = useOrg();

    // Booking-level vertical takes precedence over org default (Phase 18 VERT-04)
    const orgVertical = (params.event_vertical as string | undefined) ?? primaryVertical;
    const bookingId = (params.booking_id as string | undefined) ?? null;
    ```

    This restores the `orgVertical` variable name so all downstream usages (compliance checks, form presets, post-treatment guidance at line 374) continue to work without change. The only difference is the source — it now comes from OrgContext + route params instead of a network fetch.

    **6. Store bookingId and event_vertical on the WatermelonDB treatment record.**
    In `initializeTreatment()` (around lines 125-142), inside the `database.write()` callback where the treatment is created, add:
    ```typescript
    t.eventVertical = orgVertical;
    t.bookingId = bookingId ?? undefined;
    ```
    These fields exist on the Treatment model after Plan 18-01.

    **7. Add event_vertical and booking_id to the sync payload (around lines 336-360).**
    In the `enqueueSyncItem` call, add these two fields to the payload object:
    ```typescript
    event_vertical: treatment.eventVertical ?? null,
    booking_id: treatment.bookingId ?? null,
    ```
    Add them after `last_modified_at: treatment.lastModifiedAt,` (current last item in payload).

    Do NOT change any other logic. The `getVerticalCompliance(orgVertical)` call (line 374), all form section rendering, and all other useEffect hooks are untouched. `orgVertical` is still a string variable — all downstream consumers work identically.

    After making changes, search for any remaining references to `setOrgVertical` or `fetchOrgVertical` in the file — there should be zero. If any remain, delete them.
  </action>
  <verify>
    `grep -n "fetchOrgVertical" app/treatment/new.tsx` — expect 0 matches.
    `grep -n "setOrgVertical" app/treatment/new.tsx` — expect 0 matches.
    `grep -n "useOrg" app/treatment/new.tsx` — expect 1 match (the hook call).
    `grep -n "useLocalSearchParams" app/treatment/new.tsx` — expect at least 1 match.
    `grep -n "event_vertical" app/treatment/new.tsx` — expect at least 2 matches (in payload and in hook).
    `grep -n "booking_id" app/treatment/new.tsx` — expect at least 1 match (in payload).
    `pnpm tsc --noEmit` — zero TypeScript errors.
  </verify>
  <done>new.tsx has no fetchOrgVertical function or setOrgVertical state. orgVertical is derived from useOrg().primaryVertical (org default) or params.event_vertical (booking override). The enqueueSyncItem payload includes event_vertical and booking_id. initializeTreatment writes eventVertical and bookingId to the WatermelonDB record. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
After the task completes:

1. Removed: `grep "fetchOrgVertical" app/treatment/new.tsx` → 0 matches
2. Removed: `grep "setOrgVertical" app/treatment/new.tsx` → 0 matches
3. Added: `grep "useOrg" app/treatment/new.tsx` → 1 match
4. Added: `grep "useLocalSearchParams" app/treatment/new.tsx` → 1 match
5. Sync payload: `grep "event_vertical" app/treatment/new.tsx` → at least 2 matches
6. Model write: `grep "eventVertical" app/treatment/new.tsx` → at least 1 match (in database.write callback)
7. TypeScript: `pnpm tsc --noEmit` → zero errors
</verification>

<success_criteria>
- No Supabase fetch for org vertical in new.tsx — OrgContext provides it at zero cost
- params.event_vertical (from booking navigation) overrides org default when present
- params.booking_id stored in Treatment record and sync payload
- enqueueSyncItem payload includes event_vertical and booking_id
- pnpm tsc --noEmit passes with zero errors
- All existing form behavior (compliance checks, presets, post-treatment guidance) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/18-vertical-infrastructure-riddor-fix/18-04-SUMMARY.md`
</output>
