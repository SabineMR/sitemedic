---
phase: 45-document-upload-profile-storage
plan: 02
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - app/(tabs)/documents.tsx
  - app/documents/upload.tsx
  - app/(tabs)/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Medic can upload a compliance document from the iOS app using a system document picker (PDF, image)"
    - "Medic can capture a document photograph using the camera from within the upload flow"
    - "Medic selects a category and enters an expiry date (or checks does-not-expire) before uploading"
    - "Uploaded document appears in the iOS documents list grouped by category"
    - "iOS uploads go to the same Supabase medic-documents bucket with the same path convention as web"
    - "Versioning works the same as web: uploading a replacement creates a new version, archives the old"
  artifacts:
    - path: "app/(tabs)/documents.tsx"
      provides: "Documents tab screen with list view"
      min_lines: 60
    - path: "app/documents/upload.tsx"
      provides: "Document upload screen with picker + camera + metadata"
      min_lines: 100
    - path: "app/(tabs)/_layout.tsx"
      provides: "Updated tab layout with Documents tab"
  key_links:
    - from: "app/documents/upload.tsx"
      to: "supabase.storage.from('medic-documents').upload"
      via: "Supabase client direct upload from iOS"
      pattern: "storage.*from.*medic-documents.*upload"
    - from: "app/(tabs)/documents.tsx"
      to: "supabase.from('documents')"
      via: "Supabase client query for document list"
      pattern: "from.*documents.*select"
    - from: "app/documents/upload.tsx"
      to: "expo-document-picker"
      via: "DocumentPicker.getDocumentAsync for file selection"
      pattern: "DocumentPicker|getDocumentAsync"
---

<objective>
Create the iOS document upload flow so medics can upload compliance documents from the mobile app.

Purpose: Field medics often need to photograph paper certificates on-site (insurance certificates, DBS checks) rather than having digital copies. This plan adds a Documents tab to the iOS app with document picker and camera capture, uploading directly to Supabase Storage with the same versioning logic as the web dashboard.

Output: Working iOS Documents tab showing uploaded documents grouped by category, with an upload screen supporting both file picker and camera capture, category selection, and expiry date entry.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-document-upload-profile-storage/45-CONTEXT.md
@.planning/phases/45-document-upload-profile-storage/45-RESEARCH.md
@.planning/phases/45-document-upload-profile-storage/45-01-SUMMARY.md

Key references (read these for patterns):
@app/(tabs)/_layout.tsx â€” iOS tab layout (add Documents tab)
@app/(tabs)/messages.tsx â€” Messages tab pattern (Supabase direct queries, not Next.js API)
@web/types/comms.types.ts â€” DocumentCategory, Document, DocumentVersion types

Key decisions:
- [42-02]: iOS app talks to Supabase directly (NOT through Next.js API routes)
- iOS uses Expo Router for navigation
- Storage path: {org_id}/{medic_id}/{category_slug}/{timestamp}-{filename}
- medic-documents bucket is PRIVATE, 10MB limit
- expo-document-picker for file selection, expo-image-picker for camera capture
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create iOS upload screen with document picker and camera</name>
  <files>
    app/documents/upload.tsx
  </files>
  <action>
Install required Expo packages if not already installed:
- `expo-document-picker` (for PDF/file selection)
- `expo-image-picker` (for camera capture and photo library)

Check package.json first â€” if already present, skip install.

**app/documents/upload.tsx:**
Create a React Native screen using Expo Router (stack screen pushed from documents tab).

Screen layout (ScrollView):
1. **Source selection buttons:** Two large buttons at top:
   - "Choose File" â€” opens expo-document-picker with type: ['application/pdf', 'image/jpeg', 'image/png'], max file size 10MB
   - "Take Photo" â€” opens expo-image-picker with mediaTypes: Images, allowsEditing: true, quality: 0.8 (compress camera photos)

2. **Preview section** (shown after file selected):
   - Image preview for JPEG/PNG (React Native Image component, 200px height, resizeMode: contain)
   - PDF icon + filename for PDFs
   - File size display (formatted KB/MB)
   - "Change" button to re-select

3. **Category picker:**
   - Fetch categories from Supabase: `supabase.from('document_categories').select('*').eq('org_id', orgId).eq('is_active', true).order('sort_order')`
   - Use a Picker component (from @react-native-picker/picker) or a simple ScrollView with selectable chips/buttons (matching the app's visual style)
   - If opened with a `replaceDocumentId` route param, pre-set and lock the category

4. **Expiry date:**
   - Date input with a "Does not expire" toggle (Switch component)
   - When toggle is on, hide date picker, expiry = null
   - When toggle is off, show date picker (use a TextInput with date format prompt, or a simple date picker â€” check what's available in the project)
   - Use format YYYY-MM-DD for the date value

5. **Optional fields:**
   - Certificate number (TextInput)
   - Notes (TextInput, multiline)

6. **Upload button:**
   - Disabled until file + category selected
   - On press:
     a. Get current user: `supabase.auth.getUser()`
     b. Get medic record: `supabase.from('medics').select('id').eq('user_id', user.id).eq('org_id', orgId).single()`
     c. Get category slug from selected category
     d. Build storage path: `${orgId}/${medicId}/${categorySlug}/${Date.now()}-${sanitizedFileName}`
     e. **Versioning logic (if replaceDocumentId route param provided):**
        - Get current max version_number: `supabase.from('document_versions').select('version_number').eq('document_id', replaceDocumentId).order('version_number', { ascending: false }).limit(1)`
        - Upload file to storage
        - Insert new document_versions row with version_number + 1
        - Update documents.current_version_id to new version id
     f. **New document (no replaceDocumentId):**
        - Insert documents row (status='pending')
        - Upload file to storage
        - Insert document_versions row (version_number=1)
        - Update documents.current_version_id
     g. For file upload from camera/picker, read the file URI and convert to ArrayBuffer/Blob:
        - For expo-image-picker result: use `fetch(uri).then(r => r.blob())` or read as base64
        - For expo-document-picker: same pattern with the returned URI
        - Upload: `supabase.storage.from('medic-documents').upload(storagePath, blob, { contentType: mimeType, upsert: false })`
     h. Show ActivityIndicator during upload
     i. On success: Alert.alert('Document Uploaded', 'Your document has been uploaded successfully'), then router.back()
     j. On error: Alert.alert('Upload Failed', error.message)

Route params: accept optional `replaceDocumentId` and `presetCategoryId` via Expo Router search params.

Get orgId from OrgContext (import { useOrg } from '../../src/contexts/OrgContext').
Get auth from AuthContext or supabase.auth.getUser().

Style: White background, clean form layout matching existing iOS screens. Use consistent padding (16px), standard React Native components (View, Text, TextInput, TouchableOpacity, ScrollView, Switch, ActivityIndicator, Image, Alert).
  </action>
  <verify>
1. Run `cd /Users/sabineresoagli/GitHub/sitemedic && npx tsc --noEmit 2>&1 | head -40` to check for TypeScript errors
2. Verify the file exists and imports resolve: `head -20 /Users/sabineresoagli/GitHub/sitemedic/app/documents/upload.tsx`
  </verify>
  <done>
Upload screen exists at app/documents/upload.tsx with document picker (PDF, JPEG, PNG), camera capture, file preview, category picker, expiry date with toggle, certificate number, notes, and upload-to-Supabase logic including versioning.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Documents tab and list screen</name>
  <files>
    app/(tabs)/documents.tsx
    app/(tabs)/_layout.tsx
  </files>
  <action>
**app/(tabs)/documents.tsx:**
Create a React Native screen for the Documents tab.

On mount/focus:
- Get orgId from OrgContext, user from auth
- Get medic record for current user
- Fetch documents: `supabase.from('documents').select('*, document_versions!documents_current_version_id_fkey(*), document_categories!documents_category_id_fkey(name, slug)').eq('medic_id', medicId).eq('org_id', orgId).neq('status', 'archived').order('created_at', { ascending: false })`
- If FK join names cause issues, use separate queries (fetch documents, then categories and versions by ID)
- Fetch categories: `supabase.from('document_categories').select('*').eq('org_id', orgId).eq('is_active', true).order('sort_order')`

Layout:
- Header area: "My Documents" title + "Upload" button (blue #2563EB accent, matching app style)
- **Category sections:** Group documents by category. For each category:
  - Category name as section header
  - Document cards showing: file_name, file type icon, expiry date (or "No expiry"), version badge (e.g., "v2"), uploaded date
  - Each card has two actions: "Download" and "New Version"
  - "Download" action: `supabase.storage.from('medic-documents').createSignedUrl(storagePath, 3600)` then open URL with `Linking.openURL(signedUrl)`
  - "New Version" action: `router.push({ pathname: '/documents/upload', params: { replaceDocumentId: doc.id, presetCategoryId: doc.category_id } })`
- Categories with no documents: show "No documents" in muted text
- Empty state (no documents at all): "No documents uploaded yet. Tap Upload to add your compliance documents." with an upload icon
- Pull-to-refresh: RefreshControl on the ScrollView/FlatList

"Upload" button navigates to: `router.push('/documents/upload')`

Style: White background, consistent with other tabs (Messages, etc.). Use standard React Native components. Category section headers in gray (#6B7280), document cards with light border, rounded corners.

**app/(tabs)/_layout.tsx:**
Add a Documents tab to the Tabs component. Place it after Messages and before Events:

```tsx
<Tabs.Screen
  name="documents"
  options={{
    title: 'Documents',
    headerTitle: 'Documents',
    tabBarLabel: 'Documents',
    tabBarIcon: ({ color }) => (
      <Text style={[styles.iconText, { color }]}>ðŸ“„</Text>
    ),
  }}
/>
```

The Documents tab should be visible to ALL roles (both medic and admin â€” like Messages).
  </action>
  <verify>
1. Run `cd /Users/sabineresoagli/GitHub/sitemedic && npx tsc --noEmit 2>&1 | head -40` to check for TypeScript errors
2. Verify both files exist and have correct structure
  </verify>
  <done>
iOS app has a Documents tab in the bottom bar showing documents grouped by category with download and new version actions. Upload button navigates to the upload screen. Pull-to-refresh updates the list. Tab is visible to all roles.
  </done>
</task>

</tasks>

<verification>
1. iOS app shows Documents tab in bottom navigation bar
2. Documents tab loads and shows categories from the database
3. Tapping Upload navigates to the upload screen
4. Upload screen allows choosing a file via document picker (PDF, JPEG, PNG)
5. Upload screen allows capturing a photo via camera
6. Selected file shows preview (image thumbnail or PDF icon)
7. Category selection, expiry date with toggle, and optional fields work
8. Uploading a file stores it in Supabase Storage at correct path
9. After upload, Documents tab refreshes and shows the new document
10. Download button opens a signed URL in the browser
11. "New Version" uploads a new version and increments version number
</verification>

<success_criteria>
- iOS app has a working Documents tab with document list
- Medic can upload PDF or image from file picker or camera
- Category selection and expiry date entry work correctly
- Documents stored in same Supabase bucket with same path convention as web
- Versioning logic matches web (new version archives old)
- Download works via signed URL
</success_criteria>

<output>
After completion, create `.planning/phases/45-document-upload-profile-storage/45-02-SUMMARY.md`
</output>
