---
phase: 45-document-upload-profile-storage
plan: 03
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - web/app/(dashboard)/workers/[id]/page.tsx
  - web/components/documents/admin-document-view.tsx
  - web/app/(dashboard)/admin/document-categories/page.tsx
  - web/app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can view all documents for any medic in their org from the medic's worker profile page"
    - "Org admin can download the original uploaded document file for any medic's document"
    - "Org admin can see version history for each document"
    - "Org admin can create custom document categories for their org"
    - "Document display shows file name, category, expiry date, version number, and upload date"
  artifacts:
    - path: "web/app/(dashboard)/workers/[id]/page.tsx"
      provides: "Worker detail page with embedded Documents section"
    - path: "web/components/documents/admin-document-view.tsx"
      provides: "Reusable admin document view component"
      min_lines: 80
    - path: "web/app/(dashboard)/admin/document-categories/page.tsx"
      provides: "Custom category management page for org admins"
      min_lines: 50
  key_links:
    - from: "web/components/documents/admin-document-view.tsx"
      to: "/api/documents"
      via: "fetch GET with medicId query param"
      pattern: "fetch.*api/documents.*medicId"
    - from: "web/components/documents/admin-document-view.tsx"
      to: "/api/documents/[id]/download"
      via: "fetch GET for signed download URL"
      pattern: "fetch.*api/documents.*download"
    - from: "web/app/(dashboard)/admin/document-categories/page.tsx"
      to: "/api/documents/categories"
      via: "fetch GET and POST for category management"
      pattern: "fetch.*api/documents/categories"
---

<objective>
Create admin-facing document views so org admins can see all compliance documents for their medics and manage custom document categories.

Purpose: Org admins need visibility into their medics' compliance documentation. This plan adds a Documents section to the worker detail page showing all uploaded documents with download capability and version history. It also adds a category management page where admins can create custom categories for their org's specific compliance needs.

Output: Worker detail page (/dashboard/workers/[id]) has a Documents card showing all medic documents grouped by category with download links and version history. Admin settings has a Document Categories management page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-document-upload-profile-storage/45-CONTEXT.md
@.planning/phases/45-document-upload-profile-storage/45-RESEARCH.md
@.planning/phases/45-document-upload-profile-storage/45-01-SUMMARY.md

Key references (read these for patterns):
@web/app/(dashboard)/workers/[id]/page.tsx — Worker detail page (server component, Cards, shadcn/ui)
@web/types/comms.types.ts — DocumentCategory, Document, DocumentVersion, DocumentWithVersion
@web/app/api/documents/route.ts — GET documents API (accepts medicId query param)
@web/app/api/documents/[id]/download/route.ts — GET signed URL download API
@web/app/api/documents/categories/route.ts — GET list + POST create categories API

Key patterns from workers/[id]:
- Server component with Promise-based params
- Uses Card, CardContent, CardHeader, CardTitle from @/components/ui
- Badge component for status indicators
- date-fns format() for dates, suppressHydrationWarning
- Button component for actions
- Light theme (dashboard, NOT medic dark theme)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Documents section to worker detail page</name>
  <files>
    web/components/documents/admin-document-view.tsx
    web/app/(dashboard)/workers/[id]/page.tsx
  </files>
  <action>
**web/components/documents/admin-document-view.tsx:**
Create a CLIENT component ('use client') for displaying a medic's documents in the admin dashboard context (light theme, shadcn/ui components).

Props: `{ medicId: string }`

On mount:
- Fetch documents: `fetch('/api/documents?medicId=${medicId}')` — returns array of documents with current version and category info
- Fetch categories: `fetch('/api/documents/categories')` — for category grouping
- Loading state with Loader2 spinner

Layout (using shadcn/ui Card, Badge, Button):
- Group documents by category
- Each category section:
  - Category name as heading with count badge (e.g., "Insurance (2)")
  - If category is_required, show small "Required" badge
  - Each document card (border rounded-lg p-4):
    - Left: File type icon (FileText for PDF, ImageIcon for images from lucide-react) + file_name + file_size
    - Middle: Expiry info — Badge with color coding:
      - Green "Current" if expiry > 30 days away or no expiry
      - Amber "Expiring Soon" if expiry <= 30 days (Phase 46 will add progressive alerts, this is just the badge)
      - Red "Expired" if past expiry
      - Gray "No Expiry" if expiry_date is null
    - Right side: Version badge ("v{version_number}"), upload date, download button
    - Download button (Button variant="outline" size="sm"): fetch `/api/documents/${doc.id}/download`, then `window.open(url, '_blank')`. Show Download icon.
  - **Version history toggle:** Small "Show history" text button per document. When clicked, fetch all versions for that document using an additional API call or from the already-loaded data. Show table of: version_number, file_name, expiry_date, uploaded_at, download link for each archived version.
- Categories with no documents: show "No documents uploaded" in muted text
- Empty state (no documents at all): "No compliance documents uploaded for this medic."

Status badge component (reusable):
```tsx
function ExpiryBadge({ expiryDate }: { expiryDate: string | null }) {
  if (!expiryDate) return <Badge variant="secondary">No Expiry</Badge>;
  const daysUntil = Math.ceil((new Date(expiryDate).getTime() - Date.now()) / (1000*60*60*24));
  if (daysUntil < 0) return <Badge variant="destructive">Expired</Badge>;
  if (daysUntil <= 30) return <Badge className="bg-amber-100 text-amber-800">Expiring Soon</Badge>;
  return <Badge className="bg-green-100 text-green-800">Current</Badge>;
}
```

**web/app/(dashboard)/workers/[id]/page.tsx:**
Add a Documents section to the existing worker detail page. This is a SERVER component, so embed the AdminDocumentView client component within it.

Read the existing file first. Add a new Card section AFTER the existing GDPR Request card:

```tsx
{/* Compliance Documents */}
<Card>
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <FileText className="h-4 w-4" />
      Compliance Documents
    </CardTitle>
  </CardHeader>
  <CardContent>
    <AdminDocumentView medicId={id} />
  </CardContent>
</Card>
```

To get the medic_id for the worker page: The workers/[id] page receives a worker id (from the workers/patients table). The medic document system uses medic_id from the medics table. These are DIFFERENT tables. The worker detail page shows info about treated patients/workers, NOT about medics/staff.

IMPORTANT: Re-read workers/[id]/page.tsx carefully. If workers are patients (not medics), then documents should NOT go here. Instead, documents should be displayed on the medic management page. Check if there's a separate medic detail page in the admin dashboard.

If workers/[id] is for patients: Create a NEW route at web/app/(dashboard)/medics/[id]/documents/page.tsx instead, or find the existing admin medic view. The admin needs to see documents for MEDICS (staff), not for WORKERS (patients).

LIKELY the correct approach: Check web/app/(dashboard) for a medic management page. If one exists (e.g., /dashboard/team or similar), add the Documents section there. If no admin medic detail page exists, create a new page at web/app/(dashboard)/medics/[id]/page.tsx that shows medic profile info + documents.

The simplest approach: Create a standalone page at web/app/(dashboard)/documents/[medicId]/page.tsx that shows a specific medic's documents. Then link to it from wherever medics are listed in the admin dashboard.

Steps:
1. Read workers/[id]/page.tsx — confirm it's about patients/workers not medics
2. Search for existing admin medic pages: check web/app/(dashboard)/medics/ or web/app/(dashboard)/team/
3. Create the documents view at the appropriate location
4. Import AdminDocumentView and FileText icon
5. Add the Documents card to the page
  </action>
  <verify>
1. Run `cd /Users/sabineresoagli/GitHub/sitemedic && npx tsc --noEmit --project web/tsconfig.json 2>&1 | head -40` — should compile
2. Navigate to the admin page showing medic documents — should load without errors and show documents grouped by category
  </verify>
  <done>
Admin dashboard has a page/section showing a medic's compliance documents grouped by category. Each document shows file name, expiry status badge, version number, and a download button that opens the file via signed URL. Version history is expandable per document. Categories with no documents show placeholder text.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create custom category management page</name>
  <files>
    web/app/(dashboard)/admin/document-categories/page.tsx
    web/app/(dashboard)/layout.tsx
  </files>
  <action>
**web/app/(dashboard)/admin/document-categories/page.tsx:**
Create a CLIENT component ('use client') for managing document categories (light theme, shadcn/ui).

Page layout:
- Header: "Document Categories" with subtitle "Manage compliance document categories for your organisation"
- "Add Category" button (top right) that opens a simple inline form or dialog

Categories list:
- Fetch from GET /api/documents/categories on mount
- Table or card list showing: name, slug, is_required badge, is_active status, sort_order
- Default categories (Insurance, DBS, Qualification, ID, Other) shown with a "Default" badge — these cannot be deleted
- Custom categories show an "Custom" badge
- Each custom category has: toggle active/inactive (PATCH to update is_active — would need a small PATCH API, OR use the existing POST to create and handle is_active toggle client-side via direct Supabase update since admin has org-scoped RLS)
- Actually, for simplicity: use direct Supabase client update for toggling is_active: `supabase.from('document_categories').update({ is_active: !currentValue }).eq('id', categoryId).eq('org_id', orgId)` — RLS allows this for org members

Add Category form:
- Text input for category name
- On submit: POST /api/documents/categories with { name }
- Validate name is not empty, show error if duplicate slug (409 from API)
- On success: refresh list, clear input, toast.success('Category created')

Style: Use Card, CardHeader, CardTitle, CardContent, Table, TableHeader, TableRow, TableCell, Badge, Button, Input from shadcn/ui. Match existing admin settings pages.

**web/app/(dashboard)/layout.tsx:**
Read the existing dashboard layout file. Find where the admin nav/sidebar items are defined. Add a link to the document categories page under admin settings or a relevant section.

Look for patterns like:
- If there's a settings section: add "Document Categories" under it
- If there's an admin section: add it there
- The nav item: `{ name: 'Document Categories', href: '/admin/document-categories', icon: FolderOpen }` (or similar)

If the dashboard layout uses a different nav pattern (e.g., sidebar defined elsewhere), trace to the correct file and add the nav item there. Check DashboardNav component or similar.

NOTE: Only add the nav item if it fits naturally. If the admin settings structure is complex, just create the page — it can be navigated to directly. Don't force a nav item if it breaks the existing layout structure.
  </action>
  <verify>
1. Run `cd /Users/sabineresoagli/GitHub/sitemedic && npx tsc --noEmit --project web/tsconfig.json 2>&1 | head -40` — should compile
2. Navigate to /admin/document-categories — page loads showing the 5 default categories
3. Add a custom category — it appears in the list with "Custom" badge
  </verify>
  <done>
Admin has a Document Categories page showing default and custom categories. Admin can create new custom categories (name auto-generates slug). Custom categories can be toggled active/inactive. Default categories shown with "Default" badge and cannot be deleted.
  </done>
</task>

</tasks>

<verification>
1. Admin navigates to a medic's document view — sees all uploaded documents grouped by category
2. Admin clicks Download on a document — file opens in new tab via signed URL
3. Admin expands version history — sees all versions with download links
4. Expiry badges show correct color coding (green Current, amber Expiring Soon, red Expired, gray No Expiry)
5. Admin navigates to Document Categories page — sees 5 default categories
6. Admin creates a custom category "Motorsport Medical Licence" — appears with Custom badge
7. Admin toggles a custom category inactive — it no longer appears in upload category pickers
</verification>

<success_criteria>
- Org admin can view all documents for any medic in their org
- Download works for both current and archived versions
- Expiry status badges display correctly
- Custom category creation works with slug auto-generation
- Category active/inactive toggle works
- All pages compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/45-document-upload-profile-storage/45-03-SUMMARY.md`
</output>
