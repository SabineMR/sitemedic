---
phase: 23-analytics-heat-maps-and-trend-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/generate-weekly-report/index.tsx
  - supabase/migrations/130_compliance_score_history_index_and_rls.sql
autonomous: true

must_haves:
  truths:
    - "Compliance scores are persisted automatically each week when generate-weekly-report runs"
    - "Each weekly report run upserts a compliance_score_history row with numeric score 0-100"
    - "Platform admins can query compliance_score_history across all orgs"
    - "Duplicate runs for the same org+vertical+period_start do not create duplicate rows"
  artifacts:
    - path: "supabase/migrations/130_compliance_score_history_index_and_rls.sql"
      provides: "UNIQUE index on (org_id, vertical, period_start) + platform admin SELECT RLS policy"
      contains: "CREATE UNIQUE INDEX"
    - path: "supabase/functions/generate-weekly-report/index.tsx"
      provides: "Compliance score upsert after reportData fetch"
      contains: "compliance_score_history"
  key_links:
    - from: "supabase/functions/generate-weekly-report/index.tsx"
      to: "compliance_score_history"
      via: "supabase.from('compliance_score_history').upsert()"
      pattern: "compliance_score_history.*upsert"
---

<objective>
Update the generate-weekly-report Edge Function to persist a numeric compliance score (0-100) into the compliance_score_history table each time it runs. Create the required UNIQUE index and platform admin RLS policy via migration 130.

Purpose: The compliance_score_history table was created in migration 124 (Phase 18) but has no data writer yet. This plan wires the existing weekly report pipeline to populate it, providing the data foundation for trend charts in plans 23-04 and 23-05.

Output: Migration 130 (unique index + RLS policy) + updated generate-weekly-report/index.tsx with compliance score upsert logic.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-RESEARCH.md

Key existing code:
@supabase/functions/generate-weekly-report/index.tsx
@supabase/functions/generate-weekly-report/queries.ts
@supabase/functions/generate-weekly-report/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 130 — UNIQUE index + platform admin RLS policy on compliance_score_history</name>
  <files>supabase/migrations/130_compliance_score_history_index_and_rls.sql</files>
  <action>
    Create SQL migration file with two statements:

    1. UNIQUE INDEX for upsert onConflict:
    ```sql
    CREATE UNIQUE INDEX IF NOT EXISTS compliance_score_history_period_unique
      ON compliance_score_history (org_id, vertical, period_start);
    ```

    2. Platform admin SELECT policy (table was created in migration 124 but has NO platform admin policy):
    ```sql
    CREATE POLICY "Platform admins can view all compliance scores"
      ON compliance_score_history FOR SELECT
      USING (is_platform_admin());
    ```

    The `is_platform_admin()` function already exists (created in migration 101). The compliance_score_history table already has RLS enabled (migration 124). Only the platform admin SELECT policy is missing.

    Do NOT add org-scoped SELECT policy here — it was already created in migration 124.
  </action>
  <verify>
    File exists at supabase/migrations/130_compliance_score_history_index_and_rls.sql.
    File contains CREATE UNIQUE INDEX with columns (org_id, vertical, period_start).
    File contains CREATE POLICY referencing is_platform_admin().
    No other DDL (no CREATE TABLE, no ALTER TABLE).
  </verify>
  <done>Migration 130 creates the unique index required for upsert and the platform admin RLS policy required for plan 23-05.</done>
</task>

<task type="auto">
  <name>Task 2: Add compliance score upsert to generate-weekly-report Edge Function</name>
  <files>supabase/functions/generate-weekly-report/index.tsx</files>
  <action>
    After the `reportData` is fetched (line ~165, after `const reportData = await fetchWeeklyReportData(...)`) and before the PDF rendering, add a compliance score upsert block:

    1. Convert the existing traffic-light status to a numeric score using the v1 formula:
    ```typescript
    // Compliance score v1: numeric 0-100 from the four compliance factors
    const complianceNumericScore = 100
      - (reportData.complianceScore.dailyCheckDone ? 0 : 40)
      - (reportData.complianceScore.riddorDeadlines > 0 ? 30 : 0)
      - (reportData.complianceScore.overdueFollowups > 0 ? 20 : 0)
      - (reportData.complianceScore.expiredCerts > 0 ? 10 : 0);
    ```

    2. Calculate period_start and period_end (DATE type, not TIMESTAMPTZ):
    ```typescript
    const periodEnd = weekEnding.split('T')[0]; // YYYY-MM-DD
    const periodStartDate = new Date(weekEnding);
    periodStartDate.setDate(periodStartDate.getDate() - 7);
    const periodStart = periodStartDate.toISOString().split('T')[0];
    ```

    3. Upsert into compliance_score_history:
    ```typescript
    const { error: complianceUpsertError } = await supabase
      .from('compliance_score_history')
      .upsert(
        {
          org_id: orgId,
          vertical: 'general',
          score: complianceNumericScore,
          period_start: periodStart,
          period_end: periodEnd,
          details: {
            formula_version: 'v1',
            daily_check_done: reportData.complianceScore.dailyCheckDone,
            riddor_deadlines: reportData.complianceScore.riddorDeadlines,
            overdue_followups: reportData.complianceScore.overdueFollowups,
            expired_certs: reportData.complianceScore.expiredCerts,
          },
        },
        { onConflict: 'org_id,vertical,period_start' }
      );

    if (complianceUpsertError) {
      console.error('Failed to upsert compliance score:', complianceUpsertError.message);
      // Non-blocking: compliance history failure should not prevent report generation
    } else {
      console.log(`Compliance score ${complianceNumericScore}/100 persisted for period ${periodStart} to ${periodEnd}`);
    }
    ```

    IMPORTANT:
    - formula_version goes in the `details` JSONB column, NOT as a separate column (column does not exist)
    - vertical is 'general' (NOT NULL constraint in schema — 'general' is sentinel for org-wide)
    - The upsert uses onConflict matching the UNIQUE index from Task 1
    - This block is non-blocking (try/catch or error log only) — report generation must not fail if compliance upsert fails
    - The Edge Function uses service role client, so it bypasses RLS for the INSERT
    - Place the upsert BETWEEN fetchWeeklyReportData and renderToBuffer (before PDF generation, after data fetch)
  </action>
  <verify>
    grep for 'compliance_score_history' in supabase/functions/generate-weekly-report/index.tsx — should appear.
    grep for 'formula_version' — should appear inside details object.
    grep for 'onConflict' — should reference org_id,vertical,period_start.
    The numeric score formula matches: 100 - 40(dailyCheck) - 30(riddor) - 20(followups) - 10(certs).
  </verify>
  <done>generate-weekly-report upserts a numeric compliance score (0-100) with formula v1 details into compliance_score_history on every run. Duplicate runs for same period are idempotent via upsert.</done>
</task>

</tasks>

<verification>
1. Migration 130 file exists with exactly 2 SQL statements (UNIQUE INDEX + RLS POLICY)
2. generate-weekly-report/index.tsx contains compliance_score_history upsert block
3. Score formula: 100 - 40(no daily check) - 30(riddor deadlines) - 20(overdue followups) - 10(expired certs)
4. formula_version stored in details JSONB, not as a column
5. vertical = 'general' (string sentinel, not null)
6. Upsert is non-blocking (failure logged but does not prevent report generation)
</verification>

<success_criteria>
- Migration 130 creates UNIQUE INDEX on compliance_score_history(org_id, vertical, period_start) and platform admin SELECT policy
- generate-weekly-report persists compliance score on every POST invocation
- Compliance score is numeric 0-100 with v1 formula
- details JSONB contains formula_version and all four input factors
- Re-running for same week is idempotent (upsert, not insert)
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-heat-maps-and-trend-charts/23-01-SUMMARY.md`
</output>
