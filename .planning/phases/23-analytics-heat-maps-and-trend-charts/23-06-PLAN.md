---
id: 23-06
title: "Motorsport Incident Report Card"
phase: 23
plan: 6
type: execute
wave: 6
depends_on: []
gap_closure: true
autonomous: true
files_modified:
  - web/lib/queries/motorsport-incidents.ts
  - web/components/dashboard/MotorsportIncidentReportCard.tsx
  - web/app/(dashboard)/treatments/[id]/page.tsx
must_haves:
  truths:
    - "Dashboard treatment detail page shows a Motorsport UK Accident Form download card when event_vertical === 'motorsport'"
    - "Clicking 'Generate Motorsport Incident Report' calls the motorsport-incident-generator Edge Function and opens the signed PDF URL in a new tab"
    - "Button shows 'Generating PDF...' spinner state while the Edge Function is executing"
  artifacts:
    - path: "web/lib/queries/motorsport-incidents.ts"
      provides: "generateMotorsportIncidentPDF() query function"
      exports: ["generateMotorsportIncidentPDF"]
    - path: "web/components/dashboard/MotorsportIncidentReportCard.tsx"
      provides: "Client component with useMutation PDF download card"
      exports: ["MotorsportIncidentReportCard"]
    - path: "web/app/(dashboard)/treatments/[id]/page.tsx"
      provides: "Conditional rendering of MotorsportIncidentReportCard for motorsport treatments"
      contains: "MotorsportIncidentReportCard"
  key_links:
    - from: "web/components/dashboard/MotorsportIncidentReportCard.tsx"
      to: "web/lib/queries/motorsport-incidents.ts"
      via: "import generateMotorsportIncidentPDF"
      pattern: "import.*generateMotorsportIncidentPDF.*from.*motorsport-incidents"
    - from: "web/lib/queries/motorsport-incidents.ts"
      to: "/functions/v1/motorsport-incident-generator"
      via: "fetch POST with { incident_id, event_vertical: 'motorsport' }"
      pattern: "motorsport-incident-generator"
    - from: "web/app/(dashboard)/treatments/[id]/page.tsx"
      to: "web/components/dashboard/MotorsportIncidentReportCard.tsx"
      via: "conditional render when event_vertical === 'motorsport'"
      pattern: "event_vertical.*motorsport.*MotorsportIncidentReportCard"
---

<objective>
Close GAP MOTO-07: The motorsport-incident-generator Edge Function is fully implemented but the web dashboard has no UI to trigger it. Create the query function, download card component, and wire it into the treatment detail page.

Purpose: Complete the end-to-end PDF download flow for motorsport treatments so medics can generate and download Motorsport UK Accident Form PDFs from the dashboard.

Output: Three files — query function, card component, page wiring — enabling one-click PDF generation for motorsport treatments.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing pattern to mirror exactly
@web/lib/queries/event-incidents.ts
@web/components/dashboard/EventIncidentReportCard.tsx

# Treatment detail page (wiring target)
@web/app/(dashboard)/treatments/[id]/page.tsx

# Edge Function (confirms request body shape)
@supabase/functions/motorsport-incident-generator/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create query function and card component</name>
  <files>
    web/lib/queries/motorsport-incidents.ts
    web/components/dashboard/MotorsportIncidentReportCard.tsx
  </files>
  <action>
**File 1: `web/lib/queries/motorsport-incidents.ts`**

Create this file by mirroring `web/lib/queries/event-incidents.ts` exactly, with these changes:

- Function name: `generateMotorsportIncidentPDF` (not `generateEventIncidentPDF`)
- Edge Function endpoint: `/functions/v1/motorsport-incident-generator` (not `event-incident-report-generator`)
- Request body: `{ incident_id: treatmentId, event_vertical: 'motorsport' }` (not `'festivals'`)
  - IMPORTANT: The field name is `incident_id` (confirmed from motorsport-incident-generator/index.ts line 39)
  - IMPORTANT: The `event_vertical: 'motorsport'` field IS required (index.ts line 46 validates it)
- Error message: `'Failed to generate Motorsport Incident Report'`
- Return type: same `Promise<{ success: boolean; pdf_path: string; signed_url: string }>`
- JSDoc: Update comment block to reference "Motorsport UK Accident Form" and "motorsport-incident-generator Edge Function"

**File 2: `web/components/dashboard/MotorsportIncidentReportCard.tsx`**

Create this file by mirroring `web/components/dashboard/EventIncidentReportCard.tsx` exactly, with these changes:

- `'use client'` directive at top (required)
- Import `generateMotorsportIncidentPDF` from `@/lib/queries/motorsport-incidents` (not event-incidents)
- Interface: `MotorsportIncidentReportCardProps` (same shape: `{ treatmentId: string }`)
- Export: `MotorsportIncidentReportCard` (not `EventIncidentReportCard`)
- `mutationFn`: calls `generateMotorsportIncidentPDF(treatmentId)`
- `onError` alert: `'Failed to generate Motorsport Incident Report. Please try again.'`
- CardTitle: `Motorsport UK &mdash; Accident Form`
- CardDescription: `Pre-filled Motorsport UK Accident Form generated from this treatment record for submission to race control or Motorsport UK`
- Button text (idle): `Generate Motorsport Incident Report`
- Button text (pending): `Generating PDF...`
- Footer text: `Click to generate a pre-filled Motorsport UK Accident Form. Review all information for accuracy before sharing with race control or the Clerk of the Course.`
- Icon: `FileText` from lucide-react (same as EventIncidentReportCard)
  </action>
  <verify>
- `cat web/lib/queries/motorsport-incidents.ts` — file exists, exports `generateMotorsportIncidentPDF`, calls `/functions/v1/motorsport-incident-generator` with `{ incident_id: treatmentId, event_vertical: 'motorsport' }`
- `cat web/components/dashboard/MotorsportIncidentReportCard.tsx` — file exists, has `'use client'`, exports `MotorsportIncidentReportCard`, imports from `@/lib/queries/motorsport-incidents`
- `npx tsc --noEmit --pretty 2>&1 | grep -i motorsport` — no TypeScript errors for these files
  </verify>
  <done>
- `generateMotorsportIncidentPDF()` function exists and calls the correct Edge Function endpoint with the correct request body shape
- `MotorsportIncidentReportCard` component exists with correct card copy, useMutation wiring, and error handling
- Both files compile without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire MotorsportIncidentReportCard into treatment detail page</name>
  <files>
    web/app/(dashboard)/treatments/[id]/page.tsx
  </files>
  <action>
Edit `web/app/(dashboard)/treatments/[id]/page.tsx` to add the motorsport card:

1. **Add import** (after line 19, alongside the existing EventIncidentReportCard and FAIncidentReportCard imports):
   ```ts
   import { MotorsportIncidentReportCard } from '@/components/dashboard/MotorsportIncidentReportCard';
   ```

2. **Add conditional render block** (after line 236 — the closing of the `sporting_events` block, before the `{/* Photos */}` comment on line 238):
   ```tsx
   {/* Motorsport UK Accident Form (motorsport only) */}
   {treatment.event_vertical === 'motorsport' && (
     <MotorsportIncidentReportCard treatmentId={treatment.id} />
   )}
   ```

   This follows the exact same pattern as the festivals and sporting_events blocks at lines 229-236.

IMPORTANT: Do NOT modify any other part of the page. The only changes are one new import and one new conditional render block.
  </action>
  <verify>
- `grep -n 'MotorsportIncidentReportCard' web/app/(dashboard)/treatments/[id]/page.tsx` — shows import line and render line
- `grep -n "event_vertical.*motorsport" web/app/(dashboard)/treatments/[id]/page.tsx` — confirms the conditional render exists
- The motorsport block appears AFTER the sporting_events block and BEFORE the Photos section
- `npx tsc --noEmit --pretty 2>&1 | grep treatments` — no TypeScript errors for the page
  </verify>
  <done>
- Treatment detail page imports and conditionally renders `MotorsportIncidentReportCard` when `event_vertical === 'motorsport'`
- The render position is consistent with existing vertical-specific cards (festivals, sporting_events)
- Page compiles without TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — full project compiles without errors
2. `grep -r "MotorsportIncidentReportCard" web/` — shows 3 hits: definition, export, import+render
3. `grep -r "generateMotorsportIncidentPDF" web/` — shows 2 hits: definition/export, import/call
4. `grep "motorsport-incident-generator" web/lib/queries/motorsport-incidents.ts` — confirms correct endpoint
5. Visual: treatment detail page for a motorsport treatment shows the "Motorsport UK — Accident Form" card with a generate button
</verification>

<success_criteria>
- A motorsport treatment's detail page on the dashboard displays a download card with "Generate Motorsport Incident Report" button
- Clicking the button sends a POST to `/functions/v1/motorsport-incident-generator` with `{ incident_id, event_vertical: 'motorsport' }`
- On success, the generated PDF opens in a new browser tab via the signed URL
- On failure, an alert is shown to the user
- The pattern is identical to EventIncidentReportCard (festivals) and FAIncidentReportCard (sporting_events)
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-heat-maps-and-trend-charts/23-06-SUMMARY.md`
</output>
