---
phase: 23-analytics-heat-maps-and-trend-charts
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/components/analytics/NearMissHeatMap.tsx
  - web/lib/queries/analytics/near-miss-geo.ts
  - web/app/(dashboard)/analytics/heat-map/page.tsx
  - web/components/dashboard/DashboardNav.tsx
  - web/components/analytics/AnalyticsSubNav.tsx
autonomous: true

must_haves:
  truths:
    - "A site manager on the org dashboard can view a Leaflet map of near-miss incidents clustered by GPS location"
    - "Near-miss markers are colour-coded by severity (low=blue, medium=amber, high=red, critical=purple)"
    - "Near-miss markers scale by severity (low=6, medium=10, high=14, critical=18 radius)"
    - "Only near-misses with non-null GPS coordinates are displayed"
    - "The Analytics nav link is visible in the dashboard sidebar"
    - "The heat-map page has a sub-navigation allowing users to switch to the Compliance Trends page"
  artifacts:
    - path: "web/components/analytics/NearMissHeatMap.tsx"
      provides: "CircleMarker-based near-miss map component using react-leaflet"
      min_lines: 60
    - path: "web/lib/queries/analytics/near-miss-geo.ts"
      provides: "TanStack Query hook for fetching near-miss GPS data"
      exports: ["useNearMissGeoData"]
    - path: "web/app/(dashboard)/analytics/heat-map/page.tsx"
      provides: "Org dashboard heat map page with dynamic import and analytics sub-nav"
      min_lines: 30
    - path: "web/components/dashboard/DashboardNav.tsx"
      provides: "Updated nav with Analytics link"
      contains: "analytics"
    - path: "web/components/analytics/AnalyticsSubNav.tsx"
      provides: "Shared sub-navigation component for analytics pages (Heat Map | Compliance Trends)"
      exports: ["AnalyticsSubNav"]
  key_links:
    - from: "web/app/(dashboard)/analytics/heat-map/page.tsx"
      to: "web/components/analytics/NearMissHeatMap.tsx"
      via: "dynamic(() => import(...))"
      pattern: "dynamic.*NearMissHeatMap"
    - from: "web/components/analytics/NearMissHeatMap.tsx"
      to: "web/lib/queries/analytics/near-miss-geo.ts"
      via: "useNearMissGeoData hook"
      pattern: "useNearMissGeoData"
    - from: "web/app/(dashboard)/analytics/heat-map/page.tsx"
      to: "web/components/analytics/AnalyticsSubNav.tsx"
      via: "import AnalyticsSubNav"
      pattern: "AnalyticsSubNav"
---

<objective>
Create the org-level near-miss heat map — a CircleMarker-based Leaflet map showing GPS-located near-miss incidents on the org dashboard. Add an Analytics nav link to the dashboard sidebar. Create a shared analytics sub-navigation component for switching between analytics pages.

Purpose: Site managers need to see where near-misses are geographically clustering so they can focus safety interventions on high-risk areas.

Output: NearMissHeatMap component, near-miss-geo query hook, heat-map dashboard page, updated DashboardNav, AnalyticsSubNav component.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-RESEARCH.md

Key existing patterns to follow:
@web/components/admin/territory-map.tsx (CircleMarker + react-leaflet pattern)
@web/app/admin/geofences/page.tsx (dynamic import with ssr:false pattern)
@web/lib/queries/admin/revenue.ts (TanStack Query hook pattern)
@web/components/dashboard/DashboardNav.tsx (sidebar nav items)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create near-miss geo query hook + NearMissHeatMap component + AnalyticsSubNav component</name>
  <files>web/lib/queries/analytics/near-miss-geo.ts, web/components/analytics/NearMissHeatMap.tsx, web/components/analytics/AnalyticsSubNav.tsx</files>
  <action>
    **File 1: web/lib/queries/analytics/near-miss-geo.ts**

    Create a TanStack Query hook following the pattern in web/lib/queries/admin/revenue.ts:

    ```typescript
    'use client';
    import { useQuery } from '@tanstack/react-query';
    import { createClient } from '@/lib/supabase/client';
    ```

    Interface `NearMissGeoPoint`:
    - id: string
    - gps_lat: number
    - gps_lng: number
    - severity: 'low' | 'medium' | 'high' | 'critical'
    - category: string
    - description: string | null
    - created_at: string

    Export `useNearMissGeoData()` hook:
    - queryKey: ['near-miss-geo']
    - queryFn: Fetches from supabase `near_misses` table
    - SELECT: id, gps_lat, gps_lng, severity, category, description, created_at
    - WHERE: gps_lat IS NOT NULL AND gps_lng IS NOT NULL AND deleted_at IS NULL
    - ORDER BY: created_at desc
    - LIMIT: 500 (reasonable cap for map rendering performance)
    - RLS handles org filtering automatically (no explicit org_id WHERE clause needed)
    - staleTime: 5 * 60 * 1000 (5 minutes)
    - Returns { data, isLoading, error }

    **File 2: web/components/analytics/NearMissHeatMap.tsx**

    Create a 'use client' component following the pattern in web/components/admin/territory-map.tsx:

    ```typescript
    'use client';
    import { useEffect } from 'react';
    import { MapContainer, TileLayer, CircleMarker, Popup, useMap } from 'react-leaflet';
    import L from 'leaflet';
    import 'leaflet/dist/leaflet.css';
    ```

    Import and use the `useNearMissGeoData` hook directly inside the component (no props needed for data — hook fetches internally).

    Severity configuration:
    - Radius: low=6, medium=10, high=14, critical=18
    - Color: low='#3B82F6' (blue), medium='#F59E0B' (amber), high='#EF4444' (red), critical='#7C3AED' (purple)
    - fillOpacity: 0.6

    Map setup:
    - Default center: [54.0, -2.5] (UK center)
    - Default zoom: 6
    - scrollWheelZoom: true
    - TileLayer: OpenStreetMap (same URL as territory-map.tsx)
    - Style: { height: '100%', width: '100%', borderRadius: '0.75rem' }

    Create a MapBoundsAdjuster sub-component (same pattern as territory-map.tsx) that fits bounds to all markers if data exists, otherwise defaults to UK center.

    Each near-miss renders as a CircleMarker with a Popup showing:
    - Category (bold)
    - Severity badge (coloured)
    - Description (truncated to 120 chars)
    - Date (formatted as DD MMM YYYY using toLocaleDateString('en-GB'))

    Add a severity legend in bottom-right corner (same absolute positioning pattern as territory-map.tsx legend) showing the four severity levels with their colours.

    Handle empty state: if data array is empty, show a centered message "No near-misses with GPS data recorded yet" inside the map container area.

    Handle loading state: if isLoading, show a pulse skeleton div at the same height.

    Do NOT use leaflet.heat — use CircleMarker only. This is a deliberate decision because leaflet.heat is incompatible with react-leaflet@5.0.0.

    Export as default (for dynamic import compatibility).

    **File 3: web/components/analytics/AnalyticsSubNav.tsx**

    Create a shared sub-navigation component for analytics pages:

    ```typescript
    'use client';
    import Link from 'next/link';
    import { usePathname } from 'next/navigation';
    ```

    Named export `AnalyticsSubNav`:
    - Renders two tab-style links side by side:
      1. "Heat Map" linking to `/analytics/heat-map`
      2. "Compliance Trends" linking to `/analytics/compliance`
    - Uses `usePathname()` to determine the active tab and style it accordingly
    - Active tab styling: bg-gray-700 text-white font-medium rounded-lg px-4 py-2
    - Inactive tab styling: text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg px-4 py-2
    - Container: flex gap-2 mb-6 (horizontal row with bottom margin)
    - Dark theme consistent with dashboard pages
    - Export as named export `AnalyticsSubNav`
  </action>
  <verify>
    File web/lib/queries/analytics/near-miss-geo.ts exists and exports useNearMissGeoData.
    File web/components/analytics/NearMissHeatMap.tsx exists and default-exports a component.
    File web/components/analytics/AnalyticsSubNav.tsx exists and exports AnalyticsSubNav.
    grep for 'CircleMarker' in NearMissHeatMap.tsx — should appear.
    grep for 'leaflet.heat' or 'HeatmapLayer' in NearMissHeatMap.tsx — should NOT appear.
    grep for 'gps_lat' in near-miss-geo.ts — should appear in the not-null filter.
    grep for 'useNearMissGeoData' in NearMissHeatMap.tsx — should appear (hook import).
    grep for '/analytics/heat-map' in AnalyticsSubNav.tsx — should appear.
    grep for '/analytics/compliance' in AnalyticsSubNav.tsx — should appear.
  </verify>
  <done>NearMissHeatMap renders GPS-located near-misses as severity-coded CircleMarkers on a Leaflet map. Data is fetched via TanStack Query hook with RLS-scoped org filtering. AnalyticsSubNav provides tab-style navigation between analytics pages.</done>
</task>

<task type="auto">
  <name>Task 2: Create heat-map dashboard page with sub-nav + add Analytics nav link</name>
  <files>web/app/(dashboard)/analytics/heat-map/page.tsx, web/components/dashboard/DashboardNav.tsx</files>
  <action>
    **File 1: web/app/(dashboard)/analytics/heat-map/page.tsx**

    Create a 'use client' page component following the pattern in web/app/admin/geofences/page.tsx:

    ```typescript
    'use client';
    import dynamic from 'next/dynamic';
    import { AnalyticsSubNav } from '@/components/analytics/AnalyticsSubNav';
    ```

    Dynamic import NearMissHeatMap with ssr: false:
    ```typescript
    const NearMissHeatMap = dynamic(
      () => import('@/components/analytics/NearMissHeatMap'),
      {
        ssr: false,
        loading: () => <div className="h-[500px] bg-gray-900 rounded-xl animate-pulse" />,
      }
    );
    ```

    Page structure:
    - Header: "Near-Miss Heat Map" title + subtitle "Geographic distribution of near-miss incidents"
    - Use dark theme styling consistent with other dashboard pages (bg-gray-900 text-white)
    - Render `<AnalyticsSubNav />` below the header, above the map — this provides tab links to switch between "Heat Map" and "Compliance Trends"
    - Map container: fixed height of 500px (h-[500px]) with rounded corners
    - Render the dynamically imported NearMissHeatMap component

    Export as default page component.

    **File 2: web/components/dashboard/DashboardNav.tsx**

    Add an "Analytics" nav item to the existing navigation array. Place it AFTER "Reports" and BEFORE no other item (last position in nav).

    ```typescript
    {
      name: 'Analytics',
      href: '/analytics/heat-map',
      icon: BarChart3,  // from lucide-react
    },
    ```

    Import BarChart3 from lucide-react (add to the existing import destructuring).

    Update the `isActive` function to handle the /analytics prefix — it should highlight for any path starting with '/analytics'.
  </action>
  <verify>
    File web/app/(dashboard)/analytics/heat-map/page.tsx exists.
    grep for "dynamic.*NearMissHeatMap" in page.tsx — should appear.
    grep for "ssr: false" in page.tsx — should appear.
    grep for "AnalyticsSubNav" in page.tsx — should appear (sub-nav rendered on page).
    grep for "Analytics" in DashboardNav.tsx — should appear in navigation array.
    grep for "BarChart3" in DashboardNav.tsx — should appear in import.
    The nav href is '/analytics/heat-map' (lives under (dashboard) route group).
  </verify>
  <done>Heat map page is accessible at /analytics/heat-map within the org dashboard with sub-navigation to switch to Compliance Trends. Analytics nav link is visible in the sidebar navigation for site managers.</done>
</task>

</tasks>

<verification>
1. web/components/analytics/NearMissHeatMap.tsx uses CircleMarker from react-leaflet (NOT leaflet.heat)
2. web/lib/queries/analytics/near-miss-geo.ts filters WHERE gps_lat IS NOT NULL AND gps_lng IS NOT NULL
3. web/app/(dashboard)/analytics/heat-map/page.tsx uses dynamic({ ssr: false }) for Leaflet component
4. web/app/(dashboard)/analytics/heat-map/page.tsx renders AnalyticsSubNav for cross-page navigation
5. DashboardNav.tsx has Analytics link pointing to /analytics/heat-map
6. Severity mapping: low=blue/6, medium=amber/10, high=red/14, critical=purple/18
7. AnalyticsSubNav links to both /analytics/heat-map and /analytics/compliance
8. No new npm packages added
</verification>

<success_criteria>
- Site manager can navigate to Analytics > Heat Map from the dashboard sidebar
- Near-miss incidents with GPS coordinates appear as severity-coloured CircleMarkers on a Leaflet map
- Map centers on UK (54.0, -2.5) at zoom 6 by default
- Empty state shows informative message when no GPS data exists
- No SSR errors from Leaflet (dynamic import with ssr:false)
- Heat Map page has sub-nav tabs allowing navigation to Compliance Trends page
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-heat-maps-and-trend-charts/23-02-SUMMARY.md`
</output>
