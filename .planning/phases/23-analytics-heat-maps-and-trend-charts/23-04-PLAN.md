---
phase: 23-analytics-heat-maps-and-trend-charts
plan: 04
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - web/lib/queries/analytics/compliance-history.ts
  - web/components/analytics/ComplianceScoreChart.tsx
  - web/components/analytics/IncidentFrequencyChart.tsx
  - web/app/(dashboard)/analytics/compliance/page.tsx
autonomous: true

must_haves:
  truths:
    - "A site manager can view a compliance score trend chart showing weekly scores over the last 12 months"
    - "A site manager can view an incident frequency trend chart showing treatment + near-miss counts per week over the last 12 months"
    - "Both charts are accessible from the org dashboard analytics section"
    - "Compliance chart shows score as a line chart with 0-100 Y axis"
    - "Incident frequency chart shows two series (treatments and near-misses) as an area chart"
    - "The compliance page has a sub-navigation allowing users to switch to the Heat Map page"
  artifacts:
    - path: "web/lib/queries/analytics/compliance-history.ts"
      provides: "TanStack Query hooks for compliance score history and incident frequency"
      exports: ["useComplianceHistory", "useIncidentFrequency"]
    - path: "web/components/analytics/ComplianceScoreChart.tsx"
      provides: "Recharts LineChart showing compliance score trend"
      exports: ["ComplianceScoreChart"]
    - path: "web/components/analytics/IncidentFrequencyChart.tsx"
      provides: "Recharts AreaChart showing treatment + near-miss counts per week"
      exports: ["IncidentFrequencyChart"]
    - path: "web/app/(dashboard)/analytics/compliance/page.tsx"
      provides: "Org dashboard compliance trends page with both charts and analytics sub-nav"
      min_lines: 30
  key_links:
    - from: "web/app/(dashboard)/analytics/compliance/page.tsx"
      to: "web/components/analytics/ComplianceScoreChart.tsx"
      via: "dynamic import"
      pattern: "dynamic.*ComplianceScoreChart"
    - from: "web/components/analytics/ComplianceScoreChart.tsx"
      to: "web/lib/queries/analytics/compliance-history.ts"
      via: "useComplianceHistory hook"
      pattern: "useComplianceHistory"
    - from: "web/components/analytics/IncidentFrequencyChart.tsx"
      to: "web/lib/queries/analytics/compliance-history.ts"
      via: "useIncidentFrequency hook"
      pattern: "useIncidentFrequency"
    - from: "web/app/(dashboard)/analytics/compliance/page.tsx"
      to: "web/components/analytics/AnalyticsSubNav.tsx"
      via: "import AnalyticsSubNav"
      pattern: "AnalyticsSubNav"
---

<objective>
Create the org-level compliance score trend chart and incident frequency trend chart on the org dashboard. Both charts show 12 months of weekly data points using Recharts. Include analytics sub-navigation for discoverability.

Purpose: Site managers need to see whether their compliance score is improving or declining over time, and whether incident volumes are trending up or down. This closes ANLT-04 and ANLT-05.

Output: ComplianceScoreChart + IncidentFrequencyChart components, compliance-history query hooks, compliance dashboard page with sub-nav.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-RESEARCH.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-01-SUMMARY.md

Key existing patterns:
@web/components/admin/revenue-charts.tsx (Recharts LineChart pattern with dark theme)
@web/lib/queries/admin/revenue.ts (TanStack Query hook pattern)
@web/components/analytics/AnalyticsSubNav.tsx (shared sub-nav component created in 23-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compliance-history query hooks</name>
  <files>web/lib/queries/analytics/compliance-history.ts</files>
  <action>
    Create a file with two TanStack Query hooks, following the pattern in web/lib/queries/admin/revenue.ts.

    ```typescript
    'use client';
    import { useQuery } from '@tanstack/react-query';
    import { createClient } from '@/lib/supabase/client';
    ```

    **Interface `ComplianceScorePoint`:**
    - period_end: string (DATE — YYYY-MM-DD)
    - score: number (0-100)
    - details: { formula_version: string; daily_check_done: boolean; riddor_deadlines: number; overdue_followups: number; expired_certs: number } | null

    **Export `useComplianceHistory()` hook:**
    - queryKey: ['compliance-history']
    - queryFn: Fetches from `compliance_score_history`
    - SELECT: period_end, score, details
    - WHERE: vertical = 'general'
    - ORDER BY: period_start ASC (chronological for chart)
    - LIMIT: 52 (52 weeks = ~12 months)
    - RLS handles org filtering automatically
    - staleTime: 10 * 60 * 1000 (10 minutes — data changes weekly)
    - Returns { data: ComplianceScorePoint[], isLoading, error }

    **Interface `IncidentFrequencyPoint`:**
    - week_label: string (e.g., "W7 Feb")
    - week_start: string
    - treatments: number
    - near_misses: number

    **Export `useIncidentFrequency()` hook:**
    - queryKey: ['incident-frequency']
    - queryFn: This requires weekly aggregation. Since Supabase doesn't have built-in week bucketing, compute client-side:
      1. Fetch treatments (created_at, id) and near_misses (created_at, id) from last 12 months, both filtered by deleted_at IS NULL
      2. Use date-fns `startOfWeek` and `format` to bucket records by ISO week
      3. Build weekly counts for each bucket
      4. Return sorted chronologically

    Implementation approach for incident frequency:
    ```typescript
    import { startOfWeek, format, subMonths } from 'date-fns';

    const twelveMonthsAgo = subMonths(new Date(), 12).toISOString();

    const [treatmentsRes, nearMissesRes] = await Promise.all([
      supabase.from('treatments')
        .select('created_at')
        .gte('created_at', twelveMonthsAgo)
        .is('deleted_at', null),
      supabase.from('near_misses')
        .select('created_at')
        .gte('created_at', twelveMonthsAgo)
        .is('deleted_at', null),
    ]);

    // Bucket by week
    const weekMap = new Map<string, { treatments: number; near_misses: number }>();

    for (const t of treatmentsRes.data ?? []) {
      const weekStart = startOfWeek(new Date(t.created_at), { weekStartsOn: 1 }).toISOString().split('T')[0];
      const entry = weekMap.get(weekStart) ?? { treatments: 0, near_misses: 0 };
      entry.treatments++;
      weekMap.set(weekStart, entry);
    }

    for (const nm of nearMissesRes.data ?? []) {
      const weekStart = startOfWeek(new Date(nm.created_at), { weekStartsOn: 1 }).toISOString().split('T')[0];
      const entry = weekMap.get(weekStart) ?? { treatments: 0, near_misses: 0 };
      entry.near_misses++;
      weekMap.set(weekStart, entry);
    }

    // Sort and format
    const sorted = [...weekMap.entries()]
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([weekStart, counts]) => ({
        week_label: format(new Date(weekStart), "'W'I MMM"),
        week_start: weekStart,
        treatments: counts.treatments,
        near_misses: counts.near_misses,
      }));
    ```
    - staleTime: 10 * 60 * 1000
    - Returns { data: IncidentFrequencyPoint[], isLoading, error }
  </action>
  <verify>
    File exists at web/lib/queries/analytics/compliance-history.ts.
    grep for 'useComplianceHistory' — should appear as export.
    grep for 'useIncidentFrequency' — should appear as export.
    grep for 'compliance_score_history' — should appear in useComplianceHistory queryFn.
    grep for 'startOfWeek' — should appear in useIncidentFrequency (date-fns import).
    grep for "vertical.*general" — should appear (filter for general sentinel).
  </verify>
  <done>Two TanStack Query hooks provide weekly compliance scores and weekly incident frequency data for the last 12 months.</done>
</task>

<task type="auto">
  <name>Task 2: Create ComplianceScoreChart + IncidentFrequencyChart + compliance page with sub-nav</name>
  <files>web/components/analytics/ComplianceScoreChart.tsx, web/components/analytics/IncidentFrequencyChart.tsx, web/app/(dashboard)/analytics/compliance/page.tsx</files>
  <action>
    **File 1: web/components/analytics/ComplianceScoreChart.tsx**

    Follow the Recharts pattern from web/components/admin/revenue-charts.tsx (dark theme, ResponsiveContainer).

    ```typescript
    'use client';
    import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } from 'recharts';
    import { useComplianceHistory } from '@/lib/queries/analytics/compliance-history';
    ```

    Named export `ComplianceScoreChart`:
    - Uses useComplianceHistory() hook internally
    - LineChart with data mapped from hook
    - XAxis: period_end formatted as "DD MMM" (e.g., "14 Feb")
    - YAxis: domain [0, 100], ticks at 0, 25, 50, 75, 100
    - Line: dataKey="score", stroke="#3B82F6" (blue), strokeWidth=2, dot={{ r: 3 }}
    - ReferenceLine at y=70 (amber threshold) with label "Amber" in yellow, dashed
    - ReferenceLine at y=40 (red threshold) with label "Red" in red, dashed
    - CartesianGrid: strokeDasharray="3 3", stroke="#374151"
    - Tooltip: custom formatter showing "Score: XX/100" and the contributing factors from details
    - ResponsiveContainer: width="100%", height={400}
    - Handle empty: "No compliance history data yet. Scores are recorded weekly."
    - Handle loading: skeleton pulse div

    **File 2: web/components/analytics/IncidentFrequencyChart.tsx**

    ```typescript
    'use client';
    import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
    import { useIncidentFrequency } from '@/lib/queries/analytics/compliance-history';
    ```

    Named export `IncidentFrequencyChart`:
    - Uses useIncidentFrequency() hook internally
    - AreaChart with data from hook
    - XAxis: dataKey="week_label"
    - YAxis: auto domain, allowDecimals=false (integer counts)
    - Area 1: dataKey="treatments", stroke="#3B82F6", fill="#3B82F6", fillOpacity=0.3, name="Treatments"
    - Area 2: dataKey="near_misses", stroke="#F59E0B", fill="#F59E0B", fillOpacity=0.3, name="Near-Misses"
    - CartesianGrid: strokeDasharray="3 3", stroke="#374151"
    - Legend: shows both series
    - Tooltip: shows week label + both counts
    - ResponsiveContainer: width="100%", height={400}
    - Handle empty: "No incident data in the last 12 months."
    - Handle loading: skeleton pulse div

    **File 3: web/app/(dashboard)/analytics/compliance/page.tsx**

    'use client' page component. Dynamic import both chart components:
    ```typescript
    import { AnalyticsSubNav } from '@/components/analytics/AnalyticsSubNav';

    const ComplianceScoreChart = dynamic(
      () => import('@/components/analytics/ComplianceScoreChart').then(m => ({ default: m.ComplianceScoreChart })),
      { ssr: false, loading: () => <div className="h-[400px] bg-gray-800 animate-pulse rounded-lg" /> }
    );
    const IncidentFrequencyChart = dynamic(
      () => import('@/components/analytics/IncidentFrequencyChart').then(m => ({ default: m.IncidentFrequencyChart })),
      { ssr: false, loading: () => <div className="h-[400px] bg-gray-800 animate-pulse rounded-lg" /> }
    );
    ```

    Page layout:
    - Header: "Compliance & Incident Trends" + subtitle
    - Dark theme (bg-gray-900 text-white) consistent with other dashboard pages
    - Render `<AnalyticsSubNav />` below the header — this provides tab links to switch between "Heat Map" and "Compliance Trends" (component created in plan 23-02)
    - Two chart sections stacked vertically:
      1. "Compliance Score Trend" card (bg-gray-800 rounded-lg p-6 border border-gray-700) containing ComplianceScoreChart
      2. "Incident Frequency" card (same styling) containing IncidentFrequencyChart

    Note: The DashboardNav link from 23-02 points to /analytics/heat-map. For the compliance page, the user navigates via the AnalyticsSubNav tabs or directly via /analytics/compliance. The isActive logic in DashboardNav should highlight "Analytics" for both paths (already handled by startsWith('/analytics') in 23-02).
  </action>
  <verify>
    File web/components/analytics/ComplianceScoreChart.tsx exists and exports ComplianceScoreChart.
    File web/components/analytics/IncidentFrequencyChart.tsx exists and exports IncidentFrequencyChart.
    File web/app/(dashboard)/analytics/compliance/page.tsx exists.
    grep for 'LineChart' in ComplianceScoreChart.tsx — should appear.
    grep for 'AreaChart' in IncidentFrequencyChart.tsx — should appear.
    grep for 'ssr: false' in compliance/page.tsx — should appear twice (both charts).
    grep for 'useComplianceHistory' in ComplianceScoreChart.tsx — should appear.
    grep for 'useIncidentFrequency' in IncidentFrequencyChart.tsx — should appear.
    grep for 'AnalyticsSubNav' in compliance/page.tsx — should appear (sub-nav rendered on page).
    Both charts use recharts (already installed — no new packages).
  </verify>
  <done>Compliance score trend chart shows weekly scores with red/amber thresholds. Incident frequency chart shows treatment and near-miss weekly counts. Both accessible at /analytics/compliance on the org dashboard with sub-nav for discoverability.</done>
</task>

</tasks>

<verification>
1. ComplianceScoreChart uses Recharts LineChart with Y-axis 0-100
2. IncidentFrequencyChart uses Recharts AreaChart with two series (treatments, near-misses)
3. Both charts use dynamic({ ssr: false }) on the page
4. Data fetched via TanStack Query hooks from compliance_score_history and treatments/near_misses tables
5. Compliance history filters vertical = 'general' and limits to 52 weeks
6. Incident frequency uses date-fns for weekly bucketing (date-fns 4.1.0 already installed)
7. Compliance page renders AnalyticsSubNav for cross-page navigation to Heat Map
8. No new npm packages added
</verification>

<success_criteria>
- Site manager can navigate to /analytics/compliance and see both trend charts
- Compliance score chart shows 12 months of weekly scores as a line chart with red/amber thresholds
- Incident frequency chart shows treatment and near-miss counts per week as stacked areas
- Empty states are handled gracefully when no data exists
- Charts render without SSR errors
- Compliance page has sub-nav tabs allowing navigation to Heat Map page
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-heat-maps-and-trend-charts/23-04-SUMMARY.md`
</output>
