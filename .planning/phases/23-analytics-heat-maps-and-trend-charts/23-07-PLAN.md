---
id: 23-07
title: "Competitor Clearance UI Toggle"
phase: 23
plan: 7
type: execute
wave: 6
depends_on: []
gap_closure: true
autonomous: true
files_modified:
  - app/treatment/new.tsx
must_haves:
  truths:
    - "Mobile treatment form shows a 'Competitor cleared to return to race' checkbox for motorsport treatments"
    - "The checkbox is visible for ALL motorsport treatments (not gated behind concussion_suspected)"
    - "Toggling the checkbox updates motorsportFields.competitor_cleared_to_return via toggleMotorsportBool"
    - "The field value is included in the vertical_extra_fields JSON payload on save"
    - "The concussion clearance gate (lines 420-431) still only checks hia_conducted, competitor_stood_down, cmo_notified — NOT competitor_cleared_to_return"
  artifacts:
    - path: "app/treatment/new.tsx"
      provides: "competitor_cleared_to_return toggle checkbox in motorsport section"
      contains: "toggleMotorsportBool('competitor_cleared_to_return')"
  key_links:
    - from: "app/treatment/new.tsx (checkbox)"
      to: "motorsportFields.competitor_cleared_to_return"
      via: "toggleMotorsportBool('competitor_cleared_to_return')"
      pattern: "toggleMotorsportBool.*competitor_cleared_to_return"
    - from: "app/treatment/new.tsx (buildVerticalExtraFields)"
      to: "treatments.vertical_extra_fields JSONB"
      via: "JSON.stringify(motorsportFields) — competitor_cleared_to_return is already in INITIAL_MOTORSPORT_FIELDS spread"
      pattern: "JSON\\.stringify\\(motorsportFields\\)"
---

<objective>
Close GAP Flow 3: The `competitor_cleared_to_return` field is defined in the taxonomy (motorsport-fields.ts line 62), initialized in `INITIAL_MOTORSPORT_FIELDS` (line 98), and checked by the dashboard columns (treatments-columns.tsx line 109), but the mobile treatment form has no UI toggle for it. A medic can never set it to `true`, causing the "Concussion clearance required" badge to persist permanently.

Purpose: Add the missing checkbox so medics can mark a competitor as cleared to return after the concussion protocol is completed.

Output: One edited file — `app/treatment/new.tsx` — with a 4th checkbox added to the motorsport section.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Taxonomy definition (confirms field exists and is boolean)
@services/taxonomy/motorsport-fields.ts

# Treatment form (edit target)
@app/treatment/new.tsx

# Dashboard column that checks this field (confirms the bug)
@web/components/dashboard/treatments-columns.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add competitor_cleared_to_return checkbox to motorsport section</name>
  <files>
    app/treatment/new.tsx
  </files>
  <action>
**Location:** The checkbox goes AFTER the concussion clearance panel's closing `)}` (line 1110) and BEFORE the closing `</View>` of the motorsport section (line 1111). This means it is OUTSIDE the `{motorsportFields.concussion_suspected && (...)}` gate — it is visible for ALL motorsport treatments, not just concussion-suspected ones.

**What to add** (insert between lines 1110 and 1111):

```tsx
            {/* MOTO-07: Competitor clearance — outside concussion gate */}
            <Pressable
              style={[
                styles.clearanceCheckbox,
                motorsportFields.competitor_cleared_to_return && styles.clearanceCheckboxChecked,
              ]}
              onPress={() => toggleMotorsportBool('competitor_cleared_to_return')}
            >
              <Text style={[
                styles.clearanceCheckboxText,
                motorsportFields.competitor_cleared_to_return && styles.clearanceCheckboxTextChecked,
              ]}>
                {motorsportFields.competitor_cleared_to_return ? '[X] ' : '[ ] '}
                Competitor cleared to return to race
              </Text>
            </Pressable>
```

**Style reuse:** Uses the exact same styles as the 3 existing concussion checkboxes: `styles.clearanceCheckbox`, `styles.clearanceCheckboxChecked`, `styles.clearanceCheckboxText`, `styles.clearanceCheckboxTextChecked`. No new styles needed.

**Toggle helper reuse:** Uses the existing `toggleMotorsportBool('competitor_cleared_to_return')` — same helper used for all motorsport boolean fields.

**Payload inclusion — ALREADY HANDLED:** `competitor_cleared_to_return` is a property of `INITIAL_MOTORSPORT_FIELDS` (motorsport-fields.ts line 98), which means it is already part of the `motorsportFields` state object. `buildVerticalExtraFields()` at line 227-230 does `JSON.stringify(motorsportFields)`, which includes ALL fields from the state object. No change to `buildVerticalExtraFields()` is needed.

**Gate check — DO NOT MODIFY:** The concussion clearance gate at lines 420-431 checks ONLY `hia_conducted`, `competitor_stood_down`, `cmo_notified`. Do NOT add `competitor_cleared_to_return` to this gate. The competitor may not be cleared immediately; this field should be independently updatable after the concussion panel is complete.

**Indentation:** Match the indentation level of the concussion panel (12 spaces / 3 tabs). The Pressable is a direct child of the motorsport `<View>` section, at the same level as the concussion gate block.
  </action>
  <verify>
- `grep -n "competitor_cleared_to_return" app/treatment/new.tsx` — shows the new Pressable with toggleMotorsportBool call
- `grep -c "competitor_cleared_to_return" app/treatment/new.tsx` — count should be 3 (style condition, toggle call, text condition)
- `grep -A2 "Concussion Clearance Required" app/treatment/new.tsx` — gate still only mentions the 3 original checkboxes
- The new checkbox is NOT nested inside the `{motorsportFields.concussion_suspected && (` block
- `npx expo export --platform web 2>&1 | tail -5` — no build errors (or `npx tsc --noEmit` if available for RN)
  </verify>
  <done>
- Mobile treatment form displays "Competitor cleared to return to race" checkbox in the motorsport section
- The checkbox is visible for all motorsport treatments regardless of concussion_suspected state
- Toggling updates `motorsportFields.competitor_cleared_to_return` which is included in the save payload via `JSON.stringify(motorsportFields)`
- Concussion gate (lines 420-431) is unchanged — still only checks hia_conducted, competitor_stood_down, cmo_notified
- Dashboard "Concussion clearance required" badge (treatments-columns.tsx line 109) can now be resolved by a medic toggling this field
  </done>
</task>

</tasks>

<verification>
1. `grep "competitor_cleared_to_return" app/treatment/new.tsx` — field referenced in new checkbox
2. `grep "toggleMotorsportBool('competitor_cleared_to_return')" app/treatment/new.tsx` — toggle wired correctly
3. The new checkbox is positioned AFTER line 1110 (outside concussion gate) and BEFORE the section's closing `</View>`
4. `grep -B2 -A5 "hia_conducted.*competitor_stood_down.*cmo_notified" app/treatment/new.tsx` — gate unchanged, no reference to competitor_cleared_to_return
5. `buildVerticalExtraFields()` still does `JSON.stringify(motorsportFields)` — no modification needed since the field is already in the state shape
</verification>

<success_criteria>
- A motorsport treatment form shows a "Competitor cleared to return to race" checkbox that is independently toggleable
- The checkbox is NOT hidden behind the concussion_suspected gate — it appears for all motorsport treatments
- The field value persists in `vertical_extra_fields` JSON on save
- The concussion clearance gate logic is completely unchanged
- The dashboard "Concussion clearance required" badge can now be cleared because a medic can set `competitor_cleared_to_return = true`
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-heat-maps-and-trend-charts/23-07-SUMMARY.md`
</output>
