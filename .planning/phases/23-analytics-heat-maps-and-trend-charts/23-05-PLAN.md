---
phase: 23-analytics-heat-maps-and-trend-charts
plan: 05
type: execute
wave: 3
depends_on: ["23-01", "23-04"]
files_modified:
  - web/lib/queries/analytics/compliance-history.ts
  - web/components/analytics/AdminComplianceTrend.tsx
  - web/components/analytics/OrgComplianceTable.tsx
  - web/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "A platform admin can view aggregate compliance trends across all orgs"
    - "A platform admin can identify the top and bottom performing orgs by compliance score"
    - "The admin analytics page has a 'Compliance' tab showing aggregate trend + top/bottom orgs table"
  artifacts:
    - path: "web/lib/queries/analytics/compliance-history.ts"
      provides: "Admin-level query hooks for cross-org compliance data"
      exports: ["useComplianceHistory", "useIncidentFrequency", "useAdminComplianceTrend", "useOrgComplianceRanking"]
    - path: "web/components/analytics/AdminComplianceTrend.tsx"
      provides: "Recharts LineChart showing aggregate compliance across all orgs"
      exports: ["AdminComplianceTrend"]
    - path: "web/components/analytics/OrgComplianceTable.tsx"
      provides: "Table showing top/bottom orgs ranked by latest compliance score"
      exports: ["OrgComplianceTable"]
    - path: "web/app/admin/analytics/page.tsx"
      provides: "Compliance tab added to admin analytics tabbed interface"
      contains: "compliance"
  key_links:
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/analytics/AdminComplianceTrend.tsx"
      via: "dynamic import in ComplianceTab"
      pattern: "dynamic.*AdminComplianceTrend"
    - from: "web/components/analytics/AdminComplianceTrend.tsx"
      to: "web/lib/queries/analytics/compliance-history.ts"
      via: "useAdminComplianceTrend hook"
      pattern: "useAdminComplianceTrend"
    - from: "web/components/analytics/OrgComplianceTable.tsx"
      to: "web/lib/queries/analytics/compliance-history.ts"
      via: "useOrgComplianceRanking hook"
      pattern: "useOrgComplianceRanking"
---

<objective>
Create the platform admin compliance analytics — an aggregate compliance trend chart across all orgs and a top/bottom performing orgs table. Add a "Compliance" tab to the admin analytics page.

Purpose: Platform admins need cross-org compliance visibility to identify underperforming orgs needing intervention and recognize top performers. This closes ANLT-06.

Output: AdminComplianceTrend chart, OrgComplianceTable, admin query hooks, Compliance tab on admin analytics page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-RESEARCH.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-01-SUMMARY.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-04-SUMMARY.md

Key existing patterns:
@web/app/admin/analytics/page.tsx (existing tabbed admin analytics — modified in 23-03 with Heat Map tab)
@web/components/admin/revenue-charts.tsx (Recharts LineChart dark theme pattern)
@web/lib/queries/analytics/compliance-history.ts (created in 23-04 — add admin hooks)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin compliance query hooks to compliance-history.ts</name>
  <files>web/lib/queries/analytics/compliance-history.ts</files>
  <action>
    EDIT the existing file (created in 23-04) to add two new exported hooks.

    **Interface `AdminComplianceTrendPoint`:**
    - period_end: string (DATE)
    - avg_score: number (average across all orgs for that period)
    - org_count: number (how many orgs have data for that period)
    - min_score: number
    - max_score: number

    **Export `useAdminComplianceTrend()` hook:**
    - queryKey: ['admin-compliance-trend']
    - queryFn:
      1. Fetch all rows from compliance_score_history WHERE vertical = 'general', ORDER BY period_start ASC, LIMIT 2600 (52 weeks * 50 orgs max)
      2. Group by period_end client-side
      3. For each period_end, compute: avg_score (Math.round), org_count, min_score, max_score
      4. Return sorted chronologically, limited to last 52 periods
    - Platform admin RLS policy from 23-01 migration allows SELECT
    - staleTime: 10 * 60 * 1000
    - Returns { data: AdminComplianceTrendPoint[], isLoading, error }

    **Interface `OrgComplianceRanking`:**
    - org_id: string
    - org_name: string
    - latest_score: number
    - previous_score: number | null (for trend arrow)
    - trend: 'up' | 'down' | 'stable'

    **Export `useOrgComplianceRanking()` hook:**
    - queryKey: ['org-compliance-ranking']
    - queryFn:
      1. Fetch from compliance_score_history WHERE vertical = 'general', ORDER BY period_start DESC
      2. Group by org_id — take the two most recent scores per org (latest and previous)
      3. Fetch org names: query org_settings for all unique org_ids, selecting org_id and a name field. If org_settings has no name column, query organizations table instead for org names.
      4. Build ranking array with latest_score, previous_score, trend calculation:
         - trend = latest > previous ? 'up' : latest < previous ? 'down' : 'stable'
         - If no previous_score, trend = 'stable'
      5. Sort by latest_score descending (best performers first)
    - staleTime: 10 * 60 * 1000
    - Returns { data: OrgComplianceRanking[], isLoading, error }
  </action>
  <verify>
    grep for 'useAdminComplianceTrend' in compliance-history.ts — should appear as export.
    grep for 'useOrgComplianceRanking' in compliance-history.ts — should appear as export.
    grep for 'admin-compliance-trend' — should appear as queryKey.
    grep for 'org-compliance-ranking' — should appear as queryKey.
    Existing hooks (useComplianceHistory, useIncidentFrequency) still present and unchanged.
  </verify>
  <done>Two admin-level hooks provide aggregate compliance trend data and org-by-org ranking with trend indicators.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin compliance components + add Compliance tab to admin analytics</name>
  <files>web/components/analytics/AdminComplianceTrend.tsx, web/components/analytics/OrgComplianceTable.tsx, web/app/admin/analytics/page.tsx</files>
  <action>
    **File 1: web/components/analytics/AdminComplianceTrend.tsx**

    ```typescript
    'use client';
    import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Area } from 'recharts';
    import { useAdminComplianceTrend } from '@/lib/queries/analytics/compliance-history';
    ```

    Named export `AdminComplianceTrend`:
    - Uses useAdminComplianceTrend() hook
    - LineChart showing:
      - Main line: avg_score (stroke="#3B82F6", strokeWidth=2)
      - Optional shaded band between min_score and max_score (use Area with fillOpacity=0.1 to show the range)
    - XAxis: period_end formatted as "DD MMM"
    - YAxis: domain [0, 100]
    - Tooltip: shows avg score, min, max, org count for that period
    - CartesianGrid, ResponsiveContainer (height=400), dark theme styling
    - Handle empty/loading states

    **File 2: web/components/analytics/OrgComplianceTable.tsx**

    ```typescript
    'use client';
    import { useOrgComplianceRanking } from '@/lib/queries/analytics/compliance-history';
    import { ArrowUp, ArrowDown, Minus } from 'lucide-react';
    ```

    Named export `OrgComplianceTable`:
    - Uses useOrgComplianceRanking() hook
    - Dark themed table (bg-gray-800, border-gray-700) matching admin analytics page style
    - Two sections:
      1. "Top Performers" — first 5 orgs (highest scores) with green accent
      2. "Needs Improvement" — last 5 orgs (lowest scores) with red accent
    - Columns: Rank, Organisation, Score (with colour: green >=70, amber 40-69, red <40), Trend (arrow icon), Previous Score
    - Trend icons: ArrowUp (green) for 'up', ArrowDown (red) for 'down', Minus (gray) for 'stable'
    - Score displayed as "XX/100" with a subtle progress bar background
    - Handle empty state: "No compliance data available yet"
    - Handle loading: skeleton

    **File 3: web/app/admin/analytics/page.tsx (EDIT — add Compliance tab)**

    Note: This file was already modified in 23-03 to add the Heat Map tab. Now add a Compliance tab.

    1. Add dynamic imports:
    ```typescript
    const AdminComplianceTrendDynamic = dynamic(
      () => import('@/components/analytics/AdminComplianceTrend').then(m => ({ default: m.AdminComplianceTrend })),
      { ssr: false, loading: () => <div className="h-[400px] bg-gray-800 animate-pulse rounded-lg" /> }
    );
    const OrgComplianceTableDynamic = dynamic(
      () => import('@/components/analytics/OrgComplianceTable').then(m => ({ default: m.OrgComplianceTable })),
      { ssr: false, loading: () => <div className="h-[300px] bg-gray-800 animate-pulse rounded-lg" /> }
    );
    ```

    2. Add 'compliance' to activeTab union type (now includes: overview, medics, geofences, alerts, territory, assignments, utilisation, heat-map, compliance).

    3. Add 'compliance' to the tabs array and format label as "Compliance".

    4. Add 'compliance' to isNewTab check.

    5. Add Compliance tab content:
    ```typescript
    {activeTab === 'compliance' && (
      <div className="space-y-6">
        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h2 className="text-xl font-semibold mb-2">Aggregate Compliance Trend</h2>
          <p className="text-gray-400 text-sm mb-4">Average compliance score across all organisations over the last 12 months. Shaded area shows min-max range.</p>
          <AdminComplianceTrendDynamic />
        </div>
        <OrgComplianceTableDynamic />
      </div>
    )}
    ```
  </action>
  <verify>
    File web/components/analytics/AdminComplianceTrend.tsx exists and exports AdminComplianceTrend.
    File web/components/analytics/OrgComplianceTable.tsx exists and exports OrgComplianceTable.
    grep for 'compliance' in admin/analytics/page.tsx — should appear in tabs array and tab content.
    grep for 'AdminComplianceTrend' in admin/analytics/page.tsx — should appear in dynamic import.
    grep for 'OrgComplianceTable' in admin/analytics/page.tsx — should appear in dynamic import.
    Admin analytics page now has 9 tabs total (7 original + Heat Map from 23-03 + Compliance).
    grep for 'Top Performers' in OrgComplianceTable.tsx — should appear.
    grep for 'Needs Improvement' in OrgComplianceTable.tsx — should appear.
  </verify>
  <done>Admin analytics page has a Compliance tab showing aggregate trend chart and top/bottom orgs table. Platform admins can compare compliance performance across all organisations.</done>
</task>

</tasks>

<verification>
1. AdminComplianceTrend shows avg compliance score across all orgs as a line chart with min-max range band
2. OrgComplianceTable shows top 5 and bottom 5 orgs by latest compliance score with trend arrows
3. Admin analytics page has 9 tabs (7 original + Heat Map + Compliance)
4. Both components use dynamic({ ssr: false }) on the admin page
5. Data fetched from compliance_score_history using platform admin RLS policy (from 23-01 migration)
6. No new npm packages
</verification>

<success_criteria>
- Platform admin can click "Compliance" tab in admin analytics
- Aggregate trend chart shows average score across all orgs with min-max range shading
- Top/bottom performers table shows best and worst orgs with score, trend, and previous score
- Trend arrows indicate whether each org is improving or declining
- Data reads from compliance_score_history (populated by 23-01 upsert)
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-heat-maps-and-trend-charts/23-05-SUMMARY.md`
</output>
