---
phase: 23-analytics-heat-maps-and-trend-charts
plan: 03
type: execute
wave: 2
depends_on: ["23-02"]
files_modified:
  - web/components/analytics/AdminNearMissHeatMap.tsx
  - web/lib/queries/analytics/near-miss-geo.ts
  - web/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "A platform admin can view an aggregate near-miss heat map across all orgs"
    - "Each near-miss marker on the admin map is colour-coded by org (not severity)"
    - "The admin analytics page has a 'Heat Map' tab alongside existing tabs"
  artifacts:
    - path: "web/components/analytics/AdminNearMissHeatMap.tsx"
      provides: "Platform admin aggregate heat map with org colour-coding"
      min_lines: 60
    - path: "web/lib/queries/analytics/near-miss-geo.ts"
      provides: "Admin query hook fetching all orgs' near-miss GPS data"
      exports: ["useNearMissGeoData", "useAdminNearMissGeoData"]
    - path: "web/app/admin/analytics/page.tsx"
      provides: "Heat Map tab added to admin analytics tabbed interface"
      contains: "heat-map"
  key_links:
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/components/analytics/AdminNearMissHeatMap.tsx"
      via: "dynamic import in HeatMapTab"
      pattern: "dynamic.*AdminNearMissHeatMap"
    - from: "web/components/analytics/AdminNearMissHeatMap.tsx"
      to: "web/lib/queries/analytics/near-miss-geo.ts"
      via: "useAdminNearMissGeoData hook"
      pattern: "useAdminNearMissGeoData"
---

<objective>
Create the platform admin aggregate near-miss heat map — a CircleMarker-based Leaflet map showing near-misses from ALL orgs with org-based colour-coding. Add a "Heat Map" tab to the existing admin analytics page.

Purpose: Platform admins need cross-org visibility into geographic near-miss clustering to identify systemic safety issues and compare org safety performance geographically.

Output: AdminNearMissHeatMap component, admin query hook added to near-miss-geo.ts, Heat Map tab added to admin analytics page.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-RESEARCH.md
@.planning/phases/23-analytics-heat-maps-and-trend-charts/23-02-SUMMARY.md

Key existing patterns:
@web/app/admin/analytics/page.tsx (existing tabbed admin analytics — add Heat Map tab)
@web/components/admin/territory-map.tsx (CircleMarker + dynamic import pattern)
@web/lib/queries/analytics/near-miss-geo.ts (created in 23-02 — add admin hook)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin query hook to near-miss-geo.ts + create AdminNearMissHeatMap component</name>
  <files>web/lib/queries/analytics/near-miss-geo.ts, web/components/analytics/AdminNearMissHeatMap.tsx</files>
  <action>
    **File 1: web/lib/queries/analytics/near-miss-geo.ts (EDIT — add admin hook)**

    Add a new interface `AdminNearMissGeoPoint` extending the existing `NearMissGeoPoint` with:
    - org_id: string
    - org_name: string (from a join)

    Add exported hook `useAdminNearMissGeoData()`:
    - queryKey: ['admin-near-miss-geo']
    - queryFn: Fetches from supabase `near_misses` table
    - SELECT: id, gps_lat, gps_lng, severity, category, description, created_at, org_id
    - Also need org name — fetch via a join: `near_misses` has `org_id` column. Do a secondary query to `org_settings` to get org names for the unique org_ids returned, then map org names onto the geo points.
    - Alternative simpler approach: Use `.select('id, gps_lat, gps_lng, severity, category, description, created_at, org_id, organizations!inner(name)')` — but check if the FK exists. If not, do two queries: one for near_misses, one for org names by org_ids.
    - WHERE: gps_lat IS NOT NULL AND gps_lng IS NOT NULL AND deleted_at IS NULL
    - ORDER BY: created_at desc
    - LIMIT: 1000 (higher cap for admin aggregate view)
    - Platform admin RLS policy on near_misses already exists (migration 107)
    - staleTime: 5 * 60 * 1000
    - Returns { data, isLoading, error, orgColors } where orgColors is a Map<string, string> that assigns a distinct colour per org_id

    Org colour palette (cycle through for each unique org):
    ```typescript
    const ORG_COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];
    ```

    Build orgColors map: for each unique org_id in the data, assign colors[index % colors.length].

    **File 2: web/components/analytics/AdminNearMissHeatMap.tsx**

    Create a 'use client' component similar to NearMissHeatMap.tsx but:

    - Uses `useAdminNearMissGeoData()` hook instead of `useNearMissGeoData()`
    - CircleMarker color comes from orgColors map (by org_id), NOT from severity
    - CircleMarker radius still uses severity mapping (low=6, medium=10, high=14, critical=18) — size shows severity, colour shows org
    - fillOpacity: 0.6
    - Popup shows: Category, Severity badge, Org name (bold), Description (truncated 120 chars), Date

    Legend shows:
    - Org colour key (dynamic — each org gets its colour dot + org name)
    - Severity size key (small/medium/large/xlarge circles)

    Map setup identical to NearMissHeatMap: UK center, zoom 6, OpenStreetMap tiles, MapBoundsAdjuster.

    Handle empty/loading states same as org-level map.

    Export as default for dynamic import.
  </action>
  <verify>
    grep for 'useAdminNearMissGeoData' in near-miss-geo.ts — should appear as export.
    grep for 'ORG_COLORS' in near-miss-geo.ts — should appear.
    grep for 'useAdminNearMissGeoData' in AdminNearMissHeatMap.tsx — should appear.
    grep for 'org_name' or 'org_id' in AdminNearMissHeatMap.tsx — should appear (org-based colouring).
    AdminNearMissHeatMap.tsx uses CircleMarker, NOT leaflet.heat.
  </verify>
  <done>AdminNearMissHeatMap renders all orgs' near-misses with org-based colour-coding and severity-based sizing. Admin query hook fetches cross-org GPS data using platform admin RLS.</done>
</task>

<task type="auto">
  <name>Task 2: Add Heat Map tab to admin analytics page</name>
  <files>web/app/admin/analytics/page.tsx</files>
  <action>
    Edit the existing admin analytics page to add a "Heat Map" tab.

    1. Add dynamic import at top of file (alongside existing TerritoryMapDynamic):
    ```typescript
    const AdminNearMissHeatMapDynamic = dynamic(
      () => import('@/components/analytics/AdminNearMissHeatMap'),
      { ssr: false, loading: () => <div className="h-[500px] bg-gray-800 rounded-lg animate-pulse" /> }
    );
    ```

    2. Add 'heat-map' to the activeTab state union type — extend the existing type to include 'heat-map':
    ```typescript
    useState<'overview' | 'medics' | 'geofences' | 'alerts' | 'territory' | 'assignments' | 'utilisation' | 'heat-map'>('overview');
    ```

    3. Add 'heat-map' to the tabs array in the tab bar:
    ```typescript
    (['overview', 'medics', 'geofences', 'alerts', 'territory', 'assignments', 'utilisation', 'heat-map'] as const)
    ```

    4. Format the tab label — 'heat-map' should display as "Heat Map" (not "Heat-map"). Update the tab label rendering to handle hyphenated tab names:
    ```typescript
    {tab === 'heat-map' ? 'Heat Map' : tab.charAt(0).toUpperCase() + tab.slice(1)}
    ```

    5. Add 'heat-map' to the `isNewTab` check (line ~218) so it renders independently of legacy loading:
    ```typescript
    const isNewTab = activeTab === 'territory' || activeTab === 'assignments' || activeTab === 'utilisation' || activeTab === 'heat-map';
    ```

    6. Add the Heat Map tab content block after the Utilisation tab block:
    ```typescript
    {activeTab === 'heat-map' && (
      <div className="space-y-6">
        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h2 className="text-xl font-semibold mb-4">Near-Miss Heat Map (All Organisations)</h2>
          <p className="text-gray-400 text-sm mb-4">Geographic distribution of near-miss incidents across all organisations. Colour represents organisation, size represents severity.</p>
          <div className="h-[500px]">
            <AdminNearMissHeatMapDynamic />
          </div>
        </div>
      </div>
    )}
    ```
  </action>
  <verify>
    grep for 'heat-map' in admin/analytics/page.tsx — should appear multiple times (tab, content, isNewTab).
    grep for 'AdminNearMissHeatMap' in admin/analytics/page.tsx — should appear in dynamic import.
    grep for 'ssr: false' in admin/analytics/page.tsx — should appear for AdminNearMissHeatMap import.
    The existing 7 tabs still work (overview, medics, geofences, alerts, territory, assignments, utilisation).
  </verify>
  <done>Admin analytics page has a "Heat Map" tab showing the aggregate near-miss map across all orgs with org colour-coding.</done>
</task>

</tasks>

<verification>
1. AdminNearMissHeatMap uses CircleMarker (NOT leaflet.heat) — zero new dependencies
2. Admin heat map shows markers from ALL orgs (platform admin RLS on near_misses from migration 107)
3. Markers are colour-coded by org (not severity) with a dynamic legend
4. Marker SIZE still reflects severity (low=6, medium=10, high=14, critical=18)
5. Admin analytics page has 8 tabs total (7 existing + Heat Map)
6. Leaflet component is loaded with dynamic({ ssr: false })
</verification>

<success_criteria>
- Platform admin can click "Heat Map" tab in admin analytics
- Map shows near-miss incidents from all orgs
- Each org's incidents are a distinct colour with the org name in the legend
- Severity is conveyed through marker size
- Popup on click shows org name, category, severity, description, date
</success_criteria>

<output>
After completion, create `.planning/phases/23-analytics-heat-maps-and-trend-charts/23-03-SUMMARY.md`
</output>
