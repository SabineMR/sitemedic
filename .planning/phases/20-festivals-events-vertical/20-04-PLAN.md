---
phase: 20-festivals-events-vertical
plan: 04
type: execute
wave: 3
depends_on: ["20-03"]
files_modified:
  - web/components/dashboard/EventIncidentReportCard.tsx
  - web/lib/queries/event-incidents.ts
  - web/app/(dashboard)/treatments/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "A festivals treatment detail page shows a 'Purple Guide — Event Incident Report' download card"
    - "Clicking 'Generate Event Incident Report' button calls the Edge Function and opens the PDF in a new tab"
    - "A festivals treatment detail page shows 'Attendee Information' instead of 'Worker Information'"
    - "A non-festivals treatment detail page is unchanged — no download card, 'Worker Information' label preserved"
    - "The treatment detail page shows 'Event Organiser' instead of 'Client' for festivals treatments"
  artifacts:
    - path: "web/components/dashboard/EventIncidentReportCard.tsx"
      provides: "Client component with PDF generation button"
      exports: ["EventIncidentReportCard"]
      contains: "Purple Guide"
    - path: "web/lib/queries/event-incidents.ts"
      provides: "generateEventIncidentPDF query function calling the Edge Function"
      exports: ["generateEventIncidentPDF"]
      contains: "event-incident-report-generator"
    - path: "web/app/(dashboard)/treatments/[id]/page.tsx"
      provides: "Vertical-aware treatment detail with conditional PDF card and terminology"
      contains: "EventIncidentReportCard"
  key_links:
    - from: "web/components/dashboard/EventIncidentReportCard.tsx"
      to: "web/lib/queries/event-incidents.ts"
      via: "import { generateEventIncidentPDF }"
      pattern: "generateEventIncidentPDF"
    - from: "web/lib/queries/event-incidents.ts"
      to: "supabase/functions/event-incident-report-generator"
      via: "fetch to NEXT_PUBLIC_SUPABASE_URL/functions/v1/event-incident-report-generator"
      pattern: "event-incident-report-generator"
    - from: "web/app/(dashboard)/treatments/[id]/page.tsx"
      to: "web/components/dashboard/EventIncidentReportCard.tsx"
      via: "conditional render when treatment.event_vertical === 'festivals'"
      pattern: "EventIncidentReportCard"
---

<objective>
Wire the Purple Guide PDF download into the web dashboard treatment detail page. Create the EventIncidentReportCard client component, the generateEventIncidentPDF query function, and add vertical-aware terminology (Attendee/Venue/Organiser) to the treatment detail view.

Purpose: FEST-04 (terminology), FEST-06 (PDF download from dashboard) — the frontend that connects to the Plan 20-03 Edge Function.
Output: Dashboard treatment detail page conditionally shows Purple Guide download for festivals treatments with correct terminology.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-festivals-events-vertical/20-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generateEventIncidentPDF query function and EventIncidentReportCard component</name>
  <files>
    web/lib/queries/event-incidents.ts
    web/components/dashboard/EventIncidentReportCard.tsx
  </files>
  <action>
    **File 1: web/lib/queries/event-incidents.ts (CREATE)**

    Follow the pattern from `web/lib/queries/riddor.ts` for the `generateF2508PDF` function.

    First, read `web/lib/queries/riddor.ts` to get the exact import pattern for the Supabase client and auth session retrieval. Match that pattern exactly.

    ```typescript
    import { createBrowserClient } from '@supabase/ssr';

    const supabase = createBrowserClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    );

    export async function generateEventIncidentPDF(treatmentId: string): Promise<{
      success: boolean;
      pdf_path: string;
      signed_url: string;
    }> {
      const { data: { session } } = await supabase.auth.getSession();

      const response = await fetch(
        `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/event-incident-report-generator`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session?.access_token || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            incident_id: treatmentId,
            event_vertical: 'festivals',
          }),
        }
      );

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'Failed to generate Event Incident Report PDF');
      }

      return response.json();
    }
    ```

    IMPORTANT: The body key is `incident_id` (NOT `riddor_incident_id`). The value is a treatment UUID, not a riddor_incidents row.

    IMPORTANT: Check how the existing `web/lib/queries/riddor.ts` creates the Supabase client. If it uses a different pattern (e.g., imports from a shared client module), use that same pattern. Do NOT introduce a different client instantiation.

    **File 2: web/components/dashboard/EventIncidentReportCard.tsx (CREATE)**

    Follow the research document "Code Examples > Dashboard Event Incident Card". This is a `'use client'` component.

    ```typescript
    'use client';

    import { useState } from 'react';
    import { useMutation } from '@tanstack/react-query';
    import { Button } from '@/components/ui/button';
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
    import { FileText } from 'lucide-react';
    import { generateEventIncidentPDF } from '@/lib/queries/event-incidents';

    export function EventIncidentReportCard({ treatmentId }: { treatmentId: string }) {
      const [generating, setGenerating] = useState(false);

      const mutation = useMutation({
        mutationFn: async () => {
          setGenerating(true);
          return generateEventIncidentPDF(treatmentId);
        },
        onSuccess: (data) => {
          setGenerating(false);
          if (data.signed_url) window.open(data.signed_url, '_blank');
        },
        onError: () => {
          setGenerating(false);
          alert('Failed to generate Event Incident Report. Please try again.');
        },
      });

      return (
        <Card className="md:col-span-2">
          <CardHeader>
            <CardTitle>Purple Guide — Event Incident Report</CardTitle>
            <CardDescription>
              Patient contact log in Purple Guide format for submission to the event organiser
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => mutation.mutate()} disabled={generating}>
              {generating ? 'Generating...' : (
                <>
                  <FileText className="mr-2 h-4 w-4" />
                  Generate Event Incident Report
                </>
              )}
            </Button>
            <p className="text-xs text-muted-foreground mt-4">
              Generates a pre-filled Purple Guide Patient Contact Log PDF.
              Provide a copy to the event organiser as required.
            </p>
          </CardContent>
        </Card>
      );
    }
    ```

    IMPORTANT: Check that `@/components/ui/button`, `@/components/ui/card`, `lucide-react`, and `@tanstack/react-query` are already used in the codebase. Read a couple of existing dashboard components (like the RIDDOR page) to confirm import paths.
  </action>
  <verify>
    1. Read back both files and confirm content matches spec
    2. Confirm generateEventIncidentPDF sends `incident_id` (not `riddor_incident_id`) in the body
    3. Confirm EventIncidentReportCard is a 'use client' component
    4. Confirm imports resolve to existing libraries (no new packages needed)
  </verify>
  <done>
    - web/lib/queries/event-incidents.ts created with generateEventIncidentPDF function
    - web/components/dashboard/EventIncidentReportCard.tsx created as client component
    - Button click triggers PDF generation and opens signed URL in new tab
    - Error handling shows alert on failure
    - All imports use existing packages (no new dependencies)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire EventIncidentReportCard and vertical-aware terminology into treatment detail page</name>
  <files>web/app/(dashboard)/treatments/[id]/page.tsx</files>
  <action>
    Read `web/app/(dashboard)/treatments/[id]/page.tsx` in full first.

    Make three changes to this file:

    **Change 1: Import EventIncidentReportCard**

    Add at the top with other imports:
    ```typescript
    import { EventIncidentReportCard } from '@/components/dashboard/EventIncidentReportCard';
    ```

    Also import the patient label helper if it is not already imported. Check if `getPatientLabel` from `services/taxonomy/vertical-outcome-labels` is importable from the web app (it may be in a shared path, or may need a relative import). If the existing file uses a different pattern for vertical-aware labels, follow that pattern.

    **Change 2: Vertical-aware terminology**

    Find the hardcoded string `'Worker Information'` (research says line ~99). Replace with a conditional:
    ```typescript
    {treatment.event_vertical === 'festivals' ? 'Attendee Information' : 'Worker Information'}
    ```

    Find any reference to `'Client'` in the context of the booking/org and conditionally replace:
    ```typescript
    {treatment.event_vertical === 'festivals' ? 'Event Organiser' : 'Client'}
    ```

    If `'Worker'` appears as a standalone label elsewhere on the page, apply the same conditional pattern. Use `getPatientLabel(treatment.event_vertical)` if available, or inline the conditional.

    **Change 3: Conditional Purple Guide download card**

    After the existing cards (near the bottom of the page content, after the Signature section), add:
    ```tsx
    {treatment.event_vertical === 'festivals' && (
      <EventIncidentReportCard treatmentId={treatment.id} />
    )}
    ```

    This renders the download card ONLY for festivals treatments. Non-festivals treatments see no change.

    **IMPORTANT:**
    - The page is a server component. The `EventIncidentReportCard` is a client component. This is fine — server components can render client components as children. Do NOT add `'use client'` to the page.
    - If `treatment.event_vertical` is not available on the TypeScript type, check if the type needs updating. The `fetchTreatmentById` query uses `select('*, worker:workers(*)')` which returns all columns including `event_vertical`. If the TypeScript type `Treatment` or `TreatmentWithWorker` does not include `event_vertical`, add it. Check `web/types/database.types.ts` or wherever the type is defined.
    - Similarly, `vertical_extra_fields` should be on the type but is not needed for the dashboard card (only the Edge Function reads it).
  </action>
  <verify>
    1. Read back the modified page and confirm:
       - EventIncidentReportCard import exists
       - Conditional render for festivals treatments exists
       - 'Worker Information' is replaced with conditional 'Attendee Information' / 'Worker Information'
       - 'Client' is conditionally 'Event Organiser' for festivals
    2. Confirm the page does NOT have `'use client'` directive (remains a server component)
    3. Run: `npx tsc --noEmit 2>&1 | grep -i "treatments.*page" | head -10` — check for type errors
    4. Run: `git diff --name-only` — should show treatments/[id]/page.tsx, EventIncidentReportCard.tsx, event-incidents.ts
  </verify>
  <done>
    - Treatment detail page conditionally renders EventIncidentReportCard for festivals
    - 'Worker Information' becomes 'Attendee Information' for festivals (FEST-04)
    - 'Client' becomes 'Event Organiser' for festivals (FEST-04)
    - Non-festivals treatments are completely unchanged
    - Page remains a server component (client component is the card only)
    - No TypeScript errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Three new/modified files exist:
   - web/lib/queries/event-incidents.ts (new)
   - web/components/dashboard/EventIncidentReportCard.tsx (new)
   - web/app/(dashboard)/treatments/[id]/page.tsx (modified)
2. Festivals treatment detail page shows: "Attendee Information", "Event Organiser", Purple Guide download card
3. Non-festivals treatment detail page is unchanged: "Worker Information", "Client", no download card
4. `pnpm build` or `npx tsc --noEmit` passes with no new errors
</verification>

<success_criteria>
- FEST-04 satisfied: Dashboard shows "Attendee" instead of "Worker", "Organiser" instead of "Client" for festivals
- FEST-06 frontend satisfied: Event organiser can download Purple Guide PDF from treatment detail page
- No regression: Non-festivals treatments display exactly as before
- Clean separation: server component page renders client component card (no unnecessary client directive)
</success_criteria>

<output>
After completion, create `.planning/phases/20-festivals-events-vertical/20-04-SUMMARY.md`
</output>
