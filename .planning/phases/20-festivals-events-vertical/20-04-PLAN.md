---
phase: 20-festivals-events-vertical
plan: 04
type: execute
wave: 3
depends_on: ["20-03"]
files_modified:
  - web/components/dashboard/EventIncidentReportCard.tsx
  - web/lib/queries/event-incidents.ts
  - web/app/(dashboard)/treatments/[id]/page.tsx
  - web/app/medic/profile/page.tsx
  - web/types/database.types.ts  # only if event_vertical missing from Treatment type
autonomous: true

must_haves:
  truths:
    - "A festivals treatment detail page shows a 'Purple Guide — Event Incident Report' download card"
    - "Clicking 'Generate Event Incident Report' button calls the Edge Function and opens the PDF in a new tab"
    - "A festivals treatment detail page shows 'Attendee Information' instead of 'Worker Information'"
    - "A festivals treatment detail page shows 'Venue' instead of 'Site'"
    - "A non-festivals treatment detail page is unchanged — no download card, 'Worker Information' and 'Site' labels preserved"
    - "The treatment detail page shows 'Event Organiser' instead of 'Client' for festivals treatments"
    - "The medic profile cert types list shows the festivals vertical recommended certs including FREC 3, FREC 4, PHEC, ALS Provider, SIA Door Supervisor, and Purple Guide Certificate"
  artifacts:
    - path: "web/components/dashboard/EventIncidentReportCard.tsx"
      provides: "Client component with PDF generation button"
      exports: ["EventIncidentReportCard"]
      contains: "Purple Guide"
    - path: "web/lib/queries/event-incidents.ts"
      provides: "generateEventIncidentPDF query function calling the Edge Function"
      exports: ["generateEventIncidentPDF"]
      contains: "event-incident-report-generator"
    - path: "web/app/(dashboard)/treatments/[id]/page.tsx"
      provides: "Vertical-aware treatment detail with conditional PDF card, terminology, and Venue substitution"
      contains: "EventIncidentReportCard"
    - path: "web/app/medic/profile/page.tsx"
      provides: "Vertical-aware cert type ordering using getRecommendedCertTypes"
      contains: "getRecommendedCertTypes"
    - path: "web/types/database.types.ts"
      provides: "Treatment type with event_vertical field"
      contains: "event_vertical"
      conditional: "only modified if event_vertical missing from Treatment type"
  key_links:
    - from: "web/components/dashboard/EventIncidentReportCard.tsx"
      to: "web/lib/queries/event-incidents.ts"
      via: "import { generateEventIncidentPDF }"
      pattern: "generateEventIncidentPDF"
    - from: "web/lib/queries/event-incidents.ts"
      to: "supabase/functions/event-incident-report-generator"
      via: "fetch to NEXT_PUBLIC_SUPABASE_URL/functions/v1/event-incident-report-generator"
      pattern: "event-incident-report-generator"
    - from: "web/app/(dashboard)/treatments/[id]/page.tsx"
      to: "web/components/dashboard/EventIncidentReportCard.tsx"
      via: "conditional render when treatment.event_vertical === 'festivals'"
      pattern: "EventIncidentReportCard"
    - from: "web/app/medic/profile/page.tsx"
      to: "web/types/certification.types.ts"
      via: "import { getRecommendedCertTypes } and call with org vertical"
      pattern: "getRecommendedCertTypes"
---

<objective>
Wire the Purple Guide PDF download into the web dashboard treatment detail page. Create the EventIncidentReportCard client component, the generateEventIncidentPDF query function, add vertical-aware terminology (Attendee/Venue/Organiser) to the treatment detail view, and surface recommended cert types on the medic profile for festivals vertical.

Purpose: FEST-04 (terminology including Venue), FEST-05 (cert types), FEST-06 (PDF download from dashboard) — the frontend that connects to the Plan 20-03 Edge Function.
Output: Dashboard treatment detail page conditionally shows Purple Guide download for festivals treatments with correct terminology; medic profile shows recommended cert types for the active vertical.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-festivals-events-vertical/20-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generateEventIncidentPDF query function and EventIncidentReportCard component</name>
  <files>
    web/lib/queries/event-incidents.ts
    web/components/dashboard/EventIncidentReportCard.tsx
  </files>
  <action>
    **File 1: web/lib/queries/event-incidents.ts (CREATE)**

    Follow the pattern from `web/lib/queries/riddor.ts` for the `generateF2508PDF` function.

    First, read `web/lib/queries/riddor.ts` to get the exact import pattern for the Supabase client and auth session retrieval. Match that pattern exactly.

    ```typescript
    import { createBrowserClient } from '@supabase/ssr';

    const supabase = createBrowserClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    );

    export async function generateEventIncidentPDF(treatmentId: string): Promise<{
      success: boolean;
      pdf_path: string;
      signed_url: string;
    }> {
      const { data: { session } } = await supabase.auth.getSession();

      const response = await fetch(
        `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/event-incident-report-generator`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session?.access_token || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            incident_id: treatmentId,
            event_vertical: 'festivals',
          }),
        }
      );

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'Failed to generate Event Incident Report PDF');
      }

      return response.json();
    }
    ```

    IMPORTANT: The body key is `incident_id` (NOT `riddor_incident_id`). The value is a treatment UUID, not a riddor_incidents row.

    IMPORTANT: Check how the existing `web/lib/queries/riddor.ts` creates the Supabase client. If it uses a different pattern (e.g., imports from a shared client module), use that same pattern. Do NOT introduce a different client instantiation.

    **File 2: web/components/dashboard/EventIncidentReportCard.tsx (CREATE)**

    Follow the research document "Code Examples > Dashboard Event Incident Card". This is a `'use client'` component.

    ```typescript
    'use client';

    import { useState } from 'react';
    import { useMutation } from '@tanstack/react-query';
    import { Button } from '@/components/ui/button';
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
    import { FileText } from 'lucide-react';
    import { generateEventIncidentPDF } from '@/lib/queries/event-incidents';

    export function EventIncidentReportCard({ treatmentId }: { treatmentId: string }) {
      const [generating, setGenerating] = useState(false);

      const mutation = useMutation({
        mutationFn: async () => {
          setGenerating(true);
          return generateEventIncidentPDF(treatmentId);
        },
        onSuccess: (data) => {
          setGenerating(false);
          if (data.signed_url) window.open(data.signed_url, '_blank');
        },
        onError: () => {
          setGenerating(false);
          alert('Failed to generate Event Incident Report. Please try again.');
        },
      });

      return (
        <Card className="md:col-span-2">
          <CardHeader>
            <CardTitle>Purple Guide — Event Incident Report</CardTitle>
            <CardDescription>
              Patient contact log in Purple Guide format for submission to the event organiser
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => mutation.mutate()} disabled={generating}>
              {generating ? 'Generating...' : (
                <>
                  <FileText className="mr-2 h-4 w-4" />
                  Generate Event Incident Report
                </>
              )}
            </Button>
            <p className="text-xs text-muted-foreground mt-4">
              Generates a pre-filled Purple Guide Patient Contact Log PDF.
              Provide a copy to the event organiser as required.
            </p>
          </CardContent>
        </Card>
      );
    }
    ```

    IMPORTANT: Check that `@/components/ui/button`, `@/components/ui/card`, `lucide-react`, and `@tanstack/react-query` are already used in the codebase. Read a couple of existing dashboard components (like the RIDDOR page) to confirm import paths.
  </action>
  <verify>
    1. Read back both files and confirm content matches spec
    2. Confirm generateEventIncidentPDF sends `incident_id` (not `riddor_incident_id`) in the body
    3. Confirm EventIncidentReportCard is a 'use client' component
    4. Confirm imports resolve to existing libraries (no new packages needed)
  </verify>
  <done>
    - web/lib/queries/event-incidents.ts created with generateEventIncidentPDF function
    - web/components/dashboard/EventIncidentReportCard.tsx created as client component
    - Button click triggers PDF generation and opens signed URL in new tab
    - Error handling shows alert on failure
    - All imports use existing packages (no new dependencies)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire EventIncidentReportCard and vertical-aware terminology (including Venue) into treatment detail page</name>
  <files>
    web/app/(dashboard)/treatments/[id]/page.tsx
    web/types/database.types.ts
  </files>
  <action>
    **Step 0: Check and fix TypeScript Treatment type**

    Read `web/types/database.types.ts`. This file is hand-maintained (the header comment says "Manual type definitions matching the Supabase schema" — there is no @generated comment). It is safe to edit directly.

    If `event_vertical` is missing from the Treatment interface, add it:
    ```typescript
    event_vertical: string | null;
    ```
    This column was added in migration 124 (Phase 18) but the TypeScript type may not have been updated.

    Also check if `vertical_extra_fields` is on the type. If not, add it too:
    ```typescript
    vertical_extra_fields: Record<string, unknown> | null;
    ```

    ---

    Read `web/app/(dashboard)/treatments/[id]/page.tsx` in full first.

    Make four changes to this file:

    **Change 1: Import EventIncidentReportCard**

    Add at the top with other imports:
    ```typescript
    import { EventIncidentReportCard } from '@/components/dashboard/EventIncidentReportCard';
    ```

    Also import the patient label helper if it is not already imported. Check if `getPatientLabel` from `services/taxonomy/vertical-outcome-labels` is importable from the web app (it may be in a shared path, or may need a relative import). If the existing file uses a different pattern for vertical-aware labels, follow that pattern.

    **Change 2: Vertical-aware terminology — Worker/Attendee and Client/Organiser**

    Find the hardcoded string `'Worker Information'` (research says line ~99). Replace with a conditional:
    ```typescript
    {treatment.event_vertical === 'festivals' ? 'Attendee Information' : 'Worker Information'}
    ```

    Find any reference to `'Client'` in the context of the booking/org and conditionally replace:
    ```typescript
    {treatment.event_vertical === 'festivals' ? 'Event Organiser' : 'Client'}
    ```

    If `'Worker'` appears as a standalone label elsewhere on the page, apply the same conditional pattern. Use `getPatientLabel(treatment.event_vertical)` if available, or inline the conditional.

    **Change 3: Vertical-aware terminology — Site/Venue**

    Search the treatment detail page for any label containing `'Site'` (e.g., "Site Name", "Site Address", "Site"). Replace each with a conditional:
    ```typescript
    {treatment.event_vertical === 'festivals' ? 'Venue' : 'Site'}
    ```

    For compound labels like "Site Name", use:
    ```typescript
    {treatment.event_vertical === 'festivals' ? 'Venue Name' : 'Site Name'}
    ```

    WHY: FEST-04 explicitly requires "Venue" instead of "Site" for festivals. A festival medic should see "Venue: Glastonbury Main Stage" not "Site: Glastonbury Main Stage".

    **Change 4: Conditional Purple Guide download card**

    After the existing cards (near the bottom of the page content, after the Signature section), add:
    ```tsx
    {treatment.event_vertical === 'festivals' && (
      <EventIncidentReportCard treatmentId={treatment.id} />
    )}
    ```

    This renders the download card ONLY for festivals treatments. Non-festivals treatments see no change.

    **IMPORTANT:**
    - The page is a server component. The `EventIncidentReportCard` is a client component. This is fine — server components can render client components as children. Do NOT add `'use client'` to the page.
    - If `treatment.event_vertical` is not available on the TypeScript type, Step 0 above should have fixed it. If the `fetchTreatmentById` query uses `select('*, worker:workers(*)')` which returns all columns including `event_vertical`, the runtime data is there — we just need the type to reflect it.
  </action>
  <verify>
    1. Read back the modified page and confirm:
       - EventIncidentReportCard import exists
       - Conditional render for festivals treatments exists
       - 'Worker Information' is replaced with conditional 'Attendee Information' / 'Worker Information'
       - 'Site' labels are replaced with conditional 'Venue' / 'Site'
       - 'Client' is conditionally 'Event Organiser' for festivals
    2. Confirm the page does NOT have `'use client'` directive (remains a server component)
    3. If `web/types/database.types.ts` was modified, confirm `event_vertical` is on the Treatment type
    4. Run: `npx tsc --noEmit 2>&1 | grep -i "treatments.*page" | head -10` — check for type errors
    5. Run: `git diff --name-only` — should show treatments/[id]/page.tsx, EventIncidentReportCard.tsx, event-incidents.ts (and optionally database.types.ts)
  </verify>
  <done>
    - Treatment detail page conditionally renders EventIncidentReportCard for festivals
    - 'Worker Information' becomes 'Attendee Information' for festivals (FEST-04)
    - 'Site' becomes 'Venue' for festivals (FEST-04)
    - 'Client' becomes 'Event Organiser' for festivals (FEST-04)
    - Non-festivals treatments are completely unchanged
    - Page remains a server component (client component is the card only)
    - TypeScript Treatment type includes event_vertical (if it was missing, now fixed)
    - database.types.ts is hand-maintained (no @generated comment) — direct edit is safe
    - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Surface recommended cert types for festivals vertical on medic profile page</name>
  <files>web/app/medic/profile/page.tsx</files>
  <action>
    **FEST-05: Medic profile cert types should show the festivals vertical recommended certs.**

    The function `getRecommendedCertTypes('festivals')` already exists in `web/types/certification.types.ts`. It returns the `VERTICAL_CERT_TYPES.festivals` array first (FREC 3, FREC 4, PHEC, HCPC Paramedic, ALS Provider, PHTLS, AED Trained, SIA Door Supervisor, Purple Guide Certificate, Event Safety Awareness), followed by remaining cert types. These are plain strings (`UKCertType[]`), not objects.

    The medic profile page at `web/app/medic/profile/page.tsx` currently imports `CERT_TYPE_METADATA` but does NOT call `getRecommendedCertTypes`. It displays existing certifications but has no "Recommended Certifications" section.

    **Step 1: Determine the medic's org vertical**

    Read `web/app/medic/profile/page.tsx` in full. Identify how the medic's data is fetched (likely from `medics` table joined with org). Check if the org's vertical is already available on the medic record or if you need to fetch it separately.

    If the medic's org vertical is NOT already available:
    - Add a query to fetch the org's `industry_verticals` from `org_settings` using the medic's `org_id`
    - Extract `primaryVertical` as `industry_verticals?.[0] ?? 'general'`

    **Step 2: Import getRecommendedCertTypes**

    Add to the existing imports from `@/types/certification.types`:
    ```typescript
    import { CERT_TYPE_METADATA, getRecommendedCertTypes } from '@/types/certification.types';
    ```

    **Step 3: Add "Recommended Certifications" section**

    After the existing "Certifications" section (which shows the medic's current certs), add a new section that shows the vertical's recommended cert types:

    ```tsx
    {/* Recommended Certifications for Vertical */}
    {primaryVertical && primaryVertical !== 'general' && (
      <div className="bg-gray-800/50 border border-gray-700/50 rounded-2xl p-6">
        <h2 className="text-white font-semibold text-lg mb-2">
          Recommended Certifications
        </h2>
        <p className="text-sm text-gray-400 mb-4">
          Priority certifications for your organisation's vertical
        </p>
        <div className="flex flex-wrap gap-2">
          {getRecommendedCertTypes(primaryVertical).slice(0, 6).map((certType) => {
            const meta = CERT_TYPE_METADATA[certType];
            const alreadyHeld = (medic.certifications || []).some(
              (c) => c.type === certType
            );
            return (
              <span
                key={certType}
                className={`px-3 py-1.5 rounded-full text-sm ${
                  alreadyHeld
                    ? 'bg-green-500/20 text-green-400 border border-green-500/30'
                    : 'bg-gray-700/50 text-gray-300 border border-gray-600/30'
                }`}
              >
                {alreadyHeld && '✓ '}{meta?.label ?? certType}
              </span>
            );
          })}
        </div>
      </div>
    )}
    ```

    This shows the top 6 recommended cert types for the vertical as chips/badges. Certs the medic already holds are highlighted in green. Certs not yet held are shown in gray.

    **IMPORTANT:**
    - `getRecommendedCertTypes` returns `UKCertType[]` — a plain string array (e.g., `['FREC 3', 'FREC 4', ...]`), NOT objects. Use each string directly as the key and to look up metadata via `CERT_TYPE_METADATA[certType]`.
    - For festivals, the first 6 returned will be: FREC 3, FREC 4, PHEC, HCPC Paramedic, ALS Provider, PHTLS.
    - The medic profile is a `'use client'` component, so `getRecommendedCertTypes` (a pure function) can be called directly in the render.
    - Match the existing styling patterns (bg-gray-800/50, border-gray-700/50, rounded-2xl) from the page.
  </action>
  <verify>
    1. Read back `web/app/medic/profile/page.tsx` and confirm:
       - `getRecommendedCertTypes` is imported from `@/types/certification.types`
       - A "Recommended Certifications" section exists
       - The section is conditionally rendered (only for non-general verticals)
       - For festivals vertical, the top 6 certs (FREC 3, FREC 4, PHEC, HCPC Paramedic, ALS Provider, PHTLS) would appear
    2. Confirm no TypeScript errors: `npx tsc --noEmit 2>&1 | grep -i "profile/page" | head -10`
    3. Confirm the section styling matches existing page patterns
  </verify>
  <done>
    - Medic profile page imports and calls getRecommendedCertTypes with org vertical
    - "Recommended Certifications" section shows top 6 cert types for the active vertical
    - For festivals vertical: FREC 3, FREC 4, PHEC, HCPC Paramedic, ALS Provider, PHTLS appear prominently
    - Certs the medic already holds are highlighted in green
    - Section hidden for 'general' vertical (no visual change for non-vertical orgs)
    - FEST-05 requirement satisfied
  </done>
</task>

</tasks>

<verification>
After all three tasks complete:
1. Four new/modified files exist:
   - web/lib/queries/event-incidents.ts (new)
   - web/components/dashboard/EventIncidentReportCard.tsx (new)
   - web/app/(dashboard)/treatments/[id]/page.tsx (modified)
   - web/app/medic/profile/page.tsx (modified)
   - web/types/database.types.ts (conditionally modified)
2. Festivals treatment detail page shows: "Attendee Information", "Venue", "Event Organiser", Purple Guide download card
3. Non-festivals treatment detail page is unchanged: "Worker Information", "Site", "Client", no download card
4. Medic profile for festivals org shows FREC 3, FREC 4, PHEC, HCPC Paramedic, ALS Provider, PHTLS in recommended certs section
5. `pnpm build` or `npx tsc --noEmit` passes with no new errors
</verification>

<success_criteria>
- FEST-04 satisfied: Dashboard shows "Attendee" instead of "Worker", "Venue" instead of "Site", "Organiser" instead of "Client" for festivals
- FEST-05 satisfied: Medic profile cert types list shows festivals vertical recommended certs (FREC 3, FREC 4, PHEC, HCPC Paramedic, ALS Provider, PHTLS) — all actual entries from VERTICAL_CERT_TYPES.festivals
- FEST-06 frontend satisfied: Event organiser can download Purple Guide PDF from treatment detail page
- No regression: Non-festivals treatments display exactly as before
- Clean separation: server component page renders client component card (no unnecessary client directive)
</success_criteria>

<output>
After completion, create `.planning/phases/20-festivals-events-vertical/20-04-SUMMARY.md`
</output>
