---
phase: 20-festivals-events-vertical
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  # These files are only modified if a gap is found; expected outcome is read-only (no changes)
  - supabase/functions/riddor-detector/index.ts        # only if 'festivals' missing from NON_RIDDOR_VERTICALS
  - supabase/functions/riddor-f2508-generator/index.ts  # only if 'festivals' missing from NON_RIDDOR_VERTICALS
  - services/taxonomy/vertical-compliance.ts            # only if festivals.riddorApplies is not false
autonomous: true

must_haves:
  truths:
    - "The string 'festivals' appears in NON_RIDDOR_VERTICALS array in riddor-detector/index.ts"
    - "A festivals treatment causes riddor-detector to return { detected: false } before any RIDDOR logic runs"
    - "The string 'festivals' appears in NON_RIDDOR_VERTICALS array in riddor-f2508-generator/index.ts"
    - "A festivals treatment causes riddor-f2508-generator to return HTTP 400"
    - "VERTICAL_COMPLIANCE.festivals.riddorApplies is false in vertical-compliance.ts"
  artifacts:
    # Conditional artifacts — only modified if gap fix executes; otherwise verified read-only
    - path: "supabase/functions/riddor-detector/index.ts"
      provides: "NON_RIDDOR_VERTICALS array including 'festivals'"
      contains: "festivals"
      conditional: "only modified if 'festivals' missing from array"
    - path: "supabase/functions/riddor-f2508-generator/index.ts"
      provides: "NON_RIDDOR_VERTICALS array including 'festivals'"
      contains: "festivals"
      conditional: "only modified if 'festivals' missing from array"
    - path: "services/taxonomy/vertical-compliance.ts"
      provides: "VERTICAL_COMPLIANCE.festivals config with riddorApplies: false"
      contains: "riddorApplies"
      conditional: "only modified if riddorApplies is not false"
  key_links:
    - from: "supabase/functions/riddor-detector/index.ts"
      to: "NON_RIDDOR_VERTICALS array"
      via: "array.includes check before detectRIDDOR() call"
      pattern: "NON_RIDDOR_VERTICALS.*festivals"
    - from: "supabase/functions/riddor-f2508-generator/index.ts"
      to: "NON_RIDDOR_VERTICALS array"
      via: "array.includes validation returning HTTP 400"
      pattern: "NON_RIDDOR_VERTICALS.*festivals"
---

<objective>
Verify (do NOT rebuild) that the Phase 18 RIDDOR gate is active for the festivals vertical. Confirm `festivals` is in the `NON_RIDDOR_VERTICALS` array in both `riddor-detector` and `riddor-f2508-generator`. Confirm `VERTICAL_COMPLIANCE.festivals.riddorApplies` is `false`. No code changes expected.

Purpose: FEST-03 — regression verification that festival-goer treatments never trigger RIDDOR. This is a read-only verification plan.
Output: Confirmation that the gate is live, or identification of gaps requiring a fix task.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-vertical-infrastructure-riddor-fix/18-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify RIDDOR gate includes 'festivals' in both Edge Functions and vertical-compliance config</name>
  <files>
    supabase/functions/riddor-detector/index.ts
    supabase/functions/riddor-f2508-generator/index.ts
    services/taxonomy/vertical-compliance.ts
  </files>
  <action>
    This is a READ-ONLY verification task. Do NOT modify any files unless a gap is found.

    **Step 1: Verify riddor-detector gate**
    Read `supabase/functions/riddor-detector/index.ts` and confirm:
    - `NON_RIDDOR_VERTICALS` array exists (expected at lines 74-99)
    - `'festivals'` is included in the array
    - The gate uses `NON_RIDDOR_VERTICALS.includes(effectiveVertical)` to early-return `{ detected: false }`
    - The early return happens BEFORE `detectRIDDOR()` is called

    **Step 2: Verify riddor-f2508-generator validation**
    Read `supabase/functions/riddor-f2508-generator/index.ts` and confirm:
    - `NON_RIDDOR_VERTICALS` array exists (expected at lines 102-110)
    - `'festivals'` is included in the array
    - The validation returns HTTP 400 for non-RIDDOR verticals

    **Step 3: Verify vertical-compliance config**
    Read `services/taxonomy/vertical-compliance.ts` and confirm:
    - `VERTICAL_COMPLIANCE.festivals` entry exists
    - `riddorApplies` is `false`
    - `primaryFramework` is `'purple_guide'`

    **Step 4: If all three verifications pass**
    Report: "RIDDOR gate verified — no code changes needed."

    **Step 5: If ANY verification fails**
    Fix the specific gap:
    - If `'festivals'` is missing from a NON_RIDDOR_VERTICALS array, add it
    - If `riddorApplies` is not `false`, correct it
    - Document any fix in the summary
  </action>
  <verify>
    Run these grep commands to confirm (all should return matches):
    1. `grep -n "festivals" supabase/functions/riddor-detector/index.ts` — at least 1 match
    2. `grep -n "festivals" supabase/functions/riddor-f2508-generator/index.ts` — at least 1 match
    3. `grep -n "riddorApplies.*false" services/taxonomy/vertical-compliance.ts` — at least 1 match in festivals block
    4. `grep -n "NON_RIDDOR_VERTICALS" supabase/functions/riddor-detector/index.ts` — confirms array exists
    5. `grep -n "detected.*false" supabase/functions/riddor-detector/index.ts` — confirms early return
    6. `git diff --name-only` — should show NO changes (read-only task)
  </verify>
  <done>
    Path A (clean — expected):
    - All 5 grep checks returned matches
    - 'festivals' confirmed in both NON_RIDDOR_VERTICALS arrays
    - VERTICAL_COMPLIANCE.festivals.riddorApplies confirmed as false
    - RIDDOR gate returns { detected: false } before detectRIDDOR() runs for festivals
    - F2508 generator returns HTTP 400 for festivals vertical
    - Zero files modified

    Path B (gap found and fixed):
    - List each file changed with the specific line added/modified
    - Re-run all 5 grep checks — all now pass
    - 'festivals' now in both NON_RIDDOR_VERTICALS arrays
    - VERTICAL_COMPLIANCE.festivals.riddorApplies now false
    - Gap fix documented in summary with file paths and line numbers
    - Gap fix committed with note in summary
  </done>
</task>

</tasks>

<verification>
After task completion:
1. All 5 grep checks return matches
2. No files were modified (unless a gap was found and fixed)
3. FEST-03 requirement is satisfied: festival-goer treatments never produce a RIDDOR flag
</verification>

<success_criteria>
- FEST-03 verified: The RIDDOR detector gate returns { detected: false } for festivals before any RIDDOR logic executes
- F2508 generator returns HTTP 400 if called with a festivals treatment (defense in depth)
- VERTICAL_COMPLIANCE.festivals.riddorApplies is false (vertical config is consistent with the runtime gate)
- Zero code changes (ideal) or minimal targeted fix (if gap found)
</success_criteria>

<output>
After completion, create `.planning/phases/20-festivals-events-vertical/20-02-SUMMARY.md`
</output>
