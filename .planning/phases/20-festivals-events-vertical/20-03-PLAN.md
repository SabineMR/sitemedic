---
phase: 20-festivals-events-vertical
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - supabase/functions/event-incident-report-generator/index.ts
  - supabase/functions/event-incident-report-generator/types.ts
  - supabase/functions/event-incident-report-generator/PurpleGuideDocument.tsx
  - supabase/functions/event-incident-report-generator/purple-guide-mapping.ts
  - supabase/migrations/125_event_incident_reports_storage.sql
autonomous: true

must_haves:
  truths:
    - "Calling the event-incident-report-generator Edge Function with a valid treatment ID and event_vertical 'festivals' returns a signed URL to a Purple Guide PDF"
    - "The generated PDF contains the triage priority (P1/P2/P3/P4) with a colour-coded badge"
    - "The generated PDF contains the alcohol/substance and safeguarding flags"
    - "The generated PDF contains the attendee disposition"
    - "The generated PDF has the title 'Purple Guide — Patient Contact Log'"
    - "The PDF is stored in the 'event-incident-reports' Supabase Storage bucket"
    - "Missing triage data does not crash the PDF generator — it renders a default value"
  artifacts:
    - path: "supabase/functions/event-incident-report-generator/index.ts"
      provides: "Full PDF generation flow replacing 501 stub"
      contains: "renderToBuffer"
    - path: "supabase/functions/event-incident-report-generator/PurpleGuideDocument.tsx"
      provides: "React-PDF document component for Purple Guide Patient Contact Log"
      contains: "Purple Guide"
    - path: "supabase/functions/event-incident-report-generator/purple-guide-mapping.ts"
      provides: "Maps treatment DB row to PurpleGuideData interface"
      exports: ["mapTreatmentToPurpleGuide"]
    - path: "supabase/functions/event-incident-report-generator/types.ts"
      provides: "PurpleGuideData interface"
      contains: "triageCategory"
    - path: "supabase/migrations/125_event_incident_reports_storage.sql"
      provides: "Storage bucket for event incident report PDFs"
      contains: "event-incident-reports"
  key_links:
    - from: "supabase/functions/event-incident-report-generator/index.ts"
      to: "supabase/functions/event-incident-report-generator/PurpleGuideDocument.tsx"
      via: "renderToBuffer(<PurpleGuideDocument data={...} />)"
      pattern: "renderToBuffer"
    - from: "supabase/functions/event-incident-report-generator/index.ts"
      to: "supabase/functions/event-incident-report-generator/purple-guide-mapping.ts"
      via: "mapTreatmentToPurpleGuide(treatment) call"
      pattern: "mapTreatmentToPurpleGuide"
    - from: "supabase/functions/event-incident-report-generator/index.ts"
      to: "storage bucket 'event-incident-reports'"
      via: "supabase.storage.from('event-incident-reports').upload()"
      pattern: "event-incident-reports"
---

<objective>
Replace the 501 stub in the event-incident-report-generator Edge Function with a real Purple Guide PDF generation flow. Create the PurpleGuideDocument React-PDF component, the treatment-to-PDF mapping function, and the storage bucket migration.

Purpose: FEST-06 — the event organiser can download a Purple Guide-format event incident report PDF per treatment. This is the backend that Plan 20-04 (dashboard download card) will call.
Output: Fully functional Edge Function + storage bucket + Purple Guide PDF template.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-festivals-events-vertical/20-RESEARCH.md
@.planning/phases/18-vertical-infrastructure-riddor-fix/18-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PurpleGuideDocument.tsx, purple-guide-mapping.ts, update types.ts, and create storage migration</name>
  <files>
    supabase/functions/event-incident-report-generator/PurpleGuideDocument.tsx
    supabase/functions/event-incident-report-generator/purple-guide-mapping.ts
    supabase/functions/event-incident-report-generator/types.ts
    supabase/migrations/125_event_incident_reports_storage.sql
  </files>
  <action>
    **File 1: types.ts (MODIFY — add PurpleGuideData interface)**

    Read the existing `types.ts` first. Keep the existing `EventIncidentData` interface. Add the `PurpleGuideData` interface:

    ```typescript
    export interface PurpleGuideData {
      // Header
      organisationName: string;
      eventName: string;
      eventDate: string;
      reportGeneratedAt: string;

      // Patient Contact Log
      patientIdentifier: string;
      timeOfPresentation: string;

      // Triage
      triageCategory: 'P1' | 'P2' | 'P3' | 'P4';
      triageLabel: string;

      // Complaint & Mechanism
      presentingComplaint: string;
      mechanismOfInjury: string;

      // Treatment
      treatmentGiven: string[];
      treatmentNotes: string;

      // Flags
      alcoholSubstanceInvolvement: boolean;
      safeguardingConcern: boolean;

      // Disposition
      disposition: 'discharged_on_site' | 'transferred_to_hospital' | 'refused_treatment';
      dispositionLabel: string;

      // Medic
      medicName: string;
      referenceNumber: string;
    }
    ```

    **File 2: PurpleGuideDocument.tsx (CREATE)**

    Follow the F2508Document.tsx pattern exactly for imports:
    ```typescript
    import React from 'npm:react@18.3.1';
    import { Document, Page, Text, View, StyleSheet } from 'npm:@react-pdf/renderer@4.3.2';
    import type { PurpleGuideData } from './types.ts';
    ```

    Use the complete component from the research document "Code Examples > Purple Guide PDF Document Component". Key details:
    - Title: `'Purple Guide — Patient Contact Log'`
    - Subtitle: `'Events Industry Forum — Health, Safety and Welfare at Events'`
    - Header colour: `#6B21A8` (purple) — NOT `#003366` (that's the F2508)
    - Triage badge: coloured background (P1=#DC2626 Red, P2=#F59E0B Yellow, P3=#22C55E Green, P4=#1F2937 Black)
    - 6 sections: Patient Identifier, Presenting Complaint, Treatment Given, Flags, Attendee Disposition, Attending Medic
    - Footer references SiteMedic and Purple Guide framework

    **File 3: purple-guide-mapping.ts (CREATE)**

    Maps a Supabase treatment row (with joins) to `PurpleGuideData`:

    ```typescript
    import type { PurpleGuideData } from './types.ts';

    const TRIAGE_LABELS: Record<string, string> = {
      P1: 'P1 — Immediate (Red)',
      P2: 'P2 — Urgent (Yellow)',
      P3: 'P3 — Delayed (Green)',
      P4: 'P4 — Expectant (Black/Blue)',
    };

    const DISPOSITION_LABELS: Record<string, string> = {
      discharged_on_site: 'Discharged on site',
      transferred_to_hospital: 'Transferred to hospital',
      refused_treatment: 'Refused treatment',
    };

    export function mapTreatmentToPurpleGuide(treatment: any): PurpleGuideData {
      // Parse vertical_extra_fields — may be a JSON string or already an object
      let fields: any = {};
      if (treatment.vertical_extra_fields) {
        fields = typeof treatment.vertical_extra_fields === 'string'
          ? JSON.parse(treatment.vertical_extra_fields)
          : treatment.vertical_extra_fields;
      }

      const triageKey = fields?.triage_priority ?? 'P3';

      return {
        organisationName: treatment.org_settings?.company_name ?? 'Unknown Organisation',
        eventName: treatment.bookings?.event_name ?? treatment.org_settings?.company_name ?? 'Event',
        eventDate: treatment.treatment_date
          ? new Date(treatment.treatment_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })
          : 'Date not recorded',
        reportGeneratedAt: new Date().toISOString(),

        patientIdentifier: treatment.workers
          ? `${treatment.workers.first_name ?? ''} ${treatment.workers.last_name ?? ''}`.trim() || 'Unnamed attendee'
          : `Ref: ${treatment.reference_number ?? 'N/A'}`,
        timeOfPresentation: treatment.treatment_time ?? 'Not recorded',

        triageCategory: triageKey as PurpleGuideData['triageCategory'],
        triageLabel: TRIAGE_LABELS[triageKey] ?? `${triageKey} — Triage not recorded`,

        presentingComplaint: treatment.presenting_complaint ?? treatment.injury_description ?? '',
        mechanismOfInjury: treatment.mechanism_of_injury ?? '',

        treatmentGiven: treatment.treatment_types
          ? (Array.isArray(treatment.treatment_types) ? treatment.treatment_types : [treatment.treatment_types])
          : ['No treatment types recorded'],
        treatmentNotes: treatment.treatment_notes ?? '',

        alcoholSubstanceInvolvement: fields?.alcohol_substance ?? false,
        safeguardingConcern: fields?.safeguarding_concern ?? false,

        disposition: fields?.disposition ?? 'discharged_on_site',
        dispositionLabel: DISPOSITION_LABELS[fields?.disposition] ?? 'Disposition not recorded',

        medicName: treatment.medics
          ? `${treatment.medics.first_name ?? ''} ${treatment.medics.last_name ?? ''}`.trim() || 'Unknown medic'
          : 'Unknown medic',
        referenceNumber: treatment.reference_number ?? 'N/A',
      };
    }
    ```

    Handle null/missing fields gracefully with defaults — do NOT crash if `vertical_extra_fields` is null (legacy treatments, or data not yet synced).

    **File 4: 125_event_incident_reports_storage.sql (CREATE)**

    Follow the pattern from `supabase/migrations/019_riddor_reports_storage.sql`:

    ```sql
    -- Migration 125: Create storage bucket for event incident report PDFs
    -- Phase 20: Festivals & Events Vertical

    INSERT INTO storage.buckets (id, name, public)
    VALUES ('event-incident-reports', 'event-incident-reports', false)
    ON CONFLICT (id) DO NOTHING;

    -- RLS policies for event-incident-reports bucket
    -- Service role can upload (Edge Function uses service role key)
    CREATE POLICY "Service role can upload event incident reports"
    ON storage.objects FOR INSERT
    TO service_role
    WITH CHECK (bucket_id = 'event-incident-reports');

    -- Authenticated users can read their org's reports
    CREATE POLICY "Authenticated users can read event incident reports"
    ON storage.objects FOR SELECT
    TO authenticated
    USING (bucket_id = 'event-incident-reports');
    ```

    Note: Check the exact RLS pattern used in `019_riddor_reports_storage.sql` and follow it. If the existing pattern is different from above, use the existing pattern.
  </action>
  <verify>
    1. Read back all 4 files and confirm content matches spec
    2. Confirm types.ts has both EventIncidentData and PurpleGuideData interfaces
    3. Confirm PurpleGuideDocument.tsx imports from npm:react and npm:@react-pdf/renderer (Deno patterns)
    4. Confirm purple-guide-mapping.ts handles null vertical_extra_fields without crashing
    5. Confirm migration 125 creates the storage bucket
  </verify>
  <done>
    - types.ts has PurpleGuideData interface with all fields (triage, flags, disposition, medic)
    - PurpleGuideDocument.tsx is a valid React-PDF component with purple header, triage badge, 6 sections
    - purple-guide-mapping.ts exports mapTreatmentToPurpleGuide with graceful null handling
    - Migration 125 creates event-incident-reports storage bucket with RLS policies
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace 501 stub in index.ts with full PDF generation flow</name>
  <files>supabase/functions/event-incident-report-generator/index.ts</files>
  <action>
    Read the existing `index.ts` (currently a 501 stub). Replace the stub response block with the full PDF generation flow.

    Keep the existing:
    - CORS headers
    - OPTIONS handler
    - body parsing
    - incident_id validation
    - event_vertical validation against EVENT_VERTICALS

    Replace the `// Phase 19+: PDF generation will be implemented here.` block and the 501 response with:

    ```typescript
    // Full flow (replaces 501 stub):
    // 1. Create Supabase client with service role key
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    // 2. Fetch treatment with joins
    const { data: treatment, error: fetchError } = await supabase
      .from('treatments')
      .select(`*, medics(first_name, last_name), org_settings!treatments_org_id_fkey(company_name), workers(first_name, last_name)`)
      .eq('id', body.incident_id)
      .single();

    if (fetchError || !treatment) {
      return new Response(
        JSON.stringify({ error: 'Treatment not found', details: fetchError?.message }),
        { status: 404, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
      );
    }

    // 3. Map treatment to Purple Guide data
    const purpleGuideData = mapTreatmentToPurpleGuide(treatment);

    // 4. Render PDF
    const pdfBuffer = await renderToBuffer(
      React.createElement(PurpleGuideDocument, {
        data: purpleGuideData,
        generatedAt: new Date().toLocaleDateString('en-GB', {
          day: 'numeric', month: 'long', year: 'numeric',
          hour: '2-digit', minute: '2-digit',
        }),
      })
    );

    // 5. Upload to storage
    const fileName = `${treatment.org_id}/${body.incident_id}/PurpleGuide-${Date.now()}.pdf`;
    const { error: uploadError } = await supabase.storage
      .from('event-incident-reports')
      .upload(fileName, pdfBuffer, {
        contentType: 'application/pdf',
        upsert: true,
      });

    if (uploadError) {
      console.error('Storage upload error:', uploadError);
      return new Response(
        JSON.stringify({ error: 'Failed to upload PDF', details: uploadError.message }),
        { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
      );
    }

    // 6. Create signed URL (7-day expiry)
    const { data: signedUrlData, error: signedUrlError } = await supabase.storage
      .from('event-incident-reports')
      .createSignedUrl(fileName, 60 * 60 * 24 * 7); // 7 days

    if (signedUrlError) {
      console.error('Signed URL error:', signedUrlError);
      return new Response(
        JSON.stringify({ error: 'PDF uploaded but failed to create signed URL' }),
        { status: 500, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
      );
    }

    // 7. Return success
    return new Response(
      JSON.stringify({
        success: true,
        pdf_path: fileName,
        signed_url: signedUrlData?.signedUrl,
      }),
      { status: 200, headers: { 'Content-Type': 'application/json', ...corsHeaders } }
    );
    ```

    Add these imports at the top of the file (alongside the existing ones):
    ```typescript
    import React from 'npm:react@18.3.1';
    import { renderToBuffer } from 'npm:@react-pdf/renderer@4.3.2';
    import { PurpleGuideDocument } from './PurpleGuideDocument.tsx';
    import { mapTreatmentToPurpleGuide } from './purple-guide-mapping.ts';
    ```

    The existing `import type { EventIncidentData }` can remain — it's used for the body type.

    **IMPORTANT:**
    - The body param is `incident_id` (NOT `riddor_incident_id`) — this is the treatment UUID
    - Follow the exact `renderToBuffer` + `storage.upload` + `createSignedUrl` pattern from `riddor-f2508-generator/index.ts`
    - The join on `org_settings` uses the FK alias `treatments_org_id_fkey` — check the actual FK name in the existing F2508 generator to be sure and match it. If F2508 uses a different join syntax, copy that syntax.
    - Use `Deno.env.get('SUPABASE_URL')` and `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')` — same as F2508 generator
  </action>
  <verify>
    1. Read back `index.ts` and confirm:
       - No 501 response remains
       - renderToBuffer import is present
       - PurpleGuideDocument import is present
       - mapTreatmentToPurpleGuide import is present
       - Treatment fetch with joins exists
       - Storage upload to 'event-incident-reports' bucket
       - Signed URL creation with 7-day expiry
       - Returns { success: true, pdf_path, signed_url } on success
    2. Confirm CORS headers and OPTIONS handler are preserved
    3. Confirm incident_id and event_vertical validation is preserved
  </verify>
  <done>
    - 501 stub replaced with full PDF generation flow
    - Treatment fetched from DB with medics, org_settings, and workers joins
    - vertical_extra_fields parsed and mapped to PurpleGuideData
    - PDF rendered via renderToBuffer with PurpleGuideDocument component
    - PDF uploaded to event-incident-reports storage bucket
    - 7-day signed URL returned to caller
    - Error handling for fetch, upload, and signed URL failures
    - Backwards compatible: CORS, body validation, and error handling preserved
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All 5 files exist and have correct content:
   - types.ts: PurpleGuideData interface
   - PurpleGuideDocument.tsx: React-PDF component
   - purple-guide-mapping.ts: mapTreatmentToPurpleGuide function
   - index.ts: full PDF flow (no 501)
   - 125_event_incident_reports_storage.sql: bucket creation
2. No other files modified: `git diff --name-only` shows only the 5 files above
3. All Deno imports use `npm:` prefix (not bare specifiers)
4. purple-guide-mapping.ts handles null vertical_extra_fields without crashing
</verification>

<success_criteria>
- FEST-06 backend satisfied: event-incident-report-generator Edge Function produces a Purple Guide PDF
- PDF includes triage priority with colour badge, alcohol/substance flag, safeguarding flag, and disposition
- PDF is stored in Supabase Storage bucket with signed URL for download
- Graceful handling of missing data (defaults, not crashes)
- Storage bucket created via migration 125 with proper RLS policies
- No regression to existing Edge Functions (RIDDOR, dispatcher)
</success_criteria>

<output>
After completion, create `.planning/phases/20-festivals-events-vertical/20-03-SUMMARY.md`
</output>
