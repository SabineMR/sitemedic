---
phase: 20-festivals-events-vertical
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/treatment/new.tsx
autonomous: true

must_haves:
  truths:
    - "A medic with orgVertical 'festivals' sees a TST Triage Priority picker (P1/P2/P3/P4) in the treatment form"
    - "A medic with orgVertical 'festivals' sees an Alcohol/Substance Involvement toggle on the form"
    - "A medic with orgVertical 'festivals' sees a Safeguarding Concern toggle on the form"
    - "A medic with orgVertical 'festivals' sees an Attendee Disposition picker on the form"
    - "The form cannot be completed without selecting a triage priority when orgVertical is 'festivals'"
    - "The form cannot be completed without selecting a disposition when orgVertical is 'festivals'"
    - "All four festival fields are written to verticalExtraFields as a JSON string in the enqueueSyncItem payload"
    - "Selecting a RIDDOR-reportable injury type when orgVertical is 'festivals' does NOT show the RIDDOR warning banner"
    - "Selecting a RIDDOR-reportable injury type when orgVertical is 'construction', 'tv_film', or 'general' STILL shows the RIDDOR warning banner"
  artifacts:
    - path: "app/treatment/new.tsx"
      provides: "Festival-specific form section with triage, alcohol/substance, safeguarding, and disposition fields"
      contains: "triagePriority"
  key_links:
    - from: "app/treatment/new.tsx"
      to: "treatment.verticalExtraFields"
      via: "JSON.stringify of festival fields written to WatermelonDB TEXT column"
      pattern: "vertical_extra_fields.*triage_priority"
    - from: "app/treatment/new.tsx"
      to: "enqueueSyncItem payload"
      via: "vertical_extra_fields key in sync body"
      pattern: "vertical_extra_fields"
---

<objective>
Add festival-specific form fields to the treatment form: TST triage priority (P1/P2/P3/P4), alcohol/substance involvement flag, safeguarding concern flag, and attendee disposition. All fields are required for festivals and written to `vertical_extra_fields` JSONB. Also gate the RIDDOR warning banner so it never shows for festivals.

Purpose: FEST-01 (triage), FEST-02 (alcohol/safeguarding flags) — the core data capture that the Purple Guide PDF (Plan 20-03) will render.
Output: Modified `app/treatment/new.tsx` with conditional festival form section.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-festivals-events-vertical/20-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add festival form fields, validation, RIDDOR banner gate, and sync payload wiring</name>
  <files>app/treatment/new.tsx</files>
  <action>
    Modify `app/treatment/new.tsx` to add festival-specific fields. This is a single-file change with four insertion points.

    **1. Constants (near top of file, after existing imports/constants):**

    Add these two arrays:
    ```typescript
    const TRIAGE_PRIORITIES = [
      { id: 'P1', label: 'P1 — Immediate (Red)' },
      { id: 'P2', label: 'P2 — Urgent (Yellow)' },
      { id: 'P3', label: 'P3 — Delayed (Green)' },
      { id: 'P4', label: 'P4 — Expectant (Black/Blue)' },
    ];

    const FESTIVAL_DISPOSITIONS = [
      { id: 'discharged_on_site', label: 'Discharged on site' },
      { id: 'transferred_to_hospital', label: 'Transferred to hospital' },
      { id: 'refused_treatment', label: 'Refused treatment' },
    ];
    ```

    **2. State declarations (alongside existing state, ~line 59):**

    Add:
    ```typescript
    const [triagePriority, setTriagePriority] = useState<string>('');
    const [showTriagePicker, setShowTriagePicker] = useState(false);
    const [alcoholSubstanceFlag, setAlcoholSubstanceFlag] = useState(false);
    const [safeguardingFlag, setSafeguardingFlag] = useState(false);
    const [disposition, setDisposition] = useState<string>('');
    const [showDispositionPicker, setShowDispositionPicker] = useState(false);
    ```

    **3. RIDDOR banner gate in `handleInjuryTypeSelect` (~line 183):**

    Find the existing code that sets `setRiddorFlagged(true)` when an injury type has `isRiddorReportable`. Gate it on vertical:
    ```typescript
    if (injuryType?.isRiddorReportable && orgVertical !== 'festivals') {
      setRiddorFlagged(true);
    } else {
      setRiddorFlagged(false);
    }
    ```
    WHY: Festival attendees are not workers under HSE — RIDDOR never applies. Without this gate, a medic treating a festival-goer's fracture would see a scary "RIDDOR Reportable" banner, which is incorrect and confusing.

    IMPORTANT: The `setRiddorFlagged(true)` call MUST still exist in the code (gated by `orgVertical !== 'festivals'`). Do NOT remove it entirely — it is still needed for construction, tv_film, general, and other verticals.

    **4. Validation in `handleCompleteTreatment` (after existing validation, before the try block ~line 303):**

    Add:
    ```typescript
    if (orgVertical === 'festivals') {
      if (!triagePriority) {
        Alert.alert('Missing Information', 'Please select a triage priority (P1-P4)');
        return;
      }
      if (!disposition) {
        Alert.alert('Missing Information', 'Please select attendee disposition');
        return;
      }
    }
    ```

    **5. Form section (after Section 5: Outcome, before Section 6: Signature, ~line 513–524):**

    Insert the conditional section. Use the exact JSX from the research document "Code Examples > Festival Section in Treatment Form":
    - Triage Priority picker using `BottomSheetPicker` (same component used for injury type etc.)
    - Alcohol/Substance toggle using `Pressable` with `styles.treatmentTypeButton` / `styles.treatmentTypeButtonSelected` pattern
    - Safeguarding Concern toggle (same pattern)
    - Disposition picker using `BottomSheetPicker`
    - All wrapped in `{orgVertical === 'festivals' && ( ... )}`
    - Section title: "5b. Purple Guide — Event Triage"

    Also add the two `BottomSheetPicker` modals alongside other picker modals at the bottom of the return statement.

    **6. Sync payload in `enqueueSyncItem` (~line 335):**

    Add `vertical_extra_fields` to the body:
    ```typescript
    vertical_extra_fields: orgVertical === 'festivals'
      ? JSON.stringify({
          triage_priority: triagePriority,
          alcohol_substance: alcoholSubstanceFlag,
          safeguarding_concern: safeguardingFlag,
          disposition,
        })
      : treatment.verticalExtraFields ?? null,
    ```

    **7. WatermelonDB record creation (in the database.write block where the treatment is created):**

    Set `verticalExtraFields` on the treatment record:
    ```typescript
    t.verticalExtraFields = orgVertical === 'festivals'
      ? JSON.stringify({
          triage_priority: triagePriority,
          alcohol_substance: alcoholSubstanceFlag,
          safeguarding_concern: safeguardingFlag,
          disposition,
        })
      : undefined;
    ```

    **IMPORTANT:**
    - Do NOT create a separate file — all changes go in `app/treatment/new.tsx`
    - Do NOT add `triage_priority` as a top-level DB column — it lives in `vertical_extra_fields` JSONB
    - Do NOT modify any existing section numbering (1-6) — the festival section is "5b"
    - The `orgVertical` variable already exists from Phase 18-04 (derived from params/OrgContext)
    - `BottomSheetPicker` is already imported and used in the file
    - Use `JSON.stringify` exactly once — Supabase REST API accepts a JSON string for JSONB columns
  </action>
  <verify>
    1. Read back `app/treatment/new.tsx` and confirm:
       - TRIAGE_PRIORITIES and FESTIVAL_DISPOSITIONS arrays exist
       - 6 new state variables exist (triagePriority, showTriagePicker, alcoholSubstanceFlag, safeguardingFlag, disposition, showDispositionPicker)
       - handleInjuryTypeSelect gates RIDDOR flag on `orgVertical !== 'festivals'`
       - handleCompleteTreatment validates triagePriority and disposition when orgVertical is 'festivals'
       - Section "5b. Purple Guide" is conditionally rendered
       - vertical_extra_fields is included in enqueueSyncItem payload
       - verticalExtraFields is set on the WatermelonDB treatment record
    2. Run: `npx tsc --noEmit 2>&1 | grep -i "new.tsx" | head -10` — no TypeScript errors in treatment form
    3. Run: `git diff --stat app/treatment/new.tsx` — only this file changed
    4. Run: `grep -n "setRiddorFlagged(true)" app/treatment/new.tsx` — MUST return at least 1 match (confirming the true path still exists for non-festivals verticals)
  </verify>
  <done>
    - Festival form section renders when orgVertical === 'festivals' with all 4 fields
    - Triage priority (P1/P2/P3/P4) is required — form cannot complete without selection
    - Alcohol/substance flag is a toggle (default false)
    - Safeguarding flag is a toggle (default false)
    - Disposition is required — form cannot complete without selection
    - All 4 values written to verticalExtraFields as JSON string
    - RIDDOR warning banner suppressed for festivals vertical
    - RIDDOR warning banner still activates for construction, tv_film, and general vertical injury types (non-regression confirmed)
    - No TypeScript errors
  </done>
</task>

</tasks>

<verification>
After task completion:
1. grep for `triagePriority` in app/treatment/new.tsx — must appear in state, validation, JSX, and sync payload
2. grep for `orgVertical !== 'festivals'` in the RIDDOR flag logic
3. grep for `vertical_extra_fields` in the enqueueSyncItem body
4. grep for `setRiddorFlagged(true)` — must return at least 1 match (RIDDOR still works for non-festivals)
5. Confirm no other files were modified: `git diff --name-only` shows only app/treatment/new.tsx
</verification>

<success_criteria>
- FEST-01 satisfied: TST triage category (P1/P2/P3/P4) is a required field on the festivals treatment form
- FEST-02 satisfied: Alcohol/substance flag and safeguarding concern flag are present on the festivals form
- Triage and disposition are validated before form completion (mandatory)
- All festival fields are serialized to vertical_extra_fields JSON for sync to Supabase
- RIDDOR banner is suppressed for festivals (partial FEST-03 — the backend gate is Plan 20-02)
- No regression to non-festivals treatment flow (form unchanged when orgVertical is not 'festivals')
- RIDDOR banner still activates for construction, tv_film, and general verticals (non-regression confirmed by grep)
</success_criteria>

<output>
After completion, create `.planning/phases/20-festivals-events-vertical/20-01-SUMMARY.md`
</output>
