---
phase: 18.5-construction-infrastructure-vertical
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "FUNCTION_BY_VERTICAL['construction'] === 'riddor-f2508-generator' in incident-report-dispatcher.ts"
    - "'construction' is absent from NON_RIDDOR_VERTICALS in riddor-detector/index.ts"
    - "getRecommendedCertTypes('construction') returns CSCS, CPCS, IPAF, Gas Safe, PASMA in the list"
    - "getVerticalCompliance('construction').riddorApplies === true"
    - "getPatientLabel('construction') === 'Worker'"
    - "No existing file is modified — this plan is read-only verification"
  artifacts:
    - path: "web/lib/pdf/incident-report-dispatcher.ts"
      provides: "FUNCTION_BY_VERTICAL routing table"
      contains: "construction.*riddor-f2508-generator"
    - path: "supabase/functions/riddor-detector/index.ts"
      provides: "NON_RIDDOR_VERTICALS gate"
      contains: "NON_RIDDOR_VERTICALS"
    - path: "services/taxonomy/certification-types.ts"
      provides: "getRecommendedCertTypes + VERTICAL_CERT_TYPES"
      contains: "construction"
    - path: "services/taxonomy/vertical-compliance.ts"
      provides: "riddorApplies: true for construction"
      contains: "construction"
  key_links:
    - from: "supabase/functions/riddor-detector/index.ts"
      to: "detectRIDDOR()"
      via: "construction absent from NON_RIDDOR_VERTICALS — treatment proceeds to RIDDOR detection"
      pattern: "NON_RIDDOR_VERTICALS"
    - from: "web/lib/pdf/incident-report-dispatcher.ts"
      to: "riddor-f2508-generator Edge Function"
      via: "FUNCTION_BY_VERTICAL['construction'] routing"
      pattern: "construction.*riddor-f2508-generator"
---

<objective>
Verify the construction vertical's end-to-end path is intact and produces no regressions. This is a read-only smoke-test plan — no file is created or modified. The RIDDOR detector, PDF dispatcher, cert ordering, compliance config, and patient label all already support construction from v1.0. This plan confirms each piece is still correct and documents the verified state.

Purpose: Provide a verified baseline for Phase 18 completion before Phases 19–22 add new verticals that must not disturb the construction path.

Output: No code changes. A SUMMARY.md documenting the verified state of all construction end-to-end paths.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18.5-construction-infrastructure-vertical/18.5-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify RIDDOR gate and PDF dispatcher for construction</name>
  <files>supabase/functions/riddor-detector/index.ts, web/lib/pdf/incident-report-dispatcher.ts</files>
  <action>
    READ both files and confirm the following. Do NOT edit anything.

    In `supabase/functions/riddor-detector/index.ts`:
    - Locate the `NON_RIDDOR_VERTICALS` array
    - Confirm 'construction' is NOT in this array
    - Record the exact line number and array contents for the SUMMARY

    In `web/lib/pdf/incident-report-dispatcher.ts`:
    - Locate the `FUNCTION_BY_VERTICAL` record
    - Confirm `construction: 'riddor-f2508-generator'` is present
    - Record the exact line number for the SUMMARY

    If either check FAILS (i.e., construction is found in NON_RIDDOR_VERTICALS, or construction is missing from FUNCTION_BY_VERTICAL), that is a regression — stop and report the exact discrepancy. Do not attempt to fix it silently.

    No edits. No new files except the final SUMMARY.
  </action>
  <verify>
    Read the files and confirm visually:
    - `supabase/functions/riddor-detector/index.ts` contains NON_RIDDOR_VERTICALS and 'construction' is absent
    - `web/lib/pdf/incident-report-dispatcher.ts` line ~21 contains `construction: 'riddor-f2508-generator'`
    - `git diff` shows zero changes
  </verify>
  <done>
    - NON_RIDDOR_VERTICALS confirmed — 'construction' absent (RIDDOR detection active for construction)
    - FUNCTION_BY_VERTICAL confirmed — construction routes to 'riddor-f2508-generator'
    - Both file paths and line numbers recorded for SUMMARY
    - No files modified
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify cert ordering and compliance config for construction</name>
  <files>services/taxonomy/certification-types.ts, services/taxonomy/vertical-compliance.ts, services/taxonomy/vertical-outcome-labels.ts</files>
  <action>
    READ these three files and confirm the following. Do NOT edit anything.

    In `services/taxonomy/certification-types.ts`:
    - Locate `VERTICAL_CERT_TYPES.construction`
    - Confirm it contains: 'CSCS', 'CPCS', 'IPAF', 'PASMA', 'Gas Safe' (all 5 construction-specific certs present)
    - Confirm `getRecommendedCertTypes('construction')` exists as a function and returns the full ordered array (construction-relevant first, then remaining CERT_TYPES)
    - Note: The existing function puts medical certs (FREC 3) first — this is correct for the runtime display. The new VERTICAL_CONFIG (plan 01) puts CSCS first for the canonical config. These two orderings serve different purposes and must NOT be made to match.

    In `services/taxonomy/vertical-compliance.ts`:
    - Locate `VERTICAL_COMPLIANCE.construction`
    - Confirm `riddorApplies: true`
    - Confirm `patientIsWorker: true`
    - Confirm `primaryFramework: 'RIDDOR'`

    In `services/taxonomy/vertical-outcome-labels.ts`:
    - Confirm `getPatientLabel('construction')` returns `'Worker'`
    - Confirm construction entry is in `OUTCOME_LABEL_OVERRIDES`

    Record all findings (file + line) for the SUMMARY. Report any discrepancy immediately.
    No edits.
  </action>
  <verify>
    Read each file. Confirm:
    - VERTICAL_CERT_TYPES.construction includes 'CSCS', 'CPCS', 'IPAF', 'PASMA', 'Gas Safe'
    - VERTICAL_COMPLIANCE.construction.riddorApplies === true
    - getPatientLabel('construction') returns 'Worker'
    - git diff shows zero changes
  </verify>
  <done>
    - VERTICAL_CERT_TYPES.construction confirmed with all 5 construction-specific certs present
    - getRecommendedCertTypes function confirmed present
    - riddorApplies: true confirmed in vertical-compliance.ts
    - patientIsWorker: true confirmed in vertical-compliance.ts
    - getPatientLabel('construction') === 'Worker' confirmed
    - All findings documented with file paths and line numbers
    - No files modified
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `git diff` — must show zero changes (this plan is read-only)
2. Confirm all 5 checkpoints verified:
   - 'construction' absent from NON_RIDDOR_VERTICALS
   - construction: 'riddor-f2508-generator' present in FUNCTION_BY_VERTICAL
   - VERTICAL_CERT_TYPES.construction contains all 5 construction-specific certs
   - riddorApplies: true in vertical-compliance.ts
   - getPatientLabel('construction') === 'Worker'
3. End-to-end path documented: treatment.event_vertical='construction' → RIDDOR detector passes through → detectRIDDOR() runs → if eligible, RIDDOR incident created → dispatcher routes to riddor-f2508-generator
</verification>

<success_criteria>
- CONST-03 verified: incident-report-dispatcher routes construction to 'riddor-f2508-generator' (confirmed at exact line)
- CONST-03 verified: RIDDOR detection active for construction — 'construction' absent from NON_RIDDOR_VERTICALS
- CONST-02 verified: getRecommendedCertTypes('construction') includes CSCS, CPCS, IPAF, Gas Safe, PASMA
- CONST-01 cross-checked: riddorApplies: true confirmed in vertical-compliance.ts; patientTerm 'Worker' confirmed in vertical-outcome-labels.ts
- Zero regressions — no existing file modified
- SUMMARY.md documents the verified state with file paths and line numbers for each checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/18.5-construction-infrastructure-vertical/18.5-02-SUMMARY.md`
</output>
