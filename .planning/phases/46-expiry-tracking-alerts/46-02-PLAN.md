---
phase: 46-expiry-tracking-alerts
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/lib/queries/admin/document-expiry.ts
  - web/app/(dashboard)/admin/document-expiry/page.tsx
  - web/components/dashboard/DashboardNav.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can access a bulk expiry dashboard showing all documents expiring in the next 30 days across all medics in their org"
    - "Dashboard is sortable by expiry date"
    - "Dashboard is filterable by document category"
    - "Each document row shows medic name, document type (category), expiry date, status badge, and days remaining"
    - "Dashboard has summary cards showing counts of expired, expiring soon, and current documents"
    - "Navigation sidebar has a Document Expiry item visible to admins"
  artifacts:
    - path: "web/lib/queries/admin/document-expiry.ts"
      provides: "TanStack Query hooks for expiring documents"
      exports: ["useExpiringDocuments", "useDocumentExpirySummary"]
    - path: "web/app/(dashboard)/admin/document-expiry/page.tsx"
      provides: "Bulk expiry dashboard page"
      contains: "DocumentExpiryPage"
    - path: "web/components/dashboard/DashboardNav.tsx"
      provides: "Updated navigation with Document Expiry item"
      contains: "document-expiry"
  key_links:
    - from: "web/app/(dashboard)/admin/document-expiry/page.tsx"
      to: "web/lib/queries/admin/document-expiry.ts"
      via: "import useExpiringDocuments, useDocumentExpirySummary"
      pattern: "import.*document-expiry"
    - from: "web/lib/queries/admin/document-expiry.ts"
      to: "documents + document_versions tables"
      via: "Supabase client query with org_id filter"
      pattern: "from\\('documents'\\)"
    - from: "web/components/dashboard/DashboardNav.tsx"
      to: "web/app/(dashboard)/admin/document-expiry/page.tsx"
      via: "href: '/admin/document-expiry'"
      pattern: "admin/document-expiry"
---

<objective>
Build the bulk document expiry dashboard for org admins and add it to the sidebar navigation.

Purpose: Org admins need a single view to see all documents expiring across all their medics to proactively manage compliance. Without this, admins must check each medic's profile individually.

Output:
- TanStack Query hooks for fetching expiring documents with org-scoped filtering
- Dashboard page with summary cards (expired/expiring/current counts), data table with sort by expiry date and filter by category, and expiry status badges
- Navigation item in DashboardNav.tsx
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key reference files -- study these BEFORE writing code
@web/app/(dashboard)/certifications/page.tsx  # Dashboard UI pattern (summary cards + tabs + table)
@web/lib/queries/admin/certifications.ts  # TanStack Query hooks pattern (useRequireOrg, fetchExpiringCertifications)
@web/components/dashboard/DashboardNav.tsx  # Navigation item pattern
@web/types/comms.types.ts  # DocumentWithVersion, DocumentVersion, DocumentCategory types
@web/components/documents/document-list.tsx  # ExpiryBadge component (for badge consistency)
@web/contexts/org-context.tsx  # useRequireOrg hook
@web/lib/supabase/client.ts  # createClient

# Phase 46 context and research
@.planning/phases/46-expiry-tracking-alerts/46-CONTEXT.md
@.planning/phases/46-expiry-tracking-alerts/46-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TanStack Query hooks for document expiry data</name>
  <files>web/lib/queries/admin/document-expiry.ts</files>
  <action>
Create `web/lib/queries/admin/document-expiry.ts` following the pattern in `web/lib/queries/admin/certifications.ts`.

**Types:**

```typescript
export interface ExpiringDocumentRow {
  document_id: string;
  medic_id: string;
  medic_name: string;
  category_id: string;
  category_name: string;
  category_slug: string;
  file_name: string;
  expiry_date: string;
  days_remaining: number;
  status: 'current' | 'expiring-soon' | 'expired';
}

export interface DocumentExpirySummary {
  total_documents: number;
  expired_count: number;
  expiring_soon_count: number;
  current_count: number;
}
```

**Server functions:**

1. `fetchExpiringDocuments(supabase, orgId, options)`:
   - options: { daysWindow: number; categorySlug?: string; includeExpired?: boolean }
   - Query documents table with select joining medics (first_name, last_name), document_categories (name, slug), and document_versions via fk_documents_current_version (id, expiry_date, file_name)
   - Filter: .eq('org_id', orgId), .neq('status', 'archived'), .not('current_version_id', 'is', null)
   - Client-side processing of results:
     a. Filter out rows where expiry_date is null (no-expiry documents excluded from dashboard)
     b. Compute days_remaining = differenceInDays(parseISO(expiry_date), today)
     c. Determine status: 'expired' if < 0, 'expiring-soon' if <= 30, 'current' if > 30
     d. Apply daysWindow filter: include if days_remaining <= daysWindow (for non-expired) OR if includeExpired and expired
     e. Apply categorySlug filter if provided
     f. Sort by days_remaining ascending (most urgent first)
   - Return ExpiringDocumentRow[]
   - Use differenceInDays, parseISO from date-fns (already installed)

2. `fetchDocumentExpirySummary(supabase, orgId)`:
   - Same query as above but compute aggregate counts
   - Return DocumentExpirySummary with total_documents (that have expiry dates), expired_count, expiring_soon_count (0-30d), current_count (>30d)

**React Query hooks:**

1. `useExpiringDocuments(daysWindow, categorySlug?, includeExpired?)`:
   - const supabase = createClient();
   - const orgId = useRequireOrg();
   - queryKey: ['admin', 'documents', 'expiring', orgId, daysWindow, categorySlug, includeExpired]
   - refetchInterval: 60000, staleTime: 30000
   - Returns useQuery result

2. `useDocumentExpirySummary()`:
   - Same pattern, queryKey: ['admin', 'documents', 'expiry-summary', orgId]
   - refetchInterval: 60000, staleTime: 30000

3. `useDocumentCategories()`:
   - Fetch document_categories WHERE org_id = orgId AND is_active = true, ordered by sort_order
   - queryKey: ['admin', 'document-categories', orgId]
   - staleTime: 300000 (5 min, categories rarely change)

All hooks must be 'use client' marked. Use imports: createClient from '@/lib/supabase/client', useRequireOrg from '@/contexts/org-context', useQuery from '@tanstack/react-query', date-fns functions.
  </action>
  <verify>
Run `grep -c 'useExpiringDocuments\|useDocumentExpirySummary\|useDocumentCategories' web/lib/queries/admin/document-expiry.ts` -- should return 3+. Verify 'use client' directive at top.
  </verify>
  <done>
Three TanStack Query hooks exist: useExpiringDocuments (with daysWindow, categorySlug, includeExpired filters), useDocumentExpirySummary (aggregate counts), useDocumentCategories (for filter dropdown). All org-scoped via useRequireOrg.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bulk expiry dashboard page and add navigation item</name>
  <files>
    web/app/(dashboard)/admin/document-expiry/page.tsx
    web/components/dashboard/DashboardNav.tsx
  </files>
  <action>
**Create `web/app/(dashboard)/admin/document-expiry/page.tsx`:**

Follow the pattern from `web/app/(dashboard)/certifications/page.tsx`. This is a 'use client' page.

Structure:
1. **Header**: "Document Expiry" title, subtitle showing total document count and compliance rate
2. **Summary Cards** (3-column grid on md+, 1-column on mobile):
   - Expired card: red XCircle icon, count of expired documents, "Non-compliant" subtitle
   - Expiring Soon card: amber AlertTriangle icon, count expiring within 30 days, "Within 30 days" subtitle
   - Current card: green CheckCircle2 icon, count of current documents, "All documents valid" subtitle
3. **Data Table** inside a Card:
   - Category filter: Select/dropdown at top-right populated by useDocumentCategories hook. Options: "All Categories" (default) plus each active category. Selecting a category filters the table.
   - Tabs: "30 Days" (default), "All Expiring" (includes 60/90), "Expired"
     - 30 Days tab: daysWindow=30, includeExpired=false
     - All Expiring tab: daysWindow=365, includeExpired=false
     - Expired tab: daysWindow=0, includeExpired=true
   - Table columns: Medic Name, Document Category, File Name, Expiry Date (formatted 'dd MMM yyyy'), Days Remaining (with colour: red if <0, amber if <=7, yellow if <=30), Status Badge
   - Status Badge: reuse the same badge logic from document-list.tsx ExpiryBadge but with light theme colours (admin dashboard uses light theme, not dark):
     - Expired: red bg, red text
     - Expiring Soon: amber/yellow bg, amber text
     - Current: green bg, green text
     - Use shadcn Badge component with variant="outline" and custom className for colours
   - Empty state: CheckCircle2 icon with "No expiring documents" message when table is empty
   - Loading state: "Loading documents..." centered text

State management:
- useState for activeTab ('30' | 'all' | 'expired')
- useState for selectedCategory (string | undefined)
- Hooks: useDocumentExpirySummary(), useExpiringDocuments(daysWindow, selectedCategory, includeExpired), useDocumentCategories()

Imports: Card/CardContent/CardHeader/CardTitle/CardDescription from shadcn, Tabs/TabsContent/TabsList/TabsTrigger from shadcn, Select/SelectContent/SelectItem/SelectTrigger/SelectValue from shadcn, Badge from shadcn, lucide-react icons (CheckCircle2, AlertTriangle, XCircle, FileWarning), format/parseISO from date-fns.

**Update `web/components/dashboard/DashboardNav.tsx`:**

Add a new navigation item for Document Expiry. Insert it AFTER the 'Messages' entry (last current item) in the navigation array:

```typescript
{
  name: 'Document Expiry',
  href: '/admin/document-expiry',
  icon: FileWarning,
}
```

Add `FileWarning` to the lucide-react import statement (add to existing import list). FileWarning is a triangle with exclamation mark -- appropriate for expiry tracking.

Note: This nav item is visible to all dashboard users. The page itself queries org-scoped data, so non-admin users see only their org's data (RLS enforced). If you want admin-only visibility, wrap the nav item in a role check -- but following the existing pattern (certifications is visible to all), keep it visible.
  </action>
  <verify>
1. Page exists: `ls web/app/\\(dashboard\\)/admin/document-expiry/page.tsx`
2. Nav item added: `grep 'document-expiry' web/components/dashboard/DashboardNav.tsx` returns a match
3. FileWarning imported: `grep 'FileWarning' web/components/dashboard/DashboardNav.tsx` returns a match
4. Hooks imported: `grep 'useExpiringDocuments\|useDocumentExpirySummary' web/app/\\(dashboard\\)/admin/document-expiry/page.tsx` returns matches
5. No build errors: `cd web && npx next lint --dir app/\\(dashboard\\)/admin/document-expiry 2>&1 | head -20` (or just verify file syntax)
  </verify>
  <done>
Bulk expiry dashboard page exists at /admin/document-expiry with summary cards (expired/expiring/current), tabbed data table (30 days/all/expired), category filter dropdown, expiry badges, and days remaining indicators. DashboardNav has "Document Expiry" item with FileWarning icon linking to the page.
  </done>
</task>

</tasks>

<verification>
1. Dashboard page loads: Navigate to /admin/document-expiry -- page renders with summary cards and table
2. Navigation item: "Document Expiry" appears in sidebar nav with FileWarning icon
3. Category filter: Select dropdown shows document categories from the org
4. Tab switching: Clicking 30 Days / All Expiring / Expired tabs changes the displayed documents
5. Sort order: Documents are sorted by days_remaining ascending (most urgent first)
6. Badge colours: Expired = red, Expiring Soon = amber, Current = green (consistent with existing ExpiryBadge)
7. Empty state: When no documents match the filter, a friendly empty state message is shown
8. Org scoping: Query uses useRequireOrg() -- data is scoped to the current org
</verification>

<success_criteria>
- Org admin can access /admin/document-expiry from the sidebar navigation
- Summary cards show counts of expired, expiring soon (30d), and current documents
- Data table lists documents with medic name, category, file name, expiry date, days remaining, and status badge
- Table is sortable by expiry date (default sort: most urgent first)
- Category filter dropdown filters the table by document category
- Tabs switch between 30-day window, all expiring, and expired views
- Status badges match existing ExpiryBadge colour scheme (green/amber/red)
</success_criteria>

<output>
After completion, create `.planning/phases/46-expiry-tracking-alerts/46-02-SUMMARY.md`
</output>
