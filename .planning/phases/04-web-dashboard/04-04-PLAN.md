---
phase: 04-web-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - web/app/(dashboard)/near-misses/page.tsx
  - web/components/dashboard/near-misses-table.tsx
  - web/components/dashboard/near-misses-columns.tsx
  - web/lib/queries/near-misses.ts
  - web/app/(dashboard)/workers/page.tsx
  - web/components/dashboard/workers-table.tsx
  - web/components/dashboard/workers-columns.tsx
  - web/lib/queries/workers.ts
autonomous: true

must_haves:
  truths:
    - "Site manager can view near-miss log with category, severity, and date columns"
    - "Site manager can filter near-misses by category, severity, and date"
    - "Site manager can view worker registry with name, company, role, and certification status"
    - "Site manager can search workers by company, role, and certification status"
    - "Both pages poll every 60 seconds for updates"
  artifacts:
    - path: "web/app/(dashboard)/near-misses/page.tsx"
      provides: "Near-miss log page with filterable table"
    - path: "web/components/dashboard/near-misses-table.tsx"
      provides: "Near-miss table client component with filters and polling"
    - path: "web/lib/queries/near-misses.ts"
      provides: "Supabase queries and hooks for near-misses"
      exports: ["fetchNearMisses", "useNearMisses"]
    - path: "web/app/(dashboard)/workers/page.tsx"
      provides: "Worker registry page with searchable table"
    - path: "web/components/dashboard/workers-table.tsx"
      provides: "Worker table client component with search/filter and polling"
    - path: "web/lib/queries/workers.ts"
      provides: "Supabase queries and hooks for workers"
      exports: ["fetchWorkers", "useWorkers"]
  key_links:
    - from: "web/components/dashboard/near-misses-table.tsx"
      to: "web/components/dashboard/data-table.tsx"
      via: "Reuses DataTable component from Plan 04-03"
      pattern: "DataTable"
    - from: "web/components/dashboard/workers-table.tsx"
      to: "web/components/dashboard/data-table.tsx"
      via: "Reuses DataTable component from Plan 04-03"
      pattern: "DataTable"
---

<objective>
Build the near-miss log page with category/severity/date filtering (DASH-06) and the worker registry page with company/role/certification search and filter (DASH-07, DASH-08). Both reuse the DataTable component from Plan 04-03.

Purpose: Near-miss and worker pages complete the dashboard's data views, giving site managers full visibility into safety incidents and workforce composition with certification compliance status.

Output: Near-miss log page with filterable table (category, severity, date). Worker registry page with searchable table showing certification status indicators (green/amber/red).
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-web-dashboard/04-RESEARCH.md
@.planning/phases/04-web-dashboard/04-01-SUMMARY.md
@.planning/phases/04-web-dashboard/04-03-SUMMARY.md

# Database schema
@supabase/migrations/00003_health_data_tables.sql

# Reuse DataTable from Plan 03
@web/components/dashboard/data-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build near-miss log page with queries, columns, and table</name>
  <files>
    web/lib/queries/near-misses.ts
    web/components/dashboard/near-misses-columns.tsx
    web/components/dashboard/near-misses-table.tsx
    web/app/(dashboard)/near-misses/page.tsx
  </files>
  <action>
1. `web/lib/queries/near-misses.ts` - Near-miss queries:
   - `fetchNearMisses(supabase)` - Server-side:
     - Query: `supabase.from('near_misses').select('*, reporter:profiles(id, full_name)').is('deleted_at', null).order('created_at', { ascending: false }).limit(500)`
     - Returns NearMiss[] with reporter name joined
   - `useNearMisses(initialData)` - Client-side hook:
     - useQuery with queryKey ['near-misses'], 60-second polling
     - Uses browser Supabase client for refetch

2. `web/components/dashboard/near-misses-columns.tsx` - Column definitions:
   - **Date**: `created_at` formatted as 'dd/MM/yyyy HH:mm' (UK format). Sortable.
   - **Category**: `category` displayed as readable text (replace hyphens/underscores with spaces, capitalize). Filterable.
   - **Severity**: `severity` rendered as colored Badge:
     - low: green badge
     - medium: amber badge
     - high: red badge
     - critical: dark-red badge with bold text
   - **Description**: `description` truncated to 80 chars with ellipsis. Full text on hover (title attribute).
   - **Reported By**: Reporter name from joined profile (fallback 'Unknown')
   - **Location**: `location` if present, "No location" if null

3. `web/components/dashboard/near-misses-table.tsx` - Table wrapper ('use client'):
   - Props: `initialData: NearMiss[]`
   - Uses `useNearMisses(initialData)` for polling
   - Filter controls above DataTable:
     - Category select (All + unique categories from data)
     - Severity select (All / Low / Medium / High / Critical)
     - DateRangeFilter component (reuse from Plan 04-03)
   - Apply client-side category and date range filters to data before passing to DataTable
   - Reuse DataTable component from Plan 04-03

4. `web/app/(dashboard)/near-misses/page.tsx` - Server component:
   - Page title: "Near-Miss Log"
   - Fetch initial near-misses server-side
   - Pass initialData to NearMissesTable
   - Count text: "X near-misses recorded"
  </action>
  <verify>
- `web/app/(dashboard)/near-misses/page.tsx` exists and renders near-miss table
- Table has 6 columns: Date, Category, Severity, Description, Reported By, Location
- Category and severity filters work
- Data polls every 60 seconds
  </verify>
  <done>
Near-miss log page displays filterable table with category, severity, date columns and filters (DASH-06). Reuses DataTable component from Plan 04-03. 60-second polling active.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build worker registry page with queries, columns, and table</name>
  <files>
    web/lib/queries/workers.ts
    web/components/dashboard/workers-columns.tsx
    web/components/dashboard/workers-table.tsx
    web/app/(dashboard)/workers/page.tsx
  </files>
  <action>
1. `web/lib/queries/workers.ts` - Worker queries:
   - `fetchWorkers(supabase)` - Server-side:
     - Query: `supabase.from('workers').select('*').is('deleted_at', null).order('last_name', { ascending: true }).limit(500)`
     - Returns Worker[]
   - `useWorkers(initialData)` - Client-side hook:
     - useQuery with queryKey ['workers'], 60-second polling
     - Uses browser Supabase client for refetch

2. `web/components/dashboard/workers-columns.tsx` - Column definitions:
   - **Name**: `last_name + ', ' + first_name`. Sortable. Filterable with text search.
   - **Company**: `company` (fallback 'N/A'). Filterable with text search.
   - **Role**: `role` (fallback 'N/A'). Filterable.
   - **Phone**: `phone` (fallback 'N/A')
   - **Emergency Contact**: `emergency_contact_name` + `emergency_contact_phone` (combined, fallback 'None')
   - **Consent**: `consent_given` rendered as green checkmark or red X badge
   - **Cert Status**: Certification status indicator (placeholder for Phase 7):
     - For now, show green "Active" badge for all workers (since cert tracking is Phase 7)
     - Add comment: "// TODO Phase 7: Replace with actual certification expiry check"
     - Design the column to accept future cert data (leave room in types)
   - **Added**: `created_at` formatted as 'dd/MM/yyyy' (UK format)

3. `web/components/dashboard/workers-table.tsx` - Table wrapper ('use client'):
   - Props: `initialData: Worker[]`
   - Uses `useWorkers(initialData)` for polling
   - Filter/search controls above DataTable:
     - Company text search input
     - Role text search input
     - Certification status select (All / Active / Expiring Soon / Expired) - placeholder, only "Active" works now
   - Apply client-side filters to data before passing to DataTable
   - Global search searches across name, company, and role fields
   - Reuse DataTable component from Plan 04-03

4. `web/app/(dashboard)/workers/page.tsx` - Server component:
   - Page title: "Worker Registry"
   - Fetch initial workers server-side
   - Pass initialData to WorkersTable
   - Count text: "X workers registered"
  </action>
  <verify>
- `cd web && pnpm build` compiles successfully
- `web/app/(dashboard)/workers/page.tsx` exists and renders worker table
- Table has 8 columns: Name, Company, Role, Phone, Emergency Contact, Consent, Cert Status, Added
- Company and role search filters work
- Global search searches across name, company, role
- Data polls every 60 seconds
  </verify>
  <done>
Worker registry page displays searchable table with company, role filters and certification status indicators (DASH-07, DASH-08). Global search works across name, company, and role. Cert status column is a green "Active" placeholder ready for Phase 7 integration. 60-second polling active.
  </done>
</task>

</tasks>

<verification>
1. `cd web && pnpm build` passes
2. `/near-misses` shows filterable table with category, severity, date
3. `/workers` shows searchable table with company, role, cert status
4. Both tables reuse DataTable component
5. Both tables have 60-second polling
6. Worker search works across name, company, and role
7. Near-miss severity shows color-coded badges
</verification>

<success_criteria>
- Near-miss log page with category/severity/date filters (DASH-06)
- Worker registry with certification status indicators (green badges) (DASH-07)
- Worker search by company, role, and certification status (DASH-08)
- Both pages poll every 60 seconds (DASH-09)
- Consistent UI with treatment log page (same DataTable, same filter patterns)
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-04-SUMMARY.md`
</output>
