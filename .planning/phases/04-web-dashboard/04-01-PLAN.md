---
phase: 04-web-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/package.json
  - web/lib/supabase/server.ts
  - web/lib/supabase/client.ts
  - web/lib/supabase/middleware.ts
  - web/middleware.ts
  - web/app/(auth)/login/page.tsx
  - web/app/(dashboard)/layout.tsx
  - web/app/(dashboard)/page.tsx
  - web/components/providers/query-provider.tsx
  - web/app/layout.tsx
  - web/next.config.ts
  - web/types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Unauthenticated user is redirected to /login page"
    - "Authenticated user sees dashboard shell with sidebar navigation"
    - "Dashboard layout has sidebar with links to Overview, Treatments, Near-Misses, Workers"
    - "Dashboard layout is responsive (sidebar hidden on mobile, visible on desktop)"
  artifacts:
    - path: "web/lib/supabase/server.ts"
      provides: "Server component Supabase client using @supabase/ssr with cookie-based auth"
      exports: ["createClient"]
    - path: "web/lib/supabase/client.ts"
      provides: "Browser Supabase client using @supabase/ssr"
      exports: ["createClient"]
    - path: "web/middleware.ts"
      provides: "Auth middleware that refreshes tokens and redirects unauthenticated users"
    - path: "web/app/(dashboard)/layout.tsx"
      provides: "Dashboard shell with sidebar navigation and header"
    - path: "web/components/providers/query-provider.tsx"
      provides: "TanStack Query provider with 60-second default polling"
  key_links:
    - from: "web/middleware.ts"
      to: "web/lib/supabase/middleware.ts"
      via: "createServerClient for token refresh"
      pattern: "createServerClient"
    - from: "web/app/(dashboard)/layout.tsx"
      to: "web/components/providers/query-provider.tsx"
      via: "QueryProvider wrapping children"
      pattern: "QueryProvider"
---

<objective>
Install dashboard dependencies (shadcn/ui, TanStack Table, TanStack Query, @supabase/ssr, recharts, export libs), create Supabase server/client utilities with @supabase/ssr pattern, set up auth middleware for session refresh and route protection, build responsive dashboard layout shell with sidebar navigation, and create login page.

Purpose: This is the foundation plan that all other Phase 4 plans depend on. Without auth, layout, and data fetching infrastructure, no dashboard pages can be built.

Output: Working dashboard shell with auth protection, sidebar nav (Overview, Treatments, Near-Misses, Workers), login page, and TanStack Query provider with 60-second polling default.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-dashboard/04-RESEARCH.md

# Existing web app context
@web/package.json
@web/lib/supabase.ts
@web/app/layout.tsx
@web/next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Supabase SSR utilities</name>
  <files>
    web/package.json
    web/lib/supabase/server.ts
    web/lib/supabase/client.ts
    web/lib/supabase/middleware.ts
    web/types/database.types.ts
    web/next.config.ts
  </files>
  <action>
Install Phase 4 dependencies in web/ directory using pnpm:
```bash
cd web && pnpm add @supabase/ssr @tanstack/react-table @tanstack/react-query recharts react-papaparse jspdf jspdf-autotable date-fns
pnpm add -D @types/jspdf
```

Then initialize shadcn/ui (if not already initialized):
```bash
npx shadcn@latest init
npx shadcn@latest add table button card input select badge dialog dropdown-menu separator sheet sidebar
```

Create Supabase SSR utilities following the @supabase/ssr pattern from research:

1. `web/lib/supabase/server.ts` - Server component client:
   - Export async `createClient()` function
   - Uses `createServerClient` from `@supabase/ssr`
   - Reads cookies from `next/headers` for auth
   - Uses existing NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY env vars

2. `web/lib/supabase/client.ts` - Browser client:
   - Export `createClient()` function
   - Uses `createBrowserClient` from `@supabase/ssr`
   - Replaces existing `web/lib/supabase.ts` (but keep old file to not break existing admin pages)

3. `web/lib/supabase/middleware.ts` - Middleware client:
   - Export `updateSession(request)` function
   - Creates server client with request/response cookie handling
   - Calls `supabase.auth.getUser()` (NOT getSession) for security
   - Redirects unauthenticated users to /login (except /login route itself, public pages like /, /pricing, /terms-and-conditions, etc.)

4. `web/types/database.types.ts` - Create a manual TypeScript types file with interfaces for:
   - `Treatment` (id, org_id, worker_id, medic_id, injury_type, body_part, severity, treatment_notes, outcome, is_riddor_reportable, riddor_confidence, photo_uris, signature_uri, created_at, updated_at, deleted_at)
   - `Worker` (id, org_id, first_name, last_name, company, role, phone, emergency_contact_name, emergency_contact_phone, health_notes, consent_given, consent_date, created_at, updated_at, deleted_at)
   - `NearMiss` (id, org_id, reported_by, category, severity, description, location, photo_uris, corrective_action, created_at, updated_at, deleted_at)
   - `SafetyCheck` (id, org_id, medic_id, check_date, items, overall_status, photo_uris, created_at, updated_at, deleted_at)
   - `TreatmentWithWorker` (Treatment & { worker: Worker | null })
   - Types match the Supabase schema in 00003_health_data_tables.sql

5. Update `web/next.config.ts`:
   - Add `images.remotePatterns` for Supabase Storage domain (use env var pattern: `process.env.NEXT_PUBLIC_SUPABASE_URL` hostname)
   - Keep existing config (reactStrictMode, poweredByHeader, compress, outputFileTracingRoot)

IMPORTANT: Do NOT modify or delete the existing `web/lib/supabase.ts` file -- the admin pages still use it. The new SSR utilities are ADDITIONAL files for the dashboard route group.
  </action>
  <verify>
- `cd web && pnpm build` compiles without type errors
- `web/lib/supabase/server.ts` exists with `createClient` export
- `web/lib/supabase/client.ts` exists with `createClient` export
- `web/lib/supabase/middleware.ts` exists with `updateSession` export
- `web/types/database.types.ts` exists with Treatment, Worker, NearMiss, SafetyCheck types
  </verify>
  <done>
All Phase 4 npm dependencies installed. Three Supabase SSR utility files created following @supabase/ssr patterns. TypeScript types match Supabase schema. Next.js config updated for image optimization. Existing admin pages unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth middleware, login page, and dashboard layout shell</name>
  <files>
    web/middleware.ts
    web/app/(auth)/login/page.tsx
    web/app/(auth)/layout.tsx
    web/app/(dashboard)/layout.tsx
    web/app/(dashboard)/page.tsx
    web/components/providers/query-provider.tsx
    web/app/layout.tsx
  </files>
  <action>
1. `web/middleware.ts` - Auth middleware:
   - Import `updateSession` from `@/lib/supabase/middleware`
   - Call `updateSession(request)` in middleware function
   - Matcher config: exclude static files, images, favicon, and public routes
   - Matcher: `/((?!_next/static|_next/image|favicon.ico|api/|pricing|terms-and-conditions|privacy-policy|refund-policy|cookie-policy|complaints|accessibility-statement|acceptable-use|$).*)`
   - IMPORTANT: Must allow root `/` and existing public pages through without auth

2. `web/app/(auth)/layout.tsx` - Auth layout:
   - Simple centered layout without dashboard shell
   - Clean white background with centered card

3. `web/app/(auth)/login/page.tsx` - Login page:
   - Client component with email/password form
   - Uses `createClient()` from `@/lib/supabase/client`
   - Calls `supabase.auth.signInWithPassword({ email, password })`
   - On success: redirect to `/` (dashboard overview)
   - Error display for invalid credentials
   - Styled with Tailwind (centered card, SiteMedic branding)
   - Include "Site Manager Dashboard" subtitle to clarify this is for managers, not medics

4. `web/components/providers/query-provider.tsx` - TanStack Query provider:
   - Client component ('use client')
   - Creates QueryClient with `useState` (prevents SSR issues)
   - Default options: `staleTime: 60_000`, `refetchInterval: 60_000` (60-second polling per DASH-09)
   - Wraps children in `QueryClientProvider`

5. `web/app/(dashboard)/layout.tsx` - Dashboard layout shell:
   - Server component that checks auth (redirect to /login if not authenticated)
   - Wraps children in `QueryProvider`
   - Responsive sidebar navigation:
     - Desktop (lg+): Fixed 256px sidebar with navigation links
     - Mobile/tablet: Hidden sidebar with hamburger menu (Sheet component from shadcn/ui)
   - Sidebar navigation links: Overview (/), Treatments (/treatments), Near-Misses (/near-misses), Workers (/workers)
   - Sidebar header with "SiteMedic" branding and "Dashboard" subtitle
   - Sidebar footer with user email and sign out button
   - Header bar with mobile menu button, page breadcrumb area
   - Sign out calls `supabase.auth.signOut()` then redirects to /login
   - Use Lucide React icons: LayoutDashboard (Overview), Stethoscope (Treatments), AlertTriangle (Near-Misses), Users (Workers)

6. `web/app/(dashboard)/page.tsx` - Placeholder overview page:
   - Simple server component with "Dashboard Overview" heading
   - Placeholder text: "Compliance score and weekly stats coming soon"
   - This will be replaced by Plan 04-02

7. Update `web/app/layout.tsx`:
   - Keep existing providers (CookieConsent, SkipToContent)
   - Ensure it does NOT conflict with route group layouts
   - Root layout stays minimal (html, body, metadata)
  </action>
  <verify>
- `cd web && pnpm build` compiles successfully
- Route structure: `/login` shows login form, `/` shows dashboard layout with sidebar
- `web/middleware.ts` exists and imports updateSession
- `web/app/(dashboard)/layout.tsx` renders sidebar with 4 navigation links
- `web/components/providers/query-provider.tsx` exists with 60-second polling default
  </verify>
  <done>
Auth middleware redirects unauthenticated users to /login. Login page allows email/password sign-in. Dashboard layout renders responsive sidebar (desktop: fixed sidebar, mobile: hamburger sheet). TanStack Query provider configured with 60-second polling. Navigation links: Overview, Treatments, Near-Misses, Workers.
  </done>
</task>

</tasks>

<verification>
1. `cd web && pnpm build` passes without errors
2. Navigating to `/` without auth redirects to `/login`
3. Login page renders with email/password form
4. After login, dashboard layout shows with sidebar navigation
5. Sidebar has 4 links: Overview, Treatments, Near-Misses, Workers
6. On mobile viewport, sidebar collapses to hamburger menu
7. Sign out button works and redirects to /login
</verification>

<success_criteria>
- All Phase 4 dependencies installed (shadcn/ui, TanStack Table, TanStack Query, @supabase/ssr, recharts, jspdf, react-papaparse)
- @supabase/ssr auth infrastructure operational (server client, browser client, middleware)
- Dashboard layout shell renders with responsive sidebar
- Auth middleware protects dashboard routes, allows public routes
- TanStack Query provider configured with 60-second default polling interval
- Existing admin pages and public pages unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-01-SUMMARY.md`
</output>
