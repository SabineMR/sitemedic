---
phase: 04-web-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - web/app/(dashboard)/page.tsx
  - web/components/dashboard/compliance-score.tsx
  - web/components/dashboard/stat-card.tsx
  - web/lib/queries/compliance.ts
autonomous: true

must_haves:
  truths:
    - "Site manager sees traffic-light indicator (red/amber/green) on overview page"
    - "Compliance score reflects daily check status, overdue follow-ups, expired certs, RIDDOR deadlines"
    - "Overview page shows weekly stats: treatments count, near-misses count, workers on site"
    - "Stats update via 60-second polling"
  artifacts:
    - path: "web/components/dashboard/compliance-score.tsx"
      provides: "Traffic-light compliance score component with breakdown details"
      min_lines: 40
    - path: "web/components/dashboard/stat-card.tsx"
      provides: "Reusable stat card for weekly summary numbers"
      min_lines: 15
    - path: "web/lib/queries/compliance.ts"
      provides: "Supabase queries for compliance data and weekly stats"
      exports: ["useComplianceData", "useWeeklyStats"]
    - path: "web/app/(dashboard)/page.tsx"
      provides: "Dashboard overview page composing compliance score and stat cards"
  key_links:
    - from: "web/app/(dashboard)/page.tsx"
      to: "web/lib/queries/compliance.ts"
      via: "Server component initial data fetch, passed to client components"
      pattern: "createClient.*from.*treatments|safety_checks"
    - from: "web/components/dashboard/compliance-score.tsx"
      to: "web/lib/queries/compliance.ts"
      via: "useComplianceData hook for 60-second polling"
      pattern: "useQuery.*compliance"
---

<objective>
Build the dashboard overview page with traffic-light compliance score (DASH-01, DASH-02) and weekly summary statistics (DASH-03). The compliance score evaluates daily check completion, overdue follow-ups, expired certifications, and RIDDOR deadlines. Weekly stats show treatment count, near-miss count, and active worker count.

Purpose: The overview page is the landing page site managers see when they log in. It provides immediate "at a glance" compliance status, answering the question "Is my site compliant right now?"

Output: Working overview page with red/amber/green compliance indicator, breakdown of compliance factors, and 4 weekly stat cards with 60-second polling.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-web-dashboard/04-RESEARCH.md
@.planning/phases/04-web-dashboard/04-01-SUMMARY.md

# Database schema for queries
@supabase/migrations/00003_health_data_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compliance data queries and weekly stats hooks</name>
  <files>
    web/lib/queries/compliance.ts
  </files>
  <action>
Create `web/lib/queries/compliance.ts` with:

1. **Server-side data fetching functions** (for initial page load):
   - `fetchComplianceData(supabase)` - Returns compliance indicators:
     - `dailyCheckDone`: boolean - Check if today's safety_check exists with overall_status != null for user's org
     - `overdueFollowups`: number - Count treatments where outcome = 'hospital_referral' or 'sent_home' created in last 7 days without a follow-up treatment for same worker (simplified: count treatments with these outcomes in last 7 days)
     - `expiredCerts`: number - Hard-code 0 for now (cert tracking is Phase 7, no cert expiry data exists yet)
     - `riddorDeadlines`: number - Count treatments where is_riddor_reportable = true AND created_at > NOW() - 15 days (active RIDDOR window)
   - `fetchWeeklyStats(supabase)` - Returns weekly summary:
     - `treatments`: number - Count treatments created this week (Monday to now)
     - `nearMisses`: number - Count near_misses created this week
     - `workersOnSite`: number - Count distinct worker_ids from treatments this week
     - `dailyChecksCompleted`: number - Count safety_checks this week with overall_status = 'pass'

2. **Client-side TanStack Query hooks** (for 60-second polling):
   - `useComplianceData(initialData)` - useQuery hook wrapping fetchComplianceData with 60-second refetchInterval
   - `useWeeklyStats(initialData)` - useQuery hook wrapping fetchWeeklyStats with 60-second refetchInterval
   - Both hooks accept `initialData` prop from server component

3. **Helper functions:**
   - `getWeekStart()` - Returns Monday 00:00 of current week as ISO string
   - `calculateComplianceStatus(data)` - Returns 'red' | 'amber' | 'green':
     - RED: dailyCheckDone === false OR riddorDeadlines > 0
     - AMBER: overdueFollowups > 0 OR expiredCerts > 0
     - GREEN: all clear

All queries filter by `deleted_at IS NULL` for soft-delete support. All queries use the user's auth context (RLS handles org filtering).
  </action>
  <verify>
- `web/lib/queries/compliance.ts` exists with exports: fetchComplianceData, fetchWeeklyStats, useComplianceData, useWeeklyStats, calculateComplianceStatus
- TypeScript compiles without errors
- Queries filter by deleted_at IS NULL
  </verify>
  <done>
Compliance data fetching works server-side and client-side. calculateComplianceStatus returns red/amber/green based on 4 compliance factors. Weekly stats aggregate treatments, near-misses, workers, and daily checks for current week.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build compliance score component, stat cards, and overview page</name>
  <files>
    web/components/dashboard/compliance-score.tsx
    web/components/dashboard/stat-card.tsx
    web/app/(dashboard)/page.tsx
  </files>
  <action>
1. `web/components/dashboard/compliance-score.tsx` - Client component ('use client'):
   - Props: `initialData: ComplianceData`
   - Uses `useComplianceData(initialData)` for 60-second polling
   - Large traffic-light circle (64x64px) with color:
     - Green (#10B981): "Compliant" - all checks passed
     - Amber (#F59E0B): "Attention Required" - non-critical issues
     - Red (#EF4444): "Critical Issues" - immediate action needed
   - Below the circle, show breakdown list:
     - Daily check: checkmark or X with "Daily safety check completed/not completed"
     - Follow-ups: count of overdue follow-ups (if > 0)
     - Certifications: count of expired certs (if > 0, "N expired certifications")
     - RIDDOR: count of active RIDDOR deadlines (if > 0, "N RIDDOR deadlines approaching")
   - Use Lucide React icons: CheckCircle2, XCircle, AlertTriangle, Clock
   - Wrap in a shadcn/ui Card component with "Compliance Status" heading
   - Add `aria-label` for accessibility on the traffic light

2. `web/components/dashboard/stat-card.tsx` - Client component ('use client'):
   - Reusable card showing a single stat with icon, value, and label
   - Props: `title: string`, `value: number`, `icon: LucideIcon`, `description?: string`
   - Use shadcn/ui Card with CardHeader and CardContent
   - Large bold number (text-3xl), title below (text-sm text-muted-foreground)
   - Icon in top-right corner of card

3. `web/app/(dashboard)/page.tsx` - Server component:
   - Fetch compliance data and weekly stats server-side using `createClient()` from `@/lib/supabase/server`
   - Pass initial data to client components as props (avoids loading state on first render)
   - Layout:
     - Page title: "Dashboard Overview"
     - Top section: ComplianceScore card (full width on mobile, 1/3 width on desktop)
     - Bottom section: 4 StatCards in a responsive grid (1 col mobile, 2 col tablet, 4 col desktop):
       - "Treatments This Week" (Stethoscope icon)
       - "Near-Misses This Week" (AlertTriangle icon)
       - "Workers on Site" (Users icon)
       - "Daily Checks Completed" (ClipboardCheck icon)
   - Use CSS grid: `grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4`

All components use Tailwind CSS for styling. Follow the server component -> client component data passing pattern from research.
  </action>
  <verify>
- `cd web && pnpm build` compiles successfully
- `web/app/(dashboard)/page.tsx` renders overview page with compliance score and 4 stat cards
- ComplianceScore displays red/amber/green circle with breakdown details
- StatCard renders title, value, and icon
- Responsive grid: 1 col on mobile, 4 cols on desktop
  </verify>
  <done>
Dashboard overview page displays traffic-light compliance score based on daily checks, overdue follow-ups, expired certs, and RIDDOR deadlines (DASH-01, DASH-02). Four weekly stat cards show treatments, near-misses, workers on site, and daily checks completed (DASH-03). Data polls every 60 seconds via TanStack Query (DASH-09).
  </done>
</task>

</tasks>

<verification>
1. `cd web && pnpm build` passes
2. Overview page shows compliance traffic light (green/amber/red)
3. Compliance score breakdown lists all 4 factors
4. Four stat cards display in responsive grid
5. Data refreshes every 60 seconds (verify with TanStack Query devtools or network tab)
</verification>

<success_criteria>
- Traffic-light compliance score visible on overview page (DASH-01)
- Score computed from daily check, follow-ups, expired certs, RIDDOR deadlines (DASH-02)
- Weekly stats shown: treatments, near-misses, workers, daily checks (DASH-03)
- 60-second polling active via TanStack Query (DASH-09)
- Responsive layout works on desktop and mobile viewports
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-02-SUMMARY.md`
</output>
