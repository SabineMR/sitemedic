---
phase: 04-web-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - web/app/(dashboard)/treatments/page.tsx
  - web/app/(dashboard)/treatments/[id]/page.tsx
  - web/components/dashboard/treatments-table.tsx
  - web/components/dashboard/treatments-columns.tsx
  - web/components/dashboard/data-table.tsx
  - web/components/dashboard/date-range-filter.tsx
  - web/lib/queries/treatments.ts
autonomous: true

must_haves:
  truths:
    - "Site manager can view treatment log as a sortable, filterable table"
    - "Site manager can filter treatments by date range, severity, injury type, worker name, and outcome"
    - "Site manager can click a treatment row to see full detail view"
    - "Treatment detail shows all fields including photos from Supabase Storage"
    - "Treatment list polls every 60 seconds for updates"
  artifacts:
    - path: "web/app/(dashboard)/treatments/page.tsx"
      provides: "Treatment log list page (server component for initial data)"
    - path: "web/app/(dashboard)/treatments/[id]/page.tsx"
      provides: "Treatment detail page with photos, full record, worker info"
    - path: "web/components/dashboard/treatments-table.tsx"
      provides: "Client component wrapping TanStack Table with filters and polling"
      min_lines: 60
    - path: "web/components/dashboard/data-table.tsx"
      provides: "Reusable data table component using shadcn/ui Table + TanStack Table"
      min_lines: 50
    - path: "web/lib/queries/treatments.ts"
      provides: "Supabase queries and TanStack Query hooks for treatments"
      exports: ["fetchTreatments", "useTreatments", "fetchTreatmentById"]
  key_links:
    - from: "web/app/(dashboard)/treatments/page.tsx"
      to: "web/lib/queries/treatments.ts"
      via: "Server-side fetchTreatments for initial data"
      pattern: "fetchTreatments"
    - from: "web/components/dashboard/treatments-table.tsx"
      to: "web/lib/queries/treatments.ts"
      via: "useTreatments hook for 60-second polling"
      pattern: "useTreatments"
    - from: "web/app/(dashboard)/treatments/[id]/page.tsx"
      to: "web/lib/queries/treatments.ts"
      via: "fetchTreatmentById for detail page data"
      pattern: "fetchTreatmentById"
---

<objective>
Build the treatment log page with full filtering/sorting capabilities (DASH-04), treatment detail page with photo display (DASH-05), and 60-second polling (DASH-09). The treatment log is a TanStack Table with date range, severity, injury type, worker, and outcome column filters. Clicking a row navigates to a detail view showing all treatment fields and photos.

Purpose: The treatment log is the most-used page for site managers. It provides complete visibility into all medical treatments on site, enabling compliance oversight and audit preparation.

Output: Treatment list page with interactive TanStack Table (filter, sort, paginate), treatment detail page with photos from Supabase Storage, both polling every 60 seconds.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-web-dashboard/04-RESEARCH.md
@.planning/phases/04-web-dashboard/04-01-SUMMARY.md

# Database schema
@supabase/migrations/00003_health_data_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable data table component and treatment queries</name>
  <files>
    web/components/dashboard/data-table.tsx
    web/components/dashboard/date-range-filter.tsx
    web/lib/queries/treatments.ts
  </files>
  <action>
1. `web/components/dashboard/data-table.tsx` - Reusable data table ('use client'):
   - Generic component: `DataTable<TData, TValue>` accepting `columns: ColumnDef<TData, TValue>[]` and `data: TData[]`
   - Uses `useReactTable` with: getCoreRowModel, getSortedRowModel, getFilteredRowModel, getPaginationRowModel
   - State: sorting, columnFilters, globalFilter
   - Renders using shadcn/ui Table components (Table, TableHeader, TableBody, TableRow, TableHead, TableCell)
   - Includes pagination controls at bottom: Previous/Next buttons, "Page X of Y" indicator, page size selector (25, 50, 100)
   - Includes global search input at top using shadcn/ui Input
   - Empty state: "No results found" centered in table body
   - Column headers are clickable for sorting (show sort direction arrow)
   - Use `flexRender` for cell and header rendering
   - Follow shadcn/ui data table pattern from research

2. `web/components/dashboard/date-range-filter.tsx` - Date range filter ('use client'):
   - Two date inputs (From, To) using native HTML date inputs (not a complex date picker library)
   - Props: `onDateRangeChange(from: string | null, to: string | null)`
   - Clear button to reset date range
   - Compact inline layout

3. `web/lib/queries/treatments.ts` - Treatment data queries:
   - `fetchTreatments(supabase)` - Server-side fetch:
     - Query: `supabase.from('treatments').select('*, worker:workers(id, first_name, last_name, company)').is('deleted_at', null).order('created_at', { ascending: false }).limit(500)`
     - Returns TreatmentWithWorker[]
   - `fetchTreatmentById(supabase, id)` - Server-side single treatment:
     - Query: `supabase.from('treatments').select('*, worker:workers(*)').eq('id', id).single()`
     - Returns full TreatmentWithWorker with all worker fields
   - `useTreatments(initialData)` - Client-side hook:
     - useQuery with queryKey ['treatments']
     - queryFn: fetch treatments using browser client
     - initialData from server component
     - refetchInterval: 60_000 (60-second polling)
   - All queries filter `deleted_at IS NULL` and let RLS handle org scoping
  </action>
  <verify>
- `web/components/dashboard/data-table.tsx` exists with generic DataTable component
- `web/lib/queries/treatments.ts` exists with fetchTreatments, fetchTreatmentById, useTreatments exports
- TypeScript compiles without errors
  </verify>
  <done>
Reusable DataTable component built with TanStack Table + shadcn/ui (sorting, filtering, pagination). Treatment queries handle server-side initial fetch and client-side 60-second polling. Date range filter component ready for table integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build treatment log page, columns, and detail view</name>
  <files>
    web/components/dashboard/treatments-columns.tsx
    web/components/dashboard/treatments-table.tsx
    web/app/(dashboard)/treatments/page.tsx
    web/app/(dashboard)/treatments/[id]/page.tsx
  </files>
  <action>
1. `web/components/dashboard/treatments-columns.tsx` - Column definitions:
   - Define `columns: ColumnDef<TreatmentWithWorker>[]` with columns:
     - **Date**: `created_at` formatted with date-fns `format(date, 'dd/MM/yyyy HH:mm')` (UK format). Render in client component to avoid hydration mismatch. Sortable.
     - **Worker**: `worker.first_name + ' ' + worker.last_name` (fallback 'Unknown Worker'). Filterable with includesString filter.
     - **Injury Type**: `injury_type`. Filterable.
     - **Severity**: `severity` rendered as colored Badge (green for minor, amber for moderate, red for major, dark-red for critical). Filterable with select filter.
     - **Outcome**: `outcome` rendered as readable text (replace underscores with spaces, capitalize). Filterable with select filter.
     - **RIDDOR**: `is_riddor_reportable` rendered as red "RIDDOR" badge if true, empty if false
     - **Actions**: Link/button to view detail (`/treatments/{id}`)
   - Column meta includes filter options for select filters (severity: minor/moderate/major/critical, outcome: returned_to_work/sent_home/hospital_referral/ambulance_called)

2. `web/components/dashboard/treatments-table.tsx` - Treatment table wrapper ('use client'):
   - Props: `initialData: TreatmentWithWorker[]`
   - Uses `useTreatments(initialData)` for polling data
   - Renders filter controls above the DataTable:
     - DateRangeFilter component for date filtering
     - Severity select filter (All / Minor / Moderate / Major / Critical)
     - Outcome select filter (All / Returned to Work / Sent Home / Hospital Referral / Ambulance Called)
     - Worker name text search
   - Client-side date range filtering: filter treatments array by created_at within date range before passing to DataTable
   - Row click handler: navigate to `/treatments/${row.original.id}` using `useRouter()`
   - Renders DataTable with columns and filtered data

3. `web/app/(dashboard)/treatments/page.tsx` - Treatment log page (server component):
   - Page title: "Treatment Log"
   - Fetch initial treatments server-side using fetchTreatments
   - Pass initialData to TreatmentsTable client component
   - Include count text: "X treatments recorded"

4. `web/app/(dashboard)/treatments/[id]/page.tsx` - Treatment detail page (server component):
   - Fetch treatment by ID using fetchTreatmentById
   - If not found: show "Treatment not found" with back button
   - Display all treatment fields in organized sections:
     - **Header**: Reference number, date, RIDDOR badge (if applicable)
     - **Worker Info**: Name, company, role (linked from workers table)
     - **Injury Details**: Type, body part, severity (colored badge), mechanism of injury
     - **Treatment**: Treatment notes, treatment types given
     - **Outcome**: Outcome with colored badge, follow-up notes
     - **Photos**: Grid of treatment photos loaded from Supabase Storage using Next.js Image component. Use `supabase.storage.from('treatment-photos').getPublicUrl(photoPath)` to get URLs. Display in responsive grid (1 col mobile, 2 cols tablet, 3 cols desktop). Show thumbnail initially, click to view full size in dialog.
     - **Signature**: Display signature image if signature_uri exists
   - Back button to return to treatment log (`/treatments`)
   - Use shadcn/ui Card components for section organization
   - Dates rendered in client component wrapper to avoid hydration mismatch (use `suppressHydrationWarning` or a ClientDate component)
  </action>
  <verify>
- `cd web && pnpm build` compiles successfully
- Treatment log page renders table with 7 columns (Date, Worker, Injury Type, Severity, Outcome, RIDDOR, Actions)
- Filter controls render above table (date range, severity, outcome, worker search)
- Treatment detail page shows all fields including photo grid
- Pagination shows at bottom of table
  </verify>
  <done>
Treatment log page displays interactive table with date range, severity, injury type, worker, and outcome filters (DASH-04). Treatment detail page shows full record including photos from Supabase Storage (DASH-05). Both pages poll every 60 seconds (DASH-09). Table supports sorting, pagination (25/50/100 per page), and global search.
  </done>
</task>

</tasks>

<verification>
1. `cd web && pnpm build` passes
2. `/treatments` page shows sortable, filterable treatment table
3. Date range filter narrows results by date
4. Severity and outcome select filters work
5. Worker name search filters table rows
6. Clicking a treatment row navigates to `/treatments/[id]`
7. Treatment detail page displays all fields including photos
8. Table paginates at 25/50/100 rows per page
9. Data refreshes every 60 seconds
</verification>

<success_criteria>
- Treatment log with interactive filtering by date range, severity, injury type, worker, outcome (DASH-04)
- Full treatment detail view with photos from Supabase Storage (DASH-05)
- 60-second polling active (DASH-09)
- Reusable DataTable component available for near-misses and workers pages
- UK date format (dd/MM/yyyy) used throughout
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-03-SUMMARY.md`
</output>
