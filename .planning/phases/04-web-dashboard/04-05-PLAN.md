---
phase: 04-web-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["04-03", "04-04"]
files_modified:
  - web/lib/utils/export-csv.ts
  - web/lib/utils/export-pdf.ts
  - web/components/dashboard/export-buttons.tsx
  - web/components/dashboard/treatments-table.tsx
  - web/components/dashboard/workers-table.tsx
autonomous: true

must_haves:
  truths:
    - "Site manager can export treatment log as CSV with all columns"
    - "Site manager can export treatment log as formatted PDF report"
    - "Site manager can export worker registry as CSV with all columns including cert status"
    - "Dashboard works on desktop and tablet viewports without horizontal scrolling"
  artifacts:
    - path: "web/lib/utils/export-csv.ts"
      provides: "CSV export utility using react-papaparse"
      exports: ["exportTreatmentsCSV", "exportWorkersCSV"]
    - path: "web/lib/utils/export-pdf.ts"
      provides: "PDF export utility using jsPDF + jspdf-autotable"
      exports: ["exportTreatmentsPDF"]
    - path: "web/components/dashboard/export-buttons.tsx"
      provides: "Export button group component with CSV and PDF options"
  key_links:
    - from: "web/components/dashboard/treatments-table.tsx"
      to: "web/lib/utils/export-csv.ts"
      via: "Export CSV button calls exportTreatmentsCSV with current filtered data"
      pattern: "exportTreatmentsCSV"
    - from: "web/components/dashboard/treatments-table.tsx"
      to: "web/lib/utils/export-pdf.ts"
      via: "Export PDF button calls exportTreatmentsPDF with current filtered data"
      pattern: "exportTreatmentsPDF"
    - from: "web/components/dashboard/workers-table.tsx"
      to: "web/lib/utils/export-csv.ts"
      via: "Export CSV button calls exportWorkersCSV with current data"
      pattern: "exportWorkersCSV"
---

<objective>
Add CSV and PDF export capabilities to the treatment log and worker registry (EXPORT-01, EXPORT-02, EXPORT-03), and ensure the dashboard is fully responsive on desktop and tablets (DASH-10).

Purpose: Export functionality is critical for HSE audits -- site managers need downloadable evidence. Responsive design ensures tablet access in site offices.

Output: Export buttons on treatment log (CSV + PDF) and worker registry (CSV). All dashboard pages work on desktop, tablet, and mobile viewports.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-web-dashboard/04-RESEARCH.md
@.planning/phases/04-web-dashboard/04-03-SUMMARY.md
@.planning/phases/04-web-dashboard/04-04-SUMMARY.md

# Files to modify
@web/components/dashboard/treatments-table.tsx
@web/components/dashboard/workers-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export utilities and export button component</name>
  <files>
    web/lib/utils/export-csv.ts
    web/lib/utils/export-pdf.ts
    web/components/dashboard/export-buttons.tsx
  </files>
  <action>
1. `web/lib/utils/export-csv.ts` - CSV export using react-papaparse:
   - `exportTreatmentsCSV(treatments: TreatmentWithWorker[])`:
     - Map treatments to flat CSV rows with columns: Date, Reference, Worker Name, Company, Injury Type, Body Part, Severity, Treatment Notes, Outcome, RIDDOR Reportable, Created At
     - Date formatted as 'dd/MM/yyyy HH:mm' (UK format) using date-fns
     - Use `jsonToCSV()` from react-papaparse (handles escaping, delimiters, special chars)
     - Create Blob with BOM prefix (\uFEFF) for Excel UTF-8 compatibility
     - Trigger download with filename: `treatments-export-YYYY-MM-DD.csv`
     - IMPORTANT: Use react-papaparse, do NOT build CSV strings manually (Pitfall 7 from research)
   - `exportWorkersCSV(workers: Worker[])`:
     - Map workers to flat CSV rows with columns: Last Name, First Name, Company, Role, Phone, Emergency Contact Name, Emergency Contact Phone, Health Notes, Consent Given, Consent Date, Certification Status, Added Date
     - Certification Status: hard-code "Active" for now (Phase 7 will provide real data)
     - Trigger download with filename: `worker-registry-YYYY-MM-DD.csv`

2. `web/lib/utils/export-pdf.ts` - PDF export using jsPDF + jspdf-autotable:
   - `exportTreatmentsPDF(treatments: TreatmentWithWorker[])`:
     - Create A4 landscape PDF document
     - Header: "Treatment Log Report" (bold, 18pt), "SiteMedic" subtitle, generation date
     - Table columns: Date, Worker, Injury Type, Severity, Outcome, RIDDOR
     - Use `autoTable` for formatted table with:
       - Header row: dark background (#1E293B), white text
       - Alternating row colors for readability
       - Auto column widths
       - Page break handling for long reports
     - Footer: "Generated by SiteMedic Dashboard" + page number
     - Severity column: use colored text (green for minor, amber for moderate, red for major/critical)
     - Trigger download with filename: `treatment-log-YYYY-MM-DD.pdf`

3. `web/components/dashboard/export-buttons.tsx` - Export button group ('use client'):
   - Props: `onExportCSV: () => void`, `onExportPDF?: () => void`, `label?: string`
   - Renders dropdown menu button using shadcn/ui DropdownMenu:
     - Button text: "Export" with Download icon
     - Menu items: "Export as CSV", "Export as PDF" (only if onExportPDF provided)
   - Loading state: disable button and show spinner while export is generating
   - Use Lucide React icons: Download, FileSpreadsheet (CSV), FileText (PDF)
  </action>
  <verify>
- `web/lib/utils/export-csv.ts` exists with exportTreatmentsCSV and exportWorkersCSV
- `web/lib/utils/export-pdf.ts` exists with exportTreatmentsPDF
- `web/components/dashboard/export-buttons.tsx` exists with ExportButtons component
- TypeScript compiles without errors
  </verify>
  <done>
CSV export utility handles treatments and workers with proper escaping via react-papaparse. PDF export generates formatted A4 landscape report with autoTable. Export button component provides dropdown with CSV and PDF options.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate export buttons into tables and responsive polish</name>
  <files>
    web/components/dashboard/treatments-table.tsx
    web/components/dashboard/workers-table.tsx
    web/components/dashboard/data-table.tsx
    web/app/(dashboard)/layout.tsx
  </files>
  <action>
1. Update `web/components/dashboard/treatments-table.tsx`:
   - Add ExportButtons component above the DataTable, next to filter controls
   - Wire onExportCSV to call `exportTreatmentsCSV(filteredData)` with currently filtered data
   - Wire onExportPDF to call `exportTreatmentsPDF(filteredData)` with currently filtered data
   - Exports use the FILTERED data (not all data) so manager exports only what they see
   - Layout: filters on left, export button on right (flex justify-between)

2. Update `web/components/dashboard/workers-table.tsx`:
   - Add ExportButtons component above the DataTable, next to search controls
   - Wire onExportCSV to call `exportWorkersCSV(filteredData)` with currently filtered data
   - No PDF export for workers (only CSV per EXPORT-03)
   - Layout: search on left, export button on right

3. Responsive polish for DASH-10 (desktop-focused, tablet-friendly):
   - Review DataTable: On narrow screens (<768px), make table horizontally scrollable with `overflow-x-auto` wrapper
   - Review filter controls: Stack filters vertically on mobile (flex-col on mobile, flex-row on desktop)
   - Review dashboard layout sidebar: Verify it collapses to hamburger on mobile/tablet
   - Review stat cards: Verify 1-col mobile, 2-col tablet, 4-col desktop grid
   - Review treatment detail page: Stack sections vertically on mobile
   - Add `min-w-[800px]` to table element inside overflow wrapper so columns don't compress too much on tablet
   - Test that export buttons are accessible on mobile (not hidden by overflow)

4. Review `web/app/(dashboard)/layout.tsx`:
   - Ensure the main content area has proper padding: `p-4 lg:p-6` (less on mobile for more content space)
   - Header should show current page name for context
   - Mobile hamburger menu should close on navigation
  </action>
  <verify>
- `cd web && pnpm build` compiles successfully
- Treatment log page has Export button with CSV and PDF options
- Worker registry page has Export button with CSV option
- Export uses currently filtered data
- Tables scroll horizontally on narrow viewports
- Filter controls stack on mobile
- Sidebar collapses to hamburger on mobile
  </verify>
  <done>
Export buttons integrated into treatment log (CSV + PDF, EXPORT-01, EXPORT-02) and worker registry (CSV, EXPORT-03). Exports use filtered data. Dashboard is responsive: desktop sidebar, mobile hamburger, horizontal table scroll on narrow screens, stacked filters on mobile (DASH-10).
  </done>
</task>

</tasks>

<verification>
1. `cd web && pnpm build` passes
2. Treatment log Export dropdown shows "Export as CSV" and "Export as PDF"
3. Clicking "Export as CSV" downloads a CSV file with UK date format
4. Clicking "Export as PDF" downloads a formatted PDF with header and table
5. Worker registry Export dropdown shows "Export as CSV" only
6. Exports contain filtered data (apply filters first, then export)
7. Dashboard works on 1024px viewport (tablet) without horizontal scrolling of layout
8. Tables scroll horizontally within their container on narrow viewports
</verification>

<success_criteria>
- Treatment log CSV export with all columns (EXPORT-01)
- Treatment log PDF export with formatted report (EXPORT-02)
- Worker registry CSV export with cert status column (EXPORT-03)
- Dashboard responsive on desktop and tablets (DASH-10)
- Export uses filtered data for relevance
- CSV handles special characters (commas, quotes) via react-papaparse
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-dashboard/04-05-SUMMARY.md`
</output>
