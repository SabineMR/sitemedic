---
phase: 04.5-marketing-booking
plan: 02
type: execute
wave: 2
depends_on: ["04.5-01"]
files_modified:
  - web/app/(booking)/layout.tsx
  - web/app/(booking)/book/page.tsx
  - web/components/booking/calendar-picker.tsx
  - web/components/booking/location-input.tsx
  - web/components/booking/shift-config.tsx
  - web/components/booking/pricing-breakdown.tsx
  - web/components/booking/booking-form.tsx
  - web/lib/booking/pricing.ts
  - web/lib/booking/types.ts
  - web/components/ui/calendar.tsx
  - web/components/ui/popover.tsx
autonomous: true

must_haves:
  truths:
    - "Client can select booking date from a calendar (past dates disabled)"
    - "Client can enter site location (address and postcode)"
    - "Client can configure shift details (hours, start time, special requirements)"
    - "Pricing breakdown shows base + urgency premium + travel + VAT in real-time"
    - "Urgency premium automatically calculated based on how far in advance booking is made"
  artifacts:
    - path: "web/app/(booking)/book/page.tsx"
      provides: "Booking flow page with multi-step form"
      contains: "BookingForm"
    - path: "web/components/booking/calendar-picker.tsx"
      provides: "Date picker with disabled past dates and urgency indicators"
      contains: "use client"
    - path: "web/components/booking/location-input.tsx"
      provides: "Site address and postcode input fields"
      contains: "postcode"
    - path: "web/components/booking/pricing-breakdown.tsx"
      provides: "Real-time pricing display with base, urgency, travel, VAT"
      contains: "VAT"
    - path: "web/lib/booking/pricing.ts"
      provides: "Client-side pricing calculation mirroring Edge Function logic"
      exports: ["calculateBookingPrice"]
    - path: "web/lib/booking/types.ts"
      provides: "TypeScript types for booking flow"
      exports: ["BookingFormData", "PricingBreakdown"]
  key_links:
    - from: "web/components/booking/booking-form.tsx"
      to: "web/lib/booking/pricing.ts"
      via: "Real-time pricing calculation on form change"
      pattern: "calculateBookingPrice"
    - from: "web/components/booking/booking-form.tsx"
      to: "web/components/booking/calendar-picker.tsx"
      via: "Date selection updates form state"
      pattern: "onDateSelect"
    - from: "web/app/(booking)/book/page.tsx"
      to: "web/components/booking/booking-form.tsx"
      via: "Page renders the main booking form component"
      pattern: "BookingForm"
---

<objective>
Build the booking portal calendar and site location input flow where clients select dates, enter site details, configure shift requirements, and see real-time pricing breakdown.

Purpose: This is the first step of the client booking journey (calendar -> location -> payment -> confirmation). The form captures all booking parameters needed for pricing calculation and medic matching. Real-time pricing transparency (showing base + urgency + travel + VAT) builds client trust.

Output: Working booking page at /book with calendar picker, location input, shift configuration, and live pricing breakdown.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.5-marketing-booking/04.5-RESEARCH.md
@.planning/phases/04.5-marketing-booking/04.5-01-SUMMARY.md

Key existing files:
@web/components/ui/ (existing shadcn/ui components)
@supabase/functions/calculate-pricing/index.ts (server-side pricing logic to mirror)
@supabase/migrations/002_business_operations.sql (bookings table schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, add shadcn/ui Calendar + Popover, create booking types and pricing utility</name>
  <files>
    web/components/ui/calendar.tsx
    web/components/ui/popover.tsx
    web/lib/booking/types.ts
    web/lib/booking/pricing.ts
  </files>
  <action>
    1. **Install new dependencies** via pnpm in the web/ directory:
       ```
       pnpm add @radix-ui/react-popover react-day-picker
       ```
       Note: react-day-picker and @radix-ui/react-popover may already be installed (check package.json first). date-fns 4.1.0 is already installed.

    2. **Add shadcn/ui Calendar component.** Run from web/ directory:
       ```
       npx shadcn@latest add calendar popover
       ```
       If the CLI doesn't work, manually create:
       - web/components/ui/calendar.tsx - shadcn/ui Calendar wrapper around react-day-picker. Standard shadcn/ui implementation with cn() utility for className merging.
       - web/components/ui/popover.tsx - shadcn/ui Popover wrapper around @radix-ui/react-popover. Standard shadcn/ui implementation.

    3. **web/lib/booking/types.ts** - Create TypeScript types for the booking flow:
       ```typescript
       export interface BookingFormData {
         // Date selection
         shiftDate: Date | undefined;
         shiftStartTime: string; // "07:00", "08:00", etc.
         shiftEndTime: string;   // "15:00", "16:00", etc.
         shiftHours: number;     // Calculated from start/end times

         // Site location
         siteName: string;
         siteAddress: string;
         sitePostcode: string;
         siteContactName: string;
         siteContactPhone: string;

         // Special requirements
         confinedSpaceRequired: boolean;
         traumaSpecialistRequired: boolean;
         specialNotes: string;

         // Recurring
         isRecurring: boolean;
         recurrencePattern: 'weekly' | 'biweekly' | null;
         recurringWeeks: number; // How many weeks to repeat

         // Client (set after auth/registration)
         clientId: string | null;
       }

       export interface PricingBreakdown {
         baseRate: number;        // Per hour (GBP)
         shiftHours: number;
         hourlyTotal: number;     // baseRate * shiftHours
         urgencyPremiumPercent: number; // 0, 20, 50, 75
         urgencyAmount: number;
         travelSurcharge: number;
         subtotal: number;        // Before VAT
         vat: number;             // 20%
         total: number;           // Client pays this
         platformFee: number;     // 40%
         medicPayout: number;     // 60%
       }

       export type UrgencyLevel = 'standard' | 'short_notice' | 'urgent' | 'emergency';
       ```

    4. **web/lib/booking/pricing.ts** - Client-side pricing calculation that mirrors the Edge Function logic from supabase/functions/calculate-pricing/index.ts:
       ```typescript
       export function calculateBookingPrice(params: {
         shiftHours: number;
         baseRate?: number;          // Default GBP 42/hr (GBP 350/8hr day)
         urgencyPremiumPercent?: number;
         travelSurcharge?: number;
       }): PricingBreakdown
       ```

       Urgency premium rules (match existing Edge Function):
       - 7+ days advance: 0% (standard)
       - 4-6 days advance: 20% (short notice)
       - 1-3 days advance: 50% (urgent)
       - Less than 24 hours: 75% (emergency)

       Export a helper: `getUrgencyPremium(shiftDate: Date): { percent: number; level: UrgencyLevel; label: string }` that calculates urgency based on days until shift.

       All monetary values rounded to 2 decimal places. VAT at 20%. Platform split: 40% platform, 60% medic.

       IMPORTANT: This is a PURE function with no side effects. It mirrors the Edge Function exactly so the client sees the same prices the server will calculate. The server-side Edge Function remains the source of truth for actual charges.
  </action>
  <verify>
    Run `pnpm build` from web/ directory. Verify: web/components/ui/calendar.tsx exists, web/components/ui/popover.tsx exists, web/lib/booking/types.ts compiles, web/lib/booking/pricing.ts exports calculateBookingPrice and getUrgencyPremium.
  </verify>
  <done>
    shadcn/ui Calendar and Popover components installed. BookingFormData and PricingBreakdown types defined. Client-side pricing calculation mirrors Edge Function logic with urgency premium auto-detection. All files compile without TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create booking form components and /book page</name>
  <files>
    web/components/booking/calendar-picker.tsx
    web/components/booking/location-input.tsx
    web/components/booking/shift-config.tsx
    web/components/booking/pricing-breakdown.tsx
    web/components/booking/booking-form.tsx
    web/app/(booking)/layout.tsx
    web/app/(booking)/book/page.tsx
  </files>
  <action>
    Create the booking flow UI components and page:

    1. **web/components/booking/calendar-picker.tsx** - 'use client' component.
       - Uses shadcn/ui Calendar component in a Popover for date selection
       - Disables past dates and same-day dates (minimum 1 day advance for booking)
       - Shows urgency level indicator below calendar: green "Standard" (7+ days), yellow "Short Notice +20%" (4-6 days), orange "Urgent +50%" (1-3 days)
       - Props: `{ selectedDate: Date | undefined; onDateSelect: (date: Date) => void }`
       - Display format: "dd MMMM yyyy" (e.g., "15 March 2026") using date-fns format
       - When date selected, show urgency badge next to selected date display

    2. **web/components/booking/location-input.tsx** - 'use client' component.
       - Input fields for: Site Name (text, required), Site Address (textarea, required), Site Postcode (text, required, UK postcode format hint), Site Contact Name (text, required), Site Contact Phone (text, required)
       - Postcode field has placeholder "e.g., SW1A 1AA" and validates basic UK postcode format (letters + numbers, 5-8 chars)
       - Uses shadcn/ui Input component for all fields
       - Props: `{ formData: BookingFormData; onChange: (updates: Partial<BookingFormData>) => void }`

    3. **web/components/booking/shift-config.tsx** - 'use client' component.
       - Shift start time: Select dropdown with 30-min increments from 06:00 to 12:00
       - Shift end time: Auto-calculated based on minimum 8 hours, Select dropdown from (start + 8h) to 20:00
       - Shift hours: Auto-calculated display (e.g., "8 hours")
       - Checkboxes: "Confined space certification required", "Trauma specialist required"
       - Special notes: Textarea for additional requirements
       - Recurring booking toggle: Checkbox "Recurring booking", if checked: Select for "Weekly" or "Biweekly", Number input for "Number of weeks" (1-52)
       - Props: `{ formData: BookingFormData; onChange: (updates: Partial<BookingFormData>) => void }`

    4. **web/components/booking/pricing-breakdown.tsx** - 'use client' component.
       - Displays real-time pricing calculated from form data
       - Line items: Base rate (GBP X/hr x Y hours), Urgency premium (if applicable, with percentage), Travel surcharge (if applicable), Subtotal, VAT (20%), **Total** (bold, large)
       - Uses calculateBookingPrice from web/lib/booking/pricing.ts
       - Updates live as form values change (passed pricing object as prop)
       - Gray background card with clear typography, amounts right-aligned
       - Props: `{ pricing: PricingBreakdown | null }`

    5. **web/components/booking/booking-form.tsx** - 'use client' component. Main orchestrator.
       - Manages BookingFormData state with useState
       - Composes: CalendarPicker, LocationInput, ShiftConfig, PricingBreakdown
       - Layout: Single-page form (NOT multi-step wizard). Left column (2/3 width on desktop): calendar + location + shift config in sections with headings. Right column (1/3 width on desktop, full width on mobile): sticky pricing breakdown card.
       - Recalculates pricing on every form change using calculateBookingPrice
       - "Continue to Payment" button at bottom (disabled until all required fields filled). This button will be wired to payment flow in Plan 03.
       - For now, the button stores form data in sessionStorage and navigates to /book/payment (page created in Plan 03)

    6. **web/app/(booking)/layout.tsx** - Server Component layout for booking pages.
       - Import SiteHeader from @/components/marketing/site-header (reuse from Plan 01)
       - Minimal layout: SiteHeader + main content area with max-w-6xl centering + padding
       - No SiteFooter in booking flow (cleaner conversion-focused layout, but add a small "Guardian Medics" text + back link at bottom)

    7. **web/app/(booking)/book/page.tsx** - Server Component page.
       - Export metadata: title "Book a Medic - Guardian Medics", description about booking qualified paramedics
       - Renders a heading "Book a Medic" with subtext "Select your dates and site details"
       - Renders BookingForm component (client component)
       - This page does NOT use force-static (it's dynamic by default for booking context)

    IMPORTANT: Use shadcn/ui components (Input, Button, Select, Card) for all form elements for visual consistency with the existing dashboard.
  </action>
  <verify>
    Run `pnpm build` from web/ directory. Navigate to http://localhost:30500/book. Verify: calendar picker shows and allows date selection, location fields accept input, shift config calculates hours, pricing breakdown updates in real-time as form values change, "Continue to Payment" button appears.
  </verify>
  <done>
    Booking page at /book renders with calendar picker, location input, shift configuration, and live pricing breakdown. All form inputs work. Urgency premium auto-calculates based on selected date. Pricing updates in real-time. "Continue to Payment" button navigates to /book/payment. Layout uses shared SiteHeader from Plan 01.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds without errors
2. /book page renders with all form sections (calendar, location, shift, pricing)
3. Calendar picker disables past dates
4. Selecting a date 2 days from now shows "Urgent +50%" badge
5. Selecting a date 10 days from now shows "Standard" badge
6. Entering shift hours recalculates pricing breakdown in real-time
7. Pricing shows base + urgency + subtotal + VAT + total
8. "Continue to Payment" button is disabled when required fields empty
9. "Continue to Payment" button is enabled when all required fields filled
10. Responsive layout: 2 columns on desktop, stacked on mobile
</verification>

<success_criteria>
- Booking page accessible at /book with all form sections
- Calendar picker with urgency indicators working
- Real-time pricing breakdown matching Edge Function logic
- Location input with UK postcode field
- Shift configuration with minimum 8 hours enforcement
- Recurring booking toggle with weekly/biweekly options
- "Continue to Payment" button ready for Plan 03 wiring
- `pnpm build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-marketing-booking/04.5-02-SUMMARY.md`
</output>
