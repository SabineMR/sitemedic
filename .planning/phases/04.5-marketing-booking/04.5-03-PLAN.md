---
phase: 04.5-marketing-booking
plan: 03
type: execute
wave: 2
depends_on: ["04.5-01"]
files_modified:
  - web/app/api/bookings/create-payment-intent/route.ts
  - web/app/api/bookings/create/route.ts
  - web/app/api/stripe/webhooks/route.ts
  - web/lib/stripe/client.ts
  - web/lib/stripe/server.ts
  - web/components/booking/payment-form.tsx
  - web/components/booking/net30-confirmation.tsx
  - web/app/(booking)/book/payment/page.tsx
autonomous: true

user_setup:
  - service: stripe
    why: "Client-facing payment processing for booking prepayment"
    env_vars:
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key (starts with sk_test_)"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint -> Signing secret (after creating endpoint for /api/stripe/webhooks)"
    dashboard_config:
      - task: "Create webhook endpoint pointing to {your-domain}/api/stripe/webhooks"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"

must_haves:
  truths:
    - "New client sees card payment form (Stripe Payment Element) with 3D Secure support"
    - "Established client (payment_terms='net_30') sees Net 30 confirmation without card payment"
    - "Stripe Payment Intent created server-side with correct GBP amount matching pricing breakdown"
    - "Successful payment triggers payment_intent.succeeded webhook updating booking status"
    - "Booking record created in database with all pricing fields populated"
  artifacts:
    - path: "web/app/api/bookings/create-payment-intent/route.ts"
      provides: "POST endpoint creating Stripe Payment Intent for prepay clients"
      exports: ["POST"]
    - path: "web/app/api/bookings/create/route.ts"
      provides: "POST endpoint creating booking record in database"
      exports: ["POST"]
    - path: "web/app/api/stripe/webhooks/route.ts"
      provides: "POST endpoint handling Stripe webhook events"
      exports: ["POST"]
    - path: "web/lib/stripe/client.ts"
      provides: "Client-side Stripe.js initialization"
      contains: "loadStripe"
    - path: "web/lib/stripe/server.ts"
      provides: "Server-side Stripe SDK initialization"
      contains: "new Stripe"
    - path: "web/components/booking/payment-form.tsx"
      provides: "Stripe Payment Element form for card payment"
      contains: "PaymentElement"
    - path: "web/app/(booking)/book/payment/page.tsx"
      provides: "Payment step page rendering PaymentForm or Net30Confirmation"
      contains: "payment"
  key_links:
    - from: "web/components/booking/payment-form.tsx"
      to: "web/app/api/bookings/create-payment-intent/route.ts"
      via: "fetch to create Payment Intent, receives clientSecret"
      pattern: "create-payment-intent"
    - from: "web/app/api/stripe/webhooks/route.ts"
      to: "bookings table"
      via: "Updates booking status on payment_intent.succeeded"
      pattern: "payment_intent.succeeded"
    - from: "web/app/api/bookings/create/route.ts"
      to: "supabase/functions/calculate-pricing"
      via: "Server-side pricing validation before creating booking"
      pattern: "calculate.*pricing"
---

<objective>
Implement Stripe payment integration with prepay vs Net 30 logic. New clients pay by card via Stripe Payment Intent with 3D Secure support. Established clients (payment_terms='net_30') skip payment and confirm booking directly.

Purpose: Payment is the critical conversion step. Prepay clients need a smooth card payment experience with SCA/3D Secure compliance. Net 30 clients need frictionless booking without payment delay. Server-side validation ensures correct pricing and prevents manipulation.

Output: Payment page at /book/payment with Stripe Payment Element for prepay clients and Net 30 confirmation for established clients. API routes for booking creation and payment processing.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.5-marketing-booking/04.5-RESEARCH.md
@.planning/phases/04.5-marketing-booking/04.5-01-SUMMARY.md

Key existing files:
@supabase/functions/calculate-pricing/index.ts (server pricing logic)
@supabase/functions/stripe-connect/index.ts (existing Stripe integration pattern)
@supabase/migrations/002_business_operations.sql (bookings, clients tables)
@web/lib/supabase/server.ts (Supabase server client)
@web/lib/supabase/client.ts (Supabase browser client)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Stripe client SDK and create Stripe utility files + API routes</name>
  <files>
    web/lib/stripe/client.ts
    web/lib/stripe/server.ts
    web/app/api/bookings/create/route.ts
    web/app/api/bookings/create-payment-intent/route.ts
    web/app/api/stripe/webhooks/route.ts
  </files>
  <action>
    1. **Install Stripe dependencies** in web/ directory:
       ```
       pnpm add @stripe/stripe-js @stripe/react-stripe-js stripe
       ```

    2. **web/lib/stripe/client.ts** - Client-side Stripe initialization:
       ```typescript
       import { loadStripe } from '@stripe/stripe-js';
       export const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!);
       ```

    3. **web/lib/stripe/server.ts** - Server-side Stripe initialization:
       ```typescript
       import Stripe from 'stripe';
       export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
         apiVersion: '2024-12-18.acacia', // Latest stable API version
         typescript: true,
       });
       ```
       Note: Use the latest Stripe API version available. If the exact version string causes issues, use the default by omitting apiVersion.

    4. **web/app/api/bookings/create/route.ts** - POST endpoint to create a booking record:
       - Accepts BookingFormData (from sessionStorage, sent by payment page)
       - Server-side pricing validation: call the calculate-pricing Edge Function or mirror its logic to verify the client-calculated price matches server calculation (prevent price manipulation)
       - Creates booking record in the `bookings` table via Supabase server client with status 'pending'
       - For prepay clients: Returns booking_id (payment will confirm it)
       - For net_30 clients: Creates booking with status 'confirmed' directly, checks credit_limit vs outstanding_balance + new booking total, rejects if over limit
       - Validates: shift_hours >= 8, required fields present, urgency_premium_percent is valid (0, 20, 50, 75)
       - Returns: `{ bookingId: string; requiresPayment: boolean; paymentTerms: 'prepay' | 'net_30' }`

    5. **web/app/api/bookings/create-payment-intent/route.ts** - POST endpoint for Stripe Payment Intent:
       - Accepts: `{ bookingId: string; amount: number }` (amount in pence, pre-validated)
       - Fetches booking from database to verify amount matches
       - Fetches client from database to get stripe_customer_id (or create Stripe customer if none exists)
       - Creates Stripe Payment Intent:
         ```typescript
         stripe.paymentIntents.create({
           amount: Math.round(booking.total * 100), // GBP to pence
           currency: 'gbp',
           customer: client.stripe_customer_id,
           metadata: { booking_id: bookingId, client_id: booking.client_id },
           automatic_payment_methods: { enabled: true }, // Enables 3D Secure
         })
         ```
       - Returns: `{ clientSecret: string }`
       - Error: 400 if booking not found or amount mismatch, 500 for Stripe errors

    6. **web/app/api/stripe/webhooks/route.ts** - Stripe webhook handler:
       - Verify webhook signature using STRIPE_WEBHOOK_SECRET (CRITICAL: verify BEFORE parsing)
       - Handle events:
         - `payment_intent.succeeded`: Update booking status to 'confirmed', update client total_bookings count
         - `payment_intent.payment_failed`: Update booking status to 'cancelled' with cancellation_reason
       - Use `export const dynamic = 'force-dynamic'` and `export const runtime = 'nodejs'` (webhooks need raw body)
       - Parse raw body for signature verification: use `request.text()` then `stripe.webhooks.constructEvent(body, sig, secret)`
       - Return 200 for all handled events, 400 for signature failures

    IMPORTANT: All API routes use the Supabase server client from web/lib/supabase/server.ts for database operations. Do NOT use the browser client in API routes.
  </action>
  <verify>
    Run `pnpm build` from web/ directory. Verify all API routes compile: web/app/api/bookings/create/route.ts, web/app/api/bookings/create-payment-intent/route.ts, web/app/api/stripe/webhooks/route.ts. Check that stripe and @stripe/stripe-js are in package.json dependencies.
  </verify>
  <done>
    Stripe client and server utilities created. Three API routes operational: POST /api/bookings/create (creates booking record with server-side price validation), POST /api/bookings/create-payment-intent (creates Stripe Payment Intent for prepay clients), POST /api/stripe/webhooks (handles payment success/failure events). All routes compile without TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create payment page with Stripe Payment Element and Net 30 confirmation</name>
  <files>
    web/components/booking/payment-form.tsx
    web/components/booking/net30-confirmation.tsx
    web/app/(booking)/book/payment/page.tsx
  </files>
  <action>
    1. **web/components/booking/payment-form.tsx** - 'use client' component with Stripe Payment Element:
       - Wraps content in Elements provider from @stripe/react-stripe-js with stripePromise and clientSecret
       - On mount: reads booking data from sessionStorage, calls POST /api/bookings/create to create booking, then calls POST /api/bookings/create-payment-intent to get clientSecret
       - Shows loading spinner while Payment Intent is being created
       - Renders Stripe PaymentElement for card input
       - Shows pricing summary (total amount in GBP) above the payment form
       - Submit button: "Pay GBP {total} and Confirm Booking"
       - On submit: calls stripe.confirmPayment({ elements, confirmParams: { return_url: `${origin}/book/confirmation?booking_id={id}` } })
       - Error handling: Display Stripe error messages below the form (e.g., "Your card was declined")
       - Disable submit button while processing
       - Appearance: Use Stripe's `appearance` option with `theme: 'stripe'` and custom variables to match the site's blue/slate color scheme

    2. **web/components/booking/net30-confirmation.tsx** - 'use client' component for Net 30 clients:
       - Shows booking summary (date, location, shift hours, pricing breakdown)
       - Message: "This booking will be invoiced on Net 30 terms. No payment required now."
       - "Confirm Booking" button that calls POST /api/bookings/create with net_30 flag
       - On success: navigates to /book/confirmation?booking_id={id}
       - Shows credit remaining: "Credit remaining: GBP {credit_limit - outstanding_balance - total}"
       - Error: If credit limit exceeded, show "Credit limit exceeded. Please contact us or pay by card."

    3. **web/app/(booking)/book/payment/page.tsx** - Payment page:
       - Server Component that renders either PaymentForm or Net30Confirmation based on client payment terms
       - On mount, reads booking form data from sessionStorage (set by booking-form.tsx in Plan 02)
       - Determines payment flow: If client is not authenticated, show a registration/login form first (simple email + company name + phone), then check their payment_terms
       - For NEW clients (no account): Always show PaymentForm (prepay required)
       - For returning clients with payment_terms='prepay': Show PaymentForm
       - For returning clients with payment_terms='net_30': Show Net30Confirmation
       - Includes "Back to booking details" link to /book
       - Shows step indicator: "Step 2 of 3: Payment" (Step 1 = booking details, Step 3 = confirmation)

       IMPLEMENTATION NOTE: For the client registration flow, create a simple inline form (email, company name, contact name, phone) that creates a Supabase auth account and a clients table record with payment_terms='prepay' and credit_limit=0. Use Supabase's signUp method. After signup, proceed to payment. For returning clients, check if they're already logged in via Supabase auth session.

    IMPORTANT: The Stripe Payment Element handles 3D Secure automatically when `automatic_payment_methods.enabled = true` on the Payment Intent. No custom 3D Secure redirect handling needed.
  </action>
  <verify>
    Run `pnpm build` from web/ directory. Navigate to http://localhost:30500/book/payment. Verify: page renders (may show loading state if no booking data in sessionStorage). Check that PaymentForm component imports @stripe/react-stripe-js correctly. Check that Net30Confirmation component renders booking summary.
  </verify>
  <done>
    Payment page at /book/payment renders PaymentForm for prepay clients (Stripe Payment Element with 3D Secure) and Net30Confirmation for established clients. Client registration inline form creates Supabase auth account + clients record. Payment submission redirects to /book/confirmation on success. All components compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds without errors
2. /book/payment page renders without runtime errors
3. Stripe Payment Element renders within the payment form (requires NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY env var)
4. POST /api/bookings/create accepts booking data and returns bookingId
5. POST /api/bookings/create-payment-intent creates Stripe Payment Intent and returns clientSecret
6. POST /api/stripe/webhooks verifies Stripe signature and handles payment_intent.succeeded
7. Net 30 confirmation shows booking summary without payment form
8. Client registration form creates auth account and client record
9. Back link to /book works
</verification>

<success_criteria>
- Stripe Payment Element renders for prepay clients with card input
- 3D Secure handled automatically via automatic_payment_methods
- Net 30 clients see confirmation without payment, with credit check
- Server-side price validation prevents client-side manipulation
- Webhook handler updates booking status on payment success/failure
- New client registration creates auth + client record with prepay terms
- All monetary calculations use GBP (pence for Stripe, pounds for display)
- `pnpm build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-marketing-booking/04.5-03-SUMMARY.md`
</output>
