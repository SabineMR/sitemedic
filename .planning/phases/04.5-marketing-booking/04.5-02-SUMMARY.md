---
phase: 04.5-marketing-booking
plan: 02
subsystem: ui
tags: [booking, calendar, react-day-picker, pricing, form-validation, recurring-bookings]

# Dependency graph
requires:
  - phase: 04.5-01
    provides: Marketing layout with SiteHeader component for reuse
  - phase: 01.5-01
    provides: Pricing calculation logic from Edge Function to mirror
provides:
  - Customer-facing booking flow at /book with calendar, location, shift config, and live pricing
  - Real-time pricing calculation mirroring Edge Function logic exactly
  - Recurring booking toggle with weekly/biweekly patterns
  - UK postcode validation and 8-hour minimum shift enforcement
  - Form validation with sessionStorage handoff to payment flow
affects: [04.5-03-payment-flow, 06-client-portal]

# Tech tracking
tech-stack:
  added: [@radix-ui/react-popover, react-day-picker]
  patterns:
    - "Client-side pricing calculation mirroring server Edge Function for real-time UX"
    - "Urgency premium auto-detection based on days until shift (7+/4-6/1-3/<1 day)"
    - "SessionStorage for multi-step form data handoff between booking pages"
    - "Recurring booking pattern with weekly/biweekly toggle and week count"

key-files:
  created:
    - web/lib/booking/types.ts
    - web/lib/booking/pricing.ts
    - web/components/booking/calendar-picker.tsx
    - web/components/booking/location-input.tsx
    - web/components/booking/shift-config.tsx
    - web/components/booking/pricing-breakdown.tsx
    - web/components/booking/booking-form.tsx
    - web/app/(booking)/layout.tsx
    - web/app/(booking)/book/page.tsx
    - web/components/ui/calendar.tsx
    - web/components/ui/popover.tsx
    - web/components/ui/label.tsx
    - web/components/ui/textarea.tsx
  modified:
    - web/package.json
    - web/pnpm-lock.yaml

key-decisions:
  - "D-04.5-02-001: Client-side pricing calculation mirrors Edge Function exactly for real-time transparency"
  - "D-04.5-02-002: Urgency premium auto-calculated based on days until shift (0%/20%/50%/75%)"
  - "D-04.5-02-003: Minimum 1 day advance booking (tomorrow is earliest, same-day disabled)"
  - "D-04.5-02-004: UK postcode validation with basic pattern check (uppercase, letters+numbers)"
  - "D-04.5-02-005: 8-hour minimum shift with 30-minute time increments"
  - "D-04.5-02-006: Recurring booking toggle shows/hides pattern select and weeks input"
  - "D-04.5-02-007: SessionStorage for form data handoff to payment page (Plan 03)"
  - "D-04.5-02-008: Default base rate GBP 42/hr (GBP 350 for 8hr day)"

patterns-established:
  - "Booking form pattern: Single-page form with 2-column layout (form left, pricing right sticky)"
  - "Real-time pricing recalculation on every form change via useEffect"
  - "Calendar with disabled past dates and urgency indicators"
  - "Conditional form sections (recurring fields only show when isRecurring checked)"

# Metrics
duration: 10min
completed: 2026-02-16
---

# Phase 04.5 Plan 02: Customer Booking Flow Summary

**Customer-facing booking form at /book with calendar picker, live pricing breakdown showing urgency premiums, and recurring booking support**

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-16T06:13:36Z
- **Completed:** 2026-02-16T06:23:26Z
- **Tasks:** 2
- **Files modified:** 15

## Accomplishments
- Calendar picker with urgency level indicators (green/yellow/orange badges for 7+/4-6/1-3 days)
- Real-time pricing breakdown mirroring Edge Function logic (base + urgency + VAT = total)
- Recurring booking toggle with weekly/biweekly pattern and week count input
- UK postcode validation with regex pattern
- Form validation requiring all fields plus recurring fields when enabled
- SessionStorage handoff to /book/payment for Plan 03

## Task Commits

Each task was committed atomically:

1. **Task 1: Install dependencies, add calendar/popover components, create types and pricing** - `d313ee4` (feat)
2. **Task 2: Create booking form components and /book page** - `086b9d3` (feat)

## Files Created/Modified

**Created:**
- `web/lib/booking/types.ts` - BookingFormData and PricingBreakdown types
- `web/lib/booking/pricing.ts` - Client-side pricing calculation mirroring Edge Function
- `web/components/booking/calendar-picker.tsx` - Date picker with urgency indicators
- `web/components/booking/location-input.tsx` - Site location with UK postcode validation
- `web/components/booking/shift-config.tsx` - Shift times, special requirements, recurring toggle
- `web/components/booking/pricing-breakdown.tsx` - Live pricing display card
- `web/components/booking/booking-form.tsx` - Main form orchestrator with state management
- `web/app/(booking)/layout.tsx` - Minimal booking layout with SiteHeader
- `web/app/(booking)/book/page.tsx` - Book a Medic page
- `web/components/ui/calendar.tsx` - shadcn/ui Calendar wrapper
- `web/components/ui/popover.tsx` - shadcn/ui Popover wrapper
- `web/components/ui/label.tsx` - shadcn/ui Label component (blocking fix)
- `web/components/ui/textarea.tsx` - shadcn/ui Textarea component (blocking fix)

**Modified:**
- `web/package.json` - Added @radix-ui/react-popover and react-day-picker
- `web/pnpm-lock.yaml` - Updated lockfile

## Decisions Made

**D-04.5-02-001: Client-side pricing calculation mirrors Edge Function exactly**
- Rationale: Show clients exact prices they'll pay in real-time as they configure booking
- Implementation: Pure function with same formula as supabase/functions/calculate-pricing/index.ts
- Source of truth remains server-side Edge Function for actual charges

**D-04.5-02-002: Urgency premium auto-calculated based on days until shift**
- 7+ days advance: 0% (standard)
- 4-6 days advance: 20% (short notice)
- 1-3 days advance: 50% (urgent)
- Less than 24 hours: 75% (emergency)
- Rationale: Matches existing Edge Function pricing rules from Plan 01.5-01

**D-04.5-02-003: Minimum 1 day advance booking**
- Tomorrow is earliest selectable date, same-day disabled
- Rationale: Medics need advance notice for scheduling

**D-04.5-02-004: UK postcode validation with basic pattern check**
- Regex: `/^[A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2}$/i`
- Uppercase conversion on input
- Rationale: Ensure valid UK postcode format for medic assignment

**D-04.5-02-005: 8-hour minimum shift with 30-minute increments**
- Start times: 06:00 to 12:00 in 30-min increments
- End times: Auto-calculated minimum (start + 8h) to 20:00
- Rationale: UK construction standard 8-hour minimum

**D-04.5-02-006: Recurring booking toggle shows/hides pattern select and weeks input**
- When unchecked: Hide pattern/weeks, reset to null/0
- When checked: Show weekly/biweekly select and weeks number input (max 52)
- Rationale: Clean UI - only show fields when relevant

**D-04.5-02-007: SessionStorage for form data handoff to payment page**
- Store both formData and pricing objects
- Next step (Plan 03) will retrieve from sessionStorage
- Rationale: Simple state persistence between booking pages without URL params

**D-04.5-02-008: Default base rate GBP 42/hr (GBP 350 for 8hr day)**
- Matches Edge Function default from Plan 01.5-01
- Rationale: Standard construction medic rate in UK

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added missing label and textarea UI components**
- **Found during:** Task 2 (Build verification)
- **Issue:** Pre-existing build error in admin/timesheet-batch-approval.tsx - missing @/components/ui/label and @/components/ui/textarea
- **Fix:** Ran `npx shadcn@latest add label textarea` to add missing components
- **Files modified:** web/components/ui/label.tsx, web/components/ui/textarea.tsx
- **Verification:** Build passed successfully, /book page compiled
- **Committed in:** 086b9d3 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Blocking fix necessary to complete build verification. No scope creep - pre-existing missing dependencies.

## Issues Encountered

None. Build succeeded, all components compiled correctly.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Plan 03 (Payment Integration):**
- Booking form data structure defined (BookingFormData)
- Pricing breakdown calculated and ready to pass to payment
- SessionStorage handoff implemented for /book/payment
- Form validation ensures all required fields collected

**No blockers.**

---
*Phase: 04.5-marketing-booking*
*Completed: 2026-02-16*
