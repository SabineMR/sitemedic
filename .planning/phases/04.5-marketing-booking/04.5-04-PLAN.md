---
phase: 04.5-marketing-booking
plan: 04
type: execute
wave: 4
depends_on: ["04.5-02", "04.5-03"]
files_modified:
  - web/app/api/bookings/match/route.ts
  - web/components/booking/medic-matcher.tsx
  - web/components/booking/booking-confirmation.tsx
  - web/components/booking/recurring-summary.tsx
  - web/app/(booking)/book/confirmation/page.tsx
  - web/lib/booking/calendar.ts
  - web/lib/email/resend.ts
  - web/lib/email/templates/booking-confirmation-email.tsx
  - web/lib/email/templates/medic-assignment-email.tsx
  - web/app/api/email/booking-confirmation/route.ts
  - web/app/api/bookings/recurring/route.ts
autonomous: true

user_setup:
  - service: resend
    why: "Transactional email for booking confirmation and medic notification"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API key"
    dashboard_config:
      - task: "Verify sitemedic.co.uk domain for email sending"
        location: "Resend Dashboard -> Domains -> Add domain -> Follow DNS verification steps"

must_haves:
  truths:
    - "Auto-matching presents ranked medic candidates with distance, availability, and rating"
    - "Client receives booking confirmation with .ics calendar invite attachment"
    - "Medic receives notification email when assigned to a booking"
    - "Confirmation page shows booking summary with assigned medic details"
    - "Recurring bookings create multiple booking records (same medic, weekly schedule)"
    - "Pricing breakdown visible on confirmation (base + urgency + travel + VAT)"
  artifacts:
    - path: "web/app/api/bookings/match/route.ts"
      provides: "POST endpoint calling auto-assign Edge Function, updating booking medic_id, then triggering email"
      exports: ["POST"]
    - path: "web/components/booking/medic-matcher.tsx"
      provides: "UI showing ranked medic candidates with match reasons"
      contains: "match_reasons"
    - path: "web/components/booking/booking-confirmation.tsx"
      provides: "Booking confirmation display with medic details and pricing"
      contains: "Booking Confirmed"
    - path: "web/lib/booking/calendar.ts"
      provides: ".ics calendar invite generation using ical-generator"
      exports: ["generateBookingIcs"]
    - path: "web/lib/email/resend.ts"
      provides: "Resend email client initialization"
      exports: ["resend"]
    - path: "web/app/api/email/booking-confirmation/route.ts"
      provides: "POST endpoint sending confirmation email with .ics attachment"
      exports: ["POST"]
    - path: "web/app/api/bookings/recurring/route.ts"
      provides: "POST endpoint creating recurring booking instances"
      exports: ["POST"]
  key_links:
    - from: "web/app/api/bookings/match/route.ts"
      to: "supabase/functions/auto-assign-medic-v2"
      via: "Step 1: Calls Edge Function to get matched medic"
      pattern: "auto-assign-medic-v2"
    - from: "web/app/api/bookings/match/route.ts"
      to: "bookings table"
      via: "Step 2: UPDATE bookings SET medic_id = matched_medic_id"
      pattern: "update.*medic_id"
    - from: "web/app/api/bookings/match/route.ts"
      to: "web/app/api/email/booking-confirmation/route.ts"
      via: "Step 3: Calls email endpoint AFTER medic_id is set on booking"
      pattern: "api/email/booking-confirmation"
    - from: "web/app/api/email/booking-confirmation/route.ts"
      to: "web/lib/booking/calendar.ts"
      via: "Generates .ics and attaches to confirmation email"
      pattern: "generateBookingIcs"
    - from: "web/app/api/email/booking-confirmation/route.ts"
      to: "web/lib/email/resend.ts"
      via: "Sends email via Resend API"
      pattern: "resend.emails.send"
    - from: "web/app/api/bookings/recurring/route.ts"
      to: "bookings table"
      via: "Creates multiple booking records with parent_booking_id"
      pattern: "parent_booking_id"
---

<objective>
Build the auto-matching UI showing ranked medic candidates with transparency, booking confirmation page with calendar invite (.ics) email delivery, medic assignment notification email, and recurring booking creation.

Purpose: This completes the end-to-end booking flow. Auto-matching transparency builds client trust by showing WHY a medic was selected. Calendar invites (.ics) ensure the booking appears in the client's calendar. Medic notification ensures the assigned medic knows about the booking. Recurring bookings enable weekly scheduling with the same medic.

Output: Confirmation page at /book/confirmation with medic matching, email notifications with calendar invites, and recurring booking support.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.5-marketing-booking/04.5-RESEARCH.md
@.planning/phases/04.5-marketing-booking/04.5-01-SUMMARY.md
@.planning/phases/04.5-marketing-booking/04.5-02-SUMMARY.md
@.planning/phases/04.5-marketing-booking/04.5-03-SUMMARY.md

Key existing files:
@supabase/functions/auto-assign-medic-v2/index.ts (auto-assignment algorithm with 7-factor scoring)
@supabase/migrations/002_business_operations.sql (bookings table with recurring fields)
@web/lib/booking/types.ts (BookingFormData, PricingBreakdown types)
@web/lib/booking/pricing.ts (pricing calculation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install email dependencies, create auto-match API route, calendar invite generator, and email templates</name>
  <files>
    web/lib/booking/calendar.ts
    web/lib/email/resend.ts
    web/lib/email/templates/booking-confirmation-email.tsx
    web/lib/email/templates/medic-assignment-email.tsx
    web/app/api/bookings/match/route.ts
    web/app/api/email/booking-confirmation/route.ts
    web/app/api/bookings/recurring/route.ts
  </files>
  <action>
    1. **Install dependencies** in web/ directory:
       ```
       pnpm add resend ical-generator @react-email/components
       ```

    2. **web/lib/booking/calendar.ts** - .ics calendar invite generator using ical-generator:
       ```typescript
       import ical from 'ical-generator';

       export function generateBookingIcs(booking: {
         date: string;        // "2026-03-15"
         startTime: string;   // "07:00"
         endTime: string;     // "15:00"
         siteName: string;
         siteAddress: string;
         medicName: string;
         clientEmail: string;
         clientName: string;
       }): string
       ```
       - Creates ICalCalendar with name "SiteMedic Booking"
       - Creates event with: start/end as Date objects (combine date + time, timezone Europe/London), summary "Medic Visit - {siteName}", description with medic name and site details, location as siteAddress, organizer as bookings@sitemedic.co.uk
       - Returns calendar.toString() (the .ics string content)
       - Set timezone to 'Europe/London' on the calendar (handles GMT/BST automatically)

    3. **web/lib/email/resend.ts** - Resend client initialization:
       ```typescript
       import { Resend } from 'resend';
       export const resend = new Resend(process.env.RESEND_API_KEY);
       ```
       Graceful fallback: If RESEND_API_KEY is not set, export a mock that logs emails to console instead of sending (dev mode).

    4. **web/lib/email/templates/booking-confirmation-email.tsx** - React Email template for client:
       - Uses @react-email/components (Html, Head, Body, Container, Heading, Text, Button, Hr)
       - Shows: "Booking Confirmed" heading, booking date, shift times, site location, assigned medic name, pricing total
       - "View Booking" button linking to the confirmation page
       - Footer: "Guardian Medics Ltd - UK paramedic staffing with built-in compliance"
       - Brand colors: blue-600 for buttons, slate-900 for text
       - Props: `{ booking, client, medic }` with typed interfaces

    5. **web/lib/email/templates/medic-assignment-email.tsx** - React Email template for medic:
       - Shows: "New Booking Assignment" heading, booking date, shift times, site location, site contact details, special requirements (confined space, trauma)
       - "View in Dashboard" button (link to dashboard)
       - Includes: site address, site contact name and phone, any special notes
       - Footer: "Guardian Medics - You have been assigned to this booking. Please confirm your availability."

    6. **web/app/api/bookings/match/route.ts** - POST endpoint for auto-matching with EXPLICIT 3-STEP SEQUENCE:
       - Accepts: `{ bookingId: string }`
       - **Step 1 - Call auto-assign Edge Function:**
         `supabase.functions.invoke('auto-assign-medic-v2', { body: { booking_id: bookingId } })`
         The Edge Function returns the assigned medic_id, match_score, and match_criteria.
       - **Step 2 - UPDATE booking with assigned medic:**
         `supabase.from('bookings').update({ medic_id: matched_medic_id }).eq('id', bookingId)`
         This MUST happen BEFORE calling the email endpoint. The email endpoint fetches the booking and expects medic_id to already be set.
       - **Step 3 - Trigger email sending (ONLY after medic_id is persisted):**
         Call POST /api/email/booking-confirmation internally with `{ bookingId }`. The email endpoint will fetch the booking (which now has medic_id set) and send both client and medic emails.
       - If Edge Function returns match_score and match_criteria, format them for the UI:
         - Extract match_reasons from match_criteria (e.g., "Closest medic (12 miles)", "4.8 star rating", "92% availability")
         - Return ranked list (even if only 1 assigned): `{ matches: [{ medic_id, medic_name, star_rating, distance_miles, travel_time_minutes, availability, match_score, match_reasons }] }`
       - If auto-assignment fails (no available medics, score < 50), return: `{ matches: [], requiresManualApproval: true, reason: "..." }` -- do NOT call email endpoint in this case.

    7. **web/app/api/email/booking-confirmation/route.ts** - POST endpoint for sending confirmation emails:
       - Accepts: `{ bookingId: string }`
       - Fetches booking from database (booking.medic_id MUST already be set by the match endpoint)
       - Fetches client and medic data from database using booking.client_id and booking.medic_id
       - If booking.medic_id is null, return 400 error "Booking has no assigned medic" (safety check)
       - Generates .ics calendar invite using generateBookingIcs
       - Sends email to CLIENT via Resend:
         - from: 'Guardian Medics Bookings <bookings@sitemedic.co.uk>'
         - subject: 'Booking Confirmed - {date}'
         - react: BookingConfirmationEmail template
         - attachments: [{ filename: 'booking.ics', content: icsString, contentType: 'text/calendar; charset=utf-8; method=REQUEST' }]
       - Sends email to MEDIC via Resend:
         - from: 'Guardian Medics <bookings@sitemedic.co.uk>'
         - subject: 'New Booking Assignment - {date} at {siteName}'
         - react: MedicAssignmentEmail template
         - NO .ics attachment for medic (they use the dashboard)
       - Returns: `{ clientEmailSent: boolean, medicEmailSent: boolean }`
       - Graceful degradation: If RESEND_API_KEY missing, log to console and return success

    8. **web/app/api/bookings/recurring/route.ts** - POST endpoint for creating recurring bookings:
       - Accepts: `{ parentBookingId: string; recurrencePattern: 'weekly' | 'biweekly'; weeks: number }`
       - Fetches parent booking from database
       - Creates child booking records for each recurrence:
         - Same medic, same site, same shift times, same pricing
         - shift_date incremented by 7 (weekly) or 14 (biweekly) days
         - parent_booking_id set to the original booking ID
         - is_recurring = true, recurrence_pattern set
         - Status: 'confirmed' (inherits parent's payment status)
       - Maximum 52 recurring instances (1 year cap)
       - Returns: `{ bookings: [{ id, shift_date }], count: number }`
       - For prepay recurring: Each child booking needs its own payment (handled in Phase 6.5). For now, create records with status 'pending_payment' for prepay clients.
       - For net_30 recurring: All child bookings confirmed immediately (within credit limit check).
  </action>
  <verify>
    Run `pnpm build` from web/ directory. Verify all files compile: calendar.ts exports generateBookingIcs, resend.ts exports resend, email templates render as React components, API routes export POST handlers. Check resend, ical-generator, @react-email/components are in package.json.
  </verify>
  <done>
    Auto-match API follows explicit 3-step sequence: (1) call Edge Function, (2) UPDATE booking SET medic_id, (3) call email endpoint. Email endpoint has safety check for null medic_id. Calendar invite generator produces valid .ics strings. Resend client initialized with dev fallback. Email templates created for client (with .ics attachment) and medic (assignment notification). Recurring booking endpoint creates child booking records. All files compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auto-matching UI, booking confirmation page, and recurring summary</name>
  <files>
    web/components/booking/medic-matcher.tsx
    web/components/booking/booking-confirmation.tsx
    web/components/booking/recurring-summary.tsx
    web/app/(booking)/book/confirmation/page.tsx
  </files>
  <action>
    1. **web/components/booking/medic-matcher.tsx** - 'use client' component showing ranked medic matches:
       - Receives matches array from API response
       - For each medic match, display a Card with:
         - Medic name (large, bold)
         - Star rating (e.g., "4.8 / 5.0")
         - Distance and travel time (e.g., "12 miles away, 25 min travel")
         - Availability badge: green "Available" or yellow "Backup"
         - Match score badge (e.g., "92% match")
         - "Why this medic?" expandable section showing match_reasons as a list:
           - e.g., "Closest available medic (12 miles)", "High rating (4.8 stars)", "85% utilization (capacity available)", "Confined space certified"
       - The top-ranked medic is auto-selected (highlighted with primary border)
       - If matches is empty and requiresManualApproval is true, show: "No medics available for automatic assignment. Our team will review your booking and assign a medic within 2 hours." with a blue info banner.
       - "How We Match Medics" info box at top explaining the algorithm considers: distance, availability, rating, qualifications (matches research pattern)

    2. **web/components/booking/booking-confirmation.tsx** - 'use client' component for confirmed booking:
       - Green checkmark icon + "Booking Confirmed" heading
       - Booking summary card:
         - Date and shift times
         - Site name and address
         - Assigned medic name and rating
         - Pricing breakdown (same PricingBreakdown component from Plan 02, read-only)
       - "What happens next?" section:
         - "A confirmation email with calendar invite has been sent to {email}"
         - "Your medic {name} has been notified and will arrive at {startTime}"
         - "You can view your booking anytime in your dashboard"
       - Action buttons: "View in Dashboard" (Link to /), "Book Another Medic" (Link to /book)
       - If recurring: Show recurring summary below

    3. **web/components/booking/recurring-summary.tsx** - 'use client' component for recurring booking details:
       - Shows list of all recurring booking dates in a table/list
       - Columns: Date, Day (e.g., "Monday"), Status (Confirmed/Pending Payment)
       - Summary: "X bookings created, {pattern} until {last date}"
       - Note: "Same medic ({name}) assigned to all recurring shifts"

    4. **web/app/(booking)/book/confirmation/page.tsx** - Confirmation page:
       - Reads booking_id from URL search params: `?booking_id={id}`
       - Also reads payment_intent and payment_intent_client_secret from search params (Stripe redirect adds these)
       - On mount:
         a. If payment_intent_client_secret present: Verify payment status by calling stripe.retrievePaymentIntent. If 'succeeded', proceed. If 'requires_action', show "Confirming payment..." loading state. If failed, show error with retry link.
         b. Call POST /api/bookings/match with bookingId to trigger auto-matching (which internally: assigns medic -> updates booking -> sends emails)
         c. If booking has recurring settings, call POST /api/bookings/recurring to create child bookings
         d. Wait for match result, then display BookingConfirmation with medic details
       - Loading state: "Confirming your booking..." with spinner
       - Error state: "Something went wrong. Your payment was successful but we couldn't complete the booking. Our team has been notified." with support contact
       - Step indicator: "Step 3 of 3: Confirmation"

    IMPORTANT: The confirmation page handles the full post-payment flow: verify payment -> auto-match medic (which assigns + updates booking + sends emails) -> create recurring bookings -> display confirmation. This is the critical path where everything connects.
  </action>
  <verify>
    Run `pnpm build` from web/ directory. Navigate to http://localhost:30500/book/confirmation?booking_id=test to verify the page renders (will show loading/error state without real booking data). Check that medic-matcher.tsx renders match cards with transparency info. Check that booking-confirmation.tsx shows the confirmation layout.
  </verify>
  <done>
    Confirmation page at /book/confirmation handles post-payment flow: payment verification, auto-matching trigger (3-step: assign -> update booking -> send emails), and recurring booking creation. MedicMatcher shows ranked candidates with transparency (distance, rating, match reasons). BookingConfirmation shows full summary with "what happens next" section. RecurringSummary lists all recurring dates. All components compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds without errors
2. /book/confirmation page renders with loading state when accessed directly
3. MedicMatcher component shows match cards with "Why this medic?" section
4. BookingConfirmation shows green checkmark, booking summary, and next steps
5. Calendar invite generation produces valid .ics string with Europe/London timezone
6. Email templates render with booking details and brand styling
7. Recurring booking API creates child records with correct date offsets
8. POST /api/bookings/match follows 3-step sequence: (1) call Edge Function, (2) UPDATE booking SET medic_id, (3) call email endpoint
9. POST /api/email/booking-confirmation rejects requests where booking has no medic_id
10. Graceful handling when no medics available (manual approval message)
</verification>

<success_criteria>
- Auto-matching follows explicit 3-step sequence (assign -> persist medic_id -> email)
- Email endpoint validates medic_id is set before sending
- Client receives confirmation email with .ics calendar invite (text/calendar MIME type)
- Medic receives assignment notification email
- Confirmation page shows complete booking summary with pricing
- Recurring bookings create correct number of child records
- Payment verification handles 3D Secure redirect correctly
- Manual approval fallback when no medics available
- All emails gracefully degrade when RESEND_API_KEY not set
- `pnpm build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04.5-marketing-booking/04.5-04-SUMMARY.md`
</output>
