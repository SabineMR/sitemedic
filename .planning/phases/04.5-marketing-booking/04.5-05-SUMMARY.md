---
phase: 04.5-marketing-booking
plan: 05
subsystem: api
tags: [supabase, next.js, api-routes, booking]

# Dependency graph
requires:
  - phase: 04.5-04
    provides: Auto-matching API that assigns medics to bookings
provides:
  - GET /api/bookings/{id} endpoint with client and medic joins
  - Real booking data displayed on confirmation page (no mock data)
  - Accurate pricing breakdown from database
  - Recurring booking weeks calculated from recurring_until date
affects: [confirmation-flow, booking-ui, medic-assignment]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Supabase joins pattern for booking detail queries with clients and medics relations
    - Database field mapping to UI props (shift_date → formatted date, TIME → HH:MM)

key-files:
  created:
    - web/app/api/bookings/[id]/route.ts
  modified:
    - web/app/(booking)/book/confirmation/page.tsx

key-decisions:
  - "Fetch booking data after auto-match completes (not before payment)"
  - "Calculate recurring weeks from recurring_until date field (schema uses date, not week count)"
  - "Include medic star_rating in API response to fix hardcoded 4.8 fallback"

patterns-established:
  - "Booking detail API follows same join pattern as email confirmation route (normalize array/object relations)"
  - "Convert Supabase DECIMAL strings to numbers for pricing calculations"
  - "TIME fields sliced to HH:MM format for display (remove :SS)"

# Metrics
duration: 2min
completed: 2026-02-16
---

# Phase 04.5 Plan 05: Real Booking Data in Confirmation Summary

**GET /api/bookings/{id} endpoint with client/medic joins replaces all hardcoded mock data in confirmation page, displaying accurate pricing and site details from database**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-16T22:44:27Z
- **Completed:** 2026-02-16T22:46:00Z
- **Tasks:** 1
- **Files modified:** 2

## Accomplishments
- Created GET /api/bookings/{id} endpoint with Supabase joins to clients and medics tables
- Removed all hardcoded mock values from confirmation page (Construction Site, London UK, client@example.com, £403.20)
- Mapped database fields to BookingConfirmationProps interface (shift_date, shift_start_time, base_rate, etc.)
- Calculated recurring weeks from recurring_until date field for recurring bookings
- Included medic star_rating from database instead of hardcoded fallback

## Task Commits

Each task was committed atomically:

1. **Task 1: Create booking detail API route and replace mock data in confirmation page** - `ed82a22` (feat)

## Files Created/Modified
- `web/app/api/bookings/[id]/route.ts` - GET endpoint fetching booking by ID with client and medic joins, returning all booking fields plus nested client/medic objects
- `web/app/(booking)/book/confirmation/page.tsx` - Replaced mockBooking object with API call to /api/bookings/{id}, mapping database fields to UI props

## Decisions Made

**1. Fetch booking data after auto-match completes**
- The confirmation page now fetches booking details from the database after the auto-matching API successfully assigns a medic
- This ensures the displayed data is always accurate and reflects the current database state

**2. Calculate recurring weeks from recurring_until date**
- The database schema uses `recurring_until` (DATE) not `recurring_weeks` (INT)
- Implemented calculation: `Math.floor((recurring_until - shift_date) / (7 or 14 days))` based on recurrence_pattern
- This matches the schema design decision from Phase 04.5-03 (D-04.5-03-007)

**3. Include medic star_rating in API response**
- Added `star_rating` to medics select clause in the join query
- Fixes the TODO from match/route.ts line 137 where star_rating was hardcoded to 4.8
- Now displays actual medic rating from database

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation followed the reference pattern from booking-confirmation email route.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Blocker resolved:** This plan fixes verification truth #15 from 04.5-VERIFICATION.md. The confirmation page now shows real booking data from the database.

**Phase 4.5 ready for final verification:**
- All 4 plans complete (04.5-01 through 04.5-05)
- Auto-matching works with email notifications
- Recurring bookings created with proper parent/child relationship
- Confirmation page displays accurate data from database
- No hardcoded mock values remain in production code

**Next steps:**
- Run Phase 4.5 verification checks (should now pass 18/18 truths)
- Proceed to Phase 5: PDF Generation once verification passes

---
*Phase: 04.5-marketing-booking*
*Completed: 2026-02-16*
