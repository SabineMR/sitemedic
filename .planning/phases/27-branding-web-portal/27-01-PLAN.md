# Plan 27-01: BrandingContext + Root Layout Integration

```yaml
phase: 27
plan: "01"
title: "BrandingContext + Root Layout Integration"
wave: 1
depends_on: []
files_modified:
  - web/contexts/branding-context.tsx  # NEW
  - web/app/layout.tsx
  - web/app/(auth)/layout.tsx
autonomous: true
```

## Objective

Create the `BrandingProvider` context, `useBranding()` hook, and CSS custom property injection. Wire it into the root layout so all downstream layouts (dashboard, admin, auth) inherit org branding from SSR headers. Convert the root layout's static metadata to `generateMetadata()` for dynamic tab titles.

## Tasks

<task id="1" name="create-branding-context">

### Create `web/contexts/branding-context.tsx`

Create a new client component context provider with:

**Branding interface:**
```typescript
export interface Branding {
  companyName: string;
  logoUrl: string;
  primaryColour: string;
  tagline: string;
  isSubdomain: boolean;
}
```

**Default values (SiteMedic defaults):**
```typescript
const DEFAULT_BRANDING: Branding = {
  companyName: 'SiteMedic',
  logoUrl: '',
  primaryColour: '#2563eb',
  tagline: '',
  isSubdomain: false,
};
```

**BrandingProvider component:**
- Client component (`'use client'`)
- Accepts `branding: Partial<Branding>` props from server component parent
- Merges with defaults: `{ ...DEFAULT_BRANDING, ...branding }`
- Provides merged branding via React context
- **CSS custom property injection:** renders a `<style>` tag setting `:root { --org-primary: ${safeColour}; }`
- **XSS defence:** validate hex colour with `/^#[0-9a-fA-F]{6}$/` before injecting into `<style>` tag — reject invalid, use `#2563eb` default

**useBranding() hook:**
- Returns `Branding` from context
- Throws if used outside BrandingProvider

**Export:** `BrandingProvider`, `useBranding`, `Branding` type, `DEFAULT_BRANDING`

</task>

<task id="2" name="wire-root-layout" depends_on="1">

### Update `web/app/layout.tsx` — BrandingProvider + generateMetadata

**Import changes:**
- Add `import { headers } from 'next/headers';`
- Add `import { BrandingProvider } from '@/contexts/branding-context';`
- Remove `import type { Metadata } from 'next';`
- Add `import type { Metadata } from 'next';` (keep for return type)

**Convert static metadata to generateMetadata():**

Replace:
```typescript
export const metadata: Metadata = {
  title: 'Apex Safety Group - Professional Paramedics...',
  description: '...',
};
```

With:
```typescript
export async function generateMetadata(): Promise<Metadata> {
  const headersList = await headers();
  const companyName = headersList.get('x-org-company-name') || '';

  return {
    title: companyName
      ? { template: `%s \u2014 ${companyName}`, default: `${companyName} \u2014 SiteMedic` }
      : { template: '%s \u2014 SiteMedic', default: 'SiteMedic \u2014 Professional Paramedics for Events, Productions & Worksites' },
    description: 'Book HCPC-registered paramedics for film sets, music festivals, motorsport events, construction sites, sporting events and more.',
  };
}
```

Note: `\u2014` is the em dash character (—).

**Make RootLayout async, read headers, wrap in BrandingProvider:**

```typescript
export default async function RootLayout({ children }: Readonly<{ children: React.ReactNode }>) {
  const headersList = await headers();

  const branding = {
    companyName: headersList.get('x-org-company-name') || '',
    logoUrl: headersList.get('x-org-logo-url') || '',
    primaryColour: headersList.get('x-org-primary-colour') || '',
    tagline: headersList.get('x-org-tagline') || '',
    isSubdomain: !!headersList.get('x-org-slug'),
  };

  return (
    <html lang="en-GB">
      <body className="antialiased">
        <OrgProvider>
          <BrandingProvider branding={branding}>
            <SkipToContent />
            {children}
            <CookieConsent />
            <Toaster richColors position="top-right" />
          </BrandingProvider>
        </OrgProvider>
      </body>
    </html>
  );
}
```

</task>

<task id="3" name="clean-auth-layout" depends_on="2">

### Clean up auth layout — remove redundant CSS property injection

Update `web/app/(auth)/layout.tsx`:

The `--org-primary` CSS custom property is now injected at root level by BrandingProvider. Remove the inline style injection from auth layout to avoid duplication and confusion.

Replace:
```typescript
const headersList = await headers();
const primaryColour = headersList.get('x-org-primary-colour') || '';

return (
  <div
    className="min-h-screen bg-background flex items-center justify-center p-4"
    style={primaryColour ? { '--org-primary': primaryColour } as React.CSSProperties : undefined}
  >
    {children}
  </div>
);
```

With:
```typescript
return (
  <div className="min-h-screen bg-background flex items-center justify-center p-4">
    {children}
  </div>
);
```

Remove the unused `headers` import.

</task>

## Verification

```yaml
must_haves:
  - "web/contexts/branding-context.tsx exists with BrandingProvider, useBranding(), and Branding type export"
  - "Root layout reads x-org-* headers and passes branding to BrandingProvider"
  - "Root layout uses generateMetadata() returning title template with company name"
  - "<style> tag with :root { --org-primary } is rendered by BrandingProvider"
  - "Colour value validated with hex regex before injection into style tag"
  - "Auth layout no longer injects --org-primary inline style (handled by root BrandingProvider)"
  - "TypeScript compiles without errors (npx tsc --noEmit)"
```
