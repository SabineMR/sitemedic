---
phase: 05.5-admin-operations
plan: 05
subsystem: ui
tags: [recharts, revenue-tracking, cash-flow, tanstack-query, aggregation]

# Dependency graph
requires:
  - phase: 01.5-business-foundation
    provides: Bookings, payments, timesheets, medics, clients tables with platform_fee calculations
  - phase: 05.5-01
    provides: TanStack Query pattern with 60s polling for admin dashboards
provides:
  - Revenue dashboard with trend analysis, territory breakdown, and medic earnings
  - Cash flow gap calculation warning when collection days exceed 30-day threshold
  - Client-side aggregation pattern for financial data processing
  - Recharts integration for admin visualizations
affects: [future-phases-with-financial-reporting, admin-analytics]

# Tech tracking
tech-stack:
  added: [recharts, shadcn/ui alert component]
  patterns: [client-side aggregation from bookings/payments, cash flow gap calculation, ISO week grouping]

key-files:
  created:
    - web/lib/queries/admin/revenue.ts
    - web/components/admin/revenue-charts.tsx
    - web/components/admin/cash-flow-warning.tsx
    - web/app/admin/revenue/page.tsx
    - web/components/ui/alert.tsx
  modified:
    - web/app/admin/layout.tsx

key-decisions:
  - "Client-side aggregation for revenue data (datasets small enough to process in browser)"
  - "30-day cash flow gap threshold for warning trigger"
  - "ISO week format for weekly trend grouping"
  - "Top 10 limit for territory and medic charts for readability"
  - "Medal badges (gold/silver/bronze) for top 3 medics"
  - "Time range selector: 4/12/52 weeks for flexible analysis"

patterns-established:
  - "Recharts pattern: ResponsiveContainer with dark theme styling matching admin dashboard"
  - "Cash flow calculation: daysToCollect - daysToPayMedics with >30 day warning"
  - "Revenue aggregation: weekly grouping by ISO week, territory by postcode sector, medic by medic_id"

# Metrics
duration: 12min
completed: 2026-02-16
---

# Phase 05.5 Plan 05: Admin Metrics Service Summary

**Revenue dashboard with Recharts visualizations tracking platform fees per territory/medic, cash flow gap warnings when collection exceeds 30 days**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-16T06:18:29Z
- **Completed:** 2026-02-16T06:30:00Z (estimated from commits)
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Revenue tracking dashboard with 4/12/52 week time range selector
- Three Recharts visualizations: trend line chart, territory bar chart, medic earnings table
- Cash flow gap calculation warning when avg collection days - payout days > 30
- Platform fee visibility per territory and per medic (SC #8)
- Empty data state handling across all components

## Task Commits

Each task was committed atomically:

1. **Task 1: Create revenue query hooks and cash flow calculation** - `751e162` (feat)
   - useRevenue hook with 60s polling
   - fetchRevenueData with weekly trend, territory breakdown, medic earnings
   - calculateCashFlowGap with 30-day threshold
   - ISO week grouping helper
   - Empty data handling

2. **Task 2: Build revenue dashboard with charts and warning** - `1eb0009` (feat)
   - RevenueTrendChart (LineChart: revenue/payouts/platformFees)
   - TerritoryRevenueChart (BarChart: top 10 territories)
   - MedicEarningsChart (Table: top 10 medics with medal badges)
   - CashFlowWarning banner component
   - Revenue page with summary stat cards
   - Revenue nav item in admin layout (Banknote icon)
   - Alert UI component creation

**Subsequent fixes:**
- `6a57a2c` - Added Alert UI component and fixed TypeScript issues
- `a656951` - Added type cast for Recharts formatter compatibility

## Files Created/Modified

### Created
- `web/lib/queries/admin/revenue.ts` - Revenue query hooks with fetchRevenueData, useRevenue, calculateCashFlowGap
- `web/components/admin/revenue-charts.tsx` - Three Recharts components (RevenueTrendChart, TerritoryRevenueChart, MedicEarningsChart)
- `web/components/admin/cash-flow-warning.tsx` - Non-dismissible alert banner for cash flow warnings
- `web/app/admin/revenue/page.tsx` - Revenue dashboard page with time range selector and stat cards
- `web/components/ui/alert.tsx` - shadcn/ui Alert component for warning banners

### Modified
- `web/app/admin/layout.tsx` - Added Revenue nav item with Banknote icon

## Decisions Made

**D-05.5-05-001:** Client-side aggregation for revenue data
- **Rationale:** Booking/payment datasets are small enough (weeks of data) to fetch raw and aggregate in browser, simpler than complex SQL, better TypeScript safety
- **Impact:** All aggregation logic in revenue.ts (weekly grouping, territory breakdown, medic earnings)

**D-05.5-05-002:** 30-day cash flow gap warning threshold
- **Rationale:** Medics paid weekly (7 days), clients invoiced Net 30 (30 days avg), gap of 23 days is acceptable, >30 days means funding payroll >1 month before collecting
- **Impact:** calculateCashFlowGap returns warning only when gap > 30 days

**D-05.5-05-003:** ISO week format for weekly trend
- **Rationale:** "W7 2026" format is human-readable, handles year boundaries correctly, standard for business reporting
- **Impact:** getISOWeek helper function, chart X-axis shows week labels

**D-05.5-05-004:** Top 10 limits for charts
- **Rationale:** Territory bar chart and medic table limited to 10 entries for readability, prevents overwhelming UI
- **Impact:** topTerritories and topMedics slicing in chart components

**D-05.5-05-005:** Medal badges for top 3 medics
- **Rationale:** Visual recognition for top performers (gold/silver/bronze medals + colored left borders), gamification element
- **Impact:** MedicEarningsChart renders medals and border colors for ranks 1-3

**D-05.5-05-006:** Type assertion (as any) for Recharts formatters
- **Rationale:** Recharts TypeScript definitions too strict for formatter return types, type assertion bypasses without breaking functionality
- **Impact:** Tooltip formatters use `as any` cast to satisfy TypeScript compiler

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Created Alert UI component**
- **Found during:** Task 2 (CashFlowWarning component creation)
- **Issue:** CashFlowWarning imports `@/components/ui/alert` but component didn't exist
- **Fix:** Created web/components/ui/alert.tsx following shadcn/ui pattern with destructive variant support
- **Files modified:** web/components/ui/alert.tsx (created)
- **Verification:** TypeScript compilation passes, Alert component exports correctly
- **Committed in:** 6a57a2c (separate fix commit)

**2. [Rule 3 - Blocking] Fixed Recharts formatter TypeScript errors**
- **Found during:** Task 2 (TypeScript compilation)
- **Issue:** Recharts Tooltip formatter prop has overly strict TypeScript definition, expects union type that doesn't accept simple tuple returns
- **Fix:** Added `as any` type assertion to formatter functions to bypass strict typing while maintaining runtime functionality
- **Files modified:** web/components/admin/revenue-charts.tsx
- **Verification:** `pnpm tsc --noEmit` passes with 0 errors
- **Committed in:** a656951 (separate fix commit)

---

**Total deviations:** 2 auto-fixed (1 missing critical component, 1 blocking TypeScript issue)
**Impact on plan:** Both auto-fixes necessary for compilation and functionality. No scope creep. Alert component is standard shadcn/ui pattern, Recharts type assertion is common workaround for strict typing.

## Issues Encountered

**Recharts TypeScript strictness:** Formatter prop types don't accept simple `(value, name) => [string, string]` tuples despite documentation examples using this pattern. Resolved with `as any` type assertion (common pattern in Recharts community).

## User Setup Required

None - no external service configuration required. Revenue dashboard queries existing Supabase tables (bookings, payments, timesheets, medics, clients).

## Next Phase Readiness

Revenue dashboard complete and functional. All success criteria met:
- ✅ Revenue trend chart shows revenue, payouts, and platform fees over time
- ✅ Territory bar chart ranks territories by revenue
- ✅ Medic earnings table shows top earners with medal badges
- ✅ Cash flow warning banner appears when collection gap >30 days (SC #9)
- ✅ Platform fees shown per territory and per medic (SC #8)
- ✅ Empty data states handled gracefully
- ✅ Time range selector allows 4/12/52 week views

Ready for Phase 5.5-06 (Client Management Operations) or any future admin analytics features requiring revenue data.

---
*Phase: 05.5-admin-operations*
*Completed: 2026-02-16*
