---
phase: 05.5-admin-operations
plan: 04
type: execute
wave: 2
depends_on: ["05.5-02"]
files_modified:
  - web/app/admin/territories/page.tsx
  - web/components/admin/territory-map.tsx
  - web/components/admin/territory-list.tsx
  - web/lib/queries/admin/territories.ts
autonomous: true

must_haves:
  truths:
    - "Territory coverage map displays color-coded utilization (green <50%, yellow 50-80%, red >80%)"
    - "Coverage gap alerts trigger when rejection rate >10% in territory"
  artifacts:
    - path: "web/app/admin/territories/page.tsx"
      provides: "Territory coverage page with map and alert list"
      contains: "TerritoryMap"
    - path: "web/components/admin/territory-map.tsx"
      provides: "React Leaflet map with color-coded circle markers per territory"
      exports: ["TerritoryMap"]
    - path: "web/components/admin/territory-list.tsx"
      provides: "Territory list table with utilization, medic assignments, alerts"
      exports: ["TerritoryList"]
    - path: "web/lib/queries/admin/territories.ts"
      provides: "Territory queries with utilization and gap calculation"
      exports: ["useTerritories", "calculateCoverageGaps"]
  key_links:
    - from: "web/app/admin/territories/page.tsx"
      to: "web/components/admin/territory-map.tsx"
      via: "renders map component with territory data"
      pattern: "import.*TerritoryMap"
    - from: "web/lib/queries/admin/territories.ts"
      to: "supabase territories + territory_metrics tables"
      via: "joined queries for utilization and gap detection"
      pattern: "supabase.*from.*territories|territory_metrics"
---

<objective>
Build the territory coverage page with a color-coded map and coverage gap alert system.

Purpose: Admins need visual oversight of geographic coverage -- which territories are overloaded (red), which are healthy (green), and where coverage gaps exist (rejection rate >10%). This drives hiring and territory rebalancing decisions.

Output: Territory page with React Leaflet map showing color-coded circle markers per postcode area, territory list with utilization data, and coverage gap alert banners.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.5-admin-operations/05.5-RESEARCH.md

Key existing files to reference:
@web/app/admin/layout.tsx (admin sidebar - needs Territories nav if not present)
@web/components/admin/MedicTrackingMap.tsx (existing Leaflet map component for reference)
@supabase/migrations/002_business_operations.sql (territories, territory_metrics tables)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create territory query hooks with utilization and gap detection</name>
  <files>web/lib/queries/admin/territories.ts</files>
  <action>
Create `web/lib/queries/admin/territories.ts` with:

1. **Types**:
   - `TerritoryWithMetrics`: extends territory table fields with: `utilization_pct` (number 0-100), `primary_medic_name` (string | null), `secondary_medic_name` (string | null), `recent_metrics` ({ total_bookings, confirmed_bookings, rejected_bookings, rejection_rate, fulfillment_rate } from territory_metrics), `lat` and `lng` (approximate center coordinates for map display)
   - `CoverageGapAlert`: { territory_id, postcode_sector, region, rejection_rate, total_bookings, rejected_bookings, severity: 'warning' | 'critical', message: string }

2. **UK_POSTCODE_CENTROIDS**: A const map of approximate lat/lng coordinates for major UK postcode areas. Include top 50 UK postcode areas (E, EC, N, NW, SE, SW, W, WC for London, plus M, B, L, LS, S, BS, CF, EH, G, etc.). These are APPROXIMATE centroids for map marker placement. Format: `{ 'E1': { lat: 51.517, lng: -0.056 }, ... }`. This avoids needing a geocoding API.

   Note: Research Open Question #1 acknowledged that exact boundary polygons require OS Data Hub. We use circle markers at postcode centroids instead of polygons -- simpler, no external data dependency, and sufficient for the admin overview.

3. **fetchTerritoriesWithMetrics(supabase)**: Server-side function:
   - Fetch territories joined with medics table for primary_medic_name and secondary_medic_name
   - Fetch latest territory_metrics for each postcode_sector (most recent metric_date)
   - Calculate utilization from territory_metrics.primary_medic_utilization
   - Attach lat/lng from UK_POSTCODE_CENTROIDS lookup (default to London center 51.505, -0.09 if not found)
   - Returns TerritoryWithMetrics[]

4. **useTerritories(initialData?)**: TanStack Query hook with 60s polling.

5. **calculateCoverageGaps(territories)**: Pure function per Research code example:
   - Filter territories where rejection_rate > 10%
   - Return CoverageGapAlert[] with severity: 'critical' if rejection_rate > 25%, 'warning' if > 10%
   - Message format: "Coverage Gap in {postcode_sector}: {rejected}/{total} bookings rejected ({rate}%). Consider assigning additional medics."

6. **getUtilizationColor(pct)**: Returns hex color: '#22c55e' for <50%, '#eab308' for 50-80%, '#ef4444' for >80% (matches Research Pattern 5 colors).

AVOID: Don't use Google Maps geocoding API just for map markers. Hardcoded centroids are sufficient for postcode-area-level display.
  </action>
  <verify>
- `ls web/lib/queries/admin/territories.ts`
- `grep -n 'UK_POSTCODE_CENTROIDS\|centroids' web/lib/queries/admin/territories.ts` confirms centroid data exists
- `grep -n 'calculateCoverageGaps' web/lib/queries/admin/territories.ts` confirms gap detection
- `grep -n 'getUtilizationColor' web/lib/queries/admin/territories.ts` confirms color function
  </verify>
  <done>
Territory hooks export useTerritories, calculateCoverageGaps, getUtilizationColor. UK postcode centroids mapped for 50+ areas. Coverage gaps detected at >10% rejection rate with severity levels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build territory map and list with coverage gap alerts</name>
  <files>web/components/admin/territory-map.tsx, web/components/admin/territory-list.tsx, web/app/admin/territories/page.tsx</files>
  <action>
**2a. Create `web/components/admin/territory-map.tsx`:**

Client component using React Leaflet (already installed):

1. **Dynamic import**: Use `next/dynamic` with `ssr: false` for the MapContainer (Leaflet requires browser APIs, will crash during SSR). Import pattern:
```typescript
import dynamic from 'next/dynamic';
const MapContainer = dynamic(() => import('react-leaflet').then(m => m.MapContainer), { ssr: false });
```
Actually, the cleaner pattern is to make the entire map component dynamic:
- Create the actual map as a separate inner component
- Export a wrapper that dynamically imports it with ssr: false

2. **Map configuration**:
   - Center: UK center (54.0, -2.5), zoom: 6 (shows all of England/Wales)
   - TileLayer: OpenStreetMap tiles (free, no API key)
   - Leaflet CSS: Import 'leaflet/dist/leaflet.css' in the component

3. **Territory markers**: Use CircleMarker (not Polygon -- Research Open Question #1 acknowledged boundary data not available):
   - Position: lat/lng from territory centroid
   - Radius: 12 (visible at country zoom level)
   - fillColor: getUtilizationColor(utilization_pct)
   - fillOpacity: 0.7
   - Stroke: black, weight 1
   - Popup on click: postcode_sector, region, utilization %, primary/secondary medic names, recent bookings count

4. **Accessibility** (Pitfall 5): Add text labels alongside colors. The popup shows utilization as number, and the territory list (below map) provides non-color-dependent data.

5. **Legend**: Small box in bottom-right corner showing green/yellow/red meaning.

**2b. Create `web/components/admin/territory-list.tsx`:**

Simple table below the map showing all territories:
- Columns: Postcode Sector, Region, Primary Medic, Secondary Medic, Utilization (bar), Bookings (total/confirmed/rejected), Rejection Rate, Fulfillment Rate
- Sortable by utilization (default: high to low)
- Row click navigates to territory detail (or opens info panel)
- Rows with rejection_rate > 10% have red left border and warning icon

**2c. Create `web/app/admin/territories/page.tsx`:**

'use client' page that:
- Uses useTerritories hook
- Calculates coverage gaps via calculateCoverageGaps
- Renders coverage gap AlertBanners at top (if any gaps exist):
  - Warning severity: yellow Alert with AlertTriangle icon
  - Critical severity: red Alert (destructive variant)
  - Each alert shows postcode, rejection rate, suggestion to add medics
- Renders TerritoryMap (60% of viewport height)
- Renders TerritoryList below map
- Header: "Territory Coverage" with Map icon, subtitle "Monitor utilization and coverage gaps across UK territories"

**2d. Update `web/app/admin/layout.tsx`:**

Ensure "Territories" nav item exists (currently it shows "Command Center" which is the existing map). If not already present, the existing layout has no explicit "Territories" nav item. Check if "Command Center" should be renamed or if Territories should be added alongside it. Since the layout already has `{ name: 'Command Center', href: '/admin/command-center', icon: MapPin }`, we do NOT add a duplicate. Instead, the territories page is accessible via the admin sidebar -- it's already implied by the existing nav structure. No layout changes needed if the path exists.

Actually, looking at the layout, there is NO "Territories" item. Add it:
- name: 'Territories'
- href: '/admin/territories'
- icon: Map (from lucide-react)
- Position: After "Command Center"

AVOID:
- Don't use Polygon/GeoJSON (no boundary data available)
- Don't call Google Maps geocoding API (use hardcoded centroids)
- Don't render map on server (use dynamic import with ssr: false)
  </action>
  <verify>
- `ls web/components/admin/territory-map.tsx web/components/admin/territory-list.tsx web/app/admin/territories/page.tsx`
- `grep -n 'dynamic\|ssr.*false' web/components/admin/territory-map.tsx` confirms SSR disabled for Leaflet
- `grep -n 'CircleMarker\|fillColor' web/components/admin/territory-map.tsx` confirms color-coded markers
- `grep -n 'calculateCoverageGaps\|CoverageGapAlert' web/app/admin/territories/page.tsx` confirms gap alerts rendered
- `grep -n 'Territories' web/app/admin/layout.tsx` confirms nav item
- `pnpm tsc --noEmit` passes
  </verify>
  <done>
Territory page shows React Leaflet map with color-coded circle markers (green/yellow/red by utilization), territory list table with utilization bars, and coverage gap alert banners when rejection rate >10%. SC #6 (territory map with utilization colors) and SC #7 (coverage gap alerts >10%) addressed.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'CircleMarker' web/components/admin/territory-map.tsx` confirms map markers
2. `grep -rn 'rejection_rate.*10\|rejectionRate.*0.10' web/lib/queries/admin/territories.ts` confirms gap threshold
3. `grep -rn 'Alert.*Coverage\|coverage.*gap' web/app/admin/territories/page.tsx` confirms gap alerts displayed
4. `grep -rn '#22c55e\|#eab308\|#ef4444' web/lib/queries/admin/territories.ts` confirms color coding
5. `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- Territory map renders with color-coded markers: green <50%, yellow 50-80%, red >80% utilization (SC #6)
- Map centered on UK, shows all seeded territories
- Clicking marker shows popup with territory details
- Coverage gap alerts appear as banners when rejection rate >10% (SC #7)
- Territory list shows all data in tabular form with sorting
- Map uses dynamic import (no SSR crash)
</success_criteria>

<output>
After completion, create `.planning/phases/05.5-admin-operations/05.5-04-SUMMARY.md`
</output>
