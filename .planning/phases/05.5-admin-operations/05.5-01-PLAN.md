---
phase: 05.5-admin-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/admin/bookings/page.tsx
  - web/components/admin/booking-approval-table.tsx
  - web/lib/queries/admin/bookings.ts
  - web/components/admin/bulk-action-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view all bookings with filters (date range, status, medic, client)"
    - "Admin can approve/reject bookings requiring manual review (emergency, out-of-territory, special requirements)"
    - "Admin can reassign medic to different booking with reason"
  artifacts:
    - path: "web/app/admin/bookings/page.tsx"
      provides: "Bookings management page with approval workflow"
      contains: "BookingApprovalTable"
    - path: "web/components/admin/booking-approval-table.tsx"
      provides: "Data table with row selection, bulk approve/reject, reassign dialog"
      exports: ["BookingApprovalTable"]
    - path: "web/lib/queries/admin/bookings.ts"
      provides: "TanStack Query hooks and mutation functions for bookings"
      exports: ["useBookings", "useApproveBookings", "useRejectBookings", "useReassignBooking"]
    - path: "web/components/admin/bulk-action-toolbar.tsx"
      provides: "Floating toolbar when rows are selected"
      exports: ["BulkActionToolbar"]
  key_links:
    - from: "web/app/admin/bookings/page.tsx"
      to: "web/components/admin/booking-approval-table.tsx"
      via: "imports BookingApprovalTable"
      pattern: "import.*BookingApprovalTable"
    - from: "web/components/admin/booking-approval-table.tsx"
      to: "web/lib/queries/admin/bookings.ts"
      via: "uses TanStack Query mutations for approve/reject/reassign"
      pattern: "useApproveBookings|useRejectBookings|useReassignBooking"
    - from: "web/lib/queries/admin/bookings.ts"
      to: "supabase bookings table"
      via: "Supabase client update queries with optimistic updates"
      pattern: "supabase.*from.*bookings.*update"
---

<objective>
Build the bookings management page with approval workflow, bulk operations, and medic reassignment.

Purpose: Admins need to approve/reject bookings that require manual review (emergency, out-of-territory, special requirements) and reassign medics when needed. This is the most workflow-heavy admin page.

Output: Fully functional bookings management with row selection, bulk approve/reject with confirmation dialogs, reassign medic dialog, optimistic updates, and enhanced filtering.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.5-admin-operations/05.5-RESEARCH.md

Key existing files to reference:
@web/app/admin/bookings/page.tsx (existing read-only bookings page - will be replaced)
@web/app/admin/layout.tsx (existing admin sidebar layout)
@web/components/dashboard/data-table.tsx (Phase 4 DataTable pattern to extend)
@web/lib/queries/compliance.ts (TanStack Query hook pattern to follow)
@supabase/migrations/002_business_operations.sql (bookings table schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create booking query hooks and mutation functions</name>
  <files>web/lib/queries/admin/bookings.ts</files>
  <action>
Create `web/lib/queries/admin/bookings.ts` with TanStack Query hooks for bookings CRUD:

1. **Types**: Define `BookingWithRelations` type matching the bookings table joined with clients (company_name) and medics (first_name, last_name). Include all booking fields from the existing page's Booking interface plus `approval_reason`.

2. **fetchBookings(supabase)**: Server-side fetch function that queries bookings with client and medic joins, ordered by shift_date DESC. Filter out cancelled bookings older than 30 days for performance.

3. **useBookings(initialData)**: Client-side TanStack Query hook with 60-second polling (refetchInterval: 60_000), consistent with Phase 4/5 pattern from compliance.ts.

4. **useApproveBookings()**: Mutation hook using TanStack Query useMutation:
   - mutationFn: takes array of booking IDs, calls supabase.from('bookings').update({ status: 'confirmed', approved_at: new Date().toISOString() }).in('id', bookingIds)
   - onMutate: optimistic update -- cancel queries, snapshot previous data, update cache to set status='confirmed' for selected IDs
   - onError: rollback to previous data, show toast error
   - onSettled: invalidate bookings query
   - Pattern: Follow Research Pattern 3 (Optimistic Updates for Approval Workflows)

5. **useRejectBookings()**: Similar mutation hook that sets status='cancelled', cancellation_reason from user input, cancelled_at timestamp.

6. **useReassignBooking()**: Mutation for single booking reassignment:
   - Takes { bookingId, newMedicId, reason }
   - Updates medic_id and adds approval_reason
   - Optimistic update on the single booking row

7. **fetchAvailableMedics(supabase, shiftDate)**: Fetch medics who are available_for_work=true for reassignment dropdown. Join with territories if the booking has a site_postcode.

Use `createClient` from `@/lib/supabase/client` for client-side hooks. Import pattern from existing `web/lib/queries/compliance.ts`.

AVOID: Individual UPDATE calls in loops (Pitfall 1). Use .in('id', bookingIds) for bulk operations.
  </action>
  <verify>
Check file exists and exports are correct:
- `ls web/lib/queries/admin/bookings.ts`
- Grep for exported hooks: `grep -n 'export function' web/lib/queries/admin/bookings.ts`
- Verify optimistic update pattern: `grep -n 'onMutate' web/lib/queries/admin/bookings.ts`
- Verify no N+1 pattern: ensure no `.update()` inside a loop
  </verify>
  <done>
File exports useBookings, useApproveBookings, useRejectBookings, useReassignBooking, fetchBookings, fetchAvailableMedics. All mutations use optimistic updates with rollback. Bulk operations use single .in() query, not loops.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build booking approval table with bulk actions and reassign dialog</name>
  <files>web/components/admin/booking-approval-table.tsx, web/components/admin/bulk-action-toolbar.tsx, web/app/admin/bookings/page.tsx</files>
  <action>
**2a. Create `web/components/admin/bulk-action-toolbar.tsx`:**

Reusable floating toolbar that appears when rows are selected in any admin table:
- Props: `selectedCount: number`, `onApprove?: () => void`, `onReject?: () => void`, `onClear: () => void`, `isLoading?: boolean`, `children?: ReactNode` (for custom actions)
- UI: Fixed-position bar at bottom of viewport (or sticky at top of table area), shows "{N} selected" with action buttons
- Uses shadcn/ui Button, includes confirmation via AlertDialog (Research Pattern: Confirmation Dialog for Destructive Actions)
- Approve button (green), Reject button (red with AlertDialog confirmation), Clear selection (ghost)
- Show loading spinner when isLoading is true (Pitfall 9: Missing Loading States)

**2b. Create `web/components/admin/booking-approval-table.tsx`:**

Client component ('use client') with TanStack Table and row selection:

1. **Column definitions** with checkbox column (Research Pattern 2: Row Selection):
   - Select checkbox (header = select all, cell = select row)
   - Date (shift_date formatted dd MMM yyyy, shift_start_time - shift_end_time below)
   - Site (site_name, site_postcode below)
   - Client (clients.company_name)
   - Medic (medics.first_name + last_name, or "Unassigned" in yellow if null, "Needs approval" badge if requires_manual_approval)
   - Requirements (badges: Confined Space blue, Trauma red, urgency premium orange)
   - Total (formatted GBP with CurrencyWithTooltip, platform_fee and medic_payout below)
   - Status (color-coded badge: pending=yellow, confirmed=green, in_progress=cyan, completed=purple, cancelled=red)
   - Actions (dropdown menu: View Details, Approve, Reject, Reassign Medic)

2. **Filters section** above table:
   - Search input with 300ms debounce (Pitfall 4: Unbounded Search Queries)
   - Status filter (Select component: All, Pending, Confirmed, In Progress, Completed, Cancelled)
   - Date filter (Select: All, Today, Upcoming, Past)
   - "Needs Approval" toggle/badge filter

3. **Row selection** using TanStack Table rowSelection state, getRowId returns booking.id (preserves selection across pagination, Pitfall 3).

4. **BulkActionToolbar** rendered when selectedCount > 0, wired to useApproveBookings and useRejectBookings mutations.

5. **Reassign Dialog** using shadcn/ui Dialog:
   - Triggered from row action dropdown "Reassign Medic"
   - Shows current medic name
   - Select component populated with available medics from fetchAvailableMedics
   - Required "reason" text input
   - Confirm button calls useReassignBooking mutation

6. **Rejection Dialog** using AlertDialog:
   - Required "reason" text input for rejection
   - Shows count of bookings being rejected
   - Confirm triggers useRejectBookings with reason

7. **Stats row** above table showing: Total bookings, Pending (highlighted if >0), Needs Approval (highlighted if >0), Completed, Total Revenue (CurrencyWithTooltip)

Style: Match existing admin dark theme (bg-gray-800/50, border-gray-700/50, text-white). Use the existing admin page styling patterns from the current bookings page.

**2c. Update `web/app/admin/bookings/page.tsx`:**

Replace the entire existing page with a cleaner version that:
- Keeps 'use client' (consistent with admin layout pattern)
- Imports and renders BookingApprovalTable with bookings data
- Uses useBookings hook for data fetching with 60s polling
- Keeps the existing header design pattern (gradient header with icon and "New Booking" button)
- Removes all the inline component definitions (StatCard, BookingRow, etc.) that are now in the table component

AVOID:
- Don't change the admin layout.tsx (shared across all admin pages)
- Don't use Server Components for admin pages (admin layout is 'use client')
- No individual API calls in loops for bulk operations
  </action>
  <verify>
- `ls web/components/admin/booking-approval-table.tsx web/components/admin/bulk-action-toolbar.tsx`
- Grep for row selection: `grep -n 'rowSelection\|toggleSelected\|getIsSelected' web/components/admin/booking-approval-table.tsx`
- Grep for bulk actions: `grep -n 'useApproveBookings\|useRejectBookings' web/components/admin/booking-approval-table.tsx`
- Grep for reassign dialog: `grep -n 'Reassign\|reassign' web/components/admin/booking-approval-table.tsx`
- Grep for debounced search: `grep -n 'setTimeout\|debounce' web/components/admin/booking-approval-table.tsx`
- `pnpm build` passes (or at minimum `pnpm tsc --noEmit` for type checking)
  </verify>
  <done>
Bookings page renders BookingApprovalTable with row selection, bulk approve/reject with confirmation dialogs, reassign medic dialog with available medics dropdown, debounced search, status/date filters, and optimistic updates. All three success criteria (SC #1, #2, #3) addressed.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'useApproveBookings\|useRejectBookings\|useReassignBooking' web/` confirms hooks are imported and used
2. `grep -rn 'rowSelection' web/components/admin/booking-approval-table.tsx` confirms row selection is wired
3. `grep -rn 'AlertDialog' web/components/admin/` confirms confirmation dialogs exist for destructive actions
4. `grep -rn 'onMutate' web/lib/queries/admin/bookings.ts` confirms optimistic updates
5. `pnpm tsc --noEmit` passes with no type errors
</verification>

<success_criteria>
- Admin can view all bookings with status, date, and search filters (SC #1)
- Admin can bulk approve/reject bookings with confirmation dialog (SC #2)
- Admin can reassign medic with reason via dialog (SC #3)
- Optimistic updates provide instant UI feedback
- Debounced search prevents query overload
- Row selection persists across pagination
</success_criteria>

<output>
After completion, create `.planning/phases/05.5-admin-operations/05.5-01-SUMMARY.md`
</output>
