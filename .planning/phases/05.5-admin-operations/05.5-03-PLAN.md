---
phase: 05.5-admin-operations
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/admin/timesheets/page.tsx
  - web/components/admin/timesheet-batch-approval.tsx
  - web/lib/queries/admin/timesheets.ts
autonomous: true

must_haves:
  truths:
    - "Admin can batch-approve 20 timesheets in <5 minutes (Friday payout workflow)"
    - "Timesheet approval uses single bulk database operation, not individual updates"
  artifacts:
    - path: "web/app/admin/timesheets/page.tsx"
      provides: "Timesheet batch approval page for Friday payout workflow"
      contains: "TimesheetBatchApproval"
    - path: "web/components/admin/timesheet-batch-approval.tsx"
      provides: "Table with select-all, batch approve/reject, payout amount display"
      exports: ["TimesheetBatchApproval"]
    - path: "web/lib/queries/admin/timesheets.ts"
      provides: "TanStack Query hooks with bulk upsert mutation"
      exports: ["usePendingTimesheets", "useBatchApproveTimesheets", "useBatchRejectTimesheets"]
  key_links:
    - from: "web/components/admin/timesheet-batch-approval.tsx"
      to: "web/lib/queries/admin/timesheets.ts"
      via: "uses batch mutation hooks"
      pattern: "useBatchApproveTimesheets|useBatchRejectTimesheets"
    - from: "web/lib/queries/admin/timesheets.ts"
      to: "supabase timesheets table"
      via: "bulk upsert for batch approval"
      pattern: "supabase.*from.*timesheets.*upsert"
---

<objective>
Build the timesheet batch approval page for the Friday payout workflow.

Purpose: Every Friday, admins need to review and approve timesheets so medics get paid. The batch approval must handle 20+ timesheets efficiently (< 5 minutes including review time). This is the most performance-critical admin workflow.

Output: Timesheet page with select-all, batch approve/reject, bulk upsert database operation, payout summary, and optimistic updates.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.5-admin-operations/05.5-RESEARCH.md

Key existing files to reference:
@web/app/admin/layout.tsx (admin sidebar layout - needs "Timesheets" nav item)
@web/components/admin/bulk-action-toolbar.tsx (created in Plan 01, reuse for batch actions)
@supabase/migrations/002_business_operations.sql (timesheets table schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create timesheet query hooks with bulk upsert mutation</name>
  <files>web/lib/queries/admin/timesheets.ts</files>
  <action>
Create `web/lib/queries/admin/timesheets.ts` with:

1. **Types**:
   - `TimesheetWithDetails`: extends timesheet fields with joined data: booking.site_name, booking.shift_date, booking.shift_start_time, booking.shift_end_time, medic.first_name, medic.last_name, booking.clients.company_name
   - `TimesheetFilterState`: { status: 'all' | 'pending' | 'manager_approved' | 'admin_approved' | 'paid' | 'rejected', weekFilter: 'current' | 'last' | 'all', search: string }

2. **fetchPendingTimesheets(supabase)**: Fetch timesheets with status in ['pending', 'manager_approved'] joined with bookings (site_name, shift_date, shift_start_time, shift_end_time, client join for company_name) and medics (first_name, last_name). Order by booking shift_date DESC. These are the ones ready for admin review.

3. **fetchAllTimesheets(supabase)**: Fetch ALL timesheets (all statuses) for the overview/history view.

4. **usePendingTimesheets(initialData?)**: TanStack Query hook with 60s polling for timesheets needing approval.

5. **useBatchApproveTimesheets()**: CRITICAL mutation following Research Pattern 4 (Batch Operations via PostgreSQL Bulk Upsert):
   - mutationFn: Takes array of timesheet IDs
   - Builds update array: timesheetIds.map(id => ({ id, payout_status: 'admin_approved', admin_approved_at: new Date().toISOString(), admin_approved_by: adminUserId }))
   - Executes SINGLE supabase.from('timesheets').upsert(updates, { onConflict: 'id' })
   - Validates batch size <= 1000 (optimal: 500-1000 per Research)
   - onMutate: Optimistic update -- set selected timesheets to 'admin_approved' in cache
   - onError: Rollback, show error toast
   - onSettled: Invalidate queries
   - Performance target: 20 timesheets in <5 seconds database time

6. **useBatchRejectTimesheets()**: Similar bulk mutation setting payout_status='rejected', admin_rejection_reason from user input.

7. **calculatePayoutSummary(timesheets)**: Pure function that sums payout_amount for selected timesheets, returns { totalPayout, medicCount, avgPerMedic }.

CRITICAL: The bulk upsert MUST be a SINGLE database call, NOT a loop of individual updates. This is the key performance requirement (Pitfall 1: N+1 Query Problem).
  </action>
  <verify>
- `ls web/lib/queries/admin/timesheets.ts`
- `grep -n 'upsert' web/lib/queries/admin/timesheets.ts` confirms bulk upsert pattern
- `grep -n 'onMutate' web/lib/queries/admin/timesheets.ts` confirms optimistic updates
- Verify NO loop pattern: `grep -n 'for.*await\|forEach.*await\|map.*await' web/lib/queries/admin/timesheets.ts` should return empty or only Promise.all
  </verify>
  <done>
Timesheet hooks export usePendingTimesheets, useBatchApproveTimesheets, useBatchRejectTimesheets. Batch operations use single supabase.upsert() call. No N+1 query patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build timesheet batch approval page with select-all and payout summary</name>
  <files>web/components/admin/timesheet-batch-approval.tsx, web/app/admin/timesheets/page.tsx, web/app/admin/layout.tsx</files>
  <action>
**2a. Create `web/components/admin/timesheet-batch-approval.tsx`:**

Client component optimized for the Friday payout workflow:

1. **Column definitions** with checkbox column:
   - Select checkbox (header = select all on page, cell = select row)
   - Medic (first_name + last_name)
   - Site (booking.site_name)
   - Client (booking.clients.company_name)
   - Date (booking.shift_date formatted dd MMM yyyy)
   - Shift (shift_start_time - shift_end_time)
   - Hours (logged_hours, with discrepancy indicator if logged_hours != scheduled_hours -- yellow text with scheduled_hours in parentheses)
   - Payout Amount (CurrencyWithTooltip for medic payout_amount)
   - Status (badge: pending=yellow, manager_approved=blue "Manager OK", admin_approved=green "Approved", paid=purple "Paid", rejected=red)
   - Submitted (medic_submitted_at formatted, manager_approved_at below)

2. **Payout summary card** above table (only visible when timesheets selected):
   - Total payout amount (sum of selected payout_amount values, CurrencyWithTooltip)
   - Number of medics (unique medic_ids in selection)
   - Number of timesheets selected
   - "Approve & Queue for Payout" primary button (green gradient)
   - "Reject Selected" secondary button (red outline)

3. **Quick actions row**:
   - "Select All Pending" button (selects all with status='manager_approved', the typical Friday workflow)
   - "Select This Week" button (filters and selects timesheets from current week)
   - Shows total pending count and total payout amount

4. **Filters**:
   - Status tabs (All, Pending Review, Manager Approved, Admin Approved, Paid, Rejected)
   - Week filter (This Week, Last Week, All)
   - Search (medic name, site name, client)

5. **Discrepancy highlighting**: Rows where logged_hours differs from scheduled_hours get a subtle yellow left border and a warning icon. Discrepancy reason shown in tooltip.

6. **Confirmation dialog** for batch approve: Shows count, total payout, list of medic names being paid. "This will queue {N} timesheets totaling {amount} for Friday payout."

7. **Rejection dialog**: Requires admin_rejection_reason text input. Shows which timesheets are being rejected.

Import BulkActionToolbar from Plan 01 if it exists, otherwise create inline action bar.

**2b. Create `web/app/admin/timesheets/page.tsx`:**

'use client' page that:
- Uses usePendingTimesheets hook
- Renders TimesheetBatchApproval component
- Header: "Timesheets" with Clock icon, subtitle "Review and approve timesheets for Friday payouts"
- No "Add" button (timesheets come from medic submissions)

**2c. Update `web/app/admin/layout.tsx`:**

Add "Timesheets" to the navItems array in the admin sidebar:
- name: 'Timesheets'
- href: '/admin/timesheets'
- icon: Clock (from lucide-react, already imported)
- badge: count of pending timesheets (optional, can be hardcoded initially)
- Position: After "Schedule Board" and before "Medics" in the nav order

AVOID:
- Don't change the sidebar styling or other nav items
- Only ADD the Timesheets item to the existing navItems array
  </action>
  <verify>
- `ls web/app/admin/timesheets/page.tsx web/components/admin/timesheet-batch-approval.tsx`
- `grep -n 'Timesheets' web/app/admin/layout.tsx` confirms nav item added
- `grep -n 'Select All\|select.*all\|selectAll' web/components/admin/timesheet-batch-approval.tsx` confirms select-all functionality
- `grep -n 'payout_amount\|PayoutSummary\|totalPayout' web/components/admin/timesheet-batch-approval.tsx` confirms payout summary
- `grep -n 'useBatchApproveTimesheets' web/components/admin/timesheet-batch-approval.tsx` confirms batch mutation wired
- `pnpm tsc --noEmit` passes
  </verify>
  <done>
Timesheet page with batch approval workflow: select-all, payout summary, confirmation dialog, bulk upsert. Admin can select 20 timesheets and approve in one click. SC #5 (batch approve 20 timesheets in <5 minutes) addressed. Timesheets nav item added to admin sidebar.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'upsert' web/lib/queries/admin/timesheets.ts` confirms single bulk operation
2. `grep -rn 'rowSelection' web/components/admin/timesheet-batch-approval.tsx` confirms row selection
3. `grep -rn 'AlertDialog\|confirmation' web/components/admin/timesheet-batch-approval.tsx` confirms confirmation before bulk action
4. `grep -rn 'Timesheets' web/app/admin/layout.tsx` confirms navigation entry
5. `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- Admin can view pending timesheets with medic, site, hours, payout details
- "Select All Pending" enables one-click selection of all manager-approved timesheets
- Batch approve uses single database upsert (not N individual updates)
- Payout summary shows total amount, medic count before confirmation
- Confirmation dialog prevents accidental bulk actions
- Discrepancy highlighting flags hours mismatches
- SC #5: 20 timesheets approved in <5 minutes workflow
</success_criteria>

<output>
After completion, create `.planning/phases/05.5-admin-operations/05.5-03-SUMMARY.md`
</output>
