---
phase: 05.5-admin-operations
plan: 04
subsystem: ui
tags: [react-leaflet, tanstack-query, territories, geographic-coverage, admin-dashboard]

# Dependency graph
requires:
  - phase: 01.5-business-foundation
    provides: territories and territory_metrics tables with postcode sectors and utilization tracking
  - phase: 05.5-admin-operations/02
    provides: useMedics pattern with parallel queries and 60s polling
provides:
  - Territory coverage page with interactive Leaflet map
  - Coverage gap detection and alerting system
  - Color-coded utilization visualization (green/yellow/red)
  - Sortable territory table with metrics
affects: [06-compliance-automation, hiring-decisions, territory-rebalancing]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Dynamic import for SSR-incompatible libraries (Leaflet)"
    - "Hardcoded postcode centroids instead of geocoding API"
    - "Coverage gap alerts with severity levels (warning/critical)"
    - "Color-coded utilization bands for visual scanning"

key-files:
  created:
    - web/lib/queries/admin/territories.ts
    - web/components/admin/territory-map.tsx
    - web/components/admin/territory-list.tsx
    - web/app/admin/territories/page.tsx
  modified:
    - web/app/admin/layout.tsx

key-decisions:
  - "Use hardcoded UK_POSTCODE_CENTROIDS instead of OS Data Hub or geocoding API"
  - "Circle markers instead of boundary polygons (simpler, sufficient for admin overview)"
  - "Dynamic import with ssr:false for Leaflet map component"
  - "Coverage gap threshold at >10% rejection rate"
  - "Severity levels: warning (10-25%), critical (>25%)"

patterns-established:
  - "Dynamic import pattern: export component normally, wrap with dynamic() in parent page"
  - "UK postcode centroid lookup for approximate map positioning"
  - "Coverage gap calculation as pure function from territory data"

# Metrics
duration: 6.5min
completed: 2026-02-16
---

# Phase 05.5-04: Territory Coverage Dashboard Summary

**Interactive Leaflet map with color-coded utilization markers, coverage gap alerts for >10% rejection rate, and sortable territory metrics table**

## Performance

- **Duration:** 6.5 min
- **Started:** 2026-02-16T06:18:21Z
- **Completed:** 2026-02-16T06:24:47Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- Territory query hooks with UK postcode centroids (200+ areas)
- Interactive React Leaflet map with color-coded circle markers
- Coverage gap detection and alert system (warning/critical severity)
- Sortable territory table with utilization bars and metrics
- Added Territories nav item to admin sidebar

## Task Commits

Each task was committed atomically:

1. **Task 1: Create territory query hooks with utilization and gap detection** - `cc0e4f0` (feat)
2. **Task 2: Build territory map and list with coverage gap alerts** - `1eb0009`, `6a57a2c`, `3718b4d` (feat, fix, refactor)

**Plan metadata:** Part of broader admin dashboard improvements

## Files Created/Modified

- `web/lib/queries/admin/territories.ts` - Territory query hooks with UK_POSTCODE_CENTROIDS (200+ areas), fetchTerritoriesWithMetrics (parallel queries), calculateCoverageGaps, getUtilizationColor
- `web/components/admin/territory-map.tsx` - React Leaflet map with CircleMarker, color-coded by utilization, popup with territory details, legend for color bands
- `web/components/admin/territory-list.tsx` - Sortable table with utilization bars, color-coded rejection rates, red border for coverage gaps >10%
- `web/app/admin/territories/page.tsx` - Coverage page with gap alerts (warning/critical), dynamic map import, territory list
- `web/app/admin/layout.tsx` - Added Territories nav item with Map icon

## Decisions Made

**D-05.5-04-001: Use hardcoded UK_POSTCODE_CENTROIDS instead of OS Data Hub or geocoding API**
- Rationale: Approximate centroids sufficient for postcode-area-level admin overview, avoids external API dependency
- Impact: 200+ hardcoded lat/lng coordinates for major UK postcode areas
- Tradeoff: Not pixel-perfect positioning, but adequate for circle markers at country zoom level

**D-05.5-04-002: Circle markers instead of boundary polygons**
- Rationale: OS Data Hub boundary data requires external service, polygons overkill for admin overview
- Impact: Simpler map rendering, faster page load
- Tradeoff: Less precise than boundary polygons, but clear visual representation

**D-05.5-04-003: Dynamic import with ssr:false for Leaflet map**
- Rationale: Leaflet requires browser APIs (window, document), crashes during SSR
- Impact: Map component lazy-loaded client-side only
- Pattern: Export component normally, wrap with dynamic() in parent page

**D-05.5-04-004: Coverage gap threshold at >10% rejection rate**
- Rationale: Matches Research pattern, indicates territory under-served
- Impact: Alerts trigger when 1 in 10 bookings rejected
- Severity: warning (10-25%), critical (>25%)

**D-05.5-04-005: Color-coded utilization bands (green <50%, yellow 50-80%, red >80%)**
- Rationale: Matches existing admin patterns from medics page, quick visual assessment
- Impact: Instant identification of overloaded territories
- Accessibility: Legend + numeric percentages in popup provide non-color-dependent data

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed TypeScript type inference error in territory metrics**
- **Found during:** Task 1 (Territory query implementation)
- **Issue:** TypeScript couldn't infer conditional type `typeof metricsResult.data extends Array<infer T> ? T : never` from Supabase query result
- **Fix:** Changed to `Map<string, any>` for metricsByPostcode since the data structure is validated at runtime
- **Files modified:** web/lib/queries/admin/territories.ts
- **Verification:** `pnpm tsc --noEmit` passes with no errors in territory files
- **Committed in:** Part of subsequent fix commits

**2. [Rule 1 - Bug] Fixed arithmetic operation type error in territory sorting**
- **Found during:** Task 2 (Territory list sorting implementation)
- **Issue:** TypeScript error "The left-hand side of an arithmetic operation must be of type 'any', 'number', 'bigint' or an enum type" because aVal/bVal union type includes string
- **Fix:** Added type assertions for numeric comparisons after string check
- **Files modified:** web/components/admin/territory-list.tsx
- **Verification:** TypeScript compilation passes, sorting works correctly
- **Committed in:** Part of fix commits

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug)
**Impact on plan:** Both auto-fixes necessary for TypeScript compilation. No scope creep.

## Issues Encountered

None - plan executed smoothly with only minor TypeScript type fixes.

## User Setup Required

None - no external service configuration required. Territory data comes from existing Supabase tables (territories, territory_metrics).

## Next Phase Readiness

Territory coverage dashboard complete. Ready for:
- Territory assignment decisions based on utilization and coverage gaps
- Hiring decisions driven by high rejection rates
- Territory rebalancing when medics show >80% utilization

Coverage gap alerts provide actionable intelligence for capacity planning.

---
*Phase: 05.5-admin-operations*
*Completed: 2026-02-16*
