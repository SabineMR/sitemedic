---
phase: 05.5-admin-operations
plan: 05
type: execute
wave: 2
depends_on: ["05.5-01"]
files_modified:
  - web/app/admin/revenue/page.tsx
  - web/components/admin/revenue-charts.tsx
  - web/components/admin/cash-flow-warning.tsx
  - web/lib/queries/admin/revenue.ts
autonomous: true

must_haves:
  truths:
    - "Revenue dashboard shows platform fees earned per territory and per medic"
    - "Cash flow projection warns when gap >30 days (pay medics before collecting from clients)"
  artifacts:
    - path: "web/app/admin/revenue/page.tsx"
      provides: "Revenue dashboard page with charts and cash flow warning"
      contains: "RevenueCharts"
    - path: "web/components/admin/revenue-charts.tsx"
      provides: "Recharts components for revenue trends, territory breakdown, medic earnings"
      exports: ["RevenueTrendChart", "TerritoryRevenueChart", "MedicEarningsChart"]
    - path: "web/components/admin/cash-flow-warning.tsx"
      provides: "Cash flow gap warning banner component"
      exports: ["CashFlowWarning"]
    - path: "web/lib/queries/admin/revenue.ts"
      provides: "Revenue aggregation queries and cash flow calculation"
      exports: ["useRevenue", "calculateCashFlowGap"]
  key_links:
    - from: "web/app/admin/revenue/page.tsx"
      to: "web/components/admin/revenue-charts.tsx"
      via: "renders chart components with revenue data"
      pattern: "import.*RevenueTrendChart|TerritoryRevenueChart"
    - from: "web/lib/queries/admin/revenue.ts"
      to: "supabase bookings + payments + timesheets tables"
      via: "aggregation queries for revenue data"
      pattern: "supabase.*from.*bookings|payments"
---

<objective>
Build the revenue dashboard with Recharts visualizations and cash flow gap warning system.

Purpose: Admins need to track platform profitability, understand which territories and medics generate the most revenue, and get early warning when the cash flow gap between paying medics (weekly) and collecting from clients (Net 30) becomes dangerous.

Output: Revenue dashboard with trend line chart (revenue/payouts/gap over time), territory bar chart, medic earnings table, and cash flow warning banner.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.5-admin-operations/05.5-RESEARCH.md

Key existing files to reference:
@web/app/admin/layout.tsx (admin sidebar)
@web/components/CurrencyWithTooltip.tsx (currency display component)
@supabase/migrations/002_business_operations.sql (bookings, payments, timesheets, invoices tables)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create revenue query hooks and cash flow calculation</name>
  <files>web/lib/queries/admin/revenue.ts</files>
  <action>
Create `web/lib/queries/admin/revenue.ts` with:

1. **Types**:
   - `RevenueData`: { weeklyTrend: WeeklyRevenue[], territoryBreakdown: TerritoryRevenue[], medicEarnings: MedicRevenue[], summary: RevenueSummary }
   - `WeeklyRevenue`: { week: string (ISO week label like "W7 2026"), revenue: number, payouts: number, platformFees: number, gap: number }
   - `TerritoryRevenue`: { postcode_sector: string, region: string, revenue: number, platformFees: number, bookingCount: number }
   - `MedicRevenue`: { medic_id: string, medic_name: string, totalEarnings: number, shiftsCompleted: number, avgPerShift: number }
   - `RevenueSummary`: { totalRevenue: number, totalPayouts: number, totalPlatformFees: number, avgCollectionDays: number, activeClients: number, net30Clients: number }

2. **fetchRevenueData(supabase, timeRange)**: Server-side function:
   - timeRange: 'last_4_weeks' | 'last_12_weeks' | 'last_52_weeks'

   a. **Weekly trend**: Query completed bookings grouped by ISO week. For each week, sum total (revenue), medic_payout (payouts), platform_fee (fees). Calculate gap = cumulative payouts - cumulative collections (from payments table where status='succeeded').

   b. **Territory breakdown**: Query completed bookings grouped by site_postcode (first part), sum total and platform_fee, count bookings. Map postcode to region using territories table join.

   c. **Medic earnings**: Query completed bookings grouped by medic_id, sum medic_payout, count shifts, calculate avg per shift. Join medics table for names.

   d. **Summary**: Aggregate totals across all time range. Calculate avgCollectionDays from payments table (avg of days between booking.created_at and payment.created_at where status='succeeded'). Count active clients (distinct client_id from bookings in range). Count net30 clients from clients table.

3. **useRevenue(timeRange, initialData?)**: TanStack Query hook with 60s polling. queryKey includes timeRange for cache separation.

4. **calculateCashFlowGap(summary)**: Pure function per Research code example:
   - daysToCollect = summary.avgCollectionDays (typically ~30 for Net 30 clients)
   - daysToPayMedics = 7 (weekly Friday payouts)
   - gap = daysToCollect - daysToPayMedics
   - Returns null if gap <= 30 (acceptable)
   - Returns CashFlowWarning { severity: 'destructive', title: 'Cash Flow Warning', message: "..." } if gap > 30

5. Handle empty data gracefully (Pitfall 6: Cash Flow Projections Without Null Handling): All aggregation functions return 0 for empty datasets, chart data returns empty arrays.

AVOID: Complex SQL -- use Supabase JS client with grouping done client-side after fetching. The dataset is small enough (weeks of bookings) to process in the browser.
  </action>
  <verify>
- `ls web/lib/queries/admin/revenue.ts`
- `grep -n 'export function\|export type' web/lib/queries/admin/revenue.ts`
- `grep -n 'calculateCashFlowGap' web/lib/queries/admin/revenue.ts` confirms cash flow calculation
- `grep -n 'avgCollectionDays\|gap.*30' web/lib/queries/admin/revenue.ts` confirms 30-day threshold
  </verify>
  <done>
Revenue hooks export useRevenue, calculateCashFlowGap. Weekly trend, territory breakdown, medic earnings calculated from bookings/payments data. Cash flow gap warns when >30 days. Empty data handled gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build revenue dashboard with Recharts charts and cash flow warning</name>
  <files>web/components/admin/revenue-charts.tsx, web/components/admin/cash-flow-warning.tsx, web/app/admin/revenue/page.tsx</files>
  <action>
**2a. Create `web/components/admin/revenue-charts.tsx`:**

Three Recharts components per Research Pattern 6:

1. **RevenueTrendChart**: LineChart with ResponsiveContainer (100% width, 400px height):
   - X-axis: week label
   - Three lines: Revenue (green #22c55e), Payouts (red #ef4444), Platform Fees (blue #2563EB)
   - CartesianGrid with dashed lines
   - Tooltip showing all three values formatted as GBP
   - Legend at bottom
   - If data is empty, show "No revenue data for this period" centered text

2. **TerritoryRevenueChart**: BarChart with ResponsiveContainer (100% width, 350px height):
   - X-axis: postcode_sector
   - Two bars stacked: Platform Fees (blue), Medic Payouts (green)
   - Tooltip showing total revenue, platform fees, booking count
   - Bar label showing total revenue
   - Horizontal scroll if >10 territories (wrap in overflow-x-auto div)

3. **MedicEarningsChart**: Table (not chart -- tabular data is clearer for ranked earnings):
   - Columns: Rank, Medic Name, Shifts, Total Earnings (CurrencyWithTooltip), Avg/Shift (CurrencyWithTooltip)
   - Sorted by totalEarnings DESC
   - Top 3 highlighted with gold/silver/bronze left border
   - Empty state: "No completed shifts in this period"

All charts must handle empty arrays gracefully (Pitfall 6). Recharts handles empty data naturally but add explicit empty state UI.

**2b. Create `web/components/admin/cash-flow-warning.tsx`:**

Alert banner component:
- Props: { warning: CashFlowWarning | null }
- If warning is null, don't render anything
- Uses shadcn/ui Alert component with variant="destructive"
- AlertTriangle icon
- Title: "Cash Flow Warning"
- Description: warning.message (from calculateCashFlowGap)
- Dismissible: No (financial warnings should persist until resolved)

**2c. Create `web/app/admin/revenue/page.tsx`:**

'use client' page layout:
- Uses useRevenue hook with default timeRange='last_12_weeks'
- Time range selector at top (4 weeks, 12 weeks, 52 weeks buttons)
- CashFlowWarning banner rendered at top (always visible if warning exists)

- **Summary stat cards row** (4 cards):
  - Total Revenue (green, CurrencyWithTooltip)
  - Platform Fees (blue, CurrencyWithTooltip, percentage of revenue)
  - Total Payouts (red, CurrencyWithTooltip)
  - Active Clients (purple, count + Net 30 clients count)

- **Charts section**:
  - RevenueTrendChart (full width)
  - Two-column grid: TerritoryRevenueChart (left), MedicEarningsChart (right)

- Header: "Revenue" with DollarSign icon, subtitle "Track platform fees, medic payouts, and cash flow health"

**2d. Update `web/app/admin/layout.tsx`:**

Ensure "Revenue" nav item exists. Looking at existing layout, there's no Revenue item. Add:
- name: 'Revenue'
- href: '/admin/revenue'
- icon: TrendingUp (already imported) -- but wait, TrendingUp is already used for "Analytics". Use DollarSign or PoundSterling instead.
- Actually, use the Banknote icon from lucide-react for Revenue
- Position: After "Territories" (or after "Customers" if Territories not yet added)

AVOID:
- Don't use Chart.js (Recharts already installed, better React integration)
- Don't build custom SVG charts (use Recharts composable components)
- Don't crash on empty data (check array length before rendering charts)
  </action>
  <verify>
- `ls web/components/admin/revenue-charts.tsx web/components/admin/cash-flow-warning.tsx web/app/admin/revenue/page.tsx`
- `grep -n 'LineChart\|BarChart\|ResponsiveContainer' web/components/admin/revenue-charts.tsx` confirms Recharts usage
- `grep -n 'CashFlowWarning' web/app/admin/revenue/page.tsx` confirms warning rendered
- `grep -n 'Revenue' web/app/admin/layout.tsx` confirms nav item
- `grep -n 'calculateCashFlowGap' web/app/admin/revenue/page.tsx` confirms gap calculation used
- `pnpm tsc --noEmit` passes
  </verify>
  <done>
Revenue dashboard with trend chart (revenue/payouts/fees lines), territory bar chart, medic earnings table, and cash flow gap warning banner. SC #8 (platform fees per territory/medic) and SC #9 (cash flow warning >30 days) addressed.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'recharts' web/components/admin/revenue-charts.tsx` confirms Recharts library used
2. `grep -rn 'CashFlowWarning' web/components/admin/cash-flow-warning.tsx` confirms warning component
3. `grep -rn 'calculateCashFlowGap' web/lib/queries/admin/revenue.ts` confirms calculation function
4. `grep -rn 'platform_fee\|platformFees' web/lib/queries/admin/revenue.ts` confirms platform fee tracking
5. `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- Revenue trend chart shows revenue, payouts, and platform fees over time
- Territory bar chart ranks territories by revenue
- Medic earnings table shows top earners
- Cash flow warning banner appears when collection gap >30 days (SC #9)
- Platform fees shown per territory and per medic (SC #8)
- Empty data states handled gracefully
- Time range selector allows 4/12/52 week views
</success_criteria>

<output>
After completion, create `.planning/phases/05.5-admin-operations/05.5-05-SUMMARY.md`
</output>
