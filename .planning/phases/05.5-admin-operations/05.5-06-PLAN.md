---
phase: 05.5-admin-operations
plan: 06
type: execute
wave: 2
depends_on: ["05.5-01"]
files_modified:
  - web/app/admin/customers/page.tsx
  - web/components/admin/client-management-table.tsx
  - web/lib/queries/admin/clients.ts
  - web/app/admin/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can upgrade client to Net 30 payment terms (from prepay)"
    - "Admin overview dashboard shows real-time metrics from database, not mock data"
  artifacts:
    - path: "web/app/admin/customers/page.tsx"
      provides: "Client management page with payment terms upgrade"
      contains: "ClientManagementTable"
    - path: "web/components/admin/client-management-table.tsx"
      provides: "Client table with Net 30 upgrade action and booking history"
      exports: ["ClientManagementTable"]
    - path: "web/lib/queries/admin/clients.ts"
      provides: "Client queries and payment terms mutation"
      exports: ["useClients", "useUpgradeToNet30"]
    - path: "web/app/admin/page.tsx"
      provides: "Admin overview with real database metrics, not mock data"
      contains: "useAdminOverview"
  key_links:
    - from: "web/components/admin/client-management-table.tsx"
      to: "web/lib/queries/admin/clients.ts"
      via: "uses upgrade mutation"
      pattern: "useUpgradeToNet30"
    - from: "web/lib/queries/admin/clients.ts"
      to: "supabase clients table"
      via: "update payment_terms to net_30"
      pattern: "supabase.*from.*clients.*update"
    - from: "web/app/admin/page.tsx"
      to: "supabase bookings + medics + timesheets tables"
      via: "real-time metrics queries"
      pattern: "supabase.*from.*bookings|medics"
---

<objective>
Build client management with Net 30 upgrade capability and replace admin overview mock data with real database queries.

Purpose: Admins manage client payment terms (upgrading reliable prepay clients to Net 30 credit terms) and need a real-time overview dashboard that reflects actual system state instead of hardcoded mock data.

Output: Client management table with payment terms upgrade, and admin overview page wired to real database metrics.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.5-admin-operations/05.5-RESEARCH.md

Key existing files to reference:
@web/app/admin/customers/page.tsx (existing read-only customers page - will be enhanced)
@web/app/admin/page.tsx (existing overview with mock data - will be replaced with real queries)
@web/app/admin/layout.tsx (admin sidebar)
@supabase/migrations/002_business_operations.sql (clients table schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client query hooks with Net 30 upgrade mutation</name>
  <files>web/lib/queries/admin/clients.ts</files>
  <action>
Create `web/lib/queries/admin/clients.ts` with:

1. **Types**:
   - `ClientWithHistory`: extends client table fields with: `recent_bookings` (last 10 bookings summary: { id, site_name, shift_date, status, total }[]), `payment_reliability_score` (number 0-100, calculated from late_payments vs total_bookings)
   - `PaymentTermsUpgrade`: { clientId: string, newTerms: 'net_30', creditLimit: number, reason: string }

2. **fetchClients(supabase)**: Fetch all clients ordered by company_name. For each client, calculate payment_reliability_score:
   - If total_bookings = 0: score = 50 (new client, neutral)
   - Otherwise: score = ((successful_bookings - late_payments * 2) / total_bookings) * 100, clamped to 0-100
   - This score helps admins decide if client is reliable enough for Net 30

3. **useClients(initialData?)**: TanStack Query hook with 60s polling.

4. **useUpgradeToNet30()**: Mutation hook:
   - mutationFn: Takes PaymentTermsUpgrade, updates client record: payment_terms='net_30', credit_limit from input
   - Validation: Don't allow upgrade if client has >2 late_payments or status != 'active'
   - onMutate: Optimistic update
   - onError: Rollback, show toast "Failed to upgrade payment terms"
   - onSettled: Invalidate clients query

5. **useDowngradeToPrePay()**: Mutation to revert client to prepay (for clients who abuse Net 30 terms):
   - Sets payment_terms='prepay', credit_limit=0
   - Requires reason field

6. **fetchClientBookingHistory(supabase, clientId)**: Fetch last 20 bookings for a specific client (for detail modal/panel).

AVOID: Don't expose credit limit changes without validation. Minimum credit limit should be 500 GBP.
  </action>
  <verify>
- `ls web/lib/queries/admin/clients.ts`
- `grep -n 'useUpgradeToNet30\|useDowngradeToPrePay' web/lib/queries/admin/clients.ts`
- `grep -n 'payment_reliability_score\|reliabilityScore' web/lib/queries/admin/clients.ts` confirms scoring
- `grep -n 'onMutate' web/lib/queries/admin/clients.ts` confirms optimistic updates
  </verify>
  <done>
Client hooks export useClients, useUpgradeToNet30, useDowngradeToPrePay. Payment reliability score calculated. Net 30 upgrade validated against late payment history.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build client management table and wire admin overview to real data</name>
  <files>web/components/admin/client-management-table.tsx, web/app/admin/customers/page.tsx, web/app/admin/page.tsx, web/lib/queries/admin/overview.ts</files>
  <action>
**2a. Create `web/lib/queries/admin/overview.ts`:**

Query hooks for the admin overview dashboard:
- **fetchAdminOverview(supabase)**: Returns { activeMedics, todayBookings, pendingBookings, issuesCount, totalRevenue, weeklyPayouts, recentActivity }
  - activeMedics: count from medics where available_for_work=true
  - todayBookings: count from bookings where shift_date=today
  - pendingBookings: count from bookings where status='pending'
  - issuesCount: count from bookings where requires_manual_approval=true AND status='pending'
  - totalRevenue: sum of platform_fee from bookings where status='completed' AND created_at >= first day of current month
  - weeklyPayouts: sum of payout_amount from timesheets where payout_status='paid' AND paid_at >= 7 days ago
  - recentActivity: last 10 bookings ordered by created_at DESC, mapped to activity format { id, type, message, timestamp, status, amount? }
- **useAdminOverview()**: TanStack Query hook with 60s polling

**2b. Create `web/components/admin/client-management-table.tsx`:**

Client component with TanStack Table:

1. **Column definitions**:
   - Company (company_name, billing_postcode below, VAT number if present)
   - Contact (contact_name, contact_email, contact_phone)
   - Payment Terms (badge: "Prepay" blue or "Net 30" purple, with credit limit shown for Net 30)
   - Reliability (payment_reliability_score as colored badge: green >=80, yellow 60-79, red <60, with late_payments count)
   - Financials (credit_limit, outstanding_balance for Net 30; "Pay on booking" for prepay)
   - Bookings (total_bookings, successful_bookings, cancelled_bookings, success rate percentage)
   - Status (active green, suspended red with reason tooltip, closed gray)
   - Stripe (Connected green if stripe_customer_id exists, "Not setup" yellow otherwise)
   - Actions (dropdown: View Details, Upgrade to Net 30, Downgrade to Prepay, Suspend, View Booking History)

2. **Upgrade to Net 30 dialog** (shadcn/ui Dialog):
   - Shows client company_name, current payment terms, reliability score
   - If reliability score < 60: warning "This client has a low reliability score ({score}%). Upgrade with caution."
   - Credit limit input (number, minimum 500, default 5000)
   - Reason text input (required)
   - Confirm button calls useUpgradeToNet30

3. **Downgrade to Prepay dialog**:
   - Shows current credit limit and outstanding balance
   - Warning: "Outstanding balance of {amount} will remain. Client must pay before booking again."
   - Reason text input (required)

4. **Filters**:
   - Search (company name, contact, email, postcode) with 300ms debounce
   - Status filter (All, Active, Suspended, Closed)
   - Payment terms filter (All, Prepay, Net 30)
   - "At Risk" toggle (late_payments > 2 or outstanding > 80% credit limit)

5. **Stats row**: Total, Active, Suspended, Net 30, At Risk (highlighted), Outstanding Balance (CurrencyWithTooltip)

**2c. Update `web/app/admin/customers/page.tsx`:**

Replace existing page to:
- Use useClients hook for data
- Render ClientManagementTable
- Keep existing header design with "Add Customer" button

**2d. Update `web/app/admin/page.tsx`:**

Replace mock data with real database queries:
- Import and use useAdminOverview hook
- Keep ALL existing UI design (StatCard, ActivityItem, QuickActionButton, AlertItem components) -- they are well-designed
- Only change the data source: replace the hardcoded mock data in loadDashboardData with the hook's data
- Map recentActivity from database format to the existing RecentActivity interface
- Keep CurrencyWithTooltip usage for revenue/payout amounts
- Add loading state while data fetches
- Add error state if queries fail

IMPORTANT: Do NOT redesign the admin overview page. Only replace mock data with real queries. The existing components (StatCard, ActivityItem, etc.) are already polished and should be preserved exactly.

AVOID:
- Don't redesign the admin overview UI (just wire to real data)
- Don't allow Net 30 upgrade for clients with >2 late payments without explicit admin override
- Don't show credit limit input below 500 GBP
  </action>
  <verify>
- `ls web/components/admin/client-management-table.tsx web/lib/queries/admin/clients.ts web/lib/queries/admin/overview.ts`
- `grep -n 'useUpgradeToNet30' web/components/admin/client-management-table.tsx` confirms upgrade action wired
- `grep -n 'useAdminOverview\|fetchAdminOverview' web/app/admin/page.tsx` confirms real data used
- `grep -n 'TODO.*Replace\|mock\|Mock\|hardcoded' web/app/admin/page.tsx` should return EMPTY (no more mock data)
- `pnpm tsc --noEmit` passes
  </verify>
  <done>
Client management table with Net 30 upgrade/downgrade dialogs, reliability scoring, and all filters. Admin overview wired to real database metrics replacing all mock data. SC #10 (upgrade client to Net 30) addressed. Admin overview now shows live data.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'useUpgradeToNet30' web/components/admin/client-management-table.tsx` confirms upgrade mutation used
2. `grep -rn 'payment_terms.*net_30' web/lib/queries/admin/clients.ts` confirms payment terms update
3. `grep -rn 'fetchAdminOverview\|useAdminOverview' web/app/admin/page.tsx` confirms real data source
4. `grep -rn 'TODO\|mock\|Mock' web/app/admin/page.tsx` should return 0 results (no mock data remains)
5. `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- Admin can upgrade client from prepay to Net 30 with credit limit (SC #10)
- Admin can downgrade client back to prepay with reason
- Reliability score helps admin make informed upgrade decisions
- At Risk filter highlights clients with payment issues
- Admin overview shows real metrics from database (not mock data)
- 60-second polling keeps all data fresh
</success_criteria>

<output>
After completion, create `.planning/phases/05.5-admin-operations/05.5-06-SUMMARY.md`
</output>
