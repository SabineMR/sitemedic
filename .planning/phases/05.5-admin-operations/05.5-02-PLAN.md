---
phase: 05.5-admin-operations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/app/admin/medics/page.tsx
  - web/components/admin/medic-roster-table.tsx
  - web/lib/queries/admin/medics.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view medic roster with availability calendar and territory assignments"
    - "Admin can see utilization percentage and performance metrics for each medic"
  artifacts:
    - path: "web/app/admin/medics/page.tsx"
      provides: "Medic management page with roster table and utilization"
      contains: "MedicRosterTable"
    - path: "web/components/admin/medic-roster-table.tsx"
      provides: "Data table with availability indicators, territory assignments, utilization bars"
      exports: ["MedicRosterTable"]
    - path: "web/lib/queries/admin/medics.ts"
      provides: "TanStack Query hooks for medics with utilization calculation"
      exports: ["useMedics", "useUpdateMedicAvailability"]
  key_links:
    - from: "web/app/admin/medics/page.tsx"
      to: "web/components/admin/medic-roster-table.tsx"
      via: "imports MedicRosterTable"
      pattern: "import.*MedicRosterTable"
    - from: "web/components/admin/medic-roster-table.tsx"
      to: "web/lib/queries/admin/medics.ts"
      via: "uses TanStack Query hooks"
      pattern: "useMedics|useUpdateMedicAvailability"
    - from: "web/lib/queries/admin/medics.ts"
      to: "supabase medics + bookings + territories tables"
      via: "joined queries for utilization calculation"
      pattern: "supabase.*from.*medics"
---

<objective>
Build the medic management page with roster table showing availability, territory assignments, utilization metrics, and performance data.

Purpose: Admins need visibility into their medic workforce -- who's available, where they're assigned, how busy they are, and how well they're performing. This enables workforce planning and territory optimization.

Output: Medic roster table with availability status, territory assignment display, utilization percentage bars, performance metrics (star rating, shifts completed, compliance rate), and Stripe onboarding status.
</objective>

<execution_context>
@/Users/sabineresoagli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sabineresoagli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.5-admin-operations/05.5-RESEARCH.md

Key existing files to reference:
@web/app/admin/medics/page.tsx (existing read-only medics page - will be enhanced)
@web/app/admin/layout.tsx (admin sidebar layout)
@supabase/migrations/002_business_operations.sql (medics, bookings, territories tables)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medic query hooks with utilization calculation</name>
  <files>web/lib/queries/admin/medics.ts</files>
  <action>
Create `web/lib/queries/admin/medics.ts` with:

1. **Types**:
   - `MedicWithMetrics`: extends medic table fields with computed fields: `utilization_pct` (number 0-100), `territory_assignments` (array of { postcode_sector, region, role: 'primary' | 'secondary' }), `upcoming_bookings_count` (number), `completed_bookings_this_week` (number)

2. **fetchMedicsWithMetrics(supabase)**: Server-side function that:
   - Fetches all medics from medics table
   - For each medic, fetches territory assignments from territories table where primary_medic_id or secondary_medic_id matches
   - Calculates utilization: count of confirmed/in_progress bookings this week divided by available working days (5) * 100
   - Counts upcoming bookings (shift_date >= today, status in ['confirmed', 'in_progress', 'pending'])
   - Uses Promise.all for parallel queries (not sequential, Pitfall 8)
   - Returns MedicWithMetrics[]

3. **useMedics(initialData?)**: TanStack Query hook with 60s polling.

4. **useUpdateMedicAvailability()**: Mutation to toggle available_for_work, set unavailable_reason and unavailable_until. Optimistic update.

5. **Helper: getUtilizationColor(pct)**: Returns Tailwind class -- green-400 for <50%, yellow-400 for 50-80%, red-400 for >80%.

AVOID: N+1 queries. Fetch bookings counts in a single query grouped by medic_id, then join client-side. Don't fetch full booking objects when you only need counts.
  </action>
  <verify>
- `ls web/lib/queries/admin/medics.ts`
- `grep -n 'export function\|export type\|export interface' web/lib/queries/admin/medics.ts`
- `grep -n 'utilization' web/lib/queries/admin/medics.ts` confirms utilization calculation exists
- `grep -n 'Promise.all' web/lib/queries/admin/medics.ts` confirms parallel queries
  </verify>
  <done>
File exports useMedics, useUpdateMedicAvailability, fetchMedicsWithMetrics, MedicWithMetrics type. Utilization calculated from booking counts. Territory assignments fetched and attached. Parallel queries via Promise.all.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build medic roster table with utilization, territories, and availability toggle</name>
  <files>web/components/admin/medic-roster-table.tsx, web/app/admin/medics/page.tsx</files>
  <action>
**2a. Create `web/components/admin/medic-roster-table.tsx`:**

Client component with TanStack Table:

1. **Column definitions**:
   - Medic (first_name + last_name, home_postcode below, employment_status badge: "Self-employed" blue or "Umbrella" purple)
   - Contact (email, phone below)
   - Territories (list of postcode_sector badges with "P" or "S" indicator for primary/secondary, max 3 visible + "+N more" overflow)
   - Utilization (visual progress bar 0-100%, color-coded: green <50%, yellow 50-80%, red >80%. Show "N bookings this week" below)
   - Performance (star_rating with star icon, total_shifts_completed count, riddor_compliance_rate percentage)
   - Availability (toggle switch or clickable badge: green "Available" / red "Unavailable" with reason tooltip)
   - Stripe (green "Active" if stripe_onboarding_complete, yellow "Pending" with link if not)
   - Actions (dropdown: View Details, Toggle Availability, View Schedule)

2. **Utilization bar component**: Horizontal progress bar with:
   - Width = utilization_pct%
   - Color: green (<50%), yellow (50-80%), red (>80%)
   - Text: "{utilization_pct}%" label
   - Tooltip: "X confirmed bookings out of 5 working days this week"

3. **Filters**:
   - Search (name, email, phone) with 300ms debounce
   - Availability filter (All, Available, Unavailable)
   - Certification filter (All, Confined Space, Trauma)
   - Stripe status filter (All, Active, Pending)

4. **Stats row** above table: Total Medics (blue), Available (green), Needs Onboarding (yellow highlighted if >0), High Performers 4.5+ (purple), Average Utilization (color-coded)

5. **Availability toggle**: When admin clicks availability badge/toggle:
   - If making unavailable: Show dialog asking for reason and optional "unavailable until" date
   - If making available: Direct toggle with optimistic update
   - Uses useUpdateMedicAvailability mutation

Style: Match existing admin dark theme. Keep the gradient header pattern from existing medics page.

**2b. Update `web/app/admin/medics/page.tsx`:**

Replace existing page to:
- Use useMedics hook for data with 60s polling
- Render MedicRosterTable component
- Keep existing header with "Add Medic" button
- Remove inline component definitions now in the table component

AVOID: Don't duplicate the table logic from the existing page. The table component handles all data display.
  </action>
  <verify>
- `ls web/components/admin/medic-roster-table.tsx`
- `grep -n 'utilization\|Utilization' web/components/admin/medic-roster-table.tsx` confirms utilization bar exists
- `grep -n 'territory\|Territory' web/components/admin/medic-roster-table.tsx` confirms territory display
- `grep -n 'useUpdateMedicAvailability' web/components/admin/medic-roster-table.tsx` confirms availability toggle wired
- `pnpm tsc --noEmit` passes
  </verify>
  <done>
Medic roster displays with utilization bars (green/yellow/red), territory assignment badges (primary/secondary), performance metrics, availability toggle with reason dialog, and Stripe status. Success criteria #4 (medic roster with availability and territory assignments) addressed.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn 'MedicRosterTable' web/app/admin/medics/` confirms component is used
2. `grep -rn 'utilization_pct\|utilization' web/components/admin/medic-roster-table.tsx` confirms utilization display
3. `grep -rn 'territory_assignments' web/components/admin/medic-roster-table.tsx` confirms territory display
4. `pnpm tsc --noEmit` passes with no type errors
</verification>

<success_criteria>
- Admin can view medic roster with name, contact, certifications, performance metrics (SC #4)
- Utilization percentage displayed as color-coded bar per medic
- Territory assignments shown as badges (primary/secondary)
- Admin can toggle medic availability with reason
- 60-second polling keeps data fresh
- Stripe onboarding status visible
</success_criteria>

<output>
After completion, create `.planning/phases/05.5-admin-operations/05.5-02-SUMMARY.md`
</output>
