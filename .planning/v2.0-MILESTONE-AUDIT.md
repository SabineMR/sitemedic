---
milestone: v2.0
audited: 2026-02-18T06:30:00Z
status: gaps_found
scores:
  requirements: 35/36
  phases: 7/7
  integration: 3/5
  flows: 3/5
gaps:
  requirements:
    - "MOTO-07: Motorsport per-incident PDF has no UI download path — motorsport-incident-generator Edge Function exists but no MotorsportIncidentReportCard component and no caller from treatment detail page"
  integration:
    - "motorsport-incident-generator Edge Function is unreachable from the web UI — no treatment-level PDF card for event_vertical = 'motorsport'"
    - "competitor_cleared_to_return has no UI toggle in the mobile form — concussion clearance badge permanently shows for all motorsport concussion cases"
  flows:
    - "Flow 2 (Treatment → PDF → Admin Download) broken for motorsport vertical"
    - "Flow 3 (Motorsport Concussion → Alert → Clearance) broken: clearance can never be marked resolved from mobile form"
tech_debt:
  - phase: "19-motorsport-vertical"
    items:
      - "competitor_cleared_to_return defined in MotorsportExtraFields (motorsport-fields.ts line 62) but no UI toggle in app/treatment/new.tsx — badge will show indefinitely"
      - "JSX syntax in .ts file: supabase/functions/motorsport-incident-generator/index.ts line 121 — could fail at runtime if JSX transform not configured"
  - phase: "all-verticals"
    items:
      - "app/treatment/new.tsx lines 171-172: t.orgId = 'temp-org' / t.medicId = 'temp-medic' — pre-existing, orgId/medicId not yet wired from auth context"
  - phase: "18.5-construction-infrastructure-vertical"
    items:
      - "services/taxonomy/verticals.ts: VERTICAL_CONFIG only has construction entry; Phases 19-22 entries are comments; getVerticalConfig() returns undefined for motorsport/festivals/sporting_events/tv_film"
  - phase: "18-vertical-infrastructure-riddor-fix"
    items:
      - "web/lib/pdf/incident-report-dispatcher.ts: generateIncidentReportPDF() is never imported or called — Phases 20 and 22 bypass it with direct fetch calls; Phase 19 has no caller at all"
      - "web/components/dashboard/treatments-columns.tsx line 95: nonRiddorVerticals hardcoded as ['motorsport', 'festivals', 'sporting_events'] — missing fairs_shows and private_events which are also in NON_RIDDOR_VERTICALS"
  - phase: "20-festivals-events-vertical"
    items:
      - "web/app/(dashboard)/treatments/[id]/page.tsx: EventIncidentReportCard only rendered for 'festivals' — fairs_shows and private_events treatments have no PDF download card despite routing to same Edge Function"
---

# v2.0 Milestone Audit: Multi-Vertical Platform Expansion

**Audited:** 2026-02-18T06:30:00Z
**Status:** GAPS FOUND
**Report by:** Claude (gsd-integration-checker + gsd-audit-milestone)

---

## Summary

| Category | Score | Status |
|----------|-------|--------|
| Requirements | 35/36 | ⚠ 1 unsatisfied |
| Phases verified | 7/7 | ✓ All passed (Phase 19 needs human runtime tests) |
| E2E Flows | 3/5 | ⚠ 2 broken |
| Cross-phase wiring | Connected | ✓ Core infrastructure wired |

---

## Requirements Coverage

### Satisfied (35/36)

| Requirement | Phase | Status |
|-------------|-------|--------|
| VERT-01: RIDDOR gate fires only when riddorApplies: true | 18 | ✓ SATISFIED |
| VERT-02: WatermelonDB v4 schema with vertical columns | 18 | ✓ SATISFIED |
| VERT-03: Mobile app fetches vertical once at login via OrgContext | 18 | ✓ SATISFIED |
| VERT-04: Booking-level vertical override in mobile treatment form | 18 | ✓ SATISFIED |
| VERT-05: Admin can set default vertical in org settings | 18 | ✓ SATISFIED |
| VERT-06: Client selects event vertical when creating booking | 18 | ✓ SATISFIED |
| FILM-01: Production-specific form fields | 21 | ✓ SATISFIED |
| FILM-02: Film/TV terminology throughout app | 21 | ✓ SATISFIED |
| FILM-03: Film/TV cert profile (HCPC, ScreenSkills, FREC 4, EFR) | 21 | ✓ SATISFIED |
| FILM-04: RIDDOR pipeline unchanged for Film/TV | 21 | ✓ SATISFIED |
| FEST-01: TST triage category in festival form | 20 | ✓ SATISFIED |
| FEST-02: Alcohol/substance + safeguarding flags in festival form | 20 | ✓ SATISFIED |
| FEST-03: RIDDOR disabled for festival-goer patients | 20 | ✓ SATISFIED |
| FEST-04: App terminology switches to events context | 20 | ✓ SATISFIED |
| FEST-05: Medic profile shows events certs (FREC 3 minimum) | 20 | ✓ SATISFIED |
| FEST-06: Purple Guide PDF for event organiser | 20 | ✓ SATISFIED |
| MOTO-01: Motorsport form captures GCS, extrication, helmet, concussion | 19 | ✓ SATISFIED |
| MOTO-02: Medical Statistics Sheet at end of event | 19 | ✓ SATISFIED |
| MOTO-03: Concussion triggers licence suspension notification | 19 | ✓ SATISFIED (alert created; clearance UI gap noted in tech debt) |
| MOTO-04: RIDDOR disabled for motorsport competitor patients | 19 | ✓ SATISFIED |
| MOTO-05: Motorsport terminology (Competitor, Circuit/Paddock, Organiser) | 19 | ✓ SATISFIED |
| MOTO-06: Motorsport cert profile (Motorsport UK Licence, ATLS, BASM) | 19 | ✓ SATISFIED |
| MOTO-07: Motorsport incidents generate Motorsport UK Accident Form PDF | 19 | ✗ UNSATISFIED — see gap below |
| FOOT-01: Football patient type selector (Player/Spectator) | 22 | ✓ SATISFIED |
| FOOT-02: Player incident form (Phase of Play, Contact, HIA, FA Severity) | 22 | ✓ SATISFIED |
| FOOT-03: Spectator incident form (Stand Location, Referral, Safeguarding) | 22 | ✓ SATISFIED |
| FOOT-04: RIDDOR disabled for player on-pitch injuries | 22 | ✓ SATISFIED |
| FOOT-05: Football terminology (Player, Pitch/Ground, Club) | 22 | ✓ SATISFIED |
| FOOT-06: Football cert profile (ATMMiF-led) | 22 | ✓ SATISFIED |
| FOOT-07: Correct PDF for each football incident type | 22 | ✓ SATISFIED |
| ANLT-01: Near-miss heat map on org dashboard | 23 | ✓ SATISFIED |
| ANLT-02: Admin aggregate near-miss heat map | 23 | ✓ SATISFIED |
| ANLT-03: Compliance scores persisted weekly | 23 | ✓ SATISFIED |
| ANLT-04: Compliance score trend chart on org dashboard | 23 | ✓ SATISFIED |
| ANLT-05: Incident frequency trend chart on org dashboard | 23 | ✓ SATISFIED |
| ANLT-06: Admin aggregate compliance trends + org ranking | 23 | ✓ SATISFIED |

### Unsatisfied (1)

**MOTO-07:** Motorsport incidents shall generate a Motorsport UK–style Accident Form PDF per incident.

- The `motorsport-incident-generator` Edge Function is fully implemented (167 lines, PDF pipeline, storage bucket `motorsport-reports`)
- The `incident-report-dispatcher.ts` correctly routes `motorsport` to this function
- **Gap:** `web/app/(dashboard)/treatments/[id]/page.tsx` has no PDF download card for `event_vertical === 'motorsport'`
- **Gap:** No `MotorsportIncidentReportCard` component exists
- **Gap:** No `generateMotorsportIncidentPDF()` query function exists
- **Effect:** Admins and medics cannot download per-incident Motorsport UK Accident Forms from the web dashboard

---

## Phase Verification Summary

| Phase | Status | Score | Human Tests |
|-------|--------|-------|-------------|
| 18: Vertical Infrastructure & RIDDOR Fix | ✓ passed | 18/18 | 3 (runtime only) |
| 18.5: Construction Infrastructure Vertical | ✓ passed | 15/15 | 0 |
| 19: Motorsport Vertical | ⚠ human_needed | 5/5 | 4 (runtime only) |
| 20: Festivals & Events Vertical | ✓ passed | 16/16 | 3 (runtime only) |
| 21: Film/TV Production Vertical | ✓ passed | 10/10 | 3 (runtime only) |
| 22: Football / Sports Vertical | ✓ passed (re-verified) | 5/5 | 0 |
| 23: Analytics — Heat Maps & Trend Charts | ✓ passed | 6/6 | 5 (runtime only) |

Note: Phase 19 `human_needed` status means all 5 structural checks passed but 4 tests require a live running app + Edge Runtime (RIDDOR banner on device, dashboard badge in context, PDF generation via Supabase Edge Runtime). This is not a structural blocker.

---

## E2E Flow Status

### Flow 1: Treatment → Vertical Detection → RIDDOR Gate ✓ COMPLETE

| Step | Status |
|------|--------|
| OrgContext provides `primaryVertical` from cache at login | Connected |
| Mobile form writes `event_vertical` + `vertical_extra_fields` to WatermelonDB + sync payload | Connected |
| `riddor-detector` reads `event_vertical`, gates against `NON_RIDDOR_VERTICALS` | Connected |
| `handleInjuryTypeSelect` uses `getVerticalCompliance(orgVertical).riddorApplies` | Connected |
| All 4 new verticals excluded from RIDDOR at Edge Function level | Connected |

### Flow 2: Treatment → PDF Generation → Admin Download ⚠ BROKEN (motorsport)

| Vertical | Treatment Detail Card | Edge Function | Status |
|----------|-----------------------|---------------|--------|
| festivals | EventIncidentReportCard ✓ | event-incident-report-generator ✓ | Connected |
| sporting_events | FAIncidentReportCard ✓ | fa-incident-generator ✓ | Connected |
| motorsport | **None** | motorsport-incident-generator ✓ (but unreachable) | **Broken** |
| tv_film | F2508 via pre-existing RIDDOR flow | riddor-f2508-generator ✓ | Connected |
| construction | F2508 via pre-existing RIDDOR flow | riddor-f2508-generator ✓ | Connected |

### Flow 3: Motorsport Concussion → Alert → Clearance ⚠ BROKEN

| Step | Status |
|------|--------|
| Concussion suspected → `medic_alerts` insert fires (when bookingId present) | Connected |
| Dashboard shows "Concussion clearance required" badge | Connected |
| Medic sets `competitor_cleared_to_return = true` in mobile form | **Not implemented — no UI toggle** |
| Badge clears when competitor_cleared_to_return is true | Would work if field were settable |

The badge is visible but permanently stuck — a medic has no way to mark a competitor as cleared from within the mobile treatment form.

### Flow 4: Near-Miss GPS → Heat Map ✓ COMPLETE

All links connected: GPS columns (schema v4) → near_misses table → `useNearMissGeoData` hook → `NearMissHeatMap` CircleMarker → org dashboard `/analytics/heat-map` page and admin analytics Heat Map tab.

### Flow 5: Weekly Report → Compliance History → Trend Chart ✓ COMPLETE

All links connected: `generate-weekly-report` upserts → `compliance_score_history` (UNIQUE INDEX from migration 130) → `useComplianceHistory` hook → `ComplianceScoreChart` → org compliance page and admin analytics Compliance tab.

---

## RIDDOR Consistency Audit

| Vertical | riddor-detector NON_RIDDOR_VERTICALS | vertical-compliance.ts riddorApplies | Mobile RIDDOR banner gate | Dashboard badge guard |
|----------|--------------------------------------|--------------------------------------|---------------------------|-----------------------|
| motorsport | ✓ Excluded | false | ✓ Excluded (via getVerticalCompliance) | ✓ Excluded |
| festivals | ✓ Excluded | false | ✓ Excluded (via getVerticalCompliance) | ✓ Excluded |
| sporting_events | ✓ Excluded | false | ✓ Excluded (via getVerticalCompliance) | ✓ Excluded |
| fairs_shows | ✓ Excluded | false | ✓ Excluded (via getVerticalCompliance) | ⚠ Not guarded |
| private_events | ✓ Excluded | false | ✓ Excluded (via getVerticalCompliance) | ⚠ Not guarded |
| tv_film | Not excluded (correct) | true | RIDDOR applies (correct) | Not excluded (correct) |
| construction | Not excluded (correct) | true | RIDDOR applies (correct) | Not excluded (correct) |

Dashboard `nonRiddorVerticals` array (`treatments-columns.tsx` line 95) guards only `['motorsport', 'festivals', 'sporting_events']` but not `fairs_shows` or `private_events`. Low risk: neither sub-vertical is currently marketed/active, but if stale sync data carries `is_riddor_reportable = true`, the badge would incorrectly show.

---

## Migration Sequence

| # | Migration | Purpose | Status |
|---|-----------|---------|--------|
| 124 | vertical_schema_v4 | Schema v4 + compliance_score_history table | ✓ Present |
| 125 | event_incident_reports_storage | event-incident-reports bucket + RLS | ✓ Present |
| 126 | motorsport_concussion | Motorsport UK alert type constraint | ✓ Present |
| 127 | fa_incident_storage | fa-incident-reports bucket + RLS | ✓ Present |
| 128 | motorsport_reports_storage | motorsport-reports bucket + RLS | ✓ Present |
| 129 | hourly_pay_and_profit_split | Compensation (out of v2.0 scope) | ✓ Present, no conflict |
| 130 | compliance_score_history_index_and_rls | UNIQUE INDEX + platform admin RLS | ✓ Present |

No gaps, no conflicts. All v2.0 migrations present and sequentially ordered.

---

## Storage Bucket Coverage

| Bucket | Vertical | Migration | RLS | Status |
|--------|----------|-----------|-----|--------|
| event-incident-reports | festivals / fairs_shows / private_events | 125 | 3 policies (SELECT, INSERT, UPDATE) | ✓ |
| fa-incident-reports | sporting_events | 127 | 3 policies | ✓ |
| motorsport-reports | motorsport (stats sheet + incident PDFs) | 128 | 3 policies | ✓ |

All vertical-specific storage buckets present with appropriate RLS.

---

## Tech Debt

### High (affects feature completeness)
- `competitor_cleared_to_return` field has no UI toggle in `app/treatment/new.tsx` — badge shows permanently (Phase 19)

### Medium
- `generateIncidentReportPDF()` in `incident-report-dispatcher.ts` is orphaned dead code — never imported or called; Phases 20 and 22 bypass it with direct fetch calls, Phase 19 has no caller (Phase 18)

### Low
- `VERTICAL_CONFIG` in `verticals.ts` contains only `construction`; `getVerticalConfig()` returns `undefined` for all new verticals — not in active code paths currently (Phase 18.5)
- Dashboard `nonRiddorVerticals` missing `fairs_shows` and `private_events` (Phase 19)
- `EventIncidentReportCard` not rendered for `fairs_shows` and `private_events` in treatment detail page (Phase 20)
- JSX syntax in `motorsport-incident-generator/index.ts` (`.ts` file, pre-existing) (Phase 19)
- `t.orgId = 'temp-org'` / `t.medicId = 'temp-medic'` in `app/treatment/new.tsx` lines 171-172 (pre-existing, all phases)

---

## Gaps to Close

### Gap 1 (CRITICAL — MOTO-07): Motorsport Per-Incident PDF Download UI

**What's needed:**
1. Create `web/lib/queries/motorsport-incidents.ts` with `generateMotorsportIncidentPDF(treatmentId)` that POSTs to `/functions/v1/motorsport-incident-generator`
2. Create `web/components/dashboard/MotorsportIncidentReportCard.tsx` matching the pattern of `EventIncidentReportCard.tsx`
3. Add `{treatment.event_vertical === 'motorsport' && <MotorsportIncidentReportCard treatmentId={treatment.id} />}` to `web/app/(dashboard)/treatments/[id]/page.tsx`

**Scope:** ~1 plan, mirrors existing Phase 20/22 patterns exactly.

### Gap 2 (MEDIUM — MOTO-03 completeness): Competitor Clearance UI

**What's needed:**
In `app/treatment/new.tsx` motorsport concussion section, add a toggle for `competitor_cleared_to_return` (mirrors the `hia_conducted` / `competitor_stood_down` / `cmo_notified` toggles already present). The badge logic in `treatments-columns.tsx` already checks this field correctly.

**Scope:** ~10 lines in `app/treatment/new.tsx`, single plan.

---

## Human Verification Checklist

The following runtime tests cannot be verified by static analysis. Complete before archiving:

| # | Phase | Test | Why Human |
|---|-------|------|-----------|
| 1 | 18 | RIDDOR early-return E2E: submit festival-vertical treatment, confirm no `riddor_incidents` row | Live DB + Edge Function |
| 2 | 18 | OrgContext offline cache: enable airplane mode after login, confirm treatment form loads | Physical device |
| 3 | 18 | Booking vertical → treatment form roundtrip | Full web + mobile integration |
| 4 | 19 | Motorsport RIDDOR banner suppression in mobile app | Device with motorsport booking |
| 5 | 19 | Dashboard RIDDOR badge absent for motorsport treatments | E2E treatment creation + sync |
| 6 | 19 | Medical Statistics Sheet PDF generation (Generate button → PDF in new tab) | Supabase Edge Runtime |
| 7 | 19 | RIDDOR detector response for motorsport treatment | Deployed Edge Function |
| 8 | 20 | Festival PDF visual rendering (P2 triage, alcohol flag, disposition in PDF) | Browser + PDF viewer |
| 9 | 20 | RIDDOR banner suppression for festivals in live mobile use | Device |
| 10 | 20 | Purple Guide PDF signed URL access control (cross-org denial) | Live Supabase + two sessions |
| 11 | 21 | Film/TV form section renders "Production Details" | Device/simulator with tv_film org |
| 12 | 21 | Cast & Crew tab label shows (not "Workers") | Device |
| 13 | 21 | RIDDOR auto-flag for crew member injury triggers F2508 | Supabase functions + E2E |
| 14 | 23 | Near-miss heat map renders with CircleMarkers and severity legend | Browser, authenticated session |
| 15 | 23 | Compliance trend charts render (LineChart + AreaChart on `/analytics/compliance`) | Browser, after weekly report run |
| 16 | 23 | Admin aggregate heat map renders with org colour coding | Browser, platform admin, multi-org data |
| 17 | 23 | Admin compliance tab: ComposedChart + OrgComplianceTable accents | Browser, platform admin, multi-org data |
| 18 | 23 | generate-weekly-report inserts a `compliance_score_history` row | Invoke Edge Function, query table |

---

## Conclusion

v2.0 has 35 of 36 requirements satisfied. The single unsatisfied requirement (MOTO-07) has the Edge Function fully built and deployed — only the web UI download path is missing. This is a 1-plan gap, mirroring the exact pattern already established in Phase 20 and Phase 22.

The concussion clearance workflow gap (Flow 3) is a functional completeness issue that doesn't affect incident recording but means the "Concussion clearance required" badge will show indefinitely regardless of clinical outcome.

Both gaps can be closed in a single gap-closure phase (~2 plans) before archiving.

---

*Audited: 2026-02-18T06:30:00Z*
*Auditor: Claude (gsd-audit-milestone)*
*Integration check: Claude (gsd-integration-checker)*
